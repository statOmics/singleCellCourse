<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Koen Van den Berge and Jeroen Gilis" />


<title>Lab3: Clustering, cell type annotation, differential expression</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>


<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Single-cell course</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-chalkboard-teacher"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="introSequencingBulk.html">A brief introduction to sequencing technology</a>
    </li>
    <li>
      <a href="singleCellProtocols.html">Two popular single-cell protocols</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lab1_session.html">Lab 1</a>
    </li>
    <li>
      <a href="lab2_session.html">Lab 2</a>
    </li>
    <li>
      <a href="lab3_session.html">Lab 3</a>
    </li>
    <li>
      <a href="lab4_session.html">Lab 4</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/statOmics/Rmd-website">
    <span class="fab fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://statomics.github.io/">statOmics</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Lab3: Clustering, cell type annotation, differential expression</h1>
<h4 class="author">Koen Van den Berge and Jeroen Gilis</h4>
<h4 class="date">6/12/2021</h4>

</div>


<div id="preamble-installation-of-bioconductor-libraries" class="section level1">
<h1><span class="header-section-number">1</span> Preamble: installation of Bioconductor libraries</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># install BiocManager package if not installed yet.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># BiocManager is the package installer for Bioconductor software.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">requireNamespace</span>(<span class="st">&quot;BiocManager&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="kw">install.packages</span>(<span class="st">&quot;BiocManager&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># install packages if not yet installed.</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SingleCellExperiment&quot;</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>          <span class="st">&quot;ExperimentHub&quot;</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>          <span class="st">&quot;edgeR&quot;</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>          <span class="st">&quot;biomaRt&quot;</span>,</span>
<span id="cb1-11"><a href="#cb1-11"></a>          <span class="st">&quot;DropletUtils&quot;</span>, </span>
<span id="cb1-12"><a href="#cb1-12"></a>          <span class="st">&quot;scRNAseq&quot;</span>, </span>
<span id="cb1-13"><a href="#cb1-13"></a>          <span class="st">&quot;scater&quot;</span>, </span>
<span id="cb1-14"><a href="#cb1-14"></a>          <span class="st">&quot;scuttle&quot;</span>, </span>
<span id="cb1-15"><a href="#cb1-15"></a>          <span class="st">&quot;scran&quot;</span>,</span>
<span id="cb1-16"><a href="#cb1-16"></a>          <span class="st">&quot;scry&quot;</span>,</span>
<span id="cb1-17"><a href="#cb1-17"></a>          <span class="st">&quot;BiocSingular&quot;</span>, </span>
<span id="cb1-18"><a href="#cb1-18"></a>          <span class="st">&quot;scDblFinder&quot;</span>,</span>
<span id="cb1-19"><a href="#cb1-19"></a>          <span class="st">&quot;Seurat&quot;</span>,</span>
<span id="cb1-20"><a href="#cb1-20"></a>          <span class="st">&quot;PCAtools&quot;</span>,</span>
<span id="cb1-21"><a href="#cb1-21"></a>          <span class="st">&quot;glmpca&quot;</span>,</span>
<span id="cb1-22"><a href="#cb1-22"></a>          <span class="st">&quot;genefilter&quot;</span>,</span>
<span id="cb1-23"><a href="#cb1-23"></a>          <span class="st">&quot;pheatmap&quot;</span>,</span>
<span id="cb1-24"><a href="#cb1-24"></a>          <span class="st">&quot;tidyverse&quot;</span>,</span>
<span id="cb1-25"><a href="#cb1-25"></a>          <span class="st">&quot;mclust&quot;</span>,</span>
<span id="cb1-26"><a href="#cb1-26"></a>          <span class="st">&quot;ggplot2&quot;</span>,</span>
<span id="cb1-27"><a href="#cb1-27"></a>          <span class="st">&quot;SingleR&quot;</span>)</span>
<span id="cb1-28"><a href="#cb1-28"></a>notInstalled &lt;-<span class="st"> </span>pkgs[<span class="op">!</span>pkgs <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()[,<span class="dv">1</span>]]</span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="cf">if</span>(<span class="kw">length</span>(notInstalled) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb1-30"><a href="#cb1-30"></a>  BiocManager<span class="op">::</span><span class="kw">install</span>(notInstalled)</span>
<span id="cb1-31"><a href="#cb1-31"></a>}</span></code></pre></div>
<pre><code>## &#39;getOption(&quot;repos&quot;)&#39; replaces Bioconductor standard repositories, see
## &#39;?repositories&#39; for details
## 
## replacement repositories:
##     CRAN: https://cran.rstudio.com</code></pre>
<pre><code>## Bioconductor version 3.14 (BiocManager 1.30.16), R 4.1.2 (2021-11-01)</code></pre>
<pre><code>## Installing package(s) &#39;genefilter&#39;, &#39;pheatmap&#39;, &#39;tidyverse&#39;, &#39;mclust&#39;,
##   &#39;SingleR&#39;</code></pre>
<pre><code>## also installing the dependencies &#39;ps&#39;, &#39;rematch&#39;, &#39;processx&#39;, &#39;backports&#39;, &#39;gargle&#39;, &#39;uuid&#39;, &#39;cellranger&#39;, &#39;ids&#39;, &#39;rematch2&#39;, &#39;clipr&#39;, &#39;vroom&#39;, &#39;tzdb&#39;, &#39;callr&#39;, &#39;selectr&#39;, &#39;annotate&#39;, &#39;broom&#39;, &#39;dtplyr&#39;, &#39;forcats&#39;, &#39;googledrive&#39;, &#39;googlesheets4&#39;, &#39;haven&#39;, &#39;lubridate&#39;, &#39;modelr&#39;, &#39;readr&#39;, &#39;readxl&#39;, &#39;reprex&#39;, &#39;rstudioapi&#39;, &#39;rvest&#39;</code></pre>
<pre><code>## 
##   There is a binary version available but the source version is later:
##           binary source needs_compilation
## backports  1.4.0  1.4.1              TRUE
## 
## 
## The downloaded binary packages are in
##  /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T//RtmpPfiF6R/downloaded_packages</code></pre>
<pre><code>## installing the source package &#39;backports&#39;</code></pre>
<pre><code>## Old packages: &#39;crayon&#39;, &#39;digest&#39;, &#39;glue&#39;, &#39;knitr&#39;, &#39;lattice&#39;, &#39;lifecycle&#39;,
##   &#39;mgcv&#39;, &#39;mime&#39;, &#39;nlme&#39;, &#39;pillar&#39;, &#39;rlang&#39;, &#39;rmarkdown&#39;, &#39;stringi&#39;, &#39;tibble&#39;,
##   &#39;tinytex&#39;, &#39;withr&#39;, &#39;xfun&#39;, &#39;Matrix&#39;</code></pre>
<p>Steps taken in first two lab sessions:</p>
<ol style="list-style-type: decimal">
<li><p>Import the Macosko dataset as <code>SingleCellExperiment</code> object from the <code>scRNAseq</code> Bioconductor package.</p></li>
<li><p>Include ENSEMBL gene identifiers in the <code>rowData</code></p></li>
<li><p>Remove very lowly expressed genes</p></li>
<li><p>Remove low quality cells 4.1. Cells with outlying library size 4.2. Cells with outlying transcriptome complexity 4.3. Cells with outlying percentage of mitochondrial reads 4.4. Empty droplets 4.5. Doublets</p></li>
<li><p>Normalization 5.1. Compute log-normalized counts 5.2. Compute scaling factor to correct for differences in library size</p></li>
<li><p>Feature selection 6.1. Genes with high variance 6.2. Genes with high variance with respect to their mean expression 6.3. Genes with high deviance 6.4. Genes with high variance after variance-stabilizing transformation (VST)</p></li>
<li><p>Dimensionality reduction 7.1. Based on two most variable genes from step 6.2. 7.2. PCA 7.3. GLM-PCA 7.4. T-SNE 7.5. UMAP</p></li>
</ol>
</div>
<div id="the-macosko-dataset" class="section level1">
<h1><span class="header-section-number">2</span> The Macosko dataset</h1>
<p>In this workshop session, we will analyze the single-cell RNA-seq dataset from the publication by Macosko <em>et al.</em>, Cell 161, 1202–1214 from 2015 <a href="https://doi.org/10.1016/j.cell.2015.05.002">(link)</a>. This is the manuscript in which the droplet scRNA-seq technology <strong>Drop-seq</strong> was introduced. Six years after the original publication, drop-seq is still one of the most commonly adopted scRNA-seq protocols, as evidenced by the large number of citations for Macosko <em>et al.</em> (4.303 citations at November 3, 2021).</p>
<p>The basic idea behind the Drop-seq protocol can be taken from the graphical abstract of the publication.</p>
<pre><code>knitr::include_graphics(&quot;macosko_graphicalAbstract.jpeg&quot;)</code></pre>
<p>The success of Drop-seq can be explained by the following advantageous features:</p>
<ul>
<li><p>The use of unique molecular identifiers (UMIs). By working with UMIs, one count corresponds to one observed mRNA molecule present in the cell. Thanks to the use of UMI barcodes, PCR artifacts are reduced.</p></li>
<li><p>Scalability: microfluidics technology allows for performing the library prep reactions inside nanodroplets, in which single cells may be contained. Library prep occurs across all droplets simultaneously.</p></li>
<li><p>Cost: the experiment costs around 6.5 cents (USD) per cell.</p></li>
<li><p>Speed: The very large dataset that we will be working with today was generated in an experiment that took only 4 days.</p></li>
</ul>
<p>In this particular experiment, Macosko <em>et al.</em> sequenced 49,300 cells from the mouse retina, identifying 39 transcriptionally distinct cell populations. The experiment was performed in 7 batches.</p>
</div>
<div id="data-availability" class="section level1">
<h1><span class="header-section-number">3</span> Data availability</h1>
<div id="sra" class="section level2">
<h2><span class="header-section-number">3.1</span> SRA</h2>
<p>The <a href="https://www.ncbi.nlm.nih.gov/sra">Sequence Read Archive (SRA)</a> is the largest publicly available repository of high-throughput sequencing data. The data are stored by the National Center for Biotechnology Information (NCBI) services and multiple cloud storage providers. From this website “raw” sequencing data can be retrieved. In practice, these are usually <code>.sra</code> files, which can be downloaded and converted into FASTQ files using functions from the <code>sratoolkit</code> software.</p>
<p>For our dataset, the FASTQ data can be retrieved from this <a href="https://www.ncbi.nlm.nih.gov/Traces/study/?acc=PRJNA267857&amp;o=acc_s%3Aa">link</a>. The data are stored as one file per sequencing batch, with each file approximately 20Gb. As such, it will be unfeasible to download and process these FASTQ files in this practical session.</p>
<p>Instead, for demonstrative purposes, we have taken a subsample of the FASTQ file for the first sequencing batch for you to work with. On this subsample, we may perform all the tasks that we would have performed on the full dataset. The steps that are required for downloading and quantifying drop-seq data can be found in <a href="https://github.com/statOmics/singleCellCourse/blob/master/lab1_preprocessing/preprocessDropseq.sh">a Shell script on our companion GitHub repository</a>.</p>
</div>
<div id="geo" class="section level2">
<h2><span class="header-section-number">3.2</span> GEO</h2>
<p>The dataset from Macosko <em>et al.</em> was also uploaded by the authors on the Gene Expression Omnibus (GEO) platform under accession number <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE63472">GSE63472</a>, from which raw and readily-processed data files may be retrieved, including:</p>
<ol style="list-style-type: decimal">
<li><p><em>GSE63472_RAW.tar</em>, a 90.6Gb object that contains the “raw data” for the experiment. In the scRNA-seq context, FASTQ files are often considered the raw data format.</p></li>
<li><p><em>GSE63472_P14Retina_merged_digital_expression.txt.gz</em>, a 50.7Mb matrix that stores the gene expression values for each cell. These values are integer counts, that did not undergo any type of preprocessing or normalization.</p></li>
<li><p><em>GSE63472_mm10_reference_metadata.tar.gz</em>, a 862.9Mb compressed folder containing information on the reference genome to which the scRNA-seq reads were aligned (see theory slides).</p></li>
<li><p><em>GSE63472_P14Retina_logDGE.txt.gz</em>, a 316.8Mb compressed text file, not clear what it contains (results from a differential gene expression analysis, but with log-transformation, so log-fold changes maybe?).</p></li>
</ol>
<p>As such, by downloading <em>GSE63472_P14Retina_merged_digital_expression.txt.gz</em>, we avoid re-quantifying the data, i.e., the translation from reads from the FASTQ files into a gene-level expression values for each cell.</p>
<p>One issue that often arises from data downloaded from GEO, is that there is no strict requirements for which data should be included in the upload by the authors. As such, from my personal experience, it can often be the case that important information like metadata are missing, or the content of the submitted files is unclear. Even if all the required data are available, as is the case here, we would still need to piece all the information together from different files and file formats before we can use them.</p>
</div>
<div id="experimenthub" class="section level2">
<h2><span class="header-section-number">3.3</span> ExperimentHub</h2>
<p>The Bioconductor <em>ExperimentHub</em> web resource, which can be accessed using the <a href="https://bioconductor.org/packages/release/bioc/html/ExperimentHub.html">ExperimentHub</a> R package, provides a central location where curated data from experiments, publications or training courses can be accessed. While it contains far less datasets than the SRA or GEO (4965 records to date), these datasets all follow the tidy data format of Bioconductor. Note that the ExperimentHub contains several types of data, like bulk and single-cell transcriptomics data, microarrays and more.</p>
<p>The Macosko dataset is available from ExperimentHub and can be accessed as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">library</span>(ExperimentHub)</span>
<span id="cb10-2"><a href="#cb10-2"></a>edb &lt;-<span class="st"> </span><span class="kw">ExperimentHub</span>()</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a>edb[<span class="kw">grep</span>(<span class="st">&quot;Macosko&quot;</span>, edb<span class="op">$</span>title)] <span class="co"># find accession number (can be inefficient)</span></span></code></pre></div>
<pre><code>## ExperimentHub with 2 records
## # snapshotDate(): 2021-10-19
## # $dataprovider: Steve McCarroll, GEO
## # $species: Mus musculus
## # $rdataclass: dgCMatrix, DataFrame
## # additional mcols(): taxonomyid, genome, description,
## #   coordinate_1_based, maintainer, rdatadateadded, preparerclass, tags,
## #   rdatapath, sourceurl, sourcetype 
## # retrieve records with, e.g., &#39;object[[&quot;EH2690&quot;]]&#39; 
## 
##            title                 
##   EH2690 | Macosko retina counts 
##   EH2691 | Macosko retina colData</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>edb_counts &lt;-<span class="st"> </span>edb[[<span class="st">&quot;EH2690&quot;</span>]]</span>
<span id="cb12-2"><a href="#cb12-2"></a>edb_counts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## 5 x 5 sparse Matrix of class &quot;dgCMatrix&quot;
##               r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
## KITL                        .               .               1               .
## TMTC3                       3               .               .               .
## CEP290                      1               3               .               2
## 4930430F08RIK               2               1               2               .
## 1700017N19RIK               .               .               .               .
##               r1_CCTCCTAGTTGG
## KITL                        .
## TMTC3                       2
## CEP290                      1
## 4930430F08RIK               1
## 1700017N19RIK               .</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>edb_coldata &lt;-<span class="st"> </span>edb[[<span class="st">&quot;EH2691&quot;</span>]]</span>
<span id="cb14-2"><a href="#cb14-2"></a>edb_coldata[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,]</span></code></pre></div>
<pre><code>## DataFrame with 5 rows and 2 columns
##           cell.id   cluster
##       &lt;character&gt; &lt;integer&gt;
## 1 r1_GGCCGCAGTCCG         2
## 2 r1_CTTGTGCGGGAA         2
## 3 r1_GCGCAACTGCTC         2
## 4 r1_GATTGGGAGGCA         2
## 5 r1_CCTCCTAGTTGG        NA</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">rm</span>(edb, edb_counts, edb_coldata)</span></code></pre></div>
</div>
<div id="scrnaseq" class="section level2">
<h2><span class="header-section-number">3.4</span> scRNASeq</h2>
<p>In addition to ExperimentHub, Bioconductor provides the package <a href="https://bioconductor.org/packages/release/data/experiment/html/scRNAseq.html">scRNAseq</a>. This package provides an even more user-friendly client to access (only) scRNA-seq datasets from the ExperimentHub web resource. Data retrieved using the scRNAseq package are stored as user-friendly <code>SingleCellExperiment</code> objects, with the expression data, gene-level information, cell-level information and experiment metadata all in place in one data object. The scRNA-seq package currently holds 61 datasets, including the data from <em>Macosko et al.</em>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb17-2"><a href="#cb17-2"></a>scRNAseq<span class="op">::</span><span class="kw">MacoskoRetinaData</span>()</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 24658 49300 
## metadata(0):
## assays(1): counts
## rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
## rowData names(0):
## colnames(49300): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
##   p1_ATTCTTGTTCTT
## colData names(2): cell.id cluster
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
</div>
</div>
<div id="import-data" class="section level1">
<h1><span class="header-section-number">4</span> Import data</h1>
<p>The <code>scRNAseq</code> package provides convenient access to several datasets. See the <a href="http://bioconductor.org/packages/release/data/experiment/html/scRNAseq.html">package Bioconductor page</a> for more information.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Code below might ask you to create an ExperimentHub directory. </span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># Type &#39;yes&#39; and hit Enter, to allow this.</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(scRNAseq))</span>
<span id="cb19-4"><a href="#cb19-4"></a>sce &lt;-<span class="st"> </span><span class="kw">MacoskoRetinaData</span>()</span></code></pre></div>
<pre><code>## snapshotDate(): 2021-10-19</code></pre>
<pre><code>## see ?scRNAseq and browseVignettes(&#39;scRNAseq&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
<pre><code>## see ?scRNAseq and browseVignettes(&#39;scRNAseq&#39;) for documentation</code></pre>
<pre><code>## loading from cache</code></pre>
</div>
<div id="a-singlecellexperiment-object" class="section level1">
<h1><span class="header-section-number">5</span> A <code>SingleCellExperiment</code> object</h1>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 24658 49300 
## metadata(0):
## assays(1): counts
## rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
## rowData names(0):
## colnames(49300): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
##   p1_ATTCTTGTTCTT
## colData names(2): cell.id cluster
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<div id="accessing-data-from-a-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.1</span> Accessing data from a <code>SingleCellExperiment</code> object</h2>
<p>Please see <a href="http://bioconductor.org/books/release/OSCA/data-infrastructure.html">Figure 4.1 in OSCA</a> for an overview of a <code>SingleCellExperiment</code> object.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Data: assays</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw">assays</span>(sce)</span></code></pre></div>
<pre><code>## List of length 1
## names(1): counts</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">assays</span>(sce)<span class="op">$</span>counts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## 5 x 5 sparse Matrix of class &quot;dgCMatrix&quot;
##               r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
## KITL                        .               .               1               .
## TMTC3                       3               .               .               .
## CEP290                      1               3               .               2
## 4930430F08RIK               2               1               2               .
## 1700017N19RIK               .               .               .               .
##               r1_CCTCCTAGTTGG
## KITL                        .
## TMTC3                       2
## CEP290                      1
## 4930430F08RIK               1
## 1700017N19RIK               .</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># Feature metadata: rowData</span></span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="kw">rowData</span>(sce) <span class="co"># empty for now</span></span></code></pre></div>
<pre><code>## DataFrame with 24658 rows and 0 columns</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># Cell metadata: colData</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="kw">colData</span>(sce)</span></code></pre></div>
<pre><code>## DataFrame with 49300 rows and 2 columns
##                         cell.id   cluster
##                     &lt;character&gt; &lt;integer&gt;
## r1_GGCCGCAGTCCG r1_GGCCGCAGTCCG         2
## r1_CTTGTGCGGGAA r1_CTTGTGCGGGAA         2
## r1_GCGCAACTGCTC r1_GCGCAACTGCTC         2
## r1_GATTGGGAGGCA r1_GATTGGGAGGCA         2
## r1_CCTCCTAGTTGG r1_CCTCCTAGTTGG        NA
## ...                         ...       ...
## p1_TCAAAAGCCGGG p1_TCAAAAGCCGGG        24
## p1_ATTAAGTTCCAA p1_ATTAAGTTCCAA        34
## p1_CTGTCTGAGACC p1_CTGTCTGAGACC         2
## p1_TAACGCGCTCCT p1_TAACGCGCTCCT        24
## p1_ATTCTTGTTCTT p1_ATTCTTGTTCTT        24</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Reduced dimensions: reducedDims</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw">reducedDims</span>(sce) <span class="co"># empty for now</span></span></code></pre></div>
<pre><code>## List of length 0
## names(0):</code></pre>
</div>
<div id="creating-a-new-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.2</span> Creating a new <code>SingleCellExperiment</code> object</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>sceNew &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays =</span> <span class="kw">list</span>(<span class="dt">counts =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts))</span>
<span id="cb37-2"><a href="#cb37-2"></a>sceNew</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 24658 49300 
## metadata(0):
## assays(1): counts
## rownames(24658): KITL TMTC3 ... 1110059M19RIK GM20861
## rowData names(0):
## colnames(49300): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
##   p1_ATTCTTGTTCTT
## colData names(0):
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">rm</span>(sceNew)</span></code></pre></div>
</div>
<div id="storing-metadata-in-a-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.3</span> Storing (meta)data in a <code>SingleCellExperiment</code> object</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>fakeGeneNames &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;gene&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sce))</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="kw">rowData</span>(sce)<span class="op">$</span>fakeName &lt;-<span class="st"> </span>fakeGeneNames</span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 1 column
##                  fakeName
##               &lt;character&gt;
## KITL                gene1
## TMTC3               gene2
## CEP290              gene3
## 4930430F08RIK       gene4
## 1700017N19RIK       gene5
## MGAT4C              gene6</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># Remove again by setting to NULL</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="kw">rowData</span>(sce)<span class="op">$</span>fakeName &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb42-3"><a href="#cb42-3"></a></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts &lt;-<span class="st"> </span><span class="kw">log1p</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts)</span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="kw">assays</span>(sce)</span></code></pre></div>
<pre><code>## List of length 2
## names(2): counts logCounts</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## 5 x 5 sparse Matrix of class &quot;dgCMatrix&quot;
##               r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA r1_GCGCAACTGCTC r1_GATTGGGAGGCA
## KITL                .               .               0.6931472        .       
## TMTC3               1.3862944       .               .                .       
## CEP290              0.6931472       1.3862944       .                1.098612
## 4930430F08RIK       1.0986123       0.6931472       1.0986123        .       
## 1700017N19RIK       .               .               .                .       
##               r1_CCTCCTAGTTGG
## KITL                .        
## TMTC3               1.0986123
## CEP290              0.6931472
## 4930430F08RIK       0.6931472
## 1700017N19RIK       .</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts &lt;-<span class="st"> </span><span class="ot">NULL</span></span></code></pre></div>
</div>
</div>
<div id="obtaining-and-including-rowdata" class="section level1">
<h1><span class="header-section-number">6</span> Obtaining and including rowData</h1>
<p>The <code>rowData</code> slot of a <code>SingleCellExperiment</code> object allows for storing information on the features, i.e. the genes, in a dataset. In our object, the <code>rowData</code> slot is empty.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">rowData</span>(sce)</span></code></pre></div>
<pre><code>## DataFrame with 24658 rows and 0 columns</code></pre>
<p>As such, the only information we have on the genes are their names, which can be retrieved as the <code>rownames</code> of the expression matrix.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">head</span>(<span class="kw">rownames</span>(sce))</span></code></pre></div>
<pre><code>## [1] &quot;KITL&quot;          &quot;TMTC3&quot;         &quot;CEP290&quot;        &quot;4930430F08RIK&quot;
## [5] &quot;1700017N19RIK&quot; &quot;MGAT4C&quot;</code></pre>
<p>These are the gene names (symbols). Note that it may be useful to include additional information in the <code>rowData</code> slot. For instance, we may want to store:</p>
<ul>
<li>Unambiguous gene identifiers (e.g. from ENSEMBL)</li>
<li>On which chromosome the gene is located</li>
<li>Gene length (genomic start position and end position)</li>
<li>Others…</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="kw">library</span>(<span class="st">&quot;biomaRt&quot;</span>)</span>
<span id="cb51-2"><a href="#cb51-2"></a></span>
<span id="cb51-3"><a href="#cb51-3"></a>ensembl75 &lt;-<span class="st"> </span><span class="kw">useEnsembl</span>(<span class="dt">biomart =</span> <span class="st">&#39;genes&#39;</span>, </span>
<span id="cb51-4"><a href="#cb51-4"></a>                        <span class="dt">dataset =</span> <span class="st">&#39;mmusculus_gene_ensembl&#39;</span>,</span>
<span id="cb51-5"><a href="#cb51-5"></a>                        <span class="dt">version =</span> <span class="dv">75</span>)</span>
<span id="cb51-6"><a href="#cb51-6"></a></span>
<span id="cb51-7"><a href="#cb51-7"></a><span class="kw">head</span>(<span class="kw">listAttributes</span>(ensembl75)) <span class="co"># potential info to extract</span></span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["name"],"name":[1],"type":["chr"],"align":["left"]},{"label":["description"],"name":[2],"type":["chr"],"align":["left"]},{"label":["page"],"name":[3],"type":["chr"],"align":["left"]}],"data":[{"1":"ensembl_gene_id","2":"Ensembl Gene ID","3":"feature_page","_rn_":"1"},{"1":"ensembl_transcript_id","2":"Ensembl Transcript ID","3":"feature_page","_rn_":"2"},{"1":"ensembl_peptide_id","2":"Ensembl Protein ID","3":"feature_page","_rn_":"3"},{"1":"ensembl_exon_id","2":"Ensembl Exon ID","3":"feature_page","_rn_":"4"},{"1":"description","2":"Description","3":"feature_page","_rn_":"5"},{"1":"chromosome_name","2":"Chromosome Name","3":"feature_page","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>geneInfo &lt;-<span class="st"> </span><span class="kw">getBM</span>(<span class="dt">attributes =</span> <span class="kw">c</span>(<span class="st">&quot;ensembl_gene_id&quot;</span>, <span class="co"># ENSEMBL unambiguous identifier</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>                                 <span class="st">&quot;mgi_symbol&quot;</span>, <span class="co"># Gene symbol (to link with SCE rownames),</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>                                 <span class="st">&quot;chromosome_name&quot;</span>, <span class="co"># On which chromosome</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>                                 <span class="st">&quot;start_position&quot;</span>, <span class="co"># Start position</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>                                 <span class="st">&quot;end_position&quot;</span>),<span class="co"># End position</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>                  <span class="dt">mart =</span> ensembl75)</span>
<span id="cb52-7"><a href="#cb52-7"></a></span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="kw">head</span>(geneInfo)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["ensembl_gene_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mgi_symbol"],"name":[2],"type":["chr"],"align":["left"]},{"label":["chromosome_name"],"name":[3],"type":["chr"],"align":["left"]},{"label":["start_position"],"name":[4],"type":["int"],"align":["right"]},{"label":["end_position"],"name":[5],"type":["int"],"align":["right"]}],"data":[{"1":"ENSMUSG00000085172","2":"Gm6542","3":"18","4":"36609958","5":"36610729","_rn_":"1"},{"1":"ENSMUSG00000063514","2":"Gm6756","3":"18","4":"36920396","5":"36922207","_rn_":"2"},{"1":"ENSMUSG00000089983","2":"2010320O07Rik","3":"18","4":"38209772","5":"38229145","_rn_":"3"},{"1":"ENSMUSG00000013653","2":"1810065E05Rik","3":"11","4":"58421111","5":"58426024","_rn_":"4"},{"1":"ENSMUSG00000066475","2":"Gm10268","3":"18","4":"38244828","5":"38245382","_rn_":"5"},{"1":"ENSMUSG00000083766","2":"Gm15335","3":"18","4":"38717528","5":"38718128","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>geneInfo<span class="op">$</span>mgi_symbol_upper &lt;-<span class="st"> </span><span class="kw">toupper</span>(geneInfo<span class="op">$</span>mgi_symbol) </span>
<span id="cb53-2"><a href="#cb53-2"></a><span class="co"># match between gene info and rownames</span></span>
<span id="cb53-3"><a href="#cb53-3"></a></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="kw">sum</span>(<span class="kw">rownames</span>(sce) <span class="op">%in%</span><span class="st"> </span>geneInfo<span class="op">$</span>mgi_symbol_upper)</span></code></pre></div>
<pre><code>## [1] 24360</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="kw">sum</span>(<span class="op">!</span><span class="kw">rownames</span>(sce) <span class="op">%in%</span><span class="st"> </span>geneInfo<span class="op">$</span>mgi_symbol_upper) <span class="co"># lost in conversion :(</span></span></code></pre></div>
<pre><code>## [1] 298</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="kw">rowData</span>(sce) &lt;-<span class="st"> </span>geneInfo[<span class="kw">match</span>(<span class="kw">rownames</span>(sce),geneInfo<span class="op">$</span>mgi_symbol_upper),]</span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 6 columns
##                  ensembl_gene_id    mgi_symbol chromosome_name start_position
##                      &lt;character&gt;   &lt;character&gt;     &lt;character&gt;      &lt;integer&gt;
## KITL          ENSMUSG00000019966          Kitl              10      100015630
## TMTC3         ENSMUSG00000036676         Tmtc3              10      100443902
## CEP290        ENSMUSG00000019971        Cep290              10      100488289
## 4930430F08RIK ENSMUSG00000046567 4930430F08Rik              10      100572274
## 1700017N19RIK ENSMUSG00000056912 1700017N19Rik              10      100592386
## MGAT4C        ENSMUSG00000019888        Mgat4c              10      101681487
##               end_position mgi_symbol_upper
##                  &lt;integer&gt;      &lt;character&gt;
## KITL             100100413             KITL
## TMTC3            100487350            TMTC3
## CEP290           100573655           CEP290
## 4930430F08RIK    100589259    4930430F08RIK
## 1700017N19RIK    100618391    1700017N19RIK
## MGAT4C           102391469           MGAT4C</code></pre>
</div>
<div id="filtering-non-informative-genes" class="section level1">
<h1><span class="header-section-number">7</span> Filtering non-informative genes</h1>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw">library</span>(edgeR)</span></code></pre></div>
<pre><code>## Loading required package: limma</code></pre>
<pre><code>## 
## Attaching package: &#39;limma&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:BiocGenerics&#39;:
## 
##     plotMA</code></pre>
<pre><code>## 
## Attaching package: &#39;edgeR&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:SingleCellExperiment&#39;:
## 
##     cpm</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># A very simple strategy: remove all genes that are expressed in less than 10</span></span>
<span id="cb66-2"><a href="#cb66-2"></a><span class="co"># out of 49300 cells -&gt; note that this a very lenient filtering criterium</span></span>
<span id="cb66-3"><a href="#cb66-3"></a>keep &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb66-4"><a href="#cb66-4"></a><span class="kw">table</span>(keep)</span></code></pre></div>
<pre><code>## keep
## FALSE  TRUE 
##  6771 17887</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>sce &lt;-<span class="st"> </span>sce[keep,]</span></code></pre></div>
<p>Note that dedicated functions for filtering out lowly expressed genes exist. One such function is the <code>filterByExpr</code> function of the edgeR R package. In brief, the strategy keeps genes that have at least “min.count” reads in a worthwhile number samples.</p>
<p>More precisely, the filtering keeps genes that have count-per-million (CPM) above k in n samples.</p>
<p>k is determined by the min.count argument to the function, and by the sample library sizes.</p>
<p>n is determined by the design matrix. n can be seen as the smallest group sample size. A <code>group</code> of samples/cells can be defined as cells that are more similar to one another, e.g., from the same sequencing batch, the same patient…. Here we could also use the cluster assignment (cell type) for each cell as the grouping variable; <em>note however, that this usually is not available until a</em> <em>later stage in the analysis pipeline</em> (i.e., after dimension reduction and clustering, topics we will cover next session.)</p>
<p>If all the group sizes are larger than the <code>large.n</code> argument of the filterByExpr function, which defaults to 10, then n will be taken as <code>min.prop</code>* the the number of samples/cells in the smallest group.</p>
<p>Note that all the group sizes will often be larger than the <code>large.n</code> in case of single-cell data.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a><span class="co"># Slow (more than 1min) -&gt; do not run</span></span>
<span id="cb69-2"><a href="#cb69-2"></a><span class="co"># keep2 &lt;- filterByExpr(sce,</span></span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="co">#                       group = sce$cluster,</span></span>
<span id="cb69-4"><a href="#cb69-4"></a><span class="co">#                       min.count = 1,</span></span>
<span id="cb69-5"><a href="#cb69-5"></a><span class="co">#                       min.total.count = 15,</span></span>
<span id="cb69-6"><a href="#cb69-6"></a><span class="co">#                       min.prop = 0.2)</span></span>
<span id="cb69-7"><a href="#cb69-7"></a><span class="co"># table(keep2)</span></span></code></pre></div>
</div>
<div id="quality-control" class="section level1">
<h1><span class="header-section-number">8</span> Quality control</h1>
<p>In quality control (QC), we check the quality of our dataset. In particular, we investigate undesirable oddities, such as low-quality cells, empty droplets or doublets.</p>
<div id="identifying-and-removing-low-quality-cells" class="section level2">
<h2><span class="header-section-number">8.1</span> Identifying and removing low-quality cells</h2>
<p>There are several distinguishing features of low-quality cells that can be used in order to identify them. <a href="http://bioconductor.org/books/3.14/OSCA.basic/quality-control.html">As described in the OSCA book</a> book):</p>
<ol style="list-style-type: decimal">
<li><p>The library size is defined as the total sum of counts across all relevant features for each cell. Here, we will consider the relevant features to be the endogenous genes. Cells with small library sizes are of low quality as the RNA has been lost at some point during library preparation, either due to cell lysis or inefficient cDNA capture and amplification.</p></li>
<li><p>The number of expressed features in each cell is defined as the number of endogenous genes with non-zero counts for that cell. Any cell with very few expressed genes is likely to be of poor quality as the diverse transcript population has not been successfully captured.</p></li>
<li><p>We sometimes have spike-in (ERCC) transcripts available. The proportion of reads mapped to spike-in transcripts is calculated relative to the total count across all features (including spike-ins) for each cell. As the same amount of spike-in RNA should have been added to each cell, any enrichment in spike-in counts is symptomatic of loss of endogenous RNA.</p></li>
<li><p>In the absence of spike-in transcripts, the proportion of reads mapped to genes in the mitochondrial genome can be used. High proportions are indicative of poor-quality cells (Islam et al. 2014; Ilicic et al. 2016), presumably because of loss of cytoplasmic RNA from perforated cells. The reasoning is that, in the presence of modest damage, the holes in the cell membrane permit efflux of individual transcript molecules but are too small to allow mitochondria to escape, leading to a relative enrichment of mitochondrial transcripts. For single-nuclei RNA-seq experiments, high proportions are also useful as they can mark cells where the cytoplasm has not been successfully stripped.</p></li>
</ol>
</div>
<div id="calculate-qc-variables" class="section level2">
<h2><span class="header-section-number">8.2</span> Calculate QC variables</h2>
<p>This function calculates useful QC metrics for identification and removal of potentially problematic cells. Default per-cell metrics are the sum of counts (i.e., the library size) and the number of detected features. The percentage of counts in the top features also provides a measure of library complexity.</p>
<p>If subsets is specified, these statistics are also computed for each subset of features. This is useful for investigating gene sets of interest, e.g., mitochondrial genes.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="kw">library</span>(scater)</span>
<span id="cb70-2"><a href="#cb70-2"></a></span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="co"># check ERCC spike-in transcripts</span></span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="kw">sum</span>(<span class="kw">grepl</span>(<span class="st">&quot;^ERCC-&quot;</span>, <span class="kw">rownames</span>(sce))) <span class="co"># no spike-in transcripts available</span></span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># check mitochondrial genes</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="kw">sum</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>chromosome_name<span class="op">==</span><span class="st">&quot;MT&quot;</span>,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># 28 mitochondrial genes</span></span></code></pre></div>
<pre><code>## [1] 28</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="kw">sum</span>(<span class="kw">grepl</span>(<span class="st">&quot;^MT-&quot;</span>, <span class="kw">rownames</span>(sce))) <span class="co"># alternatively</span></span></code></pre></div>
<pre><code>## [1] 28</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>is.mito &lt;-<span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;^MT-&quot;</span>, <span class="kw">rownames</span>(sce))</span>
<span id="cb76-2"><a href="#cb76-2"></a></span>
<span id="cb76-3"><a href="#cb76-3"></a><span class="co">## calculate QC metrics</span></span>
<span id="cb76-4"><a href="#cb76-4"></a>df &lt;-<span class="st"> </span><span class="kw">perCellQCMetrics</span>(sce, <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mito=</span>is.mito))</span>
<span id="cb76-5"><a href="#cb76-5"></a><span class="kw">head</span>(df)</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 6 columns
##                       sum  detected subsets_Mito_sum subsets_Mito_detected
##                 &lt;numeric&gt; &lt;integer&gt;        &lt;numeric&gt;             &lt;integer&gt;
## r1_GGCCGCAGTCCG     37478      7235              427                    14
## r1_CTTGTGCGGGAA     32034      6921              503                    15
## r1_GCGCAACTGCTC     28140      6390              460                    13
## r1_GATTGGGAGGCA     20352      5727              326                    11
## r1_CCTCCTAGTTGG     19550      5769              264                     9
## r1_AGTCAAGCCCTC     19176      5217              253                    12
##                 subsets_Mito_percent     total
##                            &lt;numeric&gt; &lt;numeric&gt;
## r1_GGCCGCAGTCCG              1.13934     37478
## r1_CTTGTGCGGGAA              1.57021     32034
## r1_GCGCAACTGCTC              1.63468     28140
## r1_GATTGGGAGGCA              1.60181     20352
## r1_CCTCCTAGTTGG              1.35038     19550
## r1_AGTCAAGCCCTC              1.31936     19176</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="co"># add QC variables to sce object</span></span>
<span id="cb78-2"><a href="#cb78-2"></a><span class="kw">colData</span>(sce) &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">colData</span>(sce), df)</span>
<span id="cb78-3"><a href="#cb78-3"></a></span>
<span id="cb78-4"><a href="#cb78-4"></a><span class="co"># the QC variables have now been added to the colData of our SCE object.</span></span>
<span id="cb78-5"><a href="#cb78-5"></a><span class="kw">head</span>(<span class="kw">colData</span>(sce))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 8 columns
##                         cell.id   cluster       sum  detected subsets_Mito_sum
##                     &lt;character&gt; &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;        &lt;numeric&gt;
## r1_GGCCGCAGTCCG r1_GGCCGCAGTCCG         2     37478      7235              427
## r1_CTTGTGCGGGAA r1_CTTGTGCGGGAA         2     32034      6921              503
## r1_GCGCAACTGCTC r1_GCGCAACTGCTC         2     28140      6390              460
## r1_GATTGGGAGGCA r1_GATTGGGAGGCA         2     20352      5727              326
## r1_CCTCCTAGTTGG r1_CCTCCTAGTTGG        NA     19550      5769              264
## r1_AGTCAAGCCCTC r1_AGTCAAGCCCTC        NA     19176      5217              253
##                 subsets_Mito_detected subsets_Mito_percent     total
##                             &lt;integer&gt;            &lt;numeric&gt; &lt;numeric&gt;
## r1_GGCCGCAGTCCG                    14              1.13934     37478
## r1_CTTGTGCGGGAA                    15              1.57021     32034
## r1_GCGCAACTGCTC                    13              1.63468     28140
## r1_GATTGGGAGGCA                    11              1.60181     20352
## r1_CCTCCTAGTTGG                     9              1.35038     19550
## r1_AGTCAAGCCCTC                    12              1.31936     19176</code></pre>
</div>
<div id="exploratory-data-analysis" class="section level2">
<h2><span class="header-section-number">8.3</span> Exploratory data analysis</h2>
<p>In the figure below, we see that several cells have a very low number of expressed genes, and where most of the molecules are derived from mitochondrial genes. This indicates likely damaged cells, presumably because of loss of cytoplasmic RNA from perforated cells, so we should remove these for the downstream analysis.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a><span class="co"># Number of genes vs library size</span></span>
<span id="cb80-2"><a href="#cb80-2"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;sum&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;cluster&quot;</span>) </span>
<span id="cb80-3"><a href="#cb80-3"></a></span>
<span id="cb80-4"><a href="#cb80-4"></a><span class="co"># Mitochondrial genes</span></span>
<span id="cb80-5"><a href="#cb80-5"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;detected&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>)</span></code></pre></div>
</div>
<div id="qc-using-adaptive-thresholds" class="section level2">
<h2><span class="header-section-number">8.4</span> QC using adaptive thresholds</h2>
<p>Below, we remove cells that are outlying with respect to</p>
<ol style="list-style-type: decimal">
<li>A low sequencing depth (number of UMIs);</li>
<li>A low number of genes detected;</li>
<li>A high percentage of reads from mitochondrial genes.</li>
</ol>
<p>Here we will remove cells for QC based on <strong>adaptive thresholds</strong> related to the three points from above. Adaptive trhesholds are used as opposed to <strong>fixed thresholds</strong>.</p>
<p>With fixed thresholds, we use fixed cut-off values for each cell to pass QC, e.g., we might consider cells to be low quality if they have library sizes below 100,000 reads; express fewer than 5,000 genes; have spike-in proportions above 10%; or have mitochondrial proportions above 10%.</p>
<p>With adaptive thresholds, we assume that most of the dataset consists of high-quality cells. We then identify cells that are outliers for the various QC metrics, based on the median absolute deviation (MAD) from the median value of each metric across all cells. By default, we consider a value to be anoutlier if it is more than 3 MADs from the median in the “problematic” direction. This is loosely motivated by the fact that such a filter will retain 99% of non-outlier values that follow a normal distribution. We demonstrate adopting adaptive thresholds on the Macosko dataset:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>lowLib &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>sum, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>, <span class="dt">log=</span><span class="ot">TRUE</span>)</span>
<span id="cb81-2"><a href="#cb81-2"></a>lowFeatures &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>detected, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>, <span class="dt">log=</span><span class="ot">TRUE</span>)</span>
<span id="cb81-3"><a href="#cb81-3"></a>highMito &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)</span>
<span id="cb81-4"><a href="#cb81-4"></a></span>
<span id="cb81-5"><a href="#cb81-5"></a><span class="kw">table</span>(lowLib)</span></code></pre></div>
<pre><code>## lowLib
## FALSE 
## 49300</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="kw">table</span>(lowFeatures)</span></code></pre></div>
<pre><code>## lowFeatures
## FALSE  TRUE 
## 49287    13</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="kw">table</span>(highMito)</span></code></pre></div>
<pre><code>## highMito
## FALSE  TRUE 
## 45890  3410</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>discardCells &lt;-<span class="st"> </span>(lowLib <span class="op">|</span><span class="st"> </span>lowFeatures <span class="op">|</span><span class="st"> </span>highMito)</span>
<span id="cb87-2"><a href="#cb87-2"></a><span class="kw">table</span>(discardCells)</span></code></pre></div>
<pre><code>## discardCells
## FALSE  TRUE 
## 45877  3423</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="kw">colData</span>(sce)<span class="op">$</span>discardCells &lt;-<span class="st"> </span>discardCells</span>
<span id="cb89-2"><a href="#cb89-2"></a></span>
<span id="cb89-3"><a href="#cb89-3"></a><span class="co"># visualize cells to be removed</span></span>
<span id="cb89-4"><a href="#cb89-4"></a><span class="co"># plotColData(sce, x = &quot;sum&quot;, y=&quot;detected&quot;, colour_by=&quot;discardCells&quot;)</span></span>
<span id="cb89-5"><a href="#cb89-5"></a><span class="co"># plotColData(sce, x = &quot;detected&quot;, y=&quot;subsets_Mito_percent&quot;, colour_by = &quot;discardCells&quot;)</span></span></code></pre></div>
<p>We removed a total of <span class="math inline">\(3423\)</span> cells, most of which because of an outlyingly high percentage of reads from mitochondrial genes.</p>
</div>
<div id="identifying-and-removing-empty-droplets" class="section level2">
<h2><span class="header-section-number">8.5</span> Identifying and removing empty droplets</h2>
<p>Note that the removal of cells with low sequencing depth using the adaptive threshold procedure above is a way of removing empty droplets. Other approaches are possible, e.g., removing cells by statistical testing using <code>emtpyDrops</code>. This does require us to specify a lower bound on the total number of UMIs, below which all cells are considered to correspond to empty droplets. This lower bound may not be trivial to derive, but the <code>barcodeRanks</code> function can be useful to identify an elbow/knee point.</p>
<p>In brief, the steps taken by the <code>emtpyDrops</code> function can be summarized as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Define threshold T of total UMI counts (e.g. with the help of the <code>barcodeRanks</code> function), below which cells may be considered to be from empty droplets. Call this set of cells E.</p></li>
<li><p>Define <span class="math inline">\(A_g\)</span> as the total gene expression across all cells in E.</p></li>
<li><p>Define <span class="math inline">\(pi_g\)</span> as the relative contribution of gene g to the ambient profile.</p></li>
<li><p>Calculate p-value for each cell to have a transcriptional profile similar to the ambient solution. Intuitively, a p-value below the requested alpha level would correspond to a cell for which the observed count profile strongly deviates from the count profile observed in the cells with a library size below threshold T, i.e., a non-empty droplet.</p></li>
</ol>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a><span class="kw">library</span>(DropletUtils)</span>
<span id="cb90-2"><a href="#cb90-2"></a>bcrank &lt;-<span class="st"> </span><span class="kw">barcodeRanks</span>(<span class="kw">counts</span>(sce))</span>
<span id="cb90-3"><a href="#cb90-3"></a></span>
<span id="cb90-4"><a href="#cb90-4"></a><span class="co"># Only showing unique points for plotting speed. Duplicated ranks are a </span></span>
<span id="cb90-5"><a href="#cb90-5"></a><span class="co"># consequence of ties in the ranks, i.e., when cells have an equal library size.</span></span>
<span id="cb90-6"><a href="#cb90-6"></a><span class="kw">sum</span>(<span class="kw">duplicated</span>(bcrank<span class="op">$</span>rank))</span></code></pre></div>
<pre><code>## [1] 43864</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a>uniq &lt;-<span class="st"> </span><span class="op">!</span><span class="kw">duplicated</span>(bcrank<span class="op">$</span>rank)</span>
<span id="cb92-2"><a href="#cb92-2"></a></span>
<span id="cb92-3"><a href="#cb92-3"></a><span class="kw">plot</span>(bcrank<span class="op">$</span>rank[uniq], bcrank<span class="op">$</span>total[uniq], <span class="dt">log=</span><span class="st">&quot;xy&quot;</span>,</span>
<span id="cb92-4"><a href="#cb92-4"></a>    <span class="dt">xlab=</span><span class="st">&quot;Rank&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Total UMI count&quot;</span>, <span class="dt">cex.lab=</span><span class="fl">1.2</span>)</span>
<span id="cb92-5"><a href="#cb92-5"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(bcrank)<span class="op">$</span>inflection, <span class="dt">col=</span><span class="st">&quot;darkgreen&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb92-6"><a href="#cb92-6"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(bcrank)<span class="op">$</span>knee, <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb92-7"><a href="#cb92-7"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">350</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) <span class="co"># picked visually myself</span></span>
<span id="cb92-8"><a href="#cb92-8"></a><span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>, </span>
<span id="cb92-9"><a href="#cb92-9"></a>       <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;Inflection&quot;</span>, <span class="st">&quot;Knee&quot;</span>, <span class="st">&quot;Empirical knee point&quot;</span>), </span>
<span id="cb92-10"><a href="#cb92-10"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;dodgerblue&quot;</span>, <span class="st">&quot;orange&quot;</span>), </span>
<span id="cb92-11"><a href="#cb92-11"></a>       <span class="dt">lty=</span><span class="dv">2</span>, </span>
<span id="cb92-12"><a href="#cb92-12"></a>       <span class="dt">cex=</span><span class="fl">1.2</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb93-2"><a href="#cb93-2"></a>limit &lt;-<span class="st"> </span><span class="dv">350</span>   </span>
<span id="cb93-3"><a href="#cb93-3"></a>all.out &lt;-<span class="st"> </span><span class="kw">emptyDrops</span>(<span class="kw">counts</span>(sce), <span class="dt">lower=</span>limit, <span class="dt">test.ambient=</span><span class="ot">TRUE</span>)</span>
<span id="cb93-4"><a href="#cb93-4"></a><span class="co"># p-values for cells with total UMI count under the lower bound.</span></span>
<span id="cb93-5"><a href="#cb93-5"></a><span class="kw">hist</span>(all.out<span class="op">$</span>PValue[all.out<span class="op">$</span>Total <span class="op">&lt;=</span><span class="st"> </span>limit <span class="op">&amp;</span><span class="st"> </span>all.out<span class="op">$</span>Total <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>],</span>
<span id="cb93-6"><a href="#cb93-6"></a>    <span class="dt">xlab=</span><span class="st">&quot;P-value&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">breaks=</span><span class="dv">20</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-19-2.png" width="672" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># but note that it would remove a very high number of cells</span></span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="kw">length</span>(<span class="kw">which</span>(all.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.01</span>)) <span class="co"># retained</span></span></code></pre></div>
<pre><code>## [1] 27230</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a><span class="co"># so we stick to the more lenient adaptive filtering strategy</span></span>
<span id="cb96-2"><a href="#cb96-2"></a><span class="co"># remove cells identified using adaptive thresholds</span></span>
<span id="cb96-3"><a href="#cb96-3"></a>sce &lt;-<span class="st"> </span>sce[, <span class="op">!</span><span class="kw">colData</span>(sce)<span class="op">$</span>discardCells]</span></code></pre></div>
</div>
<div id="identifying-and-removing-doublets" class="section level2">
<h2><span class="header-section-number">8.6</span> Identifying and removing doublets</h2>
<p>We will use <a href="https://bioconductor.org/packages/3.14/bioc/html/scDblFinder.html">scDblFinder</a> to detect doublet cells.</p>
<p>As discussed in the theory session of last week, the steps taken by <code>scDblFinder</code> can be summarized as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Perform principal components analysis (PCA) on log-normalized expression counts. This allows for projecting each cell in the dataset into a 2D space (for more details on PCA, see next weeks session).</p></li>
<li><p>Randomly select two cells, sum their counts and normalize, and project into PCA space from step 1. In other words, artificially generate doublets and see where they are located in the 2D space.</p></li>
<li><p>Repeat step 2 many times (generate many artificial doublets).</p></li>
<li><p>Generate neighbor network in the 2D space. The network is then used to estimate a number of characteristics for each cell, in particular the proportion f artificial doublets among the nearest neighbors.</p></li>
<li><p>Use this information, along with other predictors, to train a classifier (gradient boosted tree) that allows for distinguishing doublets from singlets.</p></li>
</ol>
<p>Note: only classifies for identifying doublets for which the two cells are from different cell type clusters.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co">## perform doublet detection</span></span>
<span id="cb97-2"><a href="#cb97-2"></a><span class="kw">library</span>(scDblFinder)</span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a><span class="kw">set.seed</span>(<span class="dv">211103</span>)</span>
<span id="cb98-2"><a href="#cb98-2"></a>sampleID &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">strsplit</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cell.id, <span class="dt">split=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;[[&quot;</span>, <span class="dv">1</span>))</span>
<span id="cb98-3"><a href="#cb98-3"></a><span class="kw">table</span>(sampleID)</span></code></pre></div>
<pre><code>## sampleID
##   p1   r1   r2   r3   r4   r5   r6 
## 3942 5953 8414 5319 7015 7487 7747</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a>sce &lt;-<span class="st"> </span><span class="kw">scDblFinder</span>(sce, </span>
<span id="cb100-2"><a href="#cb100-2"></a>                   <span class="dt">returnType=</span><span class="st">&quot;table&quot;</span>,</span>
<span id="cb100-3"><a href="#cb100-3"></a>                   <span class="dt">samples =</span> <span class="kw">factor</span>(sampleID))</span>
<span id="cb100-4"><a href="#cb100-4"></a><span class="kw">table</span>(sce<span class="op">$</span>scDblFinder.class)</span></code></pre></div>
<pre><code>## 
## singlet doublet 
##   41036    4841</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="co">## visualize these scores</span></span>
<span id="cb102-2"><a href="#cb102-2"></a><span class="co">## explore doublet score wrt original cluster labels</span></span>
<span id="cb102-3"><a href="#cb102-3"></a><span class="kw">boxplot</span>(<span class="kw">log1p</span>(sce<span class="op">$</span>scDblFinder.score) <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, <span class="dt">exclude=</span><span class="ot">NULL</span>))</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>tab &lt;-<span class="st"> </span><span class="kw">table</span>(sce<span class="op">$</span>scDblFinder.class, sce<span class="op">$</span>cluster, </span>
<span id="cb103-2"><a href="#cb103-2"></a>      <span class="dt">exclude=</span><span class="ot">NULL</span>)</span>
<span id="cb103-3"><a href="#cb103-3"></a>tab</span></code></pre></div>
<pre><code>##          
##               1     2     3     4     5     6     7     8     9    10    11
##   singlet   212   364   254    64    66   174   263   142   310   164   175
##   doublet     3    13    21     8     8    31    54     7    27    25    32
##          
##              12    13    14    15    16    17    18    19    20    21    22
##   singlet   206    45    86    52   196   312    64   109   320   173   204
##   doublet    48     5    22    20    55    59    16    16    62    74    57
##          
##              23    24    25    26    27    28    29    30    31    32    33
##   singlet   215 24994  1549  1937   472   343   460   511   412   269   662
##   doublet    44  1949   224   224   157   138   121   119    90    49   151
##          
##              34    35    36    37    38    39  &lt;NA&gt;
##   singlet  1418    36    41   228    57    62  3415
##   doublet   146     7     4    12     2     4   737</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a><span class="kw">t</span>(<span class="kw">t</span>(tab) <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(tab))</span></code></pre></div>
<pre><code>##          
##                    1          2          3          4          5          6
##   singlet 0.98604651 0.96551724 0.92363636 0.88888889 0.89189189 0.84878049
##   doublet 0.01395349 0.03448276 0.07636364 0.11111111 0.10810811 0.15121951
##          
##                    7          8          9         10         11         12
##   singlet 0.82965300 0.95302013 0.91988131 0.86772487 0.84541063 0.81102362
##   doublet 0.17034700 0.04697987 0.08011869 0.13227513 0.15458937 0.18897638
##          
##                   13         14         15         16         17         18
##   singlet 0.90000000 0.79629630 0.72222222 0.78087649 0.84097035 0.80000000
##   doublet 0.10000000 0.20370370 0.27777778 0.21912351 0.15902965 0.20000000
##          
##                   19         20         21         22         23         24
##   singlet 0.87200000 0.83769634 0.70040486 0.78160920 0.83011583 0.92766210
##   doublet 0.12800000 0.16230366 0.29959514 0.21839080 0.16988417 0.07233790
##          
##                   25         26         27         28         29         30
##   singlet 0.87366046 0.89634429 0.75039746 0.71309771 0.79173838 0.81111111
##   doublet 0.12633954 0.10365571 0.24960254 0.28690229 0.20826162 0.18888889
##          
##                   31         32         33         34         35         36
##   singlet 0.82071713 0.84591195 0.81426814 0.90664962 0.83720930 0.91111111
##   doublet 0.17928287 0.15408805 0.18573186 0.09335038 0.16279070 0.08888889
##          
##                   37         38         39       &lt;NA&gt;
##   singlet 0.95000000 0.96610169 0.93939394 0.82249518
##   doublet 0.05000000 0.03389831 0.06060606 0.17750482</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a><span class="kw">barplot</span>(<span class="kw">t</span>(<span class="kw">t</span>(tab) <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(tab))[<span class="dv">2</span>,],</span>
<span id="cb107-2"><a href="#cb107-2"></a>        <span class="dt">xlab =</span> <span class="st">&quot;Cluster&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Fraction of doublets&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-21-2.png" width="672" /></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a><span class="kw">range</span>(sce<span class="op">$</span>scDblFinder.score[sce<span class="op">$</span>scDblFinder.class  <span class="op">==</span><span class="st"> &quot;doublet&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sampleID <span class="op">==</span><span class="st"> &quot;r1&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 0.7053791 0.9999142</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a><span class="kw">range</span>(sce<span class="op">$</span>scDblFinder.score[sce<span class="op">$</span>scDblFinder.class  <span class="op">==</span><span class="st"> &quot;singlet&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sampleID <span class="op">==</span><span class="st"> &quot;r1&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 0.0000222011 0.7013915181</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a><span class="co"># remove doublets</span></span>
<span id="cb112-2"><a href="#cb112-2"></a>sce &lt;-<span class="st"> </span>sce[,<span class="op">!</span>sce<span class="op">$</span>scDblFinder.class <span class="op">==</span><span class="st"> &quot;doublet&quot;</span>]</span></code></pre></div>
</div>
</div>
<div id="normalization" class="section level1">
<h1><span class="header-section-number">9</span> Normalization</h1>
<p>Normalization aims to remove technical effects such as sequencing depth so that comparisons between cells are not confounded by them. The most commonly used normalization methods methods use scaling, where a scaling factor (also called size factor, normalization factor) is estimated for each cell. These scaling factors (e.g., the effective library size) can be included as an offset to downstream modeling procedures. This effectively allows for performing inference on the relative abundance of a gene in a cell, after accounting for library size and RNA composition differences between cells, which is much more relevant than comparing raw counts</p>
<p>For normalization, the size factors <span class="math inline">\(s_i\)</span> computed here are simply scaled library sizes: <span class="math display">\[ N_i = \sum_g Y_{gi} \]</span> <span class="math display">\[ s_i = N_i / \bar{N}_i \]</span></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a>sce &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce)</span>
<span id="cb113-2"><a href="#cb113-2"></a></span>
<span id="cb113-3"><a href="#cb113-3"></a><span class="co"># note we also returned log counts: see the additional logcounts assay.</span></span>
<span id="cb113-4"><a href="#cb113-4"></a>sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 17887 41036 
## metadata(0):
## assays(2): counts logcounts
## rownames(17887): KITL TMTC3 ... GM16012 GM21464
## rowData names(6): ensembl_gene_id mgi_symbol ... end_position
##   mgi_symbol_upper
## colnames(41036): r1_GGCCGCAGTCCG r1_CTTGTGCGGGAA ... p1_TAACGCGCTCCT
##   p1_ATTCTTGTTCTT
## colData names(15): cell.id cluster ... scDblFinder.cxds_score
##   sizeFactor
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># you can extract size factors using</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>sf &lt;-<span class="st"> </span><span class="kw">librarySizeFactors</span>(sce)</span>
<span id="cb115-3"><a href="#cb115-3"></a><span class="kw">mean</span>(sf) <span class="co"># equal to 1 due to scaling.</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a><span class="kw">plot</span>(<span class="dt">x=</span> <span class="kw">log</span>(<span class="kw">colSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts)), </span>
<span id="cb117-2"><a href="#cb117-2"></a>     <span class="dt">y=</span>sf)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>From the OSCA book: Alternatively, we may use more sophisticated approaches for variance stabilizing transformations in genomics data, e.g., <code>DESeq2</code> or <code>sctransform</code>. These aim to remove the mean-variance trend more effectively than the simpler transformations mentioned above, though it could be argued whether this is actually desirable. For low-coverage scRNA-seq data, there will always be a mean-variance trend under any transformation, for the simple reason that the variance must be zero when the mean count is zero. These methods also face the challenge of removing the mean-variance trend while preserving the interesting component of variation, i.e., the log-fold changes between subpopulations; this may or may not be done adequately, depending on the aggressiveness of the algorithm.</p>
<p>In practice, the log-transformation is a good default choice due to its simplicity and interpretability, and is what we will be using for all downstream analyses.</p>
<hr />
<p>— end lab session 1 —</p>
<hr />
</div>
<div id="normalization-continued" class="section level1">
<h1><span class="header-section-number">10</span> Normalization (continued)</h1>
<p>Normalization is necessary to correct for several sources of technical variation:</p>
<ul>
<li><strong>Differences in sequencing depth</strong> between samples. Some samples get sequenced deeper in the sense that they consist of more (mapped) reads and therefore can be considered to contain a higher amount of information, which we should be taking into account. In addition, if a sample is sequenced deeper, it is natural that the counts for each gene will be higher, jeopardizing a direct comparison of the expression counts.</li>
<li><strong>Differences in RNA population composition</strong> between samples. As an extreme example, suppose that two samples have been sequenced to the exact same depth. One sample is contaminated and has a very high concentration of the contaminant cDNA being sequenced, but otherwise the two samples are identical. Since the contaminant will be taking up a significant proportion of the reads being sequenced, the counts will not be directly comparable between the samples. Hence, we may also want to correct for differences in the composition of the RNA population of the samples (see <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf">edgeR manual chapter 2.8</a>).</li>
<li><strong>Other technical variation</strong> such as sample-specific GC-content or transcript length effects may also be accounted for.</li>
</ul>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster)</span></code></pre></div>
<pre><code>## 
##     1     2     3     4     5     6     7     8     9    10    11    12    13 
##   212   364   254    64    66   174   263   142   310   164   175   206    45 
##    14    15    16    17    18    19    20    21    22    23    24    25    26 
##    86    52   196   312    64   109   320   173   204   215 24994  1549  1937 
##    27    28    29    30    31    32    33    34    35    36    37    38    39 
##   472   343   460   511   412   269   662  1418    36    41   228    57    62</code></pre>
<p>Below, we will visualize the normalization occurring between two cells of the same cell type (which could be considered technical repeats):</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1"></a>select &lt;-<span class="st"> </span>sce<span class="op">$</span>cluster <span class="op">==</span><span class="st"> &quot;1&quot;</span></span>
<span id="cb120-2"><a href="#cb120-2"></a>select[<span class="kw">is.na</span>(select)] &lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb120-3"><a href="#cb120-3"></a>cs &lt;-<span class="st"> </span><span class="kw">colSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts[,select])</span>
<span id="cb120-4"><a href="#cb120-4"></a>cs[<span class="kw">order</span>(cs, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)][<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)]</span></code></pre></div>
<pre><code>## r2_GTTTACTTCCCC r1_GATTTCCTCTGA 
##           20869           14719</code></pre>
<p>Let’s take a look at how comparable two cells (replicates) of cluster 1 are. We will compare the cell with the highest library size with the cell that has the 10th highest library size using MD-plots (mean-difference plots, as introduced by <a href="https://www.jstor.org/stable/24307038?seq=1#metadata_info_tab_contents">Dudoit et al. (2002)</a>), also sometimes referred to as MA-plots.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1"></a>targetCells &lt;-<span class="st"> </span><span class="kw">names</span>(cs[<span class="kw">order</span>(cs, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)][<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)])</span>
<span id="cb122-2"><a href="#cb122-2"></a></span>
<span id="cb122-3"><a href="#cb122-3"></a>M &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells])</span>
<span id="cb122-4"><a href="#cb122-4"></a>D &lt;-<span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells[<span class="dv">2</span>]] <span class="op">/</span><span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells[<span class="dv">1</span>]]</span>
<span id="cb122-5"><a href="#cb122-5"></a><span class="kw">plot</span>(<span class="dt">x =</span> <span class="kw">log</span>(M), <span class="dt">y =</span> <span class="kw">log2</span>(D),</span>
<span id="cb122-6"><a href="#cb122-6"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb122-7"><a href="#cb122-7"></a>     <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Cell &quot;</span>, targetCells[<span class="dv">2</span>], <span class="st">&quot; vs cell &quot;</span>, targetCells[<span class="dv">1</span>]),</span>
<span id="cb122-8"><a href="#cb122-8"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Log mean&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Log2 fold-change&quot;</span>,</span>
<span id="cb122-9"><a href="#cb122-9"></a>     <span class="dt">bty =</span> <span class="st">&#39;l&#39;</span>)</span>
<span id="cb122-10"><a href="#cb122-10"></a><span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>We see clear bias in the comparison of the 1st and 10th most deeply sequenced cell from cell cluster 1. We see that the log fold-changes are biased downwards. This means that, on average, a gene is higher expressed in cell 1 versus cell 10. Looking at the library sizes, we can indeed see that the library size for cell 1 is 20869 counts, while it is only 14719 counts for cell 10! This is a clear library size effect that we should take into account.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a><span class="co"># normalize the count data using the previously computed &quot;size factors&quot;</span></span>
<span id="cb123-2"><a href="#cb123-2"></a><span class="kw">assay</span>(sce, <span class="st">&quot;normed&quot;</span>) &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(sce, </span>
<span id="cb123-3"><a href="#cb123-3"></a>                                        <span class="dt">log=</span><span class="ot">FALSE</span>,</span>
<span id="cb123-4"><a href="#cb123-4"></a>                                        <span class="dt">size.factors=</span>sce<span class="op">$</span>sizeFactor, </span>
<span id="cb123-5"><a href="#cb123-5"></a>                                        <span class="dt">pseudo.count=</span><span class="dv">0</span>)</span>
<span id="cb123-6"><a href="#cb123-6"></a></span>
<span id="cb123-7"><a href="#cb123-7"></a>M &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells])</span>
<span id="cb123-8"><a href="#cb123-8"></a>D &lt;-<span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells[<span class="dv">2</span>]] <span class="op">/</span><span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells[<span class="dv">1</span>]]</span>
<span id="cb123-9"><a href="#cb123-9"></a><span class="kw">plot</span>(<span class="dt">x =</span> <span class="kw">log</span>(M), <span class="dt">y =</span> <span class="kw">log2</span>(D),</span>
<span id="cb123-10"><a href="#cb123-10"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb123-11"><a href="#cb123-11"></a>     <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Cell &quot;</span>, targetCells[<span class="dv">2</span>], <span class="st">&quot; vs cell &quot;</span>, targetCells[<span class="dv">1</span>]),</span>
<span id="cb123-12"><a href="#cb123-12"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Log mean&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Log2 fold-change&quot;</span>,</span>
<span id="cb123-13"><a href="#cb123-13"></a>     <span class="dt">bty =</span> <span class="st">&#39;l&#39;</span>)</span>
<span id="cb123-14"><a href="#cb123-14"></a><span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<p>Upon normalizing the data using size factors, we have removed bias as a consequence of differences in sequencing depth.</p>
<p>Note that we computed the normalized count matrix only for demonstrating the effect of such normalization. In a typical workflow, the size factors are used as offsets in the downstream models rather than to perform data transformation. In brief, such transformation would distort the mean-variance relationship in the data. For more details, we refer to the document that was touched upon in the first theory session (<a href="https://statomics.github.io/SGA21/sequencing_scalingNormalization.html">link</a>)</p>
</div>
<div id="feature-selection" class="section level1">
<h1><span class="header-section-number">11</span> Feature selection</h1>
<p>As dimensions increase, shortest and farthest distances between points become nearly inseparable. In high-dimensional space, it is therefore extremely difficult to separate signal from noise.</p>
<p>In order to recover structure (e.g. setting up a dimension-reduced space to help us find cell-type clusters in the data), we want to move to an informative, lower-dimensional space. We will select genes which we hope are informative for recovering the biological structure. But what defines an informative gene?</p>
<div id="selecting-genes-with-high-variance" class="section level2">
<h2><span class="header-section-number">11.1</span> Selecting genes with high variance</h2>
<p>The simplest approach to quantifying per-gene variation is to compute the variance of the log-normalized expression values (i.e., “log-counts”) for each gene across all cells.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1"></a><span class="co"># calculate variance of log-normalized counts for each gene</span></span>
<span id="cb124-2"><a href="#cb124-2"></a>geneVars &lt;-<span class="st"> </span>genefilter<span class="op">::</span><span class="kw">rowVars</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>logcounts)</span>
<span id="cb124-3"><a href="#cb124-3"></a><span class="co"># select top 1000 highly variable genes</span></span>
<span id="cb124-4"><a href="#cb124-4"></a>highVarGenes &lt;-<span class="st"> </span><span class="kw">names</span>(geneVars)[<span class="kw">order</span>(geneVars, <span class="dt">decreasing=</span><span class="ot">TRUE</span>)[<span class="dv">1</span><span class="op">:</span><span class="fl">1e3</span>]]</span>
<span id="cb124-5"><a href="#cb124-5"></a><span class="kw">head</span>(highVarGenes)</span></code></pre></div>
</div>
<div id="selecting-genes-with-high-variation-with-respect-to-mean" class="section level2">
<h2><span class="header-section-number">11.2</span> Selecting genes with high variation with respect to mean</h2>
<p>While calculation of the per-gene variance is simple, feature selection requires modelling of the mean-variance relationship. Indeed, not accounting for the mean-variance structure while selecting highly variable genes will oftentimes boil down to selecting the most highly expressed genes. The log-transformation is a helpful variance stabilizing transformation, however, it is not perfect, meaning that the variance of a gene is not completely independent of its mean. Therefore, feature selection may still be driven by average expression rather than underlying biological heterogeneity.</p>
<p>A (rightly so) popular approach is to select genes that have a high variance with respect to their mean. Often, first an empirical mean-variance trend is fitted, upon which genes with the highest positive residuals are selected. Being intuitive, reasonable and fairly straight-forward, this method is widely used.</p>
<p>To account for the mean-variance effect, we use the <code>modelGeneVar</code> function of the <code>scran</code> package to fit a trend to the variance with respect to abundance across all genes (on log-normalized expression values of the sce object).</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a><span class="kw">library</span>(scran)</span>
<span id="cb125-2"><a href="#cb125-2"></a>dec &lt;-<span class="st"> </span><span class="kw">modelGeneVar</span>(sce)</span>
<span id="cb125-3"><a href="#cb125-3"></a><span class="kw">head</span>(dec)</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 6 columns
##                      mean       total        tech          bio   p.value
##                 &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;    &lt;numeric&gt; &lt;numeric&gt;
## KITL          0.008777743 0.011468955 0.011567858 -9.89021e-05  0.525710
## TMTC3         0.047808247 0.070339120 0.062648596  7.69052e-03  0.177233
## CEP290        0.538342285 0.797002183 0.654153448  1.42849e-01  0.049759
## 4930430F08RIK 0.048310644 0.063629062 0.063302338  3.26723e-04  0.484472
## 1700017N19RIK 0.000483927 0.000534856 0.000638521 -1.03665e-04  0.889643
## MGAT4C        0.015591625 0.015819602 0.020527248 -4.70765e-03  0.958176
##                     FDR
##               &lt;numeric&gt;
## KITL                  1
## TMTC3                 1
## CEP290                1
## 4930430F08RIK         1
## 1700017N19RIK         1
## MGAT4C                1</code></pre>
<p>The fitted value for each gene is used as a proxy for the technical component of variation for each gene, under the assumption that most genes exhibit a low baseline level of variation that is not biologically interesting. The biological component of variation for each gene is defined as the the residual from the trend. Ranking genes by the biological component enables identification of interesting genes for downstream analyses in a manner that accounts for the mean-variance relationship.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>fitRetina &lt;-<span class="st"> </span><span class="kw">metadata</span>(dec)</span>
<span id="cb127-2"><a href="#cb127-2"></a><span class="kw">plot</span>(fitRetina<span class="op">$</span>mean, fitRetina<span class="op">$</span>var, </span>
<span id="cb127-3"><a href="#cb127-3"></a>     <span class="dt">xlab=</span><span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb127-4"><a href="#cb127-4"></a>    <span class="dt">ylab=</span><span class="st">&quot;Variance of log-expression&quot;</span>)</span>
<span id="cb127-5"><a href="#cb127-5"></a><span class="kw">curve</span>(fitRetina<span class="op">$</span><span class="kw">trend</span>(x), <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
<p>We are interested in those genes for which the variance in expression is higher than what we would expect for that gene based on its mean expression.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1"></a><span class="co"># get 10% most variable genes</span></span>
<span id="cb128-2"><a href="#cb128-2"></a>hvg &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec, </span>
<span id="cb128-3"><a href="#cb128-3"></a>                  <span class="dt">prop=</span><span class="fl">0.1</span>)</span>
<span id="cb128-4"><a href="#cb128-4"></a><span class="kw">head</span>(hvg)</span></code></pre></div>
<pre><code>## [1] &quot;RHO&quot;     &quot;CALM1&quot;   &quot;MEG3&quot;    &quot;GNGT1&quot;   &quot;RPGRIP1&quot; &quot;TRPM1&quot;</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1"></a><span class="co"># plot these </span></span>
<span id="cb130-2"><a href="#cb130-2"></a><span class="kw">plot</span>(fitRetina<span class="op">$</span>mean, fitRetina<span class="op">$</span>var, </span>
<span id="cb130-3"><a href="#cb130-3"></a>     <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;darkseagreen3&quot;</span>)[(<span class="kw">names</span>(fitRetina<span class="op">$</span>mean) <span class="op">%in%</span><span class="st"> </span>hvg)<span class="op">+</span><span class="dv">1</span>],</span>
<span id="cb130-4"><a href="#cb130-4"></a>     <span class="dt">xlab=</span><span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb130-5"><a href="#cb130-5"></a>    <span class="dt">ylab=</span><span class="st">&quot;Variance of log-expression&quot;</span>)</span>
<span id="cb130-6"><a href="#cb130-6"></a><span class="kw">curve</span>(fitRetina<span class="op">$</span><span class="kw">trend</span>(x), <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb130-7"><a href="#cb130-7"></a><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, </span>
<span id="cb130-8"><a href="#cb130-8"></a>       <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Selected&quot;</span>, <span class="st">&quot;Not selected&quot;</span>), </span>
<span id="cb130-9"><a href="#cb130-9"></a>       <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;darkseagreen3&quot;</span>, <span class="st">&quot;orange&quot;</span>),</span>
<span id="cb130-10"><a href="#cb130-10"></a>       <span class="dt">pch =</span> <span class="dv">16</span>,</span>
<span id="cb130-11"><a href="#cb130-11"></a>       <span class="dt">bty=</span><span class="st">&#39;n&#39;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<p>As a comparison, we could color the genes on this figure according to the selection that was made purely by looking at the raw variance of each gene.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1"></a><span class="kw">plot</span>(fitRetina<span class="op">$</span>mean, fitRetina<span class="op">$</span>var, </span>
<span id="cb131-2"><a href="#cb131-2"></a>     <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;steelblue&quot;</span>)[(<span class="kw">names</span>(fitRetina<span class="op">$</span>mean) <span class="op">%in%</span><span class="st"> </span>highVarGenes)<span class="op">+</span><span class="dv">1</span>],</span>
<span id="cb131-3"><a href="#cb131-3"></a>     <span class="dt">xlab=</span><span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb131-4"><a href="#cb131-4"></a>    <span class="dt">ylab=</span><span class="st">&quot;Variance of log-expression&quot;</span>)</span>
<span id="cb131-5"><a href="#cb131-5"></a><span class="kw">curve</span>(fitRetina<span class="op">$</span><span class="kw">trend</span>(x), <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb131-6"><a href="#cb131-6"></a><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, </span>
<span id="cb131-7"><a href="#cb131-7"></a>       <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Selected&quot;</span>, <span class="st">&quot;Not selected&quot;</span>), </span>
<span id="cb131-8"><a href="#cb131-8"></a>       <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;steelblue&quot;</span>, <span class="st">&quot;orange&quot;</span>),</span>
<span id="cb131-9"><a href="#cb131-9"></a>       <span class="dt">pch =</span> <span class="dv">16</span>,</span>
<span id="cb131-10"><a href="#cb131-10"></a>       <span class="dt">bty=</span><span class="st">&#39;n&#39;</span>)</span></code></pre></div>
<p>As expected, we here simply select genes with a high variance, without recognizing that a high variance is typically driven by a high mean.</p>
</div>
<div id="high-deviance-genes" class="section level2">
<h2><span class="header-section-number">11.3</span> High deviance genes</h2>
<p>Here, we will select genes with a high residual deviance. The idea is that we assume a null model of constant expression fraction (i.e., RNA concentration) across all cells. We subsequently calculate a goodness-of-fit statistic for each gene, assessing whether the model is a good approximation to the gene expression of the corresponding gene.</p>
<p>If the model fits poorly, i.e., the gene has a high deviance, the expression fraction varies significantly across the cells in our datasets.Genes with a high deviance will thus most poorly fit a null model where the relative abundance is equal for all cells, which therefore are informative.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1"></a><span class="co">#BiocManager::install(&quot;scry&quot;)</span></span>
<span id="cb132-2"><a href="#cb132-2"></a><span class="kw">library</span>(scry)</span>
<span id="cb132-3"><a href="#cb132-3"></a>sce &lt;-<span class="st"> </span><span class="kw">devianceFeatureSelection</span>(<span class="dt">object =</span> sce, </span>
<span id="cb132-4"><a href="#cb132-4"></a>                                <span class="dt">assay =</span> <span class="st">&quot;counts&quot;</span>, </span>
<span id="cb132-5"><a href="#cb132-5"></a>                                <span class="dt">sorted =</span> <span class="ot">FALSE</span>)</span>
<span id="cb132-6"><a href="#cb132-6"></a></span>
<span id="cb132-7"><a href="#cb132-7"></a><span class="kw">plot</span>(<span class="kw">sort</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>binomial_deviance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>), </span>
<span id="cb132-8"><a href="#cb132-8"></a>     <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, </span>
<span id="cb132-9"><a href="#cb132-9"></a>     <span class="dt">xlab=</span><span class="st">&quot;ranked genes&quot;</span>, </span>
<span id="cb132-10"><a href="#cb132-10"></a>     <span class="dt">ylab=</span><span class="st">&quot;binomial deviance&quot;</span>, </span>
<span id="cb132-11"><a href="#cb132-11"></a>     <span class="dt">main=</span><span class="st">&quot;Feature Selection with Deviance&quot;</span>)</span>
<span id="cb132-12"><a href="#cb132-12"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="dv">2000</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>Our plot looks similar to one displayed in the <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/scry/inst/doc/scry.html">vignette of the scry package</a>. Based on that plot, the authors suggest retaining 2.000 genes (the top 2000 based on the deviance residuals) for downstream dimensionality reduction and clustering.</p>
</div>
<div id="seurat-vst" class="section level2">
<h2><span class="header-section-number">11.4</span> Seurat VST</h2>
<p>Another very common feature selection strategy is the variance-stabilizing transformation from the <code>Seurat</code> R package, which amounts to calculating Pearson residuals from a regularized negative binomial regression model, with sequencing depth as a covariate.</p>
<p><strong>Intermezzo: interoperability between SingleCellExperiment and Seurat objects</strong></p>
<p>In this lecture series, we always make use of the SingleCellExperiment object and the packages available from Bioconductor. Another very popular toolbox for performing scRNA-seq data analysis is <code>Seurat</code>. However, functions from <code>Seurat</code> cannot be used directly to manipulate <code>SingleCellExperiment</code> objects, and vice versa. Fortunately, efforts have been made to increase the interoperability between the two toolboxes.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a><span class="kw">library</span>(Seurat)</span></code></pre></div>
<pre><code>## Attaching SeuratObject</code></pre>
<pre><code>## 
## Attaching package: &#39;Seurat&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:SummarizedExperiment&#39;:
## 
##     Assays</code></pre>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a>seurat_obj &lt;-<span class="st"> </span><span class="kw">as.Seurat</span>(sce)</span></code></pre></div>
<pre><code>## Warning: Feature names cannot have underscores (&#39;_&#39;), replacing with dashes
## (&#39;-&#39;)

## Warning: Feature names cannot have underscores (&#39;_&#39;), replacing with dashes
## (&#39;-&#39;)</code></pre>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a>seurat_obj <span class="co"># notice the &quot;0 variable features&quot;</span></span></code></pre></div>
<pre><code>## An object of class Seurat 
## 17887 features across 41036 samples within 1 assay 
## Active assay: originalexp (17887 features, 0 variable features)</code></pre>
<p>On this object, we may use functions from the <code>Seurat</code> toolbox. For instance, we may search for highly variable features using <code>Seurat</code>’s VST implementation:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a>seurat_obj &lt;-<span class="st"> </span>Seurat<span class="op">::</span><span class="kw">NormalizeData</span>(seurat_obj, </span>
<span id="cb141-2"><a href="#cb141-2"></a>                                    <span class="dt">normalization.method =</span> <span class="st">&quot;LogNormalize&quot;</span>, </span>
<span id="cb141-3"><a href="#cb141-3"></a>                                    <span class="dt">scale.factor =</span> <span class="dv">10000</span>)</span>
<span id="cb141-4"><a href="#cb141-4"></a></span>
<span id="cb141-5"><a href="#cb141-5"></a>seurat_obj &lt;-<span class="st">  </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> seurat_obj,</span>
<span id="cb141-6"><a href="#cb141-6"></a>                                    <span class="dt">selection.method =</span> <span class="st">&quot;vst&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a>seurat_obj  <span class="co"># notice the &quot;2000 variable features&quot; (default)</span></span></code></pre></div>
<pre><code>## An object of class Seurat 
## 17887 features across 41036 samples within 1 assay 
## Active assay: originalexp (17887 features, 2000 variable features)</code></pre>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a><span class="kw">head</span>(<span class="kw">VariableFeatures</span>(seurat_obj)) <span class="co"># here they are</span></span></code></pre></div>
<pre><code>## [1] &quot;CARTPT&quot; &quot;HBB-BS&quot; &quot;RGS5&quot;   &quot;HBA-A1&quot; &quot;HBA-A2&quot; &quot;NEFL&quot;</code></pre>
</div>
</div>
<div id="dimensionality-reduction" class="section level1">
<h1><span class="header-section-number">12</span> Dimensionality reduction</h1>
<p>Note that, below, we color the cells using the known, true cell type label as defined in the metadata, to empirically evaluate the dimensionality reduction. In reality, we don’t know this yet at this stage.</p>
<div id="the-most-basic-dr" class="section level2">
<h2><span class="header-section-number">12.1</span> The most basic DR</h2>
<p>Just by looking at the top two genes based on our feature selection criterion, we can already see some separation according to the cell type!</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">as.factor</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster)</span>
<span id="cb146-2"><a href="#cb146-2"></a>cl &lt;-<span class="st"> </span><span class="kw">colData</span>(sce)<span class="op">$</span>cluster</span>
<span id="cb146-3"><a href="#cb146-3"></a><span class="kw">par</span>(<span class="dt">bty=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb146-4"><a href="#cb146-4"></a><span class="kw">plot</span>(<span class="dt">x =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts[hvg[<span class="dv">1</span>],],</span>
<span id="cb146-5"><a href="#cb146-5"></a>     <span class="dt">y =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts[hvg[<span class="dv">2</span>],],</span>
<span id="cb146-6"><a href="#cb146-6"></a>     <span class="dt">col =</span> <span class="kw">as.numeric</span>(cl),</span>
<span id="cb146-7"><a href="#cb146-7"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb146-8"><a href="#cb146-8"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Most informative gene&quot;</span>,</span>
<span id="cb146-9"><a href="#cb146-9"></a>     <span class="dt">ylab =</span> <span class="st">&quot;Second most informative gene&quot;</span>,</span>
<span id="cb146-10"><a href="#cb146-10"></a>     <span class="dt">main =</span> <span class="st">&quot;Cells colored acc to cell type&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<p>We are able to recover quite some structure. However, many cell populations remain obscure, and the plot is overcrowded.</p>
</div>
<div id="linear-dimensionality-reduction-pca" class="section level2">
<h2><span class="header-section-number">12.2</span> Linear dimensionality reduction: PCA</h2>
<p>A DR method is linear when the reduced dimensions are a linear function of the original variables. For example, in PCA, each principal component is a linear combination of genes, therefore the DR is a linear function of the original variables.</p>
<p>Typically, PCA is performed on log-transformed normalized counts. The log-transformation helps somewhat, but not completely, to account for the mean-variance relationship. PCA works well for bulk RNA-seq data. However, the structure of scRNA-seq data is often too complex to be visualized by a small number of PCs.</p>
<p>There are several R functions that allow you to perform PCA. Here, we make use of the <code>runPCA</code> function of the <code>scater</code> package, which has been specifically developed for performing PCA on <code>SingleCellExperiment</code> objects. We calculate the top 30 principal components.</p>
<div id="pca-with-feature-selection" class="section level3">
<h3><span class="header-section-number">12.2.1</span> PCA with feature selection</h3>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb147-2"><a href="#cb147-2"></a>sce &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce, </span>
<span id="cb147-3"><a href="#cb147-3"></a>              <span class="dt">ncomponents=</span><span class="dv">30</span>, </span>
<span id="cb147-4"><a href="#cb147-4"></a>              <span class="dt">subset_row=</span>hvg)</span></code></pre></div>
<p>PCA has been performed. The PCA information has been automatically stored in the <em>reducedDim</em> slot of the SingleCellExperiment object.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1"></a><span class="kw">reducedDimNames</span>(sce)</span></code></pre></div>
<pre><code>## [1] &quot;PCA&quot;</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a><span class="kw">head</span>(<span class="kw">reducedDim</span>(sce,</span>
<span id="cb150-2"><a href="#cb150-2"></a>           <span class="dt">type=</span><span class="st">&quot;PCA&quot;</span>))</span></code></pre></div>
<pre><code>##                       PC1         PC2         PC3       PC4       PC5
## r1_GGCCGCAGTCCG  9.782147 -0.06989828  0.53682936 -4.285499 0.4437403
## r1_CTTGTGCGGGAA  9.710234  0.26092747  0.47567655 -4.978495 0.7599940
## r1_GCGCAACTGCTC  9.859269  0.16764772  0.68577161 -4.358120 0.4952484
## r1_GATTGGGAGGCA  9.585260 -0.02842153 -0.07751398 -4.825305 0.9111534
## r1_CCTCCTAGTTGG  9.901159 -0.10277759  0.25045816 -4.191151 0.5552125
## r1_AGTCAAGCCCTC -4.658214 -0.21318880 -0.97465866  1.203952 3.1182027
##                        PC6       PC7        PC8        PC9      PC10       PC11
## r1_GGCCGCAGTCCG -0.8783709 0.8110351 -1.6039082  0.9163174 -1.469966 -0.3202611
## r1_CTTGTGCGGGAA -0.9647669 1.6056783 -0.8339512  1.2459207 -1.072585 -0.3908371
## r1_GCGCAACTGCTC -0.8623239 0.7409644 -1.8074712  1.2098030 -1.655158 -0.4278883
## r1_GATTGGGAGGCA -1.0407473 1.5968654 -0.8256230  1.3308616 -1.376928 -0.4321302
## r1_CCTCCTAGTTGG -0.8564299 0.8691439 -1.4532843  0.9992053 -1.675298 -0.4580044
## r1_AGTCAAGCCCTC -1.2935647 1.8744985  0.1631854 -0.7715584 -0.727341 -1.0121014
##                       PC12       PC13        PC14        PC15         PC16
## r1_GGCCGCAGTCCG -0.4850761 -1.1028970 -0.28971405  0.95317249  0.075099779
## r1_CTTGTGCGGGAA -0.6161034 -0.9086733 -0.03621874  0.98432865 -0.033842442
## r1_GCGCAACTGCTC -0.5135708 -0.9734205 -0.21992930  1.03457308  0.197066086
## r1_GATTGGGAGGCA -0.3053884 -1.0257235 -0.08283002  1.02434633  0.007373196
## r1_CCTCCTAGTTGG -0.3431460 -1.1719912 -0.45890504  1.29849300  0.310448501
## r1_AGTCAAGCCCTC -1.0511057  0.2203544 -0.26394145 -0.07750261  0.754847869
##                         PC17       PC18       PC19        PC20        PC21
## r1_GGCCGCAGTCCG -0.382484342 -0.4834363 -0.4365855 -0.22335165  0.04439278
## r1_CTTGTGCGGGAA -0.698945386 -0.8001994 -0.5467860 -0.42223415  0.12788414
## r1_GCGCAACTGCTC -0.487704332 -0.7538982 -0.5558649 -0.41815539 -0.40311719
## r1_GATTGGGAGGCA -0.626201355 -0.6633866 -0.5408733 -0.42363487  0.09189851
## r1_CCTCCTAGTTGG -0.479545499 -0.5328632 -0.5135454 -0.25976225 -0.36081535
## r1_AGTCAAGCCCTC -0.007645504  0.4240357  0.2051139 -0.09304772 -0.76393126
##                       PC22         PC23       PC24        PC25        PC26
## r1_GGCCGCAGTCCG -0.5197639 -0.002494402 0.33304751 -0.09400709  0.19228997
## r1_CTTGTGCGGGAA -0.6714840 -0.027254103 0.07687241 -0.13838360  0.06172177
## r1_GCGCAACTGCTC -0.4107161 -0.307483552 0.05562828  0.03397895  0.01276577
## r1_GATTGGGAGGCA -0.7100066 -0.012887286 0.24543705  0.01885473 -0.12068804
## r1_CCTCCTAGTTGG -0.4140079 -0.023587021 0.51321834  0.18489709 -0.07123888
## r1_AGTCAAGCCCTC  0.7589591  0.463769220 0.83133662  0.11331966  0.26734532
##                        PC27       PC28        PC29         PC30
## r1_GGCCGCAGTCCG -0.26126854 -0.3662743 -0.02872727  0.291097948
## r1_CTTGTGCGGGAA -0.10611096 -0.1333745 -0.10016477 -0.056596597
## r1_GCGCAACTGCTC -0.33706597 -0.1669009 -0.10364368  0.326936667
## r1_GATTGGGAGGCA -0.07934285 -0.1265276  0.35267002  0.032295298
## r1_CCTCCTAGTTGG -0.07717379 -0.3050977  0.14086675  0.174801535
## r1_AGTCAAGCCCTC  0.27379303  0.7638374  0.36586430  0.009525786</code></pre>
<p>The <code>plotPCA</code> function of the <code>scater</code> package now allows us to visualize the cells in PCA space, based on the PCA information stored in our object:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a><span class="kw">plotPCA</span>(sce, </span>
<span id="cb152-2"><a href="#cb152-2"></a>        <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
<p>While the large number of clusters in this dataset makes it hard to distinguish between all the different colors, we can already see that PCA retrieves some, but not all, of the structure in the data that was discovered by the original authors.</p>
<p>How many of the top PCs should we retain for downstream analyses? The choice of the number of PCs is a decision that is analogous to the choice of the number of HVGs to use. Using more PCs will retain more biological signal at the cost of including more noise that might mask said signal. On the other hand, using fewer PCs will introduce competition between different factors of variation, where weaker (but still interesting) factors may be pushed down into lower PCs and inadvertently discarded from downstream analyses.</p>
<p>Most analysts will simply aim to use a “reasonable” but arbitrary value, typically ranging from 10 to 50. This is often satisfactory as the later PCs explain so little variance that their inclusion or omission has no major effect.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1"></a>percent.var &lt;-<span class="st"> </span><span class="kw">attr</span>(<span class="kw">reducedDim</span>(sce), <span class="st">&quot;percentVar&quot;</span>)</span>
<span id="cb154-2"><a href="#cb154-2"></a><span class="kw">plot</span>(percent.var, <span class="dt">log=</span><span class="st">&quot;y&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;PC&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Variance explained (%)&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a><span class="kw">plot</span>(<span class="kw">cumsum</span>(percent.var), <span class="dt">xlab=</span><span class="st">&quot;PC&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Cumulative variance explained (%)&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-42-2.png" width="672" /></p>
<p>Here, retaining ±15PCs seems reasonable. If you really prefer a more data-driven way for determining this, there are procedures available that aim to computationally identify the elbow/knee point in the variance explained per PC plot.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a><span class="kw">library</span>(PCAtools)</span></code></pre></div>
<pre><code>## Loading required package: ggrepel</code></pre>
<pre><code>## 
## Attaching package: &#39;PCAtools&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:scran&#39;:
## 
##     parallelPCA</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     biplot, screeplot</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1"></a>chosen.elbow &lt;-<span class="st"> </span><span class="kw">findElbowPoint</span>(percent.var)</span>
<span id="cb161-2"><a href="#cb161-2"></a>chosen.elbow</span></code></pre></div>
<pre><code>## [1] 5</code></pre>
</div>
<div id="pca-without-feature-selection" class="section level3">
<h3><span class="header-section-number">12.2.2</span> PCA without feature selection</h3>
<p>Note: more features -&gt; computationally more intensive!</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb163-2"><a href="#cb163-2"></a>sceNoFS &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce, </span>
<span id="cb163-3"><a href="#cb163-3"></a>                  <span class="dt">ncomponents=</span><span class="dv">30</span>, </span>
<span id="cb163-4"><a href="#cb163-4"></a>                  <span class="dt">subset_row=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sce))</span>
<span id="cb163-5"><a href="#cb163-5"></a><span class="kw">plotPCA</span>(sceNoFS, <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1"></a><span class="kw">rm</span>(sceNoFS)</span></code></pre></div>
<p>While we use more information to make this PCA plot (17.887 genes) as compared to the feature selected PCA plot (642 genes), we seem to retrieve less structure in the data. This is the power of feature selection, an increase in the signal-to-noise ratio!</p>
</div>
<div id="effect-of-feature-selection-on-pca" class="section level3">
<h3><span class="header-section-number">12.2.3</span> Effect of feature selection on PCA</h3>
<p>First, we compare the different feature selection criteria, using the top 1000 highly variable genes for each method.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a><span class="co"># Get top 1000 highly variable features using the highly variable genes</span></span>
<span id="cb166-2"><a href="#cb166-2"></a><span class="co"># (w.r.t. mean), high deviance genes and the VST strategy of Seurat</span></span>
<span id="cb166-3"><a href="#cb166-3"></a></span>
<span id="cb166-4"><a href="#cb166-4"></a>hvg1000 &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec, <span class="dt">n =</span> <span class="dv">1000</span>)</span>
<span id="cb166-5"><a href="#cb166-5"></a>hdg1000 &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">sort</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>binomial_deviance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>]</span>
<span id="cb166-6"><a href="#cb166-6"></a>vst1000 &lt;-<span class="st"> </span><span class="kw">VariableFeatures</span>(seurat_obj)[<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>]</span>
<span id="cb166-7"><a href="#cb166-7"></a></span>
<span id="cb166-8"><a href="#cb166-8"></a><span class="co"># HVG strategy</span></span>
<span id="cb166-9"><a href="#cb166-9"></a><span class="kw">plotPCA</span>(</span>
<span id="cb166-10"><a href="#cb166-10"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb166-11"><a href="#cb166-11"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb166-12"><a href="#cb166-12"></a>           <span class="dt">subset_row =</span> hvg1000), </span>
<span id="cb166-13"><a href="#cb166-13"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb166-14"><a href="#cb166-14"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Highly variable genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a><span class="co"># HDG strategy</span></span>
<span id="cb168-2"><a href="#cb168-2"></a><span class="kw">plotPCA</span>(</span>
<span id="cb168-3"><a href="#cb168-3"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb168-4"><a href="#cb168-4"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb168-5"><a href="#cb168-5"></a>           <span class="dt">subset_row =</span> hdg1000), </span>
<span id="cb168-6"><a href="#cb168-6"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb168-7"><a href="#cb168-7"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;High-deviance genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-45-2.png" width="672" /></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1"></a><span class="co"># VST strategy</span></span>
<span id="cb170-2"><a href="#cb170-2"></a><span class="kw">plotPCA</span>(</span>
<span id="cb170-3"><a href="#cb170-3"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb170-4"><a href="#cb170-4"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>,</span>
<span id="cb170-5"><a href="#cb170-5"></a>           <span class="dt">subset_row =</span> vst1000),</span>
<span id="cb170-6"><a href="#cb170-6"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb170-7"><a href="#cb170-7"></a>    ) <span class="op">+</span></span>
<span id="cb170-8"><a href="#cb170-8"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seurat VST&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-45-3.png" width="672" /></p>
<p>Next, we assess the sensitivity on the number of top features for the highly variable genes method;</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1"></a>hvg_all &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec)</span>
<span id="cb172-2"><a href="#cb172-2"></a></span>
<span id="cb172-3"><a href="#cb172-3"></a>hvg2000 &lt;-<span class="st"> </span>hvg_all[<span class="dv">1</span><span class="op">:</span><span class="dv">2000</span>]</span>
<span id="cb172-4"><a href="#cb172-4"></a>hvg1000 &lt;-<span class="st"> </span>hvg_all[<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>]</span>
<span id="cb172-5"><a href="#cb172-5"></a>hvg100 &lt;-<span class="st"> </span>hvg_all[<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>]</span>
<span id="cb172-6"><a href="#cb172-6"></a>hvg10 &lt;-<span class="st"> </span>hvg_all[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span>
<span id="cb172-7"><a href="#cb172-7"></a>hvg5 &lt;-<span class="st"> </span>hvg_all[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb172-8"><a href="#cb172-8"></a></span>
<span id="cb172-9"><a href="#cb172-9"></a><span class="kw">plotPCA</span>(</span>
<span id="cb172-10"><a href="#cb172-10"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb172-11"><a href="#cb172-11"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>), </span>
<span id="cb172-12"><a href="#cb172-12"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb172-13"><a href="#cb172-13"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;All genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1"></a><span class="kw">plotPCA</span>(</span>
<span id="cb174-2"><a href="#cb174-2"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb174-3"><a href="#cb174-3"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb174-4"><a href="#cb174-4"></a>           <span class="dt">subset_row =</span> hvg2000), </span>
<span id="cb174-5"><a href="#cb174-5"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb174-6"><a href="#cb174-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 2000 genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-2.png" width="672" /></p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1"></a><span class="kw">plotPCA</span>(</span>
<span id="cb176-2"><a href="#cb176-2"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb176-3"><a href="#cb176-3"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb176-4"><a href="#cb176-4"></a>           <span class="dt">subset_row =</span> hvg1000), </span>
<span id="cb176-5"><a href="#cb176-5"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb176-6"><a href="#cb176-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 1000 genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-3.png" width="672" /></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1"></a><span class="kw">plotPCA</span>(</span>
<span id="cb178-2"><a href="#cb178-2"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb178-3"><a href="#cb178-3"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb178-4"><a href="#cb178-4"></a>           <span class="dt">subset_row =</span> hvg100), </span>
<span id="cb178-5"><a href="#cb178-5"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb178-6"><a href="#cb178-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 100 genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-4.png" width="672" /></p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1"></a><span class="kw">plotPCA</span>(</span>
<span id="cb180-2"><a href="#cb180-2"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb180-3"><a href="#cb180-3"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb180-4"><a href="#cb180-4"></a>           <span class="dt">subset_row =</span> hvg10), </span>
<span id="cb180-5"><a href="#cb180-5"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb180-6"><a href="#cb180-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 10 genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-5.png" width="672" /></p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1"></a><span class="kw">plotPCA</span>(</span>
<span id="cb182-2"><a href="#cb182-2"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb182-3"><a href="#cb182-3"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb182-4"><a href="#cb182-4"></a>           <span class="dt">subset_row =</span> hvg5), </span>
<span id="cb182-5"><a href="#cb182-5"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb182-6"><a href="#cb182-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 5 genes&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-46-6.png" width="672" /></p>
</div>
<div id="remarks-on-pca" class="section level3">
<h3><span class="header-section-number">12.2.4</span> Remarks on PCA</h3>
<p>Visualizations of reduced dimensions from linear dimensionality reduction methods are often “overcrowded”, and it is hard to see structure (e.g., the PCA plot we just saw). Non-linear dimensionality reduction methods can overcome this problem. As the name suggests, the reduced dimensions are a non-linear function of the observed data. We will not go into detail as to how these work under the hood, but provide a few guidelines for the most popular methods. Often, the top (~10-50) PCs are provided as input.</p>
</div>
</div>
<div id="a-generalization-of-pca-for-exponential-family-distributions." class="section level2">
<h2><span class="header-section-number">12.3</span> A generalization of PCA for exponential family distributions.</h2>
<p>PCA is implicitly based on Euclidean distances, corresponding to maximizing a Gaussian likelihood, which is inappropriate for count data such as scRNA-seq. <a href="https://doi.org/10.1186/s13059-019-1861-6">Townes et al.</a> (2019) develop GLM-PCA, a generalization of PCA for exponential family likelihoods. They posit, using negative control data, that the data generative mechanism of UMI count data can be considered to be multinomial.</p>
<p>The GLM-PCA strategy is implemented in the <code>glmpca</code> function of the <code>glmpca</code> package.</p>
<p>Note that this function is quite computationally intensive. For regular PCA on log-transformed normalized counts, the underlying computations can be strongly simplified. Here, we work with the raw counts, which we assume to be <em>Poisson</em> distributed, requiring an iterative optimization scheme.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1"></a><span class="co"># runs 2min on my laptop</span></span>
<span id="cb184-2"><a href="#cb184-2"></a><span class="kw">library</span>(glmpca)</span>
<span id="cb184-3"><a href="#cb184-3"></a><span class="kw">set.seed</span>(<span class="dv">211103</span>)</span>
<span id="cb184-4"><a href="#cb184-4"></a>poipca &lt;-<span class="st"> </span><span class="kw">glmpca</span>(<span class="dt">Y =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts[hvg,],</span>
<span id="cb184-5"><a href="#cb184-5"></a>                 <span class="dt">L =</span> <span class="dv">2</span>, </span>
<span id="cb184-6"><a href="#cb184-6"></a>                 <span class="dt">fam =</span> <span class="st">&quot;poi&quot;</span>,</span>
<span id="cb184-7"><a href="#cb184-7"></a>                 <span class="dt">minibatch =</span> <span class="st">&quot;stochastic&quot;</span>)</span>
<span id="cb184-8"><a href="#cb184-8"></a><span class="kw">reducedDim</span>(sce, <span class="st">&quot;PoiPCA&quot;</span>) &lt;-<span class="st"> </span>poipca<span class="op">$</span>factors</span>
<span id="cb184-9"><a href="#cb184-9"></a><span class="kw">plotReducedDim</span>(sce, </span>
<span id="cb184-10"><a href="#cb184-10"></a>               <span class="dt">dimred=</span><span class="st">&quot;PoiPCA&quot;</span>,</span>
<span id="cb184-11"><a href="#cb184-11"></a>               <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>Alternatively, we could adopt the GLM-PCA strategy using only the genes with high deviance.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1"></a><span class="co"># Based on the diagnostic plot from the feature selection, we would select the </span></span>
<span id="cb186-2"><a href="#cb186-2"></a><span class="co"># top 2000 genes with highest deviance. However, to reduce the running time of</span></span>
<span id="cb186-3"><a href="#cb186-3"></a><span class="co"># the function, I here select the top 500 (which still is quite slow - 5min).</span></span>
<span id="cb186-4"><a href="#cb186-4"></a><span class="kw">Sys.time</span>()</span></code></pre></div>
<pre><code>## [1] &quot;2021-12-14 18:23:15 UTC&quot;</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1"></a>hdg &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">sort</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>binomial_deviance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">500</span>]</span>
<span id="cb188-2"><a href="#cb188-2"></a></span>
<span id="cb188-3"><a href="#cb188-3"></a><span class="kw">set.seed</span>(<span class="dv">471681</span>)</span>
<span id="cb188-4"><a href="#cb188-4"></a>poipca_dev &lt;-<span class="st"> </span><span class="kw">glmpca</span>(<span class="dt">Y =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts[hdg,],</span>
<span id="cb188-5"><a href="#cb188-5"></a>                 <span class="dt">L =</span> <span class="dv">2</span>, </span>
<span id="cb188-6"><a href="#cb188-6"></a>                 <span class="dt">fam =</span> <span class="st">&quot;poi&quot;</span>,</span>
<span id="cb188-7"><a href="#cb188-7"></a>                 <span class="dt">minibatch =</span> <span class="st">&quot;stochastic&quot;</span>)</span>
<span id="cb188-8"><a href="#cb188-8"></a><span class="kw">Sys.time</span>()</span></code></pre></div>
<pre><code>## [1] &quot;2021-12-14 18:26:44 UTC&quot;</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1"></a><span class="kw">reducedDim</span>(sce, <span class="st">&quot;PoiPCA_dev&quot;</span>) &lt;-<span class="st"> </span>poipca_dev<span class="op">$</span>factors</span>
<span id="cb190-2"><a href="#cb190-2"></a><span class="kw">plotReducedDim</span>(sce, </span>
<span id="cb190-3"><a href="#cb190-3"></a>               <span class="dt">dimred=</span><span class="st">&quot;PoiPCA_dev&quot;</span>,</span>
<span id="cb190-4"><a href="#cb190-4"></a>               <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<p>The authors of the <code>glmpca</code> package note that GLM-PCA can be slow for large datasets. Therefore, they have implemented a fast approximation of the algorithm, which first fits a null model of constant expression for each gene across all cells, and subsequently fits standard PCA to either the Pearson or deviance residuals from the null model.</p>
<p>However, at least for me the <code>nullResiduals</code> function was <strong>extremely slow</strong> even slower than the <code>glmpca</code> code above. Therefore, <strong>I suggest not running</strong> this code, but I leave it in for reference.</p>
<pre><code>sce &lt;- nullResiduals(sce, assay=&quot;counts&quot;, type=&quot;deviance&quot;)
sce &lt;- nullResiduals(sce, assay=&quot;counts&quot;, type=&quot;pearson&quot;)

pca&lt;-function(Y, L=2, center=TRUE, scale=TRUE){
    #assumes features=rows, observations=cols
    res&lt;-prcomp(as.matrix(t(Y)), center=center, scale.=scale, rank.=L)
    factors&lt;-as.data.frame(res$x)
    colnames(factors)&lt;-paste0(&quot;dim&quot;, 1:L)
    factors
}
pca_d &lt;- pca(assay(sce[hdg,], &quot;binomial_deviance_residuals&quot;))
pca_d$resid_type &lt;- &quot;deviance_residuals&quot;
pca_p &lt;- pca(assay(sce[hdg,], &quot;binomial_pearson_residuals&quot;))
pca_p$resid_type &lt;- &quot;pearson_residuals&quot;
cm &lt;- as.data.frame(colData(sce[hdg,]))
pd &lt;- rbind(cbind(cm, pca_d), cbind(cm, pca_p))
ggplot(pd, aes(x=dim1, y=dim2, colour=phenoid)) + geom_point() +
  facet_wrap(~resid_type, scales=&quot;free&quot;, nrow=2) +
  ggtitle(&quot;PCA applied to null residuals of high deviance genes&quot;)</code></pre>
</div>
<div id="non-linear-dimensionality-reduction-t-sne" class="section level2">
<h2><span class="header-section-number">12.4</span> Non-linear dimensionality reduction: t-SNE</h2>
<p>t-SNE focuses on preserving local rather than global distances. Therefore, distances on a t-SNE reduced dimension plot can only be interpreted locally, i.e., cells that are close together in reduced dimension will have a similar transcriptome, but cells that are far away may not necessarily have a very distinct transcriptome.</p>
<p>Running t-SNE on a <code>SingleCellExperiment</code> object can be achieved with the <code>runTSNE</code> function of the <code>scater</code> package. By default, this function will first perform PCA, and use the top 50 PCs as an input to the actual t-SNE algorithm. Since we already performed PCA, we may set <code>dimred = "PCA"</code> as argument to the function. As such we will be performing a T-SNE on the 30 PCs we computed before. If we would like to run t-SNE only using the top 10 PCs, we could set <code>n_dimred = 10</code>.</p>
<p>In addition, we may wish to set <code>external_neighbors=TRUE</code>, which increases the speed of the algorithm for large datasets by applying a heuristic.</p>
<p><strong>Note:</strong> for me this was the slowest function of the analysis (so far). If you feel like your PC/laptop had a lot of trouble with the previous step(s), you may consider not running this code, or running it on a subset of the data (e.g., randomly subsampling cells) for demonstrational purposes. Alternatively, you may consider reducing the input space for the t-SNE algorithm, e.g. by setting <code>n_dimred = 5</code>.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1"></a><span class="co"># (For me it takes 3min30 with n_dimred = 5)</span></span>
<span id="cb193-2"><a href="#cb193-2"></a>sce &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce, </span>
<span id="cb193-3"><a href="#cb193-3"></a>               <span class="dt">dimred =</span> <span class="st">&#39;PCA&#39;</span>,</span>
<span id="cb193-4"><a href="#cb193-4"></a>               <span class="dt">n_dimred =</span> <span class="dv">5</span>,</span>
<span id="cb193-5"><a href="#cb193-5"></a>               <span class="dt">external_neighbors=</span><span class="ot">TRUE</span>)</span>
<span id="cb193-6"><a href="#cb193-6"></a><span class="kw">plotTSNE</span>(sce,</span>
<span id="cb193-7"><a href="#cb193-7"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
</div>
<div id="non-linear-dimensionality-reduction-umap" class="section level2">
<h2><span class="header-section-number">12.5</span> Non-linear dimensionality reduction: UMAP</h2>
<p>It is often suggested that UMAP is better than t-SNE in preserving global differences. Therefore, UMAP is also often used in analyses such as trajectory inference, where this is important.</p>
<p>Running UMAP on a <code>SingleCellExperiment</code> object can be achieved with the <code>runUMAP</code> function of the <code>scater</code> package.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1"></a><span class="co"># Using top 10% highly variable genes and top 30 PCs</span></span>
<span id="cb195-2"><a href="#cb195-2"></a>sce &lt;-<span class="st"> </span><span class="kw">runUMAP</span>(sce, </span>
<span id="cb195-3"><a href="#cb195-3"></a>               <span class="dt">dimred =</span> <span class="st">&#39;PCA&#39;</span>, </span>
<span id="cb195-4"><a href="#cb195-4"></a>               <span class="dt">external_neighbors =</span> <span class="ot">TRUE</span>)</span>
<span id="cb195-5"><a href="#cb195-5"></a><span class="kw">plotUMAP</span>(sce,</span>
<span id="cb195-6"><a href="#cb195-6"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1"></a><span class="co"># Using top 10% highly variable genes and top 10 PCs</span></span>
<span id="cb197-2"><a href="#cb197-2"></a><span class="kw">plotUMAP</span>(<span class="kw">runUMAP</span>(sce, </span>
<span id="cb197-3"><a href="#cb197-3"></a>               <span class="dt">dimred =</span> <span class="st">&#39;PCA&#39;</span>, </span>
<span id="cb197-4"><a href="#cb197-4"></a>               <span class="dt">external_neighbors =</span> <span class="ot">TRUE</span>,</span>
<span id="cb197-5"><a href="#cb197-5"></a>               <span class="dt">n_dimred =</span> <span class="dv">10</span>),</span>
<span id="cb197-6"><a href="#cb197-6"></a>  <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 3415 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-50-2.png" width="672" /></p>
<hr />
<p>— end lab session 2 —</p>
<hr />
</div>
</div>
<div id="read-results-from-first-two-sessions" class="section level1">
<h1><span class="header-section-number">13</span> Read results from first two sessions</h1>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./sce_after_labsession2.rds&quot;</span>) <span class="co"># change to YOUR path!</span></span></code></pre></div>
</div>
<div id="add-cluster-information-from-publication" class="section level1">
<h1><span class="header-section-number">14</span> Add cluster information from publication</h1>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb200-2"><a href="#cb200-2"></a>sce<span class="op">$</span>cluster_lowRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, </span>
<span id="cb200-3"><a href="#cb200-3"></a>           <span class="st">&quot;Horizontal_cells&quot;</span> =<span class="st"> &quot;1&quot;</span>,</span>
<span id="cb200-4"><a href="#cb200-4"></a>           <span class="st">&quot;Ganglion_cells&quot;</span> =<span class="st"> &quot;2&quot;</span>,</span>
<span id="cb200-5"><a href="#cb200-5"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;3&quot;</span>,</span>
<span id="cb200-6"><a href="#cb200-6"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;4&quot;</span>,</span>
<span id="cb200-7"><a href="#cb200-7"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;5&quot;</span>,</span>
<span id="cb200-8"><a href="#cb200-8"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;6&quot;</span>,</span>
<span id="cb200-9"><a href="#cb200-9"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;7&quot;</span>,</span>
<span id="cb200-10"><a href="#cb200-10"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;8&quot;</span>,</span>
<span id="cb200-11"><a href="#cb200-11"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;9&quot;</span>,</span>
<span id="cb200-12"><a href="#cb200-12"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;10&quot;</span>,</span>
<span id="cb200-13"><a href="#cb200-13"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;11&quot;</span>,</span>
<span id="cb200-14"><a href="#cb200-14"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;12&quot;</span>,</span>
<span id="cb200-15"><a href="#cb200-15"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;13&quot;</span>,</span>
<span id="cb200-16"><a href="#cb200-16"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;14&quot;</span>,</span>
<span id="cb200-17"><a href="#cb200-17"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;15&quot;</span>,</span>
<span id="cb200-18"><a href="#cb200-18"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;16&quot;</span>,</span>
<span id="cb200-19"><a href="#cb200-19"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;17&quot;</span>,</span>
<span id="cb200-20"><a href="#cb200-20"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;18&quot;</span>,</span>
<span id="cb200-21"><a href="#cb200-21"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;19&quot;</span>,</span>
<span id="cb200-22"><a href="#cb200-22"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;20&quot;</span>,</span>
<span id="cb200-23"><a href="#cb200-23"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;21&quot;</span>,</span>
<span id="cb200-24"><a href="#cb200-24"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;22&quot;</span>,</span>
<span id="cb200-25"><a href="#cb200-25"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;23&quot;</span>,</span>
<span id="cb200-26"><a href="#cb200-26"></a>           <span class="st">&quot;Rods&quot;</span> =<span class="st"> &quot;24&quot;</span>,</span>
<span id="cb200-27"><a href="#cb200-27"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;25&quot;</span>,</span>
<span id="cb200-28"><a href="#cb200-28"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;26&quot;</span>,</span>
<span id="cb200-29"><a href="#cb200-29"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;27&quot;</span>,</span>
<span id="cb200-30"><a href="#cb200-30"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;28&quot;</span>,</span>
<span id="cb200-31"><a href="#cb200-31"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;29&quot;</span>,</span>
<span id="cb200-32"><a href="#cb200-32"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;30&quot;</span>,</span>
<span id="cb200-33"><a href="#cb200-33"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;31&quot;</span>,</span>
<span id="cb200-34"><a href="#cb200-34"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;32&quot;</span>,</span>
<span id="cb200-35"><a href="#cb200-35"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;33&quot;</span>,</span>
<span id="cb200-36"><a href="#cb200-36"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;34&quot;</span>,</span>
<span id="cb200-37"><a href="#cb200-37"></a>           <span class="st">&quot;Astrocytes&quot;</span> =<span class="st"> &quot;35&quot;</span>,</span>
<span id="cb200-38"><a href="#cb200-38"></a>           <span class="st">&quot;Fibroblast&quot;</span> =<span class="st"> &quot;36&quot;</span>,</span>
<span id="cb200-39"><a href="#cb200-39"></a>           <span class="st">&quot;Vascular_endothelium&quot;</span> =<span class="st"> &quot;37&quot;</span>,</span>
<span id="cb200-40"><a href="#cb200-40"></a>           <span class="st">&quot;Pericytes&quot;</span> =<span class="st"> &quot;38&quot;</span>,</span>
<span id="cb200-41"><a href="#cb200-41"></a>           <span class="st">&quot;Microglia&quot;</span> =<span class="st"> &quot;39&quot;</span>)</span>
<span id="cb200-42"><a href="#cb200-42"></a></span>
<span id="cb200-43"><a href="#cb200-43"></a>sce<span class="op">$</span>cluster_highRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, </span>
<span id="cb200-44"><a href="#cb200-44"></a>           <span class="st">&quot;Horizontal_cells&quot;</span> =<span class="st"> &quot;1&quot;</span>,</span>
<span id="cb200-45"><a href="#cb200-45"></a>           <span class="st">&quot;Ganglion_cells&quot;</span> =<span class="st"> &quot;2&quot;</span>,</span>
<span id="cb200-46"><a href="#cb200-46"></a>           <span class="st">&quot;Amacrine_1&quot;</span> =<span class="st"> &quot;3&quot;</span>,</span>
<span id="cb200-47"><a href="#cb200-47"></a>           <span class="st">&quot;Amacrine_2&quot;</span> =<span class="st"> &quot;4&quot;</span>,</span>
<span id="cb200-48"><a href="#cb200-48"></a>           <span class="st">&quot;Amacrine_3&quot;</span> =<span class="st"> &quot;5&quot;</span>,</span>
<span id="cb200-49"><a href="#cb200-49"></a>           <span class="st">&quot;Amacrine_4&quot;</span> =<span class="st"> &quot;6&quot;</span>,</span>
<span id="cb200-50"><a href="#cb200-50"></a>           <span class="st">&quot;Amacrine_5&quot;</span> =<span class="st"> &quot;7&quot;</span>,</span>
<span id="cb200-51"><a href="#cb200-51"></a>           <span class="st">&quot;Amacrine_6&quot;</span> =<span class="st"> &quot;8&quot;</span>,</span>
<span id="cb200-52"><a href="#cb200-52"></a>           <span class="st">&quot;Amacrine_7&quot;</span> =<span class="st"> &quot;9&quot;</span>,</span>
<span id="cb200-53"><a href="#cb200-53"></a>           <span class="st">&quot;Amacrine_8&quot;</span> =<span class="st"> &quot;10&quot;</span>,</span>
<span id="cb200-54"><a href="#cb200-54"></a>           <span class="st">&quot;Amacrine_9&quot;</span> =<span class="st"> &quot;11&quot;</span>,</span>
<span id="cb200-55"><a href="#cb200-55"></a>           <span class="st">&quot;Amacrine_10&quot;</span> =<span class="st"> &quot;12&quot;</span>,</span>
<span id="cb200-56"><a href="#cb200-56"></a>           <span class="st">&quot;Amacrine_11&quot;</span> =<span class="st"> &quot;13&quot;</span>,</span>
<span id="cb200-57"><a href="#cb200-57"></a>           <span class="st">&quot;Amacrine_12&quot;</span> =<span class="st"> &quot;14&quot;</span>,</span>
<span id="cb200-58"><a href="#cb200-58"></a>           <span class="st">&quot;Amacrine_13&quot;</span> =<span class="st"> &quot;15&quot;</span>,</span>
<span id="cb200-59"><a href="#cb200-59"></a>           <span class="st">&quot;Amacrine_14&quot;</span> =<span class="st"> &quot;16&quot;</span>,</span>
<span id="cb200-60"><a href="#cb200-60"></a>           <span class="st">&quot;Amacrine_15&quot;</span> =<span class="st"> &quot;17&quot;</span>,</span>
<span id="cb200-61"><a href="#cb200-61"></a>           <span class="st">&quot;Amacrine_16&quot;</span> =<span class="st"> &quot;18&quot;</span>,</span>
<span id="cb200-62"><a href="#cb200-62"></a>           <span class="st">&quot;Amacrine_17&quot;</span> =<span class="st"> &quot;19&quot;</span>,</span>
<span id="cb200-63"><a href="#cb200-63"></a>           <span class="st">&quot;Amacrine_18&quot;</span> =<span class="st"> &quot;20&quot;</span>,</span>
<span id="cb200-64"><a href="#cb200-64"></a>           <span class="st">&quot;Amacrine_19&quot;</span> =<span class="st"> &quot;21&quot;</span>,</span>
<span id="cb200-65"><a href="#cb200-65"></a>           <span class="st">&quot;Amacrine_20&quot;</span> =<span class="st"> &quot;22&quot;</span>,</span>
<span id="cb200-66"><a href="#cb200-66"></a>           <span class="st">&quot;Amacrine_21&quot;</span> =<span class="st"> &quot;23&quot;</span>,</span>
<span id="cb200-67"><a href="#cb200-67"></a>           <span class="st">&quot;Rods&quot;</span> =<span class="st"> &quot;24&quot;</span>,</span>
<span id="cb200-68"><a href="#cb200-68"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;25&quot;</span>,</span>
<span id="cb200-69"><a href="#cb200-69"></a>           <span class="st">&quot;Bipolar_1&quot;</span> =<span class="st"> &quot;26&quot;</span>,</span>
<span id="cb200-70"><a href="#cb200-70"></a>           <span class="st">&quot;Bipolar_2&quot;</span> =<span class="st"> &quot;27&quot;</span>,</span>
<span id="cb200-71"><a href="#cb200-71"></a>           <span class="st">&quot;Bipolar_3&quot;</span> =<span class="st"> &quot;28&quot;</span>,</span>
<span id="cb200-72"><a href="#cb200-72"></a>           <span class="st">&quot;Bipolar_4&quot;</span> =<span class="st"> &quot;29&quot;</span>,</span>
<span id="cb200-73"><a href="#cb200-73"></a>           <span class="st">&quot;Bipolar_5&quot;</span> =<span class="st"> &quot;30&quot;</span>,</span>
<span id="cb200-74"><a href="#cb200-74"></a>           <span class="st">&quot;Bipolar_6&quot;</span> =<span class="st"> &quot;31&quot;</span>,</span>
<span id="cb200-75"><a href="#cb200-75"></a>           <span class="st">&quot;Bipolar_7&quot;</span> =<span class="st"> &quot;32&quot;</span>,</span>
<span id="cb200-76"><a href="#cb200-76"></a>           <span class="st">&quot;Bipolar_8&quot;</span> =<span class="st"> &quot;33&quot;</span>,</span>
<span id="cb200-77"><a href="#cb200-77"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;34&quot;</span>,</span>
<span id="cb200-78"><a href="#cb200-78"></a>           <span class="st">&quot;Astrocytes&quot;</span> =<span class="st"> &quot;35&quot;</span>,</span>
<span id="cb200-79"><a href="#cb200-79"></a>           <span class="st">&quot;Fibroblast&quot;</span> =<span class="st"> &quot;36&quot;</span>,</span>
<span id="cb200-80"><a href="#cb200-80"></a>           <span class="st">&quot;Vascular_endothelium&quot;</span> =<span class="st"> &quot;37&quot;</span>,</span>
<span id="cb200-81"><a href="#cb200-81"></a>           <span class="st">&quot;Pericytes&quot;</span> =<span class="st"> &quot;38&quot;</span>,</span>
<span id="cb200-82"><a href="#cb200-82"></a>           <span class="st">&quot;Microglia&quot;</span> =<span class="st"> &quot;39&quot;</span>)</span></code></pre></div>
</div>
<div id="clustering" class="section level1">
<h1><span class="header-section-number">15</span> Clustering</h1>
<div id="graph-based-clustering" class="section level2">
<h2><span class="header-section-number">15.1</span> Graph-based clustering</h2>
<p>First, we discuss graph-based clustering methods for scRNA-Seq data. This is very well explained in the <a href="http://bioconductor.org/books/3.14/OSCA.basic/clustering.html#clustering-graph">OSCA book chapter 5.2</a>.</p>
<p>As written in the OSCA book: “Popularized by its use in Seurat, graph-based clustering is a flexible and scalable technique for clustering large scRNA-seq datasets. We first build a graph where each node is a cell that is connected to its nearest neighbors in the high-dimensional space. Edges are weighted based on the similarity between the cells involved, with higher weight given to cells that are more closely related. We then apply algorithms to identify “communities” of cells that are more connected to cells in the same community than they are to cells of different communities. Each community represents a cluster that we can use for downstream interpretation.</p>
<p>The major advantage of graph-based clustering lies in its scalability. It only requires a k-nearest neighbor search that can be done in log-linear time on average, in contrast to hierarchical clustering methods with runtimes that are quadratic with respect to the number of cells. Graph construction avoids making strong assumptions about the shape of the clusters or the distribution of cells within each cluster, compared to other methods like k-means (that favor spherical clusters) or Gaussian mixture models (that require normality)."</p>
<p>Several graph-based clustering algorithms are implemented in the <code>scran</code> library. The most global wrapper-function in this package is the <code>clusterCells</code> function. Typically, the input to this function is a <code>SingleCellExperiment</code> object with pre-computed principal components; these are used to take advantage of data compression and denoising. If the default settings are adopted, <code>clusterCells</code> will perform two steps under the hood:</p>
<ol style="list-style-type: decimal">
<li><p>Build a shared nearest neighbors (SNN) graph of observations for downstream community detection. The SNN graph is closely related to the more common KNN graph. For each observation, its k-nearest neighbors are identified (k=10 by default), based on distances between their expression profiles (Euclidean distances are used by default) as observed in PCA space. An edge is drawn between all pairs of observations that share at least one neighbor, weighted by the characteristics of the shared nearest neighbors.</p></li>
<li><p>The <code>clusterCells</code> function next internally calls the <code>cluster_walktrap</code> function from the <code>igraph</code> library. Based on the SNN graph from step 1, this function tries to find densely connected subgraphs, also called communities in a graph via random walks. The idea is that short random walks tend to stay in the same community.</p></li>
</ol>
<pre><code># Do not run; clusterCells function with default settings, i.e., building an
# SNN graph and finding clusters with the walktrap algorithm.
library(scran)
nn.clusters &lt;- clusterCells(sce, 
                            use.dimred=&quot;PCA&quot;)
table(nn.clusters)</code></pre>
<p>The disadvantage of using <code>clusterCells</code> is that the default setting of the second step, the <code>cluster_walktrap</code> function, is slow for large datasets. While it is possible to adjust the different arguments of the <code>clusterCells</code> function, it might be more clear and intuitive to simply break up the process in two steps: building the graph and detecting clusters in that graph. For this second step, we may then adopt a faster algorithm.</p>
<div id="build-graph-snn-graph" class="section level3">
<h3><span class="header-section-number">15.1.1</span> Build graph (SNN graph)</h3>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1"></a><span class="co"># Build a shared nearest-neighbor graph from PCA space</span></span>
<span id="cb202-2"><a href="#cb202-2"></a>graph &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(sce, </span>
<span id="cb202-3"><a href="#cb202-3"></a>                       <span class="dt">use.dimred =</span> <span class="st">&#39;PCA&#39;</span>)</span>
<span id="cb202-4"><a href="#cb202-4"></a><span class="co"># alternative: buildKNNGraph()</span></span></code></pre></div>
</div>
<div id="detect-clusters-on-the-graph" class="section level3">
<h3><span class="header-section-number">15.1.2</span> Detect clusters on the graph</h3>
<p>Two popular graph-based clustering algorithm are the <code>leiden</code> and <code>louvain</code> algorithms, both referring to the location of its developers. A common implementation of the <a href="https://iopscience.iop.org/article/10.1088/1742-5468/2008/10/P10008"><code>louvain</code>algorithm</a> is to optimize the modularity, effectively attempting to maximize the difference between the observed number of edges in a community and the expected number of such edges.</p>
<p>However, additional evaluations found that modularity optimization using the <code>louvain</code> algorithm is confined to a <a href="https://www.pnas.org/content/104/1/36">resolution limit</a>, and in addition may result in communities that are not well connected. The <a href="https://www.nature.com/articles/s41598-019-41695-z"><code>leiden</code> algorithm</a>, instead, guarantees well-connected communities.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1"></a><span class="kw">set.seed</span>(<span class="dv">464688</span>)</span>
<span id="cb203-2"><a href="#cb203-2"></a><span class="co"># Walktrap community finding algorithm on the SNN graph</span></span>
<span id="cb203-3"><a href="#cb203-3"></a><span class="co"># DO NOT RUN -&gt; takes 20 minutes</span></span>
<span id="cb203-4"><a href="#cb203-4"></a><span class="co"># cluster_walktrap &lt;- factor(igraph::cluster_walktrap(g)$membership) #20min</span></span>
<span id="cb203-5"><a href="#cb203-5"></a></span>
<span id="cb203-6"><a href="#cb203-6"></a><span class="co"># The `cluster_fast_greedy` function tries to find dense subgraph, also called </span></span>
<span id="cb203-7"><a href="#cb203-7"></a><span class="co"># communities in graphs via directly optimizing a modularity score</span></span>
<span id="cb203-8"><a href="#cb203-8"></a><span class="co"># DO NOT RUN -&gt; takes 4 minutes</span></span>
<span id="cb203-9"><a href="#cb203-9"></a><span class="co"># cluster_fastGreedy &lt;- factor(igraph::cluster_fast_greedy(graph)$membership) #4min</span></span>
<span id="cb203-10"><a href="#cb203-10"></a></span>
<span id="cb203-11"><a href="#cb203-11"></a><span class="co"># Louvain clustering on the SNN graph</span></span>
<span id="cb203-12"><a href="#cb203-12"></a>cluster_louvain &lt;-<span class="st"> </span><span class="kw">factor</span>(igraph<span class="op">::</span><span class="kw">cluster_louvain</span>(graph)<span class="op">$</span>membership) <span class="co">#8sec</span></span>
<span id="cb203-13"><a href="#cb203-13"></a><span class="kw">nlevels</span>(cluster_louvain) <span class="co"># 11 clusters</span></span></code></pre></div>
<pre><code>## [1] 13</code></pre>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1"></a><span class="co"># Leiden clustering on the SNN graph</span></span>
<span id="cb205-2"><a href="#cb205-2"></a>cluster_leiden &lt;-<span class="st"> </span><span class="kw">factor</span>(igraph<span class="op">::</span><span class="kw">cluster_leiden</span>(graph)<span class="op">$</span>membership) <span class="co">#10sec</span></span>
<span id="cb205-3"><a href="#cb205-3"></a><span class="kw">nlevels</span>(cluster_leiden) <span class="co"># 1326 different clusters!</span></span></code></pre></div>
<pre><code>## [1] 1260</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1"></a>cluster_leiden2 &lt;-<span class="st"> </span><span class="kw">factor</span>(igraph<span class="op">::</span><span class="kw">cluster_leiden</span>(<span class="dt">graph =</span> graph,</span>
<span id="cb207-2"><a href="#cb207-2"></a>                                                 <span class="dt">resolution_parameter =</span> <span class="fl">0.01</span>)<span class="op">$</span>membership) <span class="co">#10sec</span></span>
<span id="cb207-3"><a href="#cb207-3"></a><span class="kw">nlevels</span>(cluster_leiden2) <span class="co">#14 different clusters</span></span></code></pre></div>
<pre><code>## [1] 10</code></pre>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1"></a><span class="co"># Add to sce and visualize</span></span>
<span id="cb209-2"><a href="#cb209-2"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster_louvain &lt;-<span class="st"> </span>cluster_louvain</span>
<span id="cb209-3"><a href="#cb209-3"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster_leiden2 &lt;-<span class="st"> </span>cluster_leiden2</span></code></pre></div>
</div>
<div id="comparing-clustering-strategies" class="section level3">
<h3><span class="header-section-number">15.1.3</span> Comparing clustering strategies</h3>
<p>A direct comparison of the Louvain and Leiden clustering results using a table of the cluster labels, shows good agreement.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1"></a><span class="kw">table</span>(cluster_louvain, cluster_leiden2)</span></code></pre></div>
<pre><code>##                cluster_leiden2
## cluster_louvain    1    2    3    4    5    6    7    8    9   10
##              1  3546    0    0   24    0    1    0    0    0    0
##              2     0 2079    0    3    6    0    0    0    3    0
##              3     1    0  181    0    0    0    0    0    0    0
##              4     1    0    0 3047    0    0    4    0    0    0
##              5    55   11    0 1779   99    2    0    0   20    0
##              6   198    0    0    0    0    0    0    0    0    0
##              7     0    4    0    0 3744    0    0    0   13    0
##              8     0    0    0    0    0  466    0    0    0    0
##              9     0    0    0  182    0    0 2294    0    0    0
##              10    1    0    0    0    0    2    0 1639    1    0
##              11    0    0    0    0  124    0    0    0 6045    0
##              12    0    1    0    9 8936    1    0    3   91    0
##              13    0    0    0    2 6382    0    0    0   35    1</code></pre>
<p>First, note that Leiden2 clusters 9-14 all contain only 1 cell, which doesn’t make much sense.</p>
<p>Next, we see the following clear correspondences between the cluster labels:</p>
<p>Louvain 1 -&gt; Leiden 1 Louvain 6 -&gt; Leiden 2 Louvain 3 -&gt; Leiden 4 Louvain 7 -&gt; Leiden 6 Louvain 8 -&gt; Leiden 7 Louvain 10 -&gt; Leiden 8</p>
<p>For the remaining clusters, we see that - Leiden cluster 3 contains almost cells of Louvain clusters 2, 9 and 11 - Leiden cluster 5 contains almost cells of Louvain clusters 4 and 5</p>
<p>To make a visualization that gives us very similar information, we may use a heatmap:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb212-2"><a href="#cb212-2"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(cluster_louvain, cluster_leiden2))</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-56-1.png" width="672" /></p>
<p>Alternatively, we may compute a clustering similarity score that captures the agreement between two sets of partitions. The Adjusted Rand Index (ARI) is often used in the literature for this purpose. The ARI is equal to 1 if the two partitions agree perfectly, and it is zero if the two partitions are unrelated. In some cases, the ARI may also be negative if the partitions are much more different than what could be expected by chance.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1"></a><span class="kw">library</span>(mclust)</span></code></pre></div>
<pre><code>## Package &#39;mclust&#39; version 5.4.8
## Type &#39;citation(&quot;mclust&quot;)&#39; for citing this R package in publications.</code></pre>
<pre><code>## 
## Attaching package: &#39;mclust&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     map</code></pre>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1"></a>mclust<span class="op">::</span><span class="kw">adjustedRandIndex</span>(cluster_louvain[<span class="op">-</span><span class="kw">which</span>(cluster_leiden2 <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">14</span>))], </span>
<span id="cb217-2"><a href="#cb217-2"></a>                          cluster_leiden2[<span class="op">-</span><span class="kw">which</span>(cluster_leiden2 <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">14</span>))])</span></code></pre></div>
<pre><code>## [1] 0.4664357</code></pre>
</div>
<div id="visualization" class="section level3">
<h3><span class="header-section-number">15.1.4</span> Visualization</h3>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1"></a><span class="co"># Visualization. Add the cluster labels to the previously generated TSNE</span></span>
<span id="cb219-2"><a href="#cb219-2"></a><span class="co"># coordinates</span></span>
<span id="cb219-3"><a href="#cb219-3"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb219-4"><a href="#cb219-4"></a>         <span class="dt">colour_by=</span><span class="st">&quot;cluster_louvain&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb220-2"><a href="#cb220-2"></a>         <span class="dt">colour_by=</span><span class="st">&quot;cluster_leiden2&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-58-2.png" width="672" /></p>
</div>
</div>
<div id="k-means-clustering" class="section level2">
<h2><span class="header-section-number">15.2</span> K-means clustering</h2>
<p>K-means is a clustering algorithm that has been used in many application areas. In R, it can be applied via the <code>kmeans</code> function. Typically, it is applied to a reduced dimensional representation of the expression data (most often PCA). We need to define the number of clusters in advance. Since the results depend on the initialization of the cluster centers, it is typically recommended to run k-means with multiple starting configurations (via the <code>nstart</code> argument). For reproducibility, we also strongly advise to set a seed.</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb221-2"><a href="#cb221-2"></a></span>
<span id="cb221-3"><a href="#cb221-3"></a><span class="co"># k=10</span></span>
<span id="cb221-4"><a href="#cb221-4"></a>clust_kmeans_k10 &lt;-<span class="st"> </span><span class="kw">kmeans</span>(<span class="kw">reducedDim</span>(sce, <span class="st">&quot;PCA&quot;</span>), <span class="dt">centers =</span> <span class="dv">10</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</span>
<span id="cb221-5"><a href="#cb221-5"></a><span class="kw">table</span>(clust_kmeans_k10<span class="op">$</span>cluster)</span>
<span id="cb221-6"><a href="#cb221-6"></a><span class="kw">colData</span>(sce)<span class="op">$</span>kmeans10 &lt;-<span class="st"> </span><span class="kw">factor</span>(clust_kmeans_k10<span class="op">$</span>cluster)</span>
<span id="cb221-7"><a href="#cb221-7"></a><span class="kw">plotTSNE</span>(sce, <span class="dt">colour_by=</span><span class="st">&quot;kmeans10&quot;</span>)</span>
<span id="cb221-8"><a href="#cb221-8"></a></span>
<span id="cb221-9"><a href="#cb221-9"></a><span class="co"># k=39</span></span>
<span id="cb221-10"><a href="#cb221-10"></a>clust_kmeans_k39 &lt;-<span class="st"> </span><span class="kw">kmeans</span>(<span class="kw">reducedDim</span>(sce, <span class="st">&quot;PCA&quot;</span>), <span class="dt">centers =</span> <span class="dv">39</span>, <span class="dt">nstart =</span> <span class="dv">5</span>)</span>
<span id="cb221-11"><a href="#cb221-11"></a><span class="kw">table</span>(clust_kmeans_k39<span class="op">$</span>cluster)</span>
<span id="cb221-12"><a href="#cb221-12"></a><span class="kw">colData</span>(sce)<span class="op">$</span>kmeans39 &lt;-<span class="st"> </span><span class="kw">factor</span>(clust_kmeans_k39<span class="op">$</span>cluster)</span>
<span id="cb221-13"><a href="#cb221-13"></a><span class="kw">plotTSNE</span>(sce, <span class="dt">colour_by=</span><span class="st">&quot;kmeans39&quot;</span>)</span></code></pre></div>
<p>We here arbitrarily performed two k-means clustering analyses, once with k=10 and once with k=39 (the number of clusters communicated by the authors). The choice of the number of clusters k can be guided by known biology, however, it is arbitrary at least to some interval.</p>
</div>
<div id="hierarchical-clustering" class="section level2">
<h2><span class="header-section-number">15.3</span> Hierarchical clustering</h2>
<p>From <a href="http://bioconductor.org/books/3.14/OSCA.basic/clustering.html#hierarchical-clustering">OSCA book chapter 5.4</a>:</p>
<p>"Hierarchical clustering is an old technique that arranges samples into a hierarchy based on their relative similarity to each other. Most implementations do so by joining the most similar samples into a new cluster, then joining similar clusters into larger clusters, and so on, until all samples belong to a single cluster. This process yields a dendrogram that defines clusters with progressively increasing granularity. Variants of hierarchical clustering methods primarily differ in how they choose to perform the agglomerations. For example, complete linkage aims to merge clusters with the smallest maximum distance between their elements, while Ward’s method aims to minimize the increase in within-cluster variance.</p>
<p>In the context of scRNA-seq, the main advantage of hierarchical clustering lies in the production of the dendrogram. This is a rich summary that quantitatively captures the relationships between subpopulations at various resolutions. Cutting the dendrogram at high resolution is also guaranteed to yield clusters that are nested within those obtained at a low-resolution cut; this can be helpful for interpretation."</p>
<p>Indeed, low-resolution clusters can typically be interpreted as super-level cell types, like immune cells, neuron cells or endothelial cells. Higher resolution clusters correspond with a higher biological resolution: immune cell -&gt; lymphocyte -&gt; T-cell -&gt; Th1 cell.</p>
<p>However, note that we can also overcluster the data (splitting a homogenous set of cells in multiple clusters), resulting in spurious cell type identification.</p>
<p>The <code>clusterCells</code> function of the <code>scran</code> library also allows for performing hierarchical clustering. This can be implemented as follows:</p>
<pre><code># takes 4 minutes
library(bluster)
hclust.sce &lt;- clusterCells(x = sce, 
                            use.dimred = &quot;PCA&quot;,
                            BLUSPARAM = HclustParam(method=&quot;ward.D2&quot;))</code></pre>
<p>Equivalently, we may again split the process in two steps:</p>
<ol style="list-style-type: decimal">
<li><p>Compute the pairwise distances between all cells. These are by default Euclidean distances and, in order to reduce data complexity and increase signal to noise, we may perform this on the top (30) PC’s, just like we did when constructing the SNN graph in graph-based clustering. Calculating a dissimilarity matrix is implemented in the <code>dist</code> function.</p></li>
<li><p>Perform a hierarchical clustering on the distances from step 1. In an agglomerative procedure, each cell is first assigned to its own cluster and then the algorithm proceeds iteratively, at each stage joining the two most similar clusters, continuing until there is just a single cluster. Implemented in the <code>hclust</code> function.</p></li>
</ol>
<p>Note that the <code>hclust</code> function allows for specifying a “method” argument. The differences between the different methods goes beyond the scope of this session, but a brief description is provided in the function help file. In the context of scRNA-seq, we recommend the use of the <code>"ward.D2"</code> method.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1"></a>distsce &lt;-<span class="st"> </span><span class="kw">dist</span>(<span class="kw">reducedDim</span>(sce, <span class="st">&quot;PCA&quot;</span>)) <span class="co">#1min</span></span>
<span id="cb223-2"><a href="#cb223-2"></a>hcl &lt;-<span class="st"> </span><span class="kw">hclust</span>(distsce, <span class="dt">method =</span> <span class="st">&quot;ward.D2&quot;</span>) <span class="co">#3min</span></span>
<span id="cb223-3"><a href="#cb223-3"></a><span class="kw">plot</span>(hcl, <span class="dt">labels =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p>Next, in order to derive a given set of cluster labels, we need to “cut the tree”, i.e., choose at which resolution we want to report the (cell type) clusters. This can be achieved with the <code>cutree</code> function. As an input, <code>cutree</code> takes the dendrogram from the <code>hclust</code> function and a threshold value for cutting the tree. The latter may be either <code>k</code>, the number of clusters we want to report, or <code>h</code>, the height of the dendrogram at which we want to cut the tree.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1"></a><span class="co"># cut to get 10 clusters</span></span>
<span id="cb224-2"><a href="#cb224-2"></a>clust_hcl_k10 &lt;-<span class="st"> </span><span class="kw">cutree</span>(hcl, <span class="dt">k =</span> <span class="dv">10</span>)</span>
<span id="cb224-3"><a href="#cb224-3"></a><span class="kw">table</span>(clust_hcl_k10)</span></code></pre></div>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1"></a><span class="co"># cut to get 39 clusters</span></span>
<span id="cb225-2"><a href="#cb225-2"></a>clust_hcl_k39 &lt;-<span class="st"> </span><span class="kw">cutree</span>(hcl, <span class="dt">k =</span> <span class="dv">39</span>)</span>
<span id="cb225-3"><a href="#cb225-3"></a><span class="kw">table</span>(clust_hcl_k39)</span></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1"></a>sce<span class="op">$</span>clust_hcl_k10 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(clust_hcl_k10)</span>
<span id="cb226-2"><a href="#cb226-2"></a>sce<span class="op">$</span>clust_hcl_k39 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(clust_hcl_k39)</span>
<span id="cb226-3"><a href="#cb226-3"></a></span>
<span id="cb226-4"><a href="#cb226-4"></a><span class="co"># Visualization. Add the cluster labels to the previously generated TSNE</span></span>
<span id="cb226-5"><a href="#cb226-5"></a><span class="co"># coordinates</span></span>
<span id="cb226-6"><a href="#cb226-6"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb226-7"><a href="#cb226-7"></a>         <span class="dt">colour_by=</span><span class="st">&quot;clust_hcl_k10&quot;</span>)</span>
<span id="cb226-8"><a href="#cb226-8"></a></span>
<span id="cb226-9"><a href="#cb226-9"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb226-10"><a href="#cb226-10"></a>         <span class="dt">colour_by =</span><span class="st">&quot;clust_hcl_k39&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="clustering-in-the-original-paper" class="section level1">
<h1><span class="header-section-number">16</span> Clustering in the original paper</h1>
<p>When we compare our cluster labels with those from the original paper, we’ll see that the correspondence is not great. As a demonstration, I make a table and a heatmap comparing the low-resolution cluster labels from the paper with our Louvain, Leiden2 and hierarchical clustering (k=10) labels:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>cluster_louvain)</span></code></pre></div>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>cluster_leiden2)</span></code></pre></div>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>clust_hcl_k10)</span></code></pre></div>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>cluster_louvain))</span>
<span id="cb230-2"><a href="#cb230-2"></a></span>
<span id="cb230-3"><a href="#cb230-3"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>cluster_leiden2))</span>
<span id="cb230-4"><a href="#cb230-4"></a></span>
<span id="cb230-5"><a href="#cb230-5"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, sce<span class="op">$</span>clust_hcl_k10))</span></code></pre></div>
<p>Also, when we look at the t-SNE from the original publication, we observe clearly distinct clusters:</p>
<p><img src="macosko_figure_5B.jpeg" /><!-- --></p>
<p>The main reason for this is that the authors of the original paper used quite a different strategy for performing the feature selection and dimension reduction that we have performed in lab session 2.</p>
<p>To demonstrate the pipeline of the original authors, and to make our results more comparable to theirs, We will here mimic their strategy for feature selection and clustering. <strong>However, we will do this approximatively!</strong> We will take similar steps conceptually, but will remain within the current Bioconductor framework and the range of functions that we have seen in this lecture series.</p>
<p>The authors performed the following steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Filtering:</strong> The authors first filtered the 49,300-cell dataset to retain only single-cell libraries where at least 900 genes were detected.</p></li>
<li><p><strong>Feature selection:</strong> The authors first identified the set of genes that were most variable across the selected susbet of cells, after controlling for the relationship between mean expression and variability. To do this, the authors adopted a manual implementation.</p></li>
</ol>
<p>-&gt; We will not use the exact same strategy, but the <code>modelGeneVar-getTopHVGs</code> strategy, which is conceptually similar in addressing the mean-variance relationship during feature selection.</p>
<ol start="3" style="list-style-type: decimal">
<li><p><strong>Principal component analysis:</strong> The authors performed PCA after scaling the data. They next performed a test to determine how many PCs contributed significantly to explaining the variability in the data. Based on this test, they continued the analysis pipeline with the top 32 PCs.</p></li>
<li><p><strong>t-SNE:</strong> Next, the authors performed a t-SNE on the top 32 PC’s, setting the <code>perplexity</code> parameter of the t-SNE algorithm to 30.</p></li>
<li><p><strong>Projection of remaining cells and clustering:</strong> Finally, the authors adopted a manually implemented, rather complex strategy to project the remaining cells (where less than 900 different genes were detected) on the t-SNE embedding obtained in step 4. Next, they cluster the cells using a density clustering (DBSCAN algorithm) that was not discussed in this lecture series. Because this 5th step uses techniques beyond the scope of this course, we will simply continue working with the filtered dataset and perform hierarchical clustering. However, we included some code that allows you to do something similar to what the authors did for your reference (note that running<br />
this code requires installing the <code>snifter</code> R package, which requires a working Python and Conda installation).</p></li>
</ol>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1"></a><span class="co"># code for steps 1-4</span></span>
<span id="cb231-2"><a href="#cb231-2"></a><span class="kw">library</span>(scater)</span>
<span id="cb231-3"><a href="#cb231-3"></a><span class="kw">library</span>(genefilter)</span>
<span id="cb231-4"><a href="#cb231-4"></a><span class="kw">library</span>(scran)</span>
<span id="cb231-5"><a href="#cb231-5"></a></span>
<span id="cb231-6"><a href="#cb231-6"></a><span class="co"># Step 1: Downsampling</span></span>
<span id="cb231-7"><a href="#cb231-7"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span>sce[,sce<span class="op">$</span>detected <span class="op">&gt;</span><span class="st"> </span><span class="dv">900</span>]</span>
<span id="cb231-8"><a href="#cb231-8"></a></span>
<span id="cb231-9"><a href="#cb231-9"></a><span class="co"># Step 2: Feature selection</span></span>
<span id="cb231-10"><a href="#cb231-10"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce_<span class="dv">900</span>)</span>
<span id="cb231-11"><a href="#cb231-11"></a>dec_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">modelGeneVar</span>(sce_<span class="dv">900</span>)</span>
<span id="cb231-12"><a href="#cb231-12"></a>hvg_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec_<span class="dv">900</span>,</span>
<span id="cb231-13"><a href="#cb231-13"></a>                      <span class="dt">n =</span> <span class="dv">374</span>) <span class="co"># same number of top features as original paper</span></span>
<span id="cb231-14"><a href="#cb231-14"></a></span>
<span id="cb231-15"><a href="#cb231-15"></a><span class="co"># Step 3: PCA</span></span>
<span id="cb231-16"><a href="#cb231-16"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb231-17"><a href="#cb231-17"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce_<span class="dv">900</span>, </span>
<span id="cb231-18"><a href="#cb231-18"></a>                  <span class="dt">ncomponents =</span> <span class="dv">32</span>, <span class="co"># same number of PCs as original paper</span></span>
<span id="cb231-19"><a href="#cb231-19"></a>                  <span class="dt">subset_row =</span> hvg_<span class="dv">900</span>,</span>
<span id="cb231-20"><a href="#cb231-20"></a>                  <span class="dt">scale=</span><span class="ot">TRUE</span>) <span class="co"># scale the data like in original paper</span></span>
<span id="cb231-21"><a href="#cb231-21"></a></span>
<span id="cb231-22"><a href="#cb231-22"></a><span class="co"># Step 4: T-SNE</span></span>
<span id="cb231-23"><a href="#cb231-23"></a><span class="kw">set.seed</span>(<span class="dv">484854</span>)</span>
<span id="cb231-24"><a href="#cb231-24"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce_<span class="dv">900</span>, </span>
<span id="cb231-25"><a href="#cb231-25"></a>               <span class="dt">dimred =</span> <span class="st">&#39;PCA&#39;</span>,</span>
<span id="cb231-26"><a href="#cb231-26"></a>               <span class="dt">n_dimred =</span> <span class="dv">32</span>,</span>
<span id="cb231-27"><a href="#cb231-27"></a>               <span class="dt">perplexity =</span> <span class="dv">30</span>) <span class="co"># same perplexity as original paper</span></span></code></pre></div>
<pre><code># Step 5 authors (just for your reference): project new cells on t-SNE embedding
#BiocManager::install(&quot;snifter&quot;)
library(snifter)
tsne1 &lt;- snifter::fitsne(reducedDim(sce_900, type=&quot;PCA&quot;))
embedding &lt;- reducedDim(sce[hvg_900,sce$detected&gt;900], type=&quot;PCA&quot;)

ggplot() +
  aes(tsne1[, 1], tsne1[, 2], colour = as.factor(sce[,sce$detected&gt;900]$cluster)) +
  geom_point(pch = 19) +
  scale_colour_discrete(name = &quot;Cluster&quot;) +
  labs(x = &quot;t-SNE 1&quot;, y = &quot;t-SNE 2&quot;) +
  theme_bw()

new_coords &lt;- project(tsne1, 
                      new = reducedDim(sce[,sce$detected&lt;=900], type=&quot;PCA&quot;), 
                      old = reducedDim(sce[,sce$detected&gt;900], type=&quot;PCA&quot;))
ggplot() +
    geom_point(
        aes(tsne1[, 1], tsne1[, 2],
            colour = as.factor(sce[,sce$detected&gt;900]$cluster),
            shape = &quot;embedding&quot;
        )
    ) +
    geom_point(
        aes(new_coords[, 1], new_coords[, 2], 
            colour = as.factor(sce[,sce$detected&lt;=900]$cluster),
            shape = &quot;projection&quot;
        )
    ) +
    scale_colour_discrete(name = &quot;Cell type&quot;) +
    scale_shape_discrete(name = NULL) +
    labs(x = &quot;t-SNE 1&quot;, y = &quot;t-SNE 2&quot;) +
    theme_bw()</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1"></a><span class="co"># Step 5 for us: perform hierarchical clustering</span></span>
<span id="cb233-2"><a href="#cb233-2"></a>distsce &lt;-<span class="st"> </span><span class="kw">dist</span>(<span class="kw">reducedDim</span>(sce_<span class="dv">900</span>, <span class="st">&quot;PCA&quot;</span>))</span>
<span id="cb233-3"><a href="#cb233-3"></a>hcl &lt;-<span class="st"> </span><span class="kw">hclust</span>(distsce, <span class="dt">method =</span> <span class="st">&quot;ward.D2&quot;</span>)</span>
<span id="cb233-4"><a href="#cb233-4"></a></span>
<span id="cb233-5"><a href="#cb233-5"></a>clust_hcl_k10 &lt;-<span class="st"> </span><span class="kw">cutree</span>(hcl, <span class="dt">k =</span> <span class="dv">10</span>)</span>
<span id="cb233-6"><a href="#cb233-6"></a>clust_hcl_k39 &lt;-<span class="st"> </span><span class="kw">cutree</span>(hcl, <span class="dt">k =</span> <span class="dv">39</span>)</span>
<span id="cb233-7"><a href="#cb233-7"></a></span>
<span id="cb233-8"><a href="#cb233-8"></a>sce_<span class="dv">900</span><span class="op">$</span>clust_hcl_k10 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(clust_hcl_k10)</span>
<span id="cb233-9"><a href="#cb233-9"></a>sce_<span class="dv">900</span><span class="op">$</span>clust_hcl_k39 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(clust_hcl_k39)</span></code></pre></div>
<p>Visualize our labels and compare with original labels</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb234-2"><a href="#cb234-2"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;clust_hcl_k10&quot;</span>,</span>
<span id="cb234-3"><a href="#cb234-3"></a>         <span class="dt">text_by =</span> <span class="st">&quot;clust_hcl_k10&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-71-1.png" width="672" /></p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb235-2"><a href="#cb235-2"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>,</span>
<span id="cb235-3"><a href="#cb235-3"></a>         <span class="dt">text_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-71-2.png" width="672" /></p>
<p>For the low resolution labels, we observe a strong correspondence between our clustering and that of the original authors. More specifically:</p>
<ul>
<li>The original rods correspond with our group 5</li>
<li>The original cones correspond with our group 2</li>
<li>The original pericytes and vascular endothelium correspond with our group 7</li>
<li>The original muller glia, astrocytes, fibroblasts and microglia (which are similar cell types, see paper figure 5D) correspond with our group 8</li>
<li>The original ganglion and horizontal cells (which are similar cell types, see paper figure 5D) correspond with our group 1</li>
<li>The original bipolar cells are split out between our groups 4 and 10</li>
<li>The original amacrine cells correspond with our groups 3, 6 and 9</li>
</ul>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb236-2"><a href="#cb236-2"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>,</span>
<span id="cb236-3"><a href="#cb236-3"></a>         <span class="dt">text_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb237-2"><a href="#cb237-2"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb237-3"><a href="#cb237-3"></a>         <span class="dt">text_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 1523 rows containing missing values (geom_point).</code></pre>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-72-2.png" width="672" /></p>
<p>I will not make an extensive comparison here. However, note that we see several scenarios:</p>
<ol style="list-style-type: decimal">
<li><p>Clusters that correspond one-on-one (e.g., our cluster 19 with cluster 16 of the authors)</p></li>
<li><p>We split up some clusters in multiple sets (e.g., our clusters 16, 18 and</p></li>
</ol>
<ol start="32" style="list-style-type: decimal">
<li>that are just 1 cluster in the analysis of the authors (cluster 34)</li>
</ol>
<ol start="3" style="list-style-type: decimal">
<li>We aggregate some clusters into 1 (e.g. cluster 14) that are split up in the original results (clusters 37 and 38)</li>
</ol>
<p><strong>Overall, we observe a rather strong correspondence between our clusters and</strong> <strong>those of the authors.</strong> Also note that our t-SNE visualization now resembles the t-SNE map of the original authors much more closely:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;./macosko_figure_5B.jpeg&quot;</span>)</span></code></pre></div>
<p><img src="macosko_figure_5B.jpeg" /><!-- --></p>
</div>
<div id="cell-type-annotation" class="section level1">
<h1><span class="header-section-number">17</span> Cell type annotation</h1>
<div id="supervised-using-a-limited-set-of-known-markers" class="section level2">
<h2><span class="header-section-number">17.1</span> Supervised: using a limited set of known markers</h2>
<p>In the publication, the authors aimed to identify the different clusters in the data by using a set of 12 well-known molecular markers; genes for which the expression profile is typically very specific, i.e., highly expressed only in one specific cell type. They used the following markers:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1"></a>markers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;LHX1&quot;</span>, <span class="st">&quot;SLC17A6&quot;</span>,<span class="st">&quot;PAX6&quot;</span>,<span class="st">&quot;GAD1&quot;</span>,<span class="st">&quot;SLC6A9&quot;</span>,<span class="st">&quot;OPN1MW&quot;</span>,<span class="st">&quot;VSX2&quot;</span>,</span>
<span id="cb240-2"><a href="#cb240-2"></a>             <span class="st">&quot;RLBP1&quot;</span>, <span class="st">&quot;GFAP&quot;</span>, <span class="st">&quot;PECAM1&quot;</span>, <span class="st">&quot;KCNJ8&quot;</span>,<span class="st">&quot;CX3CR1&quot;</span>)</span></code></pre></div>
<p>We will here visualize the expression of these markers in t-SNE space. First, we create a “baseline” figure, displaying each cell in 2D space, colored in black.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb241-2"><a href="#cb241-2"></a>gg_hlp_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">reducedDim</span>(sce_<span class="dv">900</span>, <span class="dt">type =</span> <span class="st">&quot;TSNE&quot;</span>)[,<span class="dv">1</span>],</span>
<span id="cb241-3"><a href="#cb241-3"></a>                          <span class="dt">y =</span> <span class="kw">reducedDim</span>(sce_<span class="dv">900</span>, <span class="dt">type =</span> <span class="st">&quot;TSNE&quot;</span>)[,<span class="dv">2</span>],</span>
<span id="cb241-4"><a href="#cb241-4"></a>                          <span class="dt">cluster =</span> sce_<span class="dv">900</span><span class="op">$</span>cluster)</span>
<span id="cb241-5"><a href="#cb241-5"></a>gg_base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gg_hlp_data[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster),],</span>
<span id="cb241-6"><a href="#cb241-6"></a>                  <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y,)) <span class="op">+</span></span>
<span id="cb241-7"><a href="#cb241-7"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb241-8"><a href="#cb241-8"></a><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb241-9"><a href="#cb241-9"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;TSNE 1&quot;</span>) <span class="op">+</span></span>
<span id="cb241-10"><a href="#cb241-10"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;TSNE 2&quot;</span>)</span>
<span id="cb241-11"><a href="#cb241-11"></a>gg_base</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-75-1.png" width="672" /></p>
<p>Next, we obtain the counts of the 12 pre-selected marker genes for all cells.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1"></a>marker_counts &lt;-<span class="st"> </span><span class="kw">assays</span>(sce_<span class="dv">900</span>)<span class="op">$</span>counts[markers,]</span>
<span id="cb242-2"><a href="#cb242-2"></a>marker_counts &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">t</span>(marker_counts))</span></code></pre></div>
<p>Finally, we make one figure for each of the 12 marker genes. The idea is to give each cell that has a non-zero expression of the marker (i.e., for which the marker is expressed) a red coloring.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1"></a>marker_counts_binary &lt;-<span class="st"> </span>marker_counts</span>
<span id="cb243-2"><a href="#cb243-2"></a>marker_counts_binary[<span class="kw">which</span>(marker_counts_binary <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb243-3"><a href="#cb243-3"></a></span>
<span id="cb243-4"><a href="#cb243-4"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(markers)) {</span>
<span id="cb243-5"><a href="#cb243-5"></a>    gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gg_hlp_data[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster),],</span>
<span id="cb243-6"><a href="#cb243-6"></a>                    <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb243-7"><a href="#cb243-7"></a><span class="st">        </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">as.factor</span>(marker_counts_binary[,i])[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster)]), <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb243-8"><a href="#cb243-8"></a><span class="st">        </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;black&quot;</span>,<span class="st">&quot;red&quot;</span>)) <span class="op">+</span></span>
<span id="cb243-9"><a href="#cb243-9"></a><span class="st">        </span><span class="kw">xlab</span>(<span class="st">&quot;TSNE 1&quot;</span>) <span class="op">+</span></span>
<span id="cb243-10"><a href="#cb243-10"></a><span class="st">        </span><span class="kw">ylab</span>(<span class="st">&quot;TSNE 2&quot;</span>) <span class="op">+</span></span>
<span id="cb243-11"><a href="#cb243-11"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="kw">colnames</span>(marker_counts_binary)[i]) <span class="op">+</span></span>
<span id="cb243-12"><a href="#cb243-12"></a><span class="st">        </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb243-13"><a href="#cb243-13"></a><span class="st">      </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span>
<span id="cb243-14"><a href="#cb243-14"></a>    <span class="kw">print</span>(gg)</span>
<span id="cb243-15"><a href="#cb243-15"></a>}</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-1.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-2.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-3.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-4.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-5.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-6.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-7.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-8.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-9.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-10.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-11.png" width="672" /><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-77-12.png" width="672" /></p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1"></a><span class="co"># Visualize our clusters</span></span>
<span id="cb244-2"><a href="#cb244-2"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb244-3"><a href="#cb244-3"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>,</span>
<span id="cb244-4"><a href="#cb244-4"></a>         <span class="dt">text_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-78-1.png" width="672" /></p>
<p>From figure 5D, we obtain the marker-cell type relationship,</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;./macosko_figure_5D.jpeg&quot;</span>)</span></code></pre></div>
<p><img src="macosko_figure_5D.jpeg" /><!-- --></p>
<p>and draw the following conclusions:</p>
<ul>
<li><p>The <em>LHX1</em> marker is specific for horizontal cells. As such, our <strong>cluster 3</strong> corresponds to <strong>horizontal cells</strong>.</p></li>
<li><p>The <em>SLC17A6</em> marker is specific for ganglion cells. As such, our <strong>cluster 1</strong> corresponds to <strong>ganglion cells</strong>.</p></li>
<li><p>The <em>PAX6</em> marker is not specific. It is expressed in horizontal cells, ganglion cells, amacrine cells (all subtypes), muller glia cells and fibroblasts. First, this reconfirms our previous statements about clusters 3 and 1, which indeed should also express <em>PAX6</em>. Second, many clusters are potential candidates for being any of the remaining cell types to express <em>PAX6</em>. The next marker should point us to their more exact identity.</p></li>
<li><p>The <em>GAD1</em> marker is specific for amacrine cells. In addition, it is only expressed in “GABAergic” amacrine cells, which affect the neurotransmitter GABA. As such, <strong>clusters 4, 5, 6, 8, 9, 11, 13, 29, 30 and 31 are GABAergic</strong> <strong>amacrine cells</strong>. Conversely, the clusters that express <em>PAX6</em> but not <em>GAD1</em> (clusters 16, 18, 19, 22, 23, 24, 26, 32, 36) are either non-GABAergic amacrine cells, muller glia cells or fibroblasts.</p></li>
<li><p>The <em>SLC6A9</em> marker is specific for glycinergic amacrine cells, i.e., affecting the neurotransmitter glycine. As such, <strong>clusters 19, 22, 23, 26 and 36</strong> are the glycinergic amacrine cells. In addition, we have clusters 16, 18, 24 and 32 that express <em>PAX6</em>, but not <em>GAD1</em> nor <em>SLC6A9</em>. As such, these cells should be either muller glia cells or fibroblasts.</p></li>
<li><p>The <em>OPN1MW</em> marker is specific for cones. As such, our <strong>clusters 2, 34 and 35</strong> corresponds to <strong>cones</strong>.</p></li>
<li><p>The <em>VSX2</em> marker is strongly expressed in <strong>bipolar cells</strong>. In addition, it is lowly expressed in <strong>muller glia cells</strong> and <strong>fibroblasts</strong>. As such, <strong>clusters 7, 10, 15, 16, 18, 20, 21, 25, 27, 32, 33, 37 and 38</strong> should belong to one of these cell types.</p></li>
<li><p>The <em>RLBP1</em> marker is specific for muller glia cells and astrocytes. Since clusters 16, 18 and 32 express <em>RLBP1</em> and <em>PAX6</em>, but not <em>GAD1</em> nor <em>SLC6A9</em>, we now have very strong evidence that these are muller glia cells.</p></li>
<li><p>The <em>GFAP</em> marker is specific for astrocytes. As such, our <strong>clusters 24</strong>, which also expresses <em>RLBP1</em>, should correspond to <strong>astrocytes</strong>.</p></li>
<li><p>The <em>PECAM1</em> marker is specific for pericytes As such, our <strong>clusters 14</strong>, should correspond to <strong>pericytes</strong>.</p></li>
<li><p>The <em>PECAM1</em> marker is specific for vascular endothelium cells. As such, our <strong>clusters 14</strong>, should correspond to <strong>vascular endothelium cells</strong>.</p></li>
<li><p>The <em>KCNJ8</em> marker is specific for pericytes. As such, our <strong>clusters 14</strong>, should correspond to <strong>pericytes</strong>. Note that it thus appears that our clustering procedure was not able to differentiate between vascular endothelium cells and pericytes, which both are likely to be present in cluster 14!</p></li>
<li><p>The <em>CX3CR1</em> marker is specific for microglia. However, we do not seem to observe any cells that were identified as microglia by the original publication.</p></li>
<li><p>Last but not least, the authors have identified the rod cells as cells that do not express any of the aforementioned markers. As such, we are able to identify our <strong>clusters 12 and 17</strong> as <strong>rod cells</strong>.</p></li>
</ul>
</div>
<div id="supervised-using-marker-genes-detected-from-this-data" class="section level2">
<h2><span class="header-section-number">17.2</span> Supervised: Using marker genes detected from this data</h2>
<p>Sometimes it will be very difficult to set up a panel of known marker genes that would allow us to distinguish between all cell types in our dataset. For instance, sometimes we may not know in advance which cell types to expect, or we may not have good information on relevant markers (if the studied system is not well known).</p>
<p>An alternative strategy is to identify the genes that drive separation between clusters. These marker genes allow us to assign biological meaning to each cluster based on their functional annotation. This strategy is referred to as <strong>marker gene detection</strong>.</p>
<p>The most straightforward approach to marker gene detection involves testing for differential expression (DE) between clusters. If a gene is strongly DE between clusters, it is likely to have driven the separation of cells in the dimensionality reduction. The general strategy is to compare each pair of clusters and compute scores quantifying the differences in the expression distributions between clusters. The scores for all pairwise comparisons involving a particular cluster are then consolidated into a single data frame for that cluster. This approach is implemented in the <code>scoreMarkers</code> function of the <code>scran</code> package.</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1"></a><span class="kw">library</span>(scran)</span>
<span id="cb246-2"><a href="#cb246-2"></a>marker.info &lt;-<span class="st"> </span><span class="kw">scoreMarkers</span>(sce_<span class="dv">900</span>, </span>
<span id="cb246-3"><a href="#cb246-3"></a>                            sce_<span class="dv">900</span><span class="op">$</span>clust_hcl_k39)</span>
<span id="cb246-4"><a href="#cb246-4"></a>marker.info <span class="co"># one dataframe for each of the 39 clusters</span></span></code></pre></div>
<pre><code>## List of length 39
## names(39): 1 2 3 4 5 6 7 8 9 10 11 12 ... 28 29 30 31 32 33 34 35 36 37 38 39</code></pre>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1"></a><span class="kw">colnames</span>(marker.info[[<span class="st">&quot;1&quot;</span>]]) <span class="co"># statistics for cluster 1.</span></span></code></pre></div>
<pre><code>##  [1] &quot;self.average&quot;          &quot;other.average&quot;         &quot;self.detected&quot;        
##  [4] &quot;other.detected&quot;        &quot;mean.logFC.cohen&quot;      &quot;min.logFC.cohen&quot;      
##  [7] &quot;median.logFC.cohen&quot;    &quot;max.logFC.cohen&quot;       &quot;rank.logFC.cohen&quot;     
## [10] &quot;mean.AUC&quot;              &quot;min.AUC&quot;               &quot;median.AUC&quot;           
## [13] &quot;max.AUC&quot;               &quot;rank.AUC&quot;              &quot;mean.logFC.detected&quot;  
## [16] &quot;min.logFC.detected&quot;    &quot;median.logFC.detected&quot; &quot;max.logFC.detected&quot;   
## [19] &quot;rank.logFC.detected&quot;</code></pre>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1"></a><span class="kw">head</span>(marker.info[[<span class="st">&quot;1&quot;</span>]])</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 19 columns
##               self.average other.average self.detected other.detected
##                  &lt;numeric&gt;     &lt;numeric&gt;     &lt;numeric&gt;      &lt;numeric&gt;
## KITL             0.4798515   0.035488665     0.4173554    0.025644468
## TMTC3            0.0480443   0.075517912     0.0909091    0.072274768
## CEP290           0.2237387   0.640236382     0.2892562    0.386764446
## 4930430F08RIK    0.2112797   0.139696889     0.3223140    0.126230455
## 1700017N19RIK    0.0727844   0.000326469     0.0950413    0.000307741
## MGAT4C           0.2019885   0.115957416     0.2644628    0.098883750
##               mean.logFC.cohen min.logFC.cohen median.logFC.cohen
##                      &lt;numeric&gt;       &lt;numeric&gt;          &lt;numeric&gt;
## KITL                 0.8270156       -0.499824          0.8900032
## TMTC3               -0.0939661       -0.372466         -0.0703824
## CEP290              -0.5597464       -2.162262         -0.4787982
## 4930430F08RIK        0.1983805       -0.166161          0.1995006
## 1700017N19RIK        0.3608628        0.325612          0.3633424
## MGAT4C               0.3200703       -0.694604          0.4334344
##               max.logFC.cohen rank.logFC.cohen  mean.AUC   min.AUC median.AUC
##                     &lt;numeric&gt;        &lt;integer&gt; &lt;numeric&gt; &lt;numeric&gt;  &lt;numeric&gt;
## KITL                0.8941330               77  0.694597  0.375699   0.707467
## TMTC3               0.0551863             7966  0.507319  0.458087   0.512835
## CEP290              0.2531998             3408  0.412583  0.109099   0.424965
## 4930430F08RIK       0.6553654             1004  0.587322  0.466248   0.597490
## 1700017N19RIK       0.3633424              631  0.547362  0.545830   0.547521
## MGAT4C              0.6901370              349  0.576408  0.352774   0.596736
##                 max.AUC  rank.AUC mean.logFC.detected min.logFC.detected
##               &lt;numeric&gt; &lt;integer&gt;           &lt;numeric&gt;          &lt;numeric&gt;
## KITL           0.708678        97            5.082991          -0.463011
## TMTC3          0.530106      5063            0.462161          -0.840522
## CEP290         0.600016      2484           -0.189069          -1.534176
## 4930430F08RIK  0.645911       814            1.478203          -0.203561
## 1700017N19RIK  0.547521      1966            4.005010           1.945323
## MGAT4C         0.632231       509            2.783339          -0.842964
##               median.logFC.detected max.logFC.detected rank.logFC.detected
##                           &lt;numeric&gt;          &lt;numeric&gt;           &lt;integer&gt;
## KITL                       5.424163            6.67243                   7
## TMTC3                      0.533927            1.33498                3103
## CEP290                    -0.401871            1.88607                4062
## 4930430F08RIK              1.464793            3.31236                1265
## 1700017N19RIK              4.072430            4.58496                  71
## MGAT4C                     1.859965            6.02237                  46</code></pre>
<p>We observe several summary statistics for each gene in the dataframe for cluster 1. We highlight a few:</p>
<ul>
<li><p><code>self.average</code>: the average log-normalized expression of the gene in the target cluster (cluster 1)</p></li>
<li><p><code>other.average</code>: the average log-normalized expression of the gene in all the other clusters (clusters 2-39)</p></li>
<li><p><code>self.detected</code>: the fraction of cells in which the gene was expressed in the target cluster (cluster 1)</p></li>
<li><p><code>other.detected</code>: the fraction of cells in which the gene was expressed in all the other clusters (cluster 2-39)</p></li>
<li><p><code>mean.AUC</code>: From the <a href="http://bioconductor.org/books/3.14/OSCA.basic/marker-detection.html#effect-sizes-for-pairwise-comparisons">OSCA book chapter 6.3</a>: “In the context of marker detection, the area under the curve (AUC) quantifies our ability to distinguish between two distributions in a pairwise comparison. The AUC represents the probability that a randomly chosen observation from our cluster of interest is greater than a randomly chosen observation from the other cluster. A value of 1 corresponds to upregulation, where all values of our cluster of interest are greater than any value from the other cluster; a value of 0.5 means that there is no net difference in the location of the distributions; and a value of 0 corresponds to downregulation. The AUC is closely related to the U statistic in the Wilcoxon ranked sum test (a.k.a., Mann-Whitney U-test).” As such, this a very interesting column to use for selecting marker genes.</p></li>
</ul>
<p>Based on the <code>mean.AUC</code> statistic, we may now inspect the top10 markers to distinguish between cells of cluster 1 and cells of the other clusters:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1"></a>chosen &lt;-<span class="st"> </span>marker.info[[<span class="st">&quot;1&quot;</span>]]</span>
<span id="cb252-2"><a href="#cb252-2"></a>ordered &lt;-<span class="st"> </span>chosen[<span class="kw">order</span>(chosen<span class="op">$</span>mean.AUC, <span class="dt">decreasing=</span><span class="ot">TRUE</span>),]</span>
<span id="cb252-3"><a href="#cb252-3"></a><span class="kw">head</span>(ordered[,<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,<span class="dv">10</span>)],<span class="dt">n=</span><span class="dv">10</span>) <span class="co"># showing basic stats only, for brevity.</span></span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 5 columns
##         self.average other.average self.detected other.detected  mean.AUC
##            &lt;numeric&gt;     &lt;numeric&gt;     &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;
## NEFL         4.42252    0.18249591      0.995868     0.12567656  0.997444
## NEFM         3.58762    0.11875546      0.983471     0.08249728  0.989206
## SNCG         3.06554    0.04148141      0.979339     0.03209654  0.988398
## STMN2        3.13135    0.39418823      0.991736     0.22631276  0.977709
## THY1         2.52283    0.15867796      0.954545     0.12517930  0.967995
## NRN1         1.80861    0.00529365      0.909091     0.00474391  0.953644
## STMN3        2.79576    0.78340619      0.979339     0.47329027  0.948466
## SLC17A6      1.95508    0.01211911      0.896694     0.00932919  0.946487
## UCHL1        2.74023    0.60916713      0.971074     0.37735209  0.945737
## YWHAH        2.33409    0.48955157      0.958678     0.34886757  0.933976</code></pre>
<p>We can also visualize the log-normalized expression of the top10 markers in each cell, stratified on cluster label, using the <code>plotExpression</code> function of the <code>scater</code> package:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1"></a><span class="kw">library</span>(scater)</span>
<span id="cb254-2"><a href="#cb254-2"></a><span class="kw">plotExpression</span>(sce_<span class="dv">900</span>, </span>
<span id="cb254-3"><a href="#cb254-3"></a>               <span class="dt">features=</span><span class="kw">head</span>(<span class="kw">rownames</span>(ordered),<span class="dt">n=</span><span class="dv">10</span>), </span>
<span id="cb254-4"><a href="#cb254-4"></a>               <span class="dt">x=</span><span class="st">&quot;clust_hcl_k39&quot;</span>, </span>
<span id="cb254-5"><a href="#cb254-5"></a>               <span class="dt">colour_by=</span><span class="st">&quot;clust_hcl_k39&quot;</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-84-1.png" width="672" /></p>
<p>Two genes pop up as extremely interesting for using as markers specific for cluster 1: <em>NRN1</em> and <em>SLC17A6</em>. These markers are highly expressed in cluster 1, but have almost no expression in any of the other clusters.</p>
<p>Interestingly, <em>SLC17A6</em> is exactly the marker the original authors have used as a specific marker for ganglion cells! Note that if we would not know the system under study, i.e. we were unable to select the <em>SLC17A6</em> marker based on our prior biological knowledge, we would have successfully identified the marker using this strategy. In a next step, we could perform an internet search to see if this marker is known or not.</p>
<p>For the record, <em>NRN1</em> also is a known marker for identifying ganglion cells.</p>
</div>
<div id="semi-supervised-using-singler" class="section level2">
<h2><span class="header-section-number">17.3</span> Semi-supervised using SingleR</h2>
<p>A conceptually straightforward annotation approach is to compare our current scRNA-seq dataset with a previously annotated reference dataset. Labels can then be assigned to each cell in the Macosko dataset based on the most similar reference cells, for some definition of “similar”. This is a standard classification challenge that can be tackled by standard machine learning techniques such as random forests and support vector machines. Any published and labeled RNA-seq dataset (bulk or single-cell) can be used as a reference, though its reliability depends greatly on the expertise of the original authors who assigned the labels in the first place and the closer the reference dataset is to the dataset we would like to annotate (e.g., full-length vs UMI-based protocol), the more accurate the annotation will typically be.</p>
<p>In this section, we will perform such label transfer between the annotated reference dataset from <a href="https://doi.org/10.1016/j.cell.2016.07.054">Shekhar et al.</a>, which also is a scRNA-seq dataset that studied the mouse retina, and the Macosko dataset.</p>
<p>To perform the actual label transfer, will use the <code>SingleR</code> Bioconductor package. For each “test” cell in the Macosko dataset, <code>SingleR</code> will:</p>
<ol style="list-style-type: decimal">
<li><p>Compute Spearman correlation between the test cell and each reference cell. To improve signal/noise, only marker genes identified using the reference dataset are used for this.</p></li>
<li><p>For each label (cell type), set the score as the (default of) 80% quantile of Spearman correlations.</p></li>
<li><p>The prediction is then the label with the highest score.</p></li>
</ol>
<p>Before we can use <code>singleR</code> to perform label transfer, we will need to import, explore (brief) and wrangle the reference dataset by Shekhar <em>et al.</em>.</p>
<div id="import-reference-data" class="section level3">
<h3><span class="header-section-number">17.3.1</span> Import reference data</h3>
<p>The dataset by Shekhar <em>et al.</em> can be conveniently imported using the <code>scRNAseq</code> package.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb255-2"><a href="#cb255-2"></a>(ref.data &lt;-<span class="st"> </span>scRNAseq<span class="op">::</span><span class="kw">ShekharRetinaData</span>(<span class="dt">ensembl =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 22947 44994 
## metadata(0):
## assays(1): counts
## rownames(22947): ENSMUSG00000109644 ENSMUSG00000007777 ...
##   ENSMUSG00000064618 ENSMUSG00000064508
## rowData names(1): originalName
## colnames(44994): Bipolar1_CCCACAAGACTA Bipolar1_TCGCCTCGTAAG ...
##   Bipolar6_GAAGAATGCGCT Bipolar6_GGCAACACGATA
## colData names(3): NAME CLUSTER SUB-CLUSTER
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
</div>
<div id="explore-metadata-of-reference-data" class="section level3">
<h3><span class="header-section-number">17.3.2</span> Explore metadata of reference data</h3>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1"></a><span class="kw">head</span>(<span class="kw">colData</span>(ref.data))</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 3 columns
##                                        NAME                CLUSTER
##                                 &lt;character&gt;            &lt;character&gt;
## Bipolar1_CCCACAAGACTA Bipolar1_CCCACAAGACTA                   BC5D
## Bipolar1_TCGCCTCGTAAG Bipolar1_TCGCCTCGTAAG  Doublets/Contaminants
## Bipolar1_CAAAGCATTTGC Bipolar1_CAAAGCATTTGC                    BC6
## Bipolar1_CTTTTGATTGAC Bipolar1_CTTTTGATTGAC BC7 (Cone Bipolar ce..
## Bipolar1_GCTCCAATGACA Bipolar1_GCTCCAATGACA RBC (Rod Bipolar cell)
## Bipolar1_AAATACCCTCAT Bipolar1_AAATACCCTCAT BC5A (Cone Bipolar c..
##                                  SUB-CLUSTER
##                                  &lt;character&gt;
## Bipolar1_CCCACAAGACTA                   BC5D
## Bipolar1_TCGCCTCGTAAG  Doublets/Contaminants
## Bipolar1_CAAAGCATTTGC                    BC6
## Bipolar1_CTTTTGATTGAC BC7 (Cone Bipolar ce..
## Bipolar1_GCTCCAATGACA RBC (Rod Bipolar cell)
## Bipolar1_AAATACCCTCAT BC5A (Cone Bipolar c..</code></pre>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1"></a><span class="kw">levels</span>(<span class="kw">as.factor</span>(ref.data<span class="op">$</span>CLUSTER))</span></code></pre></div>
<pre><code>##  [1] &quot;AC (Amacrine cell)&quot;             &quot;BC1A&quot;                          
##  [3] &quot;BC1B&quot;                           &quot;BC2&quot;                           
##  [5] &quot;BC3A&quot;                           &quot;BC3B&quot;                          
##  [7] &quot;BC4&quot;                            &quot;BC5A (Cone Bipolar cell 5A)&quot;   
##  [9] &quot;BC5B&quot;                           &quot;BC5C&quot;                          
## [11] &quot;BC5D&quot;                           &quot;BC6&quot;                           
## [13] &quot;BC7 (Cone Bipolar cell 7)&quot;      &quot;BC8/9 (mixture of BC8 and BC9)&quot;
## [15] &quot;Cone Photoreceptors&quot;            &quot;Doublets/Contaminants&quot;         
## [17] &quot;MG (Mueller Glia)&quot;              &quot;RBC (Rod Bipolar cell)&quot;        
## [19] &quot;Rod Photoreceptors&quot;</code></pre>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1"></a><span class="kw">levels</span>(<span class="kw">as.factor</span>(ref.data<span class="op">$</span><span class="st">`</span><span class="dt">SUB-CLUSTER</span><span class="st">`</span>))</span></code></pre></div>
<pre><code>##  [1] &quot;AC (Amacrine cell)&quot;             &quot;BC1A&quot;                          
##  [3] &quot;BC1B&quot;                           &quot;BC2&quot;                           
##  [5] &quot;BC3A&quot;                           &quot;BC3B&quot;                          
##  [7] &quot;BC4&quot;                            &quot;BC5A (Cone Bipolar cell 5A)&quot;   
##  [9] &quot;BC5B&quot;                           &quot;BC5C&quot;                          
## [11] &quot;BC5D&quot;                           &quot;BC6&quot;                           
## [13] &quot;BC7 (Cone Bipolar cell 7)&quot;      &quot;BC8/9 (mixture of BC8 and BC9)&quot;
## [15] &quot;Cone Photoreceptors&quot;            &quot;Doublets/Contaminants&quot;         
## [17] &quot;MG (Mueller Glia)&quot;              &quot;RBC (Rod Bipolar cell)&quot;        
## [19] &quot;Rod Photoreceptors&quot;</code></pre>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1"></a><span class="co"># both have exactly the same info...</span></span>
<span id="cb263-2"><a href="#cb263-2"></a><span class="kw">all</span>(ref.data<span class="op">$</span><span class="st">`</span><span class="dt">SUB-CLUSTER</span><span class="st">`</span> <span class="op">==</span><span class="st"> </span>ref.data<span class="op">$</span>CLUSTER, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="process-reference-data" class="section level3">
<h3><span class="header-section-number">17.3.3</span> Process reference data</h3>
<ol style="list-style-type: decimal">
<li>Remove unlabeled cells</li>
</ol>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1"></a><span class="kw">sum</span>(<span class="kw">is.na</span>(ref.data<span class="op">$</span>CLUSTER))</span></code></pre></div>
<pre><code>## [1] 17495</code></pre>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1"></a>ref.data &lt;-<span class="st"> </span>ref.data[,<span class="op">-</span><span class="kw">which</span>(<span class="kw">is.na</span>(ref.data<span class="op">$</span>CLUSTER))]</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Remove doublets/contaminant cells</li>
</ol>
<p>The original authors already performed quality control; we have cells with cluster label “Doublets/Contaminants”. Let’s remove those:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1"></a><span class="kw">sum</span>(ref.data<span class="op">$</span>CLUSTER <span class="op">==</span><span class="st"> &quot;Doublets/Contaminants&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 669</code></pre>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1"></a>ref.data &lt;-<span class="st"> </span>ref.data[,<span class="op">-</span><span class="kw">which</span>(ref.data<span class="op">$</span>CLUSTER <span class="op">==</span><span class="st"> &quot;Doublets/Contaminants&quot;</span>)]</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Make lower resolution cell type levels (for easier interpretation)</li>
</ol>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1"></a>ref.data<span class="op">$</span>CLUSTER_lowRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(ref.data<span class="op">$</span>CLUSTER, </span>
<span id="cb271-2"><a href="#cb271-2"></a>           <span class="st">&quot;Amacrine_cells&quot;</span> =<span class="st"> &quot;AC (Amacrine cell)&quot;</span>,</span>
<span id="cb271-3"><a href="#cb271-3"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC1A&quot;</span>,</span>
<span id="cb271-4"><a href="#cb271-4"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC1B&quot;</span>,</span>
<span id="cb271-5"><a href="#cb271-5"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC2&quot;</span>,</span>
<span id="cb271-6"><a href="#cb271-6"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC3A&quot;</span>,</span>
<span id="cb271-7"><a href="#cb271-7"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC3B&quot;</span>,</span>
<span id="cb271-8"><a href="#cb271-8"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC4&quot;</span>,</span>
<span id="cb271-9"><a href="#cb271-9"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5A (Cone Bipolar cell 5A)&quot;</span>,</span>
<span id="cb271-10"><a href="#cb271-10"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5B&quot;</span>,</span>
<span id="cb271-11"><a href="#cb271-11"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5C&quot;</span>,</span>
<span id="cb271-12"><a href="#cb271-12"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5D&quot;</span>,</span>
<span id="cb271-13"><a href="#cb271-13"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC6&quot;</span>,</span>
<span id="cb271-14"><a href="#cb271-14"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC7 (Cone Bipolar cell 7)&quot;</span>,</span>
<span id="cb271-15"><a href="#cb271-15"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC8/9 (mixture of BC8 and BC9)&quot;</span>,</span>
<span id="cb271-16"><a href="#cb271-16"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;Cone Photoreceptors&quot;</span>,</span>
<span id="cb271-17"><a href="#cb271-17"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;MG (Mueller Glia)&quot;</span>,</span>
<span id="cb271-18"><a href="#cb271-18"></a>           <span class="st">&quot;Rod_Bipolar_cell&quot;</span> =<span class="st"> &quot;RBC (Rod Bipolar cell)&quot;</span>,</span>
<span id="cb271-19"><a href="#cb271-19"></a>           <span class="st">&quot;Rod Photoreceptors&quot;</span> =<span class="st"> &quot;Rod Photoreceptors&quot;</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Remove lowly expressed genes</li>
</ol>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1"></a>keep &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">assays</span>(ref.data)<span class="op">$</span>counts <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb272-2"><a href="#cb272-2"></a><span class="kw">table</span>(keep)</span></code></pre></div>
<pre><code>## keep
## FALSE  TRUE 
##  7599 15348</code></pre>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1"></a>ref.data &lt;-<span class="st"> </span>ref.data[keep,]</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Obtain same gene ID format as in target data</li>
</ol>
<p>To avoid problems with different version of gene symbols, it is good practice do work with unambiguous gene identifiers like those of ENSEMBL instead.</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1"></a><span class="kw">rownames</span>(sce_<span class="dv">900</span>) &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce_<span class="dv">900</span>)<span class="op">$</span>ensembl_gene_id <span class="co"># use ENSEMBL identifiers instead</span></span>
<span id="cb275-2"><a href="#cb275-2"></a><span class="kw">sum</span>(<span class="kw">rownames</span>(sce_<span class="dv">900</span>) <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(ref.data))</span></code></pre></div>
<pre><code>## [1] 14520</code></pre>
<ol start="6" style="list-style-type: decimal">
<li>Compute <code>logNormCounts</code></li>
</ol>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1"></a><span class="kw">library</span>(scuttle)</span>
<span id="cb277-2"><a href="#cb277-2"></a>ref.data &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(ref.data)</span></code></pre></div>
</div>
<div id="singler-at-low-reference-resolution" class="section level3">
<h3><span class="header-section-number">17.3.4</span> <code>SingleR</code> at low reference resolution</h3>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1"></a><span class="co">#BiocManager::install(&quot;SingleR&quot;)</span></span>
<span id="cb278-2"><a href="#cb278-2"></a><span class="kw">library</span>(SingleR)</span>
<span id="cb278-3"><a href="#cb278-3"></a></span>
<span id="cb278-4"><a href="#cb278-4"></a><span class="co"># runs 2min 30sec for me</span></span>
<span id="cb278-5"><a href="#cb278-5"></a>pred.lowRes &lt;-<span class="st"> </span><span class="kw">SingleR</span>(<span class="dt">test =</span> sce_<span class="dv">900</span>, </span>
<span id="cb278-6"><a href="#cb278-6"></a>                     <span class="dt">ref =</span> ref.data, </span>
<span id="cb278-7"><a href="#cb278-7"></a>                     <span class="dt">labels =</span> ref.data<span class="op">$</span>CLUSTER_lowRes, </span>
<span id="cb278-8"><a href="#cb278-8"></a>                     <span class="dt">de.method =</span> <span class="st">&quot;wilcox&quot;</span>)</span>
<span id="cb278-9"><a href="#cb278-9"></a><span class="kw">table</span>(pred.lowRes<span class="op">$</span>labels)</span></code></pre></div>
<pre><code>## 
##     Amacrine_cells      Bipolar_cells              Cones        Muller_glia 
##               2854               1588                418                768 
## Rod Photoreceptors   Rod_Bipolar_cell 
##               3042               1168</code></pre>
<p>Using the <code>SingleR</code> classifier that was trained on the reference dataset by Shekhar <em>et al.</em>, we have labeled 2731 cells from the Macosko dataset as amacrine cells, 1528 cells as bipolar cells, and so on. Again note that we predicted a label for each cell in the Macosko dataset based its similarity (in gene expression) with labeled cells from the Shekhar dataset.</p>
<p><strong>Most importantly,</strong> we want to compare our predicted cell labels with the labels that were obtained by Macokso <em>et al.</em>, which we <em>could</em> consider to be ground truth labels if we assume that the authors succeeded in their large effort of annotating their cell clusters for their publication.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1"></a>tab &lt;-<span class="st"> </span><span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes, pred.lowRes<span class="op">$</span>labels)</span>
<span id="cb280-2"><a href="#cb280-2"></a>tab</span></code></pre></div>
<pre><code>##                       
##                        Amacrine_cells Bipolar_cells Cones Muller_glia
##   Horizontal_cells                135             0     0           0
##   Ganglion_cells                  227             0     0           0
##   Amacrine                       2167             8     1           1
##   Rods                              9             4     1           0
##   Cones                             0             0   308           0
##   Bipolar                          10          1275     1           1
##   Muller_glia                       0             0     0         572
##   Astrocytes                        0             0     0          16
##   Fibroblast                        0             0     0          19
##   Vascular_endothelium             23             1     0          88
##   Pericytes                         6             1     1          11
##   Microglia                         0             0     1           9
##                       
##                        Rod Photoreceptors Rod_Bipolar_cell
##   Horizontal_cells                      1                0
##   Ganglion_cells                        0                0
##   Amacrine                            204                1
##   Rods                               1508                1
##   Cones                               499                0
##   Bipolar                             233              949
##   Muller_glia                           3                0
##   Astrocytes                            0                0
##   Fibroblast                            0                0
##   Vascular_endothelium                 12                0
##   Pericytes                             6                0
##   Microglia                             2                0</code></pre>
<p>By the naked eye, we immediately observe a strong correspondence between our predicted labels and the labels from the original publication (i.e., most amacrine cells being predicted as amacrine cells, most bipolar cells being predicted as bipolar cells, and so on). Before we dive deeper into this, we may visualize our result using a heatmap:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(tab <span class="op">/</span><span class="st"> </span><span class="kw">rowSums</span>(tab))</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-97-1.png" width="672" /></p>
<p>where we also can observe the correspondence between the predicted (x-axis) and the original (y-axis) labels. Note that we have normalized the values in the heatmap for each row, so that the coloring of the cells in the matrix can be interpreted as the fraction of the original cell types that got assigned to each of the reference categories (e.g. for row 1, 80-90% of the cells got predicted as amacrine cells and the remaining 10% got predicted as rod photoreceptors).</p>
<p>One other visualization strategy is implemented in the <code>plotScoreHeatmap</code> of the <code>SingleR</code> package. Remember, the <code>SingleR</code> classifier assigns each target cell to a cell type label <strong>with a certain probability</strong>. The <code>plotScoreHeatmap</code> function then allows you to plot, for each cell (columns) the assignment score (which can be thought of as a probability) of that cell belonging to each of the reference label categories (rows).</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1"></a>gg &lt;-<span class="st"> </span><span class="kw">plotScoreHeatmap</span>(pred.lowRes[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>,])</span>
<span id="cb283-2"><a href="#cb283-2"></a>gg</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-98-1.png" width="672" /></p>
<p>For instance, when we look at the 20th cell (rightmost column), we see that this cell was labeled as a rod photoreceptor. This is because this was the label that was assigned to the cell with highest assignment score. We also see that the second most likely label for this cell is cones.</p>
<p>Finally, we can use these assignment score to filter out cells that could not be unambiguously assigned to one cell type, i.e., only report those cells that we were able to reliably assign:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1"></a><span class="kw">summary</span>(<span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels))</span></code></pre></div>
<pre><code>##    Mode   FALSE    TRUE 
## logical    9020     818</code></pre>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1"></a><span class="kw">range</span>(<span class="kw">rowMaxs</span>(pred.lowRes<span class="op">$</span>scores)) <span class="co"># all assignments</span></span></code></pre></div>
<pre><code>## [1] 0.1713326 0.8309885</code></pre>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1"></a><span class="kw">range</span>(<span class="kw">rowMaxs</span>(pred.lowRes<span class="op">$</span>scores[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels),])) <span class="co"># reliable assignments</span></span></code></pre></div>
<pre><code>## [1] 0.2766630 0.8309885</code></pre>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1"></a><span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels)], </span>
<span id="cb290-2"><a href="#cb290-2"></a>      pred.lowRes<span class="op">$</span>labels[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels)])</span></code></pre></div>
<pre><code>##                       
##                        Amacrine_cells Bipolar_cells Cones Muller_glia
##   Horizontal_cells                134             0     0           0
##   Ganglion_cells                  227             0     0           0
##   Amacrine                       2142             8     0           1
##   Rods                              6             4     1           0
##   Cones                             0             0   303           0
##   Bipolar                           7          1275     0           1
##   Muller_glia                       0             0     0         569
##   Astrocytes                        0             0     0          14
##   Fibroblast                        0             0     0          15
##   Vascular_endothelium              3             1     0           0
##   Pericytes                         0             1     0           0
##   Microglia                         0             0     1           0
##                       
##                        Rod Photoreceptors Rod_Bipolar_cell
##   Horizontal_cells                      0                0
##   Ganglion_cells                        0                0
##   Amacrine                             60                0
##   Rods                               1486                0
##   Cones                               496                0
##   Bipolar                              52              865
##   Muller_glia                           3                0
##   Astrocytes                            0                0
##   Fibroblast                            0                0
##   Vascular_endothelium                  1                0
##   Pericytes                             0                0
##   Microglia                             0                0</code></pre>
<p>We will interpret the concordance between the predicted and the original labels on this subset. We observe a strong correspondence between the predicted labels and the labels from Macokso <em>et al.</em> We can read this table as follows:</p>
<ul>
<li><p>Almost all amacrine cells of the Macosko dataset are correctly predicted as amacrine cells (2036/(2036+7+1+41+1) ±= 98% correctly assigned).</p></li>
<li><p>All horizontal cells and all ganglion cells of the Macosko dataset are predicted as amacrine cells. This makes perfect sense. Since the reference dataset did not contain horizontal/ganglion cell labels, it is impossible to label the target cells with these labels. In stead, the cells were labeled as the cell type that is most closely related to horizontal/ ganglion cells; the amacrine cell type (see figure 5D).</p></li>
<li><p>Most of the bipolar cells of the Macosko dataset were either predicted as bipolar cells or as rod bipolar cells. The authors of the Macosko paper were not able (in their low-resolution labeling) to distinguish between these two subtypes of bipolar cells, but we succeeded in doing this (although we should in principle need to double-check with markers whether this is a true biological signal and not some spurious effect).</p></li>
<li><p>44% (279/(279+354)) of the cones in the Macosko dataset are correctly labeled as cones. The remaining 56% of the cells were labeled as rods. This means that either the <code>SingleR</code> classifier wrongfully labeled these cones as rods, or the original authors mislabeled these rods as cones. Since we do not really have a ground truth here, the best idea is to check this using known markers to distinguish between rods and cones.</p></li>
<li><p>Almost all Muller glia cells of the Macosko dataset are correctly predicted as Muller glia cells (569/(569+2) ±= 100% correctly assigned). In addition, most of the astrocytes, fibroblast, vascular endothelium, pericytes and microglia cells also got labeled as Muller glia cells. This makes perfect sense. Since the reference dataset did not contain these cell labels, it was impossible to label the target cells with these labels. In stead, the cells were labeled as the cell type that is most closely related; the Muller glia cell type (see figure 5D).</p></li>
<li><p>Almost all rod cells of the Macosko dataset are correctly predicted as rod cells (1834/(1834+6+4+1) ±= 99% correctly assigned).</p></li>
</ul>
<p>We can now also visualize the predicted labels and the original labels on our t-SNE.</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1"></a>sce_<span class="dv">900</span><span class="op">$</span>SingleR_lowRes &lt;-<span class="st"> </span>pred.lowRes<span class="op">$</span>labels</span>
<span id="cb292-2"><a href="#cb292-2"></a></span>
<span id="cb292-3"><a href="#cb292-3"></a><span class="co"># our low resolution labels based on reference</span></span>
<span id="cb292-4"><a href="#cb292-4"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb292-5"><a href="#cb292-5"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;SingleR_lowRes&quot;</span>,</span>
<span id="cb292-6"><a href="#cb292-6"></a>         <span class="dt">text_by =</span> <span class="st">&quot;SingleR_lowRes&quot;</span>,</span>
<span id="cb292-7"><a href="#cb292-7"></a>         <span class="dt">text_size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-100-1.png" width="672" /></p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1"></a><span class="co"># low resolution labels of the authors</span></span>
<span id="cb293-2"><a href="#cb293-2"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb293-3"><a href="#cb293-3"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>,</span>
<span id="cb293-4"><a href="#cb293-4"></a>         <span class="dt">text_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>,</span>
<span id="cb293-5"><a href="#cb293-5"></a>         <span class="dt">text_size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="lab3_MacoskoWorkflow_files/figure-html/unnamed-chunk-100-2.png" width="672" /></p>
<p>Comparing these two figures, we come to the same conclusion as above based on the table comparison.</p>
<p>We see how some cells our classifier labeld more clusters as rods. Based on the marker results from the first section of cell annotation, we known that our classifier as misclassified these (i.e., the original labels are correct).</p>
<p>On the other hand, we were here nicely able to distinguish between bipolar cells and rod bipolar cells, which cluster separately.</p>
<p><strong>Altogether, label-transfer was quite successful, and we would have been able</strong> <strong>to very quickly get high-quality results using this very user-friendly and</strong> <strong>fast approach implemented in the <code>SingleR</code> package.</strong></p>
</div>
<div id="addendum-singler-at-high-reference-resolution" class="section level3">
<h3><span class="header-section-number">17.3.5</span> Addendum: <code>SingleR</code> at high reference resolution</h3>
<p>For the sake of completeness, we may also perform label transfer with <code>SingleR</code> using the more fine-grained labels from the reference dataset.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1"></a><span class="co"># Runs 3min 30sec for me</span></span>
<span id="cb294-2"><a href="#cb294-2"></a>pred.higRes &lt;-<span class="st"> </span><span class="kw">SingleR</span>(<span class="dt">test =</span> sce_<span class="dv">900</span>, </span>
<span id="cb294-3"><a href="#cb294-3"></a>                     <span class="dt">ref =</span> ref.data, </span>
<span id="cb294-4"><a href="#cb294-4"></a>                     <span class="dt">labels =</span> ref.data<span class="op">$</span>CLUSTER, </span>
<span id="cb294-5"><a href="#cb294-5"></a>                     <span class="dt">de.method =</span> <span class="st">&quot;wilcox&quot;</span>)</span>
<span id="cb294-6"><a href="#cb294-6"></a><span class="kw">table</span>(pred.higRes<span class="op">$</span>labels)</span></code></pre></div>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1"></a><span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes, pred.higRes<span class="op">$</span>labels)</span></code></pre></div>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes, pred.higRes<span class="op">$</span>labels))</span></code></pre></div>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1"></a>gg &lt;-<span class="st"> </span><span class="kw">plotScoreHeatmap</span>(pred.higRes[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>,])</span></code></pre></div>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="#cb298-1"></a><span class="co"># low certainty labels: 751</span></span>
<span id="cb298-2"><a href="#cb298-2"></a><span class="kw">summary</span>(<span class="kw">is.na</span>(pred.higRes<span class="op">$</span>pruned.labels))</span>
<span id="cb298-3"><a href="#cb298-3"></a><span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes[<span class="op">!</span><span class="kw">is.na</span>(pred.higRes<span class="op">$</span>pruned.labels)], </span>
<span id="cb298-4"><a href="#cb298-4"></a>      pred.higRes<span class="op">$</span>labels[<span class="op">!</span><span class="kw">is.na</span>(pred.higRes<span class="op">$</span>pruned.labels)])</span></code></pre></div>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1"></a>sce_<span class="dv">900</span><span class="op">$</span>SingleR_highRes &lt;-<span class="st"> </span>pred.higRes<span class="op">$</span>labels</span>
<span id="cb299-2"><a href="#cb299-2"></a></span>
<span id="cb299-3"><a href="#cb299-3"></a><span class="co"># our high resolution labels based on reference</span></span>
<span id="cb299-4"><a href="#cb299-4"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb299-5"><a href="#cb299-5"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;SingleR_highRes&quot;</span>,</span>
<span id="cb299-6"><a href="#cb299-6"></a>         <span class="dt">text_by =</span> <span class="st">&quot;SingleR_highRes&quot;</span>,</span>
<span id="cb299-7"><a href="#cb299-7"></a>         <span class="dt">text_size =</span> <span class="fl">2.5</span>)</span>
<span id="cb299-8"><a href="#cb299-8"></a></span>
<span id="cb299-9"><a href="#cb299-9"></a></span>
<span id="cb299-10"><a href="#cb299-10"></a><span class="co"># high resolution labels of the authors</span></span>
<span id="cb299-11"><a href="#cb299-11"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb299-12"><a href="#cb299-12"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster_highRes&quot;</span>,</span>
<span id="cb299-13"><a href="#cb299-13"></a>         <span class="dt">text_by =</span> <span class="st">&quot;cluster_highRes&quot;</span>,</span>
<span id="cb299-14"><a href="#cb299-14"></a>         <span class="dt">text_size =</span> <span class="fl">2.5</span>)</span></code></pre></div>
</div>
</div>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAnTGFiMzogQ2x1c3RlcmluZywgY2VsbCB0eXBlIGFubm90YXRpb24sIGRpZmZlcmVudGlhbCBleHByZXNzaW9uJwphdXRob3I6ICJLb2VuIFZhbiBkZW4gQmVyZ2UgYW5kIEplcm9lbiBHaWxpcyIKZGF0ZTogIjYvMTIvMjAyMSIKb3V0cHV0OiAKICBodG1sX2RvY3VtZW50OgogICAgZG93bmxvYWQ6IHRydWUKICAgIHRvYzogdHJ1ZQogICAgdG9jX2Zsb2F0OiB0cnVlCi0tLQoKIyBQcmVhbWJsZTogaW5zdGFsbGF0aW9uIG9mIEJpb2NvbmR1Y3RvciBsaWJyYXJpZXMKCmBgYHtyfQojIGluc3RhbGwgQmlvY01hbmFnZXIgcGFja2FnZSBpZiBub3QgaW5zdGFsbGVkIHlldC4KIyBCaW9jTWFuYWdlciBpcyB0aGUgcGFja2FnZSBpbnN0YWxsZXIgZm9yIEJpb2NvbmR1Y3RvciBzb2Z0d2FyZS4KaWYgKCFyZXF1aXJlTmFtZXNwYWNlKCJCaW9jTWFuYWdlciIsIHF1aWV0bHkgPSBUUlVFKSkKICAgIGluc3RhbGwucGFja2FnZXMoIkJpb2NNYW5hZ2VyIikKCiMgaW5zdGFsbCBwYWNrYWdlcyBpZiBub3QgeWV0IGluc3RhbGxlZC4KcGtncyA8LSBjKCJTaW5nbGVDZWxsRXhwZXJpbWVudCIsCiAgICAgICAgICAiRXhwZXJpbWVudEh1YiIsCiAgICAgICAgICAiZWRnZVIiLAogICAgICAgICAgImJpb21hUnQiLAogICAgICAgICAgIkRyb3BsZXRVdGlscyIsIAogICAgICAgICAgInNjUk5Bc2VxIiwgCiAgICAgICAgICAic2NhdGVyIiwgCiAgICAgICAgICAic2N1dHRsZSIsIAogICAgICAgICAgInNjcmFuIiwKICAgICAgICAgICJzY3J5IiwKICAgICAgICAgICJCaW9jU2luZ3VsYXIiLCAKICAgICAgICAgICJzY0RibEZpbmRlciIsCiAgICAgICAgICAiU2V1cmF0IiwKICAgICAgICAgICJQQ0F0b29scyIsCiAgICAgICAgICAiZ2xtcGNhIiwKICAgICAgICAgICJnZW5lZmlsdGVyIiwKICAgICAgICAgICJwaGVhdG1hcCIsCiAgICAgICAgICAidGlkeXZlcnNlIiwKICAgICAgICAgICJtY2x1c3QiLAogICAgICAgICAgImdncGxvdDIiLAogICAgICAgICAgIlNpbmdsZVIiKQpub3RJbnN0YWxsZWQgPC0gcGtnc1shcGtncyAlaW4lIGluc3RhbGxlZC5wYWNrYWdlcygpWywxXV0KaWYobGVuZ3RoKG5vdEluc3RhbGxlZCkgPiAwKXsKICBCaW9jTWFuYWdlcjo6aW5zdGFsbChub3RJbnN0YWxsZWQpCn0KYGBgCgpTdGVwcyB0YWtlbiBpbiBmaXJzdCB0d28gbGFiIHNlc3Npb25zOgoKMS4gSW1wb3J0IHRoZSBNYWNvc2tvIGRhdGFzZXQgYXMgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QgZnJvbSB0aGUgCmBzY1JOQXNlcWAgQmlvY29uZHVjdG9yIHBhY2thZ2UuCgoyLiBJbmNsdWRlIEVOU0VNQkwgZ2VuZSBpZGVudGlmaWVycyBpbiB0aGUgYHJvd0RhdGFgCgozLiBSZW1vdmUgdmVyeSBsb3dseSBleHByZXNzZWQgZ2VuZXMKCjQuIFJlbW92ZSBsb3cgcXVhbGl0eSBjZWxscyAKICA0LjEuIENlbGxzIHdpdGggb3V0bHlpbmcgbGlicmFyeSBzaXplIAogIDQuMi4gQ2VsbHMgd2l0aCBvdXRseWluZyB0cmFuc2NyaXB0b21lIGNvbXBsZXhpdHkgCiAgNC4zLiBDZWxscyB3aXRoIG91dGx5aW5nIHBlcmNlbnRhZ2Ugb2YgbWl0b2Nob25kcmlhbCByZWFkcyAKICA0LjQuIEVtcHR5IGRyb3BsZXRzIAogIDQuNS4gRG91YmxldHMKCjUuIE5vcm1hbGl6YXRpb24gCiAgNS4xLiBDb21wdXRlIGxvZy1ub3JtYWxpemVkIGNvdW50cyAKICA1LjIuIENvbXB1dGUgc2NhbGluZyBmYWN0b3IgdG8gY29ycmVjdCBmb3IgZGlmZmVyZW5jZXMgaW4gbGlicmFyeSBzaXplCgo2LiBGZWF0dXJlIHNlbGVjdGlvbiAKICA2LjEuIEdlbmVzIHdpdGggaGlnaCB2YXJpYW5jZSAKICA2LjIuIEdlbmVzIHdpdGggaGlnaCB2YXJpYW5jZSB3aXRoIHJlc3BlY3QgdG8gdGhlaXIgbWVhbiBleHByZXNzaW9uIAogIDYuMy4gR2VuZXMgd2l0aCBoaWdoIGRldmlhbmNlIAogIDYuNC4gR2VuZXMgd2l0aCBoaWdoIHZhcmlhbmNlIGFmdGVyIHZhcmlhbmNlLXN0YWJpbGl6aW5nIHRyYW5zZm9ybWF0aW9uIChWU1QpCgo3LiBEaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gCiAgNy4xLiBCYXNlZCBvbiB0d28gbW9zdCB2YXJpYWJsZSBnZW5lcyBmcm9tIHN0ZXAgNi4yLiAKICA3LjIuIFBDQSAKICA3LjMuIEdMTS1QQ0EgCiAgNy40LiBULVNORSAKICA3LjUuIFVNQVAKCiMgVGhlIE1hY29za28gZGF0YXNldAoKSW4gdGhpcyB3b3Jrc2hvcCBzZXNzaW9uLCB3ZSB3aWxsIGFuYWx5emUgdGhlIHNpbmdsZS1jZWxsIFJOQS1zZXEgZGF0YXNldApmcm9tIHRoZSBwdWJsaWNhdGlvbiBieSBNYWNvc2tvICpldCBhbC4qLCBDZWxsIDE2MSwgMTIwMuKAkzEyMTQgZnJvbSAyMDE1ClsobGluayldKGh0dHBzOi8vZG9pLm9yZy8xMC4xMDE2L2ouY2VsbC4yMDE1LjA1LjAwMikuIFRoaXMgaXMgdGhlIG1hbnVzY3JpcHQgaW4Kd2hpY2ggdGhlIGRyb3BsZXQgc2NSTkEtc2VxIHRlY2hub2xvZ3kgKipEcm9wLXNlcSoqIHdhcyBpbnRyb2R1Y2VkLgpTaXggeWVhcnMgYWZ0ZXIgdGhlIG9yaWdpbmFsIHB1YmxpY2F0aW9uLCBkcm9wLXNlcSBpcyBzdGlsbCBvbmUgb2YgdGhlIG1vc3QgCmNvbW1vbmx5IGFkb3B0ZWQgc2NSTkEtc2VxIHByb3RvY29scywgYXMgZXZpZGVuY2VkIGJ5IHRoZQpsYXJnZSBudW1iZXIgb2YgY2l0YXRpb25zIGZvciBNYWNvc2tvICpldCBhbC4qIAooNC4zMDMgY2l0YXRpb25zIGF0IE5vdmVtYmVyIDMsIDIwMjEpLgoKVGhlIGJhc2ljIGlkZWEgYmVoaW5kIHRoZSBEcm9wLXNlcSBwcm90b2NvbCBjYW4gYmUgdGFrZW4gZnJvbSB0aGUgZ3JhcGhpY2FsCmFic3RyYWN0IG9mIHRoZSBwdWJsaWNhdGlvbi4KCmBgYAprbml0cjo6aW5jbHVkZV9ncmFwaGljcygibWFjb3Nrb19ncmFwaGljYWxBYnN0cmFjdC5qcGVnIikKYGBgCgpUaGUgc3VjY2VzcyBvZiBEcm9wLXNlcSBjYW4gYmUgZXhwbGFpbmVkIGJ5IHRoZSBmb2xsb3dpbmcgYWR2YW50YWdlb3VzIApmZWF0dXJlczoKCi0gVGhlIHVzZSBvZiB1bmlxdWUgbW9sZWN1bGFyIGlkZW50aWZpZXJzIChVTUlzKS4gQnkgd29ya2luZyB3aXRoIFVNSXMsIG9uZSBjb3VudApjb3JyZXNwb25kcyB0byBvbmUgb2JzZXJ2ZWQgbVJOQSBtb2xlY3VsZSBwcmVzZW50IGluIHRoZSBjZWxsLiBUaGFua3MgdG8gdGhlIHVzZQpvZiBVTUkgYmFyY29kZXMsIFBDUiBhcnRpZmFjdHMgYXJlIHJlZHVjZWQuCgotIFNjYWxhYmlsaXR5OiBtaWNyb2ZsdWlkaWNzIHRlY2hub2xvZ3kgYWxsb3dzIGZvciBwZXJmb3JtaW5nIHRoZSBsaWJyYXJ5IHByZXAKcmVhY3Rpb25zIGluc2lkZSBuYW5vZHJvcGxldHMsIGluIHdoaWNoIHNpbmdsZSBjZWxscyBtYXkgYmUgY29udGFpbmVkLiBMaWJyYXJ5IHByZXAgb2NjdXJzIGFjcm9zcyBhbGwgZHJvcGxldHMgc2ltdWx0YW5lb3VzbHkuCgotIENvc3Q6IHRoZSBleHBlcmltZW50IGNvc3RzIGFyb3VuZCA2LjUgY2VudHMgKFVTRCkgcGVyIGNlbGwuCgotIFNwZWVkOiBUaGUgdmVyeSBsYXJnZSBkYXRhc2V0IHRoYXQgd2Ugd2lsbCBiZSB3b3JraW5nIHdpdGggdG9kYXkgd2FzIApnZW5lcmF0ZWQgaW4gYW4gZXhwZXJpbWVudCB0aGF0IHRvb2sgb25seSA0IGRheXMuCgpJbiB0aGlzIHBhcnRpY3VsYXIgZXhwZXJpbWVudCwgTWFjb3NrbyAqZXQgYWwuKiBzZXF1ZW5jZWQgNDksMzAwIGNlbGxzIGZyb20gdGhlCm1vdXNlIHJldGluYSwgaWRlbnRpZnlpbmcgMzkgdHJhbnNjcmlwdGlvbmFsbHkgZGlzdGluY3QgY2VsbCBwb3B1bGF0aW9ucy4gVGhlCmV4cGVyaW1lbnQgd2FzIHBlcmZvcm1lZCBpbiA3IGJhdGNoZXMuCgojIERhdGEgYXZhaWxhYmlsaXR5CgojIyBTUkEKClRoZSBbU2VxdWVuY2UgUmVhZCBBcmNoaXZlIChTUkEpXShodHRwczovL3d3dy5uY2JpLm5sbS5uaWguZ292L3NyYSkgaXMgdGhlIApsYXJnZXN0IHB1YmxpY2x5IGF2YWlsYWJsZSByZXBvc2l0b3J5IG9mIGhpZ2gtdGhyb3VnaHB1dCBzZXF1ZW5jaW5nIGRhdGEuClRoZSBkYXRhIGFyZSBzdG9yZWQgYnkgdGhlIE5hdGlvbmFsIENlbnRlciBmb3IgQmlvdGVjaG5vbG9neSBJbmZvcm1hdGlvbiAoTkNCSSkgCnNlcnZpY2VzIGFuZCBtdWx0aXBsZSBjbG91ZCBzdG9yYWdlIHByb3ZpZGVycy4gRnJvbSB0aGlzIHdlYnNpdGUgInJhdyIgCnNlcXVlbmNpbmcgZGF0YSBjYW4gYmUgcmV0cmlldmVkLiBJbiBwcmFjdGljZSwgdGhlc2UgYXJlIHVzdWFsbHkgYC5zcmFgIGZpbGVzLAp3aGljaCBjYW4gYmUgZG93bmxvYWRlZCBhbmQgY29udmVydGVkIGludG8gRkFTVFEgZmlsZXMgdXNpbmcgZnVuY3Rpb25zCmZyb20gdGhlIGBzcmF0b29sa2l0YCBzb2Z0d2FyZS4gCgpGb3Igb3VyIGRhdGFzZXQsIHRoZSBGQVNUUSBkYXRhIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGlzIApbbGlua10oaHR0cHM6Ly93d3cubmNiaS5ubG0ubmloLmdvdi9UcmFjZXMvc3R1ZHkvP2FjYz1QUkpOQTI2Nzg1NyZvPWFjY19zJTNBYSkuClRoZSBkYXRhIGFyZSBzdG9yZWQgYXMgb25lIGZpbGUgcGVyIHNlcXVlbmNpbmcgYmF0Y2gsIHdpdGggZWFjaCBmaWxlIAphcHByb3hpbWF0ZWx5IDIwR2IuIEFzIHN1Y2gsIGl0IHdpbGwgYmUgdW5mZWFzaWJsZSB0byBkb3dubG9hZCBhbmQgcHJvY2VzcyB0aGVzZQpGQVNUUSBmaWxlcyBpbiB0aGlzIHByYWN0aWNhbCBzZXNzaW9uLgoKSW5zdGVhZCwgZm9yIGRlbW9uc3RyYXRpdmUgcHVycG9zZXMsIHdlIGhhdmUgdGFrZW4gYSBzdWJzYW1wbGUgb2YgdGhlIEZBU1RRCmZpbGUgZm9yIHRoZSBmaXJzdCBzZXF1ZW5jaW5nIGJhdGNoIGZvciB5b3UgdG8gd29yayB3aXRoLiBPbiB0aGlzIHN1YnNhbXBsZSwgCndlIG1heSBwZXJmb3JtIGFsbCB0aGUgdGFza3MgdGhhdCB3ZSB3b3VsZCBoYXZlIHBlcmZvcm1lZCBvbiB0aGUgZnVsbCBkYXRhc2V0LgpUaGUgc3RlcHMgdGhhdCBhcmUgcmVxdWlyZWQgZm9yIGRvd25sb2FkaW5nIGFuZCBxdWFudGlmeWluZyBkcm9wLXNlcSBkYXRhCmNhbiBiZSBmb3VuZCBpbiBbYSBTaGVsbCBzY3JpcHQgb24gb3VyIGNvbXBhbmlvbiBHaXRIdWIgcmVwb3NpdG9yeV0oaHR0cHM6Ly9naXRodWIuY29tL3N0YXRPbWljcy9zaW5nbGVDZWxsQ291cnNlL2Jsb2IvbWFzdGVyL2xhYjFfcHJlcHJvY2Vzc2luZy9wcmVwcm9jZXNzRHJvcHNlcS5zaCkuCgojIyBHRU8KClRoZSBkYXRhc2V0IGZyb20gTWFjb3NrbyAqZXQgYWwuKiB3YXMgYWxzbyB1cGxvYWRlZCBieSB0aGUgYXV0aG9ycyBvbiB0aGUgCkdlbmUgRXhwcmVzc2lvbiBPbW5pYnVzIChHRU8pIHBsYXRmb3JtIHVuZGVyIGFjY2Vzc2lvbiBudW1iZXIgCltHU0U2MzQ3Ml0oaHR0cHM6Ly93d3cubmNiaS5ubG0ubmloLmdvdi9nZW8vcXVlcnkvYWNjLmNnaT9hY2M9R1NFNjM0NzIpLCAKZnJvbSB3aGljaCByYXcgYW5kIHJlYWRpbHktcHJvY2Vzc2VkIGRhdGEgZmlsZXMgbWF5IGJlIHJldHJpZXZlZCwgaW5jbHVkaW5nOgoKMS4gKkdTRTYzNDcyX1JBVy50YXIqLCBhIDkwLjZHYiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgInJhdyBkYXRhIiBmb3IgdGhlCmV4cGVyaW1lbnQuIEluIHRoZSBzY1JOQS1zZXEgY29udGV4dCwgRkFTVFEgZmlsZXMgYXJlIG9mdGVuIGNvbnNpZGVyZWQgdGhlIHJhdwpkYXRhIGZvcm1hdC4KCjIuICpHU0U2MzQ3Ml9QMTRSZXRpbmFfbWVyZ2VkX2RpZ2l0YWxfZXhwcmVzc2lvbi50eHQuZ3oqLCBhIDUwLjdNYiBtYXRyaXggdGhhdApzdG9yZXMgdGhlIGdlbmUgZXhwcmVzc2lvbiB2YWx1ZXMgZm9yIGVhY2ggY2VsbC4gVGhlc2UgdmFsdWVzIGFyZSBpbnRlZ2VyIApjb3VudHMsIHRoYXQgZGlkIG5vdCB1bmRlcmdvIGFueSB0eXBlIG9mIHByZXByb2Nlc3Npbmcgb3Igbm9ybWFsaXphdGlvbi4KCjMuICpHU0U2MzQ3Ml9tbTEwX3JlZmVyZW5jZV9tZXRhZGF0YS50YXIuZ3oqLCBhIDg2Mi45TWIgY29tcHJlc3NlZCBmb2xkZXIKY29udGFpbmluZyBpbmZvcm1hdGlvbiBvbiB0aGUgcmVmZXJlbmNlIGdlbm9tZSB0byB3aGljaCB0aGUgc2NSTkEtc2VxIHJlYWRzCndlcmUgYWxpZ25lZCAoc2VlIHRoZW9yeSBzbGlkZXMpLgoKNC4gKkdTRTYzNDcyX1AxNFJldGluYV9sb2dER0UudHh0Lmd6KiwgYSAzMTYuOE1iIGNvbXByZXNzZWQgdGV4dCBmaWxlLCBub3QgY2xlYXIKd2hhdCBpdCBjb250YWlucyAocmVzdWx0cyBmcm9tIGEgZGlmZmVyZW50aWFsIGdlbmUgZXhwcmVzc2lvbiBhbmFseXNpcywgYnV0CndpdGggbG9nLXRyYW5zZm9ybWF0aW9uLCBzbyBsb2ctZm9sZCBjaGFuZ2VzIG1heWJlPykuCgpBcyBzdWNoLCBieSBkb3dubG9hZGluZyAqR1NFNjM0NzJfUDE0UmV0aW5hX21lcmdlZF9kaWdpdGFsX2V4cHJlc3Npb24udHh0Lmd6KiwKd2UgYXZvaWQgcmUtcXVhbnRpZnlpbmcgdGhlIGRhdGEsIGkuZS4sIHRoZSB0cmFuc2xhdGlvbiBmcm9tIHJlYWRzIGZyb20gdGhlCkZBU1RRIGZpbGVzIGludG8gYSBnZW5lLWxldmVsIGV4cHJlc3Npb24gdmFsdWVzIGZvciBlYWNoIGNlbGwuIAoKT25lIGlzc3VlIHRoYXQgb2Z0ZW4gYXJpc2VzIGZyb20gZGF0YSBkb3dubG9hZGVkIGZyb20gR0VPLCBpcyB0aGF0IHRoZXJlIGlzIG5vCnN0cmljdCByZXF1aXJlbWVudHMgZm9yIHdoaWNoIGRhdGEgc2hvdWxkIGJlIGluY2x1ZGVkIGluIHRoZSB1cGxvYWQgYnkgdGhlIAphdXRob3JzLiBBcyBzdWNoLCBmcm9tIG15IHBlcnNvbmFsIGV4cGVyaWVuY2UsIGl0IGNhbiBvZnRlbiBiZSB0aGUgY2FzZSB0aGF0CmltcG9ydGFudCBpbmZvcm1hdGlvbiBsaWtlIG1ldGFkYXRhIGFyZSBtaXNzaW5nLCBvciB0aGUgY29udGVudCBvZiB0aGUgc3VibWl0dGVkCmZpbGVzIGlzIHVuY2xlYXIuIEV2ZW4gaWYgYWxsIHRoZSByZXF1aXJlZCBkYXRhIGFyZSBhdmFpbGFibGUsIGFzIGlzIHRoZSBjYXNlIApoZXJlLCB3ZSB3b3VsZCBzdGlsbCBuZWVkIHRvIHBpZWNlIGFsbCB0aGUgaW5mb3JtYXRpb24gdG9nZXRoZXIgZnJvbSBkaWZmZXJlbnQgCmZpbGVzIGFuZCBmaWxlIGZvcm1hdHMgYmVmb3JlIHdlIGNhbiB1c2UgdGhlbS4KCiMjIEV4cGVyaW1lbnRIdWIKClRoZSBCaW9jb25kdWN0b3IgKkV4cGVyaW1lbnRIdWIqIHdlYiByZXNvdXJjZSwgd2hpY2ggY2FuIGJlIGFjY2Vzc2VkIHVzaW5nIHRoZSAKW0V4cGVyaW1lbnRIdWJdKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9wYWNrYWdlcy9yZWxlYXNlL2Jpb2MvaHRtbC9FeHBlcmltZW50SHViLmh0bWwpIApSIHBhY2thZ2UsIHByb3ZpZGVzIGEgY2VudHJhbCBsb2NhdGlvbiB3aGVyZSBjdXJhdGVkIGRhdGEgZnJvbSBleHBlcmltZW50cywgCnB1YmxpY2F0aW9ucyBvciB0cmFpbmluZyBjb3Vyc2VzIGNhbiBiZSBhY2Nlc3NlZC4gV2hpbGUgaXQgY29udGFpbnMgZmFyIGxlc3MKZGF0YXNldHMgdGhhbiB0aGUgU1JBIG9yIEdFTyAoNDk2NSByZWNvcmRzIHRvIGRhdGUpLCB0aGVzZSBkYXRhc2V0cyBhbGwgZm9sbG93IAp0aGUgdGlkeSBkYXRhIGZvcm1hdCBvZiBCaW9jb25kdWN0b3IuIE5vdGUgdGhhdCB0aGUgRXhwZXJpbWVudEh1YiBjb250YWlucyAKc2V2ZXJhbCB0eXBlcyBvZiBkYXRhLCBsaWtlIGJ1bGsgYW5kIHNpbmdsZS1jZWxsIHRyYW5zY3JpcHRvbWljcyBkYXRhLCAKbWljcm9hcnJheXMgYW5kIG1vcmUuCgpUaGUgTWFjb3NrbyBkYXRhc2V0IGlzIGF2YWlsYWJsZSBmcm9tIEV4cGVyaW1lbnRIdWIgYW5kIGNhbiBiZSBhY2Nlc3NlZCBhcwpmb2xsb3dzOgoKYGBge3IsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoRXhwZXJpbWVudEh1YikKZWRiIDwtIEV4cGVyaW1lbnRIdWIoKQoKZWRiW2dyZXAoIk1hY29za28iLCBlZGIkdGl0bGUpXSAjIGZpbmQgYWNjZXNzaW9uIG51bWJlciAoY2FuIGJlIGluZWZmaWNpZW50KQoKZWRiX2NvdW50cyA8LSBlZGJbWyJFSDI2OTAiXV0KZWRiX2NvdW50c1sxOjUsMTo1XQoKZWRiX2NvbGRhdGEgPC0gZWRiW1siRUgyNjkxIl1dCmVkYl9jb2xkYXRhWzE6NSxdCgpybShlZGIsIGVkYl9jb3VudHMsIGVkYl9jb2xkYXRhKQpgYGAKCiMjIHNjUk5BU2VxCgpJbiBhZGRpdGlvbiB0byBFeHBlcmltZW50SHViLCBCaW9jb25kdWN0b3IgcHJvdmlkZXMgdGhlIHBhY2thZ2UKW3NjUk5Bc2VxXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvcGFja2FnZXMvcmVsZWFzZS9kYXRhL2V4cGVyaW1lbnQvaHRtbC9zY1JOQXNlcS5odG1sKS4KVGhpcyBwYWNrYWdlIHByb3ZpZGVzIGFuIGV2ZW4gbW9yZSB1c2VyLWZyaWVuZGx5IGNsaWVudCB0byBhY2Nlc3MgKG9ubHkpIApzY1JOQS1zZXEgZGF0YXNldHMgZnJvbSB0aGUgRXhwZXJpbWVudEh1YiB3ZWIgcmVzb3VyY2UuIERhdGEgcmV0cmlldmVkIHVzaW5nIHRoZQpzY1JOQXNlcSBwYWNrYWdlIGFyZSBzdG9yZWQgYXMgdXNlci1mcmllbmRseSBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIG9iamVjdHMsIAp3aXRoIHRoZSBleHByZXNzaW9uIGRhdGEsIGdlbmUtbGV2ZWwgaW5mb3JtYXRpb24sIGNlbGwtbGV2ZWwgaW5mb3JtYXRpb24gYW5kIApleHBlcmltZW50IG1ldGFkYXRhIGFsbCBpbiBwbGFjZSBpbiBvbmUgZGF0YSBvYmplY3QuIFRoZSBzY1JOQS1zZXEgcGFja2FnZQpjdXJyZW50bHkgaG9sZHMgNjEgZGF0YXNldHMsIGluY2x1ZGluZyB0aGUgZGF0YSBmcm9tICpNYWNvc2tvIGV0IGFsLio6CgpgYGB7ciwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeShzY1JOQXNlcSkKc2NSTkFzZXE6Ok1hY29za29SZXRpbmFEYXRhKCkKYGBgCgojIEltcG9ydCBkYXRhCgpUaGUgYHNjUk5Bc2VxYCBwYWNrYWdlIHByb3ZpZGVzIGNvbnZlbmllbnQgYWNjZXNzIHRvIHNldmVyYWwgZGF0YXNldHMuIFNlZSB0aGUgW3BhY2thZ2UgQmlvY29uZHVjdG9yIHBhZ2VdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL3BhY2thZ2VzL3JlbGVhc2UvZGF0YS9leHBlcmltZW50L2h0bWwvc2NSTkFzZXEuaHRtbCkgCmZvciBtb3JlIGluZm9ybWF0aW9uLgoKYGBge3J9CiMgQ29kZSBiZWxvdyBtaWdodCBhc2sgeW91IHRvIGNyZWF0ZSBhbiBFeHBlcmltZW50SHViIGRpcmVjdG9yeS4gCiMgVHlwZSAneWVzJyBhbmQgaGl0IEVudGVyLCB0byBhbGxvdyB0aGlzLgpzdXBwcmVzc1BhY2thZ2VTdGFydHVwTWVzc2FnZXMobGlicmFyeShzY1JOQXNlcSkpCnNjZSA8LSBNYWNvc2tvUmV0aW5hRGF0YSgpCmBgYAoKIyBBIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0CgpgYGB7cn0Kc2NlCmBgYAoKIyMgQWNjZXNzaW5nIGRhdGEgZnJvbSBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0CgpQbGVhc2Ugc2VlIFtGaWd1cmUgNC4xIGluIE9TQ0FdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzL3JlbGVhc2UvT1NDQS9kYXRhLWluZnJhc3RydWN0dXJlLmh0bWwpIApmb3IgYW4gb3ZlcnZpZXcgb2YgYSBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIG9iamVjdC4KCmBgYHtyfQojIERhdGE6IGFzc2F5cwphc3NheXMoc2NlKQphc3NheXMoc2NlKSRjb3VudHNbMTo1LCAxOjVdCgojIEZlYXR1cmUgbWV0YWRhdGE6IHJvd0RhdGEKcm93RGF0YShzY2UpICMgZW1wdHkgZm9yIG5vdwoKIyBDZWxsIG1ldGFkYXRhOiBjb2xEYXRhCmNvbERhdGEoc2NlKQoKIyBSZWR1Y2VkIGRpbWVuc2lvbnM6IHJlZHVjZWREaW1zCnJlZHVjZWREaW1zKHNjZSkgIyBlbXB0eSBmb3Igbm93CmBgYAoKIyMgQ3JlYXRpbmcgYSBuZXcgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QKCmBgYHtyfQpzY2VOZXcgPC0gU2luZ2xlQ2VsbEV4cGVyaW1lbnQoYXNzYXlzID0gbGlzdChjb3VudHMgPSBhc3NheXMoc2NlKSRjb3VudHMpKQpzY2VOZXcKCnJtKHNjZU5ldykKYGBgCgojIyBTdG9yaW5nIChtZXRhKWRhdGEgaW4gYSBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIG9iamVjdAoKYGBge3J9CmZha2VHZW5lTmFtZXMgPC0gcGFzdGUwKCJnZW5lIiwgMTpucm93KHNjZSkpCnJvd0RhdGEoc2NlKSRmYWtlTmFtZSA8LSBmYWtlR2VuZU5hbWVzCmhlYWQocm93RGF0YShzY2UpKQojIFJlbW92ZSBhZ2FpbiBieSBzZXR0aW5nIHRvIE5VTEwKcm93RGF0YShzY2UpJGZha2VOYW1lIDwtIE5VTEwKCmFzc2F5cyhzY2UpJGxvZ0NvdW50cyA8LSBsb2cxcChhc3NheXMoc2NlKSRjb3VudHMpCmFzc2F5cyhzY2UpCmFzc2F5cyhzY2UpJGxvZ0NvdW50c1sxOjUsIDE6NV0KYXNzYXlzKHNjZSkkbG9nQ291bnRzIDwtIE5VTEwKYGBgCgojIE9idGFpbmluZyBhbmQgaW5jbHVkaW5nIHJvd0RhdGEKClRoZSBgcm93RGF0YWAgc2xvdCBvZiBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0IGFsbG93cyBmb3Igc3RvcmluZyAKaW5mb3JtYXRpb24gb24gdGhlIGZlYXR1cmVzLCBpLmUuIHRoZSBnZW5lcywgaW4gYSBkYXRhc2V0LiBJbiBvdXIgb2JqZWN0LAp0aGUgYHJvd0RhdGFgIHNsb3QgaXMgZW1wdHkuCgpgYGB7cn0Kcm93RGF0YShzY2UpCmBgYAoKQXMgc3VjaCwgdGhlIG9ubHkgaW5mb3JtYXRpb24gd2UgaGF2ZSBvbiB0aGUgZ2VuZXMgYXJlIHRoZWlyIG5hbWVzLCB3aGljaCBjYW4KYmUgcmV0cmlldmVkIGFzIHRoZSBgcm93bmFtZXNgIG9mIHRoZSBleHByZXNzaW9uIG1hdHJpeC4KCmBgYHtyfQpoZWFkKHJvd25hbWVzKHNjZSkpCmBgYAoKVGhlc2UgYXJlIHRoZSBnZW5lIG5hbWVzIChzeW1ib2xzKS4gTm90ZSB0aGF0IGl0IG1heSBiZSB1c2VmdWwgdG8gaW5jbHVkZSAKYWRkaXRpb25hbCBpbmZvcm1hdGlvbiBpbiB0aGUgYHJvd0RhdGFgIHNsb3QuIEZvciBpbnN0YW5jZSwgd2UgbWF5IHdhbnQgdG8gCnN0b3JlOgoKLSBVbmFtYmlndW91cyBnZW5lIGlkZW50aWZpZXJzIChlLmcuIGZyb20gRU5TRU1CTCkKLSBPbiB3aGljaCBjaHJvbW9zb21lIHRoZSBnZW5lIGlzIGxvY2F0ZWQKLSBHZW5lIGxlbmd0aCAoZ2Vub21pYyBzdGFydCBwb3NpdGlvbiBhbmQgZW5kIHBvc2l0aW9uKQotIE90aGVycy4uLgoKYGBge3IsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoImJpb21hUnQiKQoKZW5zZW1ibDc1IDwtIHVzZUVuc2VtYmwoYmlvbWFydCA9ICdnZW5lcycsIAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0ID0gJ21tdXNjdWx1c19nZW5lX2Vuc2VtYmwnLAogICAgICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gNzUpCgpoZWFkKGxpc3RBdHRyaWJ1dGVzKGVuc2VtYmw3NSkpICMgcG90ZW50aWFsIGluZm8gdG8gZXh0cmFjdAoKZ2VuZUluZm8gPC0gZ2V0Qk0oYXR0cmlidXRlcyA9IGMoImVuc2VtYmxfZ2VuZV9pZCIsICMgRU5TRU1CTCB1bmFtYmlndW91cyBpZGVudGlmaWVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZ2lfc3ltYm9sIiwgIyBHZW5lIHN5bWJvbCAodG8gbGluayB3aXRoIFNDRSByb3duYW1lcyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaHJvbW9zb21lX25hbWUiLCAjIE9uIHdoaWNoIGNocm9tb3NvbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXJ0X3Bvc2l0aW9uIiwgIyBTdGFydCBwb3NpdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kX3Bvc2l0aW9uIiksIyBFbmQgcG9zaXRpb24KICAgICAgICAgICAgICAgICAgbWFydCA9IGVuc2VtYmw3NSkKCmhlYWQoZ2VuZUluZm8pCmBgYAoKYGBge3J9CmdlbmVJbmZvJG1naV9zeW1ib2xfdXBwZXIgPC0gdG91cHBlcihnZW5lSW5mbyRtZ2lfc3ltYm9sKSAKIyBtYXRjaCBiZXR3ZWVuIGdlbmUgaW5mbyBhbmQgcm93bmFtZXMKCnN1bShyb3duYW1lcyhzY2UpICVpbiUgZ2VuZUluZm8kbWdpX3N5bWJvbF91cHBlcikKc3VtKCFyb3duYW1lcyhzY2UpICVpbiUgZ2VuZUluZm8kbWdpX3N5bWJvbF91cHBlcikgIyBsb3N0IGluIGNvbnZlcnNpb24gOigKCnJvd0RhdGEoc2NlKSA8LSBnZW5lSW5mb1ttYXRjaChyb3duYW1lcyhzY2UpLGdlbmVJbmZvJG1naV9zeW1ib2xfdXBwZXIpLF0KYGBgCgpgYGB7cn0KaGVhZChyb3dEYXRhKHNjZSkpCmBgYAoKIyBGaWx0ZXJpbmcgbm9uLWluZm9ybWF0aXZlIGdlbmVzCgpgYGB7cn0KbGlicmFyeShlZGdlUikKCiMgQSB2ZXJ5IHNpbXBsZSBzdHJhdGVneTogcmVtb3ZlIGFsbCBnZW5lcyB0aGF0IGFyZSBleHByZXNzZWQgaW4gbGVzcyB0aGFuIDEwCiMgb3V0IG9mIDQ5MzAwIGNlbGxzIC0+IG5vdGUgdGhhdCB0aGlzIGEgdmVyeSBsZW5pZW50IGZpbHRlcmluZyBjcml0ZXJpdW0Ka2VlcCA8LSByb3dTdW1zKGFzc2F5cyhzY2UpJGNvdW50cyA+IDApID4gMTAKdGFibGUoa2VlcCkKCnNjZSA8LSBzY2Vba2VlcCxdCmBgYAoKTm90ZSB0aGF0IGRlZGljYXRlZCBmdW5jdGlvbnMgZm9yIGZpbHRlcmluZyBvdXQgbG93bHkgZXhwcmVzc2VkIGdlbmVzIGV4aXN0LgpPbmUgc3VjaCBmdW5jdGlvbiBpcyB0aGUgYGZpbHRlckJ5RXhwcmAgZnVuY3Rpb24gb2YgdGhlIGVkZ2VSIFIgcGFja2FnZS4KSW4gYnJpZWYsIHRoZSBzdHJhdGVneSBrZWVwcyBnZW5lcyB0aGF0IGhhdmUgYXQgbGVhc3QgIm1pbi5jb3VudCIgcmVhZHMgaW4gYSAKd29ydGh3aGlsZSBudW1iZXIgc2FtcGxlcy4gCgpNb3JlIHByZWNpc2VseSwgdGhlIGZpbHRlcmluZyBrZWVwcyBnZW5lcyB0aGF0IGhhdmUgY291bnQtcGVyLW1pbGxpb24gKENQTSkgCmFib3ZlIGsgaW4gbiBzYW1wbGVzLiAKCmsgaXMgZGV0ZXJtaW5lZCBieSB0aGUgbWluLmNvdW50IGFyZ3VtZW50IHRvIHRoZSBmdW5jdGlvbiwgYW5kIGJ5IHRoZSBzYW1wbGUgCmxpYnJhcnkgc2l6ZXMuCgpuIGlzIGRldGVybWluZWQgYnkgdGhlIGRlc2lnbiBtYXRyaXguIG4gY2FuIGJlIHNlZW4gYXMgdGhlIHNtYWxsZXN0IGdyb3VwIHNhbXBsZQpzaXplLiBBIGBncm91cGAgb2Ygc2FtcGxlcy9jZWxscyBjYW4gYmUgZGVmaW5lZCBhcyBjZWxscyB0aGF0IGFyZSBtb3JlIHNpbWlsYXIKdG8gb25lIGFub3RoZXIsIGUuZy4sIGZyb20gdGhlIHNhbWUgc2VxdWVuY2luZyBiYXRjaCwgdGhlIHNhbWUgcGF0aWVudC4uLi4KSGVyZSB3ZSBjb3VsZCBhbHNvIHVzZSB0aGUgY2x1c3RlciBhc3NpZ25tZW50IChjZWxsIHR5cGUpIGZvciBlYWNoIGNlbGwgYXMgdGhlCmdyb3VwaW5nIHZhcmlhYmxlOyAqbm90ZSBob3dldmVyLCB0aGF0IHRoaXMgdXN1YWxseSBpcyBub3QgYXZhaWxhYmxlIHVudGlsIGEqCipsYXRlciBzdGFnZSBpbiB0aGUgYW5hbHlzaXMgcGlwZWxpbmUqIChpLmUuLCBhZnRlciBkaW1lbnNpb24gcmVkdWN0aW9uIGFuZCAKY2x1c3RlcmluZywgdG9waWNzIHdlIHdpbGwgY292ZXIgbmV4dCBzZXNzaW9uLikKCklmIGFsbCB0aGUgZ3JvdXAgc2l6ZXMgYXJlIGxhcmdlciB0aGFuIHRoZSBgbGFyZ2UubmAgYXJndW1lbnQgb2YgdGhlIApmaWx0ZXJCeUV4cHIgZnVuY3Rpb24sIHdoaWNoIGRlZmF1bHRzIHRvIDEwLCB0aGVuIG4gd2lsbCBiZSB0YWtlbiBhcwpgbWluLnByb3BgKiB0aGUgdGhlIG51bWJlciBvZiBzYW1wbGVzL2NlbGxzIGluIHRoZSBzbWFsbGVzdCBncm91cC4KCk5vdGUgdGhhdCBhbGwgdGhlIGdyb3VwIHNpemVzIHdpbGwgb2Z0ZW4gYmUgbGFyZ2VyIHRoYW4gdGhlIGBsYXJnZS5uYCBpbiBjYXNlCm9mIHNpbmdsZS1jZWxsIGRhdGEuCgpgYGB7cn0KIyBTbG93IChtb3JlIHRoYW4gMW1pbikgLT4gZG8gbm90IHJ1bgojIGtlZXAyIDwtIGZpbHRlckJ5RXhwcihzY2UsCiMgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwID0gc2NlJGNsdXN0ZXIsCiMgICAgICAgICAgICAgICAgICAgICAgIG1pbi5jb3VudCA9IDEsCiMgICAgICAgICAgICAgICAgICAgICAgIG1pbi50b3RhbC5jb3VudCA9IDE1LAojICAgICAgICAgICAgICAgICAgICAgICBtaW4ucHJvcCA9IDAuMikKIyB0YWJsZShrZWVwMikKYGBgCgoKIyBRdWFsaXR5IGNvbnRyb2wKCkluIHF1YWxpdHkgY29udHJvbCAoUUMpLCB3ZSBjaGVjayB0aGUgcXVhbGl0eSBvZiBvdXIgZGF0YXNldC4gSW4gcGFydGljdWxhciwgCndlIGludmVzdGlnYXRlIHVuZGVzaXJhYmxlIG9kZGl0aWVzLCBzdWNoIGFzIGxvdy1xdWFsaXR5IGNlbGxzLCBlbXB0eSBkcm9wbGV0cwpvciBkb3VibGV0cy4KCiMjIElkZW50aWZ5aW5nIGFuZCByZW1vdmluZyBsb3ctcXVhbGl0eSBjZWxscwoKVGhlcmUgYXJlIHNldmVyYWwgZGlzdGluZ3Vpc2hpbmcgZmVhdHVyZXMgb2YgbG93LXF1YWxpdHkgY2VsbHMgdGhhdCBjYW4gYmUgdXNlZAppbiBvcmRlciB0byBpZGVudGlmeSB0aGVtLiBbQXMgZGVzY3JpYmVkIGluIHRoZSBPU0NBIGJvb2tdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTQvT1NDQS5iYXNpYy9xdWFsaXR5LWNvbnRyb2wuaHRtbCkgCmJvb2spOgoKMS4gVGhlIGxpYnJhcnkgc2l6ZSBpcyBkZWZpbmVkIGFzIHRoZSB0b3RhbCBzdW0gb2YgY291bnRzIGFjcm9zcyBhbGwgCnJlbGV2YW50IGZlYXR1cmVzIGZvciBlYWNoIGNlbGwuIEhlcmUsIHdlIHdpbGwgY29uc2lkZXIgdGhlIHJlbGV2YW50IGZlYXR1cmVzIAp0byBiZSB0aGUgZW5kb2dlbm91cyBnZW5lcy4gQ2VsbHMgd2l0aCBzbWFsbCBsaWJyYXJ5IHNpemVzIGFyZSBvZiBsb3cgcXVhbGl0eSAKYXMgdGhlIFJOQSBoYXMgYmVlbiBsb3N0IGF0IHNvbWUgcG9pbnQgZHVyaW5nIGxpYnJhcnkgcHJlcGFyYXRpb24sIGVpdGhlciBkdWUgCnRvIGNlbGwgbHlzaXMgb3IgaW5lZmZpY2llbnQgY0ROQSBjYXB0dXJlIGFuZCBhbXBsaWZpY2F0aW9uLgoKMi4gVGhlIG51bWJlciBvZiBleHByZXNzZWQgZmVhdHVyZXMgaW4gZWFjaCBjZWxsIGlzIGRlZmluZWQgYXMgdGhlIG51bWJlciBvZiAKZW5kb2dlbm91cyBnZW5lcyB3aXRoIG5vbi16ZXJvIGNvdW50cyBmb3IgdGhhdCBjZWxsLiBBbnkgY2VsbCB3aXRoIHZlcnkgCmZldyBleHByZXNzZWQgZ2VuZXMgaXMgbGlrZWx5IHRvIGJlIG9mIHBvb3IgcXVhbGl0eSBhcyB0aGUgZGl2ZXJzZSB0cmFuc2NyaXB0IApwb3B1bGF0aW9uIGhhcyBub3QgYmVlbiBzdWNjZXNzZnVsbHkgY2FwdHVyZWQuCgozLiBXZSBzb21ldGltZXMgaGF2ZSBzcGlrZS1pbiAoRVJDQykgdHJhbnNjcmlwdHMgYXZhaWxhYmxlLgpUaGUgcHJvcG9ydGlvbiBvZiByZWFkcyBtYXBwZWQgdG8gc3Bpa2UtaW4gdHJhbnNjcmlwdHMgaXMgY2FsY3VsYXRlZCByZWxhdGl2ZSAKdG8gdGhlIHRvdGFsIGNvdW50IGFjcm9zcyBhbGwgZmVhdHVyZXMgKGluY2x1ZGluZyBzcGlrZS1pbnMpIGZvciBlYWNoIGNlbGwuIApBcyB0aGUgc2FtZSBhbW91bnQgb2Ygc3Bpa2UtaW4gUk5BIHNob3VsZCBoYXZlIGJlZW4gYWRkZWQgdG8gZWFjaCBjZWxsLCAKYW55IGVucmljaG1lbnQgaW4gc3Bpa2UtaW4gY291bnRzIGlzIHN5bXB0b21hdGljIG9mIGxvc3Mgb2YgZW5kb2dlbm91cyBSTkEuCgo0LiBJbiB0aGUgYWJzZW5jZSBvZiBzcGlrZS1pbiB0cmFuc2NyaXB0cywgdGhlIHByb3BvcnRpb24gb2YgcmVhZHMgbWFwcGVkIAp0byBnZW5lcyBpbiB0aGUgbWl0b2Nob25kcmlhbCBnZW5vbWUgY2FuIGJlIHVzZWQuIEhpZ2ggcHJvcG9ydGlvbnMgYXJlIAppbmRpY2F0aXZlIG9mIHBvb3ItcXVhbGl0eSBjZWxscyAoSXNsYW0gZXQgYWwuIDIwMTQ7IElsaWNpYyBldCBhbC4gMjAxNiksIApwcmVzdW1hYmx5IGJlY2F1c2Ugb2YgbG9zcyBvZiBjeXRvcGxhc21pYyBSTkEgZnJvbSBwZXJmb3JhdGVkIGNlbGxzLiAKVGhlIHJlYXNvbmluZyBpcyB0aGF0LCBpbiB0aGUgcHJlc2VuY2Ugb2YgbW9kZXN0IGRhbWFnZSwgdGhlIGhvbGVzIGluIHRoZSAKY2VsbCBtZW1icmFuZSBwZXJtaXQgZWZmbHV4IG9mIGluZGl2aWR1YWwgdHJhbnNjcmlwdCBtb2xlY3VsZXMgYnV0IGFyZSB0b28gCnNtYWxsIHRvIGFsbG93IG1pdG9jaG9uZHJpYSB0byBlc2NhcGUsIGxlYWRpbmcgdG8gYSByZWxhdGl2ZSBlbnJpY2htZW50IG9mIAptaXRvY2hvbmRyaWFsIHRyYW5zY3JpcHRzLiBGb3Igc2luZ2xlLW51Y2xlaSBSTkEtc2VxIGV4cGVyaW1lbnRzLCBoaWdoIApwcm9wb3J0aW9ucyBhcmUgYWxzbyB1c2VmdWwgYXMgdGhleSBjYW4gbWFyayBjZWxscyB3aGVyZSB0aGUgY3l0b3BsYXNtIGhhcyAKbm90IGJlZW4gc3VjY2Vzc2Z1bGx5IHN0cmlwcGVkLgoKIyMgQ2FsY3VsYXRlIFFDIHZhcmlhYmxlcwoKVGhpcyBmdW5jdGlvbiBjYWxjdWxhdGVzIHVzZWZ1bCBRQyBtZXRyaWNzIGZvciBpZGVudGlmaWNhdGlvbiBhbmQgcmVtb3ZhbCBvZiAKcG90ZW50aWFsbHkgcHJvYmxlbWF0aWMgY2VsbHMuIERlZmF1bHQgcGVyLWNlbGwgbWV0cmljcyBhcmUgdGhlIHN1bSBvZiBjb3VudHMgCihpLmUuLCB0aGUgbGlicmFyeSBzaXplKSBhbmQgdGhlIG51bWJlciBvZiBkZXRlY3RlZCBmZWF0dXJlcy4gVGhlIHBlcmNlbnRhZ2Ugb2YgCmNvdW50cyBpbiB0aGUgdG9wIGZlYXR1cmVzIGFsc28gcHJvdmlkZXMgYSBtZWFzdXJlIG9mIGxpYnJhcnkgY29tcGxleGl0eS4KCklmIHN1YnNldHMgaXMgc3BlY2lmaWVkLCB0aGVzZSBzdGF0aXN0aWNzIGFyZSBhbHNvIGNvbXB1dGVkIGZvciBlYWNoIHN1YnNldCBvZiAKZmVhdHVyZXMuIFRoaXMgaXMgdXNlZnVsIGZvciBpbnZlc3RpZ2F0aW5nIGdlbmUgc2V0cyBvZiBpbnRlcmVzdCwgZS5nLiwgCm1pdG9jaG9uZHJpYWwgZ2VuZXMuCgpgYGB7ciwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeShzY2F0ZXIpCgojIGNoZWNrIEVSQ0Mgc3Bpa2UtaW4gdHJhbnNjcmlwdHMKc3VtKGdyZXBsKCJeRVJDQy0iLCByb3duYW1lcyhzY2UpKSkgIyBubyBzcGlrZS1pbiB0cmFuc2NyaXB0cyBhdmFpbGFibGUKCiMgY2hlY2sgbWl0b2Nob25kcmlhbCBnZW5lcwpzdW0ocm93RGF0YShzY2UpJGNocm9tb3NvbWVfbmFtZT09Ik1UIixuYS5ybSA9IFRSVUUpICMgMjggbWl0b2Nob25kcmlhbCBnZW5lcwpzdW0oZ3JlcGwoIl5NVC0iLCByb3duYW1lcyhzY2UpKSkgIyBhbHRlcm5hdGl2ZWx5CmlzLm1pdG8gPC0gZ3JlcGwoIl5NVC0iLCByb3duYW1lcyhzY2UpKQoKIyMgY2FsY3VsYXRlIFFDIG1ldHJpY3MKZGYgPC0gcGVyQ2VsbFFDTWV0cmljcyhzY2UsIHN1YnNldHM9bGlzdChNaXRvPWlzLm1pdG8pKQpoZWFkKGRmKQoKIyBhZGQgUUMgdmFyaWFibGVzIHRvIHNjZSBvYmplY3QKY29sRGF0YShzY2UpIDwtIGNiaW5kKGNvbERhdGEoc2NlKSwgZGYpCgojIHRoZSBRQyB2YXJpYWJsZXMgaGF2ZSBub3cgYmVlbiBhZGRlZCB0byB0aGUgY29sRGF0YSBvZiBvdXIgU0NFIG9iamVjdC4KaGVhZChjb2xEYXRhKHNjZSkpCmBgYAoKIyMgRXhwbG9yYXRvcnkgZGF0YSBhbmFseXNpcwoKSW4gdGhlIGZpZ3VyZSBiZWxvdywgd2Ugc2VlIHRoYXQgc2V2ZXJhbCBjZWxscyBoYXZlIGEgdmVyeSBsb3cgbnVtYmVyIG9mIApleHByZXNzZWQgZ2VuZXMsIGFuZCB3aGVyZSBtb3N0IG9mIHRoZSBtb2xlY3VsZXMgYXJlIGRlcml2ZWQgZnJvbSAKbWl0b2Nob25kcmlhbCBnZW5lcy4gVGhpcyBpbmRpY2F0ZXMgbGlrZWx5IGRhbWFnZWQgY2VsbHMsIHByZXN1bWFibHkgYmVjYXVzZSAKb2YgbG9zcyBvZiBjeXRvcGxhc21pYyBSTkEgZnJvbSBwZXJmb3JhdGVkIGNlbGxzLCBzbyB3ZSBzaG91bGQgcmVtb3ZlIHRoZXNlIGZvciAKdGhlIGRvd25zdHJlYW0gYW5hbHlzaXMuCgpgYGB7cixldmFsPUZBTFNFfQojIE51bWJlciBvZiBnZW5lcyB2cyBsaWJyYXJ5IHNpemUKcGxvdENvbERhdGEoc2NlLCB4ID0gInN1bSIsIHk9ImRldGVjdGVkIiwgY29sb3VyX2J5PSJjbHVzdGVyIikgCgojIE1pdG9jaG9uZHJpYWwgZ2VuZXMKcGxvdENvbERhdGEoc2NlLCB4ID0gImRldGVjdGVkIiwgeT0ic3Vic2V0c19NaXRvX3BlcmNlbnQiKQpgYGAKCiMjIFFDIHVzaW5nIGFkYXB0aXZlIHRocmVzaG9sZHMKCkJlbG93LCB3ZSByZW1vdmUgY2VsbHMgdGhhdCBhcmUgb3V0bHlpbmcgd2l0aCByZXNwZWN0IHRvCgogMS4gQSBsb3cgc2VxdWVuY2luZyBkZXB0aCAobnVtYmVyIG9mIFVNSXMpOwogMi4gQSBsb3cgbnVtYmVyIG9mIGdlbmVzIGRldGVjdGVkOwogMy4gQSBoaWdoIHBlcmNlbnRhZ2Ugb2YgcmVhZHMgZnJvbSBtaXRvY2hvbmRyaWFsIGdlbmVzLgogCiBIZXJlIHdlIHdpbGwgcmVtb3ZlIGNlbGxzIGZvciBRQyBiYXNlZCBvbiAqKmFkYXB0aXZlIHRocmVzaG9sZHMqKiByZWxhdGVkIHRvCiB0aGUgdGhyZWUgcG9pbnRzIGZyb20gYWJvdmUuIEFkYXB0aXZlIHRyaGVzaG9sZHMgYXJlIHVzZWQgYXMgb3Bwb3NlZCB0bwogKipmaXhlZCB0aHJlc2hvbGRzKiouIAogCldpdGggZml4ZWQgdGhyZXNob2xkcywgd2UgdXNlIGZpeGVkIGN1dC1vZmYgdmFsdWVzIGZvciBlYWNoIGNlbGwgdG8gcGFzcyBRQywgCmUuZy4sIHdlIG1pZ2h0IGNvbnNpZGVyIGNlbGxzIHRvIGJlIGxvdyBxdWFsaXR5IGlmIHRoZXkgaGF2ZSBsaWJyYXJ5IHNpemVzIApiZWxvdyAxMDAsMDAwIHJlYWRzOyBleHByZXNzIGZld2VyIHRoYW4gNSwwMDAgZ2VuZXM7IGhhdmUgc3Bpa2UtaW4gcHJvcG9ydGlvbnMKYWJvdmUgMTAlOyBvciBoYXZlIG1pdG9jaG9uZHJpYWwgcHJvcG9ydGlvbnMgYWJvdmUgMTAlLgoKV2l0aCBhZGFwdGl2ZSB0aHJlc2hvbGRzLCB3ZSBhc3N1bWUgdGhhdCBtb3N0IG9mIHRoZSBkYXRhc2V0IGNvbnNpc3RzIG9mIApoaWdoLXF1YWxpdHkgY2VsbHMuIFdlIHRoZW4gaWRlbnRpZnkgY2VsbHMgdGhhdCBhcmUgb3V0bGllcnMgZm9yIHRoZSB2YXJpb3VzIApRQyBtZXRyaWNzLCBiYXNlZCBvbiB0aGUgbWVkaWFuIGFic29sdXRlIGRldmlhdGlvbiAoTUFEKSBmcm9tIHRoZSBtZWRpYW4gdmFsdWUKb2YgZWFjaCBtZXRyaWMgYWNyb3NzIGFsbCBjZWxscy4gQnkgZGVmYXVsdCwgd2UgY29uc2lkZXIgYSB2YWx1ZSB0byBiZSBhbm91dGxpZXIgCmlmIGl0IGlzIG1vcmUgdGhhbiAzIE1BRHMgZnJvbSB0aGUgbWVkaWFuIGluIHRoZSDigJxwcm9ibGVtYXRpY+KAnSBkaXJlY3Rpb24uIFRoaXMgCmlzIGxvb3NlbHkgbW90aXZhdGVkIGJ5IHRoZSBmYWN0IHRoYXQgc3VjaCBhIGZpbHRlciB3aWxsIHJldGFpbiA5OSUgb2YgCm5vbi1vdXRsaWVyIHZhbHVlcyB0aGF0IGZvbGxvdyBhIG5vcm1hbCBkaXN0cmlidXRpb24uIFdlIGRlbW9uc3RyYXRlIGFkb3B0aW5nCmFkYXB0aXZlIHRocmVzaG9sZHMgb24gdGhlIE1hY29za28gZGF0YXNldDoKCmBgYHtyfQpsb3dMaWIgPC0gaXNPdXRsaWVyKGRmJHN1bSwgdHlwZT0ibG93ZXIiLCBsb2c9VFJVRSkKbG93RmVhdHVyZXMgPC0gaXNPdXRsaWVyKGRmJGRldGVjdGVkLCB0eXBlPSJsb3dlciIsIGxvZz1UUlVFKQpoaWdoTWl0byA8LSBpc091dGxpZXIoZGYkc3Vic2V0c19NaXRvX3BlcmNlbnQsIHR5cGU9ImhpZ2hlciIpCgp0YWJsZShsb3dMaWIpCnRhYmxlKGxvd0ZlYXR1cmVzKQp0YWJsZShoaWdoTWl0bykKCmRpc2NhcmRDZWxscyA8LSAobG93TGliIHwgbG93RmVhdHVyZXMgfCBoaWdoTWl0bykKdGFibGUoZGlzY2FyZENlbGxzKQpjb2xEYXRhKHNjZSkkZGlzY2FyZENlbGxzIDwtIGRpc2NhcmRDZWxscwoKIyB2aXN1YWxpemUgY2VsbHMgdG8gYmUgcmVtb3ZlZAojIHBsb3RDb2xEYXRhKHNjZSwgeCA9ICJzdW0iLCB5PSJkZXRlY3RlZCIsIGNvbG91cl9ieT0iZGlzY2FyZENlbGxzIikKIyBwbG90Q29sRGF0YShzY2UsIHggPSAiZGV0ZWN0ZWQiLCB5PSJzdWJzZXRzX01pdG9fcGVyY2VudCIsIGNvbG91cl9ieSA9ICJkaXNjYXJkQ2VsbHMiKQpgYGAKCldlIHJlbW92ZWQgYSB0b3RhbCBvZiAkMzQyMyQgY2VsbHMsIG1vc3Qgb2Ygd2hpY2ggYmVjYXVzZSBvZiBhbiBvdXRseWluZ2x5IGhpZ2ggCnBlcmNlbnRhZ2Ugb2YgcmVhZHMgZnJvbSBtaXRvY2hvbmRyaWFsIGdlbmVzLgoKIyMgSWRlbnRpZnlpbmcgYW5kIHJlbW92aW5nIGVtcHR5IGRyb3BsZXRzCgpOb3RlIHRoYXQgdGhlIHJlbW92YWwgb2YgY2VsbHMgd2l0aCBsb3cgc2VxdWVuY2luZyBkZXB0aCB1c2luZyB0aGUgYWRhcHRpdmUgCnRocmVzaG9sZCBwcm9jZWR1cmUgYWJvdmUgaXMgYSB3YXkgb2YgcmVtb3ZpbmcgZW1wdHkgZHJvcGxldHMuIApPdGhlciBhcHByb2FjaGVzIGFyZSBwb3NzaWJsZSwgZS5nLiwgcmVtb3ZpbmcgY2VsbHMgYnkgc3RhdGlzdGljYWwgdGVzdGluZyAKdXNpbmcgYGVtdHB5RHJvcHNgLiBUaGlzIGRvZXMgcmVxdWlyZSB1cyB0byBzcGVjaWZ5IGEgbG93ZXIgYm91bmQgb24gdGhlIHRvdGFsIApudW1iZXIgb2YgVU1JcywgYmVsb3cgd2hpY2ggYWxsIGNlbGxzIGFyZSBjb25zaWRlcmVkIHRvIGNvcnJlc3BvbmQgdG8gZW1wdHkgCmRyb3BsZXRzLiBUaGlzIGxvd2VyIGJvdW5kIG1heSBub3QgYmUgdHJpdmlhbCB0byBkZXJpdmUsIGJ1dCB0aGUgYGJhcmNvZGVSYW5rc2AKZnVuY3Rpb24gY2FuIGJlIHVzZWZ1bCB0byBpZGVudGlmeSBhbiBlbGJvdy9rbmVlIHBvaW50LgoKSW4gYnJpZWYsIHRoZSBzdGVwcyB0YWtlbiBieSB0aGUgYGVtdHB5RHJvcHNgIGZ1bmN0aW9uIGNhbiBiZSBzdW1tYXJpemVkIGFzIApmb2xsb3dzOgoKMS4JRGVmaW5lIHRocmVzaG9sZCBUIG9mIHRvdGFsIFVNSSBjb3VudHMgKGUuZy4gd2l0aCB0aGUgaGVscCBvZiB0aGUgCmBiYXJjb2RlUmFua3NgIGZ1bmN0aW9uKSwgYmVsb3cgd2hpY2ggY2VsbHMgbWF5IGJlIGNvbnNpZGVyZWQgdG8gYmUgZnJvbSBlbXB0eSAKZHJvcGxldHMuIENhbGwgdGhpcyBzZXQgb2YgY2VsbHMgRS4KCjIuCURlZmluZSAkQV9nJCBhcyB0aGUgdG90YWwgZ2VuZSBleHByZXNzaW9uIGFjcm9zcyBhbGwgY2VsbHMgaW4gRS4KCjMuCURlZmluZSAkcGlfZyQgYXMgdGhlIHJlbGF0aXZlIGNvbnRyaWJ1dGlvbiBvZiBnZW5lIGcgdG8gdGhlIGFtYmllbnQgcHJvZmlsZS4KCjQuCUNhbGN1bGF0ZSBwLXZhbHVlIGZvciBlYWNoIGNlbGwgdG8gaGF2ZSBhIHRyYW5zY3JpcHRpb25hbCBwcm9maWxlIHNpbWlsYXIgdG8KdGhlIGFtYmllbnQgc29sdXRpb24uIEludHVpdGl2ZWx5LCBhIHAtdmFsdWUgYmVsb3cgdGhlIHJlcXVlc3RlZCBhbHBoYSBsZXZlbCAKd291bGQgY29ycmVzcG9uZCB0byBhIGNlbGwgZm9yIHdoaWNoIHRoZSBvYnNlcnZlZCBjb3VudCBwcm9maWxlIHN0cm9uZ2x5IApkZXZpYXRlcyBmcm9tIHRoZSBjb3VudCBwcm9maWxlIG9ic2VydmVkIGluIHRoZSBjZWxscyB3aXRoIGEgbGlicmFyeSBzaXplIApiZWxvdyB0aHJlc2hvbGQgVCwgaS5lLiwgYSBub24tZW1wdHkgZHJvcGxldC4KCmBgYHtyLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KERyb3BsZXRVdGlscykKYmNyYW5rIDwtIGJhcmNvZGVSYW5rcyhjb3VudHMoc2NlKSkKCiMgT25seSBzaG93aW5nIHVuaXF1ZSBwb2ludHMgZm9yIHBsb3R0aW5nIHNwZWVkLiBEdXBsaWNhdGVkIHJhbmtzIGFyZSBhIAojIGNvbnNlcXVlbmNlIG9mIHRpZXMgaW4gdGhlIHJhbmtzLCBpLmUuLCB3aGVuIGNlbGxzIGhhdmUgYW4gZXF1YWwgbGlicmFyeSBzaXplLgpzdW0oZHVwbGljYXRlZChiY3JhbmskcmFuaykpCnVuaXEgPC0gIWR1cGxpY2F0ZWQoYmNyYW5rJHJhbmspCgpwbG90KGJjcmFuayRyYW5rW3VuaXFdLCBiY3JhbmskdG90YWxbdW5pcV0sIGxvZz0ieHkiLAogICAgeGxhYj0iUmFuayIsIHlsYWI9IlRvdGFsIFVNSSBjb3VudCIsIGNleC5sYWI9MS4yKQphYmxpbmUoaD1tZXRhZGF0YShiY3JhbmspJGluZmxlY3Rpb24sIGNvbD0iZGFya2dyZWVuIiwgbHR5PTIpCmFibGluZShoPW1ldGFkYXRhKGJjcmFuaykka25lZSwgY29sPSJkb2RnZXJibHVlIiwgbHR5PTIpCmFibGluZShoPTM1MCwgY29sPSJvcmFuZ2UiLCBsdHk9MikgIyBwaWNrZWQgdmlzdWFsbHkgbXlzZWxmCmxlZ2VuZCgidG9wcmlnaHQiLCAKICAgICAgIGxlZ2VuZD1jKCJJbmZsZWN0aW9uIiwgIktuZWUiLCAiRW1waXJpY2FsIGtuZWUgcG9pbnQiKSwgCiAgICAgICBjb2w9YygiZGFya2dyZWVuIiwgImRvZGdlcmJsdWUiLCAib3JhbmdlIiksIAogICAgICAgbHR5PTIsIAogICAgICAgY2V4PTEuMikKCnNldC5zZWVkKDEwMCkKbGltaXQgPC0gMzUwICAgCmFsbC5vdXQgPC0gZW1wdHlEcm9wcyhjb3VudHMoc2NlKSwgbG93ZXI9bGltaXQsIHRlc3QuYW1iaWVudD1UUlVFKQojIHAtdmFsdWVzIGZvciBjZWxscyB3aXRoIHRvdGFsIFVNSSBjb3VudCB1bmRlciB0aGUgbG93ZXIgYm91bmQuCmhpc3QoYWxsLm91dCRQVmFsdWVbYWxsLm91dCRUb3RhbCA8PSBsaW1pdCAmIGFsbC5vdXQkVG90YWwgPiAwXSwKICAgIHhsYWI9IlAtdmFsdWUiLCBtYWluPSIiLCBjb2w9ImdyZXk4MCIsIGJyZWFrcz0yMCkKCiMgYnV0IG5vdGUgdGhhdCBpdCB3b3VsZCByZW1vdmUgYSB2ZXJ5IGhpZ2ggbnVtYmVyIG9mIGNlbGxzCmxlbmd0aCh3aGljaChhbGwub3V0JEZEUiA8PSAwLjAxKSkgIyByZXRhaW5lZAoKIyBzbyB3ZSBzdGljayB0byB0aGUgbW9yZSBsZW5pZW50IGFkYXB0aXZlIGZpbHRlcmluZyBzdHJhdGVneQojIHJlbW92ZSBjZWxscyBpZGVudGlmaWVkIHVzaW5nIGFkYXB0aXZlIHRocmVzaG9sZHMKc2NlIDwtIHNjZVssICFjb2xEYXRhKHNjZSkkZGlzY2FyZENlbGxzXQpgYGAKCiMjIElkZW50aWZ5aW5nIGFuZCByZW1vdmluZyBkb3VibGV0cwoKV2Ugd2lsbCB1c2UgCltzY0RibEZpbmRlcl0oaHR0cHM6Ly9iaW9jb25kdWN0b3Iub3JnL3BhY2thZ2VzLzMuMTQvYmlvYy9odG1sL3NjRGJsRmluZGVyLmh0bWwpIAp0byBkZXRlY3QgZG91YmxldCBjZWxscy4KCkFzIGRpc2N1c3NlZCBpbiB0aGUgdGhlb3J5IHNlc3Npb24gb2YgbGFzdCB3ZWVrLCB0aGUgc3RlcHMgdGFrZW4gYnkgCmBzY0RibEZpbmRlcmAgY2FuIGJlIHN1bW1hcml6ZWQgYXMgZm9sbG93czoKCjEuIFBlcmZvcm0gcHJpbmNpcGFsIGNvbXBvbmVudHMgYW5hbHlzaXMgKFBDQSkgb24gbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiAKY291bnRzLiBUaGlzIGFsbG93cyBmb3IgcHJvamVjdGluZyBlYWNoIGNlbGwgaW4gdGhlIGRhdGFzZXQgaW50byBhIDJEIHNwYWNlCihmb3IgbW9yZSBkZXRhaWxzIG9uIFBDQSwgc2VlIG5leHQgd2Vla3Mgc2Vzc2lvbikuCgoyLiBSYW5kb21seSBzZWxlY3QgdHdvIGNlbGxzLCBzdW0gdGhlaXIgY291bnRzIGFuZCBub3JtYWxpemUsIGFuZCBwcm9qZWN0IAppbnRvIFBDQSBzcGFjZSBmcm9tIHN0ZXAgMS4gSW4gb3RoZXIgd29yZHMsIGFydGlmaWNpYWxseSBnZW5lcmF0ZSBkb3VibGV0cyBhbmQKc2VlIHdoZXJlIHRoZXkgYXJlIGxvY2F0ZWQgaW4gdGhlIDJEIHNwYWNlLgoKMy4gUmVwZWF0IHN0ZXAgMiBtYW55IHRpbWVzIChnZW5lcmF0ZSBtYW55IGFydGlmaWNpYWwgZG91YmxldHMpLgoKNC4gR2VuZXJhdGUgbmVpZ2hib3IgbmV0d29yayBpbiB0aGUgMkQgc3BhY2UuIFRoZSBuZXR3b3JrIGlzIHRoZW4gdXNlZCB0byAKZXN0aW1hdGUgYSBudW1iZXIgb2YgY2hhcmFjdGVyaXN0aWNzIGZvciBlYWNoIGNlbGwsIGluIHBhcnRpY3VsYXIgdGhlIHByb3BvcnRpb24gCmYgYXJ0aWZpY2lhbCBkb3VibGV0cyBhbW9uZyB0aGUgbmVhcmVzdCBuZWlnaGJvcnMuCgo1LiBVc2UgdGhpcyBpbmZvcm1hdGlvbiwgYWxvbmcgd2l0aCBvdGhlciBwcmVkaWN0b3JzLCB0byB0cmFpbiBhIGNsYXNzaWZpZXIKKGdyYWRpZW50IGJvb3N0ZWQgdHJlZSkgdGhhdCBhbGxvd3MgZm9yIGRpc3Rpbmd1aXNoaW5nIGRvdWJsZXRzIGZyb20gc2luZ2xldHMuCgpOb3RlOiBvbmx5IGNsYXNzaWZpZXMgZm9yIGlkZW50aWZ5aW5nIGRvdWJsZXRzIGZvciB3aGljaCB0aGUgdHdvIGNlbGxzCmFyZSBmcm9tIGRpZmZlcmVudCBjZWxsIHR5cGUgY2x1c3RlcnMuCgoKYGBge3IsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CiMjIHBlcmZvcm0gZG91YmxldCBkZXRlY3Rpb24KbGlicmFyeShzY0RibEZpbmRlcikKYGBgCgpgYGB7cn0Kc2V0LnNlZWQoMjExMTAzKQpzYW1wbGVJRCA8LSB1bmxpc3QobGFwcGx5KHN0cnNwbGl0KGNvbERhdGEoc2NlKSRjZWxsLmlkLCBzcGxpdD0iXyIpLCAiW1siLCAxKSkKdGFibGUoc2FtcGxlSUQpCnNjZSA8LSBzY0RibEZpbmRlcihzY2UsIAogICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZT0idGFibGUiLAogICAgICAgICAgICAgICAgICAgc2FtcGxlcyA9IGZhY3RvcihzYW1wbGVJRCkpCnRhYmxlKHNjZSRzY0RibEZpbmRlci5jbGFzcykKCgojIyB2aXN1YWxpemUgdGhlc2Ugc2NvcmVzCiMjIGV4cGxvcmUgZG91YmxldCBzY29yZSB3cnQgb3JpZ2luYWwgY2x1c3RlciBsYWJlbHMKYm94cGxvdChsb2cxcChzY2Ukc2NEYmxGaW5kZXIuc2NvcmUpIH4gZmFjdG9yKGNvbERhdGEoc2NlKSRjbHVzdGVyLCBleGNsdWRlPU5VTEwpKQoKdGFiIDwtIHRhYmxlKHNjZSRzY0RibEZpbmRlci5jbGFzcywgc2NlJGNsdXN0ZXIsIAogICAgICBleGNsdWRlPU5VTEwpCnRhYgp0KHQodGFiKSAvIGNvbFN1bXModGFiKSkKCmJhcnBsb3QodCh0KHRhYikgLyBjb2xTdW1zKHRhYikpWzIsXSwKICAgICAgICB4bGFiID0gIkNsdXN0ZXIiLCB5bGFiID0gIkZyYWN0aW9uIG9mIGRvdWJsZXRzIikKCnJhbmdlKHNjZSRzY0RibEZpbmRlci5zY29yZVtzY2Ukc2NEYmxGaW5kZXIuY2xhc3MgID09ICJkb3VibGV0IiAmIHNhbXBsZUlEID09ICJyMSJdKQpyYW5nZShzY2Ukc2NEYmxGaW5kZXIuc2NvcmVbc2NlJHNjRGJsRmluZGVyLmNsYXNzICA9PSAic2luZ2xldCIgJiBzYW1wbGVJRCA9PSAicjEiXSkKYGBgCgpgYGB7cn0KIyByZW1vdmUgZG91YmxldHMKc2NlIDwtIHNjZVssIXNjZSRzY0RibEZpbmRlci5jbGFzcyA9PSAiZG91YmxldCJdCmBgYAoKIyBOb3JtYWxpemF0aW9uCgpOb3JtYWxpemF0aW9uIGFpbXMgdG8gcmVtb3ZlIHRlY2huaWNhbCBlZmZlY3RzIHN1Y2ggYXMgc2VxdWVuY2luZyBkZXB0aCBzbyB0aGF0IApjb21wYXJpc29ucyBiZXR3ZWVuIGNlbGxzIGFyZSBub3QgY29uZm91bmRlZCBieSB0aGVtLiBUaGUgbW9zdCBjb21tb25seSB1c2VkIApub3JtYWxpemF0aW9uIG1ldGhvZHMgbWV0aG9kcyB1c2Ugc2NhbGluZywgd2hlcmUgYSBzY2FsaW5nIGZhY3RvciAoYWxzbyBjYWxsZWQgCnNpemUgZmFjdG9yLCBub3JtYWxpemF0aW9uIGZhY3RvcikgaXMgZXN0aW1hdGVkIGZvciBlYWNoIGNlbGwuIFRoZXNlIHNjYWxpbmcgCmZhY3RvcnMgKGUuZy4sIHRoZSBlZmZlY3RpdmUgbGlicmFyeSBzaXplKSBjYW4gYmUgaW5jbHVkZWQgYXMgYW4gb2Zmc2V0CnRvIGRvd25zdHJlYW0gbW9kZWxpbmcgcHJvY2VkdXJlcy4gVGhpcyBlZmZlY3RpdmVseSBhbGxvd3MgZm9yIHBlcmZvcm1pbmcKaW5mZXJlbmNlIG9uIHRoZSByZWxhdGl2ZSBhYnVuZGFuY2Ugb2YgYSBnZW5lIGluIGEgY2VsbCwgYWZ0ZXIgYWNjb3VudGluZyBmb3IgCmxpYnJhcnkgc2l6ZSBhbmQgUk5BIGNvbXBvc2l0aW9uIGRpZmZlcmVuY2VzIGJldHdlZW4gY2VsbHMsIHdoaWNoIGlzIG11Y2ggbW9yZQpyZWxldmFudCB0aGFuIGNvbXBhcmluZyByYXcgY291bnRzCgpGb3Igbm9ybWFsaXphdGlvbiwgdGhlIHNpemUgZmFjdG9ycyAkc19pJCBjb21wdXRlZCBoZXJlIGFyZSBzaW1wbHkgc2NhbGVkIApsaWJyYXJ5IHNpemVzOgpcWyBOX2kgPSBcc3VtX2cgWV97Z2l9IFxdClxbIHNfaSA9IE5faSAvIFxiYXJ7Tn1faSBcXQoKYGBge3J9CnNjZSA8LSBsb2dOb3JtQ291bnRzKHNjZSkKCiMgbm90ZSB3ZSBhbHNvIHJldHVybmVkIGxvZyBjb3VudHM6IHNlZSB0aGUgYWRkaXRpb25hbCBsb2djb3VudHMgYXNzYXkuCnNjZQoKIyB5b3UgY2FuIGV4dHJhY3Qgc2l6ZSBmYWN0b3JzIHVzaW5nCnNmIDwtIGxpYnJhcnlTaXplRmFjdG9ycyhzY2UpCm1lYW4oc2YpICMgZXF1YWwgdG8gMSBkdWUgdG8gc2NhbGluZy4KcGxvdCh4PSBsb2coY29sU3Vtcyhhc3NheXMoc2NlKSRjb3VudHMpKSwgCiAgICAgeT1zZikKYGBgCgpGcm9tIHRoZSBPU0NBIGJvb2s6CkFsdGVybmF0aXZlbHksIHdlIG1heSB1c2UgbW9yZSBzb3BoaXN0aWNhdGVkIGFwcHJvYWNoZXMgZm9yIHZhcmlhbmNlIHN0YWJpbGl6aW5nIAp0cmFuc2Zvcm1hdGlvbnMgaW4gZ2Vub21pY3MgZGF0YSwgZS5nLiwgYERFU2VxMmAgb3IgYHNjdHJhbnNmb3JtYC4gVGhlc2UgYWltIAp0byByZW1vdmUgdGhlIG1lYW4tdmFyaWFuY2UgdHJlbmQgbW9yZSBlZmZlY3RpdmVseSB0aGFuIHRoZSBzaW1wbGVyIAp0cmFuc2Zvcm1hdGlvbnMgbWVudGlvbmVkIGFib3ZlLCB0aG91Z2ggaXQgY291bGQgYmUgYXJndWVkIHdoZXRoZXIgdGhpcyBpcyAKYWN0dWFsbHkgZGVzaXJhYmxlLiBGb3IgbG93LWNvdmVyYWdlIHNjUk5BLXNlcSBkYXRhLCB0aGVyZSB3aWxsIGFsd2F5cyBiZSBhIAptZWFuLXZhcmlhbmNlIHRyZW5kIHVuZGVyIGFueSB0cmFuc2Zvcm1hdGlvbiwgZm9yIHRoZSBzaW1wbGUgcmVhc29uIHRoYXQgdGhlIAp2YXJpYW5jZSBtdXN0IGJlIHplcm8gd2hlbiB0aGUgbWVhbiBjb3VudCBpcyB6ZXJvLiBUaGVzZSBtZXRob2RzIGFsc28gZmFjZSB0aGUgCmNoYWxsZW5nZSBvZiByZW1vdmluZyB0aGUgbWVhbi12YXJpYW5jZSB0cmVuZCB3aGlsZSBwcmVzZXJ2aW5nIHRoZSBpbnRlcmVzdGluZyAKY29tcG9uZW50IG9mIHZhcmlhdGlvbiwgaS5lLiwgdGhlIGxvZy1mb2xkIGNoYW5nZXMgYmV0d2VlbiBzdWJwb3B1bGF0aW9uczsgdGhpcyAKbWF5IG9yIG1heSBub3QgYmUgZG9uZSBhZGVxdWF0ZWx5LCBkZXBlbmRpbmcgb24gdGhlIGFnZ3Jlc3NpdmVuZXNzIG9mIAp0aGUgYWxnb3JpdGhtLgoKSW4gcHJhY3RpY2UsIHRoZSBsb2ctdHJhbnNmb3JtYXRpb24gaXMgYSBnb29kIGRlZmF1bHQgY2hvaWNlIGR1ZSB0byBpdHMgCnNpbXBsaWNpdHkgYW5kIGludGVycHJldGFiaWxpdHksIGFuZCBpcyB3aGF0IHdlIHdpbGwgYmUgdXNpbmcgZm9yIGFsbCAKZG93bnN0cmVhbSBhbmFseXNlcy4KCi0tLQoKLS0tIGVuZCBsYWIgc2Vzc2lvbiAxIC0tLQoKLS0tCgojIE5vcm1hbGl6YXRpb24gKGNvbnRpbnVlZCkKCk5vcm1hbGl6YXRpb24gaXMgbmVjZXNzYXJ5IHRvIGNvcnJlY3QgZm9yIHNldmVyYWwgc291cmNlcyBvZiB0ZWNobmljYWwgCnZhcmlhdGlvbjoKCiAtICoqRGlmZmVyZW5jZXMgaW4gc2VxdWVuY2luZyBkZXB0aCoqIGJldHdlZW4gc2FtcGxlcy4gU29tZSBzYW1wbGVzIGdldCAKIHNlcXVlbmNlZCBkZWVwZXIgaW4gdGhlIHNlbnNlIHRoYXQgdGhleSBjb25zaXN0IG9mIG1vcmUgKG1hcHBlZCkgcmVhZHMgYW5kIAogdGhlcmVmb3JlIGNhbiBiZSBjb25zaWRlcmVkIHRvIGNvbnRhaW4gYSBoaWdoZXIgYW1vdW50IG9mIGluZm9ybWF0aW9uLCB3aGljaCAKIHdlIHNob3VsZCBiZSB0YWtpbmcgaW50byBhY2NvdW50LiBJbiBhZGRpdGlvbiwgaWYgYSBzYW1wbGUgaXMgc2VxdWVuY2VkIGRlZXBlciwgCiBpdCBpcyBuYXR1cmFsIHRoYXQgdGhlIGNvdW50cyBmb3IgZWFjaCBnZW5lIHdpbGwgYmUgaGlnaGVyLCBqZW9wYXJkaXppbmcgYSAKIGRpcmVjdCBjb21wYXJpc29uIG9mIHRoZSBleHByZXNzaW9uIGNvdW50cy4KIC0gKipEaWZmZXJlbmNlcyBpbiBSTkEgcG9wdWxhdGlvbiBjb21wb3NpdGlvbioqIGJldHdlZW4gc2FtcGxlcy4gQXMgYW4gZXh0cmVtZSAKIGV4YW1wbGUsIHN1cHBvc2UgdGhhdCB0d28gc2FtcGxlcyBoYXZlIGJlZW4gc2VxdWVuY2VkIHRvIHRoZSBleGFjdCBzYW1lIGRlcHRoLgogT25lIHNhbXBsZSBpcyBjb250YW1pbmF0ZWQgYW5kIGhhcyBhIHZlcnkgaGlnaCBjb25jZW50cmF0aW9uIG9mIHRoZSAKIGNvbnRhbWluYW50IGNETkEgYmVpbmcgc2VxdWVuY2VkLCBidXQgb3RoZXJ3aXNlIHRoZSB0d28gc2FtcGxlcyBhcmUgaWRlbnRpY2FsLiAKIFNpbmNlIHRoZSBjb250YW1pbmFudCB3aWxsIGJlIHRha2luZyB1cCBhIHNpZ25pZmljYW50IHByb3BvcnRpb24gb2YgdGhlIHJlYWRzIAogYmVpbmcgc2VxdWVuY2VkLCB0aGUgY291bnRzIHdpbGwgbm90IGJlIGRpcmVjdGx5IGNvbXBhcmFibGUgYmV0d2VlbiB0aGUgCiBzYW1wbGVzLiBIZW5jZSwgd2UgbWF5IGFsc28gd2FudCB0byBjb3JyZWN0IGZvciBkaWZmZXJlbmNlcyBpbiB0aGUgY29tcG9zaXRpb24gCiBvZiB0aGUgUk5BIHBvcHVsYXRpb24gb2YgdGhlIHNhbXBsZXMgCiAoc2VlIFtlZGdlUiBtYW51YWwgY2hhcHRlciAyLjhdKGh0dHBzOi8vd3d3LmJpb2NvbmR1Y3Rvci5vcmcvcGFja2FnZXMvcmVsZWFzZS9iaW9jL3ZpZ25ldHRlcy9lZGdlUi9pbnN0L2RvYy9lZGdlUlVzZXJzR3VpZGUucGRmKSkuCiAtICoqT3RoZXIgdGVjaG5pY2FsIHZhcmlhdGlvbioqIHN1Y2ggYXMgc2FtcGxlLXNwZWNpZmljIEdDLWNvbnRlbnQgb3IgCiB0cmFuc2NyaXB0IGxlbmd0aCBlZmZlY3RzIG1heSBhbHNvIGJlIGFjY291bnRlZCBmb3IuCiAKYGBge3J9CnRhYmxlKHNjZSRjbHVzdGVyKQpgYGAKCkJlbG93LCB3ZSB3aWxsIHZpc3VhbGl6ZSB0aGUgbm9ybWFsaXphdGlvbiBvY2N1cnJpbmcgYmV0d2VlbiB0d28gY2VsbHMgb2YgdGhlIApzYW1lIGNlbGwgdHlwZSAod2hpY2ggY291bGQgYmUgY29uc2lkZXJlZCB0ZWNobmljYWwgcmVwZWF0cyk6IAoKYGBge3J9CnNlbGVjdCA8LSBzY2UkY2x1c3RlciA9PSAiMSIKc2VsZWN0W2lzLm5hKHNlbGVjdCldIDwtIEZBTFNFCmNzIDwtIGNvbFN1bXMoYXNzYXlzKHNjZSkkY291bnRzWyxzZWxlY3RdKQpjc1tvcmRlcihjcywgZGVjcmVhc2luZyA9IFRSVUUpXVtjKDEsMTApXQpgYGAKCkxldOKAmXMgdGFrZSBhIGxvb2sgYXQgaG93IGNvbXBhcmFibGUgdHdvIGNlbGxzIChyZXBsaWNhdGVzKSBvZiBjbHVzdGVyIDEgYXJlLiAKV2Ugd2lsbCBjb21wYXJlIHRoZSBjZWxsIHdpdGggdGhlIGhpZ2hlc3QgbGlicmFyeSBzaXplIHdpdGggdGhlIGNlbGwgdGhhdCBoYXMgCnRoZSAxMHRoIGhpZ2hlc3QgbGlicmFyeSBzaXplIHVzaW5nIE1ELXBsb3RzIChtZWFuLWRpZmZlcmVuY2UgcGxvdHMsIGFzIAppbnRyb2R1Y2VkIGJ5IApbRHVkb2l0IGV0IGFsLiAoMjAwMildKGh0dHBzOi8vd3d3LmpzdG9yLm9yZy9zdGFibGUvMjQzMDcwMzg/c2VxPTEjbWV0YWRhdGFfaW5mb190YWJfY29udGVudHMpKSwgCmFsc28gc29tZXRpbWVzIHJlZmVycmVkIHRvIGFzIE1BLXBsb3RzLgoKYGBge3J9CnRhcmdldENlbGxzIDwtIG5hbWVzKGNzW29yZGVyKGNzLCBkZWNyZWFzaW5nID0gVFJVRSldW2MoMSwxMCldKQoKTSA8LSByb3dNZWFucyhhc3NheXMoc2NlKSRjb3VudHNbLHRhcmdldENlbGxzXSkKRCA8LSBhc3NheXMoc2NlKSRjb3VudHNbLHRhcmdldENlbGxzWzJdXSAvIGFzc2F5cyhzY2UpJGNvdW50c1ssdGFyZ2V0Q2VsbHNbMV1dCnBsb3QoeCA9IGxvZyhNKSwgeSA9IGxvZzIoRCksCiAgICAgcGNoID0gMTYsIGNleD0xLzMsCiAgICAgbWFpbiA9IHBhc3RlMCgiQ2VsbCAiLCB0YXJnZXRDZWxsc1syXSwgIiB2cyBjZWxsICIsIHRhcmdldENlbGxzWzFdKSwKICAgICB4bGFiID0gIkxvZyBtZWFuIiwgeWxhYiA9ICJMb2cyIGZvbGQtY2hhbmdlIiwKICAgICBidHkgPSAnbCcpCmFibGluZShoID0gMCwgY29sPSJvcmFuZ2UiLCBsd2Q9MikKCmBgYAoKV2Ugc2VlIGNsZWFyIGJpYXMgaW4gdGhlIGNvbXBhcmlzb24gb2YgdGhlIDFzdCBhbmQgMTB0aCBtb3N0IGRlZXBseSBzZXF1ZW5jZWQgCmNlbGwgZnJvbSBjZWxsIGNsdXN0ZXIgMS4gV2Ugc2VlIHRoYXQgdGhlIGxvZyBmb2xkLWNoYW5nZXMgYXJlIGJpYXNlZCBkb3dud2FyZHMuIApUaGlzIG1lYW5zIHRoYXQsIG9uIGF2ZXJhZ2UsIGEgZ2VuZSBpcyBoaWdoZXIgZXhwcmVzc2VkIGluIGNlbGwgMSB2ZXJzdXMgY2VsbCAxMC4KTG9va2luZyBhdCB0aGUgbGlicmFyeSBzaXplcywgd2UgY2FuIGluZGVlZCBzZWUgdGhhdCB0aGUgbGlicmFyeSBzaXplIGZvciAKY2VsbCAxIGlzIDIwODY5IGNvdW50cywgd2hpbGUgaXQgaXMgb25seSAxNDcxOSBjb3VudHMgZm9yIGNlbGwgMTAhIFRoaXMgaXMgYQpjbGVhciBsaWJyYXJ5IHNpemUgZWZmZWN0IHRoYXQgd2Ugc2hvdWxkIHRha2UgaW50byBhY2NvdW50LgoKYGBge3J9CiMgbm9ybWFsaXplIHRoZSBjb3VudCBkYXRhIHVzaW5nIHRoZSBwcmV2aW91c2x5IGNvbXB1dGVkICJzaXplIGZhY3RvcnMiCmFzc2F5KHNjZSwgIm5vcm1lZCIpIDwtIG5vcm1hbGl6ZUNvdW50cyhzY2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nPUZBTFNFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZS5mYWN0b3JzPXNjZSRzaXplRmFjdG9yLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBzZXVkby5jb3VudD0wKQoKTSA8LSByb3dNZWFucyhhc3NheXMoc2NlKSRub3JtZWRbLHRhcmdldENlbGxzXSkKRCA8LSBhc3NheXMoc2NlKSRub3JtZWRbLHRhcmdldENlbGxzWzJdXSAvIGFzc2F5cyhzY2UpJG5vcm1lZFssdGFyZ2V0Q2VsbHNbMV1dCnBsb3QoeCA9IGxvZyhNKSwgeSA9IGxvZzIoRCksCiAgICAgcGNoID0gMTYsIGNleD0xLzMsCiAgICAgbWFpbiA9IHBhc3RlMCgiQ2VsbCAiLCB0YXJnZXRDZWxsc1syXSwgIiB2cyBjZWxsICIsIHRhcmdldENlbGxzWzFdKSwKICAgICB4bGFiID0gIkxvZyBtZWFuIiwgeWxhYiA9ICJMb2cyIGZvbGQtY2hhbmdlIiwKICAgICBidHkgPSAnbCcpCmFibGluZShoID0gMCwgY29sPSJvcmFuZ2UiLCBsd2Q9MikKYGBgCgpVcG9uIG5vcm1hbGl6aW5nIHRoZSBkYXRhIHVzaW5nIHNpemUgZmFjdG9ycywgd2UgaGF2ZSByZW1vdmVkIGJpYXMgYXMgYQpjb25zZXF1ZW5jZSBvZiBkaWZmZXJlbmNlcyBpbiBzZXF1ZW5jaW5nIGRlcHRoLgoKTm90ZSB0aGF0IHdlIGNvbXB1dGVkIHRoZSBub3JtYWxpemVkIGNvdW50IG1hdHJpeCBvbmx5IGZvciBkZW1vbnN0cmF0aW5nIHRoZQplZmZlY3Qgb2Ygc3VjaCBub3JtYWxpemF0aW9uLiBJbiBhIHR5cGljYWwgd29ya2Zsb3csIHRoZSBzaXplIGZhY3RvcnMgYXJlIHVzZWQKYXMgb2Zmc2V0cyBpbiB0aGUgZG93bnN0cmVhbSBtb2RlbHMgcmF0aGVyIHRoYW4gdG8gcGVyZm9ybSBkYXRhIHRyYW5zZm9ybWF0aW9uLgpJbiBicmllZiwgc3VjaCB0cmFuc2Zvcm1hdGlvbiB3b3VsZCBkaXN0b3J0IHRoZSBtZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcAppbiB0aGUgZGF0YS4gRm9yIG1vcmUgZGV0YWlscywgd2UgcmVmZXIgdG8gdGhlIGRvY3VtZW50IHRoYXQgd2FzIHRvdWNoZWQgdXBvbgppbiB0aGUgZmlyc3QgdGhlb3J5IHNlc3Npb24KKFtsaW5rXShodHRwczovL3N0YXRvbWljcy5naXRodWIuaW8vU0dBMjEvc2VxdWVuY2luZ19zY2FsaW5nTm9ybWFsaXphdGlvbi5odG1sKSkKCiMgRmVhdHVyZSBzZWxlY3Rpb24KCkFzIGRpbWVuc2lvbnMgaW5jcmVhc2UsIHNob3J0ZXN0IGFuZCBmYXJ0aGVzdCBkaXN0YW5jZXMgYmV0d2VlbiBwb2ludHMgYmVjb21lCm5lYXJseSBpbnNlcGFyYWJsZS4gSW4gaGlnaC1kaW1lbnNpb25hbCBzcGFjZSwgaXQgaXMgdGhlcmVmb3JlIGV4dHJlbWVseSAKZGlmZmljdWx0IHRvIHNlcGFyYXRlIHNpZ25hbCBmcm9tIG5vaXNlLgoKSW4gb3JkZXIgdG8gcmVjb3ZlciBzdHJ1Y3R1cmUgKGUuZy4gc2V0dGluZyB1cCBhIGRpbWVuc2lvbi1yZWR1Y2VkCnNwYWNlIHRvIGhlbHAgdXMgZmluZCBjZWxsLXR5cGUgY2x1c3RlcnMgaW4gdGhlIGRhdGEpLCB3ZSB3YW50IHRvIG1vdmUgdG8gYW4KaW5mb3JtYXRpdmUsIGxvd2VyLWRpbWVuc2lvbmFsIHNwYWNlLiBXZSB3aWxsIHNlbGVjdCBnZW5lcyB3aGljaCB3ZSBob3BlIGFyZQppbmZvcm1hdGl2ZSBmb3IgcmVjb3ZlcmluZyB0aGUgYmlvbG9naWNhbCBzdHJ1Y3R1cmUuIEJ1dCB3aGF0IGRlZmluZXMgYW4gCmluZm9ybWF0aXZlIGdlbmU/CgojIyBTZWxlY3RpbmcgZ2VuZXMgd2l0aCBoaWdoIHZhcmlhbmNlCgpUaGUgc2ltcGxlc3QgYXBwcm9hY2ggdG8gcXVhbnRpZnlpbmcgcGVyLWdlbmUgdmFyaWF0aW9uIGlzIHRvIGNvbXB1dGUgdGhlIAp2YXJpYW5jZSBvZiB0aGUgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiB2YWx1ZXMgKGkuZS4sICJsb2ctY291bnRzIikgZm9yIAplYWNoIGdlbmUgYWNyb3NzIGFsbCBjZWxscy4gCgpgYGB7ciwgZXZhbD1GQUxTRX0KIyBjYWxjdWxhdGUgdmFyaWFuY2Ugb2YgbG9nLW5vcm1hbGl6ZWQgY291bnRzIGZvciBlYWNoIGdlbmUKZ2VuZVZhcnMgPC0gZ2VuZWZpbHRlcjo6cm93VmFycyhhc3NheXMoc2NlKSRsb2djb3VudHMpCiMgc2VsZWN0IHRvcCAxMDAwIGhpZ2hseSB2YXJpYWJsZSBnZW5lcwpoaWdoVmFyR2VuZXMgPC0gbmFtZXMoZ2VuZVZhcnMpW29yZGVyKGdlbmVWYXJzLCBkZWNyZWFzaW5nPVRSVUUpWzE6MWUzXV0KaGVhZChoaWdoVmFyR2VuZXMpCmBgYAoKIyMgU2VsZWN0aW5nIGdlbmVzIHdpdGggaGlnaCB2YXJpYXRpb24gd2l0aCByZXNwZWN0IHRvIG1lYW4KCldoaWxlIGNhbGN1bGF0aW9uIG9mIHRoZSBwZXItZ2VuZSB2YXJpYW5jZSBpcyBzaW1wbGUsIGZlYXR1cmUgc2VsZWN0aW9uIHJlcXVpcmVzCm1vZGVsbGluZyBvZiB0aGUgbWVhbi12YXJpYW5jZSByZWxhdGlvbnNoaXAuIEluZGVlZCwgbm90IGFjY291bnRpbmcgZm9yIHRoZSAKbWVhbi12YXJpYW5jZSBzdHJ1Y3R1cmUgd2hpbGUgc2VsZWN0aW5nIGhpZ2hseSB2YXJpYWJsZSBnZW5lcyB3aWxsIG9mdGVudGltZXMgCmJvaWwgZG93biB0byBzZWxlY3RpbmcgdGhlIG1vc3QgaGlnaGx5IGV4cHJlc3NlZCBnZW5lcy4gVGhlIGxvZy10cmFuc2Zvcm1hdGlvbiAKaXMgYSBoZWxwZnVsIHZhcmlhbmNlIHN0YWJpbGl6aW5nIHRyYW5zZm9ybWF0aW9uLCBob3dldmVyLCBpdCBpcyBub3QgcGVyZmVjdCwgCm1lYW5pbmcgdGhhdCB0aGUgdmFyaWFuY2Ugb2YgYSBnZW5lIGlzIG5vdCBjb21wbGV0ZWx5IGluZGVwZW5kZW50IG9mIGl0cyBtZWFuLgpUaGVyZWZvcmUsIGZlYXR1cmUgc2VsZWN0aW9uIG1heSBzdGlsbCBiZSBkcml2ZW4gYnkgYXZlcmFnZSBleHByZXNzaW9uIHJhdGhlciAKdGhhbiB1bmRlcmx5aW5nIGJpb2xvZ2ljYWwgaGV0ZXJvZ2VuZWl0eS4KCkEgKHJpZ2h0bHkgc28pIHBvcHVsYXIgYXBwcm9hY2ggaXMgdG8gc2VsZWN0IGdlbmVzIHRoYXQgaGF2ZSBhIGhpZ2ggdmFyaWFuY2UKd2l0aCByZXNwZWN0IHRvIHRoZWlyIG1lYW4uIE9mdGVuLCBmaXJzdCBhbiBlbXBpcmljYWwgbWVhbi12YXJpYW5jZSB0cmVuZCBpcwpmaXR0ZWQsIHVwb24gd2hpY2ggZ2VuZXMgd2l0aCB0aGUgaGlnaGVzdCBwb3NpdGl2ZSByZXNpZHVhbHMgYXJlIHNlbGVjdGVkLiAKQmVpbmcgaW50dWl0aXZlLCByZWFzb25hYmxlIGFuZCBmYWlybHkgc3RyYWlnaHQtZm9yd2FyZCwgdGhpcyBtZXRob2QgaXMgd2lkZWx5CnVzZWQuCgpUbyBhY2NvdW50IGZvciB0aGUgbWVhbi12YXJpYW5jZSBlZmZlY3QsIHdlIHVzZSB0aGUgYG1vZGVsR2VuZVZhcmAgZnVuY3Rpb24gb2YKdGhlIGBzY3JhbmAgcGFja2FnZSB0byBmaXQgYSB0cmVuZCB0byB0aGUgdmFyaWFuY2Ugd2l0aCByZXNwZWN0IHRvIGFidW5kYW5jZQphY3Jvc3MgYWxsIGdlbmVzIChvbiBsb2ctbm9ybWFsaXplZCBleHByZXNzaW9uIHZhbHVlcyBvZiB0aGUgc2NlIG9iamVjdCkuCgpgYGB7cn0KbGlicmFyeShzY3JhbikKZGVjIDwtIG1vZGVsR2VuZVZhcihzY2UpCmhlYWQoZGVjKQpgYGAKClRoZSBmaXR0ZWQgdmFsdWUgZm9yIGVhY2ggZ2VuZSBpcyB1c2VkIGFzIGEgcHJveHkgZm9yIHRoZSB0ZWNobmljYWwgY29tcG9uZW50IG9mCnZhcmlhdGlvbiBmb3IgZWFjaCBnZW5lLCB1bmRlciB0aGUgYXNzdW1wdGlvbiB0aGF0IG1vc3QgZ2VuZXMgZXhoaWJpdCBhIGxvdwpiYXNlbGluZSBsZXZlbCBvZiB2YXJpYXRpb24gdGhhdCBpcyBub3QgYmlvbG9naWNhbGx5IGludGVyZXN0aW5nLiBUaGUgYmlvbG9naWNhbApjb21wb25lbnQgb2YgdmFyaWF0aW9uIGZvciBlYWNoIGdlbmUgaXMgZGVmaW5lZCBhcyB0aGUgdGhlIHJlc2lkdWFsIGZyb20gdGhlCnRyZW5kLiBSYW5raW5nIGdlbmVzIGJ5IHRoZSBiaW9sb2dpY2FsIGNvbXBvbmVudCBlbmFibGVzIGlkZW50aWZpY2F0aW9uIG9mCmludGVyZXN0aW5nIGdlbmVzIGZvciBkb3duc3RyZWFtIGFuYWx5c2VzIGluIGEgbWFubmVyIHRoYXQgYWNjb3VudHMgZm9yIHRoZQptZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcC4KCmBgYHtyfQpmaXRSZXRpbmEgPC0gbWV0YWRhdGEoZGVjKQpwbG90KGZpdFJldGluYSRtZWFuLCBmaXRSZXRpbmEkdmFyLCAKICAgICB4bGFiPSJNZWFuIG9mIGxvZy1leHByZXNzaW9uIiwKICAgIHlsYWI9IlZhcmlhbmNlIG9mIGxvZy1leHByZXNzaW9uIikKY3VydmUoZml0UmV0aW5hJHRyZW5kKHgpLCBjb2w9ImRvZGdlcmJsdWUiLCBhZGQ9VFJVRSwgbHdkPTIpCmBgYAoKV2UgYXJlIGludGVyZXN0ZWQgaW4gdGhvc2UgZ2VuZXMgZm9yIHdoaWNoIHRoZSB2YXJpYW5jZSBpbiBleHByZXNzaW9uIGlzIGhpZ2hlcgp0aGFuIHdoYXQgd2Ugd291bGQgZXhwZWN0IGZvciB0aGF0IGdlbmUgYmFzZWQgb24gaXRzIG1lYW4gZXhwcmVzc2lvbi4KCmBgYHtyfQojIGdldCAxMCUgbW9zdCB2YXJpYWJsZSBnZW5lcwpodmcgPC0gZ2V0VG9wSFZHcyhkZWMsIAogICAgICAgICAgICAgICAgICBwcm9wPTAuMSkKaGVhZChodmcpCgojIHBsb3QgdGhlc2UgCnBsb3QoZml0UmV0aW5hJG1lYW4sIGZpdFJldGluYSR2YXIsIAogICAgIGNvbCA9IGMoIm9yYW5nZSIsICJkYXJrc2VhZ3JlZW4zIilbKG5hbWVzKGZpdFJldGluYSRtZWFuKSAlaW4lIGh2ZykrMV0sCiAgICAgeGxhYj0iTWVhbiBvZiBsb2ctZXhwcmVzc2lvbiIsCiAgICB5bGFiPSJWYXJpYW5jZSBvZiBsb2ctZXhwcmVzc2lvbiIpCmN1cnZlKGZpdFJldGluYSR0cmVuZCh4KSwgY29sPSJkb2RnZXJibHVlIiwgYWRkPVRSVUUsIGx3ZD0yKQpsZWdlbmQoInRvcGxlZnQiLCAKICAgICAgIGxlZ2VuZCA9IGMoIlNlbGVjdGVkIiwgIk5vdCBzZWxlY3RlZCIpLCAKICAgICAgIGNvbCA9IGMoImRhcmtzZWFncmVlbjMiLCAib3JhbmdlIiksCiAgICAgICBwY2ggPSAxNiwKICAgICAgIGJ0eT0nbicpCmBgYAoKQXMgYSBjb21wYXJpc29uLCB3ZSBjb3VsZCBjb2xvciB0aGUgZ2VuZXMgb24gdGhpcyBmaWd1cmUgYWNjb3JkaW5nIHRvIHRoZSAKc2VsZWN0aW9uIHRoYXQgd2FzIG1hZGUgcHVyZWx5IGJ5IGxvb2tpbmcgYXQgdGhlIHJhdyB2YXJpYW5jZSBvZiBlYWNoIGdlbmUuCgpgYGB7ciwgZXZhbD1GQUxTRX0KcGxvdChmaXRSZXRpbmEkbWVhbiwgZml0UmV0aW5hJHZhciwgCiAgICAgY29sID0gYygib3JhbmdlIiwgInN0ZWVsYmx1ZSIpWyhuYW1lcyhmaXRSZXRpbmEkbWVhbikgJWluJSBoaWdoVmFyR2VuZXMpKzFdLAogICAgIHhsYWI9Ik1lYW4gb2YgbG9nLWV4cHJlc3Npb24iLAogICAgeWxhYj0iVmFyaWFuY2Ugb2YgbG9nLWV4cHJlc3Npb24iKQpjdXJ2ZShmaXRSZXRpbmEkdHJlbmQoeCksIGNvbD0iZG9kZ2VyYmx1ZSIsIGFkZD1UUlVFLCBsd2Q9MikKbGVnZW5kKCJ0b3BsZWZ0IiwgCiAgICAgICBsZWdlbmQgPSBjKCJTZWxlY3RlZCIsICJOb3Qgc2VsZWN0ZWQiKSwgCiAgICAgICBjb2wgPSBjKCJzdGVlbGJsdWUiLCAib3JhbmdlIiksCiAgICAgICBwY2ggPSAxNiwKICAgICAgIGJ0eT0nbicpCmBgYAoKQXMgZXhwZWN0ZWQsIHdlIGhlcmUgc2ltcGx5IHNlbGVjdCBnZW5lcyB3aXRoIGEgaGlnaCB2YXJpYW5jZSwgd2l0aG91dCAKcmVjb2duaXppbmcgdGhhdCBhIGhpZ2ggdmFyaWFuY2UgaXMgdHlwaWNhbGx5IGRyaXZlbiBieSBhIGhpZ2ggbWVhbi4KCiMjIEhpZ2ggZGV2aWFuY2UgZ2VuZXMKCkhlcmUsIHdlIHdpbGwgc2VsZWN0IGdlbmVzIHdpdGggYSBoaWdoIHJlc2lkdWFsIGRldmlhbmNlLiBUaGUgaWRlYSBpcyB0aGF0IHdlIAphc3N1bWUgYSBudWxsIG1vZGVsIG9mIGNvbnN0YW50IGV4cHJlc3Npb24gZnJhY3Rpb24gKGkuZS4sIFJOQSBjb25jZW50cmF0aW9uKSAKYWNyb3NzIGFsbCBjZWxscy4gV2Ugc3Vic2VxdWVudGx5IGNhbGN1bGF0ZSBhIGdvb2RuZXNzLW9mLWZpdCBzdGF0aXN0aWMgZm9yIAplYWNoIGdlbmUsIGFzc2Vzc2luZyB3aGV0aGVyIHRoZSBtb2RlbCBpcyBhIGdvb2QgYXBwcm94aW1hdGlvbiB0byB0aGUgZ2VuZSAKZXhwcmVzc2lvbiBvZiB0aGUgY29ycmVzcG9uZGluZyBnZW5lLgoKSWYgdGhlIG1vZGVsIGZpdHMgcG9vcmx5LCBpLmUuLCB0aGUgZ2VuZSBoYXMgYSBoaWdoIGRldmlhbmNlLCB0aGUgZXhwcmVzc2lvbiAKZnJhY3Rpb24gdmFyaWVzIHNpZ25pZmljYW50bHkgYWNyb3NzIHRoZSBjZWxscyBpbiBvdXIgZGF0YXNldHMuR2VuZXMgd2l0aCBhIApoaWdoIGRldmlhbmNlIHdpbGwgdGh1cyBtb3N0IHBvb3JseSBmaXQgYSBudWxsIG1vZGVsIHdoZXJlIHRoZSByZWxhdGl2ZQphYnVuZGFuY2UgaXMgZXF1YWwgZm9yIGFsbCBjZWxscywgd2hpY2ggdGhlcmVmb3JlIGFyZSBpbmZvcm1hdGl2ZS4KCmBgYHtyfQojQmlvY01hbmFnZXI6Omluc3RhbGwoInNjcnkiKQpsaWJyYXJ5KHNjcnkpCnNjZSA8LSBkZXZpYW5jZUZlYXR1cmVTZWxlY3Rpb24ob2JqZWN0ID0gc2NlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NheSA9ICJjb3VudHMiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0ZWQgPSBGQUxTRSkKCnBsb3Qoc29ydChyb3dEYXRhKHNjZSkkYmlub21pYWxfZGV2aWFuY2UsIGRlY3JlYXNpbmcgPSBUUlVFKSwgCiAgICAgdHlwZT0ibCIsIAogICAgIHhsYWI9InJhbmtlZCBnZW5lcyIsIAogICAgIHlsYWI9ImJpbm9taWFsIGRldmlhbmNlIiwgCiAgICAgbWFpbj0iRmVhdHVyZSBTZWxlY3Rpb24gd2l0aCBEZXZpYW5jZSIpCmFibGluZSh2PTIwMDAsIGx0eT0yLCBjb2w9InJlZCIpCmBgYAoKT3VyIHBsb3QgbG9va3Mgc2ltaWxhciB0byBvbmUgZGlzcGxheWVkIGluIHRoZSAKW3ZpZ25ldHRlIG9mIHRoZSBzY3J5IHBhY2thZ2VdKGh0dHBzOi8vd3d3LmJpb2NvbmR1Y3Rvci5vcmcvcGFja2FnZXMvcmVsZWFzZS9iaW9jL3ZpZ25ldHRlcy9zY3J5L2luc3QvZG9jL3NjcnkuaHRtbCkuIApCYXNlZCBvbiB0aGF0IHBsb3QsIHRoZSBhdXRob3JzIHN1Z2dlc3QgcmV0YWluaW5nIDIuMDAwIGdlbmVzICh0aGUgdG9wIDIwMDAgCmJhc2VkIG9uIHRoZSBkZXZpYW5jZSByZXNpZHVhbHMpIGZvciBkb3duc3RyZWFtIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbiBhbmQgCmNsdXN0ZXJpbmcuCgojIyBTZXVyYXQgVlNUCgpBbm90aGVyIHZlcnkgY29tbW9uIGZlYXR1cmUgc2VsZWN0aW9uIHN0cmF0ZWd5IGlzIHRoZSB2YXJpYW5jZS1zdGFiaWxpemluZwp0cmFuc2Zvcm1hdGlvbiBmcm9tIHRoZSBgU2V1cmF0YCBSIHBhY2thZ2UsIHdoaWNoIGFtb3VudHMgdG8gY2FsY3VsYXRpbmcgUGVhcnNvbgpyZXNpZHVhbHMgZnJvbSBhIHJlZ3VsYXJpemVkIG5lZ2F0aXZlIGJpbm9taWFsIHJlZ3Jlc3Npb24gbW9kZWwsIHdpdGggc2VxdWVuY2luZyAKZGVwdGggYXMgYSBjb3ZhcmlhdGUuCgoqKkludGVybWV6em86IGludGVyb3BlcmFiaWxpdHkgYmV0d2VlbiBTaW5nbGVDZWxsRXhwZXJpbWVudCBhbmQgU2V1cmF0IG9iamVjdHMqKgoKSW4gdGhpcyBsZWN0dXJlIHNlcmllcywgd2UgYWx3YXlzIG1ha2UgdXNlIG9mIHRoZSBTaW5nbGVDZWxsRXhwZXJpbWVudCBvYmplY3QKYW5kIHRoZSBwYWNrYWdlcyBhdmFpbGFibGUgZnJvbSBCaW9jb25kdWN0b3IuIEFub3RoZXIgdmVyeSBwb3B1bGFyIHRvb2xib3gKZm9yIHBlcmZvcm1pbmcgc2NSTkEtc2VxIGRhdGEgYW5hbHlzaXMgaXMgYFNldXJhdGAuIEhvd2V2ZXIsIGZ1bmN0aW9ucyBmcm9tCmBTZXVyYXRgIGNhbm5vdCBiZSB1c2VkIGRpcmVjdGx5IHRvIG1hbmlwdWxhdGUgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3RzLAphbmQgdmljZSB2ZXJzYS4gRm9ydHVuYXRlbHksIGVmZm9ydHMgaGF2ZSBiZWVuIG1hZGUgdG8gaW5jcmVhc2UgdGhlCmludGVyb3BlcmFiaWxpdHkgYmV0d2VlbiB0aGUgdHdvIHRvb2xib3hlcy4KCmBgYHtyfQpsaWJyYXJ5KFNldXJhdCkKc2V1cmF0X29iaiA8LSBhcy5TZXVyYXQoc2NlKQpzZXVyYXRfb2JqICMgbm90aWNlIHRoZSAiMCB2YXJpYWJsZSBmZWF0dXJlcyIKYGBgCgpPbiB0aGlzIG9iamVjdCwgd2UgbWF5IHVzZSBmdW5jdGlvbnMgZnJvbSB0aGUgYFNldXJhdGAgdG9vbGJveC4KRm9yIGluc3RhbmNlLCB3ZSBtYXkgc2VhcmNoIGZvciBoaWdobHkgdmFyaWFibGUgZmVhdHVyZXMgdXNpbmcgYFNldXJhdGAncyBWU1QKaW1wbGVtZW50YXRpb246CgpgYGB7cn0Kc2V1cmF0X29iaiA8LSBTZXVyYXQ6Ok5vcm1hbGl6ZURhdGEoc2V1cmF0X29iaiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb24ubWV0aG9kID0gIkxvZ05vcm1hbGl6ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZS5mYWN0b3IgPSAxMDAwMCkKCnNldXJhdF9vYmogPC0gIEZpbmRWYXJpYWJsZUZlYXR1cmVzKG9iamVjdCA9IHNldXJhdF9vYmosCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5tZXRob2QgPSAidnN0IikKYGBgCgpgYGB7cn0Kc2V1cmF0X29iaiAgIyBub3RpY2UgdGhlICIyMDAwIHZhcmlhYmxlIGZlYXR1cmVzIiAoZGVmYXVsdCkKaGVhZChWYXJpYWJsZUZlYXR1cmVzKHNldXJhdF9vYmopKSAjIGhlcmUgdGhleSBhcmUKYGBgCgojIERpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbgoKTm90ZSB0aGF0LCBiZWxvdywgd2UgY29sb3IgdGhlIGNlbGxzIHVzaW5nIHRoZSBrbm93biwgdHJ1ZSBjZWxsIHR5cGUgbGFiZWwgYXMgCmRlZmluZWQgaW4gdGhlIG1ldGFkYXRhLCB0byBlbXBpcmljYWxseSBldmFsdWF0ZSB0aGUgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uLiAKSW4gcmVhbGl0eSwgd2UgZG9uJ3Qga25vdyB0aGlzIHlldCBhdCB0aGlzIHN0YWdlLgoKIyMgVGhlIG1vc3QgYmFzaWMgRFIKCkp1c3QgYnkgbG9va2luZyBhdCB0aGUgdG9wIHR3byBnZW5lcyBiYXNlZCBvbiBvdXIgZmVhdHVyZSBzZWxlY3Rpb24gY3JpdGVyaW9uLCAKd2UgY2FuIGFscmVhZHkgc2VlIHNvbWUgc2VwYXJhdGlvbiBhY2NvcmRpbmcgdG8gdGhlIGNlbGwgdHlwZSEKCmBgYHtyfQpjb2xEYXRhKHNjZSkkY2x1c3RlciA8LSBhcy5mYWN0b3IoY29sRGF0YShzY2UpJGNsdXN0ZXIpCmNsIDwtIGNvbERhdGEoc2NlKSRjbHVzdGVyCnBhcihidHk9J2wnKQpwbG90KHggPSBhc3NheXMoc2NlKSRjb3VudHNbaHZnWzFdLF0sCiAgICAgeSA9IGFzc2F5cyhzY2UpJGNvdW50c1todmdbMl0sXSwKICAgICBjb2wgPSBhcy5udW1lcmljKGNsKSwKICAgICBwY2ggPSAxNiwgY2V4ID0gMS8zLAogICAgIHhsYWIgPSAiTW9zdCBpbmZvcm1hdGl2ZSBnZW5lIiwKICAgICB5bGFiID0gIlNlY29uZCBtb3N0IGluZm9ybWF0aXZlIGdlbmUiLAogICAgIG1haW4gPSAiQ2VsbHMgY29sb3JlZCBhY2MgdG8gY2VsbCB0eXBlIikKYGBgCgpXZSBhcmUgYWJsZSB0byByZWNvdmVyIHF1aXRlIHNvbWUgc3RydWN0dXJlLiBIb3dldmVyLCBtYW55IGNlbGwgcG9wdWxhdGlvbnMgCnJlbWFpbiBvYnNjdXJlLCBhbmQgdGhlIHBsb3QgaXMgb3ZlcmNyb3dkZWQuCgojIyBMaW5lYXIgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uOiBQQ0EKCkEgRFIgbWV0aG9kIGlzIGxpbmVhciB3aGVuIHRoZSByZWR1Y2VkIGRpbWVuc2lvbnMgYXJlIGEgbGluZWFyIGZ1bmN0aW9uIG9mIHRoZQpvcmlnaW5hbCB2YXJpYWJsZXMuIEZvciBleGFtcGxlLCBpbiBQQ0EsIGVhY2ggcHJpbmNpcGFsIGNvbXBvbmVudCBpcyBhIGxpbmVhcgpjb21iaW5hdGlvbiBvZiBnZW5lcywgdGhlcmVmb3JlIHRoZSBEUiBpcyBhIGxpbmVhciBmdW5jdGlvbiBvZiB0aGUgb3JpZ2luYWwKdmFyaWFibGVzLgoKVHlwaWNhbGx5LCBQQ0EgaXMgcGVyZm9ybWVkIG9uIGxvZy10cmFuc2Zvcm1lZCBub3JtYWxpemVkIGNvdW50cy4gClRoZSBsb2ctdHJhbnNmb3JtYXRpb24gaGVscHMgIHNvbWV3aGF0LCBidXQgbm90IGNvbXBsZXRlbHksIHRvIGFjY291bnQgZm9yIHRoZQptZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcC4gUENBIHdvcmtzIHdlbGwgZm9yIGJ1bGsgUk5BLXNlcSBkYXRhLiBIb3dldmVyLCB0aGUKc3RydWN0dXJlIG9mIHNjUk5BLXNlcSBkYXRhIGlzIG9mdGVuIHRvbyBjb21wbGV4IHRvIGJlIHZpc3VhbGl6ZWQgYnkgYSBzbWFsbCAKbnVtYmVyIG9mIFBDcy4KClRoZXJlIGFyZSBzZXZlcmFsIFIgZnVuY3Rpb25zIHRoYXQgYWxsb3cgeW91IHRvIHBlcmZvcm0gUENBLiBIZXJlLCB3ZSBtYWtlIHVzZQpvZiB0aGUgYHJ1blBDQWAgZnVuY3Rpb24gb2YgdGhlIGBzY2F0ZXJgIHBhY2thZ2UsIHdoaWNoIGhhcyBiZWVuIHNwZWNpZmljYWxseQpkZXZlbG9wZWQgZm9yIHBlcmZvcm1pbmcgUENBIG9uIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0cy4KV2UgY2FsY3VsYXRlIHRoZSB0b3AgMzAgcHJpbmNpcGFsIGNvbXBvbmVudHMuCgojIyMgUENBIHdpdGggZmVhdHVyZSBzZWxlY3Rpb24KCmBgYHtyfQpzZXQuc2VlZCgxMjM0KQpzY2UgPC0gcnVuUENBKHNjZSwgCiAgICAgICAgICAgICAgbmNvbXBvbmVudHM9MzAsIAogICAgICAgICAgICAgIHN1YnNldF9yb3c9aHZnKQpgYGAKClBDQSBoYXMgYmVlbiBwZXJmb3JtZWQuIFRoZSBQQ0EgaW5mb3JtYXRpb24gaGFzIGJlZW4gYXV0b21hdGljYWxseSBzdG9yZWQgaW4gdGhlCipyZWR1Y2VkRGltKiBzbG90IG9mIHRoZSBTaW5nbGVDZWxsRXhwZXJpbWVudCBvYmplY3QuCgpgYGB7cn0KcmVkdWNlZERpbU5hbWVzKHNjZSkKYGBgCgpgYGB7cn0KaGVhZChyZWR1Y2VkRGltKHNjZSwKICAgICAgICAgICB0eXBlPSJQQ0EiKSkKYGBgCgpUaGUgYHBsb3RQQ0FgIGZ1bmN0aW9uIG9mIHRoZSBgc2NhdGVyYCBwYWNrYWdlIG5vdyBhbGxvd3MgdXMgdG8gdmlzdWFsaXplCnRoZSBjZWxscyBpbiBQQ0Egc3BhY2UsIGJhc2VkIG9uIHRoZSBQQ0EgaW5mb3JtYXRpb24gc3RvcmVkIGluIG91ciBvYmplY3Q6CgpgYGB7cn0KcGxvdFBDQShzY2UsIAogICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikKYGBgCgpXaGlsZSB0aGUgbGFyZ2UgbnVtYmVyIG9mIGNsdXN0ZXJzIGluIHRoaXMgZGF0YXNldCBtYWtlcyBpdCBoYXJkIHRvIApkaXN0aW5ndWlzaCBiZXR3ZWVuIGFsbCB0aGUgZGlmZmVyZW50IGNvbG9ycywgd2UgY2FuIGFscmVhZHkgc2VlIHRoYXQgUENBCnJldHJpZXZlcyBzb21lLCBidXQgbm90IGFsbCwgb2YgdGhlIHN0cnVjdHVyZSBpbiB0aGUgZGF0YSB0aGF0IHdhcyBkaXNjb3ZlcmVkCmJ5IHRoZSBvcmlnaW5hbCBhdXRob3JzLgoKSG93IG1hbnkgb2YgdGhlIHRvcCBQQ3Mgc2hvdWxkIHdlIHJldGFpbiBmb3IgZG93bnN0cmVhbSBhbmFseXNlcz8gVGhlIGNob2ljZSBvZgp0aGUgbnVtYmVyIG9mIFBDcyBpcyBhIGRlY2lzaW9uIHRoYXQgaXMgYW5hbG9nb3VzIHRvIHRoZSBjaG9pY2Ugb2YgdGhlIG51bWJlciBvZgpIVkdzIHRvIHVzZS4gVXNpbmcgbW9yZSBQQ3Mgd2lsbCByZXRhaW4gbW9yZSBiaW9sb2dpY2FsIHNpZ25hbCBhdCB0aGUgY29zdCBvZgppbmNsdWRpbmcgbW9yZSBub2lzZSB0aGF0IG1pZ2h0IG1hc2sgc2FpZCBzaWduYWwuIE9uIHRoZSBvdGhlciBoYW5kLCB1c2luZyBmZXdlcgpQQ3Mgd2lsbCBpbnRyb2R1Y2UgY29tcGV0aXRpb24gYmV0d2VlbiBkaWZmZXJlbnQgZmFjdG9ycyBvZiB2YXJpYXRpb24sIHdoZXJlCndlYWtlciAoYnV0IHN0aWxsIGludGVyZXN0aW5nKSBmYWN0b3JzIG1heSBiZSBwdXNoZWQgZG93biBpbnRvIGxvd2VyIFBDcyBhbmQKaW5hZHZlcnRlbnRseSBkaXNjYXJkZWQgZnJvbSBkb3duc3RyZWFtIGFuYWx5c2VzLgoKTW9zdCBhbmFseXN0cyB3aWxsIHNpbXBseSBhaW0gdG8gdXNlIGEg4oCccmVhc29uYWJsZeKAnSBidXQgYXJiaXRyYXJ5IHZhbHVlLAp0eXBpY2FsbHkgcmFuZ2luZyBmcm9tIDEwIHRvIDUwLiBUaGlzIGlzIG9mdGVuIHNhdGlzZmFjdG9yeSBhcyB0aGUgbGF0ZXIgUENzCmV4cGxhaW4gc28gbGl0dGxlIHZhcmlhbmNlIHRoYXQgdGhlaXIgaW5jbHVzaW9uIG9yIG9taXNzaW9uIGhhcyBubyBtYWpvciBlZmZlY3QuCgpgYGB7cn0KcGVyY2VudC52YXIgPC0gYXR0cihyZWR1Y2VkRGltKHNjZSksICJwZXJjZW50VmFyIikKcGxvdChwZXJjZW50LnZhciwgbG9nPSJ5IiwgeGxhYj0iUEMiLCB5bGFiPSJWYXJpYW5jZSBleHBsYWluZWQgKCUpIikKcGxvdChjdW1zdW0ocGVyY2VudC52YXIpLCB4bGFiPSJQQyIsIHlsYWI9IkN1bXVsYXRpdmUgdmFyaWFuY2UgZXhwbGFpbmVkICglKSIpCmBgYAoKSGVyZSwgcmV0YWluaW5nIMKxMTVQQ3Mgc2VlbXMgcmVhc29uYWJsZS4gSWYgeW91IHJlYWxseSBwcmVmZXIgYSBtb3JlIGRhdGEtZHJpdmVuCndheSBmb3IgZGV0ZXJtaW5pbmcgdGhpcywgdGhlcmUgYXJlIHByb2NlZHVyZXMgYXZhaWxhYmxlIHRoYXQgYWltIHRvIApjb21wdXRhdGlvbmFsbHkgaWRlbnRpZnkgdGhlIGVsYm93L2tuZWUgcG9pbnQgaW4gdGhlIHZhcmlhbmNlIGV4cGxhaW5lZCBwZXIgClBDIHBsb3QuCgpgYGB7cn0KbGlicmFyeShQQ0F0b29scykKY2hvc2VuLmVsYm93IDwtIGZpbmRFbGJvd1BvaW50KHBlcmNlbnQudmFyKQpjaG9zZW4uZWxib3cKYGBgCgojIyMgUENBIHdpdGhvdXQgZmVhdHVyZSBzZWxlY3Rpb24KCk5vdGU6IG1vcmUgZmVhdHVyZXMgLT4gY29tcHV0YXRpb25hbGx5IG1vcmUgaW50ZW5zaXZlIQoKYGBge3J9CnNldC5zZWVkKDEyMzQpCnNjZU5vRlMgPC0gcnVuUENBKHNjZSwgCiAgICAgICAgICAgICAgICAgIG5jb21wb25lbnRzPTMwLCAKICAgICAgICAgICAgICAgICAgc3Vic2V0X3Jvdz0xOm5yb3coc2NlKSkKcGxvdFBDQShzY2VOb0ZTLCBjb2xvdXJfYnkgPSAiY2x1c3RlciIpCnJtKHNjZU5vRlMpCmBgYAoKV2hpbGUgd2UgdXNlIG1vcmUgaW5mb3JtYXRpb24gdG8gbWFrZSB0aGlzIFBDQSBwbG90ICgxNy44ODcgZ2VuZXMpIGFzIGNvbXBhcmVkCnRvIHRoZSBmZWF0dXJlIHNlbGVjdGVkIFBDQSBwbG90ICg2NDIgZ2VuZXMpLCB3ZSBzZWVtIHRvIHJldHJpZXZlIGxlc3Mgc3RydWN0dXJlCmluIHRoZSBkYXRhLiBUaGlzIGlzIHRoZSBwb3dlciBvZiBmZWF0dXJlIHNlbGVjdGlvbiwgYW4gaW5jcmVhc2UgaW4gdGhlCnNpZ25hbC10by1ub2lzZSByYXRpbyEKCiMjIyBFZmZlY3Qgb2YgZmVhdHVyZSBzZWxlY3Rpb24gb24gUENBCgpGaXJzdCwgd2UgY29tcGFyZSB0aGUgZGlmZmVyZW50IGZlYXR1cmUgc2VsZWN0aW9uIGNyaXRlcmlhLCB1c2luZyB0aGUgdG9wIDEwMDAKaGlnaGx5IHZhcmlhYmxlIGdlbmVzIGZvciBlYWNoIG1ldGhvZC4KCmBgYHtyfQojIEdldCB0b3AgMTAwMCBoaWdobHkgdmFyaWFibGUgZmVhdHVyZXMgdXNpbmcgdGhlIGhpZ2hseSB2YXJpYWJsZSBnZW5lcwojICh3LnIudC4gbWVhbiksIGhpZ2ggZGV2aWFuY2UgZ2VuZXMgYW5kIHRoZSBWU1Qgc3RyYXRlZ3kgb2YgU2V1cmF0CgpodmcxMDAwIDwtIGdldFRvcEhWR3MoZGVjLCBuID0gMTAwMCkKaGRnMTAwMCA8LSBuYW1lcyhzb3J0KHJvd0RhdGEoc2NlKSRiaW5vbWlhbF9kZXZpYW5jZSwgZGVjcmVhc2luZyA9IFRSVUUpKVsxOjEwMDBdCnZzdDEwMDAgPC0gVmFyaWFibGVGZWF0dXJlcyhzZXVyYXRfb2JqKVsxOjEwMDBdCgojIEhWRyBzdHJhdGVneQpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcxMDAwKSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpICsKICBnZ3RpdGxlKCJIaWdobHkgdmFyaWFibGUgZ2VuZXMiKQoKIyBIREcgc3RyYXRlZ3kKcGxvdFBDQSgKICAgIHJ1blBDQShzY2UsCiAgICAgICAgICAgbmNvbXBvbmVudHMgPSAyLCAKICAgICAgICAgICBzdWJzZXRfcm93ID0gaGRnMTAwMCksIAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKSArCiAgZ2d0aXRsZSgiSGlnaC1kZXZpYW5jZSBnZW5lcyIpCgojIFZTVCBzdHJhdGVneQpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsCiAgICAgICAgICAgc3Vic2V0X3JvdyA9IHZzdDEwMDApLAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiLAogICAgKSArCiAgZ2d0aXRsZSgiU2V1cmF0IFZTVCIpCmBgYAoKTmV4dCwgd2UgYXNzZXNzIHRoZSBzZW5zaXRpdml0eSBvbiB0aGUgbnVtYmVyIG9mIHRvcCBmZWF0dXJlcyBmb3IgdGhlIGhpZ2hseQp2YXJpYWJsZSBnZW5lcyBtZXRob2Q7CgpgYGB7cn0KaHZnX2FsbCA8LSBnZXRUb3BIVkdzKGRlYykKCmh2ZzIwMDAgPC0gaHZnX2FsbFsxOjIwMDBdCmh2ZzEwMDAgPC0gaHZnX2FsbFsxOjEwMDBdCmh2ZzEwMCA8LSBodmdfYWxsWzE6MTAwXQpodmcxMCA8LSBodmdfYWxsWzE6MTBdCmh2ZzUgPC0gaHZnX2FsbFsxOjVdCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIpLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIkFsbCBnZW5lcyIpCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcyMDAwKSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpICsKICBnZ3RpdGxlKCJUb3AgMjAwMCBnZW5lcyIpCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcxMDAwKSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpICsKICBnZ3RpdGxlKCJUb3AgMTAwMCBnZW5lcyIpCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcxMDApLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIlRvcCAxMDAgZ2VuZXMiKQoKcGxvdFBDQSgKICAgIHJ1blBDQShzY2UsCiAgICAgICAgICAgbmNvbXBvbmVudHMgPSAyLCAKICAgICAgICAgICBzdWJzZXRfcm93ID0gaHZnMTApLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIlRvcCAxMCBnZW5lcyIpCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmc1KSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpICsKICBnZ3RpdGxlKCJUb3AgNSBnZW5lcyIpCmBgYAoKIyMjIFJlbWFya3Mgb24gUENBCgpWaXN1YWxpemF0aW9ucyBvZiByZWR1Y2VkIGRpbWVuc2lvbnMgZnJvbSBsaW5lYXIgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uCm1ldGhvZHMgYXJlIG9mdGVuICJvdmVyY3Jvd2RlZCIsIGFuZCBpdCBpcyBoYXJkIHRvIHNlZSBzdHJ1Y3R1cmUgKGUuZy4sIHRoZSBQQ0EKcGxvdCB3ZSBqdXN0IHNhdykuIE5vbi1saW5lYXIgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uIG1ldGhvZHMgY2FuIG92ZXJjb21lIHRoaXMKcHJvYmxlbS4gQXMgdGhlIG5hbWUgc3VnZ2VzdHMsIHRoZSByZWR1Y2VkIGRpbWVuc2lvbnMgYXJlIGEgbm9uLWxpbmVhciBmdW5jdGlvbgpvZiB0aGUgb2JzZXJ2ZWQgZGF0YS4gV2Ugd2lsbCBub3QgZ28gaW50byBkZXRhaWwgYXMgdG8gaG93IHRoZXNlIHdvcmsgdW5kZXIgdGhlCmhvb2QsIGJ1dCBwcm92aWRlIGEgZmV3IGd1aWRlbGluZXMgZm9yIHRoZSBtb3N0IHBvcHVsYXIgbWV0aG9kcy4gT2Z0ZW4sIHRoZSB0b3AKKH4xMC01MCkgUENzIGFyZSBwcm92aWRlZCBhcyBpbnB1dC4KCiMjIEEgZ2VuZXJhbGl6YXRpb24gb2YgUENBIGZvciBleHBvbmVudGlhbCBmYW1pbHkgZGlzdHJpYnV0aW9ucy4KClBDQSBpcyBpbXBsaWNpdGx5IGJhc2VkIG9uIEV1Y2xpZGVhbiBkaXN0YW5jZXMsIGNvcnJlc3BvbmRpbmcgdG8gbWF4aW1pemluZyBhCkdhdXNzaWFuIGxpa2VsaWhvb2QsIHdoaWNoIGlzIGluYXBwcm9wcmlhdGUgZm9yIGNvdW50IGRhdGEgc3VjaCBhcyBzY1JOQS1zZXEuCltUb3duZXMgZXQgYWwuXShodHRwczovL2RvaS5vcmcvMTAuMTE4Ni9zMTMwNTktMDE5LTE4NjEtNikgKDIwMTkpIGRldmVsb3AKR0xNLVBDQSwgYSBnZW5lcmFsaXphdGlvbiBvZiBQQ0EgZm9yIGV4cG9uZW50aWFsIGZhbWlseSBsaWtlbGlob29kcy4gVGhleSBwb3NpdCwKdXNpbmcgbmVnYXRpdmUgY29udHJvbCBkYXRhLCB0aGF0IHRoZSBkYXRhIGdlbmVyYXRpdmUgbWVjaGFuaXNtIG9mIFVNSSBjb3VudApkYXRhIGNhbiBiZSBjb25zaWRlcmVkIHRvIGJlIG11bHRpbm9taWFsLgoKVGhlIEdMTS1QQ0Egc3RyYXRlZ3kgaXMgaW1wbGVtZW50ZWQgaW4gdGhlIGBnbG1wY2FgIGZ1bmN0aW9uIG9mIHRoZSBgZ2xtcGNhYApwYWNrYWdlLgoKTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gaXMgcXVpdGUgY29tcHV0YXRpb25hbGx5IGludGVuc2l2ZS4gRm9yIHJlZ3VsYXIgUENBIApvbiBsb2ctdHJhbnNmb3JtZWQgbm9ybWFsaXplZCBjb3VudHMsIHRoZSB1bmRlcmx5aW5nIGNvbXB1dGF0aW9ucyBjYW4gYmUgCnN0cm9uZ2x5IHNpbXBsaWZpZWQuIEhlcmUsIHdlIHdvcmsgd2l0aCB0aGUgcmF3IGNvdW50cywgd2hpY2ggd2UgYXNzdW1lIHRvIApiZSAqUG9pc3NvbiogZGlzdHJpYnV0ZWQsIHJlcXVpcmluZyBhbiBpdGVyYXRpdmUgb3B0aW1pemF0aW9uIHNjaGVtZS4KCmBgYHtyfQojIHJ1bnMgMm1pbiBvbiBteSBsYXB0b3AKbGlicmFyeShnbG1wY2EpCnNldC5zZWVkKDIxMTEwMykKcG9pcGNhIDwtIGdsbXBjYShZID0gYXNzYXlzKHNjZSkkY291bnRzW2h2ZyxdLAogICAgICAgICAgICAgICAgIEwgPSAyLCAKICAgICAgICAgICAgICAgICBmYW0gPSAicG9pIiwKICAgICAgICAgICAgICAgICBtaW5pYmF0Y2ggPSAic3RvY2hhc3RpYyIpCnJlZHVjZWREaW0oc2NlLCAiUG9pUENBIikgPC0gcG9pcGNhJGZhY3RvcnMKcGxvdFJlZHVjZWREaW0oc2NlLCAKICAgICAgICAgICAgICAgZGltcmVkPSJQb2lQQ0EiLAogICAgICAgICAgICAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpCmBgYAoKQWx0ZXJuYXRpdmVseSwgd2UgY291bGQgYWRvcHQgdGhlIEdMTS1QQ0Egc3RyYXRlZ3kgdXNpbmcgb25seSB0aGUgZ2VuZXMgd2l0aCAKaGlnaCBkZXZpYW5jZS4KCmBgYHtyfQojIEJhc2VkIG9uIHRoZSBkaWFnbm9zdGljIHBsb3QgZnJvbSB0aGUgZmVhdHVyZSBzZWxlY3Rpb24sIHdlIHdvdWxkIHNlbGVjdCB0aGUgCiMgdG9wIDIwMDAgZ2VuZXMgd2l0aCBoaWdoZXN0IGRldmlhbmNlLiBIb3dldmVyLCB0byByZWR1Y2UgdGhlIHJ1bm5pbmcgdGltZSBvZgojIHRoZSBmdW5jdGlvbiwgSSBoZXJlIHNlbGVjdCB0aGUgdG9wIDUwMCAod2hpY2ggc3RpbGwgaXMgcXVpdGUgc2xvdyAtIDVtaW4pLgpTeXMudGltZSgpCmhkZyA8LSBuYW1lcyhzb3J0KHJvd0RhdGEoc2NlKSRiaW5vbWlhbF9kZXZpYW5jZSwgZGVjcmVhc2luZyA9IFRSVUUpKVsxOjUwMF0KCnNldC5zZWVkKDQ3MTY4MSkKcG9pcGNhX2RldiA8LSBnbG1wY2EoWSA9IGFzc2F5cyhzY2UpJGNvdW50c1toZGcsXSwKICAgICAgICAgICAgICAgICBMID0gMiwgCiAgICAgICAgICAgICAgICAgZmFtID0gInBvaSIsCiAgICAgICAgICAgICAgICAgbWluaWJhdGNoID0gInN0b2NoYXN0aWMiKQpTeXMudGltZSgpCnJlZHVjZWREaW0oc2NlLCAiUG9pUENBX2RldiIpIDwtIHBvaXBjYV9kZXYkZmFjdG9ycwpwbG90UmVkdWNlZERpbShzY2UsIAogICAgICAgICAgICAgICBkaW1yZWQ9IlBvaVBDQV9kZXYiLAogICAgICAgICAgICAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpCmBgYAoKVGhlIGF1dGhvcnMgb2YgdGhlIGBnbG1wY2FgIHBhY2thZ2Ugbm90ZSB0aGF0IEdMTS1QQ0EgY2FuIGJlIHNsb3cgZm9yIGxhcmdlIApkYXRhc2V0cy4gVGhlcmVmb3JlLCB0aGV5IGhhdmUgaW1wbGVtZW50ZWQgYSBmYXN0IGFwcHJveGltYXRpb24gb2YgdGhlIAphbGdvcml0aG0sIHdoaWNoIGZpcnN0IGZpdHMgYSBudWxsIG1vZGVsIG9mIGNvbnN0YW50IGV4cHJlc3Npb24gZm9yIGVhY2ggZ2VuZSAKYWNyb3NzIGFsbCBjZWxscywgYW5kIHN1YnNlcXVlbnRseSBmaXRzIHN0YW5kYXJkIFBDQSB0byBlaXRoZXIgdGhlIFBlYXJzb24gb3IgCmRldmlhbmNlIHJlc2lkdWFscyBmcm9tIHRoZSBudWxsIG1vZGVsLgoKSG93ZXZlciwgYXQgbGVhc3QgZm9yIG1lIHRoZSBgbnVsbFJlc2lkdWFsc2AgZnVuY3Rpb24gd2FzICoqZXh0cmVtZWx5IHNsb3cqKgpldmVuIHNsb3dlciB0aGFuIHRoZSBgZ2xtcGNhYCBjb2RlIGFib3ZlLiBUaGVyZWZvcmUsICoqSSBzdWdnZXN0IG5vdCBydW5uaW5nKioKdGhpcyBjb2RlLCBidXQgSSBsZWF2ZSBpdCBpbiBmb3IgcmVmZXJlbmNlLgoKYGBgCnNjZSA8LSBudWxsUmVzaWR1YWxzKHNjZSwgYXNzYXk9ImNvdW50cyIsIHR5cGU9ImRldmlhbmNlIikKc2NlIDwtIG51bGxSZXNpZHVhbHMoc2NlLCBhc3NheT0iY291bnRzIiwgdHlwZT0icGVhcnNvbiIpCgpwY2E8LWZ1bmN0aW9uKFksIEw9MiwgY2VudGVyPVRSVUUsIHNjYWxlPVRSVUUpewogICAgI2Fzc3VtZXMgZmVhdHVyZXM9cm93cywgb2JzZXJ2YXRpb25zPWNvbHMKICAgIHJlczwtcHJjb21wKGFzLm1hdHJpeCh0KFkpKSwgY2VudGVyPWNlbnRlciwgc2NhbGUuPXNjYWxlLCByYW5rLj1MKQogICAgZmFjdG9yczwtYXMuZGF0YS5mcmFtZShyZXMkeCkKICAgIGNvbG5hbWVzKGZhY3RvcnMpPC1wYXN0ZTAoImRpbSIsIDE6TCkKICAgIGZhY3RvcnMKfQpwY2FfZCA8LSBwY2EoYXNzYXkoc2NlW2hkZyxdLCAiYmlub21pYWxfZGV2aWFuY2VfcmVzaWR1YWxzIikpCnBjYV9kJHJlc2lkX3R5cGUgPC0gImRldmlhbmNlX3Jlc2lkdWFscyIKcGNhX3AgPC0gcGNhKGFzc2F5KHNjZVtoZGcsXSwgImJpbm9taWFsX3BlYXJzb25fcmVzaWR1YWxzIikpCnBjYV9wJHJlc2lkX3R5cGUgPC0gInBlYXJzb25fcmVzaWR1YWxzIgpjbSA8LSBhcy5kYXRhLmZyYW1lKGNvbERhdGEoc2NlW2hkZyxdKSkKcGQgPC0gcmJpbmQoY2JpbmQoY20sIHBjYV9kKSwgY2JpbmQoY20sIHBjYV9wKSkKZ2dwbG90KHBkLCBhZXMoeD1kaW0xLCB5PWRpbTIsIGNvbG91cj1waGVub2lkKSkgKyBnZW9tX3BvaW50KCkgKwogIGZhY2V0X3dyYXAofnJlc2lkX3R5cGUsIHNjYWxlcz0iZnJlZSIsIG5yb3c9MikgKwogIGdndGl0bGUoIlBDQSBhcHBsaWVkIHRvIG51bGwgcmVzaWR1YWxzIG9mIGhpZ2ggZGV2aWFuY2UgZ2VuZXMiKQpgYGAKCiMjIE5vbi1saW5lYXIgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uOiB0LVNORQoKdC1TTkUgZm9jdXNlcyBvbiBwcmVzZXJ2aW5nIGxvY2FsIHJhdGhlciB0aGFuIGdsb2JhbCBkaXN0YW5jZXMuIFRoZXJlZm9yZSwKZGlzdGFuY2VzIG9uIGEgdC1TTkUgcmVkdWNlZCBkaW1lbnNpb24gcGxvdCBjYW4gb25seSBiZSBpbnRlcnByZXRlZCBsb2NhbGx5LAppLmUuLCBjZWxscyB0aGF0IGFyZSBjbG9zZSB0b2dldGhlciBpbiByZWR1Y2VkIGRpbWVuc2lvbiB3aWxsIGhhdmUgYSBzaW1pbGFyCnRyYW5zY3JpcHRvbWUsIGJ1dCBjZWxscyB0aGF0IGFyZSBmYXIgYXdheSBtYXkgbm90IG5lY2Vzc2FyaWx5IGhhdmUgYSB2ZXJ5IGRpc3RpbmN0IHRyYW5zY3JpcHRvbWUuCgpSdW5uaW5nIHQtU05FIG9uIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QgY2FuIGJlIGFjaGlldmVkIHdpdGggdGhlCmBydW5UU05FYCBmdW5jdGlvbiBvZiB0aGUgYHNjYXRlcmAgcGFja2FnZS4gQnkgZGVmYXVsdCwgdGhpcyBmdW5jdGlvbiB3aWxsIGZpcnN0CnBlcmZvcm0gUENBLCBhbmQgdXNlIHRoZSB0b3AgNTAgUENzIGFzIGFuIGlucHV0IHRvIHRoZSBhY3R1YWwgdC1TTkUKYWxnb3JpdGhtLiBTaW5jZSB3ZSBhbHJlYWR5IHBlcmZvcm1lZCBQQ0EsIHdlIG1heSBzZXQgYGRpbXJlZCA9ICJQQ0EiYCBhcwphcmd1bWVudCB0byB0aGUgZnVuY3Rpb24uIEFzIHN1Y2ggd2Ugd2lsbCBiZSBwZXJmb3JtaW5nIGEgVC1TTkUgb24gdGhlIDMwIFBDcwp3ZSBjb21wdXRlZCBiZWZvcmUuIElmIHdlIHdvdWxkIGxpa2UgdG8gcnVuIHQtU05FIG9ubHkgdXNpbmcgdGhlIHRvcCAxMApQQ3MsIHdlIGNvdWxkIHNldCBgbl9kaW1yZWQgPSAxMGAuCgpJbiBhZGRpdGlvbiwgd2UgbWF5IHdpc2ggdG8gc2V0IGBleHRlcm5hbF9uZWlnaGJvcnM9VFJVRWAsIHdoaWNoIGluY3JlYXNlcyB0aGUKc3BlZWQgb2YgdGhlIGFsZ29yaXRobSBmb3IgbGFyZ2UgZGF0YXNldHMgYnkgYXBwbHlpbmcgYSBoZXVyaXN0aWMuCgoqKk5vdGU6KiogZm9yIG1lIHRoaXMgd2FzIHRoZSBzbG93ZXN0IGZ1bmN0aW9uIG9mIHRoZSBhbmFseXNpcyAoc28gZmFyKS4gSWYgeW91CmZlZWwgbGlrZSB5b3VyIFBDL2xhcHRvcCBoYWQgYSBsb3Qgb2YgdHJvdWJsZSB3aXRoIHRoZSBwcmV2aW91cyBzdGVwKHMpLCB5b3UKbWF5IGNvbnNpZGVyIG5vdCBydW5uaW5nIHRoaXMgY29kZSwgb3IgcnVubmluZyBpdCBvbiBhIHN1YnNldCBvZiB0aGUgZGF0YQooZS5nLiwgcmFuZG9tbHkgc3Vic2FtcGxpbmcgY2VsbHMpIGZvciBkZW1vbnN0cmF0aW9uYWwgcHVycG9zZXMuIApBbHRlcm5hdGl2ZWx5LCB5b3UgbWF5IGNvbnNpZGVyIHJlZHVjaW5nIHRoZSBpbnB1dCBzcGFjZSBmb3IgdGhlIHQtU05FIAphbGdvcml0aG0sIGUuZy4gYnkgc2V0dGluZyBgbl9kaW1yZWQgPSA1YC4KCmBgYHtyfQojIChGb3IgbWUgaXQgdGFrZXMgM21pbjMwIHdpdGggbl9kaW1yZWQgPSA1KQpzY2UgPC0gcnVuVFNORShzY2UsIAogICAgICAgICAgICAgICBkaW1yZWQgPSAnUENBJywKICAgICAgICAgICAgICAgbl9kaW1yZWQgPSA1LAogICAgICAgICAgICAgICBleHRlcm5hbF9uZWlnaGJvcnM9VFJVRSkKcGxvdFRTTkUoc2NlLAogICAgICAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpCmBgYAoKIyMgTm9uLWxpbmVhciBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb246IFVNQVAKCkl0IGlzIG9mdGVuIHN1Z2dlc3RlZCB0aGF0IFVNQVAgaXMgYmV0dGVyIHRoYW4gdC1TTkUgaW4gcHJlc2VydmluZyBnbG9iYWwgCmRpZmZlcmVuY2VzLiBUaGVyZWZvcmUsIFVNQVAgaXMgYWxzbyBvZnRlbiB1c2VkIGluIGFuYWx5c2VzIHN1Y2ggYXMgdHJhamVjdG9yeSAKaW5mZXJlbmNlLCB3aGVyZSB0aGlzIGlzIGltcG9ydGFudC4KClJ1bm5pbmcgVU1BUCBvbiBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0IGNhbiBiZSBhY2hpZXZlZCB3aXRoIHRoZQpgcnVuVU1BUGAgZnVuY3Rpb24gb2YgdGhlIGBzY2F0ZXJgIHBhY2thZ2UuCgpgYGB7cn0KIyBVc2luZyB0b3AgMTAlIGhpZ2hseSB2YXJpYWJsZSBnZW5lcyBhbmQgdG9wIDMwIFBDcwpzY2UgPC0gcnVuVU1BUChzY2UsIAogICAgICAgICAgICAgICBkaW1yZWQgPSAnUENBJywgCiAgICAgICAgICAgICAgIGV4dGVybmFsX25laWdoYm9ycyA9IFRSVUUpCnBsb3RVTUFQKHNjZSwKICAgICAgICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKQoKIyBVc2luZyB0b3AgMTAlIGhpZ2hseSB2YXJpYWJsZSBnZW5lcyBhbmQgdG9wIDEwIFBDcwpwbG90VU1BUChydW5VTUFQKHNjZSwgCiAgICAgICAgICAgICAgIGRpbXJlZCA9ICdQQ0EnLCAKICAgICAgICAgICAgICAgZXh0ZXJuYWxfbmVpZ2hib3JzID0gVFJVRSwKICAgICAgICAgICAgICAgbl9kaW1yZWQgPSAxMCksCiAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKQpgYGAKCi0tLQoKLS0tIGVuZCBsYWIgc2Vzc2lvbiAyIC0tLQoKLS0tCgojIFJlYWQgcmVzdWx0cyBmcm9tIGZpcnN0IHR3byBzZXNzaW9ucwoKYGBge3IsZXZhbD1GQUxTRX0Kc2NlIDwtIHJlYWRSRFMoIi4vc2NlX2FmdGVyX2xhYnNlc3Npb24yLnJkcyIpICMgY2hhbmdlIHRvIFlPVVIgcGF0aCEKYGBgCgojIEFkZCBjbHVzdGVyIGluZm9ybWF0aW9uIGZyb20gcHVibGljYXRpb24KCmBgYHtyLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHRpZHl2ZXJzZSkKc2NlJGNsdXN0ZXJfbG93UmVzIDwtIGZjdF9yZWNvZGUoY29sRGF0YShzY2UpJGNsdXN0ZXIsIAogICAgICAgICAgICJIb3Jpem9udGFsX2NlbGxzIiA9ICIxIiwKICAgICAgICAgICAiR2FuZ2xpb25fY2VsbHMiID0gIjIiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiMyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICI0IiwKICAgICAgICAgICAiQW1hY3JpbmUiID0gIjUiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiNiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICI3IiwKICAgICAgICAgICAiQW1hY3JpbmUiID0gIjgiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiOSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxOCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxOSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMyIsCiAgICAgICAgICAgIlJvZHMiID0gIjI0IiwKICAgICAgICAgICAiQ29uZXMiID0gIjI1IiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMjYiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIyNyIsCiAgICAgICAgICAgIkJpcG9sYXIiID0gIjI4IiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMjkiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIzMCIsCiAgICAgICAgICAgIkJpcG9sYXIiID0gIjMxIiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMzIiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIzMyIsCiAgICAgICAgICAgIk11bGxlcl9nbGlhIiA9ICIzNCIsCiAgICAgICAgICAgIkFzdHJvY3l0ZXMiID0gIjM1IiwKICAgICAgICAgICAiRmlicm9ibGFzdCIgPSAiMzYiLAogICAgICAgICAgICJWYXNjdWxhcl9lbmRvdGhlbGl1bSIgPSAiMzciLAogICAgICAgICAgICJQZXJpY3l0ZXMiID0gIjM4IiwKICAgICAgICAgICAiTWljcm9nbGlhIiA9ICIzOSIpCgpzY2UkY2x1c3Rlcl9oaWdoUmVzIDwtIGZjdF9yZWNvZGUoY29sRGF0YShzY2UpJGNsdXN0ZXIsIAogICAgICAgICAgICJIb3Jpem9udGFsX2NlbGxzIiA9ICIxIiwKICAgICAgICAgICAiR2FuZ2xpb25fY2VsbHMiID0gIjIiLAogICAgICAgICAgICJBbWFjcmluZV8xIiA9ICIzIiwKICAgICAgICAgICAiQW1hY3JpbmVfMiIgPSAiNCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzMiID0gIjUiLAogICAgICAgICAgICJBbWFjcmluZV80IiA9ICI2IiwKICAgICAgICAgICAiQW1hY3JpbmVfNSIgPSAiNyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzYiID0gIjgiLAogICAgICAgICAgICJBbWFjcmluZV83IiA9ICI5IiwKICAgICAgICAgICAiQW1hY3JpbmVfOCIgPSAiMTAiLAogICAgICAgICAgICJBbWFjcmluZV85IiA9ICIxMSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEwIiA9ICIxMiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzExIiA9ICIxMyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEyIiA9ICIxNCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEzIiA9ICIxNSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE0IiA9ICIxNiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE1IiA9ICIxNyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE2IiA9ICIxOCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE3IiA9ICIxOSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE4IiA9ICIyMCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE5IiA9ICIyMSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzIwIiA9ICIyMiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzIxIiA9ICIyMyIsCiAgICAgICAgICAgIlJvZHMiID0gIjI0IiwKICAgICAgICAgICAiQ29uZXMiID0gIjI1IiwKICAgICAgICAgICAiQmlwb2xhcl8xIiA9ICIyNiIsCiAgICAgICAgICAgIkJpcG9sYXJfMiIgPSAiMjciLAogICAgICAgICAgICJCaXBvbGFyXzMiID0gIjI4IiwKICAgICAgICAgICAiQmlwb2xhcl80IiA9ICIyOSIsCiAgICAgICAgICAgIkJpcG9sYXJfNSIgPSAiMzAiLAogICAgICAgICAgICJCaXBvbGFyXzYiID0gIjMxIiwKICAgICAgICAgICAiQmlwb2xhcl83IiA9ICIzMiIsCiAgICAgICAgICAgIkJpcG9sYXJfOCIgPSAiMzMiLAogICAgICAgICAgICJNdWxsZXJfZ2xpYSIgPSAiMzQiLAogICAgICAgICAgICJBc3Ryb2N5dGVzIiA9ICIzNSIsCiAgICAgICAgICAgIkZpYnJvYmxhc3QiID0gIjM2IiwKICAgICAgICAgICAiVmFzY3VsYXJfZW5kb3RoZWxpdW0iID0gIjM3IiwKICAgICAgICAgICAiUGVyaWN5dGVzIiA9ICIzOCIsCiAgICAgICAgICAgIk1pY3JvZ2xpYSIgPSAiMzkiKQpgYGAKCiMgQ2x1c3RlcmluZwoKIyMgR3JhcGgtYmFzZWQgY2x1c3RlcmluZwoKRmlyc3QsIHdlIGRpc2N1c3MgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBtZXRob2RzIGZvciBzY1JOQS1TZXEgZGF0YS4KVGhpcyBpcyB2ZXJ5IHdlbGwgZXhwbGFpbmVkIGluIHRoZSAKW09TQ0EgYm9vayBjaGFwdGVyIDUuMl0oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNC9PU0NBLmJhc2ljL2NsdXN0ZXJpbmcuaHRtbCNjbHVzdGVyaW5nLWdyYXBoKS4KCkFzIHdyaXR0ZW4gaW4gdGhlIE9TQ0EgYm9vazogIlBvcHVsYXJpemVkIGJ5IGl0cyB1c2UgaW4gU2V1cmF0LCBncmFwaC1iYXNlZCAKY2x1c3RlcmluZyBpcyBhIGZsZXhpYmxlIGFuZCBzY2FsYWJsZSB0ZWNobmlxdWUgZm9yIGNsdXN0ZXJpbmcgbGFyZ2Ugc2NSTkEtc2VxIApkYXRhc2V0cy4gV2UgZmlyc3QgYnVpbGQgYSBncmFwaCB3aGVyZSBlYWNoIG5vZGUgaXMgYSBjZWxsIHRoYXQgaXMgY29ubmVjdGVkIAp0byBpdHMgbmVhcmVzdCBuZWlnaGJvcnMgaW4gdGhlIGhpZ2gtZGltZW5zaW9uYWwgc3BhY2UuIEVkZ2VzIGFyZSB3ZWlnaHRlZCAKYmFzZWQgb24gdGhlIHNpbWlsYXJpdHkgYmV0d2VlbiB0aGUgY2VsbHMgaW52b2x2ZWQsIHdpdGggaGlnaGVyIHdlaWdodCBnaXZlbiAKdG8gY2VsbHMgdGhhdCBhcmUgbW9yZSBjbG9zZWx5IHJlbGF0ZWQuIFdlIHRoZW4gYXBwbHkgYWxnb3JpdGhtcyB0byBpZGVudGlmeSAK4oCcY29tbXVuaXRpZXPigJ0gb2YgY2VsbHMgdGhhdCBhcmUgbW9yZSBjb25uZWN0ZWQgdG8gY2VsbHMgaW4gdGhlIHNhbWUgY29tbXVuaXR5IAp0aGFuIHRoZXkgYXJlIHRvIGNlbGxzIG9mIGRpZmZlcmVudCBjb21tdW5pdGllcy4gRWFjaCBjb21tdW5pdHkgcmVwcmVzZW50cyBhIApjbHVzdGVyIHRoYXQgd2UgY2FuIHVzZSBmb3IgZG93bnN0cmVhbSBpbnRlcnByZXRhdGlvbi4KClRoZSBtYWpvciBhZHZhbnRhZ2Ugb2YgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBsaWVzIGluIGl0cyBzY2FsYWJpbGl0eS4gSXQgb25seSAKcmVxdWlyZXMgYSBrLW5lYXJlc3QgbmVpZ2hib3Igc2VhcmNoIHRoYXQgY2FuIGJlIGRvbmUgaW4gbG9nLWxpbmVhciB0aW1lIG9uIAphdmVyYWdlLCBpbiBjb250cmFzdCB0byBoaWVyYXJjaGljYWwgY2x1c3RlcmluZyBtZXRob2RzIHdpdGggcnVudGltZXMgdGhhdCBhcmUgCnF1YWRyYXRpYyB3aXRoIHJlc3BlY3QgdG8gdGhlIG51bWJlciBvZiBjZWxscy4gR3JhcGggY29uc3RydWN0aW9uIGF2b2lkcyBtYWtpbmcgCnN0cm9uZyBhc3N1bXB0aW9ucyBhYm91dCB0aGUgc2hhcGUgb2YgdGhlIGNsdXN0ZXJzIG9yIHRoZSBkaXN0cmlidXRpb24gb2YgY2VsbHMgCndpdGhpbiBlYWNoIGNsdXN0ZXIsIGNvbXBhcmVkIHRvIG90aGVyIG1ldGhvZHMgbGlrZSBrLW1lYW5zICh0aGF0IGZhdm9yIApzcGhlcmljYWwgY2x1c3RlcnMpIG9yIEdhdXNzaWFuIG1peHR1cmUgbW9kZWxzICh0aGF0IHJlcXVpcmUgbm9ybWFsaXR5KS4iCgpTZXZlcmFsIGdyYXBoLWJhc2VkIGNsdXN0ZXJpbmcgYWxnb3JpdGhtcyBhcmUgaW1wbGVtZW50ZWQgaW4gdGhlIGBzY3JhbmAgbGlicmFyeS4gClRoZSBtb3N0IGdsb2JhbCB3cmFwcGVyLWZ1bmN0aW9uIGluIHRoaXMgcGFja2FnZSBpcyB0aGUgYGNsdXN0ZXJDZWxsc2AgZnVuY3Rpb24uIApUeXBpY2FsbHksIHRoZSBpbnB1dCB0byB0aGlzIGZ1bmN0aW9uIGlzIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3Qgd2l0aCAKcHJlLWNvbXB1dGVkIHByaW5jaXBhbCBjb21wb25lbnRzOyB0aGVzZSBhcmUgdXNlZCB0byB0YWtlIGFkdmFudGFnZSBvZiBkYXRhIApjb21wcmVzc2lvbiBhbmQgZGVub2lzaW5nLiBJZiB0aGUgZGVmYXVsdCBzZXR0aW5ncyBhcmUgYWRvcHRlZCwgYGNsdXN0ZXJDZWxsc2AKd2lsbCBwZXJmb3JtIHR3byBzdGVwcyB1bmRlciB0aGUgaG9vZDoKCjEuIEJ1aWxkIGEgc2hhcmVkIG5lYXJlc3QgbmVpZ2hib3JzIChTTk4pIGdyYXBoIG9mIG9ic2VydmF0aW9ucyBmb3IgZG93bnN0cmVhbSBjb21tdW5pdHkgCmRldGVjdGlvbi4gVGhlIFNOTiBncmFwaCBpcyBjbG9zZWx5IHJlbGF0ZWQgdG8gdGhlIG1vcmUgY29tbW9uIEtOTiBncmFwaC4gRm9yIAplYWNoIG9ic2VydmF0aW9uLCBpdHMgay1uZWFyZXN0IG5laWdoYm9ycyBhcmUgaWRlbnRpZmllZCAoaz0xMCBieSBkZWZhdWx0KSwgCmJhc2VkIG9uIGRpc3RhbmNlcyBiZXR3ZWVuIHRoZWlyIGV4cHJlc3Npb24gcHJvZmlsZXMgKEV1Y2xpZGVhbiBkaXN0YW5jZXMgYXJlIAp1c2VkIGJ5IGRlZmF1bHQpIGFzIG9ic2VydmVkIGluIFBDQSBzcGFjZS4gQW4gZWRnZSBpcyBkcmF3biBiZXR3ZWVuIGFsbCBwYWlycyAKb2Ygb2JzZXJ2YXRpb25zIHRoYXQgc2hhcmUgYXQgbGVhc3Qgb25lIG5laWdoYm9yLCB3ZWlnaHRlZCBieSB0aGUgY2hhcmFjdGVyaXN0aWNzIApvZiB0aGUgc2hhcmVkIG5lYXJlc3QgbmVpZ2hib3JzLgoKMi4gVGhlIGBjbHVzdGVyQ2VsbHNgIGZ1bmN0aW9uIG5leHQgaW50ZXJuYWxseSBjYWxscyB0aGUgYGNsdXN0ZXJfd2Fsa3RyYXBgIGZ1bmN0aW9uIApmcm9tIHRoZSBgaWdyYXBoYCBsaWJyYXJ5LiBCYXNlZCBvbiB0aGUgU05OIGdyYXBoIGZyb20gc3RlcCAxLCB0aGlzIGZ1bmN0aW9uIHRyaWVzCnRvIGZpbmQgZGVuc2VseSBjb25uZWN0ZWQgc3ViZ3JhcGhzLCBhbHNvIGNhbGxlZCBjb21tdW5pdGllcyBpbiBhIGdyYXBoIHZpYSAKcmFuZG9tIHdhbGtzLiBUaGUgaWRlYSBpcyB0aGF0IHNob3J0IHJhbmRvbSB3YWxrcyB0ZW5kIHRvIHN0YXkgaW4gdGhlIHNhbWUgCmNvbW11bml0eS4KCmBgYAojIERvIG5vdCBydW47IGNsdXN0ZXJDZWxscyBmdW5jdGlvbiB3aXRoIGRlZmF1bHQgc2V0dGluZ3MsIGkuZS4sIGJ1aWxkaW5nIGFuCiMgU05OIGdyYXBoIGFuZCBmaW5kaW5nIGNsdXN0ZXJzIHdpdGggdGhlIHdhbGt0cmFwIGFsZ29yaXRobS4KbGlicmFyeShzY3JhbikKbm4uY2x1c3RlcnMgPC0gY2x1c3RlckNlbGxzKHNjZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2UuZGltcmVkPSJQQ0EiKQp0YWJsZShubi5jbHVzdGVycykKYGBgCgpUaGUgZGlzYWR2YW50YWdlIG9mIHVzaW5nIGBjbHVzdGVyQ2VsbHNgIGlzIHRoYXQgdGhlIGRlZmF1bHQgc2V0dGluZyBvZiB0aGUgCnNlY29uZCBzdGVwLCB0aGUgYGNsdXN0ZXJfd2Fsa3RyYXBgIGZ1bmN0aW9uLCBpcyBzbG93IGZvciBsYXJnZSBkYXRhc2V0cy4gV2hpbGUgCml0IGlzIHBvc3NpYmxlIHRvIGFkanVzdCB0aGUgZGlmZmVyZW50IGFyZ3VtZW50cyBvZiB0aGUgYGNsdXN0ZXJDZWxsc2AgZnVuY3Rpb24sCml0IG1pZ2h0IGJlIG1vcmUgY2xlYXIgYW5kIGludHVpdGl2ZSB0byBzaW1wbHkgYnJlYWsgdXAgdGhlIHByb2Nlc3MgaW4gdHdvIHN0ZXBzOgpidWlsZGluZyB0aGUgZ3JhcGggYW5kIGRldGVjdGluZyBjbHVzdGVycyBpbiB0aGF0IGdyYXBoLiBGb3IgdGhpcyBzZWNvbmQgc3RlcCwgCndlIG1heSB0aGVuIGFkb3B0IGEgZmFzdGVyIGFsZ29yaXRobS4KCiMjIyBCdWlsZCBncmFwaCAoU05OIGdyYXBoKQoKYGBge3J9CiMgQnVpbGQgYSBzaGFyZWQgbmVhcmVzdC1uZWlnaGJvciBncmFwaCBmcm9tIFBDQSBzcGFjZQpncmFwaCA8LSBidWlsZFNOTkdyYXBoKHNjZSwgCiAgICAgICAgICAgICAgICAgICAgICAgdXNlLmRpbXJlZCA9ICdQQ0EnKQojIGFsdGVybmF0aXZlOiBidWlsZEtOTkdyYXBoKCkKYGBgCgojIyMgRGV0ZWN0IGNsdXN0ZXJzIG9uIHRoZSBncmFwaAoKVHdvIHBvcHVsYXIgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBhbGdvcml0aG0gYXJlIHRoZSBgbGVpZGVuYCBhbmQgYGxvdXZhaW5gIAphbGdvcml0aG1zLCBib3RoIHJlZmVycmluZyB0byB0aGUgbG9jYXRpb24gb2YgaXRzIGRldmVsb3BlcnMuIEEgY29tbW9uIAppbXBsZW1lbnRhdGlvbiBvZiB0aGUgCltgbG91dmFpbmBhbGdvcml0aG1dKGh0dHBzOi8vaW9wc2NpZW5jZS5pb3Aub3JnL2FydGljbGUvMTAuMTA4OC8xNzQyLTU0NjgvMjAwOC8xMC9QMTAwMDgpIAppcyB0byBvcHRpbWl6ZSB0aGUgbW9kdWxhcml0eSwgZWZmZWN0aXZlbHkgYXR0ZW1wdGluZyB0byBtYXhpbWl6ZSB0aGUgZGlmZmVyZW5jZSAKYmV0d2VlbiB0aGUgb2JzZXJ2ZWQgbnVtYmVyIG9mIGVkZ2VzIGluIGEgY29tbXVuaXR5IGFuZCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIApzdWNoIGVkZ2VzLgoKSG93ZXZlciwgYWRkaXRpb25hbCBldmFsdWF0aW9ucyBmb3VuZCB0aGF0IG1vZHVsYXJpdHkgb3B0aW1pemF0aW9uIHVzaW5nIHRoZSAKYGxvdXZhaW5gIGFsZ29yaXRobSBpcyBjb25maW5lZCB0byBhIApbcmVzb2x1dGlvbiBsaW1pdF0oaHR0cHM6Ly93d3cucG5hcy5vcmcvY29udGVudC8xMDQvMS8zNiksIGFuZCBpbiBhZGRpdGlvbiBtYXkgCnJlc3VsdCBpbiBjb21tdW5pdGllcyB0aGF0IGFyZSBub3Qgd2VsbCBjb25uZWN0ZWQuIApUaGUgW2BsZWlkZW5gIGFsZ29yaXRobV0oaHR0cHM6Ly93d3cubmF0dXJlLmNvbS9hcnRpY2xlcy9zNDE1OTgtMDE5LTQxNjk1LXopLCAKaW5zdGVhZCwgZ3VhcmFudGVlcyB3ZWxsLWNvbm5lY3RlZCBjb21tdW5pdGllcy4KCmBgYHtyfQpzZXQuc2VlZCg0NjQ2ODgpCiMgV2Fsa3RyYXAgY29tbXVuaXR5IGZpbmRpbmcgYWxnb3JpdGhtIG9uIHRoZSBTTk4gZ3JhcGgKIyBETyBOT1QgUlVOIC0+IHRha2VzIDIwIG1pbnV0ZXMKIyBjbHVzdGVyX3dhbGt0cmFwIDwtIGZhY3RvcihpZ3JhcGg6OmNsdXN0ZXJfd2Fsa3RyYXAoZykkbWVtYmVyc2hpcCkgIzIwbWluCgojIFRoZSBgY2x1c3Rlcl9mYXN0X2dyZWVkeWAgZnVuY3Rpb24gdHJpZXMgdG8gZmluZCBkZW5zZSBzdWJncmFwaCwgYWxzbyBjYWxsZWQgCiMgY29tbXVuaXRpZXMgaW4gZ3JhcGhzIHZpYSBkaXJlY3RseSBvcHRpbWl6aW5nIGEgbW9kdWxhcml0eSBzY29yZQojIERPIE5PVCBSVU4gLT4gdGFrZXMgNCBtaW51dGVzCiMgY2x1c3Rlcl9mYXN0R3JlZWR5IDwtIGZhY3RvcihpZ3JhcGg6OmNsdXN0ZXJfZmFzdF9ncmVlZHkoZ3JhcGgpJG1lbWJlcnNoaXApICM0bWluCgojIExvdXZhaW4gY2x1c3RlcmluZyBvbiB0aGUgU05OIGdyYXBoCmNsdXN0ZXJfbG91dmFpbiA8LSBmYWN0b3IoaWdyYXBoOjpjbHVzdGVyX2xvdXZhaW4oZ3JhcGgpJG1lbWJlcnNoaXApICM4c2VjCm5sZXZlbHMoY2x1c3Rlcl9sb3V2YWluKSAjIDExIGNsdXN0ZXJzCgojIExlaWRlbiBjbHVzdGVyaW5nIG9uIHRoZSBTTk4gZ3JhcGgKY2x1c3Rlcl9sZWlkZW4gPC0gZmFjdG9yKGlncmFwaDo6Y2x1c3Rlcl9sZWlkZW4oZ3JhcGgpJG1lbWJlcnNoaXApICMxMHNlYwpubGV2ZWxzKGNsdXN0ZXJfbGVpZGVuKSAjIDEzMjYgZGlmZmVyZW50IGNsdXN0ZXJzIQoKY2x1c3Rlcl9sZWlkZW4yIDwtIGZhY3RvcihpZ3JhcGg6OmNsdXN0ZXJfbGVpZGVuKGdyYXBoID0gZ3JhcGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHV0aW9uX3BhcmFtZXRlciA9IDAuMDEpJG1lbWJlcnNoaXApICMxMHNlYwpubGV2ZWxzKGNsdXN0ZXJfbGVpZGVuMikgIzE0IGRpZmZlcmVudCBjbHVzdGVycwoKIyBBZGQgdG8gc2NlIGFuZCB2aXN1YWxpemUKY29sRGF0YShzY2UpJGNsdXN0ZXJfbG91dmFpbiA8LSBjbHVzdGVyX2xvdXZhaW4KY29sRGF0YShzY2UpJGNsdXN0ZXJfbGVpZGVuMiA8LSBjbHVzdGVyX2xlaWRlbjIKYGBgCgojIyMgQ29tcGFyaW5nIGNsdXN0ZXJpbmcgc3RyYXRlZ2llcwoKQSBkaXJlY3QgY29tcGFyaXNvbiBvZiB0aGUgTG91dmFpbiBhbmQgTGVpZGVuIGNsdXN0ZXJpbmcgcmVzdWx0cyB1c2luZyBhIHRhYmxlIApvZiB0aGUgY2x1c3RlciBsYWJlbHMsIHNob3dzIGdvb2QgYWdyZWVtZW50LgoKYGBge3J9CnRhYmxlKGNsdXN0ZXJfbG91dmFpbiwgY2x1c3Rlcl9sZWlkZW4yKQpgYGAKICAgICAgICAgICAgIApGaXJzdCwgbm90ZSB0aGF0IExlaWRlbjIgY2x1c3RlcnMgOS0xNCBhbGwgY29udGFpbiBvbmx5IDEgY2VsbCwgd2hpY2ggZG9lc27igJl0IAptYWtlIG11Y2ggc2Vuc2UuCgpOZXh0LCB3ZSBzZWUgdGhlIGZvbGxvd2luZyBjbGVhciBjb3JyZXNwb25kZW5jZXMgYmV0d2VlbiB0aGUgY2x1c3RlciBsYWJlbHM6CgpMb3V2YWluIDEgLT4gTGVpZGVuIDEKTG91dmFpbiA2IC0+IExlaWRlbiAyCkxvdXZhaW4gMyAtPiBMZWlkZW4gNApMb3V2YWluIDcgLT4gTGVpZGVuIDYKTG91dmFpbiA4IC0+IExlaWRlbiA3CkxvdXZhaW4gMTAgLT4gTGVpZGVuIDgKCkZvciB0aGUgcmVtYWluaW5nIGNsdXN0ZXJzLCB3ZSBzZWUgdGhhdCAKLSBMZWlkZW4gY2x1c3RlciAzIGNvbnRhaW5zIGFsbW9zdCBjZWxscyBvZiBMb3V2YWluIGNsdXN0ZXJzIDIsIDkgYW5kIDExIAotIExlaWRlbiBjbHVzdGVyIDUgY29udGFpbnMgYWxtb3N0IGNlbGxzIG9mIExvdXZhaW4gY2x1c3RlcnMgNCBhbmQgNQoKVG8gbWFrZSBhIHZpc3VhbGl6YXRpb24gdGhhdCBnaXZlcyB1cyB2ZXJ5IHNpbWlsYXIgaW5mb3JtYXRpb24sIHdlIG1heSB1c2UgYSAKaGVhdG1hcDoKCmBgYHtyfQpsaWJyYXJ5KHBoZWF0bWFwKQpwaGVhdG1hcDo6cGhlYXRtYXAodGFibGUoY2x1c3Rlcl9sb3V2YWluLCBjbHVzdGVyX2xlaWRlbjIpKQpgYGAKCkFsdGVybmF0aXZlbHksIHdlIG1heSBjb21wdXRlIGEgY2x1c3RlcmluZyBzaW1pbGFyaXR5IHNjb3JlIHRoYXQgY2FwdHVyZXMgdGhlIAphZ3JlZW1lbnQgYmV0d2VlbiB0d28gc2V0cyBvZiBwYXJ0aXRpb25zLiBUaGUgQWRqdXN0ZWQgUmFuZCBJbmRleCAoQVJJKSBpcyBvZnRlbgp1c2VkIGluIHRoZSBsaXRlcmF0dXJlIGZvciB0aGlzIHB1cnBvc2UuIFRoZSBBUkkgaXMgZXF1YWwgdG8gMSBpZiB0aGUgdHdvIApwYXJ0aXRpb25zIGFncmVlIHBlcmZlY3RseSwgYW5kIGl0IGlzIHplcm8gaWYgdGhlIHR3byBwYXJ0aXRpb25zIGFyZSB1bnJlbGF0ZWQuIApJbiBzb21lIGNhc2VzLCB0aGUgQVJJIG1heSBhbHNvIGJlIG5lZ2F0aXZlIGlmIHRoZSBwYXJ0aXRpb25zIGFyZSBtdWNoIG1vcmUgCmRpZmZlcmVudCB0aGFuIHdoYXQgY291bGQgYmUgZXhwZWN0ZWQgYnkgY2hhbmNlLgoKYGBge3J9CmxpYnJhcnkobWNsdXN0KQptY2x1c3Q6OmFkanVzdGVkUmFuZEluZGV4KGNsdXN0ZXJfbG91dmFpblstd2hpY2goY2x1c3Rlcl9sZWlkZW4yICVpbiUgYyg5OjE0KSldLCAKICAgICAgICAgICAgICAgICAgICAgICAgICBjbHVzdGVyX2xlaWRlbjJbLXdoaWNoKGNsdXN0ZXJfbGVpZGVuMiAlaW4lIGMoOToxNCkpXSkKYGBgCgojIyMgVmlzdWFsaXphdGlvbgoKYGBge3J9CiMgVmlzdWFsaXphdGlvbi4gQWRkIHRoZSBjbHVzdGVyIGxhYmVscyB0byB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgVFNORQojIGNvb3JkaW5hdGVzCnBsb3RUU05FKHNjZSwgCiAgICAgICAgIGNvbG91cl9ieT0iY2x1c3Rlcl9sb3V2YWluIikKCnBsb3RUU05FKHNjZSwgCiAgICAgICAgIGNvbG91cl9ieT0iY2x1c3Rlcl9sZWlkZW4yIikKYGBgCgojIyBLLW1lYW5zIGNsdXN0ZXJpbmcKCkstbWVhbnMgaXMgYSBjbHVzdGVyaW5nIGFsZ29yaXRobSB0aGF0IGhhcyBiZWVuIHVzZWQgaW4gbWFueSBhcHBsaWNhdGlvbiBhcmVhcy4gCkluIFIsIGl0IGNhbiBiZSBhcHBsaWVkIHZpYSB0aGUgYGttZWFuc2AgZnVuY3Rpb24uIFR5cGljYWxseSwgaXQgaXMgYXBwbGllZCB0byAKYSByZWR1Y2VkIGRpbWVuc2lvbmFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBleHByZXNzaW9uIGRhdGEgKG1vc3Qgb2Z0ZW4gUENBKS4gCldlIG5lZWQgdG8gZGVmaW5lIHRoZSBudW1iZXIgb2YgY2x1c3RlcnMgaW4gYWR2YW5jZS4gU2luY2UgdGhlIHJlc3VsdHMgZGVwZW5kIG9uIAp0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNsdXN0ZXIgY2VudGVycywgaXQgaXMgdHlwaWNhbGx5IHJlY29tbWVuZGVkIHRvIHJ1biAKay1tZWFucyB3aXRoIG11bHRpcGxlIHN0YXJ0aW5nIGNvbmZpZ3VyYXRpb25zICh2aWEgdGhlIGBuc3RhcnRgIGFyZ3VtZW50KS4KRm9yIHJlcHJvZHVjaWJpbGl0eSwgd2UgYWxzbyBzdHJvbmdseSBhZHZpc2UgdG8gc2V0IGEgc2VlZC4KCmBgYHtyLGV2YWw9RkFMU0V9CnNldC5zZWVkKDEyMykKCiMgaz0xMApjbHVzdF9rbWVhbnNfazEwIDwtIGttZWFucyhyZWR1Y2VkRGltKHNjZSwgIlBDQSIpLCBjZW50ZXJzID0gMTAsIG5zdGFydCA9IDUpCnRhYmxlKGNsdXN0X2ttZWFuc19rMTAkY2x1c3RlcikKY29sRGF0YShzY2UpJGttZWFuczEwIDwtIGZhY3RvcihjbHVzdF9rbWVhbnNfazEwJGNsdXN0ZXIpCnBsb3RUU05FKHNjZSwgY29sb3VyX2J5PSJrbWVhbnMxMCIpCgojIGs9MzkKY2x1c3Rfa21lYW5zX2szOSA8LSBrbWVhbnMocmVkdWNlZERpbShzY2UsICJQQ0EiKSwgY2VudGVycyA9IDM5LCBuc3RhcnQgPSA1KQp0YWJsZShjbHVzdF9rbWVhbnNfazM5JGNsdXN0ZXIpCmNvbERhdGEoc2NlKSRrbWVhbnMzOSA8LSBmYWN0b3IoY2x1c3Rfa21lYW5zX2szOSRjbHVzdGVyKQpwbG90VFNORShzY2UsIGNvbG91cl9ieT0ia21lYW5zMzkiKQpgYGAKCldlIGhlcmUgYXJiaXRyYXJpbHkgcGVyZm9ybWVkIHR3byBrLW1lYW5zIGNsdXN0ZXJpbmcgYW5hbHlzZXMsIG9uY2Ugd2l0aCBrPTEwIAphbmQgb25jZSB3aXRoIGs9MzkgKHRoZSBudW1iZXIgb2YgY2x1c3RlcnMgY29tbXVuaWNhdGVkIGJ5IHRoZSBhdXRob3JzKS4gVGhlIApjaG9pY2Ugb2YgdGhlIG51bWJlciBvZiBjbHVzdGVycyBrIGNhbiBiZSBndWlkZWQgYnkga25vd24gYmlvbG9neSwgaG93ZXZlciwgaXQgCmlzIGFyYml0cmFyeSBhdCBsZWFzdCB0byBzb21lIGludGVydmFsLgoKIyMgSGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcKCkZyb20gW09TQ0EgYm9vayBjaGFwdGVyIDUuNF0oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNC9PU0NBLmJhc2ljL2NsdXN0ZXJpbmcuaHRtbCNoaWVyYXJjaGljYWwtY2x1c3RlcmluZyk6CgoiSGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcgaXMgYW4gb2xkIHRlY2huaXF1ZSB0aGF0IGFycmFuZ2VzIHNhbXBsZXMgaW50byBhIApoaWVyYXJjaHkgYmFzZWQgb24gdGhlaXIgcmVsYXRpdmUgc2ltaWxhcml0eSB0byBlYWNoIG90aGVyLiBNb3N0IGltcGxlbWVudGF0aW9ucwpkbyBzbyBieSBqb2luaW5nIHRoZSBtb3N0IHNpbWlsYXIgc2FtcGxlcyBpbnRvIGEgbmV3IGNsdXN0ZXIsIHRoZW4gam9pbmluZyAKc2ltaWxhciBjbHVzdGVycyBpbnRvIGxhcmdlciBjbHVzdGVycywgYW5kIHNvIG9uLCB1bnRpbCBhbGwgc2FtcGxlcyBiZWxvbmcgdG8gYSAKc2luZ2xlIGNsdXN0ZXIuIFRoaXMgcHJvY2VzcyB5aWVsZHMgYSBkZW5kcm9ncmFtIHRoYXQgZGVmaW5lcyBjbHVzdGVycyB3aXRoIApwcm9ncmVzc2l2ZWx5IGluY3JlYXNpbmcgZ3JhbnVsYXJpdHkuIFZhcmlhbnRzIG9mIGhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nIAptZXRob2RzIHByaW1hcmlseSBkaWZmZXIgaW4gaG93IHRoZXkgY2hvb3NlIHRvIHBlcmZvcm0gdGhlIGFnZ2xvbWVyYXRpb25zLiAKRm9yIGV4YW1wbGUsIGNvbXBsZXRlIGxpbmthZ2UgYWltcyB0byBtZXJnZSBjbHVzdGVycyB3aXRoIHRoZSBzbWFsbGVzdCBtYXhpbXVtIApkaXN0YW5jZSBiZXR3ZWVuIHRoZWlyIGVsZW1lbnRzLCB3aGlsZSBXYXJk4oCZcyBtZXRob2QgYWltcyB0byBtaW5pbWl6ZSB0aGUgCmluY3JlYXNlIGluIHdpdGhpbi1jbHVzdGVyIHZhcmlhbmNlLgoKSW4gdGhlIGNvbnRleHQgb2Ygc2NSTkEtc2VxLCB0aGUgbWFpbiBhZHZhbnRhZ2Ugb2YgaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcgbGllcwppbiB0aGUgcHJvZHVjdGlvbiBvZiB0aGUgZGVuZHJvZ3JhbS4gVGhpcyBpcyBhIHJpY2ggc3VtbWFyeSB0aGF0IHF1YW50aXRhdGl2ZWx5CmNhcHR1cmVzIHRoZSByZWxhdGlvbnNoaXBzIGJldHdlZW4gc3VicG9wdWxhdGlvbnMgYXQgdmFyaW91cyByZXNvbHV0aW9ucy4gCkN1dHRpbmcgdGhlIGRlbmRyb2dyYW0gYXQgaGlnaCByZXNvbHV0aW9uIGlzIGFsc28gZ3VhcmFudGVlZCB0byB5aWVsZCBjbHVzdGVycyAKdGhhdCBhcmUgbmVzdGVkIHdpdGhpbiB0aG9zZSBvYnRhaW5lZCBhdCBhIGxvdy1yZXNvbHV0aW9uIGN1dDsgdGhpcyBjYW4gYmUKaGVscGZ1bCBmb3IgaW50ZXJwcmV0YXRpb24uIgoKSW5kZWVkLCBsb3ctcmVzb2x1dGlvbiBjbHVzdGVycyBjYW4gdHlwaWNhbGx5IGJlIGludGVycHJldGVkIGFzIHN1cGVyLWxldmVsIGNlbGwKdHlwZXMsIGxpa2UgaW1tdW5lIGNlbGxzLCBuZXVyb24gY2VsbHMgb3IgZW5kb3RoZWxpYWwgY2VsbHMuIEhpZ2hlciByZXNvbHV0aW9uCmNsdXN0ZXJzIGNvcnJlc3BvbmQgd2l0aCBhIGhpZ2hlciBiaW9sb2dpY2FsIHJlc29sdXRpb246IGltbXVuZSBjZWxsIC0+IApseW1waG9jeXRlIC0+IFQtY2VsbCAtPiBUaDEgY2VsbC4KCkhvd2V2ZXIsIG5vdGUgdGhhdCB3ZSBjYW4gYWxzbyBvdmVyY2x1c3RlciB0aGUgZGF0YSAoc3BsaXR0aW5nIGEgaG9tb2dlbm91cyAKc2V0IG9mIGNlbGxzIGluIG11bHRpcGxlIGNsdXN0ZXJzKSwgcmVzdWx0aW5nIGluIHNwdXJpb3VzIGNlbGwgdHlwZSAKaWRlbnRpZmljYXRpb24uCgpUaGUgYGNsdXN0ZXJDZWxsc2AgZnVuY3Rpb24gb2YgdGhlIGBzY3JhbmAgbGlicmFyeSBhbHNvIGFsbG93cyBmb3IgcGVyZm9ybWluZyAKaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcuIFRoaXMgY2FuIGJlIGltcGxlbWVudGVkIGFzIGZvbGxvd3M6CgpgYGAKIyB0YWtlcyA0IG1pbnV0ZXMKbGlicmFyeShibHVzdGVyKQpoY2x1c3Quc2NlIDwtIGNsdXN0ZXJDZWxscyh4ID0gc2NlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZS5kaW1yZWQgPSAiUENBIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJMVVNQQVJBTSA9IEhjbHVzdFBhcmFtKG1ldGhvZD0id2FyZC5EMiIpKQpgYGAKCkVxdWl2YWxlbnRseSwgd2UgbWF5IGFnYWluIHNwbGl0IHRoZSBwcm9jZXNzIGluIHR3byBzdGVwczoKCjEuIENvbXB1dGUgdGhlIHBhaXJ3aXNlIGRpc3RhbmNlcyBiZXR3ZWVuIGFsbCBjZWxscy4gVGhlc2UgYXJlIGJ5IGRlZmF1bHQgRXVjbGlkZWFuCmRpc3RhbmNlcyBhbmQsIGluIG9yZGVyIHRvIHJlZHVjZSBkYXRhIGNvbXBsZXhpdHkgYW5kIGluY3JlYXNlIHNpZ25hbCB0byBub2lzZSwgCndlIG1heSBwZXJmb3JtIHRoaXMgb24gdGhlIHRvcCAoMzApIFBD4oCZcywganVzdCBsaWtlIHdlIGRpZCB3aGVuIGNvbnN0cnVjdGluZyAKdGhlIFNOTiBncmFwaCBpbiBncmFwaC1iYXNlZCBjbHVzdGVyaW5nLiBDYWxjdWxhdGluZyBhIGRpc3NpbWlsYXJpdHkgbWF0cml4IAppcyBpbXBsZW1lbnRlZCBpbiB0aGUgYGRpc3RgIGZ1bmN0aW9uLgoKMi4gUGVyZm9ybSBhIGhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nIG9uIHRoZSBkaXN0YW5jZXMgZnJvbSBzdGVwIDEuIEluIGFuIAphZ2dsb21lcmF0aXZlIHByb2NlZHVyZSwgZWFjaCBjZWxsIGlzIGZpcnN0IGFzc2lnbmVkIHRvIGl0cyBvd24gY2x1c3RlciBhbmQgCnRoZW4gdGhlIGFsZ29yaXRobSBwcm9jZWVkcyBpdGVyYXRpdmVseSwgYXQgZWFjaCBzdGFnZSBqb2luaW5nIHRoZSB0d28gbW9zdCAKc2ltaWxhciBjbHVzdGVycywgY29udGludWluZyB1bnRpbCB0aGVyZSBpcyBqdXN0IGEgc2luZ2xlIGNsdXN0ZXIuIEltcGxlbWVudGVkIAppbiB0aGUgYGhjbHVzdGAgZnVuY3Rpb24uCgpOb3RlIHRoYXQgdGhlIGBoY2x1c3RgIGZ1bmN0aW9uIGFsbG93cyBmb3Igc3BlY2lmeWluZyBhICJtZXRob2QiIGFyZ3VtZW50LiAKVGhlIGRpZmZlcmVuY2VzIGJldHdlZW4gdGhlIGRpZmZlcmVudCBtZXRob2RzIGdvZXMgYmV5b25kIHRoZSBzY29wZSBvZiB0aGlzIApzZXNzaW9uLCBidXQgYSBicmllZiBkZXNjcmlwdGlvbiBpcyBwcm92aWRlZCBpbiB0aGUgZnVuY3Rpb24gaGVscCBmaWxlLiBJbiAKdGhlIGNvbnRleHQgb2Ygc2NSTkEtc2VxLCB3ZSByZWNvbW1lbmQgdGhlIHVzZSBvZiB0aGUgYCJ3YXJkLkQyImAgbWV0aG9kLgoKYGBge3IsZXZhbD1GQUxTRX0KZGlzdHNjZSA8LSBkaXN0KHJlZHVjZWREaW0oc2NlLCAiUENBIikpICMxbWluCmhjbCA8LSBoY2x1c3QoZGlzdHNjZSwgbWV0aG9kID0gIndhcmQuRDIiKSAjM21pbgpwbG90KGhjbCwgbGFiZWxzID0gRkFMU0UpCmBgYAoKTmV4dCwgaW4gb3JkZXIgdG8gZGVyaXZlIGEgZ2l2ZW4gc2V0IG9mIGNsdXN0ZXIgbGFiZWxzLCB3ZSBuZWVkIHRvIAoiY3V0IHRoZSB0cmVlIiwgaS5lLiwgY2hvb3NlIGF0IHdoaWNoIHJlc29sdXRpb24gd2Ugd2FudCB0byAKcmVwb3J0IHRoZSAoY2VsbCB0eXBlKSBjbHVzdGVycy4gVGhpcyBjYW4gYmUgYWNoaWV2ZWQgd2l0aCB0aGUgYGN1dHJlZWAgCmZ1bmN0aW9uLiBBcyBhbiBpbnB1dCwgYGN1dHJlZWAgdGFrZXMgdGhlIGRlbmRyb2dyYW0gZnJvbSB0aGUgYGhjbHVzdGAgZnVuY3Rpb24gCmFuZCBhIHRocmVzaG9sZCB2YWx1ZSBmb3IgY3V0dGluZyB0aGUgdHJlZS4gVGhlIGxhdHRlciBtYXkgYmUgZWl0aGVyIGBrYCwgdGhlIApudW1iZXIgb2YgY2x1c3RlcnMgd2Ugd2FudCB0byByZXBvcnQsIG9yIGBoYCwgdGhlIGhlaWdodCBvZiB0aGUgZGVuZHJvZ3JhbSBhdCAKd2hpY2ggd2Ugd2FudCB0byBjdXQgdGhlIHRyZWUuCgpgYGB7cixldmFsPUZBTFNFfQojIGN1dCB0byBnZXQgMTAgY2x1c3RlcnMKY2x1c3RfaGNsX2sxMCA8LSBjdXRyZWUoaGNsLCBrID0gMTApCnRhYmxlKGNsdXN0X2hjbF9rMTApCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KIyBjdXQgdG8gZ2V0IDM5IGNsdXN0ZXJzCmNsdXN0X2hjbF9rMzkgPC0gY3V0cmVlKGhjbCwgayA9IDM5KQp0YWJsZShjbHVzdF9oY2xfazM5KQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CnNjZSRjbHVzdF9oY2xfazEwIDwtIGFzLmZhY3RvcihjbHVzdF9oY2xfazEwKQpzY2UkY2x1c3RfaGNsX2szOSA8LSBhcy5mYWN0b3IoY2x1c3RfaGNsX2szOSkKCiMgVmlzdWFsaXphdGlvbi4gQWRkIHRoZSBjbHVzdGVyIGxhYmVscyB0byB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgVFNORQojIGNvb3JkaW5hdGVzCnBsb3RUU05FKHNjZSwgCiAgICAgICAgIGNvbG91cl9ieT0iY2x1c3RfaGNsX2sxMCIpCgpwbG90VFNORShzY2UsIAogICAgICAgICBjb2xvdXJfYnkgPSJjbHVzdF9oY2xfazM5IikKYGBgCgojIENsdXN0ZXJpbmcgaW4gdGhlIG9yaWdpbmFsIHBhcGVyCgpXaGVuIHdlIGNvbXBhcmUgb3VyIGNsdXN0ZXIgbGFiZWxzIHdpdGggdGhvc2UgZnJvbSB0aGUgb3JpZ2luYWwgcGFwZXIsIHdlJ2xsCnNlZSB0aGF0IHRoZSBjb3JyZXNwb25kZW5jZSBpcyBub3QgZ3JlYXQuIEFzIGEgZGVtb25zdHJhdGlvbiwgSSBtYWtlIGEgdGFibGUgYW5kIAphIGhlYXRtYXAgY29tcGFyaW5nIHRoZSBsb3ctcmVzb2x1dGlvbiBjbHVzdGVyIGxhYmVscyBmcm9tIHRoZSBwYXBlciB3aXRoIG91ciAKTG91dmFpbiwgTGVpZGVuMiBhbmQgaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcgKGs9MTApIGxhYmVsczoKCmBgYHtyLGV2YWw9RkFMU0V9CnRhYmxlKHNjZSRjbHVzdGVyX2xvd1Jlcywgc2NlJGNsdXN0ZXJfbG91dmFpbikKYGBgCgpgYGB7cixldmFsPUZBTFNFfQp0YWJsZShzY2UkY2x1c3Rlcl9sb3dSZXMsIHNjZSRjbHVzdGVyX2xlaWRlbjIpCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KdGFibGUoc2NlJGNsdXN0ZXJfbG93UmVzLCBzY2UkY2x1c3RfaGNsX2sxMCkKYGBgCgpgYGB7cixldmFsPUZBTFNFfQpwaGVhdG1hcDo6cGhlYXRtYXAodGFibGUoc2NlJGNsdXN0ZXJfbG93UmVzLCBzY2UkY2x1c3Rlcl9sb3V2YWluKSkKCnBoZWF0bWFwOjpwaGVhdG1hcCh0YWJsZShzY2UkY2x1c3Rlcl9sb3dSZXMsIHNjZSRjbHVzdGVyX2xlaWRlbjIpKQoKcGhlYXRtYXA6OnBoZWF0bWFwKHRhYmxlKHNjZSRjbHVzdGVyX2xvd1Jlcywgc2NlJGNsdXN0X2hjbF9rMTApKQpgYGAKCkFsc28sIHdoZW4gd2UgbG9vayBhdCB0aGUgdC1TTkUgZnJvbSB0aGUgb3JpZ2luYWwgcHVibGljYXRpb24sIHdlIG9ic2VydmUKY2xlYXJseSBkaXN0aW5jdCBjbHVzdGVyczoKCmBgYHtyLCBlY2hvPUZBTFNFfQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygiLi9tYWNvc2tvX2ZpZ3VyZV81Qi5qcGVnIikKYGBgCgpUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMgaXMgdGhhdCB0aGUgYXV0aG9ycyBvZiB0aGUgb3JpZ2luYWwgcGFwZXIgdXNlZCBxdWl0ZSBhIApkaWZmZXJlbnQgc3RyYXRlZ3kgZm9yIHBlcmZvcm1pbmcgdGhlIGZlYXR1cmUgc2VsZWN0aW9uIGFuZCBkaW1lbnNpb24gcmVkdWN0aW9uIAp0aGF0IHdlIGhhdmUgcGVyZm9ybWVkIGluIGxhYiBzZXNzaW9uIDIuCgpUbyBkZW1vbnN0cmF0ZSB0aGUgcGlwZWxpbmUgb2YgdGhlIG9yaWdpbmFsIGF1dGhvcnMsIGFuZCB0byBtYWtlIG91ciByZXN1bHRzIAptb3JlIGNvbXBhcmFibGUgdG8gdGhlaXJzLCBXZSB3aWxsIGhlcmUgbWltaWMgdGhlaXIgc3RyYXRlZ3kgZm9yIGZlYXR1cmUgCnNlbGVjdGlvbiBhbmQgY2x1c3RlcmluZy4gKipIb3dldmVyLCB3ZSB3aWxsIGRvIHRoaXMgYXBwcm94aW1hdGl2ZWx5ISoqIFdlIHdpbGwgCnRha2Ugc2ltaWxhciBzdGVwcyBjb25jZXB0dWFsbHksIGJ1dCB3aWxsIHJlbWFpbiB3aXRoaW4gdGhlIGN1cnJlbnQgCkJpb2NvbmR1Y3RvciBmcmFtZXdvcmsgYW5kIHRoZSByYW5nZSBvZiBmdW5jdGlvbnMgdGhhdCB3ZSBoYXZlIHNlZW4gaW4gdGhpcyAKbGVjdHVyZSBzZXJpZXMuCgpUaGUgYXV0aG9ycyBwZXJmb3JtZWQgdGhlIGZvbGxvd2luZyBzdGVwczoKCjEuICoqRmlsdGVyaW5nOioqIFRoZSBhdXRob3JzIGZpcnN0IGZpbHRlcmVkIHRoZSA0OSwzMDAtY2VsbCBkYXRhc2V0IHRvIHJldGFpbiAKb25seSBzaW5nbGUtY2VsbCBsaWJyYXJpZXMgd2hlcmUgYXQgbGVhc3QgOTAwIGdlbmVzIHdlcmUgZGV0ZWN0ZWQuCgoyLiAqKkZlYXR1cmUgc2VsZWN0aW9uOioqIFRoZSBhdXRob3JzIGZpcnN0IGlkZW50aWZpZWQgdGhlIHNldCBvZiBnZW5lcyB0aGF0IAp3ZXJlIG1vc3QgdmFyaWFibGUgYWNyb3NzIHRoZSBzZWxlY3RlZCBzdXNiZXQgb2YgY2VsbHMsIGFmdGVyIGNvbnRyb2xsaW5nIGZvciAKdGhlIHJlbGF0aW9uc2hpcCBiZXR3ZWVuIG1lYW4gZXhwcmVzc2lvbiBhbmQgdmFyaWFiaWxpdHkuIFRvIGRvIHRoaXMsIHRoZSAKYXV0aG9ycyBhZG9wdGVkIGEgbWFudWFsIGltcGxlbWVudGF0aW9uLgoKLT4gV2Ugd2lsbCBub3QgdXNlIHRoZSBleGFjdCBzYW1lIHN0cmF0ZWd5LCBidXQgdGhlIGBtb2RlbEdlbmVWYXItZ2V0VG9wSFZHc2AgCnN0cmF0ZWd5LCB3aGljaCBpcyBjb25jZXB0dWFsbHkgc2ltaWxhciBpbiBhZGRyZXNzaW5nIHRoZSBtZWFuLXZhcmlhbmNlIApyZWxhdGlvbnNoaXAgZHVyaW5nIGZlYXR1cmUgc2VsZWN0aW9uLgoKMy4gKipQcmluY2lwYWwgY29tcG9uZW50IGFuYWx5c2lzOioqIFRoZSBhdXRob3JzIHBlcmZvcm1lZCBQQ0EgYWZ0ZXIgc2NhbGluZyAKdGhlIGRhdGEuIFRoZXkgbmV4dCBwZXJmb3JtZWQgYSB0ZXN0IHRvIGRldGVybWluZSBob3cgbWFueSBQQ3MgY29udHJpYnV0ZWQgCnNpZ25pZmljYW50bHkgdG8gZXhwbGFpbmluZyB0aGUgdmFyaWFiaWxpdHkgaW4gdGhlIGRhdGEuIEJhc2VkIG9uIHRoaXMgdGVzdCwgCnRoZXkgY29udGludWVkIHRoZSBhbmFseXNpcyBwaXBlbGluZSB3aXRoIHRoZSB0b3AgMzIgUENzLgoKNC4gKip0LVNORToqKiBOZXh0LCB0aGUgYXV0aG9ycyBwZXJmb3JtZWQgYSB0LVNORSBvbiB0aGUgdG9wIDMyIFBD4oCZcywgc2V0dGluZyAKdGhlIGBwZXJwbGV4aXR5YCBwYXJhbWV0ZXIgb2YgdGhlIHQtU05FIGFsZ29yaXRobSB0byAzMC4KCjUuICoqUHJvamVjdGlvbiBvZiByZW1haW5pbmcgY2VsbHMgYW5kIGNsdXN0ZXJpbmc6KiogRmluYWxseSwgdGhlIGF1dGhvcnMgCmFkb3B0ZWQgYSBtYW51YWxseSBpbXBsZW1lbnRlZCwgcmF0aGVyIGNvbXBsZXggc3RyYXRlZ3kgdG8gcHJvamVjdCB0aGUgCnJlbWFpbmluZyBjZWxscyAod2hlcmUgbGVzcyB0aGFuIDkwMCBkaWZmZXJlbnQgZ2VuZXMgd2VyZSBkZXRlY3RlZCkgb24gdGhlIAp0LVNORSBlbWJlZGRpbmcgb2J0YWluZWQgaW4gc3RlcCA0LiBOZXh0LCB0aGV5IGNsdXN0ZXIgdGhlIGNlbGxzIHVzaW5nIGEgCmRlbnNpdHkgY2x1c3RlcmluZyAoREJTQ0FOIGFsZ29yaXRobSkgdGhhdCB3YXMgbm90IGRpc2N1c3NlZCBpbiB0aGlzIGxlY3R1cmUgCnNlcmllcy4gQmVjYXVzZSB0aGlzIDV0aCBzdGVwIHVzZXMgdGVjaG5pcXVlcyBiZXlvbmQgdGhlIHNjb3BlIG9mIHRoaXMgY291cnNlLCAKd2Ugd2lsbCBzaW1wbHkgY29udGludWUgd29ya2luZyB3aXRoIHRoZSBmaWx0ZXJlZCBkYXRhc2V0IGFuZCBwZXJmb3JtIApoaWVyYXJjaGljYWwgY2x1c3RlcmluZy4gSG93ZXZlciwgd2UgaW5jbHVkZWQgc29tZSBjb2RlIHRoYXQgYWxsb3dzIHlvdSB0byBkbyAKc29tZXRoaW5nIHNpbWlsYXIgdG8gd2hhdCB0aGUgYXV0aG9ycyBkaWQgZm9yIHlvdXIgcmVmZXJlbmNlIChub3RlIHRoYXQgcnVubmluZyAgCnRoaXMgY29kZSByZXF1aXJlcyBpbnN0YWxsaW5nIHRoZSBgc25pZnRlcmAgUiBwYWNrYWdlLCB3aGljaCByZXF1aXJlcyBhIHdvcmtpbmcKUHl0aG9uIGFuZCBDb25kYSBpbnN0YWxsYXRpb24pLgoKYGBge3IsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CiMgY29kZSBmb3Igc3RlcHMgMS00CmxpYnJhcnkoc2NhdGVyKQpsaWJyYXJ5KGdlbmVmaWx0ZXIpCmxpYnJhcnkoc2NyYW4pCgojIFN0ZXAgMTogRG93bnNhbXBsaW5nCnNjZV85MDAgPC0gc2NlWyxzY2UkZGV0ZWN0ZWQgPiA5MDBdCgojIFN0ZXAgMjogRmVhdHVyZSBzZWxlY3Rpb24Kc2NlXzkwMCA8LSBsb2dOb3JtQ291bnRzKHNjZV85MDApCmRlY185MDAgPC0gbW9kZWxHZW5lVmFyKHNjZV85MDApCmh2Z185MDAgPC0gZ2V0VG9wSFZHcyhkZWNfOTAwLAogICAgICAgICAgICAgICAgICAgICAgbiA9IDM3NCkgIyBzYW1lIG51bWJlciBvZiB0b3AgZmVhdHVyZXMgYXMgb3JpZ2luYWwgcGFwZXIKCiMgU3RlcCAzOiBQQ0EKc2V0LnNlZWQoMTIzNCkKc2NlXzkwMCA8LSBydW5QQ0Eoc2NlXzkwMCwgCiAgICAgICAgICAgICAgICAgIG5jb21wb25lbnRzID0gMzIsICMgc2FtZSBudW1iZXIgb2YgUENzIGFzIG9yaWdpbmFsIHBhcGVyCiAgICAgICAgICAgICAgICAgIHN1YnNldF9yb3cgPSBodmdfOTAwLAogICAgICAgICAgICAgICAgICBzY2FsZT1UUlVFKSAjIHNjYWxlIHRoZSBkYXRhIGxpa2UgaW4gb3JpZ2luYWwgcGFwZXIKCiMgU3RlcCA0OiBULVNORQpzZXQuc2VlZCg0ODQ4NTQpCnNjZV85MDAgPC0gcnVuVFNORShzY2VfOTAwLCAKICAgICAgICAgICAgICAgZGltcmVkID0gJ1BDQScsCiAgICAgICAgICAgICAgIG5fZGltcmVkID0gMzIsCiAgICAgICAgICAgICAgIHBlcnBsZXhpdHkgPSAzMCkgIyBzYW1lIHBlcnBsZXhpdHkgYXMgb3JpZ2luYWwgcGFwZXIKYGBgCgpgYGAKIyBTdGVwIDUgYXV0aG9ycyAoanVzdCBmb3IgeW91ciByZWZlcmVuY2UpOiBwcm9qZWN0IG5ldyBjZWxscyBvbiB0LVNORSBlbWJlZGRpbmcKI0Jpb2NNYW5hZ2VyOjppbnN0YWxsKCJzbmlmdGVyIikKbGlicmFyeShzbmlmdGVyKQp0c25lMSA8LSBzbmlmdGVyOjpmaXRzbmUocmVkdWNlZERpbShzY2VfOTAwLCB0eXBlPSJQQ0EiKSkKZW1iZWRkaW5nIDwtIHJlZHVjZWREaW0oc2NlW2h2Z185MDAsc2NlJGRldGVjdGVkPjkwMF0sIHR5cGU9IlBDQSIpCgpnZ3Bsb3QoKSArCiAgYWVzKHRzbmUxWywgMV0sIHRzbmUxWywgMl0sIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZD45MDBdJGNsdXN0ZXIpKSArCiAgZ2VvbV9wb2ludChwY2ggPSAxOSkgKwogIHNjYWxlX2NvbG91cl9kaXNjcmV0ZShuYW1lID0gIkNsdXN0ZXIiKSArCiAgbGFicyh4ID0gInQtU05FIDEiLCB5ID0gInQtU05FIDIiKSArCiAgdGhlbWVfYncoKQoKbmV3X2Nvb3JkcyA8LSBwcm9qZWN0KHRzbmUxLCAKICAgICAgICAgICAgICAgICAgICAgIG5ldyA9IHJlZHVjZWREaW0oc2NlWyxzY2UkZGV0ZWN0ZWQ8PTkwMF0sIHR5cGU9IlBDQSIpLCAKICAgICAgICAgICAgICAgICAgICAgIG9sZCA9IHJlZHVjZWREaW0oc2NlWyxzY2UkZGV0ZWN0ZWQ+OTAwXSwgdHlwZT0iUENBIikpCmdncGxvdCgpICsKICAgIGdlb21fcG9pbnQoCiAgICAgICAgYWVzKHRzbmUxWywgMV0sIHRzbmUxWywgMl0sCiAgICAgICAgICAgIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZD45MDBdJGNsdXN0ZXIpLAogICAgICAgICAgICBzaGFwZSA9ICJlbWJlZGRpbmciCiAgICAgICAgKQogICAgKSArCiAgICBnZW9tX3BvaW50KAogICAgICAgIGFlcyhuZXdfY29vcmRzWywgMV0sIG5ld19jb29yZHNbLCAyXSwgCiAgICAgICAgICAgIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZDw9OTAwXSRjbHVzdGVyKSwKICAgICAgICAgICAgc2hhcGUgPSAicHJvamVjdGlvbiIKICAgICAgICApCiAgICApICsKICAgIHNjYWxlX2NvbG91cl9kaXNjcmV0ZShuYW1lID0gIkNlbGwgdHlwZSIpICsKICAgIHNjYWxlX3NoYXBlX2Rpc2NyZXRlKG5hbWUgPSBOVUxMKSArCiAgICBsYWJzKHggPSAidC1TTkUgMSIsIHkgPSAidC1TTkUgMiIpICsKICAgIHRoZW1lX2J3KCkKYGBgCgpgYGB7cn0KIyBTdGVwIDUgZm9yIHVzOiBwZXJmb3JtIGhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nCmRpc3RzY2UgPC0gZGlzdChyZWR1Y2VkRGltKHNjZV85MDAsICJQQ0EiKSkKaGNsIDwtIGhjbHVzdChkaXN0c2NlLCBtZXRob2QgPSAid2FyZC5EMiIpCgpjbHVzdF9oY2xfazEwIDwtIGN1dHJlZShoY2wsIGsgPSAxMCkKY2x1c3RfaGNsX2szOSA8LSBjdXRyZWUoaGNsLCBrID0gMzkpCgpzY2VfOTAwJGNsdXN0X2hjbF9rMTAgPC0gYXMuZmFjdG9yKGNsdXN0X2hjbF9rMTApCnNjZV85MDAkY2x1c3RfaGNsX2szOSA8LSBhcy5mYWN0b3IoY2x1c3RfaGNsX2szOSkKYGBgCgpWaXN1YWxpemUgb3VyIGxhYmVscyBhbmQgY29tcGFyZSB3aXRoIG9yaWdpbmFsIGxhYmVscwoKYGBge3J9CnBsb3RUU05FKHNjZV85MDAsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdF9oY2xfazEwIiwKICAgICAgICAgdGV4dF9ieSA9ICJjbHVzdF9oY2xfazEwIikKCnBsb3RUU05FKHNjZV85MDAsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyX2xvd1JlcyIsCiAgICAgICAgIHRleHRfYnkgPSAiY2x1c3Rlcl9sb3dSZXMiKQpgYGAKCkZvciB0aGUgbG93IHJlc29sdXRpb24gbGFiZWxzLCB3ZSBvYnNlcnZlIGEgc3Ryb25nIGNvcnJlc3BvbmRlbmNlIGJldHdlZW4gb3VyCmNsdXN0ZXJpbmcgYW5kIHRoYXQgb2YgdGhlIG9yaWdpbmFsIGF1dGhvcnMuIE1vcmUgc3BlY2lmaWNhbGx5OgoKLSBUaGUgb3JpZ2luYWwgcm9kcyBjb3JyZXNwb25kIHdpdGggb3VyIGdyb3VwIDUKLSBUaGUgb3JpZ2luYWwgY29uZXMgY29ycmVzcG9uZCB3aXRoIG91ciBncm91cCAyCi0gVGhlIG9yaWdpbmFsIHBlcmljeXRlcyBhbmQgdmFzY3VsYXIgZW5kb3RoZWxpdW0gY29ycmVzcG9uZCB3aXRoIG91ciBncm91cCA3Ci0gVGhlIG9yaWdpbmFsIG11bGxlciBnbGlhLCBhc3Ryb2N5dGVzLCBmaWJyb2JsYXN0cyBhbmQgbWljcm9nbGlhICh3aGljaCBhcmUgCnNpbWlsYXIgY2VsbCB0eXBlcywgc2VlIHBhcGVyIGZpZ3VyZSA1RCkgY29ycmVzcG9uZCB3aXRoIG91ciBncm91cCA4Ci0gVGhlIG9yaWdpbmFsIGdhbmdsaW9uIGFuZCBob3Jpem9udGFsIGNlbGxzICh3aGljaCBhcmUgc2ltaWxhciBjZWxsIHR5cGVzLCAKc2VlIHBhcGVyIGZpZ3VyZSA1RCkgY29ycmVzcG9uZCB3aXRoIG91ciBncm91cCAxCi0gVGhlIG9yaWdpbmFsIGJpcG9sYXIgY2VsbHMgYXJlIHNwbGl0IG91dCBiZXR3ZWVuIG91ciBncm91cHMgNCBhbmQgMTAKLSBUaGUgb3JpZ2luYWwgYW1hY3JpbmUgY2VsbHMgY29ycmVzcG9uZCB3aXRoIG91ciBncm91cHMgMywgNiBhbmQgOQoKYGBge3J9CnBsb3RUU05FKHNjZV85MDAsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdF9oY2xfazM5IiwKICAgICAgICAgdGV4dF9ieSA9ICJjbHVzdF9oY2xfazM5IikKCnBsb3RUU05FKHNjZV85MDAsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIiwKICAgICAgICAgdGV4dF9ieSA9ICJjbHVzdGVyIikKYGBgCgpJIHdpbGwgbm90IG1ha2UgYW4gZXh0ZW5zaXZlIGNvbXBhcmlzb24gaGVyZS4gSG93ZXZlciwgbm90ZSB0aGF0IHdlIHNlZQpzZXZlcmFsIHNjZW5hcmlvczoKCjEuIENsdXN0ZXJzIHRoYXQgY29ycmVzcG9uZCBvbmUtb24tb25lIChlLmcuLCBvdXIgY2x1c3RlciAxOSB3aXRoIGNsdXN0ZXIgMTYgb2YKdGhlIGF1dGhvcnMpCgoyLiBXZSBzcGxpdCB1cCBzb21lIGNsdXN0ZXJzIGluIG11bHRpcGxlIHNldHMgKGUuZy4sIG91ciBjbHVzdGVycyAxNiwgMTggYW5kCjMyKSB0aGF0IGFyZSBqdXN0IDEgY2x1c3RlciBpbiB0aGUgYW5hbHlzaXMgb2YgdGhlIGF1dGhvcnMgKGNsdXN0ZXIgMzQpCgozLiBXZSBhZ2dyZWdhdGUgc29tZSBjbHVzdGVycyBpbnRvIDEgKGUuZy4gY2x1c3RlciAxNCkgdGhhdCBhcmUgc3BsaXQgdXAgaW4gdGhlCm9yaWdpbmFsIHJlc3VsdHMgKGNsdXN0ZXJzIDM3IGFuZCAzOCkKCioqT3ZlcmFsbCwgd2Ugb2JzZXJ2ZSBhIHJhdGhlciBzdHJvbmcgY29ycmVzcG9uZGVuY2UgYmV0d2VlbiBvdXIgY2x1c3RlcnMgYW5kKioKKip0aG9zZSBvZiB0aGUgYXV0aG9ycy4qKiBBbHNvIG5vdGUgdGhhdCBvdXIgdC1TTkUgdmlzdWFsaXphdGlvbiBub3cgcmVzZW1ibGVzCnRoZSB0LVNORSBtYXAgb2YgdGhlIG9yaWdpbmFsIGF1dGhvcnMgbXVjaCBtb3JlIGNsb3NlbHk6CgpgYGB7cn0Ka25pdHI6OmluY2x1ZGVfZ3JhcGhpY3MoIi4vbWFjb3Nrb19maWd1cmVfNUIuanBlZyIpCmBgYAoKIyBDZWxsIHR5cGUgYW5ub3RhdGlvbgoKIyMgU3VwZXJ2aXNlZDogdXNpbmcgYSBsaW1pdGVkIHNldCBvZiBrbm93biBtYXJrZXJzCgpJbiB0aGUgcHVibGljYXRpb24sIHRoZSBhdXRob3JzIGFpbWVkIHRvIGlkZW50aWZ5IHRoZSBkaWZmZXJlbnQgY2x1c3RlcnMgaW4gdGhlCmRhdGEgYnkgdXNpbmcgYSBzZXQgb2YgMTIgd2VsbC1rbm93biBtb2xlY3VsYXIgbWFya2VyczsgZ2VuZXMgZm9yIHdoaWNoIHRoZQpleHByZXNzaW9uIHByb2ZpbGUgaXMgdHlwaWNhbGx5IHZlcnkgc3BlY2lmaWMsIGkuZS4sIGhpZ2hseSBleHByZXNzZWQgb25seSBpbgpvbmUgc3BlY2lmaWMgY2VsbCB0eXBlLiBUaGV5IHVzZWQgdGhlIGZvbGxvd2luZyBtYXJrZXJzOiAKCmBgYHtyfQptYXJrZXJzIDwtIGMoIkxIWDEiLCAiU0xDMTdBNiIsIlBBWDYiLCJHQUQxIiwiU0xDNkE5IiwiT1BOMU1XIiwiVlNYMiIsCiAgICAgICAgICAgICAiUkxCUDEiLCAiR0ZBUCIsICJQRUNBTTEiLCAiS0NOSjgiLCJDWDNDUjEiKQpgYGAKCldlIHdpbGwgaGVyZSB2aXN1YWxpemUgdGhlIGV4cHJlc3Npb24gb2YgdGhlc2UgbWFya2VycyBpbiB0LVNORSBzcGFjZS4KRmlyc3QsIHdlIGNyZWF0ZSBhICJiYXNlbGluZSIgZmlndXJlLCBkaXNwbGF5aW5nIGVhY2ggY2VsbCBpbiAyRCBzcGFjZSwgY29sb3JlZAppbiBibGFjay4KCmBgYHtyLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KGdncGxvdDIpCmdnX2hscF9kYXRhIDwtIGRhdGEuZnJhbWUoeCA9IHJlZHVjZWREaW0oc2NlXzkwMCwgdHlwZSA9ICJUU05FIilbLDFdLAogICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSByZWR1Y2VkRGltKHNjZV85MDAsIHR5cGUgPSAiVFNORSIpWywyXSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjbHVzdGVyID0gc2NlXzkwMCRjbHVzdGVyKQpnZ19iYXNlIDwtIGdncGxvdChkYXRhID0gZ2dfaGxwX2RhdGFbIWlzLm5hKHNjZV85MDAkY2x1c3RlciksXSwKICAgICAgICAgICAgICAgICAgYWVzKHggPSB4LCB5ID0geSwpKSArCiAgICBnZW9tX3BvaW50KHNpemU9MC40KSArCiAgICB0aGVtZV9idygpICsKICAgIHhsYWIoIlRTTkUgMSIpICsKICAgIHlsYWIoIlRTTkUgMiIpCmdnX2Jhc2UKYGBgCgpOZXh0LCB3ZSBvYnRhaW4gdGhlIGNvdW50cyBvZiB0aGUgMTIgcHJlLXNlbGVjdGVkIG1hcmtlciBnZW5lcyBmb3IgYWxsIGNlbGxzLgoKYGBge3J9Cm1hcmtlcl9jb3VudHMgPC0gYXNzYXlzKHNjZV85MDApJGNvdW50c1ttYXJrZXJzLF0KbWFya2VyX2NvdW50cyA8LSBhcy5tYXRyaXgodChtYXJrZXJfY291bnRzKSkKYGBgCgpGaW5hbGx5LCB3ZSBtYWtlIG9uZSBmaWd1cmUgZm9yIGVhY2ggb2YgdGhlIDEyIG1hcmtlciBnZW5lcy4gVGhlIGlkZWEgaXMgdG8KZ2l2ZSBlYWNoIGNlbGwgdGhhdCBoYXMgYSBub24temVybyBleHByZXNzaW9uIG9mIHRoZSBtYXJrZXIgKGkuZS4sIGZvciB3aGljaAp0aGUgbWFya2VyIGlzIGV4cHJlc3NlZCkgYSByZWQgY29sb3JpbmcuCgpgYGB7cn0KbWFya2VyX2NvdW50c19iaW5hcnkgPC0gbWFya2VyX2NvdW50cwptYXJrZXJfY291bnRzX2JpbmFyeVt3aGljaChtYXJrZXJfY291bnRzX2JpbmFyeSA+IDApXSA8LSAxCgpmb3IgKGkgaW4gc2VxX2Fsb25nKG1hcmtlcnMpKSB7CiAgICBnZyA8LSBnZ3Bsb3QoZGF0YSA9IGdnX2hscF9kYXRhWyFpcy5uYShzY2VfOTAwJGNsdXN0ZXIpLF0sCiAgICAgICAgICAgICAgICAgICAgYWVzKHggPSB4LCB5ID0geSkpICsKICAgICAgICBnZW9tX3BvaW50KGFlcyhjb2xvciA9IGFzLmZhY3RvcihtYXJrZXJfY291bnRzX2JpbmFyeVssaV0pWyFpcy5uYShzY2VfOTAwJGNsdXN0ZXIpXSksIHNpemUgPSAwLjQpICsKICAgICAgICBzY2FsZV9jb2xvcl9tYW51YWwodmFsdWVzPWMoImJsYWNrIiwicmVkIikpICsKICAgICAgICB4bGFiKCJUU05FIDEiKSArCiAgICAgICAgeWxhYigiVFNORSAyIikgKwogICAgICAgIGdndGl0bGUoY29sbmFtZXMobWFya2VyX2NvdW50c19iaW5hcnkpW2ldKSArCiAgICAgICAgdGhlbWVfYncoKSArIAogICAgICB0aGVtZShsZWdlbmQudGl0bGUgPSBlbGVtZW50X2JsYW5rKCkpCiAgICBwcmludChnZykKfQpgYGAKCmBgYHtyfQojIFZpc3VhbGl6ZSBvdXIgY2x1c3RlcnMKcGxvdFRTTkUoc2NlXzkwMCwKICAgICAgICAgY29sb3VyX2J5ID0gImNsdXN0X2hjbF9rMzkiLAogICAgICAgICB0ZXh0X2J5ID0gImNsdXN0X2hjbF9rMzkiKQpgYGAKCkZyb20gZmlndXJlIDVELCB3ZSBvYnRhaW4gdGhlIG1hcmtlci1jZWxsIHR5cGUgcmVsYXRpb25zaGlwLCAKCmBgYHtyfQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygiLi9tYWNvc2tvX2ZpZ3VyZV81RC5qcGVnIikKYGBgCgphbmQgZHJhdyB0aGUgZm9sbG93aW5nIGNvbmNsdXNpb25zOgoKLSBUaGUgKkxIWDEqIG1hcmtlciBpcyBzcGVjaWZpYyBmb3IgaG9yaXpvbnRhbCBjZWxscy4gQXMgc3VjaCwgb3VyICoqY2x1c3RlciAzKioKY29ycmVzcG9uZHMgdG8gKipob3Jpem9udGFsIGNlbGxzKiouCgotIFRoZSAqU0xDMTdBNiogbWFya2VyIGlzIHNwZWNpZmljIGZvciBnYW5nbGlvbiBjZWxscy4gQXMgc3VjaCwgb3VyICoqY2x1c3RlciAxKioKY29ycmVzcG9uZHMgdG8gKipnYW5nbGlvbiBjZWxscyoqLgoKLSBUaGUgKlBBWDYqIG1hcmtlciBpcyBub3Qgc3BlY2lmaWMuIEl0IGlzIGV4cHJlc3NlZCBpbiBob3Jpem9udGFsIGNlbGxzLCBnYW5nbGlvbgpjZWxscywgYW1hY3JpbmUgY2VsbHMgKGFsbCBzdWJ0eXBlcyksIG11bGxlciBnbGlhIGNlbGxzIGFuZCBmaWJyb2JsYXN0cy4gRmlyc3QsCnRoaXMgcmVjb25maXJtcyBvdXIgcHJldmlvdXMgc3RhdGVtZW50cyBhYm91dCBjbHVzdGVycyAzIGFuZCAxLCB3aGljaCBpbmRlZWQgCnNob3VsZCBhbHNvIGV4cHJlc3MgKlBBWDYqLiBTZWNvbmQsIG1hbnkgY2x1c3RlcnMgYXJlIHBvdGVudGlhbCBjYW5kaWRhdGVzIGZvciAKYmVpbmcgYW55IG9mIHRoZSByZW1haW5pbmcgY2VsbCB0eXBlcyB0byBleHByZXNzICpQQVg2Ki4gVGhlIG5leHQgbWFya2VyIHNob3VsZApwb2ludCB1cyB0byB0aGVpciBtb3JlIGV4YWN0IGlkZW50aXR5LgoKLSBUaGUgKkdBRDEqIG1hcmtlciBpcyBzcGVjaWZpYyBmb3IgYW1hY3JpbmUgY2VsbHMuIEluIGFkZGl0aW9uLCBpdCBpcyBvbmx5IApleHByZXNzZWQgaW4gIkdBQkFlcmdpYyIgYW1hY3JpbmUgY2VsbHMsIHdoaWNoIGFmZmVjdCB0aGUgbmV1cm90cmFuc21pdHRlciBHQUJBLgpBcyBzdWNoLCAqKmNsdXN0ZXJzIDQsIDUsIDYsIDgsIDksIDExLCAxMywgMjksIDMwIGFuZCAzMSBhcmUgR0FCQWVyZ2ljKioKKiphbWFjcmluZSBjZWxscyoqLiBDb252ZXJzZWx5LCB0aGUgY2x1c3RlcnMgdGhhdCBleHByZXNzICpQQVg2KiBidXQgbm90ICpHQUQxKgooY2x1c3RlcnMgMTYsIDE4LCAxOSwgMjIsIDIzLCAyNCwgMjYsIDMyLCAzNikgYXJlIGVpdGhlciBub24tR0FCQWVyZ2ljIAphbWFjcmluZSBjZWxscywgbXVsbGVyIGdsaWEgY2VsbHMgb3IgZmlicm9ibGFzdHMuCgotIFRoZSAqU0xDNkE5KiBtYXJrZXIgaXMgc3BlY2lmaWMgZm9yIGdseWNpbmVyZ2ljIGFtYWNyaW5lIGNlbGxzLCBpLmUuLCAKYWZmZWN0aW5nIHRoZSBuZXVyb3RyYW5zbWl0dGVyIGdseWNpbmUuIEFzIHN1Y2gsICoqY2x1c3RlcnMgMTksIDIyLCAyMywgMjYgYW5kIDM2KioKYXJlIHRoZSBnbHljaW5lcmdpYyBhbWFjcmluZSBjZWxscy4gSW4gYWRkaXRpb24sIHdlIGhhdmUgY2x1c3RlcnMgMTYsIDE4LCAyNCBhbmQKMzIgdGhhdCBleHByZXNzICpQQVg2KiwgYnV0IG5vdCAqR0FEMSogbm9yICpTTEM2QTkqLiBBcyBzdWNoLCB0aGVzZSBjZWxscyAKc2hvdWxkIGJlIGVpdGhlciBtdWxsZXIgZ2xpYSBjZWxscyBvciBmaWJyb2JsYXN0cy4KCi0gVGhlICpPUE4xTVcqIG1hcmtlciBpcyBzcGVjaWZpYyBmb3IgY29uZXMuIEFzIHN1Y2gsIG91ciAqKmNsdXN0ZXJzIDIsIDM0IGFuZCAzNSoqCmNvcnJlc3BvbmRzIHRvICoqY29uZXMqKi4KCi0gVGhlICpWU1gyKiBtYXJrZXIgaXMgc3Ryb25nbHkgZXhwcmVzc2VkIGluICoqYmlwb2xhciBjZWxscyoqLiBJbiBhZGRpdGlvbiwgaXQKaXMgbG93bHkgZXhwcmVzc2VkIGluICoqbXVsbGVyIGdsaWEgY2VsbHMqKiBhbmQgKipmaWJyb2JsYXN0cyoqLiBBcyBzdWNoLCAKKipjbHVzdGVycyA3LCAxMCwgMTUsIDE2LCAxOCwgMjAsIDIxLCAyNSwgMjcsIDMyLCAzMywgMzcgYW5kIDM4Kiogc2hvdWxkIGJlbG9uZwp0byBvbmUgb2YgdGhlc2UgY2VsbCB0eXBlcy4KCi0gVGhlICpSTEJQMSogbWFya2VyIGlzIHNwZWNpZmljIGZvciBtdWxsZXIgZ2xpYSBjZWxscyBhbmQgYXN0cm9jeXRlcy4gU2luY2UKY2x1c3RlcnMgMTYsIDE4IGFuZCAzMiBleHByZXNzICpSTEJQMSogYW5kICpQQVg2KiwgYnV0IG5vdCAqR0FEMSogbm9yICpTTEM2QTkqLAp3ZSBub3cgaGF2ZSB2ZXJ5IHN0cm9uZyBldmlkZW5jZSB0aGF0IHRoZXNlIGFyZSBtdWxsZXIgZ2xpYSBjZWxscy4KCi0gVGhlICpHRkFQKiBtYXJrZXIgaXMgc3BlY2lmaWMgZm9yIGFzdHJvY3l0ZXMuIEFzIHN1Y2gsIG91ciAqKmNsdXN0ZXJzIDI0KiosCndoaWNoIGFsc28gZXhwcmVzc2VzICpSTEJQMSosIHNob3VsZCBjb3JyZXNwb25kIHRvICoqYXN0cm9jeXRlcyoqLgoKLSBUaGUgKlBFQ0FNMSogbWFya2VyIGlzIHNwZWNpZmljIGZvciBwZXJpY3l0ZXMgQXMgc3VjaCwgb3VyICoqY2x1c3RlcnMgMTQqKiwgCnNob3VsZCBjb3JyZXNwb25kIHRvICoqcGVyaWN5dGVzKiouCgotIFRoZSAqUEVDQU0xKiBtYXJrZXIgaXMgc3BlY2lmaWMgZm9yIHZhc2N1bGFyIGVuZG90aGVsaXVtIGNlbGxzLiBBcyBzdWNoLCAKb3VyICoqY2x1c3RlcnMgMTQqKiwgc2hvdWxkIGNvcnJlc3BvbmQgdG8gKip2YXNjdWxhciBlbmRvdGhlbGl1bSBjZWxscyoqLgoKLSBUaGUgKktDTko4KiBtYXJrZXIgaXMgc3BlY2lmaWMgZm9yIHBlcmljeXRlcy4gQXMgc3VjaCwgb3VyICoqY2x1c3RlcnMgMTQqKiwgCnNob3VsZCBjb3JyZXNwb25kIHRvICoqcGVyaWN5dGVzKiouIE5vdGUgdGhhdCBpdCB0aHVzIGFwcGVhcnMgdGhhdCBvdXIgCmNsdXN0ZXJpbmcgcHJvY2VkdXJlIHdhcyBub3QgYWJsZSB0byBkaWZmZXJlbnRpYXRlIGJldHdlZW4gdmFzY3VsYXIgZW5kb3RoZWxpdW0gCmNlbGxzIGFuZCBwZXJpY3l0ZXMsIHdoaWNoIGJvdGggYXJlIGxpa2VseSB0byBiZSBwcmVzZW50IGluIGNsdXN0ZXIgMTQhCgotIFRoZSAqQ1gzQ1IxKiBtYXJrZXIgaXMgc3BlY2lmaWMgZm9yIG1pY3JvZ2xpYS4gSG93ZXZlciwgd2UgZG8gbm90IHNlZW0gdG8Kb2JzZXJ2ZSBhbnkgY2VsbHMgdGhhdCB3ZXJlIGlkZW50aWZpZWQgYXMgbWljcm9nbGlhIGJ5IHRoZSBvcmlnaW5hbCBwdWJsaWNhdGlvbi4KCi0gTGFzdCBidXQgbm90IGxlYXN0LCB0aGUgYXV0aG9ycyBoYXZlIGlkZW50aWZpZWQgdGhlIHJvZCBjZWxscyBhcyBjZWxscyB0aGF0CmRvIG5vdCBleHByZXNzIGFueSBvZiB0aGUgYWZvcmVtZW50aW9uZWQgbWFya2Vycy4gQXMgc3VjaCwgd2UgYXJlIGFibGUgdG8KaWRlbnRpZnkgb3VyICoqY2x1c3RlcnMgMTIgYW5kIDE3KiogYXMgKipyb2QgY2VsbHMqKi4KCiMjIFN1cGVydmlzZWQ6IFVzaW5nIG1hcmtlciBnZW5lcyBkZXRlY3RlZCBmcm9tIHRoaXMgZGF0YQoKU29tZXRpbWVzIGl0IHdpbGwgYmUgdmVyeSBkaWZmaWN1bHQgdG8gc2V0IHVwIGEgcGFuZWwgb2Yga25vd24gbWFya2VyIGdlbmVzIAp0aGF0IHdvdWxkIGFsbG93IHVzIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gYWxsIGNlbGwgdHlwZXMgaW4gb3VyIGRhdGFzZXQuCkZvciBpbnN0YW5jZSwgc29tZXRpbWVzIHdlIG1heSBub3Qga25vdyBpbiBhZHZhbmNlIHdoaWNoIGNlbGwgdHlwZXMgdG8gZXhwZWN0LApvciB3ZSBtYXkgbm90IGhhdmUgZ29vZCBpbmZvcm1hdGlvbiBvbiByZWxldmFudCBtYXJrZXJzIChpZiB0aGUgc3R1ZGllZCBzeXN0ZW0KaXMgbm90IHdlbGwga25vd24pLgoKQW4gYWx0ZXJuYXRpdmUgc3RyYXRlZ3kgaXMgdG8gaWRlbnRpZnkgdGhlIGdlbmVzIHRoYXQgZHJpdmUgc2VwYXJhdGlvbiBiZXR3ZWVuIApjbHVzdGVycy4gVGhlc2UgbWFya2VyIGdlbmVzIGFsbG93IHVzIHRvIGFzc2lnbiBiaW9sb2dpY2FsIG1lYW5pbmcgdG8gZWFjaCAKY2x1c3RlciBiYXNlZCBvbiB0aGVpciBmdW5jdGlvbmFsIGFubm90YXRpb24uIFRoaXMgc3RyYXRlZ3kgaXMgcmVmZXJyZWQgdG8gYXMgCioqbWFya2VyIGdlbmUgZGV0ZWN0aW9uKiouIAoKVGhlIG1vc3Qgc3RyYWlnaHRmb3J3YXJkIGFwcHJvYWNoIHRvIG1hcmtlciBnZW5lIGRldGVjdGlvbiBpbnZvbHZlcyB0ZXN0aW5nIApmb3IgZGlmZmVyZW50aWFsIGV4cHJlc3Npb24gKERFKSBiZXR3ZWVuIGNsdXN0ZXJzLiBJZiBhIGdlbmUgaXMgc3Ryb25nbHkgREUgCmJldHdlZW4gY2x1c3RlcnMsIGl0IGlzIGxpa2VseSB0byBoYXZlIGRyaXZlbiB0aGUgc2VwYXJhdGlvbiBvZiBjZWxscyBpbiB0aGUgCmRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbi4gVGhlIGdlbmVyYWwgc3RyYXRlZ3kgaXMgdG8gY29tcGFyZSBlYWNoIHBhaXIgb2YgY2x1c3RlcnMgCmFuZCBjb21wdXRlIHNjb3JlcyBxdWFudGlmeWluZyB0aGUgZGlmZmVyZW5jZXMgaW4gdGhlIGV4cHJlc3Npb24gZGlzdHJpYnV0aW9ucyAKYmV0d2VlbiBjbHVzdGVycy4gVGhlIHNjb3JlcyBmb3IgYWxsIHBhaXJ3aXNlIGNvbXBhcmlzb25zIGludm9sdmluZyBhIApwYXJ0aWN1bGFyIGNsdXN0ZXIgYXJlIHRoZW4gY29uc29saWRhdGVkIGludG8gYSBzaW5nbGUgZGF0YSBmcmFtZSBmb3IgdGhhdCAKY2x1c3Rlci4gVGhpcyBhcHByb2FjaCBpcyBpbXBsZW1lbnRlZCBpbiB0aGUgYHNjb3JlTWFya2Vyc2AgZnVuY3Rpb24gb2YgdGhlCmBzY3JhbmAgcGFja2FnZS4KCmBgYHtyLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjcmFuKQptYXJrZXIuaW5mbyA8LSBzY29yZU1hcmtlcnMoc2NlXzkwMCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2VfOTAwJGNsdXN0X2hjbF9rMzkpCm1hcmtlci5pbmZvICMgb25lIGRhdGFmcmFtZSBmb3IgZWFjaCBvZiB0aGUgMzkgY2x1c3RlcnMKYGBgCgpgYGB7cn0KY29sbmFtZXMobWFya2VyLmluZm9bWyIxIl1dKSAjIHN0YXRpc3RpY3MgZm9yIGNsdXN0ZXIgMS4KYGBgCgpgYGB7cn0KaGVhZChtYXJrZXIuaW5mb1tbIjEiXV0pCmBgYAoKV2Ugb2JzZXJ2ZSBzZXZlcmFsIHN1bW1hcnkgc3RhdGlzdGljcyBmb3IgZWFjaCBnZW5lIGluIHRoZSBkYXRhZnJhbWUgZm9yCmNsdXN0ZXIgMS4gV2UgaGlnaGxpZ2h0IGEgZmV3OgoKLSBgc2VsZi5hdmVyYWdlYDogdGhlIGF2ZXJhZ2UgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiBvZiB0aGUgZ2VuZSBpbiB0aGUKdGFyZ2V0IGNsdXN0ZXIgKGNsdXN0ZXIgMSkKCi0gYG90aGVyLmF2ZXJhZ2VgOiB0aGUgYXZlcmFnZSBsb2ctbm9ybWFsaXplZCBleHByZXNzaW9uIG9mIHRoZSBnZW5lIGluIGFsbCB0aGUKb3RoZXIgY2x1c3RlcnMgKGNsdXN0ZXJzIDItMzkpCgotIGBzZWxmLmRldGVjdGVkYDogdGhlIGZyYWN0aW9uIG9mIGNlbGxzIGluIHdoaWNoIHRoZSBnZW5lIHdhcyBleHByZXNzZWQgaW4gdGhlCnRhcmdldCBjbHVzdGVyIChjbHVzdGVyIDEpCgotIGBvdGhlci5kZXRlY3RlZGA6IHRoZSBmcmFjdGlvbiBvZiBjZWxscyBpbiB3aGljaCB0aGUgZ2VuZSB3YXMgZXhwcmVzc2VkIGluIGFsbAp0aGUgb3RoZXIgY2x1c3RlcnMgKGNsdXN0ZXIgMi0zOSkKCi0gYG1lYW4uQVVDYDogRnJvbSB0aGUgCltPU0NBIGJvb2sgY2hhcHRlciA2LjNdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTQvT1NDQS5iYXNpYy9tYXJrZXItZGV0ZWN0aW9uLmh0bWwjZWZmZWN0LXNpemVzLWZvci1wYWlyd2lzZS1jb21wYXJpc29ucyk6IAoiSW4gdGhlIGNvbnRleHQgb2YgbWFya2VyIGRldGVjdGlvbiwgdGhlIGFyZWEgdW5kZXIgdGhlIGN1cnZlIChBVUMpIHF1YW50aWZpZXMgCm91ciBhYmlsaXR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdHdvIGRpc3RyaWJ1dGlvbnMgaW4gYSBwYWlyd2lzZSBjb21wYXJpc29uLiAKVGhlIEFVQyByZXByZXNlbnRzIHRoZSBwcm9iYWJpbGl0eSB0aGF0IGEgcmFuZG9tbHkgY2hvc2VuIG9ic2VydmF0aW9uIGZyb20gb3VyIApjbHVzdGVyIG9mIGludGVyZXN0IGlzIGdyZWF0ZXIgdGhhbiBhIHJhbmRvbWx5IGNob3NlbiBvYnNlcnZhdGlvbiBmcm9tIHRoZSBvdGhlcgpjbHVzdGVyLiBBIHZhbHVlIG9mIDEgY29ycmVzcG9uZHMgdG8gdXByZWd1bGF0aW9uLCB3aGVyZSBhbGwgdmFsdWVzIG9mIG91ciAKY2x1c3RlciBvZiBpbnRlcmVzdCBhcmUgZ3JlYXRlciB0aGFuIGFueSB2YWx1ZSBmcm9tIHRoZSBvdGhlciBjbHVzdGVyOyBhIAp2YWx1ZSBvZiAwLjUgbWVhbnMgdGhhdCB0aGVyZSBpcyBubyBuZXQgZGlmZmVyZW5jZSBpbiB0aGUgbG9jYXRpb24gb2YgdGhlIApkaXN0cmlidXRpb25zOyBhbmQgYSB2YWx1ZSBvZiAwIGNvcnJlc3BvbmRzIHRvIGRvd25yZWd1bGF0aW9uLiBUaGUgQVVDIGlzIApjbG9zZWx5IHJlbGF0ZWQgdG8gdGhlIFUgc3RhdGlzdGljIGluIHRoZSBXaWxjb3hvbiByYW5rZWQgc3VtIHRlc3QgKGEuay5hLiwgCk1hbm4tV2hpdG5leSBVLXRlc3QpLiIgQXMgc3VjaCwgdGhpcyBhIHZlcnkgaW50ZXJlc3RpbmcgY29sdW1uIHRvIHVzZSBmb3IKc2VsZWN0aW5nIG1hcmtlciBnZW5lcy4KCkJhc2VkIG9uIHRoZSBgbWVhbi5BVUNgIHN0YXRpc3RpYywgd2UgbWF5IG5vdyBpbnNwZWN0IHRoZSB0b3AxMCBtYXJrZXJzIHRvCmRpc3Rpbmd1aXNoIGJldHdlZW4gY2VsbHMgb2YgY2x1c3RlciAxIGFuZCBjZWxscyBvZiB0aGUgb3RoZXIgY2x1c3RlcnM6CgpgYGB7cn0KY2hvc2VuIDwtIG1hcmtlci5pbmZvW1siMSJdXQpvcmRlcmVkIDwtIGNob3NlbltvcmRlcihjaG9zZW4kbWVhbi5BVUMsIGRlY3JlYXNpbmc9VFJVRSksXQpoZWFkKG9yZGVyZWRbLGMoMTo0LDEwKV0sbj0xMCkgIyBzaG93aW5nIGJhc2ljIHN0YXRzIG9ubHksIGZvciBicmV2aXR5LgpgYGAKCldlIGNhbiBhbHNvIHZpc3VhbGl6ZSB0aGUgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiBvZiB0aGUgdG9wMTAgbWFya2VycyBpbiAKZWFjaCBjZWxsLCBzdHJhdGlmaWVkIG9uIGNsdXN0ZXIgbGFiZWwsIHVzaW5nIHRoZSBgcGxvdEV4cHJlc3Npb25gIGZ1bmN0aW9uCm9mIHRoZSBgc2NhdGVyYCBwYWNrYWdlOgoKYGBge3IsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoc2NhdGVyKQpwbG90RXhwcmVzc2lvbihzY2VfOTAwLCAKICAgICAgICAgICAgICAgZmVhdHVyZXM9aGVhZChyb3duYW1lcyhvcmRlcmVkKSxuPTEwKSwgCiAgICAgICAgICAgICAgIHg9ImNsdXN0X2hjbF9rMzkiLCAKICAgICAgICAgICAgICAgY29sb3VyX2J5PSJjbHVzdF9oY2xfazM5IikKYGBgCgpUd28gZ2VuZXMgcG9wIHVwIGFzIGV4dHJlbWVseSBpbnRlcmVzdGluZyBmb3IgdXNpbmcgYXMgbWFya2VycwpzcGVjaWZpYyBmb3IgY2x1c3RlciAxOiAqTlJOMSogYW5kICpTTEMxN0E2Ki4gVGhlc2UgbWFya2VycyBhcmUgaGlnaGx5IGV4cHJlc3NlZAppbiBjbHVzdGVyIDEsIGJ1dCBoYXZlIGFsbW9zdCBubyBleHByZXNzaW9uIGluIGFueSBvZiB0aGUgb3RoZXIgY2x1c3RlcnMuCgpJbnRlcmVzdGluZ2x5LCAqU0xDMTdBNiogaXMgZXhhY3RseSB0aGUgbWFya2VyIHRoZSBvcmlnaW5hbCBhdXRob3JzIGhhdmUgdXNlZAphcyBhIHNwZWNpZmljIG1hcmtlciBmb3IgZ2FuZ2xpb24gY2VsbHMhIE5vdGUgdGhhdCBpZiB3ZSB3b3VsZCBub3Qga25vdyB0aGUKc3lzdGVtIHVuZGVyIHN0dWR5LCBpLmUuIHdlIHdlcmUgdW5hYmxlIHRvIHNlbGVjdCB0aGUgKlNMQzE3QTYqIG1hcmtlciBiYXNlZApvbiBvdXIgcHJpb3IgYmlvbG9naWNhbCBrbm93bGVkZ2UsIHdlIHdvdWxkIGhhdmUgc3VjY2Vzc2Z1bGx5IGlkZW50aWZpZWQgdGhlCm1hcmtlciB1c2luZyB0aGlzIHN0cmF0ZWd5LiBJbiBhIG5leHQgc3RlcCwgd2UgY291bGQgcGVyZm9ybSBhbiBpbnRlcm5ldCBzZWFyY2gKdG8gc2VlIGlmIHRoaXMgbWFya2VyIGlzIGtub3duIG9yIG5vdC4KCkZvciB0aGUgcmVjb3JkLCAqTlJOMSogYWxzbyBpcyBhIGtub3duIG1hcmtlciBmb3IgaWRlbnRpZnlpbmcgZ2FuZ2xpb24gY2VsbHMuCgojIyBTZW1pLXN1cGVydmlzZWQgdXNpbmcgU2luZ2xlUgoKQSBjb25jZXB0dWFsbHkgc3RyYWlnaHRmb3J3YXJkIGFubm90YXRpb24gYXBwcm9hY2ggaXMgdG8gY29tcGFyZSBvdXIgY3VycmVudApzY1JOQS1zZXEgZGF0YXNldCB3aXRoIGEgcHJldmlvdXNseSBhbm5vdGF0ZWQgcmVmZXJlbmNlIGRhdGFzZXQuIExhYmVscyBjYW4gCnRoZW4gYmUgYXNzaWduZWQgdG8gZWFjaCBjZWxsIGluIHRoZSBNYWNvc2tvIGRhdGFzZXQgYmFzZWQgb24gdGhlIAptb3N0IHNpbWlsYXIgcmVmZXJlbmNlIGNlbGxzLCBmb3Igc29tZSBkZWZpbml0aW9uIG9mICJzaW1pbGFyIi4gVGhpcyBpcyBhIApzdGFuZGFyZCBjbGFzc2lmaWNhdGlvbiBjaGFsbGVuZ2UgdGhhdCBjYW4gYmUgdGFja2xlZCBieSBzdGFuZGFyZCBtYWNoaW5lIApsZWFybmluZyB0ZWNobmlxdWVzIHN1Y2ggYXMgcmFuZG9tIGZvcmVzdHMgYW5kIHN1cHBvcnQgdmVjdG9yIG1hY2hpbmVzLiBBbnkgCnB1Ymxpc2hlZCBhbmQgbGFiZWxlZCBSTkEtc2VxIGRhdGFzZXQgKGJ1bGsgb3Igc2luZ2xlLWNlbGwpIGNhbiBiZSB1c2VkIGFzIGEgCnJlZmVyZW5jZSwgdGhvdWdoIGl0cyByZWxpYWJpbGl0eSBkZXBlbmRzIGdyZWF0bHkgb24gdGhlIGV4cGVydGlzZSBvZiB0aGUgCm9yaWdpbmFsIGF1dGhvcnMgd2hvIGFzc2lnbmVkIHRoZSBsYWJlbHMgaW4gdGhlIGZpcnN0IHBsYWNlIGFuZCB0aGUgY2xvc2VyCnRoZSByZWZlcmVuY2UgZGF0YXNldCBpcyB0byB0aGUgZGF0YXNldCB3ZSB3b3VsZCBsaWtlIHRvIGFubm90YXRlIChlLmcuLCAKZnVsbC1sZW5ndGggdnMgVU1JLWJhc2VkIHByb3RvY29sKSwgdGhlIG1vcmUgYWNjdXJhdGUgdGhlIGFubm90YXRpb24gd2lsbCB0eXBpY2FsbHkgYmUuCgpJbiB0aGlzIHNlY3Rpb24sIHdlIHdpbGwgcGVyZm9ybSBzdWNoIGxhYmVsIHRyYW5zZmVyIGJldHdlZW4gdGhlIGFubm90YXRlZApyZWZlcmVuY2UgZGF0YXNldCBmcm9tIApbU2hla2hhciBldCBhbC5dKGh0dHBzOi8vZG9pLm9yZy8xMC4xMDE2L2ouY2VsbC4yMDE2LjA3LjA1NCksIHdoaWNoIGFsc28gaXMgCmEgc2NSTkEtc2VxIGRhdGFzZXQgdGhhdCBzdHVkaWVkIHRoZSBtb3VzZSByZXRpbmEsIGFuZCB0aGUgTWFjb3NrbyBkYXRhc2V0LiAKClRvIHBlcmZvcm0gdGhlIGFjdHVhbCBsYWJlbCB0cmFuc2Zlciwgd2lsbCB1c2UgdGhlIGBTaW5nbGVSYCBCaW9jb25kdWN0b3IgCnBhY2thZ2UuIEZvciBlYWNoICJ0ZXN0IiBjZWxsIGluIHRoZSBNYWNvc2tvIGRhdGFzZXQsIGBTaW5nbGVSYCB3aWxsOgoKMS4gQ29tcHV0ZSBTcGVhcm1hbiBjb3JyZWxhdGlvbiBiZXR3ZWVuIHRoZSB0ZXN0IGNlbGwgYW5kIGVhY2ggcmVmZXJlbmNlIGNlbGwuIApUbyBpbXByb3ZlIHNpZ25hbC9ub2lzZSwgb25seSBtYXJrZXIgZ2VuZXMgaWRlbnRpZmllZCB1c2luZyB0aGUgcmVmZXJlbmNlIApkYXRhc2V0IGFyZSB1c2VkIGZvciB0aGlzLgoKMi4gRm9yIGVhY2ggbGFiZWwgKGNlbGwgdHlwZSksIHNldCB0aGUgc2NvcmUgYXMgdGhlIChkZWZhdWx0IG9mKSA4MCUgcXVhbnRpbGUgb2YKU3BlYXJtYW4gY29ycmVsYXRpb25zLgoKMy4gVGhlIHByZWRpY3Rpb24gaXMgdGhlbiB0aGUgbGFiZWwgd2l0aCB0aGUgaGlnaGVzdCBzY29yZS4KCkJlZm9yZSB3ZSBjYW4gdXNlIGBzaW5nbGVSYCB0byBwZXJmb3JtIGxhYmVsIHRyYW5zZmVyLCB3ZSB3aWxsIG5lZWQgdG8gaW1wb3J0LApleHBsb3JlIChicmllZikgYW5kIHdyYW5nbGUgdGhlIHJlZmVyZW5jZSBkYXRhc2V0IGJ5IFNoZWtoYXIgKmV0IGFsLiouCgojIyMgSW1wb3J0IHJlZmVyZW5jZSBkYXRhCgpUaGUgZGF0YXNldCBieSBTaGVraGFyICpldCBhbC4qIGNhbiBiZSBjb252ZW5pZW50bHkgaW1wb3J0ZWQgdXNpbmcgdGhlIApgc2NSTkFzZXFgIHBhY2thZ2UuCgpgYGB7ciwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeShzY1JOQXNlcSkKKHJlZi5kYXRhIDwtIHNjUk5Bc2VxOjpTaGVraGFyUmV0aW5hRGF0YShlbnNlbWJsID0gVFJVRSkpCmBgYAoKIyMjIEV4cGxvcmUgbWV0YWRhdGEgb2YgcmVmZXJlbmNlIGRhdGEKCmBgYHtyfQpoZWFkKGNvbERhdGEocmVmLmRhdGEpKQpsZXZlbHMoYXMuZmFjdG9yKHJlZi5kYXRhJENMVVNURVIpKQpgYGAKCmBgYHtyfQpsZXZlbHMoYXMuZmFjdG9yKHJlZi5kYXRhJGBTVUItQ0xVU1RFUmApKQpgYGAKCmBgYHtyfQojIGJvdGggaGF2ZSBleGFjdGx5IHRoZSBzYW1lIGluZm8uLi4KYWxsKHJlZi5kYXRhJGBTVUItQ0xVU1RFUmAgPT0gcmVmLmRhdGEkQ0xVU1RFUiwgbmEucm0gPSBUUlVFKQpgYGAKCiMjIyBQcm9jZXNzIHJlZmVyZW5jZSBkYXRhCgoxLiBSZW1vdmUgdW5sYWJlbGVkIGNlbGxzCgpgYGB7cn0Kc3VtKGlzLm5hKHJlZi5kYXRhJENMVVNURVIpKQpyZWYuZGF0YSA8LSByZWYuZGF0YVssLXdoaWNoKGlzLm5hKHJlZi5kYXRhJENMVVNURVIpKV0KYGBgCgoyLiBSZW1vdmUgZG91YmxldHMvY29udGFtaW5hbnQgY2VsbHMKClRoZSBvcmlnaW5hbCBhdXRob3JzIGFscmVhZHkgcGVyZm9ybWVkIHF1YWxpdHkgY29udHJvbDsgd2UgaGF2ZSBjZWxscyB3aXRoIApjbHVzdGVyIGxhYmVsICJEb3VibGV0cy9Db250YW1pbmFudHMiLiBMZXTigJlzIHJlbW92ZSB0aG9zZToKCmBgYHtyfQpzdW0ocmVmLmRhdGEkQ0xVU1RFUiA9PSAiRG91YmxldHMvQ29udGFtaW5hbnRzIikKcmVmLmRhdGEgPC0gcmVmLmRhdGFbLC13aGljaChyZWYuZGF0YSRDTFVTVEVSID09ICJEb3VibGV0cy9Db250YW1pbmFudHMiKV0KYGBgCgozLiBNYWtlIGxvd2VyIHJlc29sdXRpb24gY2VsbCB0eXBlIGxldmVscyAoZm9yIGVhc2llciBpbnRlcnByZXRhdGlvbikKCmBgYHtyfQpyZWYuZGF0YSRDTFVTVEVSX2xvd1JlcyA8LSBmY3RfcmVjb2RlKHJlZi5kYXRhJENMVVNURVIsIAogICAgICAgICAgICJBbWFjcmluZV9jZWxscyIgPSAiQUMgKEFtYWNyaW5lIGNlbGwpIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkMxQSIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDMUIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzNBIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkMzQiIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNCIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNUEgKENvbmUgQmlwb2xhciBjZWxsIDVBKSIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNUIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzVDIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkM1RCIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNiIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNyAoQ29uZSBCaXBvbGFyIGNlbGwgNykiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzgvOSAobWl4dHVyZSBvZiBCQzggYW5kIEJDOSkiLAogICAgICAgICAgICJDb25lcyIgPSAiQ29uZSBQaG90b3JlY2VwdG9ycyIsCiAgICAgICAgICAgIk11bGxlcl9nbGlhIiA9ICJNRyAoTXVlbGxlciBHbGlhKSIsCiAgICAgICAgICAgIlJvZF9CaXBvbGFyX2NlbGwiID0gIlJCQyAoUm9kIEJpcG9sYXIgY2VsbCkiLAogICAgICAgICAgICJSb2QgUGhvdG9yZWNlcHRvcnMiID0gIlJvZCBQaG90b3JlY2VwdG9ycyIpCmBgYAoKNC4gUmVtb3ZlIGxvd2x5IGV4cHJlc3NlZCBnZW5lcwoKYGBge3J9CmtlZXAgPC0gcm93U3Vtcyhhc3NheXMocmVmLmRhdGEpJGNvdW50cyA+IDApID4gMTAKdGFibGUoa2VlcCkKcmVmLmRhdGEgPC0gcmVmLmRhdGFba2VlcCxdCmBgYAoKNS4gT2J0YWluIHNhbWUgZ2VuZSBJRCBmb3JtYXQgYXMgaW4gdGFyZ2V0IGRhdGEKClRvIGF2b2lkIHByb2JsZW1zIHdpdGggZGlmZmVyZW50IHZlcnNpb24gb2YgZ2VuZSBzeW1ib2xzLCBpdCBpcyBnb29kIHByYWN0aWNlCmRvIHdvcmsgd2l0aCB1bmFtYmlndW91cyBnZW5lIGlkZW50aWZpZXJzIGxpa2UgdGhvc2Ugb2YgRU5TRU1CTCBpbnN0ZWFkLgoKYGBge3J9CnJvd25hbWVzKHNjZV85MDApIDwtIHJvd0RhdGEoc2NlXzkwMCkkZW5zZW1ibF9nZW5lX2lkICMgdXNlIEVOU0VNQkwgaWRlbnRpZmllcnMgaW5zdGVhZApzdW0ocm93bmFtZXMoc2NlXzkwMCkgJWluJSByb3duYW1lcyhyZWYuZGF0YSkpCmBgYAoKNi4gQ29tcHV0ZSBgbG9nTm9ybUNvdW50c2AKCmBgYHtyLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjdXR0bGUpCnJlZi5kYXRhIDwtIGxvZ05vcm1Db3VudHMocmVmLmRhdGEpCmBgYAoKIyMjIGBTaW5nbGVSYCBhdCBsb3cgcmVmZXJlbmNlIHJlc29sdXRpb24KCmBgYHtyfQojQmlvY01hbmFnZXI6Omluc3RhbGwoIlNpbmdsZVIiKQpsaWJyYXJ5KFNpbmdsZVIpCgojIHJ1bnMgMm1pbiAzMHNlYyBmb3IgbWUKcHJlZC5sb3dSZXMgPC0gU2luZ2xlUih0ZXN0ID0gc2NlXzkwMCwgCiAgICAgICAgICAgICAgICAgICAgIHJlZiA9IHJlZi5kYXRhLCAKICAgICAgICAgICAgICAgICAgICAgbGFiZWxzID0gcmVmLmRhdGEkQ0xVU1RFUl9sb3dSZXMsIAogICAgICAgICAgICAgICAgICAgICBkZS5tZXRob2QgPSAid2lsY294IikKdGFibGUocHJlZC5sb3dSZXMkbGFiZWxzKQpgYGAKClVzaW5nIHRoZSBgU2luZ2xlUmAgY2xhc3NpZmllciB0aGF0IHdhcyB0cmFpbmVkIG9uIHRoZSByZWZlcmVuY2UgZGF0YXNldCBieQpTaGVraGFyICpldCBhbC4qLCB3ZSBoYXZlIGxhYmVsZWQgMjczMSBjZWxscyBmcm9tIHRoZSBNYWNvc2tvIGRhdGFzZXQgYXMKYW1hY3JpbmUgY2VsbHMsIDE1MjggY2VsbHMgYXMgYmlwb2xhciBjZWxscywgYW5kIHNvIG9uLiBBZ2FpbiBub3RlIHRoYXQgd2UKcHJlZGljdGVkIGEgbGFiZWwgZm9yIGVhY2ggY2VsbCBpbiB0aGUgTWFjb3NrbyBkYXRhc2V0IGJhc2VkIGl0cyBzaW1pbGFyaXR5CihpbiBnZW5lIGV4cHJlc3Npb24pIHdpdGggbGFiZWxlZCBjZWxscyBmcm9tIHRoZSBTaGVraGFyIGRhdGFzZXQuCgoqKk1vc3QgaW1wb3J0YW50bHksKiogd2Ugd2FudCB0byBjb21wYXJlIG91ciBwcmVkaWN0ZWQgY2VsbCBsYWJlbHMgd2l0aCB0aGUKbGFiZWxzIHRoYXQgd2VyZSBvYnRhaW5lZCBieSBNYWNva3NvICpldCBhbC4qLCB3aGljaCB3ZSAqY291bGQqIGNvbnNpZGVyIHRvIGJlCmdyb3VuZCB0cnV0aCBsYWJlbHMgaWYgd2UgYXNzdW1lIHRoYXQgdGhlIGF1dGhvcnMgc3VjY2VlZGVkIGluIHRoZWlyIGxhcmdlIAplZmZvcnQgb2YgYW5ub3RhdGluZyB0aGVpciBjZWxsIGNsdXN0ZXJzIGZvciB0aGVpciBwdWJsaWNhdGlvbi4KCmBgYHtyfQp0YWIgPC0gdGFibGUoc2NlXzkwMCRjbHVzdGVyX2xvd1JlcywgcHJlZC5sb3dSZXMkbGFiZWxzKQp0YWIKYGBgCgpCeSB0aGUgbmFrZWQgZXllLCB3ZSBpbW1lZGlhdGVseSBvYnNlcnZlIGEgc3Ryb25nIGNvcnJlc3BvbmRlbmNlIGJldHdlZW4gb3VyCnByZWRpY3RlZCBsYWJlbHMgYW5kIHRoZSBsYWJlbHMgZnJvbSB0aGUgb3JpZ2luYWwgcHVibGljYXRpb24gKGkuZS4sIG1vc3QKYW1hY3JpbmUgY2VsbHMgYmVpbmcgcHJlZGljdGVkIGFzIGFtYWNyaW5lIGNlbGxzLCBtb3N0IGJpcG9sYXIgY2VsbHMgYmVpbmcKcHJlZGljdGVkIGFzIGJpcG9sYXIgY2VsbHMsIGFuZCBzbyBvbikuIEJlZm9yZSB3ZSBkaXZlIGRlZXBlciBpbnRvIHRoaXMsIHdlCm1heSB2aXN1YWxpemUgb3VyIHJlc3VsdCB1c2luZyBhIGhlYXRtYXA6CgpgYGB7cn0KcGhlYXRtYXA6OnBoZWF0bWFwKHRhYiAvIHJvd1N1bXModGFiKSkKYGBgCgp3aGVyZSB3ZSBhbHNvIGNhbiBvYnNlcnZlIHRoZSBjb3JyZXNwb25kZW5jZSBiZXR3ZWVuIHRoZSBwcmVkaWN0ZWQgKHgtYXhpcykgYW5kCnRoZSBvcmlnaW5hbCAoeS1heGlzKSBsYWJlbHMuIE5vdGUgdGhhdCB3ZSBoYXZlIG5vcm1hbGl6ZWQgdGhlIHZhbHVlcyBpbiB0aGUKaGVhdG1hcCBmb3IgZWFjaCByb3csIHNvIHRoYXQgdGhlIGNvbG9yaW5nIG9mIHRoZSBjZWxscyBpbiB0aGUgbWF0cml4IGNhbiBiZQppbnRlcnByZXRlZCBhcyB0aGUgZnJhY3Rpb24gb2YgdGhlIG9yaWdpbmFsIGNlbGwgdHlwZXMgdGhhdCBnb3QgYXNzaWduZWQgdG8gCmVhY2ggb2YgdGhlIHJlZmVyZW5jZSBjYXRlZ29yaWVzIChlLmcuIGZvciByb3cgMSwgODAtOTAlIG9mIHRoZSBjZWxscyBnb3QKcHJlZGljdGVkIGFzIGFtYWNyaW5lIGNlbGxzIGFuZCB0aGUgcmVtYWluaW5nIDEwJSBnb3QgcHJlZGljdGVkIGFzIHJvZApwaG90b3JlY2VwdG9ycykuCgpPbmUgb3RoZXIgdmlzdWFsaXphdGlvbiBzdHJhdGVneSBpcyBpbXBsZW1lbnRlZCBpbiB0aGUgYHBsb3RTY29yZUhlYXRtYXBgIG9mIHRoZQpgU2luZ2xlUmAgcGFja2FnZS4gUmVtZW1iZXIsIHRoZSBgU2luZ2xlUmAgY2xhc3NpZmllciBhc3NpZ25zIGVhY2ggdGFyZ2V0IGNlbGwKdG8gYSBjZWxsIHR5cGUgbGFiZWwgKip3aXRoIGEgY2VydGFpbiBwcm9iYWJpbGl0eSoqLiBUaGUgYHBsb3RTY29yZUhlYXRtYXBgCmZ1bmN0aW9uIHRoZW4gYWxsb3dzIHlvdSB0byBwbG90LCBmb3IgZWFjaCBjZWxsIChjb2x1bW5zKSB0aGUgYXNzaWdubWVudCBzY29yZSAKKHdoaWNoIGNhbiBiZSB0aG91Z2h0IG9mIGFzIGEgcHJvYmFiaWxpdHkpIG9mIHRoYXQgY2VsbCBiZWxvbmdpbmcgdG8gZWFjaCBvZiAKdGhlIHJlZmVyZW5jZSBsYWJlbCBjYXRlZ29yaWVzIChyb3dzKS4KCmBgYHtyfQpnZyA8LSBwbG90U2NvcmVIZWF0bWFwKHByZWQubG93UmVzWzE6MjAsXSkKZ2cKYGBgCgpGb3IgaW5zdGFuY2UsIHdoZW4gd2UgbG9vayBhdCB0aGUgMjB0aCBjZWxsIChyaWdodG1vc3QgY29sdW1uKSwgd2Ugc2VlIHRoYXQgCnRoaXMgY2VsbCB3YXMgbGFiZWxlZCBhcyBhIHJvZCBwaG90b3JlY2VwdG9yLiBUaGlzIGlzIGJlY2F1c2UgdGhpcwp3YXMgdGhlIGxhYmVsIHRoYXQgd2FzIGFzc2lnbmVkIHRvIHRoZSBjZWxsIHdpdGggaGlnaGVzdCBhc3NpZ25tZW50IHNjb3JlLiBXZSBhbHNvIHNlZSB0aGF0IHRoZSBzZWNvbmQgbW9zdCBsaWtlbHkgbGFiZWwgZm9yIHRoaXMgY2VsbCBpcwpjb25lcy4KCkZpbmFsbHksIHdlIGNhbiB1c2UgdGhlc2UgYXNzaWdubWVudCBzY29yZSB0byBmaWx0ZXIgb3V0IGNlbGxzIHRoYXQgY291bGQgbm90IGJlCnVuYW1iaWd1b3VzbHkgYXNzaWduZWQgdG8gb25lIGNlbGwgdHlwZSwgaS5lLiwgb25seSByZXBvcnQgdGhvc2UgY2VsbHMgdGhhdCB3ZQp3ZXJlIGFibGUgdG8gcmVsaWFibHkgYXNzaWduOgoKYGBge3J9CnN1bW1hcnkoaXMubmEocHJlZC5sb3dSZXMkcHJ1bmVkLmxhYmVscykpCgpyYW5nZShyb3dNYXhzKHByZWQubG93UmVzJHNjb3JlcykpICMgYWxsIGFzc2lnbm1lbnRzCnJhbmdlKHJvd01heHMocHJlZC5sb3dSZXMkc2NvcmVzWyFpcy5uYShwcmVkLmxvd1JlcyRwcnVuZWQubGFiZWxzKSxdKSkgIyByZWxpYWJsZSBhc3NpZ25tZW50cwoKdGFibGUoc2NlXzkwMCRjbHVzdGVyX2xvd1Jlc1shaXMubmEocHJlZC5sb3dSZXMkcHJ1bmVkLmxhYmVscyldLCAKICAgICAgcHJlZC5sb3dSZXMkbGFiZWxzWyFpcy5uYShwcmVkLmxvd1JlcyRwcnVuZWQubGFiZWxzKV0pCmBgYAoKV2Ugd2lsbCBpbnRlcnByZXQgdGhlIGNvbmNvcmRhbmNlIGJldHdlZW4gdGhlIHByZWRpY3RlZCBhbmQgdGhlCm9yaWdpbmFsIGxhYmVscyBvbiB0aGlzIHN1YnNldC4gV2Ugb2JzZXJ2ZSBhIHN0cm9uZyBjb3JyZXNwb25kZW5jZSBiZXR3ZWVuIHRoZSAKcHJlZGljdGVkIGxhYmVscyBhbmQgdGhlIGxhYmVscyBmcm9tIE1hY29rc28gKmV0IGFsLiogV2UgY2FuIHJlYWQgdGhpcyB0YWJsZSAKYXMgZm9sbG93czoKCi0gQWxtb3N0IGFsbCBhbWFjcmluZSBjZWxscyBvZiB0aGUgTWFjb3NrbyBkYXRhc2V0IGFyZSBjb3JyZWN0bHkgcHJlZGljdGVkIGFzCmFtYWNyaW5lIGNlbGxzICgyMDM2LygyMDM2KzcrMSs0MSsxKSDCsT0gOTglIGNvcnJlY3RseSBhc3NpZ25lZCkuCgotIEFsbCBob3Jpem9udGFsIGNlbGxzIGFuZCBhbGwgZ2FuZ2xpb24gY2VsbHMgb2YgdGhlIE1hY29za28gZGF0YXNldCBhcmUgCnByZWRpY3RlZCBhcyBhbWFjcmluZSBjZWxscy4gVGhpcyBtYWtlcyBwZXJmZWN0IHNlbnNlLiBTaW5jZSB0aGUKcmVmZXJlbmNlIGRhdGFzZXQgZGlkIG5vdCBjb250YWluIGhvcml6b250YWwvZ2FuZ2xpb24gY2VsbCBsYWJlbHMsIGl0IGlzIAppbXBvc3NpYmxlIHRvIGxhYmVsIHRoZSB0YXJnZXQgY2VsbHMgd2l0aCB0aGVzZSBsYWJlbHMuIEluIHN0ZWFkLCB0aGUgY2VsbHMKd2VyZSBsYWJlbGVkIGFzIHRoZSBjZWxsIHR5cGUgdGhhdCBpcyBtb3N0IGNsb3NlbHkgcmVsYXRlZCB0byBob3Jpem9udGFsLwpnYW5nbGlvbiBjZWxsczsgdGhlIGFtYWNyaW5lIGNlbGwgdHlwZSAoc2VlIGZpZ3VyZSA1RCkuCgotIE1vc3Qgb2YgdGhlIGJpcG9sYXIgY2VsbHMgb2YgdGhlIE1hY29za28gZGF0YXNldCB3ZXJlIGVpdGhlciBwcmVkaWN0ZWQgYXMKYmlwb2xhciBjZWxscyBvciBhcyByb2QgYmlwb2xhciBjZWxscy4gVGhlIGF1dGhvcnMgb2YgdGhlIE1hY29za28gcGFwZXIgd2VyZSBub3QKYWJsZSAoaW4gdGhlaXIgbG93LXJlc29sdXRpb24gbGFiZWxpbmcpIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdGhlc2UgdHdvIApzdWJ0eXBlcyBvZiBiaXBvbGFyIGNlbGxzLCBidXQgd2Ugc3VjY2VlZGVkIGluIGRvaW5nIHRoaXMgKGFsdGhvdWdoIHdlIHNob3VsZAppbiBwcmluY2lwbGUgbmVlZCB0byBkb3VibGUtY2hlY2sgd2l0aCBtYXJrZXJzIHdoZXRoZXIgdGhpcyBpcyBhIHRydWUgYmlvbG9naWNhbCAKc2lnbmFsIGFuZCBub3Qgc29tZSBzcHVyaW91cyBlZmZlY3QpLiAKCi0gNDQlICgyNzkvKDI3OSszNTQpKSBvZiB0aGUgY29uZXMgaW4gdGhlIE1hY29za28gZGF0YXNldCBhcmUgY29ycmVjdGx5IGxhYmVsZWQgCmFzIGNvbmVzLiBUaGUgcmVtYWluaW5nIDU2JSBvZiB0aGUgY2VsbHMgd2VyZSBsYWJlbGVkIGFzIHJvZHMuIFRoaXMgbWVhbnMgdGhhdAplaXRoZXIgdGhlIGBTaW5nbGVSYCBjbGFzc2lmaWVyIHdyb25nZnVsbHkgbGFiZWxlZCB0aGVzZSBjb25lcyBhcyByb2RzLCBvciB0aGUgCm9yaWdpbmFsIGF1dGhvcnMgbWlzbGFiZWxlZCB0aGVzZSByb2RzIGFzIGNvbmVzLiBTaW5jZSB3ZSBkbyBub3QgcmVhbGx5IGhhdmUgCmEgZ3JvdW5kIHRydXRoIGhlcmUsIHRoZSBiZXN0IGlkZWEgaXMgdG8gY2hlY2sgdGhpcyB1c2luZyBrbm93biBtYXJrZXJzIHRvIApkaXN0aW5ndWlzaCBiZXR3ZWVuIHJvZHMgYW5kIGNvbmVzLiAKCi0gQWxtb3N0IGFsbCBNdWxsZXIgZ2xpYSBjZWxscyBvZiB0aGUgTWFjb3NrbyBkYXRhc2V0IGFyZSBjb3JyZWN0bHkgcHJlZGljdGVkIGFzCk11bGxlciBnbGlhIGNlbGxzICg1NjkvKDU2OSsyKSDCsT0gMTAwJSBjb3JyZWN0bHkgYXNzaWduZWQpLiBJbiBhZGRpdGlvbiwgbW9zdCBvZgp0aGUgYXN0cm9jeXRlcywgZmlicm9ibGFzdCwgdmFzY3VsYXIgZW5kb3RoZWxpdW0sIHBlcmljeXRlcyBhbmQgbWljcm9nbGlhIGNlbGxzCmFsc28gZ290IGxhYmVsZWQgYXMgTXVsbGVyIGdsaWEgY2VsbHMuIFRoaXMgbWFrZXMgcGVyZmVjdCBzZW5zZS4gU2luY2UgdGhlCnJlZmVyZW5jZSBkYXRhc2V0IGRpZCBub3QgY29udGFpbiB0aGVzZSBjZWxsIGxhYmVscywgaXQgd2FzIGltcG9zc2libGUgdG8gbGFiZWwgCnRoZSB0YXJnZXQgY2VsbHMgd2l0aCB0aGVzZSBsYWJlbHMuIEluIHN0ZWFkLCB0aGUgY2VsbHMgd2VyZSBsYWJlbGVkIGFzIHRoZSBjZWxsIAp0eXBlIHRoYXQgaXMgbW9zdCBjbG9zZWx5IHJlbGF0ZWQ7IHRoZSBNdWxsZXIgZ2xpYSBjZWxsIHR5cGUgKHNlZSBmaWd1cmUgNUQpLgoKLSBBbG1vc3QgYWxsIHJvZCBjZWxscyBvZiB0aGUgTWFjb3NrbyBkYXRhc2V0IGFyZSBjb3JyZWN0bHkgcHJlZGljdGVkIGFzCnJvZCBjZWxscyAoMTgzNC8oMTgzNCs2KzQrMSkgwrE9IDk5JSBjb3JyZWN0bHkgYXNzaWduZWQpLgoKV2UgY2FuIG5vdyBhbHNvIHZpc3VhbGl6ZSB0aGUgcHJlZGljdGVkIGxhYmVscyBhbmQgdGhlIG9yaWdpbmFsIGxhYmVscyBvbiBvdXIKdC1TTkUuCgpgYGB7cn0Kc2NlXzkwMCRTaW5nbGVSX2xvd1JlcyA8LSBwcmVkLmxvd1JlcyRsYWJlbHMKCiMgb3VyIGxvdyByZXNvbHV0aW9uIGxhYmVscyBiYXNlZCBvbiByZWZlcmVuY2UKcGxvdFRTTkUoc2NlXzkwMCwKICAgICAgICAgY29sb3VyX2J5ID0gIlNpbmdsZVJfbG93UmVzIiwKICAgICAgICAgdGV4dF9ieSA9ICJTaW5nbGVSX2xvd1JlcyIsCiAgICAgICAgIHRleHRfc2l6ZSA9IDMpCgojIGxvdyByZXNvbHV0aW9uIGxhYmVscyBvZiB0aGUgYXV0aG9ycwpwbG90VFNORShzY2VfOTAwLAogICAgICAgICBjb2xvdXJfYnkgPSAiY2x1c3Rlcl9sb3dSZXMiLAogICAgICAgICB0ZXh0X2J5ID0gImNsdXN0ZXJfbG93UmVzIiwKICAgICAgICAgdGV4dF9zaXplID0gMykKYGBgCgpDb21wYXJpbmcgdGhlc2UgdHdvIGZpZ3VyZXMsIHdlIGNvbWUgdG8gdGhlIHNhbWUgY29uY2x1c2lvbiBhcyBhYm92ZSBiYXNlZCBvbiAKdGhlIHRhYmxlIGNvbXBhcmlzb24uCgpXZSBzZWUgaG93IHNvbWUgY2VsbHMgb3VyIGNsYXNzaWZpZXIgbGFiZWxkIG1vcmUgY2x1c3RlcnMgYXMgcm9kcy4gQmFzZWQgb24gdGhlIAptYXJrZXIgcmVzdWx0cyBmcm9tIHRoZSBmaXJzdCBzZWN0aW9uIG9mIGNlbGwgYW5ub3RhdGlvbiwgd2Uga25vd24gdGhhdCBvdXIKY2xhc3NpZmllciBhcyBtaXNjbGFzc2lmaWVkIHRoZXNlIChpLmUuLCB0aGUgb3JpZ2luYWwgbGFiZWxzIGFyZSBjb3JyZWN0KS4KCk9uIHRoZSBvdGhlciBoYW5kLCB3ZSB3ZXJlIGhlcmUgbmljZWx5IGFibGUgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBiaXBvbGFyIGNlbGxzCmFuZCByb2QgYmlwb2xhciBjZWxscywgd2hpY2ggY2x1c3RlciBzZXBhcmF0ZWx5LgoKKipBbHRvZ2V0aGVyLCBsYWJlbC10cmFuc2ZlciB3YXMgcXVpdGUgc3VjY2Vzc2Z1bCwgYW5kIHdlIHdvdWxkIGhhdmUgYmVlbiBhYmxlKioKKip0byB2ZXJ5IHF1aWNrbHkgZ2V0IGhpZ2gtcXVhbGl0eSByZXN1bHRzIHVzaW5nIHRoaXMgdmVyeSB1c2VyLWZyaWVuZGx5IGFuZCoqIAoqKmZhc3QgYXBwcm9hY2ggaW1wbGVtZW50ZWQgaW4gdGhlIGBTaW5nbGVSYCBwYWNrYWdlLioqCgojIyMgQWRkZW5kdW06IGBTaW5nbGVSYCBhdCBoaWdoIHJlZmVyZW5jZSByZXNvbHV0aW9uCgpGb3IgdGhlIHNha2Ugb2YgY29tcGxldGVuZXNzLCB3ZSBtYXkgYWxzbyBwZXJmb3JtIGxhYmVsIHRyYW5zZmVyIHdpdGggYFNpbmdsZVJgCnVzaW5nIHRoZSBtb3JlIGZpbmUtZ3JhaW5lZCBsYWJlbHMgZnJvbSB0aGUgcmVmZXJlbmNlIGRhdGFzZXQuCgpgYGB7cixldmFsPUZBTFNFfQojIFJ1bnMgM21pbiAzMHNlYyBmb3IgbWUKcHJlZC5oaWdSZXMgPC0gU2luZ2xlUih0ZXN0ID0gc2NlXzkwMCwgCiAgICAgICAgICAgICAgICAgICAgIHJlZiA9IHJlZi5kYXRhLCAKICAgICAgICAgICAgICAgICAgICAgbGFiZWxzID0gcmVmLmRhdGEkQ0xVU1RFUiwgCiAgICAgICAgICAgICAgICAgICAgIGRlLm1ldGhvZCA9ICJ3aWxjb3giKQp0YWJsZShwcmVkLmhpZ1JlcyRsYWJlbHMpCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KdGFibGUoc2NlXzkwMCRjbHVzdGVyX2xvd1JlcywgcHJlZC5oaWdSZXMkbGFiZWxzKQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CnBoZWF0bWFwOjpwaGVhdG1hcCh0YWJsZShzY2VfOTAwJGNsdXN0ZXJfbG93UmVzLCBwcmVkLmhpZ1JlcyRsYWJlbHMpKQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CmdnIDwtIHBsb3RTY29yZUhlYXRtYXAocHJlZC5oaWdSZXNbMToyMCxdKQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CiMgbG93IGNlcnRhaW50eSBsYWJlbHM6IDc1MQpzdW1tYXJ5KGlzLm5hKHByZWQuaGlnUmVzJHBydW5lZC5sYWJlbHMpKQp0YWJsZShzY2VfOTAwJGNsdXN0ZXJfbG93UmVzWyFpcy5uYShwcmVkLmhpZ1JlcyRwcnVuZWQubGFiZWxzKV0sIAogICAgICBwcmVkLmhpZ1JlcyRsYWJlbHNbIWlzLm5hKHByZWQuaGlnUmVzJHBydW5lZC5sYWJlbHMpXSkKYGBgCgoKCmBgYHtyLGV2YWw9RkFMU0V9CnNjZV85MDAkU2luZ2xlUl9oaWdoUmVzIDwtIHByZWQuaGlnUmVzJGxhYmVscwoKIyBvdXIgaGlnaCByZXNvbHV0aW9uIGxhYmVscyBiYXNlZCBvbiByZWZlcmVuY2UKcGxvdFRTTkUoc2NlXzkwMCwKICAgICAgICAgY29sb3VyX2J5ID0gIlNpbmdsZVJfaGlnaFJlcyIsCiAgICAgICAgIHRleHRfYnkgPSAiU2luZ2xlUl9oaWdoUmVzIiwKICAgICAgICAgdGV4dF9zaXplID0gMi41KQoKCiMgaGlnaCByZXNvbHV0aW9uIGxhYmVscyBvZiB0aGUgYXV0aG9ycwpwbG90VFNORShzY2VfOTAwLAogICAgICAgICBjb2xvdXJfYnkgPSAiY2x1c3Rlcl9oaWdoUmVzIiwKICAgICAgICAgdGV4dF9ieSA9ICJjbHVzdGVyX2hpZ2hSZXMiLAogICAgICAgICB0ZXh0X3NpemUgPSAyLjUpCmBgYAoKCg==</div>
<div class="footer">
    <hr>
    This work is licensed under the <a href= "https://creativecommons.org/licenses/by-nc-sa/4.0">
    CC BY-NC-SA 4.0</a> licence.
</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("lab3_MacoskoWorkflow.Rmd");
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
