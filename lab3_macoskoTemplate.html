<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Koen Van den Berge and Jeroen Gilis" />


<title>Lab3: Clustering, marker gene detection and cell type annotation</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>


<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Single-cell course</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-chalkboard-teacher"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="introSequencingBulk.html">A brief introduction to sequencing technology</a>
    </li>
    <li>
      <a href="singleCellProtocols.html">Two popular single-cell protocols</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lab1_session.html">Lab 1</a>
    </li>
    <li>
      <a href="lab2_session.html">Lab 2</a>
    </li>
    <li>
      <a href="lab3_session.html">Lab 3</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/statOmics/Rmd-website">
    <span class="fab fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://statomics.github.io/">statOmics</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Lab3: Clustering, marker gene detection and cell type annotation</h1>
<h4 class="author">Koen Van den Berge and Jeroen Gilis</h4>
<h4 class="date">6/12/2021</h4>

</div>


<div id="preamble-installation-of-bioconductor-libraries" class="section level1">
<h1><span class="header-section-number">1</span> Preamble: installation of Bioconductor libraries</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># install BiocManager package if not installed yet.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># BiocManager is the package installer for Bioconductor software.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">requireNamespace</span>(<span class="st">&quot;BiocManager&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="kw">install.packages</span>(<span class="st">&quot;BiocManager&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># install packages if not yet installed.</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SingleCellExperiment&quot;</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>          <span class="st">&quot;ExperimentHub&quot;</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>          <span class="st">&quot;edgeR&quot;</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>          <span class="st">&quot;DropletUtils&quot;</span>, </span>
<span id="cb1-11"><a href="#cb1-11"></a>          <span class="st">&quot;scRNAseq&quot;</span>, </span>
<span id="cb1-12"><a href="#cb1-12"></a>          <span class="st">&quot;scater&quot;</span>, </span>
<span id="cb1-13"><a href="#cb1-13"></a>          <span class="st">&quot;scuttle&quot;</span>, </span>
<span id="cb1-14"><a href="#cb1-14"></a>          <span class="st">&quot;scran&quot;</span>, </span>
<span id="cb1-15"><a href="#cb1-15"></a>          <span class="st">&quot;BiocSingular&quot;</span>, </span>
<span id="cb1-16"><a href="#cb1-16"></a>          <span class="st">&quot;scDblFinder&quot;</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a>notInstalled &lt;-<span class="st"> </span>pkgs[<span class="op">!</span>pkgs <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()[,<span class="dv">1</span>]]</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="cf">if</span>(<span class="kw">length</span>(notInstalled) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb1-19"><a href="#cb1-19"></a>  BiocManager<span class="op">::</span><span class="kw">install</span>(notInstalled)</span>
<span id="cb1-20"><a href="#cb1-20"></a>}</span></code></pre></div>
<p>Steps taken</p>
<ol style="list-style-type: decimal">
<li><p>Import the Macosko dataset as <code>SingleCellExperiment</code> object from the <code>scRNAseq</code> Bioconductor package.</p></li>
<li><p>Include ENSEMBL gene identifiers in the <code>rowData</code></p></li>
<li><p>Remove very lowly expressed genes</p></li>
<li><p>Remove low quality cells 4.1. Cells with outlying library size 4.2. Cells with outlying transcriptome complexity 4.3. Cells with outlying percentage of mitochondrial reads 4.4. Empty droplets 4.5. Doublets</p></li>
<li><p>Normalization 5.1. Compute log-normalized counts 5.2. Compute scaling factor to correct for differences in library size</p></li>
<li><p>Feature selection 6.1. Genes with high variance 6.2. Genes with high variance with respect to their mean expression 6.3. Genes with high deviance 6.4. Genes with high variance after variance-stabilizing transformation (VST)</p></li>
<li><p>Dimensionality reduction 7.1. Based on two most variable genes from step 6.2. 7.2. PCA 7.3. GLM-PCA 7.4. T-SNE 7.5. UMAP</p></li>
</ol>
</div>
<div id="load-end-result-after-lab-session-2" class="section level1">
<h1><span class="header-section-number">2</span> Load end-result after lab session 2</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(SingleCellExperiment)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">library</span>(scater)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">library</span>(scran)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;/Users/jg/Desktop/sce_after_labsession2.rds&quot;</span>)  <span class="co"># specify YOUR path!</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">head</span>(<span class="kw">colData</span>(sce))</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">reducedDimNames</span>(sce)</span></code></pre></div>
</div>
<div id="add-cluster-information-from-publication" class="section level1">
<h1><span class="header-section-number">3</span> Add cluster information from publication</h1>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># install.packages(&quot;tidyverse&quot;) # if not yet installed</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb6-3"><a href="#cb6-3"></a>sce<span class="op">$</span>cluster_lowRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, </span>
<span id="cb6-4"><a href="#cb6-4"></a>           <span class="st">&quot;Horizontal_cells&quot;</span> =<span class="st"> &quot;1&quot;</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>           <span class="st">&quot;Ganglion_cells&quot;</span> =<span class="st"> &quot;2&quot;</span>,</span>
<span id="cb6-6"><a href="#cb6-6"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;3&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;4&quot;</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;5&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;6&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;7&quot;</span>,</span>
<span id="cb6-11"><a href="#cb6-11"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;8&quot;</span>,</span>
<span id="cb6-12"><a href="#cb6-12"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;9&quot;</span>,</span>
<span id="cb6-13"><a href="#cb6-13"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;10&quot;</span>,</span>
<span id="cb6-14"><a href="#cb6-14"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;11&quot;</span>,</span>
<span id="cb6-15"><a href="#cb6-15"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;12&quot;</span>,</span>
<span id="cb6-16"><a href="#cb6-16"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;13&quot;</span>,</span>
<span id="cb6-17"><a href="#cb6-17"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;14&quot;</span>,</span>
<span id="cb6-18"><a href="#cb6-18"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;15&quot;</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;16&quot;</span>,</span>
<span id="cb6-20"><a href="#cb6-20"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;17&quot;</span>,</span>
<span id="cb6-21"><a href="#cb6-21"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;18&quot;</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;19&quot;</span>,</span>
<span id="cb6-23"><a href="#cb6-23"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;20&quot;</span>,</span>
<span id="cb6-24"><a href="#cb6-24"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;21&quot;</span>,</span>
<span id="cb6-25"><a href="#cb6-25"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;22&quot;</span>,</span>
<span id="cb6-26"><a href="#cb6-26"></a>           <span class="st">&quot;Amacrine&quot;</span> =<span class="st"> &quot;23&quot;</span>,</span>
<span id="cb6-27"><a href="#cb6-27"></a>           <span class="st">&quot;Rods&quot;</span> =<span class="st"> &quot;24&quot;</span>,</span>
<span id="cb6-28"><a href="#cb6-28"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;25&quot;</span>,</span>
<span id="cb6-29"><a href="#cb6-29"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;26&quot;</span>,</span>
<span id="cb6-30"><a href="#cb6-30"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;27&quot;</span>,</span>
<span id="cb6-31"><a href="#cb6-31"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;28&quot;</span>,</span>
<span id="cb6-32"><a href="#cb6-32"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;29&quot;</span>,</span>
<span id="cb6-33"><a href="#cb6-33"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;30&quot;</span>,</span>
<span id="cb6-34"><a href="#cb6-34"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;31&quot;</span>,</span>
<span id="cb6-35"><a href="#cb6-35"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;32&quot;</span>,</span>
<span id="cb6-36"><a href="#cb6-36"></a>           <span class="st">&quot;Bipolar&quot;</span> =<span class="st"> &quot;33&quot;</span>,</span>
<span id="cb6-37"><a href="#cb6-37"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;34&quot;</span>,</span>
<span id="cb6-38"><a href="#cb6-38"></a>           <span class="st">&quot;Astrocytes&quot;</span> =<span class="st"> &quot;35&quot;</span>,</span>
<span id="cb6-39"><a href="#cb6-39"></a>           <span class="st">&quot;Fibroblast&quot;</span> =<span class="st"> &quot;36&quot;</span>,</span>
<span id="cb6-40"><a href="#cb6-40"></a>           <span class="st">&quot;Vascular_endothelium&quot;</span> =<span class="st"> &quot;37&quot;</span>,</span>
<span id="cb6-41"><a href="#cb6-41"></a>           <span class="st">&quot;Pericytes&quot;</span> =<span class="st"> &quot;38&quot;</span>,</span>
<span id="cb6-42"><a href="#cb6-42"></a>           <span class="st">&quot;Microglia&quot;</span> =<span class="st"> &quot;39&quot;</span>)</span>
<span id="cb6-43"><a href="#cb6-43"></a></span>
<span id="cb6-44"><a href="#cb6-44"></a>sce<span class="op">$</span>cluster_highRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, </span>
<span id="cb6-45"><a href="#cb6-45"></a>           <span class="st">&quot;Horizontal_cells&quot;</span> =<span class="st"> &quot;1&quot;</span>,</span>
<span id="cb6-46"><a href="#cb6-46"></a>           <span class="st">&quot;Ganglion_cells&quot;</span> =<span class="st"> &quot;2&quot;</span>,</span>
<span id="cb6-47"><a href="#cb6-47"></a>           <span class="st">&quot;Amacrine_1&quot;</span> =<span class="st"> &quot;3&quot;</span>,</span>
<span id="cb6-48"><a href="#cb6-48"></a>           <span class="st">&quot;Amacrine_2&quot;</span> =<span class="st"> &quot;4&quot;</span>,</span>
<span id="cb6-49"><a href="#cb6-49"></a>           <span class="st">&quot;Amacrine_3&quot;</span> =<span class="st"> &quot;5&quot;</span>,</span>
<span id="cb6-50"><a href="#cb6-50"></a>           <span class="st">&quot;Amacrine_4&quot;</span> =<span class="st"> &quot;6&quot;</span>,</span>
<span id="cb6-51"><a href="#cb6-51"></a>           <span class="st">&quot;Amacrine_5&quot;</span> =<span class="st"> &quot;7&quot;</span>,</span>
<span id="cb6-52"><a href="#cb6-52"></a>           <span class="st">&quot;Amacrine_6&quot;</span> =<span class="st"> &quot;8&quot;</span>,</span>
<span id="cb6-53"><a href="#cb6-53"></a>           <span class="st">&quot;Amacrine_7&quot;</span> =<span class="st"> &quot;9&quot;</span>,</span>
<span id="cb6-54"><a href="#cb6-54"></a>           <span class="st">&quot;Amacrine_8&quot;</span> =<span class="st"> &quot;10&quot;</span>,</span>
<span id="cb6-55"><a href="#cb6-55"></a>           <span class="st">&quot;Amacrine_9&quot;</span> =<span class="st"> &quot;11&quot;</span>,</span>
<span id="cb6-56"><a href="#cb6-56"></a>           <span class="st">&quot;Amacrine_10&quot;</span> =<span class="st"> &quot;12&quot;</span>,</span>
<span id="cb6-57"><a href="#cb6-57"></a>           <span class="st">&quot;Amacrine_11&quot;</span> =<span class="st"> &quot;13&quot;</span>,</span>
<span id="cb6-58"><a href="#cb6-58"></a>           <span class="st">&quot;Amacrine_12&quot;</span> =<span class="st"> &quot;14&quot;</span>,</span>
<span id="cb6-59"><a href="#cb6-59"></a>           <span class="st">&quot;Amacrine_13&quot;</span> =<span class="st"> &quot;15&quot;</span>,</span>
<span id="cb6-60"><a href="#cb6-60"></a>           <span class="st">&quot;Amacrine_14&quot;</span> =<span class="st"> &quot;16&quot;</span>,</span>
<span id="cb6-61"><a href="#cb6-61"></a>           <span class="st">&quot;Amacrine_15&quot;</span> =<span class="st"> &quot;17&quot;</span>,</span>
<span id="cb6-62"><a href="#cb6-62"></a>           <span class="st">&quot;Amacrine_16&quot;</span> =<span class="st"> &quot;18&quot;</span>,</span>
<span id="cb6-63"><a href="#cb6-63"></a>           <span class="st">&quot;Amacrine_17&quot;</span> =<span class="st"> &quot;19&quot;</span>,</span>
<span id="cb6-64"><a href="#cb6-64"></a>           <span class="st">&quot;Amacrine_18&quot;</span> =<span class="st"> &quot;20&quot;</span>,</span>
<span id="cb6-65"><a href="#cb6-65"></a>           <span class="st">&quot;Amacrine_19&quot;</span> =<span class="st"> &quot;21&quot;</span>,</span>
<span id="cb6-66"><a href="#cb6-66"></a>           <span class="st">&quot;Amacrine_20&quot;</span> =<span class="st"> &quot;22&quot;</span>,</span>
<span id="cb6-67"><a href="#cb6-67"></a>           <span class="st">&quot;Amacrine_21&quot;</span> =<span class="st"> &quot;23&quot;</span>,</span>
<span id="cb6-68"><a href="#cb6-68"></a>           <span class="st">&quot;Rods&quot;</span> =<span class="st"> &quot;24&quot;</span>,</span>
<span id="cb6-69"><a href="#cb6-69"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;25&quot;</span>,</span>
<span id="cb6-70"><a href="#cb6-70"></a>           <span class="st">&quot;Bipolar_1&quot;</span> =<span class="st"> &quot;26&quot;</span>,</span>
<span id="cb6-71"><a href="#cb6-71"></a>           <span class="st">&quot;Bipolar_2&quot;</span> =<span class="st"> &quot;27&quot;</span>,</span>
<span id="cb6-72"><a href="#cb6-72"></a>           <span class="st">&quot;Bipolar_3&quot;</span> =<span class="st"> &quot;28&quot;</span>,</span>
<span id="cb6-73"><a href="#cb6-73"></a>           <span class="st">&quot;Bipolar_4&quot;</span> =<span class="st"> &quot;29&quot;</span>,</span>
<span id="cb6-74"><a href="#cb6-74"></a>           <span class="st">&quot;Bipolar_5&quot;</span> =<span class="st"> &quot;30&quot;</span>,</span>
<span id="cb6-75"><a href="#cb6-75"></a>           <span class="st">&quot;Bipolar_6&quot;</span> =<span class="st"> &quot;31&quot;</span>,</span>
<span id="cb6-76"><a href="#cb6-76"></a>           <span class="st">&quot;Bipolar_7&quot;</span> =<span class="st"> &quot;32&quot;</span>,</span>
<span id="cb6-77"><a href="#cb6-77"></a>           <span class="st">&quot;Bipolar_8&quot;</span> =<span class="st"> &quot;33&quot;</span>,</span>
<span id="cb6-78"><a href="#cb6-78"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;34&quot;</span>,</span>
<span id="cb6-79"><a href="#cb6-79"></a>           <span class="st">&quot;Astrocytes&quot;</span> =<span class="st"> &quot;35&quot;</span>,</span>
<span id="cb6-80"><a href="#cb6-80"></a>           <span class="st">&quot;Fibroblast&quot;</span> =<span class="st"> &quot;36&quot;</span>,</span>
<span id="cb6-81"><a href="#cb6-81"></a>           <span class="st">&quot;Vascular_endothelium&quot;</span> =<span class="st"> &quot;37&quot;</span>,</span>
<span id="cb6-82"><a href="#cb6-82"></a>           <span class="st">&quot;Pericytes&quot;</span> =<span class="st"> &quot;38&quot;</span>,</span>
<span id="cb6-83"><a href="#cb6-83"></a>           <span class="st">&quot;Microglia&quot;</span> =<span class="st"> &quot;39&quot;</span>)</span></code></pre></div>
</div>
<div id="clustering" class="section level1">
<h1><span class="header-section-number">4</span> Clustering</h1>
<div id="graph-based-clustering" class="section level2">
<h2><span class="header-section-number">4.1</span> Graph-based clustering</h2>
<p>First, we discuss graph-based clustering methods for scRNA-Seq data. This is very well explained in the <a href="http://bioconductor.org/books/3.14/OSCA.basic/clustering.html#clustering-graph">OSCA book chapter 5.2</a>.</p>
<p>As written in the OSCA book: “Popularized by its use in Seurat, graph-based clustering is a flexible and scalable technique for clustering large scRNA-seq datasets. We first build a graph where each node is a cell that is connected to its nearest neighbors in the high-dimensional space. Edges are weighted based on the similarity between the cells involved, with higher weight given to cells that are more closely related. We then apply algorithms to identify “communities” of cells that are more connected to cells in the same community than they are to cells of different communities. Each community represents a cluster that we can use for downstream interpretation.</p>
<p>The major advantage of graph-based clustering lies in its scalability. It only requires a k-nearest neighbor search that can be done in log-linear time on average, in contrast to hierarchical clustering methods with runtimes that are quadratic with respect to the number of cells. Graph construction avoids making strong assumptions about the shape of the clusters or the distribution of cells within each cluster, compared to other methods like k-means (that favor spherical clusters) or Gaussian mixture models (that require normality)."</p>
<p>Several graph-based clustering algorithms are implemented in the <code>scran</code> library. The most global wrapper-function in this package is the <code>clusterCells</code> function. Typically, the input to this function is a <code>SingleCellExperiment</code> object with pre-computed principal components; these are used to take advantage of data compression and denoising. If the default settings are adopted, <code>clusterCells</code> will perform two steps under the hood:</p>
<ol style="list-style-type: decimal">
<li><p>Build a shared nearest neighbors (SNN) graph of observations for downstream community detection. The SNN graph is closely related to the more common KNN graph. For each observation, its k-nearest neighbors are identified (k=10 by default), based on distances between their expression profiles (Euclidean distances are used by default) as observed in PCA space. An edge is drawn between all pairs of observations that share at least one neighbor, weighted by the characteristics of the shared nearest neighbors.</p></li>
<li><p>The <code>clusterCells</code> function next internally calls the <code>cluster_walktrap</code> function from the <code>igraph</code> library. Based on the SNN graph from step 1, this function tries to find densely connected subgraphs, also called communities in a graph via random walks. The idea is that short random walks tend to stay in the same community.</p></li>
</ol>
<pre><code># Do not run; clusterCells function with default settings, i.e., building an
# SNN graph and finding clusters with the walktrap algorithm.
library(scran)
nn.clusters &lt;- clusterCells(sce, 
                            use.dimred=&quot;PCA&quot;)
table(nn.clusters)</code></pre>
<p>The disadvantage of using <code>clusterCells</code> is that the default setting of the second step, the <code>cluster_walktrap</code> function, is slow for large datasets. While it is possible to adjust the different arguments of the <code>clusterCells</code> function, it might be more clear and intuitive to simply break up the process in two steps: building the graph and detecting clusters in that graph. For this second step, we may then adopt a faster algorithm.</p>
<div id="build-graph-snn-graph" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Build graph (SNN graph)</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Build a shared nearest-neighbor graph from PCA space</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>graph &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(<span class="dt">x =</span> ..., <span class="co"># our SCE object</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>                       <span class="dt">use.dimred =</span> ...) <span class="co">#  A string specifying which existing values in reducedDims(x) should be used.</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># alternative: buildKNNGraph()</span></span></code></pre></div>
</div>
<div id="detect-clusters-on-the-graph" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Detect clusters on the graph</h3>
<p>Two popular graph-based clustering algorithm are the <code>leiden</code> and <code>louvain</code> algorithms, both referring to the location of its developers. A common implementation of the <a href="https://iopscience.iop.org/article/10.1088/1742-5468/2008/10/P10008"><code>louvain</code>algorithm</a> is to optimize the modularity, effectively attempting to maximize the difference between the observed number of edges in a community and the expected number of such edges.</p>
<p>However, additional evaluations found that modularity optimization using the <code>louvain</code> algorithm is confined to a <a href="https://www.pnas.org/content/104/1/36">resolution limit</a>, and in addition may result in communities that are not well connected. The <a href="https://www.nature.com/articles/s41598-019-41695-z"><code>leiden</code> algorithm</a>, instead, guarantees well-connected communities.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">set.seed</span>(<span class="dv">464688</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># Walktrap community finding algorithm on the SNN graph</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># DO NOT RUN -&gt; takes 20 minutes</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># cluster_walktrap &lt;- factor(igraph::cluster_walktrap(g)$membership) #20min</span></span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co"># The `cluster_fast_greedy` function tries to find dense subgraph, also called </span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># communities in graphs via directly optimizing a modularity score</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co"># DO NOT RUN -&gt; takes 4 minutes</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co"># cluster_fastGreedy &lt;- factor(igraph::cluster_fast_greedy(graph)$membership) #4min</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co"># Louvain clustering on the SNN graph</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>cluster_louvain &lt;-<span class="st"> </span><span class="kw">factor</span>(igraph<span class="op">::</span><span class="kw">cluster_louvain</span>(graph)<span class="op">$</span>membership) <span class="co">#8sec</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="kw">nlevels</span>(cluster_louvain) <span class="co"># 11 clusters</span></span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co"># Leiden clustering on the SNN graph</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>cluster_leiden &lt;-<span class="st"> </span>... <span class="co">#10sec</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="kw">nlevels</span>(cluster_leiden) <span class="co"># 1326 different clusters!</span></span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co"># obtain a less overly fine-grained clustering</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>cluster_leiden2 &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">...</span>(<span class="dt">graph =</span> ...,</span>
<span id="cb9-21"><a href="#cb9-21"></a>                              <span class="dt">resolution_parameter =</span> <span class="fl">0.01</span>)<span class="op">$</span>membership) <span class="co">#10sec</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="kw">nlevels</span>(cluster_leiden2) <span class="co">#14 different clusters</span></span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="co"># add clusterings to colData</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster_louvain &lt;-<span class="st"> </span>...</span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster_leiden2 &lt;-<span class="st"> </span>...</span></code></pre></div>
</div>
<div id="comparing-clustering-strategies" class="section level3">
<h3><span class="header-section-number">4.1.3</span> Comparing clustering strategies</h3>
<p>A direct comparison of the Louvain and Leiden clustering results using a table of the cluster labels, shows good agreement.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">table</span>(..., ...) <span class="co"># compare Louvain and Leiden2 clustering</span></span></code></pre></div>
<p>Interpret the result of the comparison between the two clustering strategies. Is there a strong correspondence between the strategies?</p>
<p>To make a visualization that gives us very similar information, we may use a heatmap:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">#install.packages(&quot;pheatmap&quot;) # if not yet installed</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb11-3"><a href="#cb11-3"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(<span class="kw">table</span>(..., ...)) <span class="co"># heatmap to visualize the tabular comparison of above </span></span></code></pre></div>
<p>Again, interpret the result of the comparison between the two clustering strategies.</p>
<p>Alternatively, we may compute a clustering similarity score that captures the agreement between two sets of partitions. The Adjusted Rand Index (ARI) is often used in the literature for this purpose. The ARI is equal to 1 if the two partitions agree perfectly, and it is zero if the two partitions are unrelated. In some cases, the ARI may also be negative if the partitions are much more different than what could be expected by chance.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#install.packages(&quot;mclust&quot;) # if not yet installed</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">library</span>(mclust)</span>
<span id="cb12-3"><a href="#cb12-3"></a>mclust<span class="op">::</span><span class="kw">adjustedRandIndex</span>(..., <span class="co"># Louvain </span></span>
<span id="cb12-4"><a href="#cb12-4"></a>                          ... <span class="co"># Leiden)</span></span></code></pre></div>
</div>
<div id="visualization" class="section level3">
<h3><span class="header-section-number">4.1.4</span> Visualization</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># Visualization. Add the cluster labels to the previously generated TSNE</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co"># coordinates</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb13-4"><a href="#cb13-4"></a>         <span class="dt">colour_by=</span><span class="st">&quot;cluster_louvain&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">plotTSNE</span>(sce, </span>
<span id="cb13-7"><a href="#cb13-7"></a>         <span class="dt">colour_by=</span><span class="st">&quot;cluster_leiden2&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="k-means-clustering" class="section level2">
<h2><span class="header-section-number">4.2</span> K-means clustering</h2>
<p>K-means is a clustering algorithm that has been used in many application areas. In R, it can be applied via the <code>kmeans</code> function. Typically, it is applied to a reduced dimensional representation of the expression data (most often PCA). We need to define the number of clusters in advance. Since the results depend on the initialization of the cluster centers, it is typically recommended to run k-means with multiple starting configurations (via the <code>nstart</code> argument). For reproducibility, we also strongly advise to set a seed.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co"># k=10</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>clust_kmeans_k10 &lt;-<span class="st"> </span><span class="kw">kmeans</span>(<span class="kw">reducedDim</span>(...), <span class="co"># extract the principal components from the SCE object</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>                           <span class="dt">centers =</span> ..., <span class="co"># choose k = 10</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>                           <span class="dt">nstart =</span> ...)  <span class="co"># choose 5 different starting configurations</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="kw">table</span>(clust_kmeans_k10<span class="op">$</span>cluster) <span class="co"># inspect the number of cells in each kmeans cluster</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="kw">colData</span>(sce)<span class="op">$</span>kmeans10 &lt;-<span class="st"> </span>... <span class="co"># add to colData</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="kw">plotTSNE</span>(<span class="dt">object =</span> ..., </span>
<span id="cb14-10"><a href="#cb14-10"></a>         <span class="dt">colour_by =</span> ...) <span class="co"># color the observations according to the k-means clustering</span></span>
<span id="cb14-11"><a href="#cb14-11"></a></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co"># repeat for k=39</span></span></code></pre></div>
<p>We here arbitrarily performed two k-means clustering analyses, once with k=10 and once with k=39 (the number of clusters communicated by the authors). The choice of the number of clusters k can be guided by known biology, however, it is arbitrary at least to some interval.</p>
</div>
<div id="hierarchical-clustering" class="section level2">
<h2><span class="header-section-number">4.3</span> Hierarchical clustering</h2>
<p>From <a href="http://bioconductor.org/books/3.14/OSCA.basic/clustering.html#hierarchical-clustering">OSCA book chapter 5.4</a>:</p>
<p>"Hierarchical clustering is an old technique that arranges samples into a hierarchy based on their relative similarity to each other. Most implementations do so by joining the most similar samples into a new cluster, then joining similar clusters into larger clusters, and so on, until all samples belong to a single cluster. This process yields a dendrogram that defines clusters with progressively increasing granularity. Variants of hierarchical clustering methods primarily differ in how they choose to perform the agglomerations. For example, complete linkage aims to merge clusters with the smallest maximum distance between their elements, while Ward’s method aims to minimize the increase in within-cluster variance.</p>
<p>In the context of scRNA-seq, the main advantage of hierarchical clustering lies in the production of the dendrogram. This is a rich summary that quantitatively captures the relationships between subpopulations at various resolutions. Cutting the dendrogram at high resolution is also guaranteed to yield clusters that are nested within those obtained at a low-resolution cut; this can be helpful for interpretation."</p>
<p>Indeed, low-resolution clusters can typically be interpreted as super-level cell types, like immune cells, neuron cells or endothelial cells. Higher resolution clusters correspond with a higher biological resolution: immune cell -&gt; lymphocyte -&gt; T-cell -&gt; Th1 cell.</p>
<p>However, note that we can also overcluster the data (splitting a homogenous set of cells in multiple clusters), resulting in spurious cell type identification.</p>
<p>The <code>clusterCells</code> function of the <code>scran</code> library also allows for performing hierarchical clustering. This can be implemented as follows:</p>
<pre><code># takes 4 minutes
library(bluster)
hclust.sce &lt;- clusterCells(x = sce, 
                            use.dimred = &quot;PCA&quot;,
                            BLUSPARAM = HclustParam(method=&quot;ward.D2&quot;))</code></pre>
<p>Equivalently, we may again split the process in two steps:</p>
<ol style="list-style-type: decimal">
<li><p>Compute the pairwise distances between all cells. These are by default Euclidean distances and, in order to reduce data complexity and increase signal to noise, we may perform this on the top (30) PC’s, just like we did when constructing the SNN graph in graph-based clustering. Calculating a dissimilarity matrix is implemented in the <code>dist</code> function.</p></li>
<li><p>Perform a hierarchical clustering on the distances from step 1. In an agglomerative procedure, each cell is first assigned to its own cluster and then the algorithm proceeds iteratively, at each stage joining the two most similar clusters, continuing until there is just a single cluster. Implemented in the <code>hclust</code> function.</p></li>
</ol>
<p>Note that the <code>hclust</code> function allows for specifying a “method” argument. The differences between the different methods goes beyond the scope of this session, but a brief description is provided in the function help file. In the context of scRNA-seq, we recommend the use of the <code>"ward.D2"</code> method.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>distsce &lt;-<span class="st"> </span><span class="kw">dist</span>(...) <span class="co"># extract the principal components from the SCE object (runs 1min)</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>hcl &lt;-<span class="st"> </span><span class="kw">hclust</span>(distsce, </span>
<span id="cb16-3"><a href="#cb16-3"></a>              <span class="dt">method =</span> ...) <span class="co"># runs 3min</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="kw">plot</span>(hcl, </span>
<span id="cb16-5"><a href="#cb16-5"></a>     <span class="dt">labels =</span> <span class="ot">FALSE</span>) <span class="co"># visualize dendrogram</span></span></code></pre></div>
<p>Next, in order to derive a given set of cluster labels, we need to “cut the tree”, i.e., choose at which resolution we want to report the (cell type) clusters. This can be achieved with the <code>cutree</code> function. As an input, <code>cutree</code> takes the dendrogram from the <code>hclust</code> function and a threshold value for cutting the tree. The latter may be either <code>k</code>, the number of clusters we want to report, or <code>h</code>, the height of the dendrogram at which we want to cut the tree.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># cut to get 10 clusters</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>clust_hcl_k10 &lt;-<span class="st"> </span><span class="kw">cutree</span>(<span class="dt">tree =</span> ..., <span class="co"># name of clustering tree</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>                        <span class="dt">k =</span> ...) <span class="co"># desired number of groups</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="kw">table</span>(clust_hcl_k10)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># cut to get 39 clusters</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>...</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>sce<span class="op">$</span>clust_hcl_k10 &lt;-<span class="st"> </span>... <span class="co"># add to colData</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>sce<span class="op">$</span>clust_hcl_k39 &lt;-<span class="st"> </span>a... <span class="co"># add to colData</span></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># Visualization. Add the cluster labels to the previously generated TSNE</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co"># coordinates</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="kw">plotTSNE</span>(<span class="dt">object =</span> ..., </span>
<span id="cb19-7"><a href="#cb19-7"></a>         <span class="dt">colour_by =</span> ...) <span class="co"># k=10</span></span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">plotTSNE</span>(<span class="dt">object =</span> ..., </span>
<span id="cb19-10"><a href="#cb19-10"></a>         <span class="dt">colour_by =</span> ...) <span class="co"># k=39</span></span></code></pre></div>
</div>
</div>
<div id="clustering-in-the-original-paper" class="section level1">
<h1><span class="header-section-number">5</span> Clustering in the original paper</h1>
<p>When we compare our cluster labels with those from the original paper, we’ll see that the correspondence is not great. As a demonstration, I make a table and a heatmap comparing the low-resolution cluster labels from the paper with our Louvain, Leiden2 and hierarchical clustering (k=10) labels:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster_lowRes, ...) <span class="co"># compare low resolution clusters of authors to our Louvain clustering</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>... <span class="co"># compare low resolution clusters of authors to our Leiden2 clustering</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>... <span class="co"># compare low resolution clusters of authors to our hierarchical (k=10) clustering</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># all three comparisons with heatmaps</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(...)</span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(...)</span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(...)</span></code></pre></div>
<p>Also, when we look at the t-SNE from the original publication, we observe clearly distinct clusters:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;macosko_figure_5B.jpeg&quot;</span>)</span></code></pre></div>
<p><img src="macosko_figure_5B.jpeg" /><!-- --></p>
<p>The main reason for this is that the authors of the original paper used quite a different strategy for performing the feature selection and dimension reduction that we have performed in lab session 2.</p>
<p>To demonstrate the pipeline of the original authors, and to make our results more comparable to theirs, We will here mimic their strategy for feature selection and clustering. <strong>However, we will do this approximatively!</strong> We will take similar steps conceptually, but will remain within the current Bioconductor framework and the range of functions that we have seen in this lecture series.</p>
<p>The authors performed the following steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Filtering:</strong> The authors first filtered the 49,300-cell dataset to retain only single-cell libraries where at least 900 genes were detected.</p></li>
<li><p><strong>Feature selection:</strong> The authors first identified the set of genes that were most variable across the selected susbet of cells, after controlling for the relationship between mean expression and variability. To do this, the authors adopted a manual implementation.</p></li>
</ol>
<p>-&gt; We will not use the exact same strategy, but the <code>modelGeneVar-getTopHVGs</code> strategy, which is conceptually similar in addressing the mean-variance relationship during feature selection.</p>
<ol start="3" style="list-style-type: decimal">
<li><p><strong>Principal component analysis:</strong> The authors performed PCA after scaling the data. They next performed a test to determine how many PCs contributed significantly to explaining the variability in the data. Based on this test, they continued the analysis pipeline with the top 32 PCs.</p></li>
<li><p><strong>t-SNE:</strong> Next, the authors performed a t-SNE on the top 32 PC’s, setting the <code>perplexity</code> parameter of the t-SNE algorithm to 30.</p></li>
<li><p><strong>Projection of remaining cells and clustering:</strong> Finally, the authors adopted a manually implemented, rather complex strategy to project the remaining cells (where less than 900 different genes were detected) on the t-SNE embedding obtained in step 4. Next, they cluster the cells using a density clustering (DBSCAN algorithm) that was not discussed in this lecture series. Because this 5th step uses techniques beyond the scope of this course, we will simply continue working with the filtered dataset and perform hierarchical clustering. However, we included some code that allows you to do something similar to what the authors did for your reference (note that running<br />
this code requires installing the <code>snifter</code> R package, which requires a working Python and Conda installation).</p></li>
</ol>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># code for steps 1-4</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">library</span>(scater)</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="kw">library</span>(genefilter)</span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="kw">library</span>(scran)</span>
<span id="cb25-5"><a href="#cb25-5"></a></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co"># Step 1: Downsampling</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span>sce[,sce<span class="op">$</span>detected <span class="op">&gt;</span><span class="st"> </span><span class="dv">900</span>]</span>
<span id="cb25-8"><a href="#cb25-8"></a></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co"># Step 2: Feature selection</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce_<span class="dv">900</span>)</span>
<span id="cb25-11"><a href="#cb25-11"></a>dec_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">modelGeneVar</span>(sce_<span class="dv">900</span>)</span>
<span id="cb25-12"><a href="#cb25-12"></a>hvg_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec_<span class="dv">900</span>,</span>
<span id="cb25-13"><a href="#cb25-13"></a>                      <span class="dt">n =</span> <span class="dv">374</span>) <span class="co"># same number of top features as original paper</span></span>
<span id="cb25-14"><a href="#cb25-14"></a></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="co"># Step 3: PCA</span></span>
<span id="cb25-16"><a href="#cb25-16"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb25-17"><a href="#cb25-17"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce_<span class="dv">900</span>, </span>
<span id="cb25-18"><a href="#cb25-18"></a>                  <span class="dt">ncomponents =</span> <span class="dv">32</span>, <span class="co"># same number of PCs as original paper</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>                  <span class="dt">subset_row =</span> hvg_<span class="dv">900</span>,</span>
<span id="cb25-20"><a href="#cb25-20"></a>                  <span class="dt">scale=</span><span class="ot">TRUE</span>) <span class="co"># scale the data like in original paper</span></span>
<span id="cb25-21"><a href="#cb25-21"></a></span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="co"># Step 4: T-SNE</span></span>
<span id="cb25-23"><a href="#cb25-23"></a><span class="kw">set.seed</span>(<span class="dv">484854</span>)</span>
<span id="cb25-24"><a href="#cb25-24"></a>sce_<span class="dv">900</span> &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce_<span class="dv">900</span>, </span>
<span id="cb25-25"><a href="#cb25-25"></a>               <span class="dt">dimred =</span> <span class="st">&#39;PCA&#39;</span>,</span>
<span id="cb25-26"><a href="#cb25-26"></a>               <span class="dt">n_dimred =</span> <span class="dv">32</span>,</span>
<span id="cb25-27"><a href="#cb25-27"></a>               <span class="dt">perplexity =</span> <span class="dv">30</span>) <span class="co"># same perplexity as original paper</span></span></code></pre></div>
<pre><code># Step 5 authors (just for your reference): project new cells on t-SNE embedding
#BiocManager::install(&quot;snifter&quot;)
library(snifter)
tsne1 &lt;- snifter::fitsne(reducedDim(sce_900, type=&quot;PCA&quot;))
embedding &lt;- reducedDim(sce[hvg_900,sce$detected&gt;900], type=&quot;PCA&quot;)

ggplot() +
  aes(tsne1[, 1], tsne1[, 2], colour = as.factor(sce[,sce$detected&gt;900]$cluster)) +
  geom_point(pch = 19) +
  scale_colour_discrete(name = &quot;Cluster&quot;) +
  labs(x = &quot;t-SNE 1&quot;, y = &quot;t-SNE 2&quot;) +
  theme_bw()

new_coords &lt;- project(tsne1, 
                      new = reducedDim(sce[,sce$detected&lt;=900], type=&quot;PCA&quot;), 
                      old = reducedDim(sce[,sce$detected&gt;900], type=&quot;PCA&quot;))
ggplot() +
    geom_point(
        aes(tsne1[, 1], tsne1[, 2],
            colour = as.factor(sce[,sce$detected&gt;900]$cluster),
            shape = &quot;embedding&quot;
        )
    ) +
    geom_point(
        aes(new_coords[, 1], new_coords[, 2], 
            colour = as.factor(sce[,sce$detected&lt;=900]$cluster),
            shape = &quot;projection&quot;
        )
    ) +
    scale_colour_discrete(name = &quot;Cell type&quot;) +
    scale_shape_discrete(name = NULL) +
    labs(x = &quot;t-SNE 1&quot;, y = &quot;t-SNE 2&quot;) +
    theme_bw()</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Step 5 for us: perform hierarchical clustering</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>distsce &lt;-<span class="st"> </span><span class="kw">dist</span>(...)</span>
<span id="cb27-3"><a href="#cb27-3"></a>hcl &lt;-<span class="st"> </span><span class="kw">hclust</span>(<span class="dt">tree =</span> ..., </span>
<span id="cb27-4"><a href="#cb27-4"></a>              <span class="dt">method =</span> ...)</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a>clust_hcl_k10 &lt;-<span class="st"> </span>...</span>
<span id="cb27-7"><a href="#cb27-7"></a>clust_hcl_k39 &lt;-<span class="st"> </span>...</span>
<span id="cb27-8"><a href="#cb27-8"></a></span>
<span id="cb27-9"><a href="#cb27-9"></a>sce_<span class="dv">900</span><span class="op">$</span>clust_hcl_k10 &lt;-<span class="st"> </span>...</span>
<span id="cb27-10"><a href="#cb27-10"></a>sce_<span class="dv">900</span><span class="op">$</span>clust_hcl_k39 &lt;-<span class="st"> </span>...</span></code></pre></div>
<p>Visualize our labels and compare with original labels at the low resolution</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># visualize our labels</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="kw">plotTSNE</span>(<span class="dt">object =</span> ...,</span>
<span id="cb28-3"><a href="#cb28-3"></a>         <span class="dt">colour_by =</span> ...,</span>
<span id="cb28-4"><a href="#cb28-4"></a>         <span class="dt">text_by =</span> ...)</span>
<span id="cb28-5"><a href="#cb28-5"></a></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="co"># compare with original labels</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="kw">plotTSNE</span>(<span class="dt">object =</span> sce_<span class="dv">900</span>,</span>
<span id="cb28-8"><a href="#cb28-8"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>,</span>
<span id="cb28-9"><a href="#cb28-9"></a>         <span class="dt">text_by =</span> <span class="st">&quot;cluster_lowRes&quot;</span>,</span>
<span id="cb28-10"><a href="#cb28-10"></a>         <span class="dt">text_size =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Carefully compare the two resulting figures!</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># repeat for high resolution labels (2 new t-SNE plots)</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>...</span></code></pre></div>
<p>Carefully compare the two resulting figures!</p>
<p><strong>Overall, we observe a rather strong correspondence between our clusters and</strong> <strong>those of the authors.</strong> Also note that our t-SNE visualization now resembles the t-SNE map of the original authors much more closely:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;./macosko_figure_5B.jpeg&quot;</span>)</span></code></pre></div>
<p><img src="macosko_figure_5B.jpeg" /><!-- --></p>
</div>
<div id="cell-type-annotation" class="section level1">
<h1><span class="header-section-number">6</span> Cell type annotation</h1>
<div id="supervised-using-a-limited-set-of-known-markers" class="section level2">
<h2><span class="header-section-number">6.1</span> Supervised: using a limited set of known markers</h2>
<p>In the publication, the authors aimed to identify the different clusters in the data by using a set of 12 well-known molecular markers; genes for which the expression profile is typically very specific, i.e., highly expressed only in one specific cell type. They used the following markers:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>markers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;LHX1&quot;</span>, <span class="st">&quot;SLC17A6&quot;</span>,<span class="st">&quot;PAX6&quot;</span>,<span class="st">&quot;GAD1&quot;</span>,<span class="st">&quot;SLC6A9&quot;</span>,<span class="st">&quot;OPN1MW&quot;</span>,<span class="st">&quot;VSX2&quot;</span>,</span>
<span id="cb31-2"><a href="#cb31-2"></a>             <span class="st">&quot;RLBP1&quot;</span>, <span class="st">&quot;GFAP&quot;</span>, <span class="st">&quot;PECAM1&quot;</span>, <span class="st">&quot;KCNJ8&quot;</span>,<span class="st">&quot;CX3CR1&quot;</span>)</span></code></pre></div>
<p>We will here visualize the expression of these markers in t-SNE space. First, we create a “baseline” figure, displaying each cell in 2D space, colored in black.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb32-2"><a href="#cb32-2"></a>gg_hlp_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">reducedDim</span>(sce_<span class="dv">900</span>, <span class="dt">type =</span> <span class="st">&quot;TSNE&quot;</span>)[,<span class="dv">1</span>],</span>
<span id="cb32-3"><a href="#cb32-3"></a>                          <span class="dt">y =</span> <span class="kw">reducedDim</span>(sce_<span class="dv">900</span>, <span class="dt">type =</span> <span class="st">&quot;TSNE&quot;</span>)[,<span class="dv">2</span>],</span>
<span id="cb32-4"><a href="#cb32-4"></a>                          <span class="dt">cluster =</span> sce_<span class="dv">900</span><span class="op">$</span>cluster)</span>
<span id="cb32-5"><a href="#cb32-5"></a>gg_base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gg_hlp_data[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster),],</span>
<span id="cb32-6"><a href="#cb32-6"></a>                  <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y,)) <span class="op">+</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="st">    </span><span class="kw">theme_bw</span>() <span class="op">+</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;TSNE 1&quot;</span>) <span class="op">+</span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;TSNE 2&quot;</span>)</span>
<span id="cb32-11"><a href="#cb32-11"></a>gg_base</span></code></pre></div>
<p>Next, we obtain the counts of the 12 pre-selected marker genes for all cells.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>marker_counts &lt;-<span class="st"> </span><span class="kw">assays</span>(sce_<span class="dv">900</span>)<span class="op">$</span>counts[markers,]</span>
<span id="cb33-2"><a href="#cb33-2"></a>marker_counts &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">t</span>(marker_counts))</span></code></pre></div>
<p>Finally, we make one figure for each of the 12 marker genes. The idea is to give each cell that has a non-zero expression of the marker (i.e., for which the marker is expressed) a red coloring.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>marker_counts_binary &lt;-<span class="st"> </span>marker_counts</span>
<span id="cb34-2"><a href="#cb34-2"></a>marker_counts_binary[<span class="kw">which</span>(marker_counts_binary <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb34-3"><a href="#cb34-3"></a></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(markers)) {</span>
<span id="cb34-5"><a href="#cb34-5"></a>    gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gg_hlp_data[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster),],</span>
<span id="cb34-6"><a href="#cb34-6"></a>                    <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="st">        </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">as.factor</span>(marker_counts_binary[,i])[<span class="op">!</span><span class="kw">is.na</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster)]), <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="st">        </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;black&quot;</span>,<span class="st">&quot;red&quot;</span>)) <span class="op">+</span></span>
<span id="cb34-9"><a href="#cb34-9"></a><span class="st">        </span><span class="kw">xlab</span>(<span class="st">&quot;TSNE 1&quot;</span>) <span class="op">+</span></span>
<span id="cb34-10"><a href="#cb34-10"></a><span class="st">        </span><span class="kw">ylab</span>(<span class="st">&quot;TSNE 2&quot;</span>) <span class="op">+</span></span>
<span id="cb34-11"><a href="#cb34-11"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="kw">colnames</span>(marker_counts_binary)[i]) <span class="op">+</span></span>
<span id="cb34-12"><a href="#cb34-12"></a><span class="st">        </span><span class="kw">theme_bw</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb34-13"><a href="#cb34-13"></a><span class="st">      </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())</span>
<span id="cb34-14"><a href="#cb34-14"></a>    <span class="kw">print</span>(gg)</span>
<span id="cb34-15"><a href="#cb34-15"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Visualize our clusters</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw">plotTSNE</span>(sce_<span class="dv">900</span>,</span>
<span id="cb35-3"><a href="#cb35-3"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>,</span>
<span id="cb35-4"><a href="#cb35-4"></a>         <span class="dt">text_by =</span> <span class="st">&quot;clust_hcl_k39&quot;</span>)</span></code></pre></div>
<p>From figure 5D, we obtain the marker-cell type relationship:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;macosko_figure_5D.jpeg&quot;</span>)</span></code></pre></div>
<p><img src="macosko_figure_5D.jpeg" /><!-- --></p>
<p>Try to go back and forth between</p>
<ol style="list-style-type: decimal">
<li>the visualization of marker expression on the t-SNE map,</li>
<li>the visualization of our cluster labels on the t-SNE map, and</li>
<li>the marker-cell type relationship from figure 5D.</li>
</ol>
<p>This should allow you to obtain a low-resolution annotation for most of the clusters we have manually obtained ourselves! We give away one of the easiest annotations:</p>
<ul>
<li>The <em>LHX1</em> marker is specific for horizontal cells. As such, our <strong>cluster 3</strong> corresponds to <strong>horizontal cells</strong>.</li>
</ul>
<p>You can do this for the other markers/clusters (sometimes it will still be ambiguous).</p>
</div>
<div id="supervised-using-marker-genes-detected-from-this-data" class="section level2">
<h2><span class="header-section-number">6.2</span> Supervised: Using marker genes detected from this data</h2>
<p>Sometimes it will be very difficult to set up a panel of known marker genes that would allow us to distinguish between all cell types in our dataset. For instance, sometimes we may not know in advance which cell types to expect, or we may not have good information on relevant markers (if the studied system is not well known).</p>
<p>An alternative strategy is to identify the genes that drive separation between clusters. These marker genes allow us to assign biological meaning to each cluster based on their functional annotation. This strategy is referred to as <strong>marker gene detection</strong>.</p>
<p>The most straightforward approach to marker gene detection involves testing for differential expression (DE) between clusters. If a gene is strongly DE between clusters, it is likely to have driven the separation of cells in the dimensionality reduction. The general strategy is to compare each pair of clusters and compute scores quantifying the differences in the expression distributions between clusters. The scores for all pairwise comparisons involving a particular cluster are then consolidated into a single data frame for that cluster. This approach is implemented in the <code>scoreMarkers</code> function of the <code>scran</code> package.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="kw">library</span>(scran)</span>
<span id="cb37-2"><a href="#cb37-2"></a>marker.info &lt;-<span class="st"> </span><span class="kw">scoreMarkers</span>(<span class="dt">x =</span> ..., <span class="co"># the SCE object</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>                            <span class="dt">groups =</span> ...) <span class="co"># our cluster identifiers</span></span>
<span id="cb37-4"><a href="#cb37-4"></a>marker.info <span class="co"># one dataframe for each of the 39 clusters</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">colnames</span>(marker.info[[<span class="st">&quot;1&quot;</span>]]) <span class="co"># statistics for cluster 1.</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">head</span>(marker.info[[<span class="st">&quot;1&quot;</span>]])</span></code></pre></div>
<p>We observe several summary statistics for each gene in the dataframe for cluster 1. We highlight a few:</p>
<ul>
<li><p><code>self.average</code>: the average log-normalized expression of the gene in the target cluster (cluster 1)</p></li>
<li><p><code>other.average</code>: the average log-normalized expression of the gene in all the other clusters (clusters 2-39)</p></li>
<li><p><code>self.detected</code>: the fraction of cells in which the gene was expressed in the target cluster (cluster 1)</p></li>
<li><p><code>other.detected</code>: the fraction of cells in which the gene was expressed in all the other clusters (cluster 2-39)</p></li>
<li><p><code>mean.AUC</code>: From the <a href="http://bioconductor.org/books/3.14/OSCA.basic/marker-detection.html#effect-sizes-for-pairwise-comparisons">OSCA book chapter 6.3</a>: “In the context of marker detection, the area under the curve (AUC) quantifies our ability to distinguish between two distributions in a pairwise comparison. The AUC represents the probability that a randomly chosen observation from our cluster of interest is greater than a randomly chosen observation from the other cluster. A value of 1 corresponds to upregulation, where all values of our cluster of interest are greater than any value from the other cluster; a value of 0.5 means that there is no net difference in the location of the distributions; and a value of 0 corresponds to downregulation. The AUC is closely related to the U statistic in the Wilcoxon ranked sum test (a.k.a., Mann-Whitney U-test).” As such, this a very interesting column to use for selecting marker genes.</p></li>
</ul>
<p>Based on the <code>mean.AUC</code> statistic, we may now inspect the top10 markers to distinguish between cells of cluster 1 and cells of the other clusters:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>chosen &lt;-<span class="st"> </span>marker.info[[<span class="st">&quot;1&quot;</span>]]</span>
<span id="cb40-2"><a href="#cb40-2"></a>ordered &lt;-<span class="st"> </span>chosen[<span class="kw">order</span>(chosen<span class="op">$</span>mean.AUC, <span class="dt">decreasing=</span><span class="ot">TRUE</span>),]</span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="kw">head</span>(ordered[,<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,<span class="dv">10</span>)], <span class="dt">n=</span><span class="dv">10</span>) <span class="co"># showing basic stats only, for brevity.</span></span></code></pre></div>
<p>We can also visualize the log-normalized expression of the top10 markers in each cell, stratified on cluster label, using the <code>plotExpression</code> function of the <code>scater</code> package:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="kw">library</span>(scater)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="kw">plotExpression</span>(<span class="dt">bject =</span> ..., <span class="co"># the SCE object, </span></span>
<span id="cb41-3"><a href="#cb41-3"></a>               <span class="dt">features =</span> ..., <span class="co"># top 10 features according to the `scoreMarkers` results</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>               <span class="dt">x =</span> ..., <span class="co"># our cluster labels </span></span>
<span id="cb41-5"><a href="#cb41-5"></a>               <span class="dt">colour_by =</span> ...) <span class="co"># our cluster labels </span></span></code></pre></div>
<p>Based on these results, which markers would you choose to unambiguously distinguish cells from cluster 1 from cells of the other clusters?</p>
<p>Does the name of the 9th marker gene ring any bells?</p>
</div>
<div id="semi-supervised-using-singler" class="section level2">
<h2><span class="header-section-number">6.3</span> Semi-supervised using SingleR</h2>
<p>A conceptually straightforward annotation approach is to compare our current scRNA-seq dataset with a previously annotated reference dataset. Labels can then be assigned to each cell in the Macosko dataset based on the most similar reference cells, for some definition of “similar”. This is a standard classification challenge that can be tackled by standard machine learning techniques such as random forests and support vector machines. Any published and labeled RNA-seq dataset (bulk or single-cell) can be used as a reference, though its reliability depends greatly on the expertise of the original authors who assigned the labels in the first place and the closer the reference dataset is to the dataset we would like to annotate (e.g., full-length vs UMI-based protocol), the more accurate the annotation will typically be.</p>
<p>In this section, we will perform such label transfer between the annotated reference dataset from <a href="https://doi.org/10.1016/j.cell.2016.07.054">Shekhar et al.</a>, which also is a scRNA-seq dataset that studied the mouse retina, and the Macosko dataset.</p>
<p>To perform the actual label transfer, will use the <code>SingleR</code> Bioconductor package. For each “test” cell in the Macosko dataset, <code>singleR</code> will:</p>
<ol style="list-style-type: decimal">
<li><p>Compute Spearman correlation between the test cell and each reference cell. To improve signal/noise, only marker genes identified using the reference dataset are used for this.</p></li>
<li><p>For each label (cell type), set the score as the (default of) 80% quantile of Spearman correlations.</p></li>
<li><p>The prediction is then the label with the highest score.</p></li>
</ol>
<p>Before we can use <code>singleR</code> to perform label transfer, we will need to import, explore (brief) and wrangle the reference dataset by Shekhar <em>et al.</em>.</p>
<div id="import-reference-data" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Import reference data</h3>
<p>The dataset by Shekhar <em>et al.</em> can be conveniently imported using the <code>scRNAseq</code> package.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb42-2"><a href="#cb42-2"></a>(ref.data &lt;-<span class="st"> </span>scRNAseq<span class="op">::</span><span class="kw">ShekharRetinaData</span>(<span class="dt">ensembl =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
</div>
<div id="explore-metadata-of-reference-data" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Explore metadata of reference data</h3>
<p>Inspect the colData for the Shekhar dataset. Compare the CLUSTER and SUBCLUSTER variables!</p>
</div>
<div id="process-reference-data" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Process reference data</h3>
<ol style="list-style-type: decimal">
<li>Remove unlabeled cells</li>
</ol>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">sum</span>(<span class="kw">is.na</span>(ref.data<span class="op">$</span>CLUSTER))</span>
<span id="cb43-2"><a href="#cb43-2"></a>ref.data &lt;-<span class="st"> </span>ref.data[,<span class="op">-</span><span class="kw">which</span>(<span class="kw">is.na</span>(ref.data<span class="op">$</span>CLUSTER))]</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Remove doublets/contaminant cells</li>
</ol>
<p>The original authors already performed quality control; we have cells with cluster label “Doublets/Contaminants”. Let’s remove those:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">sum</span>(ref.data<span class="op">$</span>CLUSTER <span class="op">==</span><span class="st"> </span>...)</span>
<span id="cb44-2"><a href="#cb44-2"></a>ref.data &lt;-<span class="st"> </span>...</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Make lower resolution cell type levels (for easier interpretation)</li>
</ol>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>ref.data<span class="op">$</span>CLUSTER_lowRes &lt;-<span class="st"> </span><span class="kw">fct_recode</span>(ref.data<span class="op">$</span>CLUSTER, </span>
<span id="cb45-2"><a href="#cb45-2"></a>           <span class="st">&quot;Amacrine_cells&quot;</span> =<span class="st"> &quot;AC (Amacrine cell)&quot;</span>,</span>
<span id="cb45-3"><a href="#cb45-3"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC1A&quot;</span>,</span>
<span id="cb45-4"><a href="#cb45-4"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC1B&quot;</span>,</span>
<span id="cb45-5"><a href="#cb45-5"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC2&quot;</span>,</span>
<span id="cb45-6"><a href="#cb45-6"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC3A&quot;</span>,</span>
<span id="cb45-7"><a href="#cb45-7"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC3B&quot;</span>,</span>
<span id="cb45-8"><a href="#cb45-8"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC4&quot;</span>,</span>
<span id="cb45-9"><a href="#cb45-9"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5A (Cone Bipolar cell 5A)&quot;</span>,</span>
<span id="cb45-10"><a href="#cb45-10"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5B&quot;</span>,</span>
<span id="cb45-11"><a href="#cb45-11"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5C&quot;</span>,</span>
<span id="cb45-12"><a href="#cb45-12"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC5D&quot;</span>,</span>
<span id="cb45-13"><a href="#cb45-13"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC6&quot;</span>,</span>
<span id="cb45-14"><a href="#cb45-14"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC7 (Cone Bipolar cell 7)&quot;</span>,</span>
<span id="cb45-15"><a href="#cb45-15"></a>           <span class="st">&quot;Bipolar_cells&quot;</span> =<span class="st"> &quot;BC8/9 (mixture of BC8 and BC9)&quot;</span>,</span>
<span id="cb45-16"><a href="#cb45-16"></a>           <span class="st">&quot;Cones&quot;</span> =<span class="st"> &quot;Cone Photoreceptors&quot;</span>,</span>
<span id="cb45-17"><a href="#cb45-17"></a>           <span class="st">&quot;Muller_glia&quot;</span> =<span class="st"> &quot;MG (Mueller Glia)&quot;</span>,</span>
<span id="cb45-18"><a href="#cb45-18"></a>           <span class="st">&quot;Rod_Bipolar_cell&quot;</span> =<span class="st"> &quot;RBC (Rod Bipolar cell)&quot;</span>,</span>
<span id="cb45-19"><a href="#cb45-19"></a>           <span class="st">&quot;Rod Photoreceptors&quot;</span> =<span class="st"> &quot;Rod Photoreceptors&quot;</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Remove lowly expressed genes</li>
</ol>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>keep &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">assays</span>(ref.data)<span class="op">$</span>counts <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="kw">table</span>(keep)</span>
<span id="cb46-3"><a href="#cb46-3"></a>ref.data &lt;-<span class="st"> </span>ref.data[keep,]</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Obtain same gene ID format as in target data</li>
</ol>
<p>To avoid problems with different version of gene symbols, it is good practice do work with unambiguous gene identifiers like those of ENSEMBL instead.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">rownames</span>(sce_<span class="dv">900</span>) &lt;-<span class="st"> </span><span class="kw">rowData</span>(sce_<span class="dv">900</span>)<span class="op">$</span>ensembl_gene_id <span class="co"># use ENSEMBL identifiers instead</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="kw">sum</span>(<span class="kw">rownames</span>(sce_<span class="dv">900</span>) <span class="op">%in%</span><span class="st"> </span><span class="kw">rownames</span>(ref.data))</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Compute <code>logNormCounts</code></li>
</ol>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="kw">library</span>(scuttle)</span>
<span id="cb48-2"><a href="#cb48-2"></a>ref.data &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(...)</span></code></pre></div>
</div>
<div id="singler-at-low-reference-resolution" class="section level3">
<h3><span class="header-section-number">6.3.4</span> <code>SingleR</code> at low reference resolution</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co">#BiocManager::install(&quot;SingleR&quot;)</span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="kw">library</span>(SingleR)</span>
<span id="cb49-3"><a href="#cb49-3"></a></span>
<span id="cb49-4"><a href="#cb49-4"></a><span class="co"># runs 2min 30sec for me</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>pred.lowRes &lt;-<span class="st"> </span><span class="kw">SingleR</span>(<span class="dt">test =</span> ..., <span class="co"># our dataset</span></span>
<span id="cb49-6"><a href="#cb49-6"></a>                       <span class="dt">ref =</span> ..., <span class="co"># the reference dataset </span></span>
<span id="cb49-7"><a href="#cb49-7"></a>                       <span class="dt">labels =</span> ..., <span class="co"># vector of known labels for all cells in ref</span></span>
<span id="cb49-8"><a href="#cb49-8"></a>                       <span class="dt">de.method =</span> <span class="st">&quot;wilcox&quot;</span>) <span class="co"># most suitable method for sparse (droplet) data</span></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="kw">table</span>(pred.lowRes<span class="op">$</span>labels)</span></code></pre></div>
<p>Using the <code>SingleR</code> classifier that was trained on the reference dataset by Shekhar <em>et al.</em>, we have labeled 2731 cells from the Macosko dataset as amacrine cells, 1528 cells as bipolar cells, and so on. Again note that we predicted a label for each cell in the Macosko dataset based its similarity (in gene expression) with labeled cells from the Shekhar dataset.</p>
<p><strong>Most importantly,</strong> we want to compare our predicted cell labels with the labels that were obtained by Macokso <em>et al.</em>, which we <em>could</em> consider to be ground truth labels if we assume that the authors succeeded in their large effort of annotating their cell clusters for their publication.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>tab &lt;-<span class="st"> </span><span class="kw">table</span>(..., ...) <span class="co"># the original low-resolution labels versus our predicted low-resolution labels</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>tab</span></code></pre></div>
<p>Inspect the results.</p>
<p>Before we dive deeper into this, we may visualize our result using a heatmap:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(tab <span class="op">/</span><span class="st"> </span><span class="kw">rowSums</span>(tab))</span></code></pre></div>
<p>Inspect the results.</p>
<p>One other visualization strategy is implemented in the <code>plotScoreHeatmap</code> of the <code>SingleR</code> package. Remember, the <code>SingleR</code> classifier assigns each target cell to a cell type label <strong>with a certain probability</strong>. The <code>plotScoreHeatmap</code> function then allows you to plot, for each cell (columns) the assignment score (which can be thought of as a probability) of that cell belonging to each of the reference label categories (rows).</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>gg &lt;-<span class="st"> </span><span class="kw">plotScoreHeatmap</span>(pred.lowRes[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>,])</span>
<span id="cb52-2"><a href="#cb52-2"></a>gg</span></code></pre></div>
<p>Inspect the results.</p>
<p>Finally, we can use these assignment score to filter out cells that could not be unambiguously assigned to one cell type, i.e., only report those cells that we were able to reliably assign:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">summary</span>(<span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels))</span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="kw">range</span>(<span class="kw">rowMaxs</span>(pred.lowRes<span class="op">$</span>scores)) <span class="co"># all assignments</span></span>
<span id="cb53-4"><a href="#cb53-4"></a><span class="kw">range</span>(<span class="kw">rowMaxs</span>(pred.lowRes<span class="op">$</span>scores[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels),])) <span class="co"># reliable assignments</span></span>
<span id="cb53-5"><a href="#cb53-5"></a></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="kw">table</span>(sce_<span class="dv">900</span><span class="op">$</span>cluster_lowRes[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels)], </span>
<span id="cb53-7"><a href="#cb53-7"></a>      pred.lowRes<span class="op">$</span>labels[<span class="op">!</span><span class="kw">is.na</span>(pred.lowRes<span class="op">$</span>pruned.labels)])</span></code></pre></div>
<p>We will interpret the concordance between the predicted and the original labels on this subset. We observe a strong correspondence between the predicted labels and the labels from Macokso <em>et al.</em> We can read this table as follows:</p>
<ul>
<li>Almost all amacrine cells of the Macosko dataset are correctly predicted as amacrine cells (2036/(2036+7+1+41+1) ±= 98% correctly assigned).</li>
</ul>
<p>Try to interpret the results for the other cell types.</p>
<p>We can now also visualize the predicted labels and the original labels on our t-SNE.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>sce_<span class="dv">900</span><span class="op">$</span>SingleR_lowRes &lt;-<span class="st"> </span>pred.lowRes<span class="op">$</span>labels</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a><span class="co"># our low resolution labels based on reference</span></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="kw">plotTSNE</span>(...,</span>
<span id="cb54-5"><a href="#cb54-5"></a>         <span class="dt">colour_by =</span> ...,</span>
<span id="cb54-6"><a href="#cb54-6"></a>         <span class="dt">text_by =</span> ...,</span>
<span id="cb54-7"><a href="#cb54-7"></a>         <span class="dt">text_size =</span> ...)</span>
<span id="cb54-8"><a href="#cb54-8"></a></span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="co"># low resolution labels of the authors</span></span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="kw">plotTSNE</span>(...,</span>
<span id="cb54-11"><a href="#cb54-11"></a>         <span class="dt">colour_by =</span> ...,</span>
<span id="cb54-12"><a href="#cb54-12"></a>         <span class="dt">text_by =</span> ...,</span>
<span id="cb54-13"><a href="#cb54-13"></a>         <span class="dt">text_size =</span> ...)</span></code></pre></div>
<p>Interpret the visualizations.</p>
<p><strong>Altogether, label-transfer was quite successful, and we would have been able</strong> <strong>to very quickly get high-quality results using this very user-friendly and</strong> <strong>fast approach implemented in the <code>SingleR</code> package.</strong></p>
</div>
<div id="addendum-singler-at-high-reference-resolution" class="section level3">
<h3><span class="header-section-number">6.3.5</span> Addendum: <code>SingleR</code> at high reference resolution</h3>
<p>For the sake of completeness, we may also perform label transfer with <code>SingleR</code> using the more fine-grained labels from the reference dataset.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>...</span></code></pre></div>
</div>
</div>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAnTGFiMzogQ2x1c3RlcmluZywgbWFya2VyIGdlbmUgZGV0ZWN0aW9uIGFuZCBjZWxsIHR5cGUgYW5ub3RhdGlvbicKYXV0aG9yOiAiS29lbiBWYW4gZGVuIEJlcmdlIGFuZCBKZXJvZW4gR2lsaXMiCmRhdGU6ICI2LzEyLzIwMjEiCm91dHB1dDogCiAgaHRtbF9kb2N1bWVudDoKICAgIGRvd25sb2FkOiB0cnVlCiAgICB0b2M6IHRydWUKICAgIHRvY19mbG9hdDogdHJ1ZQotLS0KCiMgUHJlYW1ibGU6IGluc3RhbGxhdGlvbiBvZiBCaW9jb25kdWN0b3IgbGlicmFyaWVzCgpgYGB7cixldmFsPUZBTFNFfQojIGluc3RhbGwgQmlvY01hbmFnZXIgcGFja2FnZSBpZiBub3QgaW5zdGFsbGVkIHlldC4KIyBCaW9jTWFuYWdlciBpcyB0aGUgcGFja2FnZSBpbnN0YWxsZXIgZm9yIEJpb2NvbmR1Y3RvciBzb2Z0d2FyZS4KaWYgKCFyZXF1aXJlTmFtZXNwYWNlKCJCaW9jTWFuYWdlciIsIHF1aWV0bHkgPSBUUlVFKSkKICAgIGluc3RhbGwucGFja2FnZXMoIkJpb2NNYW5hZ2VyIikKCiMgaW5zdGFsbCBwYWNrYWdlcyBpZiBub3QgeWV0IGluc3RhbGxlZC4KcGtncyA8LSBjKCJTaW5nbGVDZWxsRXhwZXJpbWVudCIsCiAgICAgICAgICAiRXhwZXJpbWVudEh1YiIsCiAgICAgICAgICAiZWRnZVIiLAogICAgICAgICAgIkRyb3BsZXRVdGlscyIsIAogICAgICAgICAgInNjUk5Bc2VxIiwgCiAgICAgICAgICAic2NhdGVyIiwgCiAgICAgICAgICAic2N1dHRsZSIsIAogICAgICAgICAgInNjcmFuIiwgCiAgICAgICAgICAiQmlvY1Npbmd1bGFyIiwgCiAgICAgICAgICAic2NEYmxGaW5kZXIiKQpub3RJbnN0YWxsZWQgPC0gcGtnc1shcGtncyAlaW4lIGluc3RhbGxlZC5wYWNrYWdlcygpWywxXV0KaWYobGVuZ3RoKG5vdEluc3RhbGxlZCkgPiAwKXsKICBCaW9jTWFuYWdlcjo6aW5zdGFsbChub3RJbnN0YWxsZWQpCn0KYGBgCgpTdGVwcyB0YWtlbgoKMS4gSW1wb3J0IHRoZSBNYWNvc2tvIGRhdGFzZXQgYXMgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QgZnJvbSB0aGUgCmBzY1JOQXNlcWAgQmlvY29uZHVjdG9yIHBhY2thZ2UuCgoyLiBJbmNsdWRlIEVOU0VNQkwgZ2VuZSBpZGVudGlmaWVycyBpbiB0aGUgYHJvd0RhdGFgCgozLiBSZW1vdmUgdmVyeSBsb3dseSBleHByZXNzZWQgZ2VuZXMKCjQuIFJlbW92ZSBsb3cgcXVhbGl0eSBjZWxscyAKICA0LjEuIENlbGxzIHdpdGggb3V0bHlpbmcgbGlicmFyeSBzaXplIAogIDQuMi4gQ2VsbHMgd2l0aCBvdXRseWluZyB0cmFuc2NyaXB0b21lIGNvbXBsZXhpdHkgCiAgNC4zLiBDZWxscyB3aXRoIG91dGx5aW5nIHBlcmNlbnRhZ2Ugb2YgbWl0b2Nob25kcmlhbCByZWFkcyAKICA0LjQuIEVtcHR5IGRyb3BsZXRzIAogIDQuNS4gRG91YmxldHMKCjUuIE5vcm1hbGl6YXRpb24gCiAgNS4xLiBDb21wdXRlIGxvZy1ub3JtYWxpemVkIGNvdW50cyAKICA1LjIuIENvbXB1dGUgc2NhbGluZyBmYWN0b3IgdG8gY29ycmVjdCBmb3IgZGlmZmVyZW5jZXMgaW4gbGlicmFyeSBzaXplCgo2LiBGZWF0dXJlIHNlbGVjdGlvbiAKICA2LjEuIEdlbmVzIHdpdGggaGlnaCB2YXJpYW5jZSAKICA2LjIuIEdlbmVzIHdpdGggaGlnaCB2YXJpYW5jZSB3aXRoIHJlc3BlY3QgdG8gdGhlaXIgbWVhbiBleHByZXNzaW9uIAogIDYuMy4gR2VuZXMgd2l0aCBoaWdoIGRldmlhbmNlIAogIDYuNC4gR2VuZXMgd2l0aCBoaWdoIHZhcmlhbmNlIGFmdGVyIHZhcmlhbmNlLXN0YWJpbGl6aW5nIHRyYW5zZm9ybWF0aW9uIChWU1QpCgo3LiBEaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gCiAgNy4xLiBCYXNlZCBvbiB0d28gbW9zdCB2YXJpYWJsZSBnZW5lcyBmcm9tIHN0ZXAgNi4yLiAKICA3LjIuIFBDQSAKICA3LjMuIEdMTS1QQ0EgCiAgNy40LiBULVNORSAKICA3LjUuIFVNQVAKCiMgTG9hZCBlbmQtcmVzdWx0IGFmdGVyIGxhYiBzZXNzaW9uIDIKCmBgYHtyLGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoU2luZ2xlQ2VsbEV4cGVyaW1lbnQpCmxpYnJhcnkoc2NhdGVyKQpsaWJyYXJ5KHNjcmFuKQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CnNjZSA8LSByZWFkUkRTKCIvVXNlcnMvamcvRGVza3RvcC9zY2VfYWZ0ZXJfbGFic2Vzc2lvbjIucmRzIikgICMgc3BlY2lmeSBZT1VSIHBhdGghCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KaGVhZChjb2xEYXRhKHNjZSkpCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KcmVkdWNlZERpbU5hbWVzKHNjZSkKYGBgCgojIEFkZCBjbHVzdGVyIGluZm9ybWF0aW9uIGZyb20gcHVibGljYXRpb24KCmBgYHtyLGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CiMgaW5zdGFsbC5wYWNrYWdlcygidGlkeXZlcnNlIikgIyBpZiBub3QgeWV0IGluc3RhbGxlZApsaWJyYXJ5KHRpZHl2ZXJzZSkKc2NlJGNsdXN0ZXJfbG93UmVzIDwtIGZjdF9yZWNvZGUoY29sRGF0YShzY2UpJGNsdXN0ZXIsIAogICAgICAgICAgICJIb3Jpem9udGFsX2NlbGxzIiA9ICIxIiwKICAgICAgICAgICAiR2FuZ2xpb25fY2VsbHMiID0gIjIiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiMyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICI0IiwKICAgICAgICAgICAiQW1hY3JpbmUiID0gIjUiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiNiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICI3IiwKICAgICAgICAgICAiQW1hY3JpbmUiID0gIjgiLAogICAgICAgICAgICJBbWFjcmluZSIgPSAiOSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxMyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxNyIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxOCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIxOSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMCIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMSIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMiIsCiAgICAgICAgICAgIkFtYWNyaW5lIiA9ICIyMyIsCiAgICAgICAgICAgIlJvZHMiID0gIjI0IiwKICAgICAgICAgICAiQ29uZXMiID0gIjI1IiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMjYiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIyNyIsCiAgICAgICAgICAgIkJpcG9sYXIiID0gIjI4IiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMjkiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIzMCIsCiAgICAgICAgICAgIkJpcG9sYXIiID0gIjMxIiwKICAgICAgICAgICAiQmlwb2xhciIgPSAiMzIiLAogICAgICAgICAgICJCaXBvbGFyIiA9ICIzMyIsCiAgICAgICAgICAgIk11bGxlcl9nbGlhIiA9ICIzNCIsCiAgICAgICAgICAgIkFzdHJvY3l0ZXMiID0gIjM1IiwKICAgICAgICAgICAiRmlicm9ibGFzdCIgPSAiMzYiLAogICAgICAgICAgICJWYXNjdWxhcl9lbmRvdGhlbGl1bSIgPSAiMzciLAogICAgICAgICAgICJQZXJpY3l0ZXMiID0gIjM4IiwKICAgICAgICAgICAiTWljcm9nbGlhIiA9ICIzOSIpCgpzY2UkY2x1c3Rlcl9oaWdoUmVzIDwtIGZjdF9yZWNvZGUoY29sRGF0YShzY2UpJGNsdXN0ZXIsIAogICAgICAgICAgICJIb3Jpem9udGFsX2NlbGxzIiA9ICIxIiwKICAgICAgICAgICAiR2FuZ2xpb25fY2VsbHMiID0gIjIiLAogICAgICAgICAgICJBbWFjcmluZV8xIiA9ICIzIiwKICAgICAgICAgICAiQW1hY3JpbmVfMiIgPSAiNCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzMiID0gIjUiLAogICAgICAgICAgICJBbWFjcmluZV80IiA9ICI2IiwKICAgICAgICAgICAiQW1hY3JpbmVfNSIgPSAiNyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzYiID0gIjgiLAogICAgICAgICAgICJBbWFjcmluZV83IiA9ICI5IiwKICAgICAgICAgICAiQW1hY3JpbmVfOCIgPSAiMTAiLAogICAgICAgICAgICJBbWFjcmluZV85IiA9ICIxMSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEwIiA9ICIxMiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzExIiA9ICIxMyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEyIiA9ICIxNCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzEzIiA9ICIxNSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE0IiA9ICIxNiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE1IiA9ICIxNyIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE2IiA9ICIxOCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE3IiA9ICIxOSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE4IiA9ICIyMCIsCiAgICAgICAgICAgIkFtYWNyaW5lXzE5IiA9ICIyMSIsCiAgICAgICAgICAgIkFtYWNyaW5lXzIwIiA9ICIyMiIsCiAgICAgICAgICAgIkFtYWNyaW5lXzIxIiA9ICIyMyIsCiAgICAgICAgICAgIlJvZHMiID0gIjI0IiwKICAgICAgICAgICAiQ29uZXMiID0gIjI1IiwKICAgICAgICAgICAiQmlwb2xhcl8xIiA9ICIyNiIsCiAgICAgICAgICAgIkJpcG9sYXJfMiIgPSAiMjciLAogICAgICAgICAgICJCaXBvbGFyXzMiID0gIjI4IiwKICAgICAgICAgICAiQmlwb2xhcl80IiA9ICIyOSIsCiAgICAgICAgICAgIkJpcG9sYXJfNSIgPSAiMzAiLAogICAgICAgICAgICJCaXBvbGFyXzYiID0gIjMxIiwKICAgICAgICAgICAiQmlwb2xhcl83IiA9ICIzMiIsCiAgICAgICAgICAgIkJpcG9sYXJfOCIgPSAiMzMiLAogICAgICAgICAgICJNdWxsZXJfZ2xpYSIgPSAiMzQiLAogICAgICAgICAgICJBc3Ryb2N5dGVzIiA9ICIzNSIsCiAgICAgICAgICAgIkZpYnJvYmxhc3QiID0gIjM2IiwKICAgICAgICAgICAiVmFzY3VsYXJfZW5kb3RoZWxpdW0iID0gIjM3IiwKICAgICAgICAgICAiUGVyaWN5dGVzIiA9ICIzOCIsCiAgICAgICAgICAgIk1pY3JvZ2xpYSIgPSAiMzkiKQpgYGAKCiMgQ2x1c3RlcmluZwoKIyMgR3JhcGgtYmFzZWQgY2x1c3RlcmluZwoKRmlyc3QsIHdlIGRpc2N1c3MgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBtZXRob2RzIGZvciBzY1JOQS1TZXEgZGF0YS4KVGhpcyBpcyB2ZXJ5IHdlbGwgZXhwbGFpbmVkIGluIHRoZSAKW09TQ0EgYm9vayBjaGFwdGVyIDUuMl0oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNC9PU0NBLmJhc2ljL2NsdXN0ZXJpbmcuaHRtbCNjbHVzdGVyaW5nLWdyYXBoKS4KCkFzIHdyaXR0ZW4gaW4gdGhlIE9TQ0EgYm9vazogIlBvcHVsYXJpemVkIGJ5IGl0cyB1c2UgaW4gU2V1cmF0LCBncmFwaC1iYXNlZCAKY2x1c3RlcmluZyBpcyBhIGZsZXhpYmxlIGFuZCBzY2FsYWJsZSB0ZWNobmlxdWUgZm9yIGNsdXN0ZXJpbmcgbGFyZ2Ugc2NSTkEtc2VxIApkYXRhc2V0cy4gV2UgZmlyc3QgYnVpbGQgYSBncmFwaCB3aGVyZSBlYWNoIG5vZGUgaXMgYSBjZWxsIHRoYXQgaXMgY29ubmVjdGVkIAp0byBpdHMgbmVhcmVzdCBuZWlnaGJvcnMgaW4gdGhlIGhpZ2gtZGltZW5zaW9uYWwgc3BhY2UuIEVkZ2VzIGFyZSB3ZWlnaHRlZCAKYmFzZWQgb24gdGhlIHNpbWlsYXJpdHkgYmV0d2VlbiB0aGUgY2VsbHMgaW52b2x2ZWQsIHdpdGggaGlnaGVyIHdlaWdodCBnaXZlbiAKdG8gY2VsbHMgdGhhdCBhcmUgbW9yZSBjbG9zZWx5IHJlbGF0ZWQuIFdlIHRoZW4gYXBwbHkgYWxnb3JpdGhtcyB0byBpZGVudGlmeSAK4oCcY29tbXVuaXRpZXPigJ0gb2YgY2VsbHMgdGhhdCBhcmUgbW9yZSBjb25uZWN0ZWQgdG8gY2VsbHMgaW4gdGhlIHNhbWUgY29tbXVuaXR5IAp0aGFuIHRoZXkgYXJlIHRvIGNlbGxzIG9mIGRpZmZlcmVudCBjb21tdW5pdGllcy4gRWFjaCBjb21tdW5pdHkgcmVwcmVzZW50cyBhIApjbHVzdGVyIHRoYXQgd2UgY2FuIHVzZSBmb3IgZG93bnN0cmVhbSBpbnRlcnByZXRhdGlvbi4KClRoZSBtYWpvciBhZHZhbnRhZ2Ugb2YgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBsaWVzIGluIGl0cyBzY2FsYWJpbGl0eS4gSXQgb25seSAKcmVxdWlyZXMgYSBrLW5lYXJlc3QgbmVpZ2hib3Igc2VhcmNoIHRoYXQgY2FuIGJlIGRvbmUgaW4gbG9nLWxpbmVhciB0aW1lIG9uIAphdmVyYWdlLCBpbiBjb250cmFzdCB0byBoaWVyYXJjaGljYWwgY2x1c3RlcmluZyBtZXRob2RzIHdpdGggcnVudGltZXMgdGhhdCBhcmUgCnF1YWRyYXRpYyB3aXRoIHJlc3BlY3QgdG8gdGhlIG51bWJlciBvZiBjZWxscy4gR3JhcGggY29uc3RydWN0aW9uIGF2b2lkcyBtYWtpbmcgCnN0cm9uZyBhc3N1bXB0aW9ucyBhYm91dCB0aGUgc2hhcGUgb2YgdGhlIGNsdXN0ZXJzIG9yIHRoZSBkaXN0cmlidXRpb24gb2YgY2VsbHMgCndpdGhpbiBlYWNoIGNsdXN0ZXIsIGNvbXBhcmVkIHRvIG90aGVyIG1ldGhvZHMgbGlrZSBrLW1lYW5zICh0aGF0IGZhdm9yIApzcGhlcmljYWwgY2x1c3RlcnMpIG9yIEdhdXNzaWFuIG1peHR1cmUgbW9kZWxzICh0aGF0IHJlcXVpcmUgbm9ybWFsaXR5KS4iCgpTZXZlcmFsIGdyYXBoLWJhc2VkIGNsdXN0ZXJpbmcgYWxnb3JpdGhtcyBhcmUgaW1wbGVtZW50ZWQgaW4gdGhlIGBzY3JhbmAgbGlicmFyeS4gClRoZSBtb3N0IGdsb2JhbCB3cmFwcGVyLWZ1bmN0aW9uIGluIHRoaXMgcGFja2FnZSBpcyB0aGUgYGNsdXN0ZXJDZWxsc2AgZnVuY3Rpb24uIApUeXBpY2FsbHksIHRoZSBpbnB1dCB0byB0aGlzIGZ1bmN0aW9uIGlzIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3Qgd2l0aCAKcHJlLWNvbXB1dGVkIHByaW5jaXBhbCBjb21wb25lbnRzOyB0aGVzZSBhcmUgdXNlZCB0byB0YWtlIGFkdmFudGFnZSBvZiBkYXRhIApjb21wcmVzc2lvbiBhbmQgZGVub2lzaW5nLiBJZiB0aGUgZGVmYXVsdCBzZXR0aW5ncyBhcmUgYWRvcHRlZCwgYGNsdXN0ZXJDZWxsc2AKd2lsbCBwZXJmb3JtIHR3byBzdGVwcyB1bmRlciB0aGUgaG9vZDoKCjEuIEJ1aWxkIGEgc2hhcmVkIG5lYXJlc3QgbmVpZ2hib3JzIChTTk4pIGdyYXBoIG9mIG9ic2VydmF0aW9ucyBmb3IgZG93bnN0cmVhbSBjb21tdW5pdHkgCmRldGVjdGlvbi4gVGhlIFNOTiBncmFwaCBpcyBjbG9zZWx5IHJlbGF0ZWQgdG8gdGhlIG1vcmUgY29tbW9uIEtOTiBncmFwaC4gRm9yIAplYWNoIG9ic2VydmF0aW9uLCBpdHMgay1uZWFyZXN0IG5laWdoYm9ycyBhcmUgaWRlbnRpZmllZCAoaz0xMCBieSBkZWZhdWx0KSwgCmJhc2VkIG9uIGRpc3RhbmNlcyBiZXR3ZWVuIHRoZWlyIGV4cHJlc3Npb24gcHJvZmlsZXMgKEV1Y2xpZGVhbiBkaXN0YW5jZXMgYXJlIAp1c2VkIGJ5IGRlZmF1bHQpIGFzIG9ic2VydmVkIGluIFBDQSBzcGFjZS4gQW4gZWRnZSBpcyBkcmF3biBiZXR3ZWVuIGFsbCBwYWlycyAKb2Ygb2JzZXJ2YXRpb25zIHRoYXQgc2hhcmUgYXQgbGVhc3Qgb25lIG5laWdoYm9yLCB3ZWlnaHRlZCBieSB0aGUgY2hhcmFjdGVyaXN0aWNzIApvZiB0aGUgc2hhcmVkIG5lYXJlc3QgbmVpZ2hib3JzLgoKMi4gVGhlIGBjbHVzdGVyQ2VsbHNgIGZ1bmN0aW9uIG5leHQgaW50ZXJuYWxseSBjYWxscyB0aGUgYGNsdXN0ZXJfd2Fsa3RyYXBgIGZ1bmN0aW9uIApmcm9tIHRoZSBgaWdyYXBoYCBsaWJyYXJ5LiBCYXNlZCBvbiB0aGUgU05OIGdyYXBoIGZyb20gc3RlcCAxLCB0aGlzIGZ1bmN0aW9uIHRyaWVzCnRvIGZpbmQgZGVuc2VseSBjb25uZWN0ZWQgc3ViZ3JhcGhzLCBhbHNvIGNhbGxlZCBjb21tdW5pdGllcyBpbiBhIGdyYXBoIHZpYSAKcmFuZG9tIHdhbGtzLiBUaGUgaWRlYSBpcyB0aGF0IHNob3J0IHJhbmRvbSB3YWxrcyB0ZW5kIHRvIHN0YXkgaW4gdGhlIHNhbWUgCmNvbW11bml0eS4KCmBgYAojIERvIG5vdCBydW47IGNsdXN0ZXJDZWxscyBmdW5jdGlvbiB3aXRoIGRlZmF1bHQgc2V0dGluZ3MsIGkuZS4sIGJ1aWxkaW5nIGFuCiMgU05OIGdyYXBoIGFuZCBmaW5kaW5nIGNsdXN0ZXJzIHdpdGggdGhlIHdhbGt0cmFwIGFsZ29yaXRobS4KbGlicmFyeShzY3JhbikKbm4uY2x1c3RlcnMgPC0gY2x1c3RlckNlbGxzKHNjZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2UuZGltcmVkPSJQQ0EiKQp0YWJsZShubi5jbHVzdGVycykKYGBgCgpUaGUgZGlzYWR2YW50YWdlIG9mIHVzaW5nIGBjbHVzdGVyQ2VsbHNgIGlzIHRoYXQgdGhlIGRlZmF1bHQgc2V0dGluZyBvZiB0aGUgCnNlY29uZCBzdGVwLCB0aGUgYGNsdXN0ZXJfd2Fsa3RyYXBgIGZ1bmN0aW9uLCBpcyBzbG93IGZvciBsYXJnZSBkYXRhc2V0cy4gV2hpbGUgCml0IGlzIHBvc3NpYmxlIHRvIGFkanVzdCB0aGUgZGlmZmVyZW50IGFyZ3VtZW50cyBvZiB0aGUgYGNsdXN0ZXJDZWxsc2AgZnVuY3Rpb24sCml0IG1pZ2h0IGJlIG1vcmUgY2xlYXIgYW5kIGludHVpdGl2ZSB0byBzaW1wbHkgYnJlYWsgdXAgdGhlIHByb2Nlc3MgaW4gdHdvIHN0ZXBzOgpidWlsZGluZyB0aGUgZ3JhcGggYW5kIGRldGVjdGluZyBjbHVzdGVycyBpbiB0aGF0IGdyYXBoLiBGb3IgdGhpcyBzZWNvbmQgc3RlcCwgCndlIG1heSB0aGVuIGFkb3B0IGEgZmFzdGVyIGFsZ29yaXRobS4KCiMjIyBCdWlsZCBncmFwaCAoU05OIGdyYXBoKQoKYGBge3IsZXZhbD1GQUxTRX0KIyBCdWlsZCBhIHNoYXJlZCBuZWFyZXN0LW5laWdoYm9yIGdyYXBoIGZyb20gUENBIHNwYWNlCmdyYXBoIDwtIGJ1aWxkU05OR3JhcGgoeCA9IC4uLiwgIyBvdXIgU0NFIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgIHVzZS5kaW1yZWQgPSAuLi4pICMgCUEgc3RyaW5nIHNwZWNpZnlpbmcgd2hpY2ggZXhpc3RpbmcgdmFsdWVzIGluIHJlZHVjZWREaW1zKHgpIHNob3VsZCBiZSB1c2VkLgojIGFsdGVybmF0aXZlOiBidWlsZEtOTkdyYXBoKCkKYGBgCgojIyMgRGV0ZWN0IGNsdXN0ZXJzIG9uIHRoZSBncmFwaAoKVHdvIHBvcHVsYXIgZ3JhcGgtYmFzZWQgY2x1c3RlcmluZyBhbGdvcml0aG0gYXJlIHRoZSBgbGVpZGVuYCBhbmQgYGxvdXZhaW5gIAphbGdvcml0aG1zLCBib3RoIHJlZmVycmluZyB0byB0aGUgbG9jYXRpb24gb2YgaXRzIGRldmVsb3BlcnMuIEEgY29tbW9uIAppbXBsZW1lbnRhdGlvbiBvZiB0aGUgCltgbG91dmFpbmBhbGdvcml0aG1dKGh0dHBzOi8vaW9wc2NpZW5jZS5pb3Aub3JnL2FydGljbGUvMTAuMTA4OC8xNzQyLTU0NjgvMjAwOC8xMC9QMTAwMDgpIAppcyB0byBvcHRpbWl6ZSB0aGUgbW9kdWxhcml0eSwgZWZmZWN0aXZlbHkgYXR0ZW1wdGluZyB0byBtYXhpbWl6ZSB0aGUgZGlmZmVyZW5jZSAKYmV0d2VlbiB0aGUgb2JzZXJ2ZWQgbnVtYmVyIG9mIGVkZ2VzIGluIGEgY29tbXVuaXR5IGFuZCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIApzdWNoIGVkZ2VzLgoKSG93ZXZlciwgYWRkaXRpb25hbCBldmFsdWF0aW9ucyBmb3VuZCB0aGF0IG1vZHVsYXJpdHkgb3B0aW1pemF0aW9uIHVzaW5nIHRoZSAKYGxvdXZhaW5gIGFsZ29yaXRobSBpcyBjb25maW5lZCB0byBhIApbcmVzb2x1dGlvbiBsaW1pdF0oaHR0cHM6Ly93d3cucG5hcy5vcmcvY29udGVudC8xMDQvMS8zNiksIGFuZCBpbiBhZGRpdGlvbiBtYXkgCnJlc3VsdCBpbiBjb21tdW5pdGllcyB0aGF0IGFyZSBub3Qgd2VsbCBjb25uZWN0ZWQuIApUaGUgW2BsZWlkZW5gIGFsZ29yaXRobV0oaHR0cHM6Ly93d3cubmF0dXJlLmNvbS9hcnRpY2xlcy9zNDE1OTgtMDE5LTQxNjk1LXopLCAKaW5zdGVhZCwgZ3VhcmFudGVlcyB3ZWxsLWNvbm5lY3RlZCBjb21tdW5pdGllcy4KCmBgYHtyLGV2YWw9RkFMU0V9CnNldC5zZWVkKDQ2NDY4OCkKIyBXYWxrdHJhcCBjb21tdW5pdHkgZmluZGluZyBhbGdvcml0aG0gb24gdGhlIFNOTiBncmFwaAojIERPIE5PVCBSVU4gLT4gdGFrZXMgMjAgbWludXRlcwojIGNsdXN0ZXJfd2Fsa3RyYXAgPC0gZmFjdG9yKGlncmFwaDo6Y2x1c3Rlcl93YWxrdHJhcChnKSRtZW1iZXJzaGlwKSAjMjBtaW4KCiMgVGhlIGBjbHVzdGVyX2Zhc3RfZ3JlZWR5YCBmdW5jdGlvbiB0cmllcyB0byBmaW5kIGRlbnNlIHN1YmdyYXBoLCBhbHNvIGNhbGxlZCAKIyBjb21tdW5pdGllcyBpbiBncmFwaHMgdmlhIGRpcmVjdGx5IG9wdGltaXppbmcgYSBtb2R1bGFyaXR5IHNjb3JlCiMgRE8gTk9UIFJVTiAtPiB0YWtlcyA0IG1pbnV0ZXMKIyBjbHVzdGVyX2Zhc3RHcmVlZHkgPC0gZmFjdG9yKGlncmFwaDo6Y2x1c3Rlcl9mYXN0X2dyZWVkeShncmFwaCkkbWVtYmVyc2hpcCkgIzRtaW4KCiMgTG91dmFpbiBjbHVzdGVyaW5nIG9uIHRoZSBTTk4gZ3JhcGgKY2x1c3Rlcl9sb3V2YWluIDwtIGZhY3RvcihpZ3JhcGg6OmNsdXN0ZXJfbG91dmFpbihncmFwaCkkbWVtYmVyc2hpcCkgIzhzZWMKbmxldmVscyhjbHVzdGVyX2xvdXZhaW4pICMgMTEgY2x1c3RlcnMKCiMgTGVpZGVuIGNsdXN0ZXJpbmcgb24gdGhlIFNOTiBncmFwaApjbHVzdGVyX2xlaWRlbiA8LSAuLi4gIzEwc2VjCm5sZXZlbHMoY2x1c3Rlcl9sZWlkZW4pICMgMTMyNiBkaWZmZXJlbnQgY2x1c3RlcnMhCgojIG9idGFpbiBhIGxlc3Mgb3Zlcmx5IGZpbmUtZ3JhaW5lZCBjbHVzdGVyaW5nCmNsdXN0ZXJfbGVpZGVuMiA8LSBmYWN0b3IoLi4uKGdyYXBoID0gLi4uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHV0aW9uX3BhcmFtZXRlciA9IDAuMDEpJG1lbWJlcnNoaXApICMxMHNlYwpubGV2ZWxzKGNsdXN0ZXJfbGVpZGVuMikgIzE0IGRpZmZlcmVudCBjbHVzdGVycwoKIyBhZGQgY2x1c3RlcmluZ3MgdG8gY29sRGF0YQpjb2xEYXRhKHNjZSkkY2x1c3Rlcl9sb3V2YWluIDwtIC4uLgpjb2xEYXRhKHNjZSkkY2x1c3Rlcl9sZWlkZW4yIDwtIC4uLgpgYGAKCiMjIyBDb21wYXJpbmcgY2x1c3RlcmluZyBzdHJhdGVnaWVzCgpBIGRpcmVjdCBjb21wYXJpc29uIG9mIHRoZSBMb3V2YWluIGFuZCBMZWlkZW4gY2x1c3RlcmluZyByZXN1bHRzIHVzaW5nIGEgdGFibGUgCm9mIHRoZSBjbHVzdGVyIGxhYmVscywgc2hvd3MgZ29vZCBhZ3JlZW1lbnQuCgpgYGB7cixldmFsPUZBTFNFfQp0YWJsZSguLi4sIC4uLikgIyBjb21wYXJlIExvdXZhaW4gYW5kIExlaWRlbjIgY2x1c3RlcmluZwpgYGAKICAgICAgICAgICAgIApJbnRlcnByZXQgdGhlIHJlc3VsdCBvZiB0aGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSB0d28gY2x1c3RlcmluZyBzdHJhdGVnaWVzLgpJcyB0aGVyZSBhIHN0cm9uZyBjb3JyZXNwb25kZW5jZSBiZXR3ZWVuIHRoZSBzdHJhdGVnaWVzPwoKVG8gbWFrZSBhIHZpc3VhbGl6YXRpb24gdGhhdCBnaXZlcyB1cyB2ZXJ5IHNpbWlsYXIgaW5mb3JtYXRpb24sIHdlIG1heSB1c2UgYSAKaGVhdG1hcDoKCmBgYHtyLGV2YWw9RkFMU0UsbWVzc2FnZT1GQUxTRSx3YXJuaW5nPUZBTFNFfQojaW5zdGFsbC5wYWNrYWdlcygicGhlYXRtYXAiKSAjIGlmIG5vdCB5ZXQgaW5zdGFsbGVkCmxpYnJhcnkocGhlYXRtYXApCnBoZWF0bWFwOjpwaGVhdG1hcCh0YWJsZSguLi4sIC4uLikpICMgaGVhdG1hcCB0byB2aXN1YWxpemUgdGhlIHRhYnVsYXIgY29tcGFyaXNvbiBvZiBhYm92ZSAKYGBgCgpBZ2FpbiwgaW50ZXJwcmV0IHRoZSByZXN1bHQgb2YgdGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUgdHdvIGNsdXN0ZXJpbmcgCnN0cmF0ZWdpZXMuCgpBbHRlcm5hdGl2ZWx5LCB3ZSBtYXkgY29tcHV0ZSBhIGNsdXN0ZXJpbmcgc2ltaWxhcml0eSBzY29yZSB0aGF0IGNhcHR1cmVzIHRoZSAKYWdyZWVtZW50IGJldHdlZW4gdHdvIHNldHMgb2YgcGFydGl0aW9ucy4gVGhlIEFkanVzdGVkIFJhbmQgSW5kZXggKEFSSSkgaXMgb2Z0ZW4KdXNlZCBpbiB0aGUgbGl0ZXJhdHVyZSBmb3IgdGhpcyBwdXJwb3NlLiBUaGUgQVJJIGlzIGVxdWFsIHRvIDEgaWYgdGhlIHR3byAKcGFydGl0aW9ucyBhZ3JlZSBwZXJmZWN0bHksIGFuZCBpdCBpcyB6ZXJvIGlmIHRoZSB0d28gcGFydGl0aW9ucyBhcmUgdW5yZWxhdGVkLiAKSW4gc29tZSBjYXNlcywgdGhlIEFSSSBtYXkgYWxzbyBiZSBuZWdhdGl2ZSBpZiB0aGUgcGFydGl0aW9ucyBhcmUgbXVjaCBtb3JlIApkaWZmZXJlbnQgdGhhbiB3aGF0IGNvdWxkIGJlIGV4cGVjdGVkIGJ5IGNoYW5jZS4KCmBgYHtyLGV2YWw9RkFMU0UsbWVzc2FnZT1GQUxTRSx3YXJuaW5nPUZBTFNFfQojaW5zdGFsbC5wYWNrYWdlcygibWNsdXN0IikgIyBpZiBub3QgeWV0IGluc3RhbGxlZApsaWJyYXJ5KG1jbHVzdCkKbWNsdXN0OjphZGp1c3RlZFJhbmRJbmRleCguLi4sICMgTG91dmFpbiAKICAgICAgICAgICAgICAgICAgICAgICAgICAuLi4gIyBMZWlkZW4pCmBgYAoKIyMjIFZpc3VhbGl6YXRpb24KCmBgYHtyLGV2YWw9RkFMU0V9CiMgVmlzdWFsaXphdGlvbi4gQWRkIHRoZSBjbHVzdGVyIGxhYmVscyB0byB0aGUgcHJldmlvdXNseSBnZW5lcmF0ZWQgVFNORQojIGNvb3JkaW5hdGVzCnBsb3RUU05FKHNjZSwgCiAgICAgICAgIGNvbG91cl9ieT0iY2x1c3Rlcl9sb3V2YWluIikKCnBsb3RUU05FKHNjZSwgCiAgICAgICAgIGNvbG91cl9ieT0iY2x1c3Rlcl9sZWlkZW4yIikKYGBgCgojIyBLLW1lYW5zIGNsdXN0ZXJpbmcKCkstbWVhbnMgaXMgYSBjbHVzdGVyaW5nIGFsZ29yaXRobSB0aGF0IGhhcyBiZWVuIHVzZWQgaW4gbWFueSBhcHBsaWNhdGlvbiBhcmVhcy4gCkluIFIsIGl0IGNhbiBiZSBhcHBsaWVkIHZpYSB0aGUgYGttZWFuc2AgZnVuY3Rpb24uIFR5cGljYWxseSwgaXQgaXMgYXBwbGllZCB0byAKYSByZWR1Y2VkIGRpbWVuc2lvbmFsIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBleHByZXNzaW9uIGRhdGEgKG1vc3Qgb2Z0ZW4gUENBKS4gCldlIG5lZWQgdG8gZGVmaW5lIHRoZSBudW1iZXIgb2YgY2x1c3RlcnMgaW4gYWR2YW5jZS4gU2luY2UgdGhlIHJlc3VsdHMgZGVwZW5kIG9uIAp0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIGNsdXN0ZXIgY2VudGVycywgaXQgaXMgdHlwaWNhbGx5IHJlY29tbWVuZGVkIHRvIHJ1biAKay1tZWFucyB3aXRoIG11bHRpcGxlIHN0YXJ0aW5nIGNvbmZpZ3VyYXRpb25zICh2aWEgdGhlIGBuc3RhcnRgIGFyZ3VtZW50KS4KRm9yIHJlcHJvZHVjaWJpbGl0eSwgd2UgYWxzbyBzdHJvbmdseSBhZHZpc2UgdG8gc2V0IGEgc2VlZC4KCmBgYHtyLGV2YWw9RkFMU0V9CnNldC5zZWVkKDEyMykKCiMgaz0xMApjbHVzdF9rbWVhbnNfazEwIDwtIGttZWFucyhyZWR1Y2VkRGltKC4uLiksICMgZXh0cmFjdCB0aGUgcHJpbmNpcGFsIGNvbXBvbmVudHMgZnJvbSB0aGUgU0NFIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXJzID0gLi4uLCAjIGNob29zZSBrID0gMTAKICAgICAgICAgICAgICAgICAgICAgICAgICAgbnN0YXJ0ID0gLi4uKSAgIyBjaG9vc2UgNSBkaWZmZXJlbnQgc3RhcnRpbmcgY29uZmlndXJhdGlvbnMKdGFibGUoY2x1c3Rfa21lYW5zX2sxMCRjbHVzdGVyKSAjIGluc3BlY3QgdGhlIG51bWJlciBvZiBjZWxscyBpbiBlYWNoIGttZWFucyBjbHVzdGVyCmNvbERhdGEoc2NlKSRrbWVhbnMxMCA8LSAuLi4gIyBhZGQgdG8gY29sRGF0YQpwbG90VFNORShvYmplY3QgPSAuLi4sIAogICAgICAgICBjb2xvdXJfYnkgPSAuLi4pICMgY29sb3IgdGhlIG9ic2VydmF0aW9ucyBhY2NvcmRpbmcgdG8gdGhlIGstbWVhbnMgY2x1c3RlcmluZwoKIyByZXBlYXQgZm9yIGs9MzkKYGBgCgpXZSBoZXJlIGFyYml0cmFyaWx5IHBlcmZvcm1lZCB0d28gay1tZWFucyBjbHVzdGVyaW5nIGFuYWx5c2VzLCBvbmNlIHdpdGggaz0xMCAKYW5kIG9uY2Ugd2l0aCBrPTM5ICh0aGUgbnVtYmVyIG9mIGNsdXN0ZXJzIGNvbW11bmljYXRlZCBieSB0aGUgYXV0aG9ycykuIFRoZSAKY2hvaWNlIG9mIHRoZSBudW1iZXIgb2YgY2x1c3RlcnMgayBjYW4gYmUgZ3VpZGVkIGJ5IGtub3duIGJpb2xvZ3ksIGhvd2V2ZXIsIGl0IAppcyBhcmJpdHJhcnkgYXQgbGVhc3QgdG8gc29tZSBpbnRlcnZhbC4KCiMjIEhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nCgpGcm9tIFtPU0NBIGJvb2sgY2hhcHRlciA1LjRdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTQvT1NDQS5iYXNpYy9jbHVzdGVyaW5nLmh0bWwjaGllcmFyY2hpY2FsLWNsdXN0ZXJpbmcpOgoKIkhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nIGlzIGFuIG9sZCB0ZWNobmlxdWUgdGhhdCBhcnJhbmdlcyBzYW1wbGVzIGludG8gYSAKaGllcmFyY2h5IGJhc2VkIG9uIHRoZWlyIHJlbGF0aXZlIHNpbWlsYXJpdHkgdG8gZWFjaCBvdGhlci4gTW9zdCBpbXBsZW1lbnRhdGlvbnMKZG8gc28gYnkgam9pbmluZyB0aGUgbW9zdCBzaW1pbGFyIHNhbXBsZXMgaW50byBhIG5ldyBjbHVzdGVyLCB0aGVuIGpvaW5pbmcgCnNpbWlsYXIgY2x1c3RlcnMgaW50byBsYXJnZXIgY2x1c3RlcnMsIGFuZCBzbyBvbiwgdW50aWwgYWxsIHNhbXBsZXMgYmVsb25nIHRvIGEgCnNpbmdsZSBjbHVzdGVyLiBUaGlzIHByb2Nlc3MgeWllbGRzIGEgZGVuZHJvZ3JhbSB0aGF0IGRlZmluZXMgY2x1c3RlcnMgd2l0aCAKcHJvZ3Jlc3NpdmVseSBpbmNyZWFzaW5nIGdyYW51bGFyaXR5LiBWYXJpYW50cyBvZiBoaWVyYXJjaGljYWwgY2x1c3RlcmluZyAKbWV0aG9kcyBwcmltYXJpbHkgZGlmZmVyIGluIGhvdyB0aGV5IGNob29zZSB0byBwZXJmb3JtIHRoZSBhZ2dsb21lcmF0aW9ucy4gCkZvciBleGFtcGxlLCBjb21wbGV0ZSBsaW5rYWdlIGFpbXMgdG8gbWVyZ2UgY2x1c3RlcnMgd2l0aCB0aGUgc21hbGxlc3QgbWF4aW11bSAKZGlzdGFuY2UgYmV0d2VlbiB0aGVpciBlbGVtZW50cywgd2hpbGUgV2FyZOKAmXMgbWV0aG9kIGFpbXMgdG8gbWluaW1pemUgdGhlIAppbmNyZWFzZSBpbiB3aXRoaW4tY2x1c3RlciB2YXJpYW5jZS4KCkluIHRoZSBjb250ZXh0IG9mIHNjUk5BLXNlcSwgdGhlIG1haW4gYWR2YW50YWdlIG9mIGhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nIGxpZXMKaW4gdGhlIHByb2R1Y3Rpb24gb2YgdGhlIGRlbmRyb2dyYW0uIFRoaXMgaXMgYSByaWNoIHN1bW1hcnkgdGhhdCBxdWFudGl0YXRpdmVseQpjYXB0dXJlcyB0aGUgcmVsYXRpb25zaGlwcyBiZXR3ZWVuIHN1YnBvcHVsYXRpb25zIGF0IHZhcmlvdXMgcmVzb2x1dGlvbnMuIApDdXR0aW5nIHRoZSBkZW5kcm9ncmFtIGF0IGhpZ2ggcmVzb2x1dGlvbiBpcyBhbHNvIGd1YXJhbnRlZWQgdG8geWllbGQgY2x1c3RlcnMgCnRoYXQgYXJlIG5lc3RlZCB3aXRoaW4gdGhvc2Ugb2J0YWluZWQgYXQgYSBsb3ctcmVzb2x1dGlvbiBjdXQ7IHRoaXMgY2FuIGJlCmhlbHBmdWwgZm9yIGludGVycHJldGF0aW9uLiIKCkluZGVlZCwgbG93LXJlc29sdXRpb24gY2x1c3RlcnMgY2FuIHR5cGljYWxseSBiZSBpbnRlcnByZXRlZCBhcyBzdXBlci1sZXZlbCBjZWxsCnR5cGVzLCBsaWtlIGltbXVuZSBjZWxscywgbmV1cm9uIGNlbGxzIG9yIGVuZG90aGVsaWFsIGNlbGxzLiBIaWdoZXIgcmVzb2x1dGlvbgpjbHVzdGVycyBjb3JyZXNwb25kIHdpdGggYSBoaWdoZXIgYmlvbG9naWNhbCByZXNvbHV0aW9uOiBpbW11bmUgY2VsbCAtPiAKbHltcGhvY3l0ZSAtPiBULWNlbGwgLT4gVGgxIGNlbGwuCgpIb3dldmVyLCBub3RlIHRoYXQgd2UgY2FuIGFsc28gb3ZlcmNsdXN0ZXIgdGhlIGRhdGEgKHNwbGl0dGluZyBhIGhvbW9nZW5vdXMgCnNldCBvZiBjZWxscyBpbiBtdWx0aXBsZSBjbHVzdGVycyksIHJlc3VsdGluZyBpbiBzcHVyaW91cyBjZWxsIHR5cGUgCmlkZW50aWZpY2F0aW9uLgoKVGhlIGBjbHVzdGVyQ2VsbHNgIGZ1bmN0aW9uIG9mIHRoZSBgc2NyYW5gIGxpYnJhcnkgYWxzbyBhbGxvd3MgZm9yIHBlcmZvcm1pbmcgCmhpZXJhcmNoaWNhbCBjbHVzdGVyaW5nLiBUaGlzIGNhbiBiZSBpbXBsZW1lbnRlZCBhcyBmb2xsb3dzOgoKYGBgCiMgdGFrZXMgNCBtaW51dGVzCmxpYnJhcnkoYmx1c3RlcikKaGNsdXN0LnNjZSA8LSBjbHVzdGVyQ2VsbHMoeCA9IHNjZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2UuZGltcmVkID0gIlBDQSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBCTFVTUEFSQU0gPSBIY2x1c3RQYXJhbShtZXRob2Q9IndhcmQuRDIiKSkKYGBgCgpFcXVpdmFsZW50bHksIHdlIG1heSBhZ2FpbiBzcGxpdCB0aGUgcHJvY2VzcyBpbiB0d28gc3RlcHM6CgoxLiBDb21wdXRlIHRoZSBwYWlyd2lzZSBkaXN0YW5jZXMgYmV0d2VlbiBhbGwgY2VsbHMuIFRoZXNlIGFyZSBieSBkZWZhdWx0IEV1Y2xpZGVhbgpkaXN0YW5jZXMgYW5kLCBpbiBvcmRlciB0byByZWR1Y2UgZGF0YSBjb21wbGV4aXR5IGFuZCBpbmNyZWFzZSBzaWduYWwgdG8gbm9pc2UsIAp3ZSBtYXkgcGVyZm9ybSB0aGlzIG9uIHRoZSB0b3AgKDMwKSBQQ+KAmXMsIGp1c3QgbGlrZSB3ZSBkaWQgd2hlbiBjb25zdHJ1Y3RpbmcgCnRoZSBTTk4gZ3JhcGggaW4gZ3JhcGgtYmFzZWQgY2x1c3RlcmluZy4gQ2FsY3VsYXRpbmcgYSBkaXNzaW1pbGFyaXR5IG1hdHJpeCAKaXMgaW1wbGVtZW50ZWQgaW4gdGhlIGBkaXN0YCBmdW5jdGlvbi4KCjIuIFBlcmZvcm0gYSBoaWVyYXJjaGljYWwgY2x1c3RlcmluZyBvbiB0aGUgZGlzdGFuY2VzIGZyb20gc3RlcCAxLiBJbiBhbiAKYWdnbG9tZXJhdGl2ZSBwcm9jZWR1cmUsIGVhY2ggY2VsbCBpcyBmaXJzdCBhc3NpZ25lZCB0byBpdHMgb3duIGNsdXN0ZXIgYW5kIAp0aGVuIHRoZSBhbGdvcml0aG0gcHJvY2VlZHMgaXRlcmF0aXZlbHksIGF0IGVhY2ggc3RhZ2Ugam9pbmluZyB0aGUgdHdvIG1vc3QgCnNpbWlsYXIgY2x1c3RlcnMsIGNvbnRpbnVpbmcgdW50aWwgdGhlcmUgaXMganVzdCBhIHNpbmdsZSBjbHVzdGVyLiBJbXBsZW1lbnRlZCAKaW4gdGhlIGBoY2x1c3RgIGZ1bmN0aW9uLgoKTm90ZSB0aGF0IHRoZSBgaGNsdXN0YCBmdW5jdGlvbiBhbGxvd3MgZm9yIHNwZWNpZnlpbmcgYSAibWV0aG9kIiBhcmd1bWVudC4gClRoZSBkaWZmZXJlbmNlcyBiZXR3ZWVuIHRoZSBkaWZmZXJlbnQgbWV0aG9kcyBnb2VzIGJleW9uZCB0aGUgc2NvcGUgb2YgdGhpcyAKc2Vzc2lvbiwgYnV0IGEgYnJpZWYgZGVzY3JpcHRpb24gaXMgcHJvdmlkZWQgaW4gdGhlIGZ1bmN0aW9uIGhlbHAgZmlsZS4gSW4gCnRoZSBjb250ZXh0IG9mIHNjUk5BLXNlcSwgd2UgcmVjb21tZW5kIHRoZSB1c2Ugb2YgdGhlIGAid2FyZC5EMiJgIG1ldGhvZC4KCmBgYHtyLCBldmFsPUZBTFNFfQpkaXN0c2NlIDwtIGRpc3QoLi4uKSAjIGV4dHJhY3QgdGhlIHByaW5jaXBhbCBjb21wb25lbnRzIGZyb20gdGhlIFNDRSBvYmplY3QgKHJ1bnMgMW1pbikKaGNsIDwtIGhjbHVzdChkaXN0c2NlLCAKICAgICAgICAgICAgICBtZXRob2QgPSAuLi4pICMgcnVucyAzbWluCnBsb3QoaGNsLCAKICAgICBsYWJlbHMgPSBGQUxTRSkgIyB2aXN1YWxpemUgZGVuZHJvZ3JhbQpgYGAKCk5leHQsIGluIG9yZGVyIHRvIGRlcml2ZSBhIGdpdmVuIHNldCBvZiBjbHVzdGVyIGxhYmVscywgd2UgbmVlZCB0byAKImN1dCB0aGUgdHJlZSIsIGkuZS4sIGNob29zZSBhdCB3aGljaCByZXNvbHV0aW9uIHdlIHdhbnQgdG8gCnJlcG9ydCB0aGUgKGNlbGwgdHlwZSkgY2x1c3RlcnMuIFRoaXMgY2FuIGJlIGFjaGlldmVkIHdpdGggdGhlIGBjdXRyZWVgIApmdW5jdGlvbi4gQXMgYW4gaW5wdXQsIGBjdXRyZWVgIHRha2VzIHRoZSBkZW5kcm9ncmFtIGZyb20gdGhlIGBoY2x1c3RgIGZ1bmN0aW9uIAphbmQgYSB0aHJlc2hvbGQgdmFsdWUgZm9yIGN1dHRpbmcgdGhlIHRyZWUuIFRoZSBsYXR0ZXIgbWF5IGJlIGVpdGhlciBga2AsIHRoZSAKbnVtYmVyIG9mIGNsdXN0ZXJzIHdlIHdhbnQgdG8gcmVwb3J0LCBvciBgaGAsIHRoZSBoZWlnaHQgb2YgdGhlIGRlbmRyb2dyYW0gYXQgCndoaWNoIHdlIHdhbnQgdG8gY3V0IHRoZSB0cmVlLgoKYGBge3IsZXZhbD1GQUxTRX0KIyBjdXQgdG8gZ2V0IDEwIGNsdXN0ZXJzCmNsdXN0X2hjbF9rMTAgPC0gY3V0cmVlKHRyZWUgPSAuLi4sICMgbmFtZSBvZiBjbHVzdGVyaW5nIHRyZWUKICAgICAgICAgICAgICAgICAgICAgICAgayA9IC4uLikgIyBkZXNpcmVkIG51bWJlciBvZiBncm91cHMKdGFibGUoY2x1c3RfaGNsX2sxMCkKYGBgCgpgYGB7cixldmFsPUZBTFNFfQojIGN1dCB0byBnZXQgMzkgY2x1c3RlcnMKLi4uCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0Kc2NlJGNsdXN0X2hjbF9rMTAgPC0gLi4uICMgYWRkIHRvIGNvbERhdGEKc2NlJGNsdXN0X2hjbF9rMzkgPC0gYS4uLiAjIGFkZCB0byBjb2xEYXRhCgojIFZpc3VhbGl6YXRpb24uIEFkZCB0aGUgY2x1c3RlciBsYWJlbHMgdG8gdGhlIHByZXZpb3VzbHkgZ2VuZXJhdGVkIFRTTkUKIyBjb29yZGluYXRlcwpwbG90VFNORShvYmplY3QgPSAuLi4sIAogICAgICAgICBjb2xvdXJfYnkgPSAuLi4pICMgaz0xMAoKcGxvdFRTTkUob2JqZWN0ID0gLi4uLCAKICAgICAgICAgY29sb3VyX2J5ID0gLi4uKSAjIGs9MzkKYGBgCgojIENsdXN0ZXJpbmcgaW4gdGhlIG9yaWdpbmFsIHBhcGVyCgpXaGVuIHdlIGNvbXBhcmUgb3VyIGNsdXN0ZXIgbGFiZWxzIHdpdGggdGhvc2UgZnJvbSB0aGUgb3JpZ2luYWwgcGFwZXIsIHdlJ2xsCnNlZSB0aGF0IHRoZSBjb3JyZXNwb25kZW5jZSBpcyBub3QgZ3JlYXQuIEFzIGEgZGVtb25zdHJhdGlvbiwgSSBtYWtlIGEgdGFibGUgYW5kIAphIGhlYXRtYXAgY29tcGFyaW5nIHRoZSBsb3ctcmVzb2x1dGlvbiBjbHVzdGVyIGxhYmVscyBmcm9tIHRoZSBwYXBlciB3aXRoIG91ciAKTG91dmFpbiwgTGVpZGVuMiBhbmQgaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcgKGs9MTApIGxhYmVsczoKCmBgYHtyLGV2YWw9RkFMU0V9CnRhYmxlKHNjZSRjbHVzdGVyX2xvd1JlcywgLi4uKSAjIGNvbXBhcmUgbG93IHJlc29sdXRpb24gY2x1c3RlcnMgb2YgYXV0aG9ycyB0byBvdXIgTG91dmFpbiBjbHVzdGVyaW5nCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KLi4uICMgY29tcGFyZSBsb3cgcmVzb2x1dGlvbiBjbHVzdGVycyBvZiBhdXRob3JzIHRvIG91ciBMZWlkZW4yIGNsdXN0ZXJpbmcKYGBgCgpgYGB7cixldmFsPUZBTFNFfQouLi4gIyBjb21wYXJlIGxvdyByZXNvbHV0aW9uIGNsdXN0ZXJzIG9mIGF1dGhvcnMgdG8gb3VyIGhpZXJhcmNoaWNhbCAoaz0xMCkgY2x1c3RlcmluZwpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CiMgYWxsIHRocmVlIGNvbXBhcmlzb25zIHdpdGggaGVhdG1hcHMKcGhlYXRtYXA6OnBoZWF0bWFwKC4uLikKCnBoZWF0bWFwOjpwaGVhdG1hcCguLi4pCgpwaGVhdG1hcDo6cGhlYXRtYXAoLi4uKQpgYGAKCkFsc28sIHdoZW4gd2UgbG9vayBhdCB0aGUgdC1TTkUgZnJvbSB0aGUgb3JpZ2luYWwgcHVibGljYXRpb24sIHdlIG9ic2VydmUKY2xlYXJseSBkaXN0aW5jdCBjbHVzdGVyczoKCmBgYHtyfQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygibWFjb3Nrb19maWd1cmVfNUIuanBlZyIpCmBgYAoKVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhlIGF1dGhvcnMgb2YgdGhlIG9yaWdpbmFsIHBhcGVyIHVzZWQgcXVpdGUgYSAKZGlmZmVyZW50IHN0cmF0ZWd5IGZvciBwZXJmb3JtaW5nIHRoZSBmZWF0dXJlIHNlbGVjdGlvbiBhbmQgZGltZW5zaW9uIHJlZHVjdGlvbiAKdGhhdCB3ZSBoYXZlIHBlcmZvcm1lZCBpbiBsYWIgc2Vzc2lvbiAyLgoKVG8gZGVtb25zdHJhdGUgdGhlIHBpcGVsaW5lIG9mIHRoZSBvcmlnaW5hbCBhdXRob3JzLCBhbmQgdG8gbWFrZSBvdXIgcmVzdWx0cyAKbW9yZSBjb21wYXJhYmxlIHRvIHRoZWlycywgV2Ugd2lsbCBoZXJlIG1pbWljIHRoZWlyIHN0cmF0ZWd5IGZvciBmZWF0dXJlIApzZWxlY3Rpb24gYW5kIGNsdXN0ZXJpbmcuICoqSG93ZXZlciwgd2Ugd2lsbCBkbyB0aGlzIGFwcHJveGltYXRpdmVseSEqKiBXZSB3aWxsIAp0YWtlIHNpbWlsYXIgc3RlcHMgY29uY2VwdHVhbGx5LCBidXQgd2lsbCByZW1haW4gd2l0aGluIHRoZSBjdXJyZW50IApCaW9jb25kdWN0b3IgZnJhbWV3b3JrIGFuZCB0aGUgcmFuZ2Ugb2YgZnVuY3Rpb25zIHRoYXQgd2UgaGF2ZSBzZWVuIGluIHRoaXMgCmxlY3R1cmUgc2VyaWVzLgoKVGhlIGF1dGhvcnMgcGVyZm9ybWVkIHRoZSBmb2xsb3dpbmcgc3RlcHM6CgoxLiAqKkZpbHRlcmluZzoqKiBUaGUgYXV0aG9ycyBmaXJzdCBmaWx0ZXJlZCB0aGUgNDksMzAwLWNlbGwgZGF0YXNldCB0byByZXRhaW4gCm9ubHkgc2luZ2xlLWNlbGwgbGlicmFyaWVzIHdoZXJlIGF0IGxlYXN0IDkwMCBnZW5lcyB3ZXJlIGRldGVjdGVkLgoKMi4gKipGZWF0dXJlIHNlbGVjdGlvbjoqKiBUaGUgYXV0aG9ycyBmaXJzdCBpZGVudGlmaWVkIHRoZSBzZXQgb2YgZ2VuZXMgdGhhdCAKd2VyZSBtb3N0IHZhcmlhYmxlIGFjcm9zcyB0aGUgc2VsZWN0ZWQgc3VzYmV0IG9mIGNlbGxzLCBhZnRlciBjb250cm9sbGluZyBmb3IgCnRoZSByZWxhdGlvbnNoaXAgYmV0d2VlbiBtZWFuIGV4cHJlc3Npb24gYW5kIHZhcmlhYmlsaXR5LiBUbyBkbyB0aGlzLCB0aGUgCmF1dGhvcnMgYWRvcHRlZCBhIG1hbnVhbCBpbXBsZW1lbnRhdGlvbi4KCi0+IFdlIHdpbGwgbm90IHVzZSB0aGUgZXhhY3Qgc2FtZSBzdHJhdGVneSwgYnV0IHRoZSBgbW9kZWxHZW5lVmFyLWdldFRvcEhWR3NgIApzdHJhdGVneSwgd2hpY2ggaXMgY29uY2VwdHVhbGx5IHNpbWlsYXIgaW4gYWRkcmVzc2luZyB0aGUgbWVhbi12YXJpYW5jZSAKcmVsYXRpb25zaGlwIGR1cmluZyBmZWF0dXJlIHNlbGVjdGlvbi4KCjMuICoqUHJpbmNpcGFsIGNvbXBvbmVudCBhbmFseXNpczoqKiBUaGUgYXV0aG9ycyBwZXJmb3JtZWQgUENBIGFmdGVyIHNjYWxpbmcgCnRoZSBkYXRhLiBUaGV5IG5leHQgcGVyZm9ybWVkIGEgdGVzdCB0byBkZXRlcm1pbmUgaG93IG1hbnkgUENzIGNvbnRyaWJ1dGVkIApzaWduaWZpY2FudGx5IHRvIGV4cGxhaW5pbmcgdGhlIHZhcmlhYmlsaXR5IGluIHRoZSBkYXRhLiBCYXNlZCBvbiB0aGlzIHRlc3QsIAp0aGV5IGNvbnRpbnVlZCB0aGUgYW5hbHlzaXMgcGlwZWxpbmUgd2l0aCB0aGUgdG9wIDMyIFBDcy4KCjQuICoqdC1TTkU6KiogTmV4dCwgdGhlIGF1dGhvcnMgcGVyZm9ybWVkIGEgdC1TTkUgb24gdGhlIHRvcCAzMiBQQ+KAmXMsIHNldHRpbmcgCnRoZSBgcGVycGxleGl0eWAgcGFyYW1ldGVyIG9mIHRoZSB0LVNORSBhbGdvcml0aG0gdG8gMzAuCgo1LiAqKlByb2plY3Rpb24gb2YgcmVtYWluaW5nIGNlbGxzIGFuZCBjbHVzdGVyaW5nOioqIEZpbmFsbHksIHRoZSBhdXRob3JzIAphZG9wdGVkIGEgbWFudWFsbHkgaW1wbGVtZW50ZWQsIHJhdGhlciBjb21wbGV4IHN0cmF0ZWd5IHRvIHByb2plY3QgdGhlIApyZW1haW5pbmcgY2VsbHMgKHdoZXJlIGxlc3MgdGhhbiA5MDAgZGlmZmVyZW50IGdlbmVzIHdlcmUgZGV0ZWN0ZWQpIG9uIHRoZSAKdC1TTkUgZW1iZWRkaW5nIG9idGFpbmVkIGluIHN0ZXAgNC4gTmV4dCwgdGhleSBjbHVzdGVyIHRoZSBjZWxscyB1c2luZyBhIApkZW5zaXR5IGNsdXN0ZXJpbmcgKERCU0NBTiBhbGdvcml0aG0pIHRoYXQgd2FzIG5vdCBkaXNjdXNzZWQgaW4gdGhpcyBsZWN0dXJlIApzZXJpZXMuIEJlY2F1c2UgdGhpcyA1dGggc3RlcCB1c2VzIHRlY2huaXF1ZXMgYmV5b25kIHRoZSBzY29wZSBvZiB0aGlzIGNvdXJzZSwgCndlIHdpbGwgc2ltcGx5IGNvbnRpbnVlIHdvcmtpbmcgd2l0aCB0aGUgZmlsdGVyZWQgZGF0YXNldCBhbmQgcGVyZm9ybSAKaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcuIEhvd2V2ZXIsIHdlIGluY2x1ZGVkIHNvbWUgY29kZSB0aGF0IGFsbG93cyB5b3UgdG8gZG8gCnNvbWV0aGluZyBzaW1pbGFyIHRvIHdoYXQgdGhlIGF1dGhvcnMgZGlkIGZvciB5b3VyIHJlZmVyZW5jZSAobm90ZSB0aGF0IHJ1bm5pbmcgIAp0aGlzIGNvZGUgcmVxdWlyZXMgaW5zdGFsbGluZyB0aGUgYHNuaWZ0ZXJgIFIgcGFja2FnZSwgd2hpY2ggcmVxdWlyZXMgYSB3b3JraW5nClB5dGhvbiBhbmQgQ29uZGEgaW5zdGFsbGF0aW9uKS4KCmBgYHtyLGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CiMgY29kZSBmb3Igc3RlcHMgMS00CmxpYnJhcnkoc2NhdGVyKQpsaWJyYXJ5KGdlbmVmaWx0ZXIpCmxpYnJhcnkoc2NyYW4pCgojIFN0ZXAgMTogRG93bnNhbXBsaW5nCnNjZV85MDAgPC0gc2NlWyxzY2UkZGV0ZWN0ZWQgPiA5MDBdCgojIFN0ZXAgMjogRmVhdHVyZSBzZWxlY3Rpb24Kc2NlXzkwMCA8LSBsb2dOb3JtQ291bnRzKHNjZV85MDApCmRlY185MDAgPC0gbW9kZWxHZW5lVmFyKHNjZV85MDApCmh2Z185MDAgPC0gZ2V0VG9wSFZHcyhkZWNfOTAwLAogICAgICAgICAgICAgICAgICAgICAgbiA9IDM3NCkgIyBzYW1lIG51bWJlciBvZiB0b3AgZmVhdHVyZXMgYXMgb3JpZ2luYWwgcGFwZXIKCiMgU3RlcCAzOiBQQ0EKc2V0LnNlZWQoMTIzNCkKc2NlXzkwMCA8LSBydW5QQ0Eoc2NlXzkwMCwgCiAgICAgICAgICAgICAgICAgIG5jb21wb25lbnRzID0gMzIsICMgc2FtZSBudW1iZXIgb2YgUENzIGFzIG9yaWdpbmFsIHBhcGVyCiAgICAgICAgICAgICAgICAgIHN1YnNldF9yb3cgPSBodmdfOTAwLAogICAgICAgICAgICAgICAgICBzY2FsZT1UUlVFKSAjIHNjYWxlIHRoZSBkYXRhIGxpa2UgaW4gb3JpZ2luYWwgcGFwZXIKCiMgU3RlcCA0OiBULVNORQpzZXQuc2VlZCg0ODQ4NTQpCnNjZV85MDAgPC0gcnVuVFNORShzY2VfOTAwLCAKICAgICAgICAgICAgICAgZGltcmVkID0gJ1BDQScsCiAgICAgICAgICAgICAgIG5fZGltcmVkID0gMzIsCiAgICAgICAgICAgICAgIHBlcnBsZXhpdHkgPSAzMCkgIyBzYW1lIHBlcnBsZXhpdHkgYXMgb3JpZ2luYWwgcGFwZXIKYGBgCgpgYGAKIyBTdGVwIDUgYXV0aG9ycyAoanVzdCBmb3IgeW91ciByZWZlcmVuY2UpOiBwcm9qZWN0IG5ldyBjZWxscyBvbiB0LVNORSBlbWJlZGRpbmcKI0Jpb2NNYW5hZ2VyOjppbnN0YWxsKCJzbmlmdGVyIikKbGlicmFyeShzbmlmdGVyKQp0c25lMSA8LSBzbmlmdGVyOjpmaXRzbmUocmVkdWNlZERpbShzY2VfOTAwLCB0eXBlPSJQQ0EiKSkKZW1iZWRkaW5nIDwtIHJlZHVjZWREaW0oc2NlW2h2Z185MDAsc2NlJGRldGVjdGVkPjkwMF0sIHR5cGU9IlBDQSIpCgpnZ3Bsb3QoKSArCiAgYWVzKHRzbmUxWywgMV0sIHRzbmUxWywgMl0sIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZD45MDBdJGNsdXN0ZXIpKSArCiAgZ2VvbV9wb2ludChwY2ggPSAxOSkgKwogIHNjYWxlX2NvbG91cl9kaXNjcmV0ZShuYW1lID0gIkNsdXN0ZXIiKSArCiAgbGFicyh4ID0gInQtU05FIDEiLCB5ID0gInQtU05FIDIiKSArCiAgdGhlbWVfYncoKQoKbmV3X2Nvb3JkcyA8LSBwcm9qZWN0KHRzbmUxLCAKICAgICAgICAgICAgICAgICAgICAgIG5ldyA9IHJlZHVjZWREaW0oc2NlWyxzY2UkZGV0ZWN0ZWQ8PTkwMF0sIHR5cGU9IlBDQSIpLCAKICAgICAgICAgICAgICAgICAgICAgIG9sZCA9IHJlZHVjZWREaW0oc2NlWyxzY2UkZGV0ZWN0ZWQ+OTAwXSwgdHlwZT0iUENBIikpCmdncGxvdCgpICsKICAgIGdlb21fcG9pbnQoCiAgICAgICAgYWVzKHRzbmUxWywgMV0sIHRzbmUxWywgMl0sCiAgICAgICAgICAgIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZD45MDBdJGNsdXN0ZXIpLAogICAgICAgICAgICBzaGFwZSA9ICJlbWJlZGRpbmciCiAgICAgICAgKQogICAgKSArCiAgICBnZW9tX3BvaW50KAogICAgICAgIGFlcyhuZXdfY29vcmRzWywgMV0sIG5ld19jb29yZHNbLCAyXSwgCiAgICAgICAgICAgIGNvbG91ciA9IGFzLmZhY3RvcihzY2VbLHNjZSRkZXRlY3RlZDw9OTAwXSRjbHVzdGVyKSwKICAgICAgICAgICAgc2hhcGUgPSAicHJvamVjdGlvbiIKICAgICAgICApCiAgICApICsKICAgIHNjYWxlX2NvbG91cl9kaXNjcmV0ZShuYW1lID0gIkNlbGwgdHlwZSIpICsKICAgIHNjYWxlX3NoYXBlX2Rpc2NyZXRlKG5hbWUgPSBOVUxMKSArCiAgICBsYWJzKHggPSAidC1TTkUgMSIsIHkgPSAidC1TTkUgMiIpICsKICAgIHRoZW1lX2J3KCkKYGBgCgpgYGB7cixldmFsPUZBTFNFfQojIFN0ZXAgNSBmb3IgdXM6IHBlcmZvcm0gaGllcmFyY2hpY2FsIGNsdXN0ZXJpbmcKZGlzdHNjZSA8LSBkaXN0KC4uLikKaGNsIDwtIGhjbHVzdCh0cmVlID0gLi4uLCAKICAgICAgICAgICAgICBtZXRob2QgPSAuLi4pCgpjbHVzdF9oY2xfazEwIDwtIC4uLgpjbHVzdF9oY2xfazM5IDwtIC4uLgoKc2NlXzkwMCRjbHVzdF9oY2xfazEwIDwtIC4uLgpzY2VfOTAwJGNsdXN0X2hjbF9rMzkgPC0gLi4uCmBgYAoKVmlzdWFsaXplIG91ciBsYWJlbHMgYW5kIGNvbXBhcmUgd2l0aCBvcmlnaW5hbCBsYWJlbHMgYXQgdGhlIGxvdyByZXNvbHV0aW9uCgpgYGB7cixldmFsPUZBTFNFfQojIHZpc3VhbGl6ZSBvdXIgbGFiZWxzCnBsb3RUU05FKG9iamVjdCA9IC4uLiwKICAgICAgICAgY29sb3VyX2J5ID0gLi4uLAogICAgICAgICB0ZXh0X2J5ID0gLi4uKQoKIyBjb21wYXJlIHdpdGggb3JpZ2luYWwgbGFiZWxzCnBsb3RUU05FKG9iamVjdCA9IHNjZV85MDAsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyX2xvd1JlcyIsCiAgICAgICAgIHRleHRfYnkgPSAiY2x1c3Rlcl9sb3dSZXMiLAogICAgICAgICB0ZXh0X3NpemUgPSAzKQpgYGAKCkNhcmVmdWxseSBjb21wYXJlIHRoZSB0d28gcmVzdWx0aW5nIGZpZ3VyZXMhCgpgYGB7cixldmFsPUZBTFNFfQojIHJlcGVhdCBmb3IgaGlnaCByZXNvbHV0aW9uIGxhYmVscyAoMiBuZXcgdC1TTkUgcGxvdHMpCi4uLgpgYGAKCkNhcmVmdWxseSBjb21wYXJlIHRoZSB0d28gcmVzdWx0aW5nIGZpZ3VyZXMhCgoqKk92ZXJhbGwsIHdlIG9ic2VydmUgYSByYXRoZXIgc3Ryb25nIGNvcnJlc3BvbmRlbmNlIGJldHdlZW4gb3VyIGNsdXN0ZXJzIGFuZCoqCioqdGhvc2Ugb2YgdGhlIGF1dGhvcnMuKiogQWxzbyBub3RlIHRoYXQgb3VyIHQtU05FIHZpc3VhbGl6YXRpb24gbm93IHJlc2VtYmxlcwp0aGUgdC1TTkUgbWFwIG9mIHRoZSBvcmlnaW5hbCBhdXRob3JzIG11Y2ggbW9yZSBjbG9zZWx5OgoKYGBge3J9CmtuaXRyOjppbmNsdWRlX2dyYXBoaWNzKCIuL21hY29za29fZmlndXJlXzVCLmpwZWciKQpgYGAKCiMgQ2VsbCB0eXBlIGFubm90YXRpb24KCiMjIFN1cGVydmlzZWQ6IHVzaW5nIGEgbGltaXRlZCBzZXQgb2Yga25vd24gbWFya2VycwoKSW4gdGhlIHB1YmxpY2F0aW9uLCB0aGUgYXV0aG9ycyBhaW1lZCB0byBpZGVudGlmeSB0aGUgZGlmZmVyZW50IGNsdXN0ZXJzIGluIHRoZQpkYXRhIGJ5IHVzaW5nIGEgc2V0IG9mIDEyIHdlbGwta25vd24gbW9sZWN1bGFyIG1hcmtlcnM7IGdlbmVzIGZvciB3aGljaCB0aGUKZXhwcmVzc2lvbiBwcm9maWxlIGlzIHR5cGljYWxseSB2ZXJ5IHNwZWNpZmljLCBpLmUuLCBoaWdobHkgZXhwcmVzc2VkIG9ubHkgaW4Kb25lIHNwZWNpZmljIGNlbGwgdHlwZS4gVGhleSB1c2VkIHRoZSBmb2xsb3dpbmcgbWFya2VyczogCgpgYGB7cixldmFsPUZBTFNFfQptYXJrZXJzIDwtIGMoIkxIWDEiLCAiU0xDMTdBNiIsIlBBWDYiLCJHQUQxIiwiU0xDNkE5IiwiT1BOMU1XIiwiVlNYMiIsCiAgICAgICAgICAgICAiUkxCUDEiLCAiR0ZBUCIsICJQRUNBTTEiLCAiS0NOSjgiLCJDWDNDUjEiKQpgYGAKCldlIHdpbGwgaGVyZSB2aXN1YWxpemUgdGhlIGV4cHJlc3Npb24gb2YgdGhlc2UgbWFya2VycyBpbiB0LVNORSBzcGFjZS4KRmlyc3QsIHdlIGNyZWF0ZSBhICJiYXNlbGluZSIgZmlndXJlLCBkaXNwbGF5aW5nIGVhY2ggY2VsbCBpbiAyRCBzcGFjZSwgY29sb3JlZAppbiBibGFjay4KCmBgYHtyLGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoZ2dwbG90MikKZ2dfaGxwX2RhdGEgPC0gZGF0YS5mcmFtZSh4ID0gcmVkdWNlZERpbShzY2VfOTAwLCB0eXBlID0gIlRTTkUiKVssMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IHJlZHVjZWREaW0oc2NlXzkwMCwgdHlwZSA9ICJUU05FIilbLDJdLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNsdXN0ZXIgPSBzY2VfOTAwJGNsdXN0ZXIpCmdnX2Jhc2UgPC0gZ2dwbG90KGRhdGEgPSBnZ19obHBfZGF0YVshaXMubmEoc2NlXzkwMCRjbHVzdGVyKSxdLAogICAgICAgICAgICAgICAgICBhZXMoeCA9IHgsIHkgPSB5LCkpICsKICAgIGdlb21fcG9pbnQoc2l6ZT0wLjQpICsKICAgIHRoZW1lX2J3KCkgKwogICAgeGxhYigiVFNORSAxIikgKwogICAgeWxhYigiVFNORSAyIikKZ2dfYmFzZQpgYGAKCk5leHQsIHdlIG9idGFpbiB0aGUgY291bnRzIG9mIHRoZSAxMiBwcmUtc2VsZWN0ZWQgbWFya2VyIGdlbmVzIGZvciBhbGwgY2VsbHMuCgpgYGB7ciwgZXZhbD1GQUxTRX0KbWFya2VyX2NvdW50cyA8LSBhc3NheXMoc2NlXzkwMCkkY291bnRzW21hcmtlcnMsXQptYXJrZXJfY291bnRzIDwtIGFzLm1hdHJpeCh0KG1hcmtlcl9jb3VudHMpKQpgYGAKCkZpbmFsbHksIHdlIG1ha2Ugb25lIGZpZ3VyZSBmb3IgZWFjaCBvZiB0aGUgMTIgbWFya2VyIGdlbmVzLiBUaGUgaWRlYSBpcyB0bwpnaXZlIGVhY2ggY2VsbCB0aGF0IGhhcyBhIG5vbi16ZXJvIGV4cHJlc3Npb24gb2YgdGhlIG1hcmtlciAoaS5lLiwgZm9yIHdoaWNoCnRoZSBtYXJrZXIgaXMgZXhwcmVzc2VkKSBhIHJlZCBjb2xvcmluZy4KCmBgYHtyLGV2YWw9RkFMU0V9Cm1hcmtlcl9jb3VudHNfYmluYXJ5IDwtIG1hcmtlcl9jb3VudHMKbWFya2VyX2NvdW50c19iaW5hcnlbd2hpY2gobWFya2VyX2NvdW50c19iaW5hcnkgPiAwKV0gPC0gMQoKZm9yIChpIGluIHNlcV9hbG9uZyhtYXJrZXJzKSkgewogICAgZ2cgPC0gZ2dwbG90KGRhdGEgPSBnZ19obHBfZGF0YVshaXMubmEoc2NlXzkwMCRjbHVzdGVyKSxdLAogICAgICAgICAgICAgICAgICAgIGFlcyh4ID0geCwgeSA9IHkpKSArCiAgICAgICAgZ2VvbV9wb2ludChhZXMoY29sb3IgPSBhcy5mYWN0b3IobWFya2VyX2NvdW50c19iaW5hcnlbLGldKVshaXMubmEoc2NlXzkwMCRjbHVzdGVyKV0pLCBzaXplID0gMC40KSArCiAgICAgICAgc2NhbGVfY29sb3JfbWFudWFsKHZhbHVlcz1jKCJibGFjayIsInJlZCIpKSArCiAgICAgICAgeGxhYigiVFNORSAxIikgKwogICAgICAgIHlsYWIoIlRTTkUgMiIpICsKICAgICAgICBnZ3RpdGxlKGNvbG5hbWVzKG1hcmtlcl9jb3VudHNfYmluYXJ5KVtpXSkgKwogICAgICAgIHRoZW1lX2J3KCkgKyAKICAgICAgdGhlbWUobGVnZW5kLnRpdGxlID0gZWxlbWVudF9ibGFuaygpKQogICAgcHJpbnQoZ2cpCn0KYGBgCgpgYGB7cixldmFsPUZBTFNFfQojIFZpc3VhbGl6ZSBvdXIgY2x1c3RlcnMKcGxvdFRTTkUoc2NlXzkwMCwKICAgICAgICAgY29sb3VyX2J5ID0gImNsdXN0X2hjbF9rMzkiLAogICAgICAgICB0ZXh0X2J5ID0gImNsdXN0X2hjbF9rMzkiKQpgYGAKCkZyb20gZmlndXJlIDVELCB3ZSBvYnRhaW4gdGhlIG1hcmtlci1jZWxsIHR5cGUgcmVsYXRpb25zaGlwOgoKYGBge3J9CmtuaXRyOjppbmNsdWRlX2dyYXBoaWNzKCJtYWNvc2tvX2ZpZ3VyZV81RC5qcGVnIikKYGBgCgpUcnkgdG8gZ28gYmFjayBhbmQgZm9ydGggYmV0d2VlbiAKCjEuIHRoZSB2aXN1YWxpemF0aW9uIG9mIG1hcmtlciBleHByZXNzaW9uIG9uIHRoZSB0LVNORSBtYXAsCjIuIHRoZSB2aXN1YWxpemF0aW9uIG9mIG91ciBjbHVzdGVyIGxhYmVscyBvbiB0aGUgdC1TTkUgbWFwLCBhbmQKMy4gdGhlIG1hcmtlci1jZWxsIHR5cGUgcmVsYXRpb25zaGlwIGZyb20gZmlndXJlIDVELgoKVGhpcyBzaG91bGQgYWxsb3cgeW91IHRvIG9idGFpbiBhIGxvdy1yZXNvbHV0aW9uIGFubm90YXRpb24gZm9yIG1vc3Qgb2YgdGhlCmNsdXN0ZXJzIHdlIGhhdmUgbWFudWFsbHkgb2J0YWluZWQgb3Vyc2VsdmVzISBXZSBnaXZlIGF3YXkgb25lIG9mIHRoZSBlYXNpZXN0CmFubm90YXRpb25zOgoKLSBUaGUgKkxIWDEqIG1hcmtlciBpcyBzcGVjaWZpYyBmb3IgaG9yaXpvbnRhbCBjZWxscy4gQXMgc3VjaCwgb3VyICoqY2x1c3RlciAzKioKY29ycmVzcG9uZHMgdG8gKipob3Jpem9udGFsIGNlbGxzKiouCgpZb3UgY2FuIGRvIHRoaXMgZm9yIHRoZSBvdGhlciBtYXJrZXJzL2NsdXN0ZXJzIChzb21ldGltZXMgaXQgd2lsbCBzdGlsbCBiZSAKYW1iaWd1b3VzKS4KCiMjIFN1cGVydmlzZWQ6IFVzaW5nIG1hcmtlciBnZW5lcyBkZXRlY3RlZCBmcm9tIHRoaXMgZGF0YQoKU29tZXRpbWVzIGl0IHdpbGwgYmUgdmVyeSBkaWZmaWN1bHQgdG8gc2V0IHVwIGEgcGFuZWwgb2Yga25vd24gbWFya2VyIGdlbmVzIAp0aGF0IHdvdWxkIGFsbG93IHVzIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gYWxsIGNlbGwgdHlwZXMgaW4gb3VyIGRhdGFzZXQuCkZvciBpbnN0YW5jZSwgc29tZXRpbWVzIHdlIG1heSBub3Qga25vdyBpbiBhZHZhbmNlIHdoaWNoIGNlbGwgdHlwZXMgdG8gZXhwZWN0LApvciB3ZSBtYXkgbm90IGhhdmUgZ29vZCBpbmZvcm1hdGlvbiBvbiByZWxldmFudCBtYXJrZXJzIChpZiB0aGUgc3R1ZGllZCBzeXN0ZW0KaXMgbm90IHdlbGwga25vd24pLgoKQW4gYWx0ZXJuYXRpdmUgc3RyYXRlZ3kgaXMgdG8gaWRlbnRpZnkgdGhlIGdlbmVzIHRoYXQgZHJpdmUgc2VwYXJhdGlvbiBiZXR3ZWVuIApjbHVzdGVycy4gVGhlc2UgbWFya2VyIGdlbmVzIGFsbG93IHVzIHRvIGFzc2lnbiBiaW9sb2dpY2FsIG1lYW5pbmcgdG8gZWFjaCAKY2x1c3RlciBiYXNlZCBvbiB0aGVpciBmdW5jdGlvbmFsIGFubm90YXRpb24uIFRoaXMgc3RyYXRlZ3kgaXMgcmVmZXJyZWQgdG8gYXMgCioqbWFya2VyIGdlbmUgZGV0ZWN0aW9uKiouIAoKVGhlIG1vc3Qgc3RyYWlnaHRmb3J3YXJkIGFwcHJvYWNoIHRvIG1hcmtlciBnZW5lIGRldGVjdGlvbiBpbnZvbHZlcyB0ZXN0aW5nIApmb3IgZGlmZmVyZW50aWFsIGV4cHJlc3Npb24gKERFKSBiZXR3ZWVuIGNsdXN0ZXJzLiBJZiBhIGdlbmUgaXMgc3Ryb25nbHkgREUgCmJldHdlZW4gY2x1c3RlcnMsIGl0IGlzIGxpa2VseSB0byBoYXZlIGRyaXZlbiB0aGUgc2VwYXJhdGlvbiBvZiBjZWxscyBpbiB0aGUgCmRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbi4gVGhlIGdlbmVyYWwgc3RyYXRlZ3kgaXMgdG8gY29tcGFyZSBlYWNoIHBhaXIgb2YgY2x1c3RlcnMgCmFuZCBjb21wdXRlIHNjb3JlcyBxdWFudGlmeWluZyB0aGUgZGlmZmVyZW5jZXMgaW4gdGhlIGV4cHJlc3Npb24gZGlzdHJpYnV0aW9ucyAKYmV0d2VlbiBjbHVzdGVycy4gVGhlIHNjb3JlcyBmb3IgYWxsIHBhaXJ3aXNlIGNvbXBhcmlzb25zIGludm9sdmluZyBhIApwYXJ0aWN1bGFyIGNsdXN0ZXIgYXJlIHRoZW4gY29uc29saWRhdGVkIGludG8gYSBzaW5nbGUgZGF0YSBmcmFtZSBmb3IgdGhhdCAKY2x1c3Rlci4gVGhpcyBhcHByb2FjaCBpcyBpbXBsZW1lbnRlZCBpbiB0aGUgYHNjb3JlTWFya2Vyc2AgZnVuY3Rpb24gb2YgdGhlCmBzY3JhbmAgcGFja2FnZS4KCmBgYHtyLGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoc2NyYW4pCm1hcmtlci5pbmZvIDwtIHNjb3JlTWFya2Vycyh4ID0gLi4uLCAjIHRoZSBTQ0Ugb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHMgPSAuLi4pICMgb3VyIGNsdXN0ZXIgaWRlbnRpZmllcnMKbWFya2VyLmluZm8gIyBvbmUgZGF0YWZyYW1lIGZvciBlYWNoIG9mIHRoZSAzOSBjbHVzdGVycwpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CmNvbG5hbWVzKG1hcmtlci5pbmZvW1siMSJdXSkgIyBzdGF0aXN0aWNzIGZvciBjbHVzdGVyIDEuCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0KaGVhZChtYXJrZXIuaW5mb1tbIjEiXV0pCmBgYAoKV2Ugb2JzZXJ2ZSBzZXZlcmFsIHN1bW1hcnkgc3RhdGlzdGljcyBmb3IgZWFjaCBnZW5lIGluIHRoZSBkYXRhZnJhbWUgZm9yCmNsdXN0ZXIgMS4gV2UgaGlnaGxpZ2h0IGEgZmV3OgoKLSBgc2VsZi5hdmVyYWdlYDogdGhlIGF2ZXJhZ2UgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiBvZiB0aGUgZ2VuZSBpbiB0aGUKdGFyZ2V0IGNsdXN0ZXIgKGNsdXN0ZXIgMSkKCi0gYG90aGVyLmF2ZXJhZ2VgOiB0aGUgYXZlcmFnZSBsb2ctbm9ybWFsaXplZCBleHByZXNzaW9uIG9mIHRoZSBnZW5lIGluIGFsbCB0aGUKb3RoZXIgY2x1c3RlcnMgKGNsdXN0ZXJzIDItMzkpCgotIGBzZWxmLmRldGVjdGVkYDogdGhlIGZyYWN0aW9uIG9mIGNlbGxzIGluIHdoaWNoIHRoZSBnZW5lIHdhcyBleHByZXNzZWQgaW4gdGhlCnRhcmdldCBjbHVzdGVyIChjbHVzdGVyIDEpCgotIGBvdGhlci5kZXRlY3RlZGA6IHRoZSBmcmFjdGlvbiBvZiBjZWxscyBpbiB3aGljaCB0aGUgZ2VuZSB3YXMgZXhwcmVzc2VkIGluIGFsbAp0aGUgb3RoZXIgY2x1c3RlcnMgKGNsdXN0ZXIgMi0zOSkKCi0gYG1lYW4uQVVDYDogRnJvbSB0aGUgCltPU0NBIGJvb2sgY2hhcHRlciA2LjNdKGh0dHA6Ly9iaW9jb25kdWN0b3Iub3JnL2Jvb2tzLzMuMTQvT1NDQS5iYXNpYy9tYXJrZXItZGV0ZWN0aW9uLmh0bWwjZWZmZWN0LXNpemVzLWZvci1wYWlyd2lzZS1jb21wYXJpc29ucyk6IAoiSW4gdGhlIGNvbnRleHQgb2YgbWFya2VyIGRldGVjdGlvbiwgdGhlIGFyZWEgdW5kZXIgdGhlIGN1cnZlIChBVUMpIHF1YW50aWZpZXMgCm91ciBhYmlsaXR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdHdvIGRpc3RyaWJ1dGlvbnMgaW4gYSBwYWlyd2lzZSBjb21wYXJpc29uLiAKVGhlIEFVQyByZXByZXNlbnRzIHRoZSBwcm9iYWJpbGl0eSB0aGF0IGEgcmFuZG9tbHkgY2hvc2VuIG9ic2VydmF0aW9uIGZyb20gb3VyIApjbHVzdGVyIG9mIGludGVyZXN0IGlzIGdyZWF0ZXIgdGhhbiBhIHJhbmRvbWx5IGNob3NlbiBvYnNlcnZhdGlvbiBmcm9tIHRoZSBvdGhlcgpjbHVzdGVyLiBBIHZhbHVlIG9mIDEgY29ycmVzcG9uZHMgdG8gdXByZWd1bGF0aW9uLCB3aGVyZSBhbGwgdmFsdWVzIG9mIG91ciAKY2x1c3RlciBvZiBpbnRlcmVzdCBhcmUgZ3JlYXRlciB0aGFuIGFueSB2YWx1ZSBmcm9tIHRoZSBvdGhlciBjbHVzdGVyOyBhIAp2YWx1ZSBvZiAwLjUgbWVhbnMgdGhhdCB0aGVyZSBpcyBubyBuZXQgZGlmZmVyZW5jZSBpbiB0aGUgbG9jYXRpb24gb2YgdGhlIApkaXN0cmlidXRpb25zOyBhbmQgYSB2YWx1ZSBvZiAwIGNvcnJlc3BvbmRzIHRvIGRvd25yZWd1bGF0aW9uLiBUaGUgQVVDIGlzIApjbG9zZWx5IHJlbGF0ZWQgdG8gdGhlIFUgc3RhdGlzdGljIGluIHRoZSBXaWxjb3hvbiByYW5rZWQgc3VtIHRlc3QgKGEuay5hLiwgCk1hbm4tV2hpdG5leSBVLXRlc3QpLiIgQXMgc3VjaCwgdGhpcyBhIHZlcnkgaW50ZXJlc3RpbmcgY29sdW1uIHRvIHVzZSBmb3IKc2VsZWN0aW5nIG1hcmtlciBnZW5lcy4KCkJhc2VkIG9uIHRoZSBgbWVhbi5BVUNgIHN0YXRpc3RpYywgd2UgbWF5IG5vdyBpbnNwZWN0IHRoZSB0b3AxMCBtYXJrZXJzIHRvCmRpc3Rpbmd1aXNoIGJldHdlZW4gY2VsbHMgb2YgY2x1c3RlciAxIGFuZCBjZWxscyBvZiB0aGUgb3RoZXIgY2x1c3RlcnM6CgpgYGB7cixldmFsPUZBTFNFfQpjaG9zZW4gPC0gbWFya2VyLmluZm9bWyIxIl1dCm9yZGVyZWQgPC0gY2hvc2VuW29yZGVyKGNob3NlbiRtZWFuLkFVQywgZGVjcmVhc2luZz1UUlVFKSxdCmhlYWQob3JkZXJlZFssYygxOjQsMTApXSwgbj0xMCkgIyBzaG93aW5nIGJhc2ljIHN0YXRzIG9ubHksIGZvciBicmV2aXR5LgpgYGAKCldlIGNhbiBhbHNvIHZpc3VhbGl6ZSB0aGUgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiBvZiB0aGUgdG9wMTAgbWFya2VycyBpbiAKZWFjaCBjZWxsLCBzdHJhdGlmaWVkIG9uIGNsdXN0ZXIgbGFiZWwsIHVzaW5nIHRoZSBgcGxvdEV4cHJlc3Npb25gIGZ1bmN0aW9uCm9mIHRoZSBgc2NhdGVyYCBwYWNrYWdlOgoKYGBge3IsZXZhbD1GQUxTRSwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeShzY2F0ZXIpCnBsb3RFeHByZXNzaW9uKGJqZWN0ID0gLi4uLCAjIHRoZSBTQ0Ugb2JqZWN0LCAKICAgICAgICAgICAgICAgZmVhdHVyZXMgPSAuLi4sICMgdG9wIDEwIGZlYXR1cmVzIGFjY29yZGluZyB0byB0aGUgYHNjb3JlTWFya2Vyc2AgcmVzdWx0cwogICAgICAgICAgICAgICB4ID0gLi4uLCAjIG91ciBjbHVzdGVyIGxhYmVscyAKICAgICAgICAgICAgICAgY29sb3VyX2J5ID0gLi4uKSAjIG91ciBjbHVzdGVyIGxhYmVscyAKYGBgCgpCYXNlZCBvbiB0aGVzZSByZXN1bHRzLCB3aGljaCBtYXJrZXJzIHdvdWxkIHlvdSBjaG9vc2UgdG8gdW5hbWJpZ3VvdXNseSAKZGlzdGluZ3Vpc2ggY2VsbHMgZnJvbSBjbHVzdGVyIDEgZnJvbSBjZWxscyBvZiB0aGUgb3RoZXIgY2x1c3RlcnM/CgpEb2VzIHRoZSBuYW1lIG9mIHRoZSA5dGggbWFya2VyIGdlbmUgcmluZyBhbnkgYmVsbHM/CgojIyBTZW1pLXN1cGVydmlzZWQgdXNpbmcgU2luZ2xlUgoKQSBjb25jZXB0dWFsbHkgc3RyYWlnaHRmb3J3YXJkIGFubm90YXRpb24gYXBwcm9hY2ggaXMgdG8gY29tcGFyZSBvdXIgY3VycmVudApzY1JOQS1zZXEgZGF0YXNldCB3aXRoIGEgcHJldmlvdXNseSBhbm5vdGF0ZWQgcmVmZXJlbmNlIGRhdGFzZXQuIExhYmVscyBjYW4gCnRoZW4gYmUgYXNzaWduZWQgdG8gZWFjaCBjZWxsIGluIHRoZSBNYWNvc2tvIGRhdGFzZXQgYmFzZWQgb24gdGhlIAptb3N0IHNpbWlsYXIgcmVmZXJlbmNlIGNlbGxzLCBmb3Igc29tZSBkZWZpbml0aW9uIG9mICJzaW1pbGFyIi4gVGhpcyBpcyBhIApzdGFuZGFyZCBjbGFzc2lmaWNhdGlvbiBjaGFsbGVuZ2UgdGhhdCBjYW4gYmUgdGFja2xlZCBieSBzdGFuZGFyZCBtYWNoaW5lIApsZWFybmluZyB0ZWNobmlxdWVzIHN1Y2ggYXMgcmFuZG9tIGZvcmVzdHMgYW5kIHN1cHBvcnQgdmVjdG9yIG1hY2hpbmVzLiBBbnkgCnB1Ymxpc2hlZCBhbmQgbGFiZWxlZCBSTkEtc2VxIGRhdGFzZXQgKGJ1bGsgb3Igc2luZ2xlLWNlbGwpIGNhbiBiZSB1c2VkIGFzIGEgCnJlZmVyZW5jZSwgdGhvdWdoIGl0cyByZWxpYWJpbGl0eSBkZXBlbmRzIGdyZWF0bHkgb24gdGhlIGV4cGVydGlzZSBvZiB0aGUgCm9yaWdpbmFsIGF1dGhvcnMgd2hvIGFzc2lnbmVkIHRoZSBsYWJlbHMgaW4gdGhlIGZpcnN0IHBsYWNlIGFuZCB0aGUgY2xvc2VyCnRoZSByZWZlcmVuY2UgZGF0YXNldCBpcyB0byB0aGUgZGF0YXNldCB3ZSB3b3VsZCBsaWtlIHRvIGFubm90YXRlIChlLmcuLCAKZnVsbC1sZW5ndGggdnMgVU1JLWJhc2VkIHByb3RvY29sKSwgdGhlIG1vcmUgYWNjdXJhdGUgdGhlIGFubm90YXRpb24gd2lsbCB0eXBpY2FsbHkgYmUuCgpJbiB0aGlzIHNlY3Rpb24sIHdlIHdpbGwgcGVyZm9ybSBzdWNoIGxhYmVsIHRyYW5zZmVyIGJldHdlZW4gdGhlIGFubm90YXRlZApyZWZlcmVuY2UgZGF0YXNldCBmcm9tIApbU2hla2hhciBldCBhbC5dKGh0dHBzOi8vZG9pLm9yZy8xMC4xMDE2L2ouY2VsbC4yMDE2LjA3LjA1NCksIHdoaWNoIGFsc28gaXMgCmEgc2NSTkEtc2VxIGRhdGFzZXQgdGhhdCBzdHVkaWVkIHRoZSBtb3VzZSByZXRpbmEsIGFuZCB0aGUgTWFjb3NrbyBkYXRhc2V0LiAKClRvIHBlcmZvcm0gdGhlIGFjdHVhbCBsYWJlbCB0cmFuc2Zlciwgd2lsbCB1c2UgdGhlIGBTaW5nbGVSYCBCaW9jb25kdWN0b3IgCnBhY2thZ2UuIEZvciBlYWNoICJ0ZXN0IiBjZWxsIGluIHRoZSBNYWNvc2tvIGRhdGFzZXQsIGBzaW5nbGVSYCB3aWxsOgoKMS4gQ29tcHV0ZSBTcGVhcm1hbiBjb3JyZWxhdGlvbiBiZXR3ZWVuIHRoZSB0ZXN0IGNlbGwgYW5kIGVhY2ggcmVmZXJlbmNlIGNlbGwuIApUbyBpbXByb3ZlIHNpZ25hbC9ub2lzZSwgb25seSBtYXJrZXIgZ2VuZXMgaWRlbnRpZmllZCB1c2luZyB0aGUgcmVmZXJlbmNlIApkYXRhc2V0IGFyZSB1c2VkIGZvciB0aGlzLgoKMi4gRm9yIGVhY2ggbGFiZWwgKGNlbGwgdHlwZSksIHNldCB0aGUgc2NvcmUgYXMgdGhlIChkZWZhdWx0IG9mKSA4MCUgcXVhbnRpbGUgb2YKU3BlYXJtYW4gY29ycmVsYXRpb25zLgoKMy4gVGhlIHByZWRpY3Rpb24gaXMgdGhlbiB0aGUgbGFiZWwgd2l0aCB0aGUgaGlnaGVzdCBzY29yZS4KCkJlZm9yZSB3ZSBjYW4gdXNlIGBzaW5nbGVSYCB0byBwZXJmb3JtIGxhYmVsIHRyYW5zZmVyLCB3ZSB3aWxsIG5lZWQgdG8gaW1wb3J0LApleHBsb3JlIChicmllZikgYW5kIHdyYW5nbGUgdGhlIHJlZmVyZW5jZSBkYXRhc2V0IGJ5IFNoZWtoYXIgKmV0IGFsLiouCgojIyMgSW1wb3J0IHJlZmVyZW5jZSBkYXRhCgpUaGUgZGF0YXNldCBieSBTaGVraGFyICpldCBhbC4qIGNhbiBiZSBjb252ZW5pZW50bHkgaW1wb3J0ZWQgdXNpbmcgdGhlIApgc2NSTkFzZXFgIHBhY2thZ2UuCgpgYGB7cixldmFsPUZBTFNFLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjUk5Bc2VxKQoocmVmLmRhdGEgPC0gc2NSTkFzZXE6OlNoZWtoYXJSZXRpbmFEYXRhKGVuc2VtYmwgPSBUUlVFKSkKYGBgCgojIyMgRXhwbG9yZSBtZXRhZGF0YSBvZiByZWZlcmVuY2UgZGF0YQoKSW5zcGVjdCB0aGUgY29sRGF0YSBmb3IgdGhlIFNoZWtoYXIgZGF0YXNldC4gQ29tcGFyZSB0aGUgQ0xVU1RFUiBhbmQgU1VCQ0xVU1RFUgp2YXJpYWJsZXMhCgojIyMgUHJvY2VzcyByZWZlcmVuY2UgZGF0YQoKMS4gUmVtb3ZlIHVubGFiZWxlZCBjZWxscwoKYGBge3IsZXZhbD1GQUxTRX0Kc3VtKGlzLm5hKHJlZi5kYXRhJENMVVNURVIpKQpyZWYuZGF0YSA8LSByZWYuZGF0YVssLXdoaWNoKGlzLm5hKHJlZi5kYXRhJENMVVNURVIpKV0KYGBgCgoyLiBSZW1vdmUgZG91YmxldHMvY29udGFtaW5hbnQgY2VsbHMKClRoZSBvcmlnaW5hbCBhdXRob3JzIGFscmVhZHkgcGVyZm9ybWVkIHF1YWxpdHkgY29udHJvbDsgd2UgaGF2ZSBjZWxscyB3aXRoIApjbHVzdGVyIGxhYmVsICJEb3VibGV0cy9Db250YW1pbmFudHMiLiBMZXTigJlzIHJlbW92ZSB0aG9zZToKCmBgYHtyLGV2YWw9RkFMU0V9CnN1bShyZWYuZGF0YSRDTFVTVEVSID09IC4uLikKcmVmLmRhdGEgPC0gLi4uCmBgYAoKMy4gTWFrZSBsb3dlciByZXNvbHV0aW9uIGNlbGwgdHlwZSBsZXZlbHMgKGZvciBlYXNpZXIgaW50ZXJwcmV0YXRpb24pCgpgYGB7cixldmFsPUZBTFNFfQpyZWYuZGF0YSRDTFVTVEVSX2xvd1JlcyA8LSBmY3RfcmVjb2RlKHJlZi5kYXRhJENMVVNURVIsIAogICAgICAgICAgICJBbWFjcmluZV9jZWxscyIgPSAiQUMgKEFtYWNyaW5lIGNlbGwpIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkMxQSIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDMUIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzNBIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkMzQiIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNCIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNUEgKENvbmUgQmlwb2xhciBjZWxsIDVBKSIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNUIiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzVDIiwKICAgICAgICAgICAiQmlwb2xhcl9jZWxscyIgPSAiQkM1RCIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNiIsCiAgICAgICAgICAgIkJpcG9sYXJfY2VsbHMiID0gIkJDNyAoQ29uZSBCaXBvbGFyIGNlbGwgNykiLAogICAgICAgICAgICJCaXBvbGFyX2NlbGxzIiA9ICJCQzgvOSAobWl4dHVyZSBvZiBCQzggYW5kIEJDOSkiLAogICAgICAgICAgICJDb25lcyIgPSAiQ29uZSBQaG90b3JlY2VwdG9ycyIsCiAgICAgICAgICAgIk11bGxlcl9nbGlhIiA9ICJNRyAoTXVlbGxlciBHbGlhKSIsCiAgICAgICAgICAgIlJvZF9CaXBvbGFyX2NlbGwiID0gIlJCQyAoUm9kIEJpcG9sYXIgY2VsbCkiLAogICAgICAgICAgICJSb2QgUGhvdG9yZWNlcHRvcnMiID0gIlJvZCBQaG90b3JlY2VwdG9ycyIpCmBgYAoKNC4gUmVtb3ZlIGxvd2x5IGV4cHJlc3NlZCBnZW5lcwoKYGBge3IsZXZhbD1GQUxTRX0Ka2VlcCA8LSByb3dTdW1zKGFzc2F5cyhyZWYuZGF0YSkkY291bnRzID4gMCkgPiAxMAp0YWJsZShrZWVwKQpyZWYuZGF0YSA8LSByZWYuZGF0YVtrZWVwLF0KYGBgCgo1LiBPYnRhaW4gc2FtZSBnZW5lIElEIGZvcm1hdCBhcyBpbiB0YXJnZXQgZGF0YQoKVG8gYXZvaWQgcHJvYmxlbXMgd2l0aCBkaWZmZXJlbnQgdmVyc2lvbiBvZiBnZW5lIHN5bWJvbHMsIGl0IGlzIGdvb2QgcHJhY3RpY2UKZG8gd29yayB3aXRoIHVuYW1iaWd1b3VzIGdlbmUgaWRlbnRpZmllcnMgbGlrZSB0aG9zZSBvZiBFTlNFTUJMIGluc3RlYWQuCgpgYGB7cixldmFsPUZBTFNFfQpyb3duYW1lcyhzY2VfOTAwKSA8LSByb3dEYXRhKHNjZV85MDApJGVuc2VtYmxfZ2VuZV9pZCAjIHVzZSBFTlNFTUJMIGlkZW50aWZpZXJzIGluc3RlYWQKc3VtKHJvd25hbWVzKHNjZV85MDApICVpbiUgcm93bmFtZXMocmVmLmRhdGEpKQpgYGAKCjYuIENvbXB1dGUgYGxvZ05vcm1Db3VudHNgCgpgYGB7cixldmFsPUZBTFNFLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjdXR0bGUpCnJlZi5kYXRhIDwtIGxvZ05vcm1Db3VudHMoLi4uKQpgYGAKCiMjIyBgU2luZ2xlUmAgYXQgbG93IHJlZmVyZW5jZSByZXNvbHV0aW9uCgpgYGB7cixldmFsPUZBTFNFfQojQmlvY01hbmFnZXI6Omluc3RhbGwoIlNpbmdsZVIiKQpsaWJyYXJ5KFNpbmdsZVIpCgojIHJ1bnMgMm1pbiAzMHNlYyBmb3IgbWUKcHJlZC5sb3dSZXMgPC0gU2luZ2xlUih0ZXN0ID0gLi4uLCAjIG91ciBkYXRhc2V0CiAgICAgICAgICAgICAgICAgICAgICAgcmVmID0gLi4uLCAjIHRoZSByZWZlcmVuY2UgZGF0YXNldCAKICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHMgPSAuLi4sICMgdmVjdG9yIG9mIGtub3duIGxhYmVscyBmb3IgYWxsIGNlbGxzIGluIHJlZgogICAgICAgICAgICAgICAgICAgICAgIGRlLm1ldGhvZCA9ICJ3aWxjb3giKSAjIG1vc3Qgc3VpdGFibGUgbWV0aG9kIGZvciBzcGFyc2UgKGRyb3BsZXQpIGRhdGEKdGFibGUocHJlZC5sb3dSZXMkbGFiZWxzKQpgYGAKClVzaW5nIHRoZSBgU2luZ2xlUmAgY2xhc3NpZmllciB0aGF0IHdhcyB0cmFpbmVkIG9uIHRoZSByZWZlcmVuY2UgZGF0YXNldCBieQpTaGVraGFyICpldCBhbC4qLCB3ZSBoYXZlIGxhYmVsZWQgMjczMSBjZWxscyBmcm9tIHRoZSBNYWNvc2tvIGRhdGFzZXQgYXMKYW1hY3JpbmUgY2VsbHMsIDE1MjggY2VsbHMgYXMgYmlwb2xhciBjZWxscywgYW5kIHNvIG9uLiBBZ2FpbiBub3RlIHRoYXQgd2UKcHJlZGljdGVkIGEgbGFiZWwgZm9yIGVhY2ggY2VsbCBpbiB0aGUgTWFjb3NrbyBkYXRhc2V0IGJhc2VkIGl0cyBzaW1pbGFyaXR5CihpbiBnZW5lIGV4cHJlc3Npb24pIHdpdGggbGFiZWxlZCBjZWxscyBmcm9tIHRoZSBTaGVraGFyIGRhdGFzZXQuCgoqKk1vc3QgaW1wb3J0YW50bHksKiogd2Ugd2FudCB0byBjb21wYXJlIG91ciBwcmVkaWN0ZWQgY2VsbCBsYWJlbHMgd2l0aCB0aGUKbGFiZWxzIHRoYXQgd2VyZSBvYnRhaW5lZCBieSBNYWNva3NvICpldCBhbC4qLCB3aGljaCB3ZSAqY291bGQqIGNvbnNpZGVyIHRvIGJlCmdyb3VuZCB0cnV0aCBsYWJlbHMgaWYgd2UgYXNzdW1lIHRoYXQgdGhlIGF1dGhvcnMgc3VjY2VlZGVkIGluIHRoZWlyIGxhcmdlIAplZmZvcnQgb2YgYW5ub3RhdGluZyB0aGVpciBjZWxsIGNsdXN0ZXJzIGZvciB0aGVpciBwdWJsaWNhdGlvbi4KCmBgYHtyLGV2YWw9RkFMU0V9CnRhYiA8LSB0YWJsZSguLi4sIC4uLikgIyB0aGUgb3JpZ2luYWwgbG93LXJlc29sdXRpb24gbGFiZWxzIHZlcnN1cyBvdXIgcHJlZGljdGVkIGxvdy1yZXNvbHV0aW9uIGxhYmVscwp0YWIKYGBgCgpJbnNwZWN0IHRoZSByZXN1bHRzLgoKQmVmb3JlIHdlIGRpdmUgZGVlcGVyIGludG8gdGhpcywgd2UgbWF5IHZpc3VhbGl6ZSBvdXIgcmVzdWx0IHVzaW5nIGEgaGVhdG1hcDoKCmBgYHtyLGV2YWw9RkFMU0V9CnBoZWF0bWFwOjpwaGVhdG1hcCh0YWIgLyByb3dTdW1zKHRhYikpCmBgYAoKSW5zcGVjdCB0aGUgcmVzdWx0cy4KCk9uZSBvdGhlciB2aXN1YWxpemF0aW9uIHN0cmF0ZWd5IGlzIGltcGxlbWVudGVkIGluIHRoZSBgcGxvdFNjb3JlSGVhdG1hcGAgb2YgdGhlCmBTaW5nbGVSYCBwYWNrYWdlLiBSZW1lbWJlciwgdGhlIGBTaW5nbGVSYCBjbGFzc2lmaWVyIGFzc2lnbnMgZWFjaCB0YXJnZXQgY2VsbAp0byBhIGNlbGwgdHlwZSBsYWJlbCAqKndpdGggYSBjZXJ0YWluIHByb2JhYmlsaXR5KiouIFRoZSBgcGxvdFNjb3JlSGVhdG1hcGAKZnVuY3Rpb24gdGhlbiBhbGxvd3MgeW91IHRvIHBsb3QsIGZvciBlYWNoIGNlbGwgKGNvbHVtbnMpIHRoZSBhc3NpZ25tZW50IHNjb3JlIAood2hpY2ggY2FuIGJlIHRob3VnaHQgb2YgYXMgYSBwcm9iYWJpbGl0eSkgb2YgdGhhdCBjZWxsIGJlbG9uZ2luZyB0byBlYWNoIG9mIAp0aGUgcmVmZXJlbmNlIGxhYmVsIGNhdGVnb3JpZXMgKHJvd3MpLgoKYGBge3IsZXZhbD1GQUxTRX0KZ2cgPC0gcGxvdFNjb3JlSGVhdG1hcChwcmVkLmxvd1Jlc1sxOjIwLF0pCmdnCmBgYAoKSW5zcGVjdCB0aGUgcmVzdWx0cy4KCkZpbmFsbHksIHdlIGNhbiB1c2UgdGhlc2UgYXNzaWdubWVudCBzY29yZSB0byBmaWx0ZXIgb3V0IGNlbGxzIHRoYXQgY291bGQgbm90IGJlCnVuYW1iaWd1b3VzbHkgYXNzaWduZWQgdG8gb25lIGNlbGwgdHlwZSwgaS5lLiwgb25seSByZXBvcnQgdGhvc2UgY2VsbHMgdGhhdCB3ZQp3ZXJlIGFibGUgdG8gcmVsaWFibHkgYXNzaWduOgoKYGBge3IsZXZhbD1GQUxTRX0Kc3VtbWFyeShpcy5uYShwcmVkLmxvd1JlcyRwcnVuZWQubGFiZWxzKSkKCnJhbmdlKHJvd01heHMocHJlZC5sb3dSZXMkc2NvcmVzKSkgIyBhbGwgYXNzaWdubWVudHMKcmFuZ2Uocm93TWF4cyhwcmVkLmxvd1JlcyRzY29yZXNbIWlzLm5hKHByZWQubG93UmVzJHBydW5lZC5sYWJlbHMpLF0pKSAjIHJlbGlhYmxlIGFzc2lnbm1lbnRzCgp0YWJsZShzY2VfOTAwJGNsdXN0ZXJfbG93UmVzWyFpcy5uYShwcmVkLmxvd1JlcyRwcnVuZWQubGFiZWxzKV0sIAogICAgICBwcmVkLmxvd1JlcyRsYWJlbHNbIWlzLm5hKHByZWQubG93UmVzJHBydW5lZC5sYWJlbHMpXSkKYGBgCgpXZSB3aWxsIGludGVycHJldCB0aGUgY29uY29yZGFuY2UgYmV0d2VlbiB0aGUgcHJlZGljdGVkIGFuZCB0aGUKb3JpZ2luYWwgbGFiZWxzIG9uIHRoaXMgc3Vic2V0LiBXZSBvYnNlcnZlIGEgc3Ryb25nIGNvcnJlc3BvbmRlbmNlIGJldHdlZW4gdGhlIApwcmVkaWN0ZWQgbGFiZWxzIGFuZCB0aGUgbGFiZWxzIGZyb20gTWFjb2tzbyAqZXQgYWwuKiBXZSBjYW4gcmVhZCB0aGlzIHRhYmxlIAphcyBmb2xsb3dzOgoKLSBBbG1vc3QgYWxsIGFtYWNyaW5lIGNlbGxzIG9mIHRoZSBNYWNvc2tvIGRhdGFzZXQgYXJlIGNvcnJlY3RseSBwcmVkaWN0ZWQgYXMKYW1hY3JpbmUgY2VsbHMgKDIwMzYvKDIwMzYrNysxKzQxKzEpIMKxPSA5OCUgY29ycmVjdGx5IGFzc2lnbmVkKS4KClRyeSB0byBpbnRlcnByZXQgdGhlIHJlc3VsdHMgZm9yIHRoZSBvdGhlciBjZWxsIHR5cGVzLgoKV2UgY2FuIG5vdyBhbHNvIHZpc3VhbGl6ZSB0aGUgcHJlZGljdGVkIGxhYmVscyBhbmQgdGhlIG9yaWdpbmFsIGxhYmVscyBvbiBvdXIKdC1TTkUuCgpgYGB7cixldmFsPUZBTFNFfQpzY2VfOTAwJFNpbmdsZVJfbG93UmVzIDwtIHByZWQubG93UmVzJGxhYmVscwoKIyBvdXIgbG93IHJlc29sdXRpb24gbGFiZWxzIGJhc2VkIG9uIHJlZmVyZW5jZQpwbG90VFNORSguLi4sCiAgICAgICAgIGNvbG91cl9ieSA9IC4uLiwKICAgICAgICAgdGV4dF9ieSA9IC4uLiwKICAgICAgICAgdGV4dF9zaXplID0gLi4uKQoKIyBsb3cgcmVzb2x1dGlvbiBsYWJlbHMgb2YgdGhlIGF1dGhvcnMKcGxvdFRTTkUoLi4uLAogICAgICAgICBjb2xvdXJfYnkgPSAuLi4sCiAgICAgICAgIHRleHRfYnkgPSAuLi4sCiAgICAgICAgIHRleHRfc2l6ZSA9IC4uLikKYGBgCgpJbnRlcnByZXQgdGhlIHZpc3VhbGl6YXRpb25zLgoKKipBbHRvZ2V0aGVyLCBsYWJlbC10cmFuc2ZlciB3YXMgcXVpdGUgc3VjY2Vzc2Z1bCwgYW5kIHdlIHdvdWxkIGhhdmUgYmVlbiBhYmxlKioKKip0byB2ZXJ5IHF1aWNrbHkgZ2V0IGhpZ2gtcXVhbGl0eSByZXN1bHRzIHVzaW5nIHRoaXMgdmVyeSB1c2VyLWZyaWVuZGx5IGFuZCoqIAoqKmZhc3QgYXBwcm9hY2ggaW1wbGVtZW50ZWQgaW4gdGhlIGBTaW5nbGVSYCBwYWNrYWdlLioqCgojIyMgQWRkZW5kdW06IGBTaW5nbGVSYCBhdCBoaWdoIHJlZmVyZW5jZSByZXNvbHV0aW9uCgpGb3IgdGhlIHNha2Ugb2YgY29tcGxldGVuZXNzLCB3ZSBtYXkgYWxzbyBwZXJmb3JtIGxhYmVsIHRyYW5zZmVyIHdpdGggYFNpbmdsZVJgCnVzaW5nIHRoZSBtb3JlIGZpbmUtZ3JhaW5lZCBsYWJlbHMgZnJvbSB0aGUgcmVmZXJlbmNlIGRhdGFzZXQuCgpgYGB7cixldmFsPUZBTFNFfQouLi4KYGBgCgo=</div>
<div class="footer">
    <hr>
    This work is licensed under the <a href= "https://creativecommons.org/licenses/by-nc-sa/4.0">
    CC BY-NC-SA 4.0</a> licence.
</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("lab3_macoskoTemplate.Rmd");
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
