<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Koen Van den Berge and Jeroen Gilis" />


<title>Normalization, feature selection and dimension reduction for the Macosko dataset</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>


<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Single-cell course</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-chalkboard-teacher"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="introSequencingBulk.html">A brief introduction to sequencing technology</a>
    </li>
    <li>
      <a href="singleCellProtocols.html">Two popular single-cell protocols</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lab1_session.html">Lab 1</a>
    </li>
    <li>
      <a href="lab2_session.html">Lab 2</a>
    </li>
    <li>
      <a href="lab3_session.html">Lab 3</a>
    </li>
    <li>
      <a href="lab4_session.html">Lab 4</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/statOmics/Rmd-website">
    <span class="fab fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://statomics.github.io/">statOmics</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Normalization, feature selection and dimension reduction for the Macosko dataset</h1>
<h4 class="author">Koen Van den Berge and Jeroen Gilis</h4>
<h4 class="date">30/11/2021</h4>

</div>


<div id="preamble-installation-of-bioconductor-libraries" class="section level1">
<h1><span class="header-section-number">1</span> Preamble: installation of Bioconductor libraries</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># install BiocManager package if not installed yet.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># BiocManager is the package installer for Bioconductor software.</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">requireNamespace</span>(<span class="st">&quot;BiocManager&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="kw">install.packages</span>(<span class="st">&quot;BiocManager&quot;</span>)</span></code></pre></div>
<pre><code>## Installing BiocManager [1.30.16] ...
##  OK [linked cache]</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># install packages if not yet installed.</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>pkgs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SingleCellExperiment&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3"></a>          <span class="st">&quot;ExperimentHub&quot;</span>,</span>
<span id="cb3-4"><a href="#cb3-4"></a>          <span class="st">&quot;edgeR&quot;</span>,</span>
<span id="cb3-5"><a href="#cb3-5"></a>          <span class="st">&quot;biomaRt&quot;</span>,</span>
<span id="cb3-6"><a href="#cb3-6"></a>          <span class="st">&quot;DropletUtils&quot;</span>, </span>
<span id="cb3-7"><a href="#cb3-7"></a>          <span class="st">&quot;scRNAseq&quot;</span>, </span>
<span id="cb3-8"><a href="#cb3-8"></a>          <span class="st">&quot;scater&quot;</span>, </span>
<span id="cb3-9"><a href="#cb3-9"></a>          <span class="st">&quot;scuttle&quot;</span>, </span>
<span id="cb3-10"><a href="#cb3-10"></a>          <span class="st">&quot;scran&quot;</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>          <span class="st">&quot;scry&quot;</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>          <span class="st">&quot;BiocSingular&quot;</span>, </span>
<span id="cb3-13"><a href="#cb3-13"></a>          <span class="st">&quot;scDblFinder&quot;</span>,</span>
<span id="cb3-14"><a href="#cb3-14"></a>          <span class="st">&quot;glmpca&quot;</span>,</span>
<span id="cb3-15"><a href="#cb3-15"></a>          <span class="st">&quot;PCAtools&quot;</span>,</span>
<span id="cb3-16"><a href="#cb3-16"></a>          <span class="st">&quot;Seurat&quot;</span>)</span>
<span id="cb3-17"><a href="#cb3-17"></a>notInstalled &lt;-<span class="st"> </span>pkgs[<span class="op">!</span>pkgs <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()[,<span class="dv">1</span>]]</span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="cf">if</span>(<span class="kw">length</span>(notInstalled) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){</span>
<span id="cb3-19"><a href="#cb3-19"></a>  BiocManager<span class="op">::</span><span class="kw">install</span>(notInstalled)</span>
<span id="cb3-20"><a href="#cb3-20"></a>}</span></code></pre></div>
<pre><code>## &#39;getOption(&quot;repos&quot;)&#39; replaces Bioconductor standard repositories, see
## &#39;?repositories&#39; for details
## 
## replacement repositories:
##     CRAN: https://cran.rstudio.com</code></pre>
<pre><code>## Bioconductor version 3.14 (BiocManager 1.30.16), R 4.1.2 (2021-11-01)</code></pre>
<pre><code>## Installing package(s) &#39;BiocVersion&#39;, &#39;SingleCellExperiment&#39;, &#39;ExperimentHub&#39;,
##   &#39;edgeR&#39;, &#39;biomaRt&#39;, &#39;DropletUtils&#39;, &#39;scRNAseq&#39;, &#39;scater&#39;, &#39;scuttle&#39;, &#39;scran&#39;,
##   &#39;scry&#39;, &#39;BiocSingular&#39;, &#39;scDblFinder&#39;, &#39;glmpca&#39;, &#39;PCAtools&#39;, &#39;Seurat&#39;</code></pre>
<pre><code>## also installing the dependencies &#39;bit&#39;, &#39;sys&#39;, &#39;formatR&#39;, &#39;rjson&#39;, &#39;fs&#39;, &#39;GenomeInfoDbData&#39;, &#39;zlibbioc&#39;, &#39;bit64&#39;, &#39;blob&#39;, &#39;memoise&#39;, &#39;plogr&#39;, &#39;DT&#39;, &#39;generics&#39;, &#39;tidyselect&#39;, &#39;assertthat&#39;, &#39;askpass&#39;, &#39;lambda.r&#39;, &#39;futile.options&#39;, &#39;GenomicAlignments&#39;, &#39;restfulr&#39;, &#39;bitops&#39;, &#39;Rhtslib&#39;, &#39;cpp11&#39;, &#39;rprojroot&#39;, &#39;gtools&#39;, &#39;caTools&#39;, &#39;sass&#39;, &#39;jquerylib&#39;, &#39;MatrixGenerics&#39;, &#39;Biobase&#39;, &#39;GenomeInfoDb&#39;, &#39;XVector&#39;, &#39;RSQLite&#39;, &#39;interactiveDisplayBase&#39;, &#39;dplyr&#39;, &#39;dbplyr&#39;, &#39;DBI&#39;, &#39;filelock&#39;, &#39;KEGGREST&#39;, &#39;hms&#39;, &#39;prettyunits&#39;, &#39;openssl&#39;, &#39;futile.logger&#39;, &#39;snow&#39;, &#39;sparseMatrixStats&#39;, &#39;rhdf5filters&#39;, &#39;R.oo&#39;, &#39;R.methodsS3&#39;, &#39;sitmo&#39;, &#39;AnnotationFilter&#39;, &#39;rtracklayer&#39;, &#39;Rsamtools&#39;, &#39;ProtGenerics&#39;, &#39;Biostrings&#39;, &#39;RCurl&#39;, &#39;BiocIO&#39;, &#39;RcppHNSW&#39;, &#39;beeswarm&#39;, &#39;vipor&#39;, &#39;data.table&#39;, &#39;plyr&#39;, &#39;globals&#39;, &#39;listenv&#39;, &#39;parallelly&#39;, &#39;zoo&#39;, &#39;htmlwidgets&#39;, &#39;tidyr&#39;, &#39;lazyeval&#39;, &#39;crosstalk&#39;, &#39;purrr&#39;, &#39;promises&#39;, &#39;here&#39;, &#39;gplots&#39;, &#39;RcppArmadillo&#39;, &#39;httpuv&#39;, &#39;xtable&#39;, &#39;fontawesome&#39;, &#39;sourcetools&#39;, &#39;later&#39;, &#39;commonmark&#39;, &#39;bslib&#39;, &#39;cachem&#39;, &#39;spatstat.data&#39;, &#39;spatstat.utils&#39;, &#39;spatstat.sparse&#39;, &#39;abind&#39;, &#39;tensor&#39;, &#39;goftest&#39;, &#39;deldir&#39;, &#39;polyclip&#39;, &#39;FNN&#39;, &#39;RSpectra&#39;, &#39;SummarizedExperiment&#39;, &#39;S4Vectors&#39;, &#39;BiocGenerics&#39;, &#39;GenomicRanges&#39;, &#39;DelayedArray&#39;, &#39;AnnotationHub&#39;, &#39;BiocFileCache&#39;, &#39;curl&#39;, &#39;rappdirs&#39;, &#39;limma&#39;, &#39;locfit&#39;, &#39;Rcpp&#39;, &#39;XML&#39;, &#39;AnnotationDbi&#39;, &#39;progress&#39;, &#39;httr&#39;, &#39;xml2&#39;, &#39;IRanges&#39;, &#39;BiocParallel&#39;, &#39;DelayedMatrixStats&#39;, &#39;HDF5Array&#39;, &#39;rhdf5&#39;, &#39;R.utils&#39;, &#39;dqrng&#39;, &#39;beachmat&#39;, &#39;Rhdf5lib&#39;, &#39;BH&#39;, &#39;ensembldb&#39;, &#39;GenomicFeatures&#39;, &#39;gridExtra&#39;, &#39;BiocNeighbors&#39;, &#39;ggbeeswarm&#39;, &#39;viridis&#39;, &#39;Rtsne&#39;, &#39;ggrepel&#39;, &#39;igraph&#39;, &#39;statmod&#39;, &#39;bluster&#39;, &#39;metapod&#39;, &#39;ScaledMatrix&#39;, &#39;irlba&#39;, &#39;rsvd&#39;, &#39;xgboost&#39;, &#39;cowplot&#39;, &#39;reshape2&#39;, &#39;fitdistrplus&#39;, &#39;future&#39;, &#39;future.apply&#39;, &#39;ggridges&#39;, &#39;ica&#39;, &#39;leiden&#39;, &#39;lmtest&#39;, &#39;matrixStats&#39;, &#39;miniUI&#39;, &#39;patchwork&#39;, &#39;pbapply&#39;, &#39;plotly&#39;, &#39;png&#39;, &#39;RANN&#39;, &#39;RcppAnnoy&#39;, &#39;reticulate&#39;, &#39;ROCR&#39;, &#39;scattermore&#39;, &#39;sctransform&#39;, &#39;SeuratObject&#39;, &#39;shiny&#39;, &#39;spatstat.core&#39;, &#39;spatstat.geom&#39;, &#39;uwot&#39;, &#39;RcppEigen&#39;, &#39;RcppProgress&#39;</code></pre>
<pre><code>## 
##   There are binary versions available but the source versions are later:
##          binary   source needs_compilation
## httpuv    1.6.3    1.6.4              TRUE
## BH     1.75.0-0 1.78.0-0             FALSE
## igraph    1.2.9   1.2.10              TRUE
## 
## 
## The downloaded binary packages are in
##  /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T//RtmpDprmjP/downloaded_packages</code></pre>
<pre><code>## installing the source packages &#39;GenomeInfoDbData&#39;, &#39;httpuv&#39;, &#39;BH&#39;, &#39;igraph&#39;, &#39;scRNAseq&#39;</code></pre>
<pre><code>## Old packages: &#39;crayon&#39;, &#39;digest&#39;, &#39;glue&#39;, &#39;knitr&#39;, &#39;lattice&#39;, &#39;lifecycle&#39;,
##   &#39;mgcv&#39;, &#39;mime&#39;, &#39;nlme&#39;, &#39;pillar&#39;, &#39;rlang&#39;, &#39;rmarkdown&#39;, &#39;stringi&#39;, &#39;tibble&#39;,
##   &#39;tinytex&#39;, &#39;withr&#39;, &#39;xfun&#39;, &#39;Matrix&#39;</code></pre>
</div>
<div id="the-macosko-dataset" class="section level1">
<h1><span class="header-section-number">2</span> The Macosko dataset</h1>
<p>In this workshop session, we will analyze the single-cell RNA-seq dataset from the publication by Macosko <em>et al.</em>, Cell 161, 1202–1214 from 2015 <a href="https://doi.org/10.1016/j.cell.2015.05.002">(link)</a>. This is the manuscript in which the droplet scRNA-seq technology <strong>Drop-seq</strong> was introduced. Six years after the original publication, drop-seq is still one of the most commonly adopted scRNA-seq protocols, as evidenced by the large number of citations for Macosko <em>et al.</em> (4.303 citations at November 3, 2021).</p>
<p>The basic idea behind the Drop-seq protocol can be taken from the graphical abstract of the publication.</p>
<pre><code>knitr::include_graphics(&quot;macosko_graphicalAbstract.jpeg&quot;)</code></pre>
<p>The success of Drop-seq can be explained by the following advantageous features:</p>
<ul>
<li><p>The use of unique molecular identifiers (UMIs). By working with UMIs, one count corresponds to one observed mRNA molecule present in the cell. Thanks to the use of UMI barcodes, PCR artifacts are reduced.</p></li>
<li><p>Scalability: microfluidics technology allows for performing the library prep reactions inside nanodroplets, in which single cells may be contained. Library prep occurs across all droplets simultaneously.</p></li>
<li><p>Cost: the experiment costs around 6.5 cents (USD) per cell.</p></li>
<li><p>Speed: The very large dataset that we will be working with today was generated in an experiment that took only 4 days.</p></li>
</ul>
<p>In this particular experiment, Macosko <em>et al.</em> sequenced 49,300 cells from the mouse retina, identifying 39 transcriptionally distinct cell populations. The experiment was performed in 7 batches.</p>
</div>
<div id="data-availability" class="section level1">
<h1><span class="header-section-number">3</span> Data availability</h1>
<div id="sra" class="section level2">
<h2><span class="header-section-number">3.1</span> SRA</h2>
<p>The <a href="https://www.ncbi.nlm.nih.gov/sra">Sequence Read Archive (SRA)</a> is the largest publicly available repository of high-throughput sequencing data. The data are stored by the National Center for Biotechnology Information (NCBI) services and multiple cloud storage providers. From this website “raw” sequencing data can be retrieved. In practice, these are usually <code>.sra</code> files, which can be downloaded and converted into FASTQ files using functions from the <code>sratoolkit</code> software.</p>
<p>For our dataset, the FASTQ data can be retrieved from this <a href="https://www.ncbi.nlm.nih.gov/Traces/study/?acc=PRJNA267857&amp;o=acc_s%3Aa">link</a>. The data are stored as one file per sequencing batch, with each file approximately 20Gb. As such, it will be unfeasible to download and process these FASTQ files in this practical session.</p>
<p>Instead, for demonstrative purposes, we have taken a subsample of the FASTQ file for the first sequencing batch for you to work with. On this subsample, we may perform all the tasks that we would have performed on the full dataset. The steps that are required for downloading and quantifying drop-seq data can be found in <a href="https://github.com/statOmics/singleCellCourse/blob/master/lab1_preprocessing/preprocessDropseq.sh">a Shell script on our companion GitHub repository</a>.</p>
</div>
<div id="geo" class="section level2">
<h2><span class="header-section-number">3.2</span> GEO</h2>
<p>The dataset from Macosko <em>et al.</em> was also uploaded by the authors on the Gene Expression Omnibus (GEO) platform under accession number <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE63472">GSE63472</a>, from which raw and readily-processed data files may be retrieved, including:</p>
<ol style="list-style-type: decimal">
<li><p><em>GSE63472_RAW.tar</em>, a 90.6Gb object that contains the “raw data” for the experiment. In the scRNA-seq context, FASTQ files are often considered the raw data format.</p></li>
<li><p><em>GSE63472_P14Retina_merged_digital_expression.txt.gz</em>, a 50.7Mb matrix that stores the gene expression values for each cell. These values are integer counts, that did not undergo any type of preprocessing or normalization.</p></li>
<li><p><em>GSE63472_mm10_reference_metadata.tar.gz</em>, a 862.9Mb compressed folder containing information on the reference genome to which the scRNA-seq reads were aligned (see theory slides).</p></li>
<li><p><em>GSE63472_P14Retina_logDGE.txt.gz</em>, a 316.8Mb compressed text file, not clear what it contains (results from a differential gene expression analysis, but with log-transformation, so log-fold changes maybe?).</p></li>
</ol>
<p>As such, by downloading <em>GSE63472_P14Retina_merged_digital_expression.txt.gz</em>, we avoid re-quantifying the data, i.e., the translation from reads from the FASTQ files into a gene-level expression values for each cell.</p>
<p>One issue that often arises from data downloaded from GEO, is that there is no strict requirements for which data should be included in the upload by the authors. As such, from my personal experience, it can often be the case that important information like metadata are missing, or the content of the submitted files is unclear. Even if all the required data are available, as is the case here, we would still need to piece all the information together from different files and file formats before we can use them.</p>
</div>
<div id="experimenthub" class="section level2">
<h2><span class="header-section-number">3.3</span> ExperimentHub</h2>
<p>The Bioconductor <em>ExperimentHub</em> web resource, which can be accessed using the <a href="https://bioconductor.org/packages/release/bioc/html/ExperimentHub.html">ExperimentHub</a> R package, provides a central location where curated data from experiments, publications or training courses can be accessed. While it contains far less datasets than the SRA or GEO (4965 records to date), these datasets all follow the tidy data format of Bioconductor. Note that the ExperimentHub contains several types of data, like bulk and single-cell transcriptomics data, microarrays and more.</p>
<p>The Macosko dataset is available from ExperimentHub and can be accessed as follows:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">library</span>(ExperimentHub)</span>
<span id="cb12-2"><a href="#cb12-2"></a>edb &lt;-<span class="st"> </span><span class="kw">ExperimentHub</span>()</span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a>edb[<span class="kw">grep</span>(<span class="st">&quot;Macosko&quot;</span>, edb<span class="op">$</span>title)] <span class="co"># find accession number (can be inefficient)</span></span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a>edb_counts &lt;-<span class="st"> </span>edb[[<span class="st">&quot;EH2690&quot;</span>]]</span>
<span id="cb12-7"><a href="#cb12-7"></a>edb_counts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb12-8"><a href="#cb12-8"></a></span>
<span id="cb12-9"><a href="#cb12-9"></a>edb_coldata &lt;-<span class="st"> </span>edb[[<span class="st">&quot;EH2691&quot;</span>]]</span>
<span id="cb12-10"><a href="#cb12-10"></a>edb_coldata[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,]</span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="kw">rm</span>(edb, edb_counts, edb_coldata)</span></code></pre></div>
</div>
<div id="scrnaseq" class="section level2">
<h2><span class="header-section-number">3.4</span> scRNASeq</h2>
<p>In addition to ExperimentHub, Bioconductor provides the package <a href="https://bioconductor.org/packages/release/data/experiment/html/scRNAseq.html">scRNAseq</a>. This package provides an even more user-friendly client to access (only) scRNA-seq datasets from the ExperimentHub web resource. Data retrieved using the scRNAseq package are stored as user-friendly <code>SingleCellExperiment</code> objects, with the expression data, gene-level information, cell-level information and experiment metadata all in place in one data object. The scRNA-seq package currently holds 61 datasets, including the data from <em>Macosko et al.</em>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb13-2"><a href="#cb13-2"></a>scRNAseq<span class="op">::</span><span class="kw">MacoskoRetinaData</span>()</span></code></pre></div>
</div>
</div>
<div id="import-data" class="section level1">
<h1><span class="header-section-number">4</span> Import data</h1>
<p>The <code>scRNAseq</code> package provides convenient access to several datasets. See the <a href="http://bioconductor.org/packages/release/data/experiment/html/scRNAseq.html">package Bioconductor page</a> for more information.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Code below might ask you to create an ExperimentHub directory. </span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co"># Type &#39;yes&#39; and hit Enter, to allow this.</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(scRNAseq))</span>
<span id="cb14-4"><a href="#cb14-4"></a>sce &lt;-<span class="st"> </span><span class="kw">MacoskoRetinaData</span>()</span></code></pre></div>
</div>
<div id="a-singlecellexperiment-object" class="section level1">
<h1><span class="header-section-number">5</span> A <code>SingleCellExperiment</code> object</h1>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>sce</span></code></pre></div>
<div id="accessing-data-from-a-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.1</span> Accessing data from a <code>SingleCellExperiment</code> object</h2>
<p>Please see <a href="http://bioconductor.org/books/release/OSCA/data-infrastructure.html">Figure 4.1 in OSCA</a> for an overview of a <code>SingleCellExperiment</code> object.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Data: assays</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">assays</span>(sce)</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="kw">assays</span>(sce)<span class="op">$</span>counts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co"># Feature metadata: rowData</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">rowData</span>(sce) <span class="co"># empty for now</span></span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co"># Cell metadata: colData</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="kw">colData</span>(sce)</span>
<span id="cb16-10"><a href="#cb16-10"></a></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co"># Reduced dimensions: reducedDims</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="kw">reducedDims</span>(sce) <span class="co"># empty for now</span></span></code></pre></div>
</div>
<div id="creating-a-new-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.2</span> Creating a new <code>SingleCellExperiment</code> object</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>sceNew &lt;-<span class="st"> </span><span class="kw">SingleCellExperiment</span>(<span class="dt">assays =</span> <span class="kw">list</span>(<span class="dt">counts =</span> <span class="kw">assays</span>(sce)<span class="op">$</span>counts))</span>
<span id="cb17-2"><a href="#cb17-2"></a>sceNew</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="kw">rm</span>(sceNew)</span></code></pre></div>
</div>
<div id="storing-metadata-in-a-singlecellexperiment-object" class="section level2">
<h2><span class="header-section-number">5.3</span> Storing (meta)data in a <code>SingleCellExperiment</code> object</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>fakeGeneNames &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;gene&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sce))</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">rowData</span>(sce)<span class="op">$</span>fakeName &lt;-<span class="st"> </span>fakeGeneNames</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce))</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co"># Remove again by setting to NULL</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="kw">rowData</span>(sce)<span class="op">$</span>fakeName &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts &lt;-<span class="st"> </span><span class="kw">log1p</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts)</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="kw">assays</span>(sce)</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="kw">assays</span>(sce)<span class="op">$</span>logCounts &lt;-<span class="st"> </span><span class="ot">NULL</span></span></code></pre></div>
</div>
</div>
<div id="obtaining-and-including-rowdata" class="section level1">
<h1><span class="header-section-number">6</span> Obtaining and including rowData</h1>
<p>The <code>rowData</code> slot of a <code>SingleCellExperiment</code> object allows for storing information on the features, i.e. the genes, in a dataset. In our object, the <code>rowData</code> slot is empty.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">rowData</span>(sce)</span></code></pre></div>
<p>As such, the only information we have on the genes are their names, which can be retrieved as the <code>rownames</code> of the expression matrix.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">head</span>(<span class="kw">rownames</span>(sce))</span></code></pre></div>
<p>These are the gene names (symbols). Note that it may be useful to include additional information in the <code>rowData</code> slot. For instance, we may want to store:</p>
<ul>
<li>Unambiguous gene identifiers (e.g. from ENSEMBL)</li>
<li>On which chromosome the gene is located</li>
<li>Gene length (genomic start position and end position)</li>
<li>Others…</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">library</span>(<span class="st">&quot;biomaRt&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a>ensembl75 &lt;-<span class="st"> </span><span class="kw">useEnsembl</span>(<span class="dt">biomart =</span> <span class="st">&#39;genes&#39;</span>, </span>
<span id="cb21-4"><a href="#cb21-4"></a>                        <span class="dt">dataset =</span> <span class="st">&#39;mmusculus_gene_ensembl&#39;</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>                        <span class="dt">version =</span> <span class="dv">75</span>)</span>
<span id="cb21-6"><a href="#cb21-6"></a></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="kw">head</span>(<span class="kw">listAttributes</span>(ensembl75)) <span class="co"># potential info to extract</span></span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a>geneInfo &lt;-<span class="st"> </span><span class="kw">getBM</span>(<span class="dt">attributes =</span> <span class="kw">c</span>(<span class="st">&quot;ensembl_gene_id&quot;</span>, <span class="co"># ENSEMBL unambiguous identifier</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>                                 <span class="st">&quot;mgi_symbol&quot;</span>, <span class="co"># Gene symbol (to link with SCE rownames),</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>                                 <span class="st">&quot;chromosome_name&quot;</span>, <span class="co"># On which chromosome</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>                                 <span class="st">&quot;start_position&quot;</span>, <span class="co"># Start position</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>                                 <span class="st">&quot;end_position&quot;</span>),<span class="co"># End position</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>                  <span class="dt">mart =</span> ensembl75)</span>
<span id="cb21-15"><a href="#cb21-15"></a></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="kw">head</span>(geneInfo)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>geneInfo<span class="op">$</span>mgi_symbol_upper &lt;-<span class="st"> </span><span class="kw">toupper</span>(geneInfo<span class="op">$</span>mgi_symbol) </span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co"># match between gene info and rownames</span></span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="kw">sum</span>(<span class="kw">rownames</span>(sce) <span class="op">%in%</span><span class="st"> </span>geneInfo<span class="op">$</span>mgi_symbol_upper)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="kw">sum</span>(<span class="op">!</span><span class="kw">rownames</span>(sce) <span class="op">%in%</span><span class="st"> </span>geneInfo<span class="op">$</span>mgi_symbol_upper) <span class="co"># lost in conversion :(</span></span>
<span id="cb22-6"><a href="#cb22-6"></a></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="kw">rowData</span>(sce) &lt;-<span class="st"> </span>geneInfo[<span class="kw">match</span>(<span class="kw">rownames</span>(sce),geneInfo<span class="op">$</span>mgi_symbol_upper),]</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">head</span>(<span class="kw">rowData</span>(sce))</span></code></pre></div>
</div>
<div id="filtering-non-informative-genes" class="section level1">
<h1><span class="header-section-number">7</span> Filtering non-informative genes</h1>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">library</span>(edgeR)</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co"># A very simple strategy: remove all genes that are expressed in less than 10</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co"># out of 49300 cells -&gt; note that this a very lenient filtering criterium</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>keep &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="kw">table</span>(keep)</span>
<span id="cb24-7"><a href="#cb24-7"></a></span>
<span id="cb24-8"><a href="#cb24-8"></a>sce &lt;-<span class="st"> </span>sce[keep,]</span></code></pre></div>
<p>Note that dedicated functions for filtering out lowly expressed genes exist. One such function is the <code>filterByExpr</code> function of the edgeR R package. In brief, the strategy keeps genes that have at least “min.count” reads in a worthwhile number samples.</p>
<p>More precisely, the filtering keeps genes that have count-per-million (CPM) above k in n samples.</p>
<p>k is determined by the min.count argument to the function, and by the sample library sizes.</p>
<p>n is determined by the design matrix. n can be seen as the smallest group sample size. A <code>group</code> of samples/cells can be defined as cells that are more similar to one another, e.g., from the same sequencing batch, the same patient…. Here we could also use the cluster assignment (cell type) for each cell as the grouping variable; <em>note however, that this usually is not available until a</em> <em>later stage in the analysis pipeline</em> (i.e., after dimension reduction and clustering, topics we will cover next session.)</p>
<p>If all the group sizes are larger than the <code>large.n</code> argument of the filterByExpr function, which defaults to 10, then n will be taken as <code>min.prop</code>* the the number of samples/cells in the smallest group.</p>
<p>Note that all the group sizes will often be larger than the <code>large.n</code> in case of single-cell data.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Slow (more than 1min) -&gt; do not run</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="co"># keep2 &lt;- filterByExpr(sce,</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">#                       group = sce$cluster,</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co">#                       min.count = 1,</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co">#                       min.total.count = 15,</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co">#                       min.prop = 0.2)</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co"># table(keep2)</span></span></code></pre></div>
</div>
<div id="quality-control" class="section level1">
<h1><span class="header-section-number">8</span> Quality control</h1>
<p>In quality control (QC), we check the quality of our dataset. In particular, we investigate undesirable oddities, such as low-quality cells, empty droplets or doublets.</p>
<div id="identifying-and-removing-low-quality-cells" class="section level2">
<h2><span class="header-section-number">8.1</span> Identifying and removing low-quality cells</h2>
<p>There are several distinguishing features of low-quality cells that can be used in order to identify them. <a href="http://bioconductor.org/books/3.14/OSCA.basic/quality-control.html">As described in the OSCA book</a> book):</p>
<ol style="list-style-type: decimal">
<li><p>The library size is defined as the total sum of counts across all relevant features for each cell. Here, we will consider the relevant features to be the endogenous genes. Cells with small library sizes are of low quality as the RNA has been lost at some point during library preparation, either due to cell lysis or inefficient cDNA capture and amplification.</p></li>
<li><p>The number of expressed features in each cell is defined as the number of endogenous genes with non-zero counts for that cell. Any cell with very few expressed genes is likely to be of poor quality as the diverse transcript population has not been successfully captured.</p></li>
<li><p>We sometimes have spike-in (ERCC) transcripts available. The proportion of reads mapped to spike-in transcripts is calculated relative to the total count across all features (including spike-ins) for each cell. As the same amount of spike-in RNA should have been added to each cell, any enrichment in spike-in counts is symptomatic of loss of endogenous RNA.</p></li>
<li><p>In the absence of spike-in transcripts, the proportion of reads mapped to genes in the mitochondrial genome can be used. High proportions are indicative of poor-quality cells (Islam et al. 2014; Ilicic et al. 2016), presumably because of loss of cytoplasmic RNA from perforated cells. The reasoning is that, in the presence of modest damage, the holes in the cell membrane permit efflux of individual transcript molecules but are too small to allow mitochondria to escape, leading to a relative enrichment of mitochondrial transcripts. For single-nuclei RNA-seq experiments, high proportions are also useful as they can mark cells where the cytoplasm has not been successfully stripped.</p></li>
</ol>
</div>
<div id="calculate-qc-variables" class="section level2">
<h2><span class="header-section-number">8.2</span> Calculate QC variables</h2>
<p>This function calculates useful QC metrics for identification and removal of potentially problematic cells. Default per-cell metrics are the sum of counts (i.e., the library size) and the number of detected features. The percentage of counts in the top features also provides a measure of library complexity.</p>
<p>If subsets is specified, these statistics are also computed for each subset of features. This is useful for investigating gene sets of interest, e.g., mitochondrial genes.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">library</span>(scater)</span>
<span id="cb26-2"><a href="#cb26-2"></a></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="co"># check ERCC spike-in transcripts</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="kw">sum</span>(<span class="kw">grepl</span>(<span class="st">&quot;^ERCC-&quot;</span>, <span class="kw">rownames</span>(sce))) <span class="co"># no spike-in transcripts available</span></span>
<span id="cb26-5"><a href="#cb26-5"></a></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co"># check mitochondrial genes</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="kw">sum</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>chromosome_name<span class="op">==</span><span class="st">&quot;MT&quot;</span>,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># 28 mitochondrial genes</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="kw">sum</span>(<span class="kw">grepl</span>(<span class="st">&quot;^MT-&quot;</span>, <span class="kw">rownames</span>(sce))) <span class="co"># alternatively</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>is.mito &lt;-<span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;^MT-&quot;</span>, <span class="kw">rownames</span>(sce))</span>
<span id="cb26-10"><a href="#cb26-10"></a></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="co">## calculate QC metrics</span></span>
<span id="cb26-12"><a href="#cb26-12"></a>df &lt;-<span class="st"> </span><span class="kw">perCellQCMetrics</span>(sce, <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mito=</span>is.mito))</span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="kw">head</span>(df)</span>
<span id="cb26-14"><a href="#cb26-14"></a></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="co"># add QC variables to sce object</span></span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="kw">colData</span>(sce) &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">colData</span>(sce), df)</span>
<span id="cb26-17"><a href="#cb26-17"></a></span>
<span id="cb26-18"><a href="#cb26-18"></a><span class="co"># the QC variables have now been added to the colData of our SCE object.</span></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="kw">head</span>(<span class="kw">colData</span>(sce))</span></code></pre></div>
</div>
<div id="exploratory-data-analysis" class="section level2">
<h2><span class="header-section-number">8.3</span> Exploratory data analysis</h2>
<p>In the figure below, we see that several cells have a very low number of expressed genes, and where most of the molecules are derived from mitochondrial genes. This indicates likely damaged cells, presumably because of loss of cytoplasmic RNA from perforated cells, so we should remove these for the downstream analysis.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Number of genes vs library size</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;sum&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;cluster&quot;</span>) </span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co"># Mitochondrial genes</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;detected&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>)</span></code></pre></div>
</div>
<div id="qc-using-adaptive-thresholds" class="section level2">
<h2><span class="header-section-number">8.4</span> QC using adaptive thresholds</h2>
<p>Below, we remove cells that are outlying with respect to</p>
<ol style="list-style-type: decimal">
<li>A low sequencing depth (number of UMIs);</li>
<li>A low number of genes detected;</li>
<li>A high percentage of reads from mitochondrial genes.</li>
</ol>
<p>Here we will remove cells for QC based on <strong>adaptive thresholds</strong> related to the three points from above. Adaptive trhesholds are used as opposed to <strong>fixed thresholds</strong>.</p>
<p>With fixed thresholds, we use fixed cut-off values for each cell to pass QC, e.g., we might consider cells to be low quality if they have library sizes below 100,000 reads; express fewer than 5,000 genes; have spike-in proportions above 10%; or have mitochondrial proportions above 10%.</p>
<p>With adaptive thresholds, we assume that most of the dataset consists of high-quality cells. We then identify cells that are outliers for the various QC metrics, based on the median absolute deviation (MAD) from the median value of each metric across all cells. By default, we consider a value to be anoutlier if it is more than 3 MADs from the median in the “problematic” direction. This is loosely motivated by the fact that such a filter will retain 99% of non-outlier values that follow a normal distribution. We demonstrate adopting adaptive thresholds on the Macosko dataset:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>lowLib &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>sum, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>, <span class="dt">log=</span><span class="ot">TRUE</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a>lowFeatures &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>detected, <span class="dt">type=</span><span class="st">&quot;lower&quot;</span>, <span class="dt">log=</span><span class="ot">TRUE</span>)</span>
<span id="cb28-3"><a href="#cb28-3"></a>highMito &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(df<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="kw">table</span>(lowLib)</span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="kw">table</span>(lowFeatures)</span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="kw">table</span>(highMito)</span>
<span id="cb28-8"><a href="#cb28-8"></a></span>
<span id="cb28-9"><a href="#cb28-9"></a>discardCells &lt;-<span class="st"> </span>(lowLib <span class="op">|</span><span class="st"> </span>lowFeatures <span class="op">|</span><span class="st"> </span>highMito)</span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="kw">table</span>(discardCells)</span>
<span id="cb28-11"><a href="#cb28-11"></a><span class="kw">colData</span>(sce)<span class="op">$</span>discardCells &lt;-<span class="st"> </span>discardCells</span>
<span id="cb28-12"><a href="#cb28-12"></a></span>
<span id="cb28-13"><a href="#cb28-13"></a><span class="co"># visualize cells to be removed</span></span>
<span id="cb28-14"><a href="#cb28-14"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;sum&quot;</span>, <span class="dt">y=</span><span class="st">&quot;detected&quot;</span>, <span class="dt">colour_by=</span><span class="st">&quot;discardCells&quot;</span>)</span>
<span id="cb28-15"><a href="#cb28-15"></a><span class="kw">plotColData</span>(sce, <span class="dt">x =</span> <span class="st">&quot;detected&quot;</span>, <span class="dt">y=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>, <span class="dt">colour_by =</span> <span class="st">&quot;discardCells&quot;</span>)</span></code></pre></div>
<p>We removed a total of <span class="math inline">\(3423\)</span> cells, most of which because of an outlyingly high percentage of reads from mitochondrial genes.</p>
</div>
<div id="identifying-and-removing-empty-droplets" class="section level2">
<h2><span class="header-section-number">8.5</span> Identifying and removing empty droplets</h2>
<p>Note that the removal of cells with low sequencing depth using the adaptive threshold procedure above is a way of removing empty droplets. Other approaches are possible, e.g., removing cells by statistical testing using <code>emtpyDrops</code>. This does require us to specify a lower bound on the total number of UMIs, below which all cells are considered to correspond to empty droplets. This lower bound may not be trivial to derive, but the <code>barcodeRanks</code> function can be useful to identify an elbow/knee point.</p>
<p>In brief, the steps taken by the <code>emtpyDrops</code> function can be summarized as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Define threshold T of total UMI counts (e.g. with the help of the <code>barcodeRanks</code> function), below which cells may be considered to be from empty droplets. Call this set of cells E.</p></li>
<li><p>Define <span class="math inline">\(A_g\)</span> as the total gene expression across all cells in E.</p></li>
<li><p>Define <span class="math inline">\(pi_g\)</span> as the relative contribution of gene g to the ambient profile.</p></li>
<li><p>Calculate p-value for each cell to have a transcriptional profile similar to the ambient solution. Intuitively, a p-value below the requested alpha level would correspond to a cell for which the observed count profile strongly deviates from the count profile observed in the cells with a library size below threshold T, i.e., a non-empty droplet.</p></li>
</ol>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">library</span>(DropletUtils)</span>
<span id="cb29-2"><a href="#cb29-2"></a>bcrank &lt;-<span class="st"> </span><span class="kw">barcodeRanks</span>(<span class="kw">counts</span>(sce))</span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co"># Only showing unique points for plotting speed. Duplicated ranks are a </span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="co"># consequence of ties in the ranks, i.e., when cells have an equal library size.</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="kw">sum</span>(<span class="kw">duplicated</span>(bcrank<span class="op">$</span>rank))</span>
<span id="cb29-7"><a href="#cb29-7"></a>uniq &lt;-<span class="st"> </span><span class="op">!</span><span class="kw">duplicated</span>(bcrank<span class="op">$</span>rank)</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="kw">plot</span>(bcrank<span class="op">$</span>rank[uniq], bcrank<span class="op">$</span>total[uniq], <span class="dt">log=</span><span class="st">&quot;xy&quot;</span>,</span>
<span id="cb29-10"><a href="#cb29-10"></a>    <span class="dt">xlab=</span><span class="st">&quot;Rank&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Total UMI count&quot;</span>, <span class="dt">cex.lab=</span><span class="fl">1.2</span>)</span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(bcrank)<span class="op">$</span>inflection, <span class="dt">col=</span><span class="st">&quot;darkgreen&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="kw">metadata</span>(bcrank)<span class="op">$</span>knee, <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">350</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lty=</span><span class="dv">2</span>) <span class="co"># picked visually myself</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>, </span>
<span id="cb29-15"><a href="#cb29-15"></a>       <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;Inflection&quot;</span>, <span class="st">&quot;Knee&quot;</span>, <span class="st">&quot;Empirical knee point&quot;</span>), </span>
<span id="cb29-16"><a href="#cb29-16"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;dodgerblue&quot;</span>, <span class="st">&quot;orange&quot;</span>), </span>
<span id="cb29-17"><a href="#cb29-17"></a>       <span class="dt">lty=</span><span class="dv">2</span>, </span>
<span id="cb29-18"><a href="#cb29-18"></a>       <span class="dt">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb29-19"><a href="#cb29-19"></a></span>
<span id="cb29-20"><a href="#cb29-20"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb29-21"><a href="#cb29-21"></a>limit &lt;-<span class="st"> </span><span class="dv">350</span>   </span>
<span id="cb29-22"><a href="#cb29-22"></a>all.out &lt;-<span class="st"> </span><span class="kw">emptyDrops</span>(<span class="kw">counts</span>(sce), <span class="dt">lower=</span>limit, <span class="dt">test.ambient=</span><span class="ot">TRUE</span>)</span>
<span id="cb29-23"><a href="#cb29-23"></a><span class="co"># p-values for cells with total UMI count under the lower bound.</span></span>
<span id="cb29-24"><a href="#cb29-24"></a><span class="kw">hist</span>(all.out<span class="op">$</span>PValue[all.out<span class="op">$</span>Total <span class="op">&lt;=</span><span class="st"> </span>limit <span class="op">&amp;</span><span class="st"> </span>all.out<span class="op">$</span>Total <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>],</span>
<span id="cb29-25"><a href="#cb29-25"></a>    <span class="dt">xlab=</span><span class="st">&quot;P-value&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">breaks=</span><span class="dv">20</span>)</span>
<span id="cb29-26"><a href="#cb29-26"></a></span>
<span id="cb29-27"><a href="#cb29-27"></a><span class="co"># but note that it would remove a very high number of cells</span></span>
<span id="cb29-28"><a href="#cb29-28"></a><span class="kw">length</span>(<span class="kw">which</span>(all.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.01</span>)) <span class="co"># retained</span></span>
<span id="cb29-29"><a href="#cb29-29"></a></span>
<span id="cb29-30"><a href="#cb29-30"></a><span class="co"># so we stick to the more lenient adaptive filtering strategy</span></span>
<span id="cb29-31"><a href="#cb29-31"></a><span class="co"># remove cells identified using adaptive thresholds</span></span>
<span id="cb29-32"><a href="#cb29-32"></a>sce &lt;-<span class="st"> </span>sce[, <span class="op">!</span><span class="kw">colData</span>(sce)<span class="op">$</span>discardCells]</span></code></pre></div>
</div>
<div id="identifying-and-removing-doublets" class="section level2">
<h2><span class="header-section-number">8.6</span> Identifying and removing doublets</h2>
<p>We will use <a href="https://bioconductor.org/packages/3.14/bioc/html/scDblFinder.html">scDblFinder</a> to detect doublet cells.</p>
<p>As discussed in the theory session of last week, the steps taken by <code>scDblFinder</code> can be summarized as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Perform principal components analysis (PCA) on log-normalized expression counts. This allows for projecting each cell in the dataset into a 2D space (for more details on PCA, see next weeks session).</p></li>
<li><p>Randomly select two cells, sum their counts and normalize, and project into PCA space from step 1. In other words, artificially generate doublets and see where they are located in the 2D space.</p></li>
<li><p>Repeat step 2 many times (generate many artificial doublets).</p></li>
<li><p>Generate neighbor network in the 2D space. The network is then used to estimate a number of characteristics for each cell, in particular the proportion f artificial doublets among the nearest neighbors.</p></li>
<li><p>Use this information, along with other predictors, to train a classifier (gradient boosted tree) that allows for distinguishing doublets from singlets.</p></li>
</ol>
<p>Note: only classifies for identifying doublets for which the two cells are from different cell type clusters.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co">## perform doublet detection</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="kw">library</span>(scDblFinder)</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">set.seed</span>(<span class="dv">211103</span>)</span>
<span id="cb31-2"><a href="#cb31-2"></a>sampleID &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(<span class="kw">strsplit</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cell.id, <span class="dt">split=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;[[&quot;</span>, <span class="dv">1</span>))</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="kw">table</span>(sampleID)</span>
<span id="cb31-4"><a href="#cb31-4"></a>sce &lt;-<span class="st"> </span><span class="kw">scDblFinder</span>(sce, </span>
<span id="cb31-5"><a href="#cb31-5"></a>                   <span class="dt">returnType=</span><span class="st">&quot;table&quot;</span>,</span>
<span id="cb31-6"><a href="#cb31-6"></a>                   <span class="dt">samples =</span> <span class="kw">factor</span>(sampleID))</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">table</span>(sce<span class="op">$</span>scDblFinder.class)</span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="co">## visualize these scores</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="co">## explore doublet score wrt original cluster labels</span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="kw">boxplot</span>(<span class="kw">log1p</span>(sce<span class="op">$</span>scDblFinder.score) <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster, <span class="dt">exclude=</span><span class="ot">NULL</span>))</span>
<span id="cb31-13"><a href="#cb31-13"></a></span>
<span id="cb31-14"><a href="#cb31-14"></a>tab &lt;-<span class="st"> </span><span class="kw">table</span>(sce<span class="op">$</span>scDblFinder.class, sce<span class="op">$</span>cluster, </span>
<span id="cb31-15"><a href="#cb31-15"></a>      <span class="dt">exclude=</span><span class="ot">NULL</span>)</span>
<span id="cb31-16"><a href="#cb31-16"></a>tab</span>
<span id="cb31-17"><a href="#cb31-17"></a><span class="kw">t</span>(<span class="kw">t</span>(tab) <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(tab))</span>
<span id="cb31-18"><a href="#cb31-18"></a></span>
<span id="cb31-19"><a href="#cb31-19"></a><span class="kw">barplot</span>(<span class="kw">t</span>(<span class="kw">t</span>(tab) <span class="op">/</span><span class="st"> </span><span class="kw">colSums</span>(tab))[<span class="dv">2</span>,],</span>
<span id="cb31-20"><a href="#cb31-20"></a>        <span class="dt">xlab =</span> <span class="st">&quot;Cluster&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Fraction of doublets&quot;</span>)</span>
<span id="cb31-21"><a href="#cb31-21"></a></span>
<span id="cb31-22"><a href="#cb31-22"></a><span class="kw">range</span>(sce<span class="op">$</span>scDblFinder.score[sce<span class="op">$</span>scDblFinder.class  <span class="op">==</span><span class="st"> &quot;doublet&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sampleID <span class="op">==</span><span class="st"> &quot;r1&quot;</span>])</span>
<span id="cb31-23"><a href="#cb31-23"></a><span class="kw">range</span>(sce<span class="op">$</span>scDblFinder.score[sce<span class="op">$</span>scDblFinder.class  <span class="op">==</span><span class="st"> &quot;singlet&quot;</span> <span class="op">&amp;</span><span class="st"> </span>sampleID <span class="op">==</span><span class="st"> &quot;r1&quot;</span>])</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># remove doublets</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>sce &lt;-<span class="st"> </span>sce[,<span class="op">!</span>sce<span class="op">$</span>scDblFinder.class <span class="op">==</span><span class="st"> &quot;doublet&quot;</span>]</span></code></pre></div>
</div>
</div>
<div id="normalization" class="section level1">
<h1><span class="header-section-number">9</span> Normalization</h1>
<p>Normalization aims to remove technical effects such as sequencing depth so that comparisons between cells are not confounded by them. The most commonly used normalization methods methods use scaling, where a scaling factor (also called size factor, normalization factor) is estimated for each cell. These scaling factors (e.g., the effective library size) can be included as an offset to downstream modeling procedures. This effectively allows for performing inference on the relative abundance of a gene in a cell, after accounting for library size and RNA composition differences between cells, which is much more relevant than comparing raw counts</p>
<p>Note that we always prefer the use of offsets over transformation of the data. In brief, such transformation would distort the mean-variance relationship in the data. For more details, we refer to the document that was discussed in theory session of last week (<a href="https://statomics.github.io/SGA21/sequencing_scalingNormalization.html">link</a>)</p>
<p>For normalization, the size factors <span class="math inline">\(s_i\)</span> computed here are simply scaled library sizes: <span class="math display">\[ N_i = \sum_g Y_{gi} \]</span> <span class="math display">\[ s_i = N_i / \bar{N}_i \]</span></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>sce &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce)</span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="co"># note we also returned log counts: see the additional logcounts assay.</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>sce</span>
<span id="cb33-5"><a href="#cb33-5"></a></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="co"># you can extract size factors using</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>sf &lt;-<span class="st"> </span><span class="kw">librarySizeFactors</span>(sce)</span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="kw">mean</span>(sf) <span class="co"># equal to 1 due to scaling.</span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="kw">plot</span>(<span class="dt">x=</span> <span class="kw">log</span>(<span class="kw">colSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts)), </span>
<span id="cb33-10"><a href="#cb33-10"></a>     <span class="dt">y=</span>sf)</span></code></pre></div>
<p>From the OSCA book: Alternatively, we may use more sophisticated approaches for variance stabilizing transformations in genomics data, e.g., <code>DESeq2</code> or <code>sctransform</code>. These aim to remove the mean-variance trend more effectively than the simpler transformations mentioned above, though it could be argued whether this is actually desirable. For low-coverage scRNA-seq data, there will always be a mean-variance trend under any transformation, for the simple reason that the variance must be zero when the mean count is zero. These methods also face the challenge of removing the mean-variance trend while preserving the interesting component of variation, i.e., the log-fold changes between subpopulations; this may or may not be done adequately, depending on the aggressiveness of the algorithm.</p>
<p>In practice, the log-transformation is a good default choice due to its simplicity and interpretability, and is what we will be using for all downstream analyses.</p>
<hr />
<p>— end lab session 1 —</p>
<hr />
<p>We have created a <a href="https://www.dropbox.com/sh/3yc9065ri76b2e7/AAAr0z9ZGp3APZ-reH6I0DGQa?dl=0">DropBox folder</a> containing convenience files, e.g., a preprocessed <code>SingleCellExperiment</code> that is the end result of lab session 1. You may want to downlaod them and import them in the code chunk below.</p>
</div>
<div id="normalization-continued" class="section level1">
<h1><span class="header-section-number">10</span> Normalization (continued)</h1>
<p>Normalization is necessary to correct for several sources of technical variation:</p>
<ul>
<li><strong>Differences in sequencing depth</strong> between samples. Some samples get sequenced deeper in the sense that they consist of more (mapped) reads and therefore can be considered to contain a higher amount of information, which we should be taking into account. In addition, if a sample is sequenced deeper, it is natural that the counts for each gene will be higher, jeopardizing a direct comparison of the expression counts.</li>
<li><strong>Differences in RNA population composition</strong> between samples. As an extreme example, suppose that two samples have been sequenced to the exact same depth. One sample is contaminated and has a very high concentration of the contaminant cDNA being sequenced, but otherwise the two samples are identical. Since the contaminant will be taking up a significant proportion of the reads being sequenced, the counts will not be directly comparable between the samples. Hence, we may also want to correct for differences in the composition of the RNA population of the samples (see <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf">edgeR manual chapter 2.8</a>).</li>
<li><strong>Other technical variation</strong> such as sample-specific GC-content or transcript length effects may also be accounted for.</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">table</span>(sce<span class="op">$</span>cluster)</span></code></pre></div>
<p>Below, we will visualize the normalization occurring between two cells of the same cell type (which could be considered technical repeats):</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>select &lt;-<span class="st"> </span>sce<span class="op">$</span>cluster <span class="op">==</span><span class="st"> &quot;1&quot;</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>select[<span class="kw">is.na</span>(select)] &lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>cs &lt;-<span class="st"> </span><span class="kw">colSums</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts[,select])</span>
<span id="cb35-4"><a href="#cb35-4"></a>cs[<span class="kw">order</span>(cs, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)][<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)]</span></code></pre></div>
<p>Let’s take a look at how comparable two cells (replicates) of cluster 1 are. We will compare the cell with the highest library size with the cell that has the 10th highest library size using MD-plots (mean-difference plots, as introduced by <a href="https://www.jstor.org/stable/24307038?seq=1#metadata_info_tab_contents">Dudoit et al. (2002)</a>), also sometimes referred to as MA-plots.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>targetCells &lt;-<span class="st"> </span><span class="kw">names</span>(cs[<span class="kw">order</span>(cs, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)][<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)])</span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a>M &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells])</span>
<span id="cb36-4"><a href="#cb36-4"></a>D &lt;-<span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells[<span class="dv">2</span>]] <span class="op">/</span><span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>counts[,targetCells[<span class="dv">1</span>]]</span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="kw">plot</span>(<span class="dt">x =</span> <span class="kw">log</span>(M), <span class="dt">y =</span> <span class="kw">log2</span>(D),</span>
<span id="cb36-6"><a href="#cb36-6"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb36-7"><a href="#cb36-7"></a>     <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Cell &quot;</span>, targetCells[<span class="dv">2</span>], <span class="st">&quot; vs cell &quot;</span>, targetCells[<span class="dv">1</span>]),</span>
<span id="cb36-8"><a href="#cb36-8"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Log mean&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Log2 fold-change&quot;</span>,</span>
<span id="cb36-9"><a href="#cb36-9"></a>     <span class="dt">bty =</span> <span class="st">&#39;l&#39;</span>)</span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p>We see clear bias in the comparison of the 1st and 10th most deeply sequenced cell from cell cluster 1. We see that the log fold-changes are biased downwards. This means that, on average, a gene is higher expressed in cell 1 versus cell 10. Looking at the library sizes, we can indeed see that the library size for cell 1 is 20869 counts, while it is only 14719 counts for cell 10! This is a clear library size effect that we should take into account.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># normalize the count data using the previously computed &quot;size factors&quot;</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="kw">assay</span>(sce, <span class="st">&quot;normed&quot;</span>) &lt;-<span class="st"> </span><span class="kw">normalizeCounts</span>(sce, </span>
<span id="cb37-3"><a href="#cb37-3"></a>                                        <span class="dt">log=</span><span class="ot">FALSE</span>,</span>
<span id="cb37-4"><a href="#cb37-4"></a>                                        <span class="dt">size.factors=</span>sf, </span>
<span id="cb37-5"><a href="#cb37-5"></a>                                        <span class="dt">pseudo.count=</span><span class="dv">0</span>)</span>
<span id="cb37-6"><a href="#cb37-6"></a></span>
<span id="cb37-7"><a href="#cb37-7"></a>M &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells])</span>
<span id="cb37-8"><a href="#cb37-8"></a>D &lt;-<span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells[<span class="dv">2</span>]] <span class="op">/</span><span class="st"> </span><span class="kw">assays</span>(sce)<span class="op">$</span>normed[,targetCells[<span class="dv">1</span>]]</span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="kw">plot</span>(<span class="dt">x =</span> <span class="kw">log</span>(M), <span class="dt">y =</span> <span class="kw">log2</span>(D),</span>
<span id="cb37-10"><a href="#cb37-10"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb37-11"><a href="#cb37-11"></a>     <span class="dt">main =</span> <span class="kw">paste0</span>(<span class="st">&quot;Cell &quot;</span>, targetCells[<span class="dv">2</span>], <span class="st">&quot; vs cell &quot;</span>, targetCells[<span class="dv">1</span>]),</span>
<span id="cb37-12"><a href="#cb37-12"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Log mean&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;Log2 fold-change&quot;</span>,</span>
<span id="cb37-13"><a href="#cb37-13"></a>     <span class="dt">bty =</span> <span class="st">&#39;l&#39;</span>)</span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="kw">abline</span>(<span class="dt">h =</span> <span class="dv">0</span>, <span class="dt">col=</span><span class="st">&quot;orange&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p>Upon normalizing the data using size factors, we have removed bias as a consequence of differences in sequencing depth.</p>
<p>Note that we computed the normalized count matrix only for demonstrating the effect of such normalization. In a typical workflow, the size factors are used as offsets in the downstream models rather than to perform data transformation. In brief, such transformation would distort the mean-variance relationship in the data. For more details, we refer to the document that was touched upon in the first theory session (<a href="https://statomics.github.io/SGA21/sequencing_scalingNormalization.html">link</a>)</p>
</div>
<div id="feature-selection" class="section level1">
<h1><span class="header-section-number">11</span> Feature selection</h1>
<p>As dimensions increase, shortest and farthest distances between points become nearly inseparable. In high-dimensional space, it is therefore extremely difficult to separate signal from noise.</p>
<p>In order to recover structure (e.g. setting up a dimension-reduced space to help us find cell-type clusters in the data), we want to move to an informative, lower-dimensional space. We will select genes which we hope are informative for recovering the biological structure. But what defines an informative gene?</p>
<div id="selecting-genes-with-high-variance" class="section level2">
<h2><span class="header-section-number">11.1</span> Selecting genes with high variance</h2>
<p>The simplest approach to quantifying per-gene variation is to compute the variance of the log-normalized expression values (i.e., “log-counts”) for each gene across all cells.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># calculate variance of log-normalized counts for each gene</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>geneVars &lt;-<span class="st"> </span>genefilter<span class="op">::</span><span class="kw">rowVars</span>(...)</span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co"># select top 1000 highly variable genes</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>highVarGenes &lt;-<span class="st"> </span><span class="kw">names</span>(geneVars)[<span class="kw">order</span>(geneVars, <span class="dt">decreasing=</span><span class="ot">TRUE</span>)[<span class="dv">1</span><span class="op">:</span><span class="fl">1e3</span>]]</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="kw">head</span>(highVarGenes)</span></code></pre></div>
</div>
<div id="selecting-genes-with-high-variation-with-respect-to-mean" class="section level2">
<h2><span class="header-section-number">11.2</span> Selecting genes with high variation with respect to mean</h2>
<p>While calculation of the per-gene variance is simple, feature selection requires modelling of the mean-variance relationship. Indeed, not accounting for the mean-variance structure while selecting highly variable genes will oftentimes boil down to selecting the most highly expressed genes. The log-transformation is a helpful variance stabilizing transformation, however, it is not perfect, meaning that the variance of a gene is not completely independent of its mean. Therefore, feature selection may still be driven by average expression rather than underlying biological heterogeneity.</p>
<p>A (rightly so) popular approach is to select genes that have a high variance with respect to their mean. Often, first an empirical mean-variance trend is fitted, upon which genes with the highest positive residuals are selected. Being intuitive, reasonable and fairly straight-forward, this method is widely used.</p>
<p>To account for the mean-variance effect, we use the <code>modelGeneVar</code> function of the <code>scran</code> package to fit a trend to the variance with respect to abundance across all genes (on log-normalized expression values of the sce object).</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">library</span>(scran)</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="co"># `modelGeneVar` function description: Model the variance of the log-expression </span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="co"># profiles for each gene, decomposing it into technical and biological </span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="co"># components based on a fitted mean-variance trend.</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>dec &lt;-<span class="st"> </span><span class="kw">modelGeneVar</span>(...) <span class="co"># input a sce object with precomputed logcounts assay</span></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="kw">head</span>(dec)</span></code></pre></div>
<p>The fitted value for each gene is used as a proxy for the technical component of variation for each gene, under the assumption that most genes exhibit a low baseline level of variation that is not biologically interesting. The biological component of variation for each gene is defined as the the residual from the trend. Ranking genes by the biological component enables identification of interesting genes for downstream analyses in a manner that accounts for the mean-variance relationship.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>fitRetina &lt;-<span class="st"> </span><span class="kw">metadata</span>(...)</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="kw">plot</span>(<span class="dt">x =</span> ..., <span class="co"># the fitted means on the x-axis </span></span>
<span id="cb40-3"><a href="#cb40-3"></a>     <span class="dt">y =</span> ..., <span class="co"># the fitted variances on the y-axis</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>     <span class="dt">xlab=</span><span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb40-5"><a href="#cb40-5"></a>    <span class="dt">ylab=</span><span class="st">&quot;Variance of log-expression&quot;</span>)</span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="kw">curve</span>(fitRetina<span class="op">$</span><span class="kw">trend</span>(x), <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">lwd=</span><span class="dv">2</span>) <span class="co"># adds a trend line</span></span></code></pre></div>
<p>We are interested in those genes for which the variance in expression is higher than what we would expect for that gene based on its mean expression.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># get 10% most variable genes</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="co"># Based on the output statistics of modelGeneVar, select the 10% most variable genes</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>hvg &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(<span class="dt">stats =</span> ..., </span>
<span id="cb41-4"><a href="#cb41-4"></a>                  <span class="dt">prop =</span> ...) <span class="co"># percentage of top variable genes. Alternatively,</span></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="co"># n = ... could be used to select the top number of variable genes</span></span>
<span id="cb41-6"><a href="#cb41-6"></a><span class="kw">head</span>(hvg)</span>
<span id="cb41-7"><a href="#cb41-7"></a></span>
<span id="cb41-8"><a href="#cb41-8"></a><span class="co"># plot these </span></span>
<span id="cb41-9"><a href="#cb41-9"></a><span class="kw">plot</span>(<span class="dt">x =</span> ..., <span class="co"># the fitted means on the x-axis </span></span>
<span id="cb41-10"><a href="#cb41-10"></a>     <span class="dt">y =</span> ..., <span class="co"># the fitted variances on the y-axis</span></span>
<span id="cb41-11"><a href="#cb41-11"></a>     <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;darkseagreen3&quot;</span>)[(<span class="kw">names</span>(fitRetina<span class="op">$</span>mean) <span class="op">%in%</span><span class="st"> </span>hvg)<span class="op">+</span><span class="dv">1</span>],</span>
<span id="cb41-12"><a href="#cb41-12"></a>     <span class="dt">xlab=</span><span class="st">&quot;Mean of log-expression&quot;</span>,</span>
<span id="cb41-13"><a href="#cb41-13"></a>    <span class="dt">ylab=</span><span class="st">&quot;Variance of log-expression&quot;</span>)</span>
<span id="cb41-14"><a href="#cb41-14"></a><span class="kw">curve</span>(fitRetina<span class="op">$</span><span class="kw">trend</span>(x), <span class="dt">col=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb41-15"><a href="#cb41-15"></a><span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, </span>
<span id="cb41-16"><a href="#cb41-16"></a>       <span class="dt">legend =</span> <span class="kw">c</span>(<span class="st">&quot;Selected&quot;</span>, <span class="st">&quot;Not selected&quot;</span>), </span>
<span id="cb41-17"><a href="#cb41-17"></a>       <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;darkseagreen3&quot;</span>, <span class="st">&quot;orange&quot;</span>),</span>
<span id="cb41-18"><a href="#cb41-18"></a>       <span class="dt">pch =</span> <span class="dv">16</span>,</span>
<span id="cb41-19"><a href="#cb41-19"></a>       <span class="dt">bty=</span><span class="st">&#39;n&#39;</span>)</span></code></pre></div>
<p>As a comparison, we could color the genes on this figure according to the selection that was made purely by looking at the raw variance of each gene.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>...</span></code></pre></div>
<p>As expected, we here simply select genes with a high variance, without recognizing that a high variance is typically driven by a high mean.</p>
</div>
<div id="high-deviance-genes" class="section level2">
<h2><span class="header-section-number">11.3</span> High deviance genes</h2>
<p>Here, we will select genes with a high residual deviance. The idea is that we assume a null model of constant expression fraction (i.e., RNA concentration) across all cells. We subsequently calculate a goodness-of-fit statistic for each gene, assessing whether the model is a good approximation to the gene expression of the corresponding gene.</p>
<p>If the model fits poorly, i.e., the gene has a high deviance, the expression fraction varies significantly across the cells in our datasets.Genes with a high deviance will thus most poorly fit a null model where the relative abundance is equal for all cells, which therefore are informative.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co">#BiocManager::install(&quot;scry&quot;)</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="kw">library</span>(scry)</span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co"># `devianceFeatureSelection` function description: Computes a deviance statistic </span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="co"># for each row feature (such as a gene) for count data based on a multinomial </span></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co"># null model [...]. </span></span>
<span id="cb43-6"><a href="#cb43-6"></a>sce &lt;-<span class="st"> </span><span class="kw">devianceFeatureSelection</span>(<span class="dt">object =</span> ..., </span>
<span id="cb43-7"><a href="#cb43-7"></a>                                <span class="dt">assay =</span> ...) <span class="co"># computed on raw counts</span></span>
<span id="cb43-8"><a href="#cb43-8"></a></span>
<span id="cb43-9"><a href="#cb43-9"></a><span class="kw">plot</span>(<span class="kw">sort</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>binomial_deviance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>), </span>
<span id="cb43-10"><a href="#cb43-10"></a>     <span class="dt">type=</span><span class="st">&quot;l&quot;</span>, </span>
<span id="cb43-11"><a href="#cb43-11"></a>     <span class="dt">xlab=</span><span class="st">&quot;ranked genes&quot;</span>, </span>
<span id="cb43-12"><a href="#cb43-12"></a>     <span class="dt">ylab=</span><span class="st">&quot;binomial deviance&quot;</span>, </span>
<span id="cb43-13"><a href="#cb43-13"></a>     <span class="dt">main=</span><span class="st">&quot;Feature Selection with Deviance&quot;</span>)</span>
<span id="cb43-14"><a href="#cb43-14"></a><span class="kw">abline</span>(<span class="dt">v=</span><span class="dv">2000</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p>Our plot looks similar to one displayed in the <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/scry/inst/doc/scry.html">vignette of the scry package</a>. Based on that plot, the authors suggest retaining 2.000 genes (the top 2000 based on the deviance residuals) for downstream dimensionality reduction and clustering.</p>
</div>
<div id="seurat-vst" class="section level2">
<h2><span class="header-section-number">11.4</span> Seurat VST</h2>
<p>Another very common feature selection strategy is the variance-stabilizing transformation from the <code>Seurat</code> R package, which amounts to calculating Pearson residuals from a regularized negative binomial regression model, with sequencing depth as a covariate.</p>
<p><strong>Intermezzo: interoperability between SingleCellExperiment and Seurat objects</strong></p>
<p>In this lecture series, we always make use of the SingleCellExperiment object and the packages available from Bioconductor. Another very popular toolbox for performing scRNA-seq data analysis is <code>Seurat</code>. However, functions from <code>Seurat</code> cannot be used directly to manipulate <code>SingleCellExperiment</code> objects, and vice versa. Fortunately, efforts have been made to increase the interoperability between the two toolboxes.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">library</span>(Seurat)</span>
<span id="cb44-2"><a href="#cb44-2"></a>seurat_obj &lt;-<span class="st"> </span><span class="kw">as.Seurat</span>(...) <span class="co"># sce object</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>seurat_obj <span class="co"># notice the &quot;0 variable features&quot;</span></span></code></pre></div>
<p>On this object, we may use functions from the <code>Seurat</code> toolbox. For instance, we may search for highly variable features using <code>Seurat</code>’s VST implementation:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># Prior to detecting variable features using VST, Seurat normalizes the data.</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="co"># The `NormalizeData` function takes as input the Seurat object, and uses </span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="co"># log normalization and a scale factor of 10000 as default (see help file).</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>seurat_obj &lt;-<span class="st"> </span>Seurat<span class="op">::</span><span class="kw">NormalizeData</span>(<span class="dt">object =</span> ..., </span>
<span id="cb45-5"><a href="#cb45-5"></a>                                    <span class="dt">normalization.method =</span> ..., </span>
<span id="cb45-6"><a href="#cb45-6"></a>                                    <span class="dt">scale.factor =</span> ...)</span>
<span id="cb45-7"><a href="#cb45-7"></a></span>
<span id="cb45-8"><a href="#cb45-8"></a><span class="co"># Next, perform feature selection based on VST</span></span>
<span id="cb45-9"><a href="#cb45-9"></a>seurat_obj &lt;-<span class="st">  </span><span class="kw">FindVariableFeatures</span>(<span class="dt">object =</span> ...,</span>
<span id="cb45-10"><a href="#cb45-10"></a>                                    <span class="dt">selection.method =</span> ...)</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>seurat_obj  <span class="co"># notice the &quot;2000 variable features&quot; (default)</span></span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="kw">head</span>(<span class="kw">VariableFeatures</span>(seurat_obj)) <span class="co"># here they are</span></span></code></pre></div>
</div>
</div>
<div id="dimensionality-reduction" class="section level1">
<h1><span class="header-section-number">12</span> Dimensionality reduction</h1>
<p>Note that, below, we color the cells using the known, true cell type label as defined in the metadata, to empirically evaluate the dimensionality reduction. In reality, we don’t know this yet at this stage.</p>
<div id="the-most-basic-dr" class="section level2">
<h2><span class="header-section-number">12.1</span> The most basic DR</h2>
<p>Just by looking at the top two genes based on our feature selection criterion, we can already see some separation according to the cell type!</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">colData</span>(sce)<span class="op">$</span>cluster &lt;-<span class="st"> </span><span class="kw">as.factor</span>(<span class="kw">colData</span>(sce)<span class="op">$</span>cluster)</span>
<span id="cb47-2"><a href="#cb47-2"></a>cl &lt;-<span class="st"> </span><span class="kw">colData</span>(sce)<span class="op">$</span>cluster</span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="kw">par</span>(<span class="dt">bty=</span><span class="st">&#39;l&#39;</span>)</span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="kw">plot</span>(<span class="dt">x =</span> ..., <span class="co"># extract the counts for the most variable gene</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>     <span class="dt">y =</span> ..., <span class="co"># extract the counts for the second most variable gene</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>     <span class="dt">col =</span> <span class="kw">as.numeric</span>(cl),</span>
<span id="cb47-7"><a href="#cb47-7"></a>     <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb47-8"><a href="#cb47-8"></a>     <span class="dt">xlab =</span> <span class="st">&quot;Most informative gene&quot;</span>,</span>
<span id="cb47-9"><a href="#cb47-9"></a>     <span class="dt">ylab =</span> <span class="st">&quot;Second most informative gene&quot;</span>,</span>
<span id="cb47-10"><a href="#cb47-10"></a>     <span class="dt">main =</span> <span class="st">&quot;Cells colored acc to cell type&quot;</span>)</span></code></pre></div>
<p>We are able to recover quite some structure. However, many cell populations remain obscure, and the plot is overcrowded.</p>
</div>
<div id="linear-dimensionality-reduction-pca" class="section level2">
<h2><span class="header-section-number">12.2</span> Linear dimensionality reduction: PCA</h2>
<p>A DR method is linear when the reduced dimensions are a linear function of the original variables. For example, in PCA, each principal component is a linear combination of genes, therefore the DR is a linear function of the original variables.</p>
<p>Typically, PCA is performed on log-transformed normalized counts. The log-transformation helps somewhat, but not completely, to account for the mean-variance relationship. PCA works well for bulk RNA-seq data. However, the structure of scRNA-seq data is often too complex to be visualized by a small number of PCs.</p>
<p>There are several R functions that allow you to perform PCA. Here, we make use of the <code>runPCA</code> function of the <code>scater</code> package, which has been specifically developed for performing PCA on <code>SingleCellExperiment</code> objects. We calculate the top 30 principal components.</p>
<div id="pca-with-feature-selection" class="section level3">
<h3><span class="header-section-number">12.2.1</span> PCA with feature selection</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># Perform a PCA for our data. Compute the first 30 principal components, only</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="co"># using the selected features with high variance with respect to the mean.</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb48-4"><a href="#cb48-4"></a>sce &lt;-<span class="st"> </span><span class="kw">runPCA</span>(...) <span class="co"># you need three arguments</span></span></code></pre></div>
<p>PCA has been performed. The PCA information has been automatically stored in the <em>reducedDim</em> slot of the SingleCellExperiment object.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">reducedDimNames</span>(sce)</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">head</span>(<span class="kw">reducedDim</span>(sce,</span>
<span id="cb50-2"><a href="#cb50-2"></a>                <span class="dt">type=</span><span class="st">&quot;PCA&quot;</span>))</span></code></pre></div>
<p>The <code>plotPCA</code> function of the <code>scater</code> package now allows us to visualize the cells in PCA space, based on the PCA information stored in our object:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="kw">plotPCA</span>(sce, </span>
<span id="cb51-2"><a href="#cb51-2"></a>        <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
<p>While the large number of clusters in this dataset makes it hard to distinguish between all the different colors, we can already see that PCA retrieves some, but not all, of the structure in the data that was discovered by the original authors.</p>
<p>How many of the top PCs should we retain for downstream analyses? The choice of the number of PCs is a decision that is analogous to the choice of the number of HVGs to use. Using more PCs will retain more biological signal at the cost of including more noise that might mask said signal. On the other hand, using fewer PCs will introduce competition between different factors of variation, where weaker (but still interesting) factors may be pushed down into lower PCs and inadvertently discarded from downstream analyses.</p>
<p>Most analysts will simply aim to use a “reasonable” but arbitrary value, typically ranging from 10 to 50. This is often satisfactory as the later PCs explain so little variance that their inclusion or omission has no major effect.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>percent.var &lt;-<span class="st"> </span><span class="kw">attr</span>(<span class="kw">reducedDim</span>(sce), <span class="st">&quot;percentVar&quot;</span>)</span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="kw">plot</span>(percent.var, <span class="dt">log=</span><span class="st">&quot;y&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;PC&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Variance explained (%)&quot;</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="kw">plot</span>(<span class="kw">cumsum</span>(percent.var), <span class="dt">xlab=</span><span class="st">&quot;PC&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Cumulative variance explained (%)&quot;</span>)</span></code></pre></div>
<p>Here, retaining ±15PCs seems reasonable. If you really prefer a more data-driven way for determining this, there are procedures available that aim to computationally identify the elbow/knee point in the variance explained per PC plot.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">library</span>(PCAtools)</span>
<span id="cb53-2"><a href="#cb53-2"></a>chosen.elbow &lt;-<span class="st"> </span><span class="kw">findElbowPoint</span>(percent.var)</span>
<span id="cb53-3"><a href="#cb53-3"></a>chosen.elbow</span></code></pre></div>
</div>
<div id="pca-without-feature-selection" class="section level3">
<h3><span class="header-section-number">12.2.2</span> PCA without feature selection</h3>
<p>Note: more features -&gt; computationally more intensive!</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb54-2"><a href="#cb54-2"></a>sceNoFS &lt;-<span class="st"> </span><span class="kw">runPCA</span>(<span class="dt">x =</span> ..., </span>
<span id="cb54-3"><a href="#cb54-3"></a>                  <span class="dt">ncomponents =</span> ..., </span>
<span id="cb54-4"><a href="#cb54-4"></a>                  <span class="dt">subset_row =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(sce))</span>
<span id="cb54-5"><a href="#cb54-5"></a><span class="kw">plotPCA</span>(...)</span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="kw">rm</span>(sceNoFS) <span class="co"># remove the object, we don&#39;t need it anymore</span></span></code></pre></div>
<p>While we use more information to make this PCA plot (17.887 genes) as compared to the feature selected PCA plot (642 genes), we seem to retrieve less structure in the data. This is the power of feature selection, an increase in the signal-to-noise ratio!</p>
</div>
<div id="effect-of-feature-selection-on-pca" class="section level3">
<h3><span class="header-section-number">12.2.3</span> Effect of feature selection on PCA</h3>
<p>First, we compare the different feature selection criteria, using the top 1000 highly variable genes for each method.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># Get top 1000 highly variable features using the highly variable genes</span></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="co"># (w.r.t. mean), high deviance genes and the VST strategy of Seurat</span></span>
<span id="cb55-3"><a href="#cb55-3"></a></span>
<span id="cb55-4"><a href="#cb55-4"></a>hvg1000 &lt;-<span class="st"> </span>... <span class="co"># extract top 1000 highly variable genes</span></span>
<span id="cb55-5"><a href="#cb55-5"></a>hdg1000 &lt;-<span class="st"> </span>... <span class="co"># extract top 1000 genes with high deviance</span></span>
<span id="cb55-6"><a href="#cb55-6"></a>vst1000 &lt;-<span class="st"> </span>... <span class="co"># extract top 1000 genes based on VST analysis</span></span>
<span id="cb55-7"><a href="#cb55-7"></a></span>
<span id="cb55-8"><a href="#cb55-8"></a><span class="co"># HVG strategy</span></span>
<span id="cb55-9"><a href="#cb55-9"></a><span class="kw">plotPCA</span>(</span>
<span id="cb55-10"><a href="#cb55-10"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb55-11"><a href="#cb55-11"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb55-12"><a href="#cb55-12"></a>           <span class="dt">subset_row =</span> hvg1000), </span>
<span id="cb55-13"><a href="#cb55-13"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb55-14"><a href="#cb55-14"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Highly variable genes&quot;</span>)</span>
<span id="cb55-15"><a href="#cb55-15"></a></span>
<span id="cb55-16"><a href="#cb55-16"></a><span class="co"># HDG strategy</span></span>
<span id="cb55-17"><a href="#cb55-17"></a><span class="kw">plotPCA</span>(</span>
<span id="cb55-18"><a href="#cb55-18"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb55-19"><a href="#cb55-19"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb55-20"><a href="#cb55-20"></a>           <span class="dt">subset_row =</span> hdg1000), </span>
<span id="cb55-21"><a href="#cb55-21"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb55-22"><a href="#cb55-22"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;High-deviance genes&quot;</span>)</span>
<span id="cb55-23"><a href="#cb55-23"></a></span>
<span id="cb55-24"><a href="#cb55-24"></a><span class="co"># VST strategy</span></span>
<span id="cb55-25"><a href="#cb55-25"></a><span class="kw">plotPCA</span>(</span>
<span id="cb55-26"><a href="#cb55-26"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb55-27"><a href="#cb55-27"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb55-28"><a href="#cb55-28"></a>           <span class="dt">subset_row =</span> vst1000), </span>
<span id="cb55-29"><a href="#cb55-29"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb55-30"><a href="#cb55-30"></a>    ) <span class="op">+</span></span>
<span id="cb55-31"><a href="#cb55-31"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Seurat VST&quot;</span>)</span></code></pre></div>
<p>Next, we assess the sensitivity on the number of top features for the highly variable genes method;</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>hvg_all &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec)</span>
<span id="cb56-2"><a href="#cb56-2"></a></span>
<span id="cb56-3"><a href="#cb56-3"></a>hvg2000 &lt;-<span class="st"> </span>... <span class="co"># extract top 2000 highly variable genes</span></span>
<span id="cb56-4"><a href="#cb56-4"></a>hvg1000 &lt;-<span class="st"> </span>... <span class="co"># extract top 1000 highly variable genes</span></span>
<span id="cb56-5"><a href="#cb56-5"></a>hvg100 &lt;-<span class="st"> </span>... <span class="co"># extract top 100 highly variable genes</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>hvg10 &lt;-<span class="st"> </span>... <span class="co"># extract top 10 highly variable genes</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>hvg5 &lt;-<span class="st"> </span>... <span class="co"># extract top 5 highly variable genes</span></span>
<span id="cb56-8"><a href="#cb56-8"></a></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-10"><a href="#cb56-10"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-11"><a href="#cb56-11"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>), </span>
<span id="cb56-12"><a href="#cb56-12"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-13"><a href="#cb56-13"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;All genes&quot;</span>)</span>
<span id="cb56-14"><a href="#cb56-14"></a></span>
<span id="cb56-15"><a href="#cb56-15"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-16"><a href="#cb56-16"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-17"><a href="#cb56-17"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb56-18"><a href="#cb56-18"></a>           <span class="dt">subset_row =</span> hvg2000), </span>
<span id="cb56-19"><a href="#cb56-19"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-20"><a href="#cb56-20"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 2000 genes&quot;</span>)</span>
<span id="cb56-21"><a href="#cb56-21"></a></span>
<span id="cb56-22"><a href="#cb56-22"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-23"><a href="#cb56-23"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-24"><a href="#cb56-24"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb56-25"><a href="#cb56-25"></a>           <span class="dt">subset_row =</span> hvg1000), </span>
<span id="cb56-26"><a href="#cb56-26"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-27"><a href="#cb56-27"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 1000 genes&quot;</span>)</span>
<span id="cb56-28"><a href="#cb56-28"></a></span>
<span id="cb56-29"><a href="#cb56-29"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-30"><a href="#cb56-30"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-31"><a href="#cb56-31"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb56-32"><a href="#cb56-32"></a>           <span class="dt">subset_row =</span> hvg100), </span>
<span id="cb56-33"><a href="#cb56-33"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-34"><a href="#cb56-34"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 100 genes&quot;</span>)</span>
<span id="cb56-35"><a href="#cb56-35"></a></span>
<span id="cb56-36"><a href="#cb56-36"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-37"><a href="#cb56-37"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-38"><a href="#cb56-38"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb56-39"><a href="#cb56-39"></a>           <span class="dt">subset_row =</span> hvg10), </span>
<span id="cb56-40"><a href="#cb56-40"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-41"><a href="#cb56-41"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 10 genes&quot;</span>)</span>
<span id="cb56-42"><a href="#cb56-42"></a></span>
<span id="cb56-43"><a href="#cb56-43"></a><span class="kw">plotPCA</span>(</span>
<span id="cb56-44"><a href="#cb56-44"></a>    <span class="kw">runPCA</span>(sce,</span>
<span id="cb56-45"><a href="#cb56-45"></a>           <span class="dt">ncomponents =</span> <span class="dv">2</span>, </span>
<span id="cb56-46"><a href="#cb56-46"></a>           <span class="dt">subset_row =</span> hvg5), </span>
<span id="cb56-47"><a href="#cb56-47"></a>    <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>) <span class="op">+</span></span>
<span id="cb56-48"><a href="#cb56-48"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Top 5 genes&quot;</span>)</span></code></pre></div>
</div>
<div id="remarks-on-pca" class="section level3">
<h3><span class="header-section-number">12.2.4</span> Remarks on PCA</h3>
<p>Visualizations of reduced dimensions from linear dimensionality reduction methods are often “overcrowded”, and it is hard to see structure (e.g., the PCA plot we just saw). Non-linear dimensionality reduction methods can overcome this problem. As the name suggests, the reduced dimensions are a non-linear function of the observed data. We will not go into detail as to how these work under the hood, but provide a few guidelines for the most popular methods. Often, the top (~10-50) PCs are provided as input.</p>
</div>
</div>
<div id="a-generalization-of-pca-for-exponential-family-distributions." class="section level2">
<h2><span class="header-section-number">12.3</span> A generalization of PCA for exponential family distributions.</h2>
<p>PCA is implicitly based on Euclidean distances, corresponding to maximizing a Gaussian likelihood, which is inappropriate for count data such as scRNA-seq. <a href="https://doi.org/10.1186/s13059-019-1861-6">Townes et al.</a> (2019) develop GLM-PCA, a generalization of PCA for exponential family likelihoods. They posit, using negative control data, that the data generative mechanism of UMI count data can be considered to be multinomial.</p>
<p>The GLM-PCA strategy is implemented in the <code>glmpca</code> function of the <code>glmpca</code> package.</p>
<p>Note that this function is quite computationally intensive. For regular PCA on log-transformed normalized counts, the underlying computations can be strongly simplified. Here, we work with the raw counts, which we assume to be <em>Poisson</em> distributed, requiring an iterative optimization scheme.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># runs 2min on my laptop</span></span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="kw">library</span>(glmpca)</span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="kw">set.seed</span>(<span class="dv">211103</span>)</span>
<span id="cb57-4"><a href="#cb57-4"></a>poipca &lt;-<span class="st"> </span><span class="kw">glmpca</span>(<span class="dt">Y =</span> ..., <span class="co"># counts for the higly variable genes</span></span>
<span id="cb57-5"><a href="#cb57-5"></a>                 <span class="dt">L =</span> ..., <span class="co"># two latent dimensions (components)</span></span>
<span id="cb57-6"><a href="#cb57-6"></a>                 <span class="dt">fam =</span> ..., <span class="co"># assume Poisson for droplet data</span></span>
<span id="cb57-7"><a href="#cb57-7"></a>                 <span class="dt">minibatch =</span> <span class="st">&quot;stochastic&quot;</span>) <span class="co"># used in the package vignette by </span></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="co"># the authors, but beyond the scope of this session.</span></span>
<span id="cb57-9"><a href="#cb57-9"></a><span class="kw">reducedDim</span>(sce, <span class="st">&quot;PoiPCA&quot;</span>) &lt;-<span class="st"> </span>poipca<span class="op">$</span>factors</span>
<span id="cb57-10"><a href="#cb57-10"></a><span class="kw">plotReducedDim</span>(...) <span class="co"># make sure to specify the right value for the `dimred` argument</span></span></code></pre></div>
<p>Alternatively, we could adopt the GLM-PCA strategy using only the genes with high deviance.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># Based on the diagnostic plot from the feature selection, we would select the </span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="co"># top 2000 genes with highest deviance. However, to reduce the running time of</span></span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="co"># the function, I here select the top 500 (which still is quite slow - 5min).</span></span>
<span id="cb58-4"><a href="#cb58-4"></a>hdg500 &lt;-<span class="st"> </span><span class="kw">names</span>(<span class="kw">sort</span>(<span class="kw">rowData</span>(sce)<span class="op">$</span>binomial_deviance, <span class="dt">decreasing =</span> <span class="ot">TRUE</span>))[<span class="dv">1</span><span class="op">:</span><span class="dv">500</span>]</span>
<span id="cb58-5"><a href="#cb58-5"></a></span>
<span id="cb58-6"><a href="#cb58-6"></a>...</span></code></pre></div>
<p>The authors of the <code>glmpca</code> package note that GLM-PCA can be slow for large datasets. Therefore, they have implemented a fast approximation of the algorithm, which first fits a null model of constant expression for each gene across all cells, and subsequently fits standard PCA to either the Pearson or deviance residuals from the null model.</p>
<p>However, at least for me the <code>nullResiduals</code> function was <strong>extremely slow</strong> even slower than the <code>glmpca</code> code above. Therefore, <strong>I suggest not running</strong> this code, but I leave it in for reference.</p>
<pre><code>sce &lt;- nullResiduals(sce, assay=&quot;counts&quot;, type=&quot;deviance&quot;)
sce &lt;- nullResiduals(sce, assay=&quot;counts&quot;, type=&quot;pearson&quot;)

pca&lt;-function(Y, L=2, center=TRUE, scale=TRUE){
    #assumes features=rows, observations=cols
    res&lt;-prcomp(as.matrix(t(Y)), center=center, scale.=scale, rank.=L)
    factors&lt;-as.data.frame(res$x)
    colnames(factors)&lt;-paste0(&quot;dim&quot;, 1:L)
    factors
}
pca_d &lt;- pca(assay(sce[hdg,], &quot;binomial_deviance_residuals&quot;))
pca_d$resid_type &lt;- &quot;deviance_residuals&quot;
pca_p &lt;- pca(assay(sce[hdg,], &quot;binomial_pearson_residuals&quot;))
pca_p$resid_type &lt;- &quot;pearson_residuals&quot;
cm &lt;- as.data.frame(colData(sce[hdg,]))
pd &lt;- rbind(cbind(cm, pca_d), cbind(cm, pca_p))
ggplot(pd, aes(x=dim1, y=dim2, colour=phenoid)) + geom_point() +
  facet_wrap(~resid_type, scales=&quot;free&quot;, nrow=2) +
  ggtitle(&quot;PCA applied to null residuals of high deviance genes&quot;)</code></pre>
</div>
<div id="non-linear-dimensionality-reduction-t-sne" class="section level2">
<h2><span class="header-section-number">12.4</span> Non-linear dimensionality reduction: t-SNE</h2>
<p>t-SNE focuses on preserving local rather than global distances. Therefore, distances on a t-SNE reduced dimension plot can only be interpreted locally, i.e., cells that are close together in reduced dimension will have a similar transcriptome, but cells that are far away may not necessarily have a very distinct transcriptome.</p>
<p>Running t-SNE on a <code>SingleCellExperiment</code> object can be achieved with the <code>runTSNE</code> function of the <code>scater</code> package. By default, this function will first perform PCA, and use the top 50 PCs as an input to the actual t-SNE algorithm. Since we already performed PCA, we may set <code>dimred = "PCA"</code> as argument to the function. As such we will be performing a T-SNE on the 30 PCs we computed before. If we would like to run t-SNE only using the top 10 PCs, we could set <code>n_dimred = 10</code>.</p>
<p>In addition, we may wish to set <code>external_neighbors=TRUE</code>, which increases the speed of the algorithm for large datasets by applying a heuristic.</p>
<p><strong>Note:</strong> for me this was the slowest function of the analysis (so far). If you feel like your PC/laptop had a lot of trouble with the previous step(s), you may consider not running this code, or running it on a subset of the data (e.g., randomly subsampling cells) for demonstrational purposes. Alternatively, you may consider reducing the input space for the t-SNE algorithm, e.g. by setting <code>n_dimred = 5</code>.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="co"># (For me it takes 3min30 with n_dimred = 5)</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>sce &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(<span class="dt">x =</span> ..., </span>
<span id="cb60-3"><a href="#cb60-3"></a>               <span class="dt">dimred =</span> ...,</span>
<span id="cb60-4"><a href="#cb60-4"></a>               <span class="dt">n_dimred =</span> ...,</span>
<span id="cb60-5"><a href="#cb60-5"></a>               <span class="dt">external_neighbors =</span> ...)</span>
<span id="cb60-6"><a href="#cb60-6"></a><span class="kw">plotTSNE</span>(sce,</span>
<span id="cb60-7"><a href="#cb60-7"></a>         <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
</div>
<div id="non-linear-dimensionality-reduction-umap" class="section level2">
<h2><span class="header-section-number">12.5</span> Non-linear dimensionality reduction: UMAP</h2>
<p>It is often suggested that UMAP is better than t-SNE in preserving global differences. Therefore, UMAP is also often used in analyses such as trajectory inference, where this is important.</p>
<p>Running UMAP on a <code>SingleCellExperiment</code> object can be achieved with the <code>runUMAP</code> function of the <code>scater</code> package.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="co"># Using top 10% highly variable genes and top 30 PCs</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>sce &lt;-<span class="st"> </span><span class="kw">runUMAP</span>(...)</span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="kw">plotUMAP</span>(...)</span>
<span id="cb61-4"><a href="#cb61-4"></a></span>
<span id="cb61-5"><a href="#cb61-5"></a><span class="co"># Using top 10% highly variable genes and top 10 PCs</span></span>
<span id="cb61-6"><a href="#cb61-6"></a><span class="kw">plotUMAP</span>(<span class="kw">runUMAP</span>(...),</span>
<span id="cb61-7"><a href="#cb61-7"></a>  <span class="dt">colour_by =</span> <span class="st">&quot;cluster&quot;</span>)</span></code></pre></div>
</div>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAnTm9ybWFsaXphdGlvbiwgZmVhdHVyZSBzZWxlY3Rpb24gYW5kIGRpbWVuc2lvbiByZWR1Y3Rpb24gZm9yIHRoZSBNYWNvc2tvIGRhdGFzZXQnCmF1dGhvcjogIktvZW4gVmFuIGRlbiBCZXJnZSBhbmQgSmVyb2VuIEdpbGlzIgpkYXRlOiAiMzAvMTEvMjAyMSIKb3V0cHV0OiAKICBodG1sX2RvY3VtZW50OgogICAgY29kZV9kb3dubG9hZDogdHJ1ZQogICAgdG9jOiB0cnVlCiAgICB0b2NfZmxvYXQ6IHRydWUKLS0tCgojIFByZWFtYmxlOiBpbnN0YWxsYXRpb24gb2YgQmlvY29uZHVjdG9yIGxpYnJhcmllcwoKYGBge3J9CiMgaW5zdGFsbCBCaW9jTWFuYWdlciBwYWNrYWdlIGlmIG5vdCBpbnN0YWxsZWQgeWV0LgojIEJpb2NNYW5hZ2VyIGlzIHRoZSBwYWNrYWdlIGluc3RhbGxlciBmb3IgQmlvY29uZHVjdG9yIHNvZnR3YXJlLgppZiAoIXJlcXVpcmVOYW1lc3BhY2UoIkJpb2NNYW5hZ2VyIiwgcXVpZXRseSA9IFRSVUUpKQogICAgaW5zdGFsbC5wYWNrYWdlcygiQmlvY01hbmFnZXIiKQoKIyBpbnN0YWxsIHBhY2thZ2VzIGlmIG5vdCB5ZXQgaW5zdGFsbGVkLgpwa2dzIDwtIGMoIlNpbmdsZUNlbGxFeHBlcmltZW50IiwKICAgICAgICAgICJFeHBlcmltZW50SHViIiwKICAgICAgICAgICJlZGdlUiIsCiAgICAgICAgICAiYmlvbWFSdCIsCiAgICAgICAgICAiRHJvcGxldFV0aWxzIiwgCiAgICAgICAgICAic2NSTkFzZXEiLCAKICAgICAgICAgICJzY2F0ZXIiLCAKICAgICAgICAgICJzY3V0dGxlIiwgCiAgICAgICAgICAic2NyYW4iLAogICAgICAgICAgInNjcnkiLAogICAgICAgICAgIkJpb2NTaW5ndWxhciIsIAogICAgICAgICAgInNjRGJsRmluZGVyIiwKICAgICAgICAgICJnbG1wY2EiLAogICAgICAgICAgIlBDQXRvb2xzIiwKICAgICAgICAgICJTZXVyYXQiKQpub3RJbnN0YWxsZWQgPC0gcGtnc1shcGtncyAlaW4lIGluc3RhbGxlZC5wYWNrYWdlcygpWywxXV0KaWYobGVuZ3RoKG5vdEluc3RhbGxlZCkgPiAwKXsKICBCaW9jTWFuYWdlcjo6aW5zdGFsbChub3RJbnN0YWxsZWQpCn0KCmBgYAoKIyBUaGUgTWFjb3NrbyBkYXRhc2V0CgpJbiB0aGlzIHdvcmtzaG9wIHNlc3Npb24sIHdlIHdpbGwgYW5hbHl6ZSB0aGUgc2luZ2xlLWNlbGwgUk5BLXNlcSBkYXRhc2V0CmZyb20gdGhlIHB1YmxpY2F0aW9uIGJ5IE1hY29za28gKmV0IGFsLiosIENlbGwgMTYxLCAxMjAy4oCTMTIxNCBmcm9tIDIwMTUKWyhsaW5rKV0oaHR0cHM6Ly9kb2kub3JnLzEwLjEwMTYvai5jZWxsLjIwMTUuMDUuMDAyKS4gVGhpcyBpcyB0aGUgbWFudXNjcmlwdCBpbgp3aGljaCB0aGUgZHJvcGxldCBzY1JOQS1zZXEgdGVjaG5vbG9neSAqKkRyb3Atc2VxKiogd2FzIGludHJvZHVjZWQuClNpeCB5ZWFycyBhZnRlciB0aGUgb3JpZ2luYWwgcHVibGljYXRpb24sIGRyb3Atc2VxIGlzIHN0aWxsIG9uZSBvZiB0aGUgbW9zdCAKY29tbW9ubHkgYWRvcHRlZCBzY1JOQS1zZXEgcHJvdG9jb2xzLCBhcyBldmlkZW5jZWQgYnkgdGhlCmxhcmdlIG51bWJlciBvZiBjaXRhdGlvbnMgZm9yIE1hY29za28gKmV0IGFsLiogCig0LjMwMyBjaXRhdGlvbnMgYXQgTm92ZW1iZXIgMywgMjAyMSkuCgpUaGUgYmFzaWMgaWRlYSBiZWhpbmQgdGhlIERyb3Atc2VxIHByb3RvY29sIGNhbiBiZSB0YWtlbiBmcm9tIHRoZSBncmFwaGljYWwKYWJzdHJhY3Qgb2YgdGhlIHB1YmxpY2F0aW9uLgoKYGBgCmtuaXRyOjppbmNsdWRlX2dyYXBoaWNzKCJtYWNvc2tvX2dyYXBoaWNhbEFic3RyYWN0LmpwZWciKQpgYGAKClRoZSBzdWNjZXNzIG9mIERyb3Atc2VxIGNhbiBiZSBleHBsYWluZWQgYnkgdGhlIGZvbGxvd2luZyBhZHZhbnRhZ2VvdXMgCmZlYXR1cmVzOgoKLSBUaGUgdXNlIG9mIHVuaXF1ZSBtb2xlY3VsYXIgaWRlbnRpZmllcnMgKFVNSXMpLiBCeSB3b3JraW5nIHdpdGggVU1Jcywgb25lIGNvdW50CmNvcnJlc3BvbmRzIHRvIG9uZSBvYnNlcnZlZCBtUk5BIG1vbGVjdWxlIHByZXNlbnQgaW4gdGhlIGNlbGwuIFRoYW5rcyB0byB0aGUgdXNlCm9mIFVNSSBiYXJjb2RlcywgUENSIGFydGlmYWN0cyBhcmUgcmVkdWNlZC4KCi0gU2NhbGFiaWxpdHk6IG1pY3JvZmx1aWRpY3MgdGVjaG5vbG9neSBhbGxvd3MgZm9yIHBlcmZvcm1pbmcgdGhlIGxpYnJhcnkgcHJlcApyZWFjdGlvbnMgaW5zaWRlIG5hbm9kcm9wbGV0cywgaW4gd2hpY2ggc2luZ2xlIGNlbGxzIG1heSBiZSBjb250YWluZWQuIExpYnJhcnkgcHJlcCBvY2N1cnMgYWNyb3NzIGFsbCBkcm9wbGV0cyBzaW11bHRhbmVvdXNseS4KCi0gQ29zdDogdGhlIGV4cGVyaW1lbnQgY29zdHMgYXJvdW5kIDYuNSBjZW50cyAoVVNEKSBwZXIgY2VsbC4KCi0gU3BlZWQ6IFRoZSB2ZXJ5IGxhcmdlIGRhdGFzZXQgdGhhdCB3ZSB3aWxsIGJlIHdvcmtpbmcgd2l0aCB0b2RheSB3YXMgCmdlbmVyYXRlZCBpbiBhbiBleHBlcmltZW50IHRoYXQgdG9vayBvbmx5IDQgZGF5cy4KCkluIHRoaXMgcGFydGljdWxhciBleHBlcmltZW50LCBNYWNvc2tvICpldCBhbC4qIHNlcXVlbmNlZCA0OSwzMDAgY2VsbHMgZnJvbSB0aGUKbW91c2UgcmV0aW5hLCBpZGVudGlmeWluZyAzOSB0cmFuc2NyaXB0aW9uYWxseSBkaXN0aW5jdCBjZWxsIHBvcHVsYXRpb25zLiBUaGUKZXhwZXJpbWVudCB3YXMgcGVyZm9ybWVkIGluIDcgYmF0Y2hlcy4KCiMgRGF0YSBhdmFpbGFiaWxpdHkKCiMjIFNSQQoKVGhlIFtTZXF1ZW5jZSBSZWFkIEFyY2hpdmUgKFNSQSldKGh0dHBzOi8vd3d3Lm5jYmkubmxtLm5paC5nb3Yvc3JhKSBpcyB0aGUgCmxhcmdlc3QgcHVibGljbHkgYXZhaWxhYmxlIHJlcG9zaXRvcnkgb2YgaGlnaC10aHJvdWdocHV0IHNlcXVlbmNpbmcgZGF0YS4KVGhlIGRhdGEgYXJlIHN0b3JlZCBieSB0aGUgTmF0aW9uYWwgQ2VudGVyIGZvciBCaW90ZWNobm9sb2d5IEluZm9ybWF0aW9uIChOQ0JJKSAKc2VydmljZXMgYW5kIG11bHRpcGxlIGNsb3VkIHN0b3JhZ2UgcHJvdmlkZXJzLiBGcm9tIHRoaXMgd2Vic2l0ZSAicmF3IiAKc2VxdWVuY2luZyBkYXRhIGNhbiBiZSByZXRyaWV2ZWQuIEluIHByYWN0aWNlLCB0aGVzZSBhcmUgdXN1YWxseSBgLnNyYWAgZmlsZXMsCndoaWNoIGNhbiBiZSBkb3dubG9hZGVkIGFuZCBjb252ZXJ0ZWQgaW50byBGQVNUUSBmaWxlcyB1c2luZyBmdW5jdGlvbnMKZnJvbSB0aGUgYHNyYXRvb2xraXRgIHNvZnR3YXJlLiAKCkZvciBvdXIgZGF0YXNldCwgdGhlIEZBU1RRIGRhdGEgY2FuIGJlIHJldHJpZXZlZCBmcm9tIHRoaXMgCltsaW5rXShodHRwczovL3d3dy5uY2JpLm5sbS5uaWguZ292L1RyYWNlcy9zdHVkeS8/YWNjPVBSSk5BMjY3ODU3Jm89YWNjX3MlM0FhKS4KVGhlIGRhdGEgYXJlIHN0b3JlZCBhcyBvbmUgZmlsZSBwZXIgc2VxdWVuY2luZyBiYXRjaCwgd2l0aCBlYWNoIGZpbGUgCmFwcHJveGltYXRlbHkgMjBHYi4gQXMgc3VjaCwgaXQgd2lsbCBiZSB1bmZlYXNpYmxlIHRvIGRvd25sb2FkIGFuZCBwcm9jZXNzIHRoZXNlCkZBU1RRIGZpbGVzIGluIHRoaXMgcHJhY3RpY2FsIHNlc3Npb24uCgpJbnN0ZWFkLCBmb3IgZGVtb25zdHJhdGl2ZSBwdXJwb3Nlcywgd2UgaGF2ZSB0YWtlbiBhIHN1YnNhbXBsZSBvZiB0aGUgRkFTVFEKZmlsZSBmb3IgdGhlIGZpcnN0IHNlcXVlbmNpbmcgYmF0Y2ggZm9yIHlvdSB0byB3b3JrIHdpdGguIE9uIHRoaXMgc3Vic2FtcGxlLCAKd2UgbWF5IHBlcmZvcm0gYWxsIHRoZSB0YXNrcyB0aGF0IHdlIHdvdWxkIGhhdmUgcGVyZm9ybWVkIG9uIHRoZSBmdWxsIGRhdGFzZXQuClRoZSBzdGVwcyB0aGF0IGFyZSByZXF1aXJlZCBmb3IgZG93bmxvYWRpbmcgYW5kIHF1YW50aWZ5aW5nIGRyb3Atc2VxIGRhdGEKY2FuIGJlIGZvdW5kIGluIFthIFNoZWxsIHNjcmlwdCBvbiBvdXIgY29tcGFuaW9uIEdpdEh1YiByZXBvc2l0b3J5XShodHRwczovL2dpdGh1Yi5jb20vc3RhdE9taWNzL3NpbmdsZUNlbGxDb3Vyc2UvYmxvYi9tYXN0ZXIvbGFiMV9wcmVwcm9jZXNzaW5nL3ByZXByb2Nlc3NEcm9wc2VxLnNoKS4KCiMjIEdFTwoKVGhlIGRhdGFzZXQgZnJvbSBNYWNvc2tvICpldCBhbC4qIHdhcyBhbHNvIHVwbG9hZGVkIGJ5IHRoZSBhdXRob3JzIG9uIHRoZSAKR2VuZSBFeHByZXNzaW9uIE9tbmlidXMgKEdFTykgcGxhdGZvcm0gdW5kZXIgYWNjZXNzaW9uIG51bWJlciAKW0dTRTYzNDcyXShodHRwczovL3d3dy5uY2JpLm5sbS5uaWguZ292L2dlby9xdWVyeS9hY2MuY2dpP2FjYz1HU0U2MzQ3MiksIApmcm9tIHdoaWNoIHJhdyBhbmQgcmVhZGlseS1wcm9jZXNzZWQgZGF0YSBmaWxlcyBtYXkgYmUgcmV0cmlldmVkLCBpbmNsdWRpbmc6CgoxLiAqR1NFNjM0NzJfUkFXLnRhciosIGEgOTAuNkdiIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSAicmF3IGRhdGEiIGZvciB0aGUKZXhwZXJpbWVudC4gSW4gdGhlIHNjUk5BLXNlcSBjb250ZXh0LCBGQVNUUSBmaWxlcyBhcmUgb2Z0ZW4gY29uc2lkZXJlZCB0aGUgcmF3CmRhdGEgZm9ybWF0LgoKMi4gKkdTRTYzNDcyX1AxNFJldGluYV9tZXJnZWRfZGlnaXRhbF9leHByZXNzaW9uLnR4dC5neiosIGEgNTAuN01iIG1hdHJpeCB0aGF0CnN0b3JlcyB0aGUgZ2VuZSBleHByZXNzaW9uIHZhbHVlcyBmb3IgZWFjaCBjZWxsLiBUaGVzZSB2YWx1ZXMgYXJlIGludGVnZXIgCmNvdW50cywgdGhhdCBkaWQgbm90IHVuZGVyZ28gYW55IHR5cGUgb2YgcHJlcHJvY2Vzc2luZyBvciBub3JtYWxpemF0aW9uLgoKMy4gKkdTRTYzNDcyX21tMTBfcmVmZXJlbmNlX21ldGFkYXRhLnRhci5neiosIGEgODYyLjlNYiBjb21wcmVzc2VkIGZvbGRlcgpjb250YWluaW5nIGluZm9ybWF0aW9uIG9uIHRoZSByZWZlcmVuY2UgZ2Vub21lIHRvIHdoaWNoIHRoZSBzY1JOQS1zZXEgcmVhZHMKd2VyZSBhbGlnbmVkIChzZWUgdGhlb3J5IHNsaWRlcykuCgo0LiAqR1NFNjM0NzJfUDE0UmV0aW5hX2xvZ0RHRS50eHQuZ3oqLCBhIDMxNi44TWIgY29tcHJlc3NlZCB0ZXh0IGZpbGUsIG5vdCBjbGVhcgp3aGF0IGl0IGNvbnRhaW5zIChyZXN1bHRzIGZyb20gYSBkaWZmZXJlbnRpYWwgZ2VuZSBleHByZXNzaW9uIGFuYWx5c2lzLCBidXQKd2l0aCBsb2ctdHJhbnNmb3JtYXRpb24sIHNvIGxvZy1mb2xkIGNoYW5nZXMgbWF5YmU/KS4KCkFzIHN1Y2gsIGJ5IGRvd25sb2FkaW5nICpHU0U2MzQ3Ml9QMTRSZXRpbmFfbWVyZ2VkX2RpZ2l0YWxfZXhwcmVzc2lvbi50eHQuZ3oqLAp3ZSBhdm9pZCByZS1xdWFudGlmeWluZyB0aGUgZGF0YSwgaS5lLiwgdGhlIHRyYW5zbGF0aW9uIGZyb20gcmVhZHMgZnJvbSB0aGUKRkFTVFEgZmlsZXMgaW50byBhIGdlbmUtbGV2ZWwgZXhwcmVzc2lvbiB2YWx1ZXMgZm9yIGVhY2ggY2VsbC4gCgpPbmUgaXNzdWUgdGhhdCBvZnRlbiBhcmlzZXMgZnJvbSBkYXRhIGRvd25sb2FkZWQgZnJvbSBHRU8sIGlzIHRoYXQgdGhlcmUgaXMgbm8Kc3RyaWN0IHJlcXVpcmVtZW50cyBmb3Igd2hpY2ggZGF0YSBzaG91bGQgYmUgaW5jbHVkZWQgaW4gdGhlIHVwbG9hZCBieSB0aGUgCmF1dGhvcnMuIEFzIHN1Y2gsIGZyb20gbXkgcGVyc29uYWwgZXhwZXJpZW5jZSwgaXQgY2FuIG9mdGVuIGJlIHRoZSBjYXNlIHRoYXQKaW1wb3J0YW50IGluZm9ybWF0aW9uIGxpa2UgbWV0YWRhdGEgYXJlIG1pc3NpbmcsIG9yIHRoZSBjb250ZW50IG9mIHRoZSBzdWJtaXR0ZWQKZmlsZXMgaXMgdW5jbGVhci4gRXZlbiBpZiBhbGwgdGhlIHJlcXVpcmVkIGRhdGEgYXJlIGF2YWlsYWJsZSwgYXMgaXMgdGhlIGNhc2UgCmhlcmUsIHdlIHdvdWxkIHN0aWxsIG5lZWQgdG8gcGllY2UgYWxsIHRoZSBpbmZvcm1hdGlvbiB0b2dldGhlciBmcm9tIGRpZmZlcmVudCAKZmlsZXMgYW5kIGZpbGUgZm9ybWF0cyBiZWZvcmUgd2UgY2FuIHVzZSB0aGVtLgoKIyMgRXhwZXJpbWVudEh1YgoKVGhlIEJpb2NvbmR1Y3RvciAqRXhwZXJpbWVudEh1Yiogd2ViIHJlc291cmNlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQgdXNpbmcgdGhlIApbRXhwZXJpbWVudEh1Yl0oaHR0cHM6Ly9iaW9jb25kdWN0b3Iub3JnL3BhY2thZ2VzL3JlbGVhc2UvYmlvYy9odG1sL0V4cGVyaW1lbnRIdWIuaHRtbCkgClIgcGFja2FnZSwgcHJvdmlkZXMgYSBjZW50cmFsIGxvY2F0aW9uIHdoZXJlIGN1cmF0ZWQgZGF0YSBmcm9tIGV4cGVyaW1lbnRzLCAKcHVibGljYXRpb25zIG9yIHRyYWluaW5nIGNvdXJzZXMgY2FuIGJlIGFjY2Vzc2VkLiBXaGlsZSBpdCBjb250YWlucyBmYXIgbGVzcwpkYXRhc2V0cyB0aGFuIHRoZSBTUkEgb3IgR0VPICg0OTY1IHJlY29yZHMgdG8gZGF0ZSksIHRoZXNlIGRhdGFzZXRzIGFsbCBmb2xsb3cgCnRoZSB0aWR5IGRhdGEgZm9ybWF0IG9mIEJpb2NvbmR1Y3Rvci4gTm90ZSB0aGF0IHRoZSBFeHBlcmltZW50SHViIGNvbnRhaW5zIApzZXZlcmFsIHR5cGVzIG9mIGRhdGEsIGxpa2UgYnVsayBhbmQgc2luZ2xlLWNlbGwgdHJhbnNjcmlwdG9taWNzIGRhdGEsIAptaWNyb2FycmF5cyBhbmQgbW9yZS4KClRoZSBNYWNvc2tvIGRhdGFzZXQgaXMgYXZhaWxhYmxlIGZyb20gRXhwZXJpbWVudEh1YiBhbmQgY2FuIGJlIGFjY2Vzc2VkIGFzCmZvbGxvd3M6CgpgYGB7ciwgZXZhbD1GQUxTRSwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeShFeHBlcmltZW50SHViKQplZGIgPC0gRXhwZXJpbWVudEh1YigpCgplZGJbZ3JlcCgiTWFjb3NrbyIsIGVkYiR0aXRsZSldICMgZmluZCBhY2Nlc3Npb24gbnVtYmVyIChjYW4gYmUgaW5lZmZpY2llbnQpCgplZGJfY291bnRzIDwtIGVkYltbIkVIMjY5MCJdXQplZGJfY291bnRzWzE6NSwxOjVdCgplZGJfY29sZGF0YSA8LSBlZGJbWyJFSDI2OTEiXV0KZWRiX2NvbGRhdGFbMTo1LF0KCnJtKGVkYiwgZWRiX2NvdW50cywgZWRiX2NvbGRhdGEpCmBgYAoKIyMgc2NSTkFTZXEKCkluIGFkZGl0aW9uIHRvIEV4cGVyaW1lbnRIdWIsIEJpb2NvbmR1Y3RvciBwcm92aWRlcyB0aGUgcGFja2FnZQpbc2NSTkFzZXFdKGh0dHBzOi8vYmlvY29uZHVjdG9yLm9yZy9wYWNrYWdlcy9yZWxlYXNlL2RhdGEvZXhwZXJpbWVudC9odG1sL3NjUk5Bc2VxLmh0bWwpLgpUaGlzIHBhY2thZ2UgcHJvdmlkZXMgYW4gZXZlbiBtb3JlIHVzZXItZnJpZW5kbHkgY2xpZW50IHRvIGFjY2VzcyAob25seSkgCnNjUk5BLXNlcSBkYXRhc2V0cyBmcm9tIHRoZSBFeHBlcmltZW50SHViIHdlYiByZXNvdXJjZS4gRGF0YSByZXRyaWV2ZWQgdXNpbmcgdGhlCnNjUk5Bc2VxIHBhY2thZ2UgYXJlIHN0b3JlZCBhcyB1c2VyLWZyaWVuZGx5IGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0cywgCndpdGggdGhlIGV4cHJlc3Npb24gZGF0YSwgZ2VuZS1sZXZlbCBpbmZvcm1hdGlvbiwgY2VsbC1sZXZlbCBpbmZvcm1hdGlvbiBhbmQgCmV4cGVyaW1lbnQgbWV0YWRhdGEgYWxsIGluIHBsYWNlIGluIG9uZSBkYXRhIG9iamVjdC4gVGhlIHNjUk5BLXNlcSBwYWNrYWdlCmN1cnJlbnRseSBob2xkcyA2MSBkYXRhc2V0cywgaW5jbHVkaW5nIHRoZSBkYXRhIGZyb20gKk1hY29za28gZXQgYWwuKjoKCmBgYHtyLCBldmFsPUZBTFNFLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjUk5Bc2VxKQpzY1JOQXNlcTo6TWFjb3Nrb1JldGluYURhdGEoKQpgYGAKCiMgSW1wb3J0IGRhdGEKClRoZSBgc2NSTkFzZXFgIHBhY2thZ2UgcHJvdmlkZXMgY29udmVuaWVudCBhY2Nlc3MgdG8gc2V2ZXJhbCBkYXRhc2V0cy4gU2VlIHRoZSBbcGFja2FnZSBCaW9jb25kdWN0b3IgcGFnZV0oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvcGFja2FnZXMvcmVsZWFzZS9kYXRhL2V4cGVyaW1lbnQvaHRtbC9zY1JOQXNlcS5odG1sKSAKZm9yIG1vcmUgaW5mb3JtYXRpb24uCgpgYGB7ciwgZXZhbD1GQUxTRX0KIyBDb2RlIGJlbG93IG1pZ2h0IGFzayB5b3UgdG8gY3JlYXRlIGFuIEV4cGVyaW1lbnRIdWIgZGlyZWN0b3J5LiAKIyBUeXBlICd5ZXMnIGFuZCBoaXQgRW50ZXIsIHRvIGFsbG93IHRoaXMuCnN1cHByZXNzUGFja2FnZVN0YXJ0dXBNZXNzYWdlcyhsaWJyYXJ5KHNjUk5Bc2VxKSkKc2NlIDwtIE1hY29za29SZXRpbmFEYXRhKCkKYGBgCgojIEEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QKCmBgYHtyLCBldmFsPUZBTFNFfQpzY2UKYGBgCgojIyBBY2Nlc3NpbmcgZGF0YSBmcm9tIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QKClBsZWFzZSBzZWUgW0ZpZ3VyZSA0LjEgaW4gT1NDQV0oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvcmVsZWFzZS9PU0NBL2RhdGEtaW5mcmFzdHJ1Y3R1cmUuaHRtbCkgCmZvciBhbiBvdmVydmlldyBvZiBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0LgoKYGBge3IsIGV2YWw9RkFMU0V9CiMgRGF0YTogYXNzYXlzCmFzc2F5cyhzY2UpCmFzc2F5cyhzY2UpJGNvdW50c1sxOjUsIDE6NV0KCiMgRmVhdHVyZSBtZXRhZGF0YTogcm93RGF0YQpyb3dEYXRhKHNjZSkgIyBlbXB0eSBmb3Igbm93CgojIENlbGwgbWV0YWRhdGE6IGNvbERhdGEKY29sRGF0YShzY2UpCgojIFJlZHVjZWQgZGltZW5zaW9uczogcmVkdWNlZERpbXMKcmVkdWNlZERpbXMoc2NlKSAjIGVtcHR5IGZvciBub3cKYGBgCgojIyBDcmVhdGluZyBhIG5ldyBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIG9iamVjdAoKYGBge3IsIGV2YWw9RkFMU0V9CnNjZU5ldyA8LSBTaW5nbGVDZWxsRXhwZXJpbWVudChhc3NheXMgPSBsaXN0KGNvdW50cyA9IGFzc2F5cyhzY2UpJGNvdW50cykpCnNjZU5ldwoKcm0oc2NlTmV3KQpgYGAKCiMjIFN0b3JpbmcgKG1ldGEpZGF0YSBpbiBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0CgpgYGB7ciwgZXZhbD1GQUxTRX0KZmFrZUdlbmVOYW1lcyA8LSBwYXN0ZTAoImdlbmUiLCAxOm5yb3coc2NlKSkKcm93RGF0YShzY2UpJGZha2VOYW1lIDwtIGZha2VHZW5lTmFtZXMKaGVhZChyb3dEYXRhKHNjZSkpCiMgUmVtb3ZlIGFnYWluIGJ5IHNldHRpbmcgdG8gTlVMTApyb3dEYXRhKHNjZSkkZmFrZU5hbWUgPC0gTlVMTAoKYXNzYXlzKHNjZSkkbG9nQ291bnRzIDwtIGxvZzFwKGFzc2F5cyhzY2UpJGNvdW50cykKYXNzYXlzKHNjZSkKYXNzYXlzKHNjZSkkbG9nQ291bnRzWzE6NSwgMTo1XQphc3NheXMoc2NlKSRsb2dDb3VudHMgPC0gTlVMTApgYGAKCiMgT2J0YWluaW5nIGFuZCBpbmNsdWRpbmcgcm93RGF0YQoKVGhlIGByb3dEYXRhYCBzbG90IG9mIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QgYWxsb3dzIGZvciBzdG9yaW5nIAppbmZvcm1hdGlvbiBvbiB0aGUgZmVhdHVyZXMsIGkuZS4gdGhlIGdlbmVzLCBpbiBhIGRhdGFzZXQuIEluIG91ciBvYmplY3QsCnRoZSBgcm93RGF0YWAgc2xvdCBpcyBlbXB0eS4KCmBgYHtyLCBldmFsPUZBTFNFfQpyb3dEYXRhKHNjZSkKYGBgCgpBcyBzdWNoLCB0aGUgb25seSBpbmZvcm1hdGlvbiB3ZSBoYXZlIG9uIHRoZSBnZW5lcyBhcmUgdGhlaXIgbmFtZXMsIHdoaWNoIGNhbgpiZSByZXRyaWV2ZWQgYXMgdGhlIGByb3duYW1lc2Agb2YgdGhlIGV4cHJlc3Npb24gbWF0cml4LgoKYGBge3IsIGV2YWw9RkFMU0V9CmhlYWQocm93bmFtZXMoc2NlKSkKYGBgCgpUaGVzZSBhcmUgdGhlIGdlbmUgbmFtZXMgKHN5bWJvbHMpLiBOb3RlIHRoYXQgaXQgbWF5IGJlIHVzZWZ1bCB0byBpbmNsdWRlIAphZGRpdGlvbmFsIGluZm9ybWF0aW9uIGluIHRoZSBgcm93RGF0YWAgc2xvdC4gRm9yIGluc3RhbmNlLCB3ZSBtYXkgd2FudCB0byAKc3RvcmU6CgotIFVuYW1iaWd1b3VzIGdlbmUgaWRlbnRpZmllcnMgKGUuZy4gZnJvbSBFTlNFTUJMKQotIE9uIHdoaWNoIGNocm9tb3NvbWUgdGhlIGdlbmUgaXMgbG9jYXRlZAotIEdlbmUgbGVuZ3RoIChnZW5vbWljIHN0YXJ0IHBvc2l0aW9uIGFuZCBlbmQgcG9zaXRpb24pCi0gT3RoZXJzLi4uCgpgYGB7ciwgZXZhbD1GQUxTRSwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KbGlicmFyeSgiYmlvbWFSdCIpCgplbnNlbWJsNzUgPC0gdXNlRW5zZW1ibChiaW9tYXJ0ID0gJ2dlbmVzJywgCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXQgPSAnbW11c2N1bHVzX2dlbmVfZW5zZW1ibCcsCiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSA3NSkKCmhlYWQobGlzdEF0dHJpYnV0ZXMoZW5zZW1ibDc1KSkgIyBwb3RlbnRpYWwgaW5mbyB0byBleHRyYWN0CgpnZW5lSW5mbyA8LSBnZXRCTShhdHRyaWJ1dGVzID0gYygiZW5zZW1ibF9nZW5lX2lkIiwgIyBFTlNFTUJMIHVuYW1iaWd1b3VzIGlkZW50aWZpZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1naV9zeW1ib2wiLCAjIEdlbmUgc3ltYm9sICh0byBsaW5rIHdpdGggU0NFIHJvd25hbWVzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNocm9tb3NvbWVfbmFtZSIsICMgT24gd2hpY2ggY2hyb21vc29tZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhcnRfcG9zaXRpb24iLCAjIFN0YXJ0IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbmRfcG9zaXRpb24iKSwjIEVuZCBwb3NpdGlvbgogICAgICAgICAgICAgICAgICBtYXJ0ID0gZW5zZW1ibDc1KQoKaGVhZChnZW5lSW5mbykKYGBgCgpgYGB7ciwgZXZhbD1GQUxTRX0KZ2VuZUluZm8kbWdpX3N5bWJvbF91cHBlciA8LSB0b3VwcGVyKGdlbmVJbmZvJG1naV9zeW1ib2wpIAojIG1hdGNoIGJldHdlZW4gZ2VuZSBpbmZvIGFuZCByb3duYW1lcwoKc3VtKHJvd25hbWVzKHNjZSkgJWluJSBnZW5lSW5mbyRtZ2lfc3ltYm9sX3VwcGVyKQpzdW0oIXJvd25hbWVzKHNjZSkgJWluJSBnZW5lSW5mbyRtZ2lfc3ltYm9sX3VwcGVyKSAjIGxvc3QgaW4gY29udmVyc2lvbiA6KAoKcm93RGF0YShzY2UpIDwtIGdlbmVJbmZvW21hdGNoKHJvd25hbWVzKHNjZSksZ2VuZUluZm8kbWdpX3N5bWJvbF91cHBlciksXQpgYGAKCmBgYHtyLCBldmFsPUZBTFNFfQpoZWFkKHJvd0RhdGEoc2NlKSkKYGBgCgojIEZpbHRlcmluZyBub24taW5mb3JtYXRpdmUgZ2VuZXMKCmBgYHtyLCBldmFsPUZBTFNFfQpsaWJyYXJ5KGVkZ2VSKQoKIyBBIHZlcnkgc2ltcGxlIHN0cmF0ZWd5OiByZW1vdmUgYWxsIGdlbmVzIHRoYXQgYXJlIGV4cHJlc3NlZCBpbiBsZXNzIHRoYW4gMTAKIyBvdXQgb2YgNDkzMDAgY2VsbHMgLT4gbm90ZSB0aGF0IHRoaXMgYSB2ZXJ5IGxlbmllbnQgZmlsdGVyaW5nIGNyaXRlcml1bQprZWVwIDwtIHJvd1N1bXMoYXNzYXlzKHNjZSkkY291bnRzID4gMCkgPiAxMAp0YWJsZShrZWVwKQoKc2NlIDwtIHNjZVtrZWVwLF0KYGBgCgpOb3RlIHRoYXQgZGVkaWNhdGVkIGZ1bmN0aW9ucyBmb3IgZmlsdGVyaW5nIG91dCBsb3dseSBleHByZXNzZWQgZ2VuZXMgZXhpc3QuCk9uZSBzdWNoIGZ1bmN0aW9uIGlzIHRoZSBgZmlsdGVyQnlFeHByYCBmdW5jdGlvbiBvZiB0aGUgZWRnZVIgUiBwYWNrYWdlLgpJbiBicmllZiwgdGhlIHN0cmF0ZWd5IGtlZXBzIGdlbmVzIHRoYXQgaGF2ZSBhdCBsZWFzdCAibWluLmNvdW50IiByZWFkcyBpbiBhIAp3b3J0aHdoaWxlIG51bWJlciBzYW1wbGVzLiAKCk1vcmUgcHJlY2lzZWx5LCB0aGUgZmlsdGVyaW5nIGtlZXBzIGdlbmVzIHRoYXQgaGF2ZSBjb3VudC1wZXItbWlsbGlvbiAoQ1BNKSAKYWJvdmUgayBpbiBuIHNhbXBsZXMuIAoKayBpcyBkZXRlcm1pbmVkIGJ5IHRoZSBtaW4uY291bnQgYXJndW1lbnQgdG8gdGhlIGZ1bmN0aW9uLCBhbmQgYnkgdGhlIHNhbXBsZSAKbGlicmFyeSBzaXplcy4KCm4gaXMgZGV0ZXJtaW5lZCBieSB0aGUgZGVzaWduIG1hdHJpeC4gbiBjYW4gYmUgc2VlbiBhcyB0aGUgc21hbGxlc3QgZ3JvdXAgc2FtcGxlCnNpemUuIEEgYGdyb3VwYCBvZiBzYW1wbGVzL2NlbGxzIGNhbiBiZSBkZWZpbmVkIGFzIGNlbGxzIHRoYXQgYXJlIG1vcmUgc2ltaWxhcgp0byBvbmUgYW5vdGhlciwgZS5nLiwgZnJvbSB0aGUgc2FtZSBzZXF1ZW5jaW5nIGJhdGNoLCB0aGUgc2FtZSBwYXRpZW50Li4uLgpIZXJlIHdlIGNvdWxkIGFsc28gdXNlIHRoZSBjbHVzdGVyIGFzc2lnbm1lbnQgKGNlbGwgdHlwZSkgZm9yIGVhY2ggY2VsbCBhcyB0aGUKZ3JvdXBpbmcgdmFyaWFibGU7ICpub3RlIGhvd2V2ZXIsIHRoYXQgdGhpcyB1c3VhbGx5IGlzIG5vdCBhdmFpbGFibGUgdW50aWwgYSoKKmxhdGVyIHN0YWdlIGluIHRoZSBhbmFseXNpcyBwaXBlbGluZSogKGkuZS4sIGFmdGVyIGRpbWVuc2lvbiByZWR1Y3Rpb24gYW5kIApjbHVzdGVyaW5nLCB0b3BpY3Mgd2Ugd2lsbCBjb3ZlciBuZXh0IHNlc3Npb24uKQoKSWYgYWxsIHRoZSBncm91cCBzaXplcyBhcmUgbGFyZ2VyIHRoYW4gdGhlIGBsYXJnZS5uYCBhcmd1bWVudCBvZiB0aGUgCmZpbHRlckJ5RXhwciBmdW5jdGlvbiwgd2hpY2ggZGVmYXVsdHMgdG8gMTAsIHRoZW4gbiB3aWxsIGJlIHRha2VuIGFzCmBtaW4ucHJvcGAqIHRoZSB0aGUgbnVtYmVyIG9mIHNhbXBsZXMvY2VsbHMgaW4gdGhlIHNtYWxsZXN0IGdyb3VwLgoKTm90ZSB0aGF0IGFsbCB0aGUgZ3JvdXAgc2l6ZXMgd2lsbCBvZnRlbiBiZSBsYXJnZXIgdGhhbiB0aGUgYGxhcmdlLm5gIGluIGNhc2UKb2Ygc2luZ2xlLWNlbGwgZGF0YS4KCmBgYHtyLCBldmFsPUZBTFNFfQojIFNsb3cgKG1vcmUgdGhhbiAxbWluKSAtPiBkbyBub3QgcnVuCiMga2VlcDIgPC0gZmlsdGVyQnlFeHByKHNjZSwKIyAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXAgPSBzY2UkY2x1c3RlciwKIyAgICAgICAgICAgICAgICAgICAgICAgbWluLmNvdW50ID0gMSwKIyAgICAgICAgICAgICAgICAgICAgICAgbWluLnRvdGFsLmNvdW50ID0gMTUsCiMgICAgICAgICAgICAgICAgICAgICAgIG1pbi5wcm9wID0gMC4yKQojIHRhYmxlKGtlZXAyKQpgYGAKCgojIFF1YWxpdHkgY29udHJvbAoKSW4gcXVhbGl0eSBjb250cm9sIChRQyksIHdlIGNoZWNrIHRoZSBxdWFsaXR5IG9mIG91ciBkYXRhc2V0LiBJbiBwYXJ0aWN1bGFyLCAKd2UgaW52ZXN0aWdhdGUgdW5kZXNpcmFibGUgb2RkaXRpZXMsIHN1Y2ggYXMgbG93LXF1YWxpdHkgY2VsbHMsIGVtcHR5IGRyb3BsZXRzCm9yIGRvdWJsZXRzLgoKIyMgSWRlbnRpZnlpbmcgYW5kIHJlbW92aW5nIGxvdy1xdWFsaXR5IGNlbGxzCgpUaGVyZSBhcmUgc2V2ZXJhbCBkaXN0aW5ndWlzaGluZyBmZWF0dXJlcyBvZiBsb3ctcXVhbGl0eSBjZWxscyB0aGF0IGNhbiBiZSB1c2VkCmluIG9yZGVyIHRvIGlkZW50aWZ5IHRoZW0uIFtBcyBkZXNjcmliZWQgaW4gdGhlIE9TQ0EgYm9va10oaHR0cDovL2Jpb2NvbmR1Y3Rvci5vcmcvYm9va3MvMy4xNC9PU0NBLmJhc2ljL3F1YWxpdHktY29udHJvbC5odG1sKSAKYm9vayk6CgoxLiBUaGUgbGlicmFyeSBzaXplIGlzIGRlZmluZWQgYXMgdGhlIHRvdGFsIHN1bSBvZiBjb3VudHMgYWNyb3NzIGFsbCAKcmVsZXZhbnQgZmVhdHVyZXMgZm9yIGVhY2ggY2VsbC4gSGVyZSwgd2Ugd2lsbCBjb25zaWRlciB0aGUgcmVsZXZhbnQgZmVhdHVyZXMgCnRvIGJlIHRoZSBlbmRvZ2Vub3VzIGdlbmVzLiBDZWxscyB3aXRoIHNtYWxsIGxpYnJhcnkgc2l6ZXMgYXJlIG9mIGxvdyBxdWFsaXR5IAphcyB0aGUgUk5BIGhhcyBiZWVuIGxvc3QgYXQgc29tZSBwb2ludCBkdXJpbmcgbGlicmFyeSBwcmVwYXJhdGlvbiwgZWl0aGVyIGR1ZSAKdG8gY2VsbCBseXNpcyBvciBpbmVmZmljaWVudCBjRE5BIGNhcHR1cmUgYW5kIGFtcGxpZmljYXRpb24uCgoyLiBUaGUgbnVtYmVyIG9mIGV4cHJlc3NlZCBmZWF0dXJlcyBpbiBlYWNoIGNlbGwgaXMgZGVmaW5lZCBhcyB0aGUgbnVtYmVyIG9mIAplbmRvZ2Vub3VzIGdlbmVzIHdpdGggbm9uLXplcm8gY291bnRzIGZvciB0aGF0IGNlbGwuIEFueSBjZWxsIHdpdGggdmVyeSAKZmV3IGV4cHJlc3NlZCBnZW5lcyBpcyBsaWtlbHkgdG8gYmUgb2YgcG9vciBxdWFsaXR5IGFzIHRoZSBkaXZlcnNlIHRyYW5zY3JpcHQgCnBvcHVsYXRpb24gaGFzIG5vdCBiZWVuIHN1Y2Nlc3NmdWxseSBjYXB0dXJlZC4KCjMuIFdlIHNvbWV0aW1lcyBoYXZlIHNwaWtlLWluIChFUkNDKSB0cmFuc2NyaXB0cyBhdmFpbGFibGUuClRoZSBwcm9wb3J0aW9uIG9mIHJlYWRzIG1hcHBlZCB0byBzcGlrZS1pbiB0cmFuc2NyaXB0cyBpcyBjYWxjdWxhdGVkIHJlbGF0aXZlIAp0byB0aGUgdG90YWwgY291bnQgYWNyb3NzIGFsbCBmZWF0dXJlcyAoaW5jbHVkaW5nIHNwaWtlLWlucykgZm9yIGVhY2ggY2VsbC4gCkFzIHRoZSBzYW1lIGFtb3VudCBvZiBzcGlrZS1pbiBSTkEgc2hvdWxkIGhhdmUgYmVlbiBhZGRlZCB0byBlYWNoIGNlbGwsIAphbnkgZW5yaWNobWVudCBpbiBzcGlrZS1pbiBjb3VudHMgaXMgc3ltcHRvbWF0aWMgb2YgbG9zcyBvZiBlbmRvZ2Vub3VzIFJOQS4KCjQuIEluIHRoZSBhYnNlbmNlIG9mIHNwaWtlLWluIHRyYW5zY3JpcHRzLCB0aGUgcHJvcG9ydGlvbiBvZiByZWFkcyBtYXBwZWQgCnRvIGdlbmVzIGluIHRoZSBtaXRvY2hvbmRyaWFsIGdlbm9tZSBjYW4gYmUgdXNlZC4gSGlnaCBwcm9wb3J0aW9ucyBhcmUgCmluZGljYXRpdmUgb2YgcG9vci1xdWFsaXR5IGNlbGxzIChJc2xhbSBldCBhbC4gMjAxNDsgSWxpY2ljIGV0IGFsLiAyMDE2KSwgCnByZXN1bWFibHkgYmVjYXVzZSBvZiBsb3NzIG9mIGN5dG9wbGFzbWljIFJOQSBmcm9tIHBlcmZvcmF0ZWQgY2VsbHMuIApUaGUgcmVhc29uaW5nIGlzIHRoYXQsIGluIHRoZSBwcmVzZW5jZSBvZiBtb2Rlc3QgZGFtYWdlLCB0aGUgaG9sZXMgaW4gdGhlIApjZWxsIG1lbWJyYW5lIHBlcm1pdCBlZmZsdXggb2YgaW5kaXZpZHVhbCB0cmFuc2NyaXB0IG1vbGVjdWxlcyBidXQgYXJlIHRvbyAKc21hbGwgdG8gYWxsb3cgbWl0b2Nob25kcmlhIHRvIGVzY2FwZSwgbGVhZGluZyB0byBhIHJlbGF0aXZlIGVucmljaG1lbnQgb2YgCm1pdG9jaG9uZHJpYWwgdHJhbnNjcmlwdHMuIEZvciBzaW5nbGUtbnVjbGVpIFJOQS1zZXEgZXhwZXJpbWVudHMsIGhpZ2ggCnByb3BvcnRpb25zIGFyZSBhbHNvIHVzZWZ1bCBhcyB0aGV5IGNhbiBtYXJrIGNlbGxzIHdoZXJlIHRoZSBjeXRvcGxhc20gaGFzIApub3QgYmVlbiBzdWNjZXNzZnVsbHkgc3RyaXBwZWQuCgojIyBDYWxjdWxhdGUgUUMgdmFyaWFibGVzCgpUaGlzIGZ1bmN0aW9uIGNhbGN1bGF0ZXMgdXNlZnVsIFFDIG1ldHJpY3MgZm9yIGlkZW50aWZpY2F0aW9uIGFuZCByZW1vdmFsIG9mIApwb3RlbnRpYWxseSBwcm9ibGVtYXRpYyBjZWxscy4gRGVmYXVsdCBwZXItY2VsbCBtZXRyaWNzIGFyZSB0aGUgc3VtIG9mIGNvdW50cyAKKGkuZS4sIHRoZSBsaWJyYXJ5IHNpemUpIGFuZCB0aGUgbnVtYmVyIG9mIGRldGVjdGVkIGZlYXR1cmVzLiBUaGUgcGVyY2VudGFnZSBvZiAKY291bnRzIGluIHRoZSB0b3AgZmVhdHVyZXMgYWxzbyBwcm92aWRlcyBhIG1lYXN1cmUgb2YgbGlicmFyeSBjb21wbGV4aXR5LgoKSWYgc3Vic2V0cyBpcyBzcGVjaWZpZWQsIHRoZXNlIHN0YXRpc3RpY3MgYXJlIGFsc28gY29tcHV0ZWQgZm9yIGVhY2ggc3Vic2V0IG9mIApmZWF0dXJlcy4gVGhpcyBpcyB1c2VmdWwgZm9yIGludmVzdGlnYXRpbmcgZ2VuZSBzZXRzIG9mIGludGVyZXN0LCBlLmcuLCAKbWl0b2Nob25kcmlhbCBnZW5lcy4KCmBgYHtyLCBldmFsPUZBTFNFLCBtZXNzYWdlPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQpsaWJyYXJ5KHNjYXRlcikKCiMgY2hlY2sgRVJDQyBzcGlrZS1pbiB0cmFuc2NyaXB0cwpzdW0oZ3JlcGwoIl5FUkNDLSIsIHJvd25hbWVzKHNjZSkpKSAjIG5vIHNwaWtlLWluIHRyYW5zY3JpcHRzIGF2YWlsYWJsZQoKIyBjaGVjayBtaXRvY2hvbmRyaWFsIGdlbmVzCnN1bShyb3dEYXRhKHNjZSkkY2hyb21vc29tZV9uYW1lPT0iTVQiLG5hLnJtID0gVFJVRSkgIyAyOCBtaXRvY2hvbmRyaWFsIGdlbmVzCnN1bShncmVwbCgiXk1ULSIsIHJvd25hbWVzKHNjZSkpKSAjIGFsdGVybmF0aXZlbHkKaXMubWl0byA8LSBncmVwbCgiXk1ULSIsIHJvd25hbWVzKHNjZSkpCgojIyBjYWxjdWxhdGUgUUMgbWV0cmljcwpkZiA8LSBwZXJDZWxsUUNNZXRyaWNzKHNjZSwgc3Vic2V0cz1saXN0KE1pdG89aXMubWl0bykpCmhlYWQoZGYpCgojIGFkZCBRQyB2YXJpYWJsZXMgdG8gc2NlIG9iamVjdApjb2xEYXRhKHNjZSkgPC0gY2JpbmQoY29sRGF0YShzY2UpLCBkZikKCiMgdGhlIFFDIHZhcmlhYmxlcyBoYXZlIG5vdyBiZWVuIGFkZGVkIHRvIHRoZSBjb2xEYXRhIG9mIG91ciBTQ0Ugb2JqZWN0LgpoZWFkKGNvbERhdGEoc2NlKSkKYGBgCgojIyBFeHBsb3JhdG9yeSBkYXRhIGFuYWx5c2lzCgpJbiB0aGUgZmlndXJlIGJlbG93LCB3ZSBzZWUgdGhhdCBzZXZlcmFsIGNlbGxzIGhhdmUgYSB2ZXJ5IGxvdyBudW1iZXIgb2YgCmV4cHJlc3NlZCBnZW5lcywgYW5kIHdoZXJlIG1vc3Qgb2YgdGhlIG1vbGVjdWxlcyBhcmUgZGVyaXZlZCBmcm9tIAptaXRvY2hvbmRyaWFsIGdlbmVzLiBUaGlzIGluZGljYXRlcyBsaWtlbHkgZGFtYWdlZCBjZWxscywgcHJlc3VtYWJseSBiZWNhdXNlIApvZiBsb3NzIG9mIGN5dG9wbGFzbWljIFJOQSBmcm9tIHBlcmZvcmF0ZWQgY2VsbHMsIHNvIHdlIHNob3VsZCByZW1vdmUgdGhlc2UgZm9yIAp0aGUgZG93bnN0cmVhbSBhbmFseXNpcy4KCmBgYHtyLCBldmFsPUZBTFNFfQojIE51bWJlciBvZiBnZW5lcyB2cyBsaWJyYXJ5IHNpemUKcGxvdENvbERhdGEoc2NlLCB4ID0gInN1bSIsIHk9ImRldGVjdGVkIiwgY29sb3VyX2J5PSJjbHVzdGVyIikgCgojIE1pdG9jaG9uZHJpYWwgZ2VuZXMKcGxvdENvbERhdGEoc2NlLCB4ID0gImRldGVjdGVkIiwgeT0ic3Vic2V0c19NaXRvX3BlcmNlbnQiKQpgYGAKCiMjIFFDIHVzaW5nIGFkYXB0aXZlIHRocmVzaG9sZHMKCkJlbG93LCB3ZSByZW1vdmUgY2VsbHMgdGhhdCBhcmUgb3V0bHlpbmcgd2l0aCByZXNwZWN0IHRvCgogMS4gQSBsb3cgc2VxdWVuY2luZyBkZXB0aCAobnVtYmVyIG9mIFVNSXMpOwogMi4gQSBsb3cgbnVtYmVyIG9mIGdlbmVzIGRldGVjdGVkOwogMy4gQSBoaWdoIHBlcmNlbnRhZ2Ugb2YgcmVhZHMgZnJvbSBtaXRvY2hvbmRyaWFsIGdlbmVzLgogCiBIZXJlIHdlIHdpbGwgcmVtb3ZlIGNlbGxzIGZvciBRQyBiYXNlZCBvbiAqKmFkYXB0aXZlIHRocmVzaG9sZHMqKiByZWxhdGVkIHRvCiB0aGUgdGhyZWUgcG9pbnRzIGZyb20gYWJvdmUuIEFkYXB0aXZlIHRyaGVzaG9sZHMgYXJlIHVzZWQgYXMgb3Bwb3NlZCB0bwogKipmaXhlZCB0aHJlc2hvbGRzKiouIAogCldpdGggZml4ZWQgdGhyZXNob2xkcywgd2UgdXNlIGZpeGVkIGN1dC1vZmYgdmFsdWVzIGZvciBlYWNoIGNlbGwgdG8gcGFzcyBRQywgCmUuZy4sIHdlIG1pZ2h0IGNvbnNpZGVyIGNlbGxzIHRvIGJlIGxvdyBxdWFsaXR5IGlmIHRoZXkgaGF2ZSBsaWJyYXJ5IHNpemVzIApiZWxvdyAxMDAsMDAwIHJlYWRzOyBleHByZXNzIGZld2VyIHRoYW4gNSwwMDAgZ2VuZXM7IGhhdmUgc3Bpa2UtaW4gcHJvcG9ydGlvbnMKYWJvdmUgMTAlOyBvciBoYXZlIG1pdG9jaG9uZHJpYWwgcHJvcG9ydGlvbnMgYWJvdmUgMTAlLgoKV2l0aCBhZGFwdGl2ZSB0aHJlc2hvbGRzLCB3ZSBhc3N1bWUgdGhhdCBtb3N0IG9mIHRoZSBkYXRhc2V0IGNvbnNpc3RzIG9mIApoaWdoLXF1YWxpdHkgY2VsbHMuIFdlIHRoZW4gaWRlbnRpZnkgY2VsbHMgdGhhdCBhcmUgb3V0bGllcnMgZm9yIHRoZSB2YXJpb3VzIApRQyBtZXRyaWNzLCBiYXNlZCBvbiB0aGUgbWVkaWFuIGFic29sdXRlIGRldmlhdGlvbiAoTUFEKSBmcm9tIHRoZSBtZWRpYW4gdmFsdWUKb2YgZWFjaCBtZXRyaWMgYWNyb3NzIGFsbCBjZWxscy4gQnkgZGVmYXVsdCwgd2UgY29uc2lkZXIgYSB2YWx1ZSB0byBiZSBhbm91dGxpZXIgCmlmIGl0IGlzIG1vcmUgdGhhbiAzIE1BRHMgZnJvbSB0aGUgbWVkaWFuIGluIHRoZSDigJxwcm9ibGVtYXRpY+KAnSBkaXJlY3Rpb24uIFRoaXMgCmlzIGxvb3NlbHkgbW90aXZhdGVkIGJ5IHRoZSBmYWN0IHRoYXQgc3VjaCBhIGZpbHRlciB3aWxsIHJldGFpbiA5OSUgb2YgCm5vbi1vdXRsaWVyIHZhbHVlcyB0aGF0IGZvbGxvdyBhIG5vcm1hbCBkaXN0cmlidXRpb24uIFdlIGRlbW9uc3RyYXRlIGFkb3B0aW5nCmFkYXB0aXZlIHRocmVzaG9sZHMgb24gdGhlIE1hY29za28gZGF0YXNldDoKCmBgYHtyLCBldmFsPUZBTFNFfQpsb3dMaWIgPC0gaXNPdXRsaWVyKGRmJHN1bSwgdHlwZT0ibG93ZXIiLCBsb2c9VFJVRSkKbG93RmVhdHVyZXMgPC0gaXNPdXRsaWVyKGRmJGRldGVjdGVkLCB0eXBlPSJsb3dlciIsIGxvZz1UUlVFKQpoaWdoTWl0byA8LSBpc091dGxpZXIoZGYkc3Vic2V0c19NaXRvX3BlcmNlbnQsIHR5cGU9ImhpZ2hlciIpCgp0YWJsZShsb3dMaWIpCnRhYmxlKGxvd0ZlYXR1cmVzKQp0YWJsZShoaWdoTWl0bykKCmRpc2NhcmRDZWxscyA8LSAobG93TGliIHwgbG93RmVhdHVyZXMgfCBoaWdoTWl0bykKdGFibGUoZGlzY2FyZENlbGxzKQpjb2xEYXRhKHNjZSkkZGlzY2FyZENlbGxzIDwtIGRpc2NhcmRDZWxscwoKIyB2aXN1YWxpemUgY2VsbHMgdG8gYmUgcmVtb3ZlZApwbG90Q29sRGF0YShzY2UsIHggPSAic3VtIiwgeT0iZGV0ZWN0ZWQiLCBjb2xvdXJfYnk9ImRpc2NhcmRDZWxscyIpCnBsb3RDb2xEYXRhKHNjZSwgeCA9ICJkZXRlY3RlZCIsIHk9InN1YnNldHNfTWl0b19wZXJjZW50IiwgY29sb3VyX2J5ID0gImRpc2NhcmRDZWxscyIpCmBgYAoKV2UgcmVtb3ZlZCBhIHRvdGFsIG9mICQzNDIzJCBjZWxscywgbW9zdCBvZiB3aGljaCBiZWNhdXNlIG9mIGFuIG91dGx5aW5nbHkgaGlnaCAKcGVyY2VudGFnZSBvZiByZWFkcyBmcm9tIG1pdG9jaG9uZHJpYWwgZ2VuZXMuCgojIyBJZGVudGlmeWluZyBhbmQgcmVtb3ZpbmcgZW1wdHkgZHJvcGxldHMKCk5vdGUgdGhhdCB0aGUgcmVtb3ZhbCBvZiBjZWxscyB3aXRoIGxvdyBzZXF1ZW5jaW5nIGRlcHRoIHVzaW5nIHRoZSBhZGFwdGl2ZSAKdGhyZXNob2xkIHByb2NlZHVyZSBhYm92ZSBpcyBhIHdheSBvZiByZW1vdmluZyBlbXB0eSBkcm9wbGV0cy4gCk90aGVyIGFwcHJvYWNoZXMgYXJlIHBvc3NpYmxlLCBlLmcuLCByZW1vdmluZyBjZWxscyBieSBzdGF0aXN0aWNhbCB0ZXN0aW5nIAp1c2luZyBgZW10cHlEcm9wc2AuIFRoaXMgZG9lcyByZXF1aXJlIHVzIHRvIHNwZWNpZnkgYSBsb3dlciBib3VuZCBvbiB0aGUgdG90YWwgCm51bWJlciBvZiBVTUlzLCBiZWxvdyB3aGljaCBhbGwgY2VsbHMgYXJlIGNvbnNpZGVyZWQgdG8gY29ycmVzcG9uZCB0byBlbXB0eSAKZHJvcGxldHMuIFRoaXMgbG93ZXIgYm91bmQgbWF5IG5vdCBiZSB0cml2aWFsIHRvIGRlcml2ZSwgYnV0IHRoZSBgYmFyY29kZVJhbmtzYApmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHRvIGlkZW50aWZ5IGFuIGVsYm93L2tuZWUgcG9pbnQuCgpJbiBicmllZiwgdGhlIHN0ZXBzIHRha2VuIGJ5IHRoZSBgZW10cHlEcm9wc2AgZnVuY3Rpb24gY2FuIGJlIHN1bW1hcml6ZWQgYXMgCmZvbGxvd3M6CgoxLglEZWZpbmUgdGhyZXNob2xkIFQgb2YgdG90YWwgVU1JIGNvdW50cyAoZS5nLiB3aXRoIHRoZSBoZWxwIG9mIHRoZSAKYGJhcmNvZGVSYW5rc2AgZnVuY3Rpb24pLCBiZWxvdyB3aGljaCBjZWxscyBtYXkgYmUgY29uc2lkZXJlZCB0byBiZSBmcm9tIGVtcHR5IApkcm9wbGV0cy4gQ2FsbCB0aGlzIHNldCBvZiBjZWxscyBFLgoKMi4JRGVmaW5lICRBX2ckIGFzIHRoZSB0b3RhbCBnZW5lIGV4cHJlc3Npb24gYWNyb3NzIGFsbCBjZWxscyBpbiBFLgoKMy4JRGVmaW5lICRwaV9nJCBhcyB0aGUgcmVsYXRpdmUgY29udHJpYnV0aW9uIG9mIGdlbmUgZyB0byB0aGUgYW1iaWVudCBwcm9maWxlLgoKNC4JQ2FsY3VsYXRlIHAtdmFsdWUgZm9yIGVhY2ggY2VsbCB0byBoYXZlIGEgdHJhbnNjcmlwdGlvbmFsIHByb2ZpbGUgc2ltaWxhciB0bwp0aGUgYW1iaWVudCBzb2x1dGlvbi4gSW50dWl0aXZlbHksIGEgcC12YWx1ZSBiZWxvdyB0aGUgcmVxdWVzdGVkIGFscGhhIGxldmVsIAp3b3VsZCBjb3JyZXNwb25kIHRvIGEgY2VsbCBmb3Igd2hpY2ggdGhlIG9ic2VydmVkIGNvdW50IHByb2ZpbGUgc3Ryb25nbHkgCmRldmlhdGVzIGZyb20gdGhlIGNvdW50IHByb2ZpbGUgb2JzZXJ2ZWQgaW4gdGhlIGNlbGxzIHdpdGggYSBsaWJyYXJ5IHNpemUgCmJlbG93IHRocmVzaG9sZCBULCBpLmUuLCBhIG5vbi1lbXB0eSBkcm9wbGV0LgoKYGBge3IsIGV2YWw9RkFMU0UsIG1lc3NhZ2U9RkFMU0UsIHdhcm5pbmc9RkFMU0V9CmxpYnJhcnkoRHJvcGxldFV0aWxzKQpiY3JhbmsgPC0gYmFyY29kZVJhbmtzKGNvdW50cyhzY2UpKQoKIyBPbmx5IHNob3dpbmcgdW5pcXVlIHBvaW50cyBmb3IgcGxvdHRpbmcgc3BlZWQuIER1cGxpY2F0ZWQgcmFua3MgYXJlIGEgCiMgY29uc2VxdWVuY2Ugb2YgdGllcyBpbiB0aGUgcmFua3MsIGkuZS4sIHdoZW4gY2VsbHMgaGF2ZSBhbiBlcXVhbCBsaWJyYXJ5IHNpemUuCnN1bShkdXBsaWNhdGVkKGJjcmFuayRyYW5rKSkKdW5pcSA8LSAhZHVwbGljYXRlZChiY3JhbmskcmFuaykKCnBsb3QoYmNyYW5rJHJhbmtbdW5pcV0sIGJjcmFuayR0b3RhbFt1bmlxXSwgbG9nPSJ4eSIsCiAgICB4bGFiPSJSYW5rIiwgeWxhYj0iVG90YWwgVU1JIGNvdW50IiwgY2V4LmxhYj0xLjIpCmFibGluZShoPW1ldGFkYXRhKGJjcmFuaykkaW5mbGVjdGlvbiwgY29sPSJkYXJrZ3JlZW4iLCBsdHk9MikKYWJsaW5lKGg9bWV0YWRhdGEoYmNyYW5rKSRrbmVlLCBjb2w9ImRvZGdlcmJsdWUiLCBsdHk9MikKYWJsaW5lKGg9MzUwLCBjb2w9Im9yYW5nZSIsIGx0eT0yKSAjIHBpY2tlZCB2aXN1YWxseSBteXNlbGYKbGVnZW5kKCJ0b3ByaWdodCIsIAogICAgICAgbGVnZW5kPWMoIkluZmxlY3Rpb24iLCAiS25lZSIsICJFbXBpcmljYWwga25lZSBwb2ludCIpLCAKICAgICAgIGNvbD1jKCJkYXJrZ3JlZW4iLCAiZG9kZ2VyYmx1ZSIsICJvcmFuZ2UiKSwgCiAgICAgICBsdHk9MiwgCiAgICAgICBjZXg9MS4yKQoKc2V0LnNlZWQoMTAwKQpsaW1pdCA8LSAzNTAgICAKYWxsLm91dCA8LSBlbXB0eURyb3BzKGNvdW50cyhzY2UpLCBsb3dlcj1saW1pdCwgdGVzdC5hbWJpZW50PVRSVUUpCiMgcC12YWx1ZXMgZm9yIGNlbGxzIHdpdGggdG90YWwgVU1JIGNvdW50IHVuZGVyIHRoZSBsb3dlciBib3VuZC4KaGlzdChhbGwub3V0JFBWYWx1ZVthbGwub3V0JFRvdGFsIDw9IGxpbWl0ICYgYWxsLm91dCRUb3RhbCA+IDBdLAogICAgeGxhYj0iUC12YWx1ZSIsIG1haW49IiIsIGNvbD0iZ3JleTgwIiwgYnJlYWtzPTIwKQoKIyBidXQgbm90ZSB0aGF0IGl0IHdvdWxkIHJlbW92ZSBhIHZlcnkgaGlnaCBudW1iZXIgb2YgY2VsbHMKbGVuZ3RoKHdoaWNoKGFsbC5vdXQkRkRSIDw9IDAuMDEpKSAjIHJldGFpbmVkCgojIHNvIHdlIHN0aWNrIHRvIHRoZSBtb3JlIGxlbmllbnQgYWRhcHRpdmUgZmlsdGVyaW5nIHN0cmF0ZWd5CiMgcmVtb3ZlIGNlbGxzIGlkZW50aWZpZWQgdXNpbmcgYWRhcHRpdmUgdGhyZXNob2xkcwpzY2UgPC0gc2NlWywgIWNvbERhdGEoc2NlKSRkaXNjYXJkQ2VsbHNdCmBgYAoKIyMgSWRlbnRpZnlpbmcgYW5kIHJlbW92aW5nIGRvdWJsZXRzCgpXZSB3aWxsIHVzZSAKW3NjRGJsRmluZGVyXShodHRwczovL2Jpb2NvbmR1Y3Rvci5vcmcvcGFja2FnZXMvMy4xNC9iaW9jL2h0bWwvc2NEYmxGaW5kZXIuaHRtbCkgCnRvIGRldGVjdCBkb3VibGV0IGNlbGxzLgoKQXMgZGlzY3Vzc2VkIGluIHRoZSB0aGVvcnkgc2Vzc2lvbiBvZiBsYXN0IHdlZWssIHRoZSBzdGVwcyB0YWtlbiBieSAKYHNjRGJsRmluZGVyYCBjYW4gYmUgc3VtbWFyaXplZCBhcyBmb2xsb3dzOgoKMS4gUGVyZm9ybSBwcmluY2lwYWwgY29tcG9uZW50cyBhbmFseXNpcyAoUENBKSBvbiBsb2ctbm9ybWFsaXplZCBleHByZXNzaW9uIApjb3VudHMuIFRoaXMgYWxsb3dzIGZvciBwcm9qZWN0aW5nIGVhY2ggY2VsbCBpbiB0aGUgZGF0YXNldCBpbnRvIGEgMkQgc3BhY2UKKGZvciBtb3JlIGRldGFpbHMgb24gUENBLCBzZWUgbmV4dCB3ZWVrcyBzZXNzaW9uKS4KCjIuIFJhbmRvbWx5IHNlbGVjdCB0d28gY2VsbHMsIHN1bSB0aGVpciBjb3VudHMgYW5kIG5vcm1hbGl6ZSwgYW5kIHByb2plY3QgCmludG8gUENBIHNwYWNlIGZyb20gc3RlcCAxLiBJbiBvdGhlciB3b3JkcywgYXJ0aWZpY2lhbGx5IGdlbmVyYXRlIGRvdWJsZXRzIGFuZApzZWUgd2hlcmUgdGhleSBhcmUgbG9jYXRlZCBpbiB0aGUgMkQgc3BhY2UuCgozLiBSZXBlYXQgc3RlcCAyIG1hbnkgdGltZXMgKGdlbmVyYXRlIG1hbnkgYXJ0aWZpY2lhbCBkb3VibGV0cykuCgo0LiBHZW5lcmF0ZSBuZWlnaGJvciBuZXR3b3JrIGluIHRoZSAyRCBzcGFjZS4gVGhlIG5ldHdvcmsgaXMgdGhlbiB1c2VkIHRvIAplc3RpbWF0ZSBhIG51bWJlciBvZiBjaGFyYWN0ZXJpc3RpY3MgZm9yIGVhY2ggY2VsbCwgaW4gcGFydGljdWxhciB0aGUgcHJvcG9ydGlvbiAKZiBhcnRpZmljaWFsIGRvdWJsZXRzIGFtb25nIHRoZSBuZWFyZXN0IG5laWdoYm9ycy4KCjUuIFVzZSB0aGlzIGluZm9ybWF0aW9uLCBhbG9uZyB3aXRoIG90aGVyIHByZWRpY3RvcnMsIHRvIHRyYWluIGEgY2xhc3NpZmllcgooZ3JhZGllbnQgYm9vc3RlZCB0cmVlKSB0aGF0IGFsbG93cyBmb3IgZGlzdGluZ3Vpc2hpbmcgZG91YmxldHMgZnJvbSBzaW5nbGV0cy4KCk5vdGU6IG9ubHkgY2xhc3NpZmllcyBmb3IgaWRlbnRpZnlpbmcgZG91YmxldHMgZm9yIHdoaWNoIHRoZSB0d28gY2VsbHMKYXJlIGZyb20gZGlmZmVyZW50IGNlbGwgdHlwZSBjbHVzdGVycy4KCgpgYGB7ciwgZXZhbD1GQUxTRSwgbWVzc2FnZT1GQUxTRSwgd2FybmluZz1GQUxTRX0KIyMgcGVyZm9ybSBkb3VibGV0IGRldGVjdGlvbgpsaWJyYXJ5KHNjRGJsRmluZGVyKQpgYGAKCmBgYHtyLCBldmFsPUZBTFNFfQpzZXQuc2VlZCgyMTExMDMpCnNhbXBsZUlEIDwtIHVubGlzdChsYXBwbHkoc3Ryc3BsaXQoY29sRGF0YShzY2UpJGNlbGwuaWQsIHNwbGl0PSJfIiksICJbWyIsIDEpKQp0YWJsZShzYW1wbGVJRCkKc2NlIDwtIHNjRGJsRmluZGVyKHNjZSwgCiAgICAgICAgICAgICAgICAgICByZXR1cm5UeXBlPSJ0YWJsZSIsCiAgICAgICAgICAgICAgICAgICBzYW1wbGVzID0gZmFjdG9yKHNhbXBsZUlEKSkKdGFibGUoc2NlJHNjRGJsRmluZGVyLmNsYXNzKQoKCiMjIHZpc3VhbGl6ZSB0aGVzZSBzY29yZXMKIyMgZXhwbG9yZSBkb3VibGV0IHNjb3JlIHdydCBvcmlnaW5hbCBjbHVzdGVyIGxhYmVscwpib3hwbG90KGxvZzFwKHNjZSRzY0RibEZpbmRlci5zY29yZSkgfiBmYWN0b3IoY29sRGF0YShzY2UpJGNsdXN0ZXIsIGV4Y2x1ZGU9TlVMTCkpCgp0YWIgPC0gdGFibGUoc2NlJHNjRGJsRmluZGVyLmNsYXNzLCBzY2UkY2x1c3RlciwgCiAgICAgIGV4Y2x1ZGU9TlVMTCkKdGFiCnQodCh0YWIpIC8gY29sU3Vtcyh0YWIpKQoKYmFycGxvdCh0KHQodGFiKSAvIGNvbFN1bXModGFiKSlbMixdLAogICAgICAgIHhsYWIgPSAiQ2x1c3RlciIsIHlsYWIgPSAiRnJhY3Rpb24gb2YgZG91YmxldHMiKQoKcmFuZ2Uoc2NlJHNjRGJsRmluZGVyLnNjb3JlW3NjZSRzY0RibEZpbmRlci5jbGFzcyAgPT0gImRvdWJsZXQiICYgc2FtcGxlSUQgPT0gInIxIl0pCnJhbmdlKHNjZSRzY0RibEZpbmRlci5zY29yZVtzY2Ukc2NEYmxGaW5kZXIuY2xhc3MgID09ICJzaW5nbGV0IiAmIHNhbXBsZUlEID09ICJyMSJdKQpgYGAKCmBgYHtyLCBldmFsPUZBTFNFfQojIHJlbW92ZSBkb3VibGV0cwpzY2UgPC0gc2NlWywhc2NlJHNjRGJsRmluZGVyLmNsYXNzID09ICJkb3VibGV0Il0KYGBgCgojIE5vcm1hbGl6YXRpb24KCk5vcm1hbGl6YXRpb24gYWltcyB0byByZW1vdmUgdGVjaG5pY2FsIGVmZmVjdHMgc3VjaCBhcyBzZXF1ZW5jaW5nIGRlcHRoIHNvIHRoYXQgCmNvbXBhcmlzb25zIGJldHdlZW4gY2VsbHMgYXJlIG5vdCBjb25mb3VuZGVkIGJ5IHRoZW0uIFRoZSBtb3N0IGNvbW1vbmx5IHVzZWQgCm5vcm1hbGl6YXRpb24gbWV0aG9kcyBtZXRob2RzIHVzZSBzY2FsaW5nLCB3aGVyZSBhIHNjYWxpbmcgZmFjdG9yIChhbHNvIGNhbGxlZCAKc2l6ZSBmYWN0b3IsIG5vcm1hbGl6YXRpb24gZmFjdG9yKSBpcyBlc3RpbWF0ZWQgZm9yIGVhY2ggY2VsbC4gVGhlc2Ugc2NhbGluZyAKZmFjdG9ycyAoZS5nLiwgdGhlIGVmZmVjdGl2ZSBsaWJyYXJ5IHNpemUpIGNhbiBiZSBpbmNsdWRlZCBhcyBhbiBvZmZzZXQKdG8gZG93bnN0cmVhbSBtb2RlbGluZyBwcm9jZWR1cmVzLiBUaGlzIGVmZmVjdGl2ZWx5IGFsbG93cyBmb3IgcGVyZm9ybWluZwppbmZlcmVuY2Ugb24gdGhlIHJlbGF0aXZlIGFidW5kYW5jZSBvZiBhIGdlbmUgaW4gYSBjZWxsLCBhZnRlciBhY2NvdW50aW5nIGZvciAKbGlicmFyeSBzaXplIGFuZCBSTkEgY29tcG9zaXRpb24gZGlmZmVyZW5jZXMgYmV0d2VlbiBjZWxscywgd2hpY2ggaXMgbXVjaCBtb3JlCnJlbGV2YW50IHRoYW4gY29tcGFyaW5nIHJhdyBjb3VudHMKCk5vdGUgdGhhdCB3ZSBhbHdheXMgcHJlZmVyIHRoZSB1c2Ugb2Ygb2Zmc2V0cyBvdmVyIHRyYW5zZm9ybWF0aW9uIG9mIHRoZSBkYXRhLgpJbiBicmllZiwgc3VjaCB0cmFuc2Zvcm1hdGlvbiB3b3VsZCBkaXN0b3J0IHRoZSBtZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcAppbiB0aGUgZGF0YS4gRm9yIG1vcmUgZGV0YWlscywgd2UgcmVmZXIgdG8gdGhlIGRvY3VtZW50IHRoYXQgd2FzIGRpc2N1c3NlZAppbiB0aGVvcnkgc2Vzc2lvbiBvZiBsYXN0IHdlZWsKKFtsaW5rXShodHRwczovL3N0YXRvbWljcy5naXRodWIuaW8vU0dBMjEvc2VxdWVuY2luZ19zY2FsaW5nTm9ybWFsaXphdGlvbi5odG1sKSkKCkZvciBub3JtYWxpemF0aW9uLCB0aGUgc2l6ZSBmYWN0b3JzICRzX2kkIGNvbXB1dGVkIGhlcmUgYXJlIHNpbXBseSBzY2FsZWQgCmxpYnJhcnkgc2l6ZXM6ClxbIE5faSA9IFxzdW1fZyBZX3tnaX0gXF0KXFsgc19pID0gTl9pIC8gXGJhcntOfV9pIFxdCgpgYGB7ciwgZXZhbD1GQUxTRX0Kc2NlIDwtIGxvZ05vcm1Db3VudHMoc2NlKQoKIyBub3RlIHdlIGFsc28gcmV0dXJuZWQgbG9nIGNvdW50czogc2VlIHRoZSBhZGRpdGlvbmFsIGxvZ2NvdW50cyBhc3NheS4Kc2NlCgojIHlvdSBjYW4gZXh0cmFjdCBzaXplIGZhY3RvcnMgdXNpbmcKc2YgPC0gbGlicmFyeVNpemVGYWN0b3JzKHNjZSkKbWVhbihzZikgIyBlcXVhbCB0byAxIGR1ZSB0byBzY2FsaW5nLgpwbG90KHg9IGxvZyhjb2xTdW1zKGFzc2F5cyhzY2UpJGNvdW50cykpLCAKICAgICB5PXNmKQpgYGAKCkZyb20gdGhlIE9TQ0EgYm9vazoKQWx0ZXJuYXRpdmVseSwgd2UgbWF5IHVzZSBtb3JlIHNvcGhpc3RpY2F0ZWQgYXBwcm9hY2hlcyBmb3IgdmFyaWFuY2Ugc3RhYmlsaXppbmcgCnRyYW5zZm9ybWF0aW9ucyBpbiBnZW5vbWljcyBkYXRhLCBlLmcuLCBgREVTZXEyYCBvciBgc2N0cmFuc2Zvcm1gLiBUaGVzZSBhaW0gCnRvIHJlbW92ZSB0aGUgbWVhbi12YXJpYW5jZSB0cmVuZCBtb3JlIGVmZmVjdGl2ZWx5IHRoYW4gdGhlIHNpbXBsZXIgCnRyYW5zZm9ybWF0aW9ucyBtZW50aW9uZWQgYWJvdmUsIHRob3VnaCBpdCBjb3VsZCBiZSBhcmd1ZWQgd2hldGhlciB0aGlzIGlzIAphY3R1YWxseSBkZXNpcmFibGUuIEZvciBsb3ctY292ZXJhZ2Ugc2NSTkEtc2VxIGRhdGEsIHRoZXJlIHdpbGwgYWx3YXlzIGJlIGEgCm1lYW4tdmFyaWFuY2UgdHJlbmQgdW5kZXIgYW55IHRyYW5zZm9ybWF0aW9uLCBmb3IgdGhlIHNpbXBsZSByZWFzb24gdGhhdCB0aGUgCnZhcmlhbmNlIG11c3QgYmUgemVybyB3aGVuIHRoZSBtZWFuIGNvdW50IGlzIHplcm8uIFRoZXNlIG1ldGhvZHMgYWxzbyBmYWNlIHRoZSAKY2hhbGxlbmdlIG9mIHJlbW92aW5nIHRoZSBtZWFuLXZhcmlhbmNlIHRyZW5kIHdoaWxlIHByZXNlcnZpbmcgdGhlIGludGVyZXN0aW5nIApjb21wb25lbnQgb2YgdmFyaWF0aW9uLCBpLmUuLCB0aGUgbG9nLWZvbGQgY2hhbmdlcyBiZXR3ZWVuIHN1YnBvcHVsYXRpb25zOyB0aGlzIAptYXkgb3IgbWF5IG5vdCBiZSBkb25lIGFkZXF1YXRlbHksIGRlcGVuZGluZyBvbiB0aGUgYWdncmVzc2l2ZW5lc3Mgb2YgCnRoZSBhbGdvcml0aG0uCgpJbiBwcmFjdGljZSwgdGhlIGxvZy10cmFuc2Zvcm1hdGlvbiBpcyBhIGdvb2QgZGVmYXVsdCBjaG9pY2UgZHVlIHRvIGl0cyAKc2ltcGxpY2l0eSBhbmQgaW50ZXJwcmV0YWJpbGl0eSwgYW5kIGlzIHdoYXQgd2Ugd2lsbCBiZSB1c2luZyBmb3IgYWxsIApkb3duc3RyZWFtIGFuYWx5c2VzLgoKLS0tCgotLS0gZW5kIGxhYiBzZXNzaW9uIDEgLS0tCgotLS0KCldlIGhhdmUgY3JlYXRlZCBhIApbRHJvcEJveCBmb2xkZXJdKGh0dHBzOi8vd3d3LmRyb3Bib3guY29tL3NoLzN5YzkwNjVyaTc2YjJlNy9BQUFyMHo5WkdwM0FQWi1yZUg2STBER1FhP2RsPTApIApjb250YWluaW5nIGNvbnZlbmllbmNlIGZpbGVzLCBlLmcuLCBhIHByZXByb2Nlc3NlZCBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIHRoYXQgCmlzIHRoZSBlbmQgcmVzdWx0IG9mIGxhYiBzZXNzaW9uIDEuIFlvdSBtYXkgd2FudCB0byBkb3dubGFvZCB0aGVtIGFuZCBpbXBvcnQgdGhlbSBpbiB0aGUgY29kZSBjaHVuayBiZWxvdy4KCmBgYHtyLCBldmFsPUZBTFNFfQpgYGAKCiMgTm9ybWFsaXphdGlvbiAoY29udGludWVkKQoKTm9ybWFsaXphdGlvbiBpcyBuZWNlc3NhcnkgdG8gY29ycmVjdCBmb3Igc2V2ZXJhbCBzb3VyY2VzIG9mIHRlY2huaWNhbCAKdmFyaWF0aW9uOgoKIC0gKipEaWZmZXJlbmNlcyBpbiBzZXF1ZW5jaW5nIGRlcHRoKiogYmV0d2VlbiBzYW1wbGVzLiBTb21lIHNhbXBsZXMgZ2V0IAogc2VxdWVuY2VkIGRlZXBlciBpbiB0aGUgc2Vuc2UgdGhhdCB0aGV5IGNvbnNpc3Qgb2YgbW9yZSAobWFwcGVkKSByZWFkcyBhbmQgCiB0aGVyZWZvcmUgY2FuIGJlIGNvbnNpZGVyZWQgdG8gY29udGFpbiBhIGhpZ2hlciBhbW91bnQgb2YgaW5mb3JtYXRpb24sIHdoaWNoIAogd2Ugc2hvdWxkIGJlIHRha2luZyBpbnRvIGFjY291bnQuIEluIGFkZGl0aW9uLCBpZiBhIHNhbXBsZSBpcyBzZXF1ZW5jZWQgZGVlcGVyLCAKIGl0IGlzIG5hdHVyYWwgdGhhdCB0aGUgY291bnRzIGZvciBlYWNoIGdlbmUgd2lsbCBiZSBoaWdoZXIsIGplb3BhcmRpemluZyBhIAogZGlyZWN0IGNvbXBhcmlzb24gb2YgdGhlIGV4cHJlc3Npb24gY291bnRzLgogLSAqKkRpZmZlcmVuY2VzIGluIFJOQSBwb3B1bGF0aW9uIGNvbXBvc2l0aW9uKiogYmV0d2VlbiBzYW1wbGVzLiBBcyBhbiBleHRyZW1lIAogZXhhbXBsZSwgc3VwcG9zZSB0aGF0IHR3byBzYW1wbGVzIGhhdmUgYmVlbiBzZXF1ZW5jZWQgdG8gdGhlIGV4YWN0IHNhbWUgZGVwdGguCiBPbmUgc2FtcGxlIGlzIGNvbnRhbWluYXRlZCBhbmQgaGFzIGEgdmVyeSBoaWdoIGNvbmNlbnRyYXRpb24gb2YgdGhlIAogY29udGFtaW5hbnQgY0ROQSBiZWluZyBzZXF1ZW5jZWQsIGJ1dCBvdGhlcndpc2UgdGhlIHR3byBzYW1wbGVzIGFyZSBpZGVudGljYWwuIAogU2luY2UgdGhlIGNvbnRhbWluYW50IHdpbGwgYmUgdGFraW5nIHVwIGEgc2lnbmlmaWNhbnQgcHJvcG9ydGlvbiBvZiB0aGUgcmVhZHMgCiBiZWluZyBzZXF1ZW5jZWQsIHRoZSBjb3VudHMgd2lsbCBub3QgYmUgZGlyZWN0bHkgY29tcGFyYWJsZSBiZXR3ZWVuIHRoZSAKIHNhbXBsZXMuIEhlbmNlLCB3ZSBtYXkgYWxzbyB3YW50IHRvIGNvcnJlY3QgZm9yIGRpZmZlcmVuY2VzIGluIHRoZSBjb21wb3NpdGlvbiAKIG9mIHRoZSBSTkEgcG9wdWxhdGlvbiBvZiB0aGUgc2FtcGxlcwogKHNlZSBbZWRnZVIgbWFudWFsIGNoYXB0ZXIgMi44XShodHRwczovL3d3dy5iaW9jb25kdWN0b3Iub3JnL3BhY2thZ2VzL3JlbGVhc2UvYmlvYy92aWduZXR0ZXMvZWRnZVIvaW5zdC9kb2MvZWRnZVJVc2Vyc0d1aWRlLnBkZikpLgogLSAqKk90aGVyIHRlY2huaWNhbCB2YXJpYXRpb24qKiBzdWNoIGFzIHNhbXBsZS1zcGVjaWZpYyBHQy1jb250ZW50IG9yIAogdHJhbnNjcmlwdCBsZW5ndGggZWZmZWN0cyBtYXkgYWxzbyBiZSBhY2NvdW50ZWQgZm9yLgoKYGBge3IsIGV2YWw9RkFMU0V9CnRhYmxlKHNjZSRjbHVzdGVyKQpgYGAKCkJlbG93LCB3ZSB3aWxsIHZpc3VhbGl6ZSB0aGUgbm9ybWFsaXphdGlvbiBvY2N1cnJpbmcgYmV0d2VlbiB0d28gY2VsbHMgb2YgdGhlIApzYW1lIGNlbGwgdHlwZSAod2hpY2ggY291bGQgYmUgY29uc2lkZXJlZCB0ZWNobmljYWwgcmVwZWF0cyk6IAoKYGBge3IsIGV2YWw9RkFMU0V9CnNlbGVjdCA8LSBzY2UkY2x1c3RlciA9PSAiMSIKc2VsZWN0W2lzLm5hKHNlbGVjdCldIDwtIEZBTFNFCmNzIDwtIGNvbFN1bXMoYXNzYXlzKHNjZSkkY291bnRzWyxzZWxlY3RdKQpjc1tvcmRlcihjcywgZGVjcmVhc2luZyA9IFRSVUUpXVtjKDEsMTApXQpgYGAKCkxldOKAmXMgdGFrZSBhIGxvb2sgYXQgaG93IGNvbXBhcmFibGUgdHdvIGNlbGxzIChyZXBsaWNhdGVzKSBvZiBjbHVzdGVyIDEgYXJlLiAKV2Ugd2lsbCBjb21wYXJlIHRoZSBjZWxsIHdpdGggdGhlIGhpZ2hlc3QgbGlicmFyeSBzaXplIHdpdGggdGhlIGNlbGwgdGhhdCBoYXMgCnRoZSAxMHRoIGhpZ2hlc3QgbGlicmFyeSBzaXplIHVzaW5nIE1ELXBsb3RzIChtZWFuLWRpZmZlcmVuY2UgcGxvdHMsIGFzIAppbnRyb2R1Y2VkIGJ5IApbRHVkb2l0IGV0IGFsLiAoMjAwMildKGh0dHBzOi8vd3d3LmpzdG9yLm9yZy9zdGFibGUvMjQzMDcwMzg/c2VxPTEjbWV0YWRhdGFfaW5mb190YWJfY29udGVudHMpKSwgCmFsc28gc29tZXRpbWVzIHJlZmVycmVkIHRvIGFzIE1BLXBsb3RzLgoKYGBge3IsIGV2YWw9RkFMU0V9CnRhcmdldENlbGxzIDwtIG5hbWVzKGNzW29yZGVyKGNzLCBkZWNyZWFzaW5nID0gVFJVRSldW2MoMSwxMCldKQoKTSA8LSByb3dNZWFucyhhc3NheXMoc2NlKSRjb3VudHNbLHRhcmdldENlbGxzXSkKRCA8LSBhc3NheXMoc2NlKSRjb3VudHNbLHRhcmdldENlbGxzWzJdXSAvIGFzc2F5cyhzY2UpJGNvdW50c1ssdGFyZ2V0Q2VsbHNbMV1dCnBsb3QoeCA9IGxvZyhNKSwgeSA9IGxvZzIoRCksCiAgICAgcGNoID0gMTYsIGNleD0xLzMsCiAgICAgbWFpbiA9IHBhc3RlMCgiQ2VsbCAiLCB0YXJnZXRDZWxsc1syXSwgIiB2cyBjZWxsICIsIHRhcmdldENlbGxzWzFdKSwKICAgICB4bGFiID0gIkxvZyBtZWFuIiwgeWxhYiA9ICJMb2cyIGZvbGQtY2hhbmdlIiwKICAgICBidHkgPSAnbCcpCmFibGluZShoID0gMCwgY29sPSJvcmFuZ2UiLCBsd2Q9MikKCmBgYAoKV2Ugc2VlIGNsZWFyIGJpYXMgaW4gdGhlIGNvbXBhcmlzb24gb2YgdGhlIDFzdCBhbmQgMTB0aCBtb3N0IGRlZXBseSBzZXF1ZW5jZWQgCmNlbGwgZnJvbSBjZWxsIGNsdXN0ZXIgMS4gV2Ugc2VlIHRoYXQgdGhlIGxvZyBmb2xkLWNoYW5nZXMgYXJlIGJpYXNlZCBkb3dud2FyZHMuIApUaGlzIG1lYW5zIHRoYXQsIG9uIGF2ZXJhZ2UsIGEgZ2VuZSBpcyBoaWdoZXIgZXhwcmVzc2VkIGluIGNlbGwgMSB2ZXJzdXMgY2VsbCAxMC4KTG9va2luZyBhdCB0aGUgbGlicmFyeSBzaXplcywgd2UgY2FuIGluZGVlZCBzZWUgdGhhdCB0aGUgbGlicmFyeSBzaXplIGZvciAKY2VsbCAxIGlzIDIwODY5IGNvdW50cywgd2hpbGUgaXQgaXMgb25seSAxNDcxOSBjb3VudHMgZm9yIGNlbGwgMTAhIFRoaXMgaXMgYQpjbGVhciBsaWJyYXJ5IHNpemUgZWZmZWN0IHRoYXQgd2Ugc2hvdWxkIHRha2UgaW50byBhY2NvdW50LgoKYGBge3IsIGV2YWw9RkFMU0V9CiMgbm9ybWFsaXplIHRoZSBjb3VudCBkYXRhIHVzaW5nIHRoZSBwcmV2aW91c2x5IGNvbXB1dGVkICJzaXplIGZhY3RvcnMiCmFzc2F5KHNjZSwgIm5vcm1lZCIpIDwtIG5vcm1hbGl6ZUNvdW50cyhzY2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nPUZBTFNFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZS5mYWN0b3JzPXNmLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBzZXVkby5jb3VudD0wKQoKTSA8LSByb3dNZWFucyhhc3NheXMoc2NlKSRub3JtZWRbLHRhcmdldENlbGxzXSkKRCA8LSBhc3NheXMoc2NlKSRub3JtZWRbLHRhcmdldENlbGxzWzJdXSAvIGFzc2F5cyhzY2UpJG5vcm1lZFssdGFyZ2V0Q2VsbHNbMV1dCnBsb3QoeCA9IGxvZyhNKSwgeSA9IGxvZzIoRCksCiAgICAgcGNoID0gMTYsIGNleD0xLzMsCiAgICAgbWFpbiA9IHBhc3RlMCgiQ2VsbCAiLCB0YXJnZXRDZWxsc1syXSwgIiB2cyBjZWxsICIsIHRhcmdldENlbGxzWzFdKSwKICAgICB4bGFiID0gIkxvZyBtZWFuIiwgeWxhYiA9ICJMb2cyIGZvbGQtY2hhbmdlIiwKICAgICBidHkgPSAnbCcpCmFibGluZShoID0gMCwgY29sPSJvcmFuZ2UiLCBsd2Q9MikKYGBgCgpVcG9uIG5vcm1hbGl6aW5nIHRoZSBkYXRhIHVzaW5nIHNpemUgZmFjdG9ycywgd2UgaGF2ZSByZW1vdmVkIGJpYXMgYXMgYQpjb25zZXF1ZW5jZSBvZiBkaWZmZXJlbmNlcyBpbiBzZXF1ZW5jaW5nIGRlcHRoLgoKTm90ZSB0aGF0IHdlIGNvbXB1dGVkIHRoZSBub3JtYWxpemVkIGNvdW50IG1hdHJpeCBvbmx5IGZvciBkZW1vbnN0cmF0aW5nIHRoZQplZmZlY3Qgb2Ygc3VjaCBub3JtYWxpemF0aW9uLiBJbiBhIHR5cGljYWwgd29ya2Zsb3csIHRoZSBzaXplIGZhY3RvcnMgYXJlIHVzZWQKYXMgb2Zmc2V0cyBpbiB0aGUgZG93bnN0cmVhbSBtb2RlbHMgcmF0aGVyIHRoYW4gdG8gcGVyZm9ybSBkYXRhIHRyYW5zZm9ybWF0aW9uLgpJbiBicmllZiwgc3VjaCB0cmFuc2Zvcm1hdGlvbiB3b3VsZCBkaXN0b3J0IHRoZSBtZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcAppbiB0aGUgZGF0YS4gRm9yIG1vcmUgZGV0YWlscywgd2UgcmVmZXIgdG8gdGhlIGRvY3VtZW50IHRoYXQgd2FzIHRvdWNoZWQgdXBvbgppbiB0aGUgZmlyc3QgdGhlb3J5IHNlc3Npb24KKFtsaW5rXShodHRwczovL3N0YXRvbWljcy5naXRodWIuaW8vU0dBMjEvc2VxdWVuY2luZ19zY2FsaW5nTm9ybWFsaXphdGlvbi5odG1sKSkKCiMgRmVhdHVyZSBzZWxlY3Rpb24KCkFzIGRpbWVuc2lvbnMgaW5jcmVhc2UsIHNob3J0ZXN0IGFuZCBmYXJ0aGVzdCBkaXN0YW5jZXMgYmV0d2VlbiBwb2ludHMgYmVjb21lCm5lYXJseSBpbnNlcGFyYWJsZS4gSW4gaGlnaC1kaW1lbnNpb25hbCBzcGFjZSwgaXQgaXMgdGhlcmVmb3JlIGV4dHJlbWVseSAKZGlmZmljdWx0IHRvIHNlcGFyYXRlIHNpZ25hbCBmcm9tIG5vaXNlLgoKSW4gb3JkZXIgdG8gcmVjb3ZlciBzdHJ1Y3R1cmUgKGUuZy4gc2V0dGluZyB1cCBhIGRpbWVuc2lvbi1yZWR1Y2VkCnNwYWNlIHRvIGhlbHAgdXMgZmluZCBjZWxsLXR5cGUgY2x1c3RlcnMgaW4gdGhlIGRhdGEpLCB3ZSB3YW50IHRvIG1vdmUgdG8gYW4KaW5mb3JtYXRpdmUsIGxvd2VyLWRpbWVuc2lvbmFsIHNwYWNlLiBXZSB3aWxsIHNlbGVjdCBnZW5lcyB3aGljaCB3ZSBob3BlIGFyZQppbmZvcm1hdGl2ZSBmb3IgcmVjb3ZlcmluZyB0aGUgYmlvbG9naWNhbCBzdHJ1Y3R1cmUuIEJ1dCB3aGF0IGRlZmluZXMgYW4gCmluZm9ybWF0aXZlIGdlbmU/CgojIyBTZWxlY3RpbmcgZ2VuZXMgd2l0aCBoaWdoIHZhcmlhbmNlCgpUaGUgc2ltcGxlc3QgYXBwcm9hY2ggdG8gcXVhbnRpZnlpbmcgcGVyLWdlbmUgdmFyaWF0aW9uIGlzIHRvIGNvbXB1dGUgdGhlIAp2YXJpYW5jZSBvZiB0aGUgbG9nLW5vcm1hbGl6ZWQgZXhwcmVzc2lvbiB2YWx1ZXMgKGkuZS4sICJsb2ctY291bnRzIikgZm9yIAplYWNoIGdlbmUgYWNyb3NzIGFsbCBjZWxscy4gCgpgYGB7cixldmFsPUZBTFNFfQojIGNhbGN1bGF0ZSB2YXJpYW5jZSBvZiBsb2ctbm9ybWFsaXplZCBjb3VudHMgZm9yIGVhY2ggZ2VuZQpnZW5lVmFycyA8LSBnZW5lZmlsdGVyOjpyb3dWYXJzKC4uLikKIyBzZWxlY3QgdG9wIDEwMDAgaGlnaGx5IHZhcmlhYmxlIGdlbmVzCmhpZ2hWYXJHZW5lcyA8LSBuYW1lcyhnZW5lVmFycylbb3JkZXIoZ2VuZVZhcnMsIGRlY3JlYXNpbmc9VFJVRSlbMToxZTNdXQpoZWFkKGhpZ2hWYXJHZW5lcykKYGBgCgojIyBTZWxlY3RpbmcgZ2VuZXMgd2l0aCBoaWdoIHZhcmlhdGlvbiB3aXRoIHJlc3BlY3QgdG8gbWVhbgoKV2hpbGUgY2FsY3VsYXRpb24gb2YgdGhlIHBlci1nZW5lIHZhcmlhbmNlIGlzIHNpbXBsZSwgZmVhdHVyZSBzZWxlY3Rpb24gcmVxdWlyZXMKbW9kZWxsaW5nIG9mIHRoZSBtZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcC4gSW5kZWVkLCBub3QgYWNjb3VudGluZyBmb3IgdGhlIAptZWFuLXZhcmlhbmNlIHN0cnVjdHVyZSB3aGlsZSBzZWxlY3RpbmcgaGlnaGx5IHZhcmlhYmxlIGdlbmVzIHdpbGwgb2Z0ZW50aW1lcyAKYm9pbCBkb3duIHRvIHNlbGVjdGluZyB0aGUgbW9zdCBoaWdobHkgZXhwcmVzc2VkIGdlbmVzLiBUaGUgbG9nLXRyYW5zZm9ybWF0aW9uIAppcyBhIGhlbHBmdWwgdmFyaWFuY2Ugc3RhYmlsaXppbmcgdHJhbnNmb3JtYXRpb24sIGhvd2V2ZXIsIGl0IGlzIG5vdCBwZXJmZWN0LCAKbWVhbmluZyB0aGF0IHRoZSB2YXJpYW5jZSBvZiBhIGdlbmUgaXMgbm90IGNvbXBsZXRlbHkgaW5kZXBlbmRlbnQgb2YgaXRzIG1lYW4uClRoZXJlZm9yZSwgZmVhdHVyZSBzZWxlY3Rpb24gbWF5IHN0aWxsIGJlIGRyaXZlbiBieSBhdmVyYWdlIGV4cHJlc3Npb24gcmF0aGVyIAp0aGFuIHVuZGVybHlpbmcgYmlvbG9naWNhbCBoZXRlcm9nZW5laXR5LgoKQSAocmlnaHRseSBzbykgcG9wdWxhciBhcHByb2FjaCBpcyB0byBzZWxlY3QgZ2VuZXMgdGhhdCBoYXZlIGEgaGlnaCB2YXJpYW5jZQp3aXRoIHJlc3BlY3QgdG8gdGhlaXIgbWVhbi4gT2Z0ZW4sIGZpcnN0IGFuIGVtcGlyaWNhbCBtZWFuLXZhcmlhbmNlIHRyZW5kIGlzCmZpdHRlZCwgdXBvbiB3aGljaCBnZW5lcyB3aXRoIHRoZSBoaWdoZXN0IHBvc2l0aXZlIHJlc2lkdWFscyBhcmUgc2VsZWN0ZWQuIApCZWluZyBpbnR1aXRpdmUsIHJlYXNvbmFibGUgYW5kIGZhaXJseSBzdHJhaWdodC1mb3J3YXJkLCB0aGlzIG1ldGhvZCBpcyB3aWRlbHkKdXNlZC4KClRvIGFjY291bnQgZm9yIHRoZSBtZWFuLXZhcmlhbmNlIGVmZmVjdCwgd2UgdXNlIHRoZSBgbW9kZWxHZW5lVmFyYCBmdW5jdGlvbiBvZgp0aGUgYHNjcmFuYCBwYWNrYWdlIHRvIGZpdCBhIHRyZW5kIHRvIHRoZSB2YXJpYW5jZSB3aXRoIHJlc3BlY3QgdG8gYWJ1bmRhbmNlCmFjcm9zcyBhbGwgZ2VuZXMgKG9uIGxvZy1ub3JtYWxpemVkIGV4cHJlc3Npb24gdmFsdWVzIG9mIHRoZSBzY2Ugb2JqZWN0KS4KCmBgYHtyLGV2YWw9RkFMU0V9CmxpYnJhcnkoc2NyYW4pCiMgYG1vZGVsR2VuZVZhcmAgZnVuY3Rpb24gZGVzY3JpcHRpb246IE1vZGVsIHRoZSB2YXJpYW5jZSBvZiB0aGUgbG9nLWV4cHJlc3Npb24gCiMgcHJvZmlsZXMgZm9yIGVhY2ggZ2VuZSwgZGVjb21wb3NpbmcgaXQgaW50byB0ZWNobmljYWwgYW5kIGJpb2xvZ2ljYWwgCiMgY29tcG9uZW50cyBiYXNlZCBvbiBhIGZpdHRlZCBtZWFuLXZhcmlhbmNlIHRyZW5kLgpkZWMgPC0gbW9kZWxHZW5lVmFyKC4uLikgIyBpbnB1dCBhIHNjZSBvYmplY3Qgd2l0aCBwcmVjb21wdXRlZCBsb2djb3VudHMgYXNzYXkKaGVhZChkZWMpCmBgYAoKVGhlIGZpdHRlZCB2YWx1ZSBmb3IgZWFjaCBnZW5lIGlzIHVzZWQgYXMgYSBwcm94eSBmb3IgdGhlIHRlY2huaWNhbCBjb21wb25lbnQgb2YKdmFyaWF0aW9uIGZvciBlYWNoIGdlbmUsIHVuZGVyIHRoZSBhc3N1bXB0aW9uIHRoYXQgbW9zdCBnZW5lcyBleGhpYml0IGEgbG93CmJhc2VsaW5lIGxldmVsIG9mIHZhcmlhdGlvbiB0aGF0IGlzIG5vdCBiaW9sb2dpY2FsbHkgaW50ZXJlc3RpbmcuIFRoZSBiaW9sb2dpY2FsCmNvbXBvbmVudCBvZiB2YXJpYXRpb24gZm9yIGVhY2ggZ2VuZSBpcyBkZWZpbmVkIGFzIHRoZSB0aGUgcmVzaWR1YWwgZnJvbSB0aGUKdHJlbmQuIFJhbmtpbmcgZ2VuZXMgYnkgdGhlIGJpb2xvZ2ljYWwgY29tcG9uZW50IGVuYWJsZXMgaWRlbnRpZmljYXRpb24gb2YKaW50ZXJlc3RpbmcgZ2VuZXMgZm9yIGRvd25zdHJlYW0gYW5hbHlzZXMgaW4gYSBtYW5uZXIgdGhhdCBhY2NvdW50cyBmb3IgdGhlCm1lYW4tdmFyaWFuY2UgcmVsYXRpb25zaGlwLgoKYGBge3IsZXZhbD1GQUxTRX0KZml0UmV0aW5hIDwtIG1ldGFkYXRhKC4uLikKcGxvdCh4ID0gLi4uLCAjIHRoZSBmaXR0ZWQgbWVhbnMgb24gdGhlIHgtYXhpcyAKICAgICB5ID0gLi4uLCAjIHRoZSBmaXR0ZWQgdmFyaWFuY2VzIG9uIHRoZSB5LWF4aXMKICAgICB4bGFiPSJNZWFuIG9mIGxvZy1leHByZXNzaW9uIiwKICAgIHlsYWI9IlZhcmlhbmNlIG9mIGxvZy1leHByZXNzaW9uIikKY3VydmUoZml0UmV0aW5hJHRyZW5kKHgpLCBjb2w9ImRvZGdlcmJsdWUiLCBhZGQ9VFJVRSwgbHdkPTIpICMgYWRkcyBhIHRyZW5kIGxpbmUKYGBgCgpXZSBhcmUgaW50ZXJlc3RlZCBpbiB0aG9zZSBnZW5lcyBmb3Igd2hpY2ggdGhlIHZhcmlhbmNlIGluIGV4cHJlc3Npb24gaXMgaGlnaGVyCnRoYW4gd2hhdCB3ZSB3b3VsZCBleHBlY3QgZm9yIHRoYXQgZ2VuZSBiYXNlZCBvbiBpdHMgbWVhbiBleHByZXNzaW9uLgoKYGBge3IsZXZhbD1GQUxTRX0KIyBnZXQgMTAlIG1vc3QgdmFyaWFibGUgZ2VuZXMKIyBCYXNlZCBvbiB0aGUgb3V0cHV0IHN0YXRpc3RpY3Mgb2YgbW9kZWxHZW5lVmFyLCBzZWxlY3QgdGhlIDEwJSBtb3N0IHZhcmlhYmxlIGdlbmVzCmh2ZyA8LSBnZXRUb3BIVkdzKHN0YXRzID0gLi4uLCAKICAgICAgICAgICAgICAgICAgcHJvcCA9IC4uLikgIyBwZXJjZW50YWdlIG9mIHRvcCB2YXJpYWJsZSBnZW5lcy4gQWx0ZXJuYXRpdmVseSwKIyBuID0gLi4uIGNvdWxkIGJlIHVzZWQgdG8gc2VsZWN0IHRoZSB0b3AgbnVtYmVyIG9mIHZhcmlhYmxlIGdlbmVzCmhlYWQoaHZnKQoKIyBwbG90IHRoZXNlIApwbG90KHggPSAuLi4sICMgdGhlIGZpdHRlZCBtZWFucyBvbiB0aGUgeC1heGlzIAogICAgIHkgPSAuLi4sICMgdGhlIGZpdHRlZCB2YXJpYW5jZXMgb24gdGhlIHktYXhpcwogICAgIGNvbCA9IGMoIm9yYW5nZSIsICJkYXJrc2VhZ3JlZW4zIilbKG5hbWVzKGZpdFJldGluYSRtZWFuKSAlaW4lIGh2ZykrMV0sCiAgICAgeGxhYj0iTWVhbiBvZiBsb2ctZXhwcmVzc2lvbiIsCiAgICB5bGFiPSJWYXJpYW5jZSBvZiBsb2ctZXhwcmVzc2lvbiIpCmN1cnZlKGZpdFJldGluYSR0cmVuZCh4KSwgY29sPSJkb2RnZXJibHVlIiwgYWRkPVRSVUUsIGx3ZD0yKQpsZWdlbmQoInRvcGxlZnQiLCAKICAgICAgIGxlZ2VuZCA9IGMoIlNlbGVjdGVkIiwgIk5vdCBzZWxlY3RlZCIpLCAKICAgICAgIGNvbCA9IGMoImRhcmtzZWFncmVlbjMiLCAib3JhbmdlIiksCiAgICAgICBwY2ggPSAxNiwKICAgICAgIGJ0eT0nbicpCmBgYAoKQXMgYSBjb21wYXJpc29uLCB3ZSBjb3VsZCBjb2xvciB0aGUgZ2VuZXMgb24gdGhpcyBmaWd1cmUgYWNjb3JkaW5nIHRvIHRoZSAKc2VsZWN0aW9uIHRoYXQgd2FzIG1hZGUgcHVyZWx5IGJ5IGxvb2tpbmcgYXQgdGhlIHJhdyB2YXJpYW5jZSBvZiBlYWNoIGdlbmUuCgpgYGB7cixldmFsPUZBTFNFfQouLi4KYGBgCgpBcyBleHBlY3RlZCwgd2UgaGVyZSBzaW1wbHkgc2VsZWN0IGdlbmVzIHdpdGggYSBoaWdoIHZhcmlhbmNlLCB3aXRob3V0IApyZWNvZ25pemluZyB0aGF0IGEgaGlnaCB2YXJpYW5jZSBpcyB0eXBpY2FsbHkgZHJpdmVuIGJ5IGEgaGlnaCBtZWFuLgoKIyMgSGlnaCBkZXZpYW5jZSBnZW5lcwoKSGVyZSwgd2Ugd2lsbCBzZWxlY3QgZ2VuZXMgd2l0aCBhIGhpZ2ggcmVzaWR1YWwgZGV2aWFuY2UuIFRoZSBpZGVhIGlzIHRoYXQgd2UgCmFzc3VtZSBhIG51bGwgbW9kZWwgb2YgY29uc3RhbnQgZXhwcmVzc2lvbiBmcmFjdGlvbiAoaS5lLiwgUk5BIGNvbmNlbnRyYXRpb24pIAphY3Jvc3MgYWxsIGNlbGxzLiBXZSBzdWJzZXF1ZW50bHkgY2FsY3VsYXRlIGEgZ29vZG5lc3Mtb2YtZml0IHN0YXRpc3RpYyBmb3IgCmVhY2ggZ2VuZSwgYXNzZXNzaW5nIHdoZXRoZXIgdGhlIG1vZGVsIGlzIGEgZ29vZCBhcHByb3hpbWF0aW9uIHRvIHRoZSBnZW5lIApleHByZXNzaW9uIG9mIHRoZSBjb3JyZXNwb25kaW5nIGdlbmUuCgpJZiB0aGUgbW9kZWwgZml0cyBwb29ybHksIGkuZS4sIHRoZSBnZW5lIGhhcyBhIGhpZ2ggZGV2aWFuY2UsIHRoZSBleHByZXNzaW9uIApmcmFjdGlvbiB2YXJpZXMgc2lnbmlmaWNhbnRseSBhY3Jvc3MgdGhlIGNlbGxzIGluIG91ciBkYXRhc2V0cy5HZW5lcyB3aXRoIGEgCmhpZ2ggZGV2aWFuY2Ugd2lsbCB0aHVzIG1vc3QgcG9vcmx5IGZpdCBhIG51bGwgbW9kZWwgd2hlcmUgdGhlIHJlbGF0aXZlCmFidW5kYW5jZSBpcyBlcXVhbCBmb3IgYWxsIGNlbGxzLCB3aGljaCB0aGVyZWZvcmUgYXJlIGluZm9ybWF0aXZlLgoKYGBge3IsIGV2YWw9RkFMU0V9CiNCaW9jTWFuYWdlcjo6aW5zdGFsbCgic2NyeSIpCmxpYnJhcnkoc2NyeSkKIyBgZGV2aWFuY2VGZWF0dXJlU2VsZWN0aW9uYCBmdW5jdGlvbiBkZXNjcmlwdGlvbjogQ29tcHV0ZXMgYSBkZXZpYW5jZSBzdGF0aXN0aWMgCiMgZm9yIGVhY2ggcm93IGZlYXR1cmUgKHN1Y2ggYXMgYSBnZW5lKSBmb3IgY291bnQgZGF0YSBiYXNlZCBvbiBhIG11bHRpbm9taWFsIAojIG51bGwgbW9kZWwgWy4uLl0uIApzY2UgPC0gZGV2aWFuY2VGZWF0dXJlU2VsZWN0aW9uKG9iamVjdCA9IC4uLiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzYXkgPSAuLi4pICMgY29tcHV0ZWQgb24gcmF3IGNvdW50cwoKcGxvdChzb3J0KHJvd0RhdGEoc2NlKSRiaW5vbWlhbF9kZXZpYW5jZSwgZGVjcmVhc2luZyA9IFRSVUUpLCAKICAgICB0eXBlPSJsIiwgCiAgICAgeGxhYj0icmFua2VkIGdlbmVzIiwgCiAgICAgeWxhYj0iYmlub21pYWwgZGV2aWFuY2UiLCAKICAgICBtYWluPSJGZWF0dXJlIFNlbGVjdGlvbiB3aXRoIERldmlhbmNlIikKYWJsaW5lKHY9MjAwMCwgbHR5PTIsIGNvbD0icmVkIikKYGBgCgpPdXIgcGxvdCBsb29rcyBzaW1pbGFyIHRvIG9uZSBkaXNwbGF5ZWQgaW4gdGhlIApbdmlnbmV0dGUgb2YgdGhlIHNjcnkgcGFja2FnZV0oaHR0cHM6Ly93d3cuYmlvY29uZHVjdG9yLm9yZy9wYWNrYWdlcy9yZWxlYXNlL2Jpb2MvdmlnbmV0dGVzL3NjcnkvaW5zdC9kb2Mvc2NyeS5odG1sKS4gCkJhc2VkIG9uIHRoYXQgcGxvdCwgdGhlIGF1dGhvcnMgc3VnZ2VzdCByZXRhaW5pbmcgMi4wMDAgZ2VuZXMgKHRoZSB0b3AgMjAwMCAKYmFzZWQgb24gdGhlIGRldmlhbmNlIHJlc2lkdWFscykgZm9yIGRvd25zdHJlYW0gZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uIGFuZCAKY2x1c3RlcmluZy4KCiMjIFNldXJhdCBWU1QKCkFub3RoZXIgdmVyeSBjb21tb24gZmVhdHVyZSBzZWxlY3Rpb24gc3RyYXRlZ3kgaXMgdGhlIHZhcmlhbmNlLXN0YWJpbGl6aW5nCnRyYW5zZm9ybWF0aW9uIGZyb20gdGhlIGBTZXVyYXRgIFIgcGFja2FnZSwgd2hpY2ggYW1vdW50cyB0byBjYWxjdWxhdGluZyBQZWFyc29uCnJlc2lkdWFscyBmcm9tIGEgcmVndWxhcml6ZWQgbmVnYXRpdmUgYmlub21pYWwgcmVncmVzc2lvbiBtb2RlbCwgd2l0aCBzZXF1ZW5jaW5nIApkZXB0aCBhcyBhIGNvdmFyaWF0ZS4KCioqSW50ZXJtZXp6bzogaW50ZXJvcGVyYWJpbGl0eSBiZXR3ZWVuIFNpbmdsZUNlbGxFeHBlcmltZW50IGFuZCBTZXVyYXQgb2JqZWN0cyoqCgpJbiB0aGlzIGxlY3R1cmUgc2VyaWVzLCB3ZSBhbHdheXMgbWFrZSB1c2Ugb2YgdGhlIFNpbmdsZUNlbGxFeHBlcmltZW50IG9iamVjdAphbmQgdGhlIHBhY2thZ2VzIGF2YWlsYWJsZSBmcm9tIEJpb2NvbmR1Y3Rvci4gQW5vdGhlciB2ZXJ5IHBvcHVsYXIgdG9vbGJveApmb3IgcGVyZm9ybWluZyBzY1JOQS1zZXEgZGF0YSBhbmFseXNpcyBpcyBgU2V1cmF0YC4gSG93ZXZlciwgZnVuY3Rpb25zIGZyb20KYFNldXJhdGAgY2Fubm90IGJlIHVzZWQgZGlyZWN0bHkgdG8gbWFuaXB1bGF0ZSBgU2luZ2xlQ2VsbEV4cGVyaW1lbnRgIG9iamVjdHMsCmFuZCB2aWNlIHZlcnNhLiBGb3J0dW5hdGVseSwgZWZmb3J0cyBoYXZlIGJlZW4gbWFkZSB0byBpbmNyZWFzZSB0aGUKaW50ZXJvcGVyYWJpbGl0eSBiZXR3ZWVuIHRoZSB0d28gdG9vbGJveGVzLgoKYGBge3IsIGV2YWw9RkFMU0V9CmxpYnJhcnkoU2V1cmF0KQpzZXVyYXRfb2JqIDwtIGFzLlNldXJhdCguLi4pICMgc2NlIG9iamVjdApzZXVyYXRfb2JqICMgbm90aWNlIHRoZSAiMCB2YXJpYWJsZSBmZWF0dXJlcyIKYGBgCgpPbiB0aGlzIG9iamVjdCwgd2UgbWF5IHVzZSBmdW5jdGlvbnMgZnJvbSB0aGUgYFNldXJhdGAgdG9vbGJveC4KRm9yIGluc3RhbmNlLCB3ZSBtYXkgc2VhcmNoIGZvciBoaWdobHkgdmFyaWFibGUgZmVhdHVyZXMgdXNpbmcgYFNldXJhdGAncyBWU1QKaW1wbGVtZW50YXRpb246CgpgYGB7ciwgZXZhbD1GQUxTRX0KIyBQcmlvciB0byBkZXRlY3RpbmcgdmFyaWFibGUgZmVhdHVyZXMgdXNpbmcgVlNULCBTZXVyYXQgbm9ybWFsaXplcyB0aGUgZGF0YS4KIyBUaGUgYE5vcm1hbGl6ZURhdGFgIGZ1bmN0aW9uIHRha2VzIGFzIGlucHV0IHRoZSBTZXVyYXQgb2JqZWN0LCBhbmQgdXNlcyAKIyBsb2cgbm9ybWFsaXphdGlvbiBhbmQgYSBzY2FsZSBmYWN0b3Igb2YgMTAwMDAgYXMgZGVmYXVsdCAoc2VlIGhlbHAgZmlsZSkuCnNldXJhdF9vYmogPC0gU2V1cmF0OjpOb3JtYWxpemVEYXRhKG9iamVjdCA9IC4uLiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6YXRpb24ubWV0aG9kID0gLi4uLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGUuZmFjdG9yID0gLi4uKQoKIyBOZXh0LCBwZXJmb3JtIGZlYXR1cmUgc2VsZWN0aW9uIGJhc2VkIG9uIFZTVApzZXVyYXRfb2JqIDwtICBGaW5kVmFyaWFibGVGZWF0dXJlcyhvYmplY3QgPSAuLi4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5tZXRob2QgPSAuLi4pCmBgYAoKYGBge3IsZXZhbD1GQUxTRX0Kc2V1cmF0X29iaiAgIyBub3RpY2UgdGhlICIyMDAwIHZhcmlhYmxlIGZlYXR1cmVzIiAoZGVmYXVsdCkKaGVhZChWYXJpYWJsZUZlYXR1cmVzKHNldXJhdF9vYmopKSAjIGhlcmUgdGhleSBhcmUKYGBgCgojIERpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbgoKTm90ZSB0aGF0LCBiZWxvdywgd2UgY29sb3IgdGhlIGNlbGxzIHVzaW5nIHRoZSBrbm93biwgdHJ1ZSBjZWxsIHR5cGUgbGFiZWwgYXMgCmRlZmluZWQgaW4gdGhlIG1ldGFkYXRhLCB0byBlbXBpcmljYWxseSBldmFsdWF0ZSB0aGUgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uLiAKSW4gcmVhbGl0eSwgd2UgZG9uJ3Qga25vdyB0aGlzIHlldCBhdCB0aGlzIHN0YWdlLgoKIyMgVGhlIG1vc3QgYmFzaWMgRFIKCkp1c3QgYnkgbG9va2luZyBhdCB0aGUgdG9wIHR3byBnZW5lcyBiYXNlZCBvbiBvdXIgZmVhdHVyZSBzZWxlY3Rpb24gY3JpdGVyaW9uLCAKd2UgY2FuIGFscmVhZHkgc2VlIHNvbWUgc2VwYXJhdGlvbiBhY2NvcmRpbmcgdG8gdGhlIGNlbGwgdHlwZSEKCmBgYHtyLGV2YWw9RkFMU0V9CmNvbERhdGEoc2NlKSRjbHVzdGVyIDwtIGFzLmZhY3Rvcihjb2xEYXRhKHNjZSkkY2x1c3RlcikKY2wgPC0gY29sRGF0YShzY2UpJGNsdXN0ZXIKcGFyKGJ0eT0nbCcpCnBsb3QoeCA9IC4uLiwgIyBleHRyYWN0IHRoZSBjb3VudHMgZm9yIHRoZSBtb3N0IHZhcmlhYmxlIGdlbmUKICAgICB5ID0gLi4uLCAjIGV4dHJhY3QgdGhlIGNvdW50cyBmb3IgdGhlIHNlY29uZCBtb3N0IHZhcmlhYmxlIGdlbmUKICAgICBjb2wgPSBhcy5udW1lcmljKGNsKSwKICAgICBwY2ggPSAxNiwgY2V4ID0gMS8zLAogICAgIHhsYWIgPSAiTW9zdCBpbmZvcm1hdGl2ZSBnZW5lIiwKICAgICB5bGFiID0gIlNlY29uZCBtb3N0IGluZm9ybWF0aXZlIGdlbmUiLAogICAgIG1haW4gPSAiQ2VsbHMgY29sb3JlZCBhY2MgdG8gY2VsbCB0eXBlIikKYGBgCgpXZSBhcmUgYWJsZSB0byByZWNvdmVyIHF1aXRlIHNvbWUgc3RydWN0dXJlLiBIb3dldmVyLCBtYW55IGNlbGwgcG9wdWxhdGlvbnMgCnJlbWFpbiBvYnNjdXJlLCBhbmQgdGhlIHBsb3QgaXMgb3ZlcmNyb3dkZWQuCgojIyBMaW5lYXIgZGltZW5zaW9uYWxpdHkgcmVkdWN0aW9uOiBQQ0EKCkEgRFIgbWV0aG9kIGlzIGxpbmVhciB3aGVuIHRoZSByZWR1Y2VkIGRpbWVuc2lvbnMgYXJlIGEgbGluZWFyIGZ1bmN0aW9uIG9mIHRoZQpvcmlnaW5hbCB2YXJpYWJsZXMuIEZvciBleGFtcGxlLCBpbiBQQ0EsIGVhY2ggcHJpbmNpcGFsIGNvbXBvbmVudCBpcyBhIGxpbmVhcgpjb21iaW5hdGlvbiBvZiBnZW5lcywgdGhlcmVmb3JlIHRoZSBEUiBpcyBhIGxpbmVhciBmdW5jdGlvbiBvZiB0aGUgb3JpZ2luYWwKdmFyaWFibGVzLgoKVHlwaWNhbGx5LCBQQ0EgaXMgcGVyZm9ybWVkIG9uIGxvZy10cmFuc2Zvcm1lZCBub3JtYWxpemVkIGNvdW50cy4gClRoZSBsb2ctdHJhbnNmb3JtYXRpb24gaGVscHMgIHNvbWV3aGF0LCBidXQgbm90IGNvbXBsZXRlbHksIHRvIGFjY291bnQgZm9yIHRoZQptZWFuLXZhcmlhbmNlIHJlbGF0aW9uc2hpcC4gUENBIHdvcmtzIHdlbGwgZm9yIGJ1bGsgUk5BLXNlcSBkYXRhLiBIb3dldmVyLCB0aGUKc3RydWN0dXJlIG9mIHNjUk5BLXNlcSBkYXRhIGlzIG9mdGVuIHRvbyBjb21wbGV4IHRvIGJlIHZpc3VhbGl6ZWQgYnkgYSBzbWFsbCAKbnVtYmVyIG9mIFBDcy4KClRoZXJlIGFyZSBzZXZlcmFsIFIgZnVuY3Rpb25zIHRoYXQgYWxsb3cgeW91IHRvIHBlcmZvcm0gUENBLiBIZXJlLCB3ZSBtYWtlIHVzZQpvZiB0aGUgYHJ1blBDQWAgZnVuY3Rpb24gb2YgdGhlIGBzY2F0ZXJgIHBhY2thZ2UsIHdoaWNoIGhhcyBiZWVuIHNwZWNpZmljYWxseQpkZXZlbG9wZWQgZm9yIHBlcmZvcm1pbmcgUENBIG9uIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0cy4KV2UgY2FsY3VsYXRlIHRoZSB0b3AgMzAgcHJpbmNpcGFsIGNvbXBvbmVudHMuCgojIyMgUENBIHdpdGggZmVhdHVyZSBzZWxlY3Rpb24KCmBgYHtyLGV2YWw9RkFMU0V9CiMgUGVyZm9ybSBhIFBDQSBmb3Igb3VyIGRhdGEuIENvbXB1dGUgdGhlIGZpcnN0IDMwIHByaW5jaXBhbCBjb21wb25lbnRzLCBvbmx5CiMgdXNpbmcgdGhlIHNlbGVjdGVkIGZlYXR1cmVzIHdpdGggaGlnaCB2YXJpYW5jZSB3aXRoIHJlc3BlY3QgdG8gdGhlIG1lYW4uCnNldC5zZWVkKDEyMzQpCnNjZSA8LSBydW5QQ0EoLi4uKSAjIHlvdSBuZWVkIHRocmVlIGFyZ3VtZW50cwpgYGAKClBDQSBoYXMgYmVlbiBwZXJmb3JtZWQuIFRoZSBQQ0EgaW5mb3JtYXRpb24gaGFzIGJlZW4gYXV0b21hdGljYWxseSBzdG9yZWQgaW4gdGhlCipyZWR1Y2VkRGltKiBzbG90IG9mIHRoZSBTaW5nbGVDZWxsRXhwZXJpbWVudCBvYmplY3QuCgpgYGB7cixldmFsPUZBTFNFfQpyZWR1Y2VkRGltTmFtZXMoc2NlKQpgYGAKCmBgYHtyLGV2YWw9RkFMU0V9CmhlYWQocmVkdWNlZERpbShzY2UsCiAgICAgICAgICAgICAgICB0eXBlPSJQQ0EiKSkKYGBgCgpUaGUgYHBsb3RQQ0FgIGZ1bmN0aW9uIG9mIHRoZSBgc2NhdGVyYCBwYWNrYWdlIG5vdyBhbGxvd3MgdXMgdG8gdmlzdWFsaXplCnRoZSBjZWxscyBpbiBQQ0Egc3BhY2UsIGJhc2VkIG9uIHRoZSBQQ0EgaW5mb3JtYXRpb24gc3RvcmVkIGluIG91ciBvYmplY3Q6CgpgYGB7cixldmFsPUZBTFNFfQpwbG90UENBKHNjZSwgCiAgICAgICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKQpgYGAKCldoaWxlIHRoZSBsYXJnZSBudW1iZXIgb2YgY2x1c3RlcnMgaW4gdGhpcyBkYXRhc2V0IG1ha2VzIGl0IGhhcmQgdG8gCmRpc3Rpbmd1aXNoIGJldHdlZW4gYWxsIHRoZSBkaWZmZXJlbnQgY29sb3JzLCB3ZSBjYW4gYWxyZWFkeSBzZWUgdGhhdCBQQ0EKcmV0cmlldmVzIHNvbWUsIGJ1dCBub3QgYWxsLCBvZiB0aGUgc3RydWN0dXJlIGluIHRoZSBkYXRhIHRoYXQgd2FzIGRpc2NvdmVyZWQKYnkgdGhlIG9yaWdpbmFsIGF1dGhvcnMuCgpIb3cgbWFueSBvZiB0aGUgdG9wIFBDcyBzaG91bGQgd2UgcmV0YWluIGZvciBkb3duc3RyZWFtIGFuYWx5c2VzPyBUaGUgY2hvaWNlIG9mCnRoZSBudW1iZXIgb2YgUENzIGlzIGEgZGVjaXNpb24gdGhhdCBpcyBhbmFsb2dvdXMgdG8gdGhlIGNob2ljZSBvZiB0aGUgbnVtYmVyIG9mCkhWR3MgdG8gdXNlLiBVc2luZyBtb3JlIFBDcyB3aWxsIHJldGFpbiBtb3JlIGJpb2xvZ2ljYWwgc2lnbmFsIGF0IHRoZSBjb3N0IG9mCmluY2x1ZGluZyBtb3JlIG5vaXNlIHRoYXQgbWlnaHQgbWFzayBzYWlkIHNpZ25hbC4gT24gdGhlIG90aGVyIGhhbmQsIHVzaW5nIGZld2VyClBDcyB3aWxsIGludHJvZHVjZSBjb21wZXRpdGlvbiBiZXR3ZWVuIGRpZmZlcmVudCBmYWN0b3JzIG9mIHZhcmlhdGlvbiwgd2hlcmUKd2Vha2VyIChidXQgc3RpbGwgaW50ZXJlc3RpbmcpIGZhY3RvcnMgbWF5IGJlIHB1c2hlZCBkb3duIGludG8gbG93ZXIgUENzIGFuZAppbmFkdmVydGVudGx5IGRpc2NhcmRlZCBmcm9tIGRvd25zdHJlYW0gYW5hbHlzZXMuCgpNb3N0IGFuYWx5c3RzIHdpbGwgc2ltcGx5IGFpbSB0byB1c2UgYSDigJxyZWFzb25hYmxl4oCdIGJ1dCBhcmJpdHJhcnkgdmFsdWUsCnR5cGljYWxseSByYW5naW5nIGZyb20gMTAgdG8gNTAuIFRoaXMgaXMgb2Z0ZW4gc2F0aXNmYWN0b3J5IGFzIHRoZSBsYXRlciBQQ3MKZXhwbGFpbiBzbyBsaXR0bGUgdmFyaWFuY2UgdGhhdCB0aGVpciBpbmNsdXNpb24gb3Igb21pc3Npb24gaGFzIG5vIG1ham9yIGVmZmVjdC4KCmBgYHtyLCBldmFsID0gRkFMU0V9CnBlcmNlbnQudmFyIDwtIGF0dHIocmVkdWNlZERpbShzY2UpLCAicGVyY2VudFZhciIpCnBsb3QocGVyY2VudC52YXIsIGxvZz0ieSIsIHhsYWI9IlBDIiwgeWxhYj0iVmFyaWFuY2UgZXhwbGFpbmVkICglKSIpCnBsb3QoY3Vtc3VtKHBlcmNlbnQudmFyKSwgeGxhYj0iUEMiLCB5bGFiPSJDdW11bGF0aXZlIHZhcmlhbmNlIGV4cGxhaW5lZCAoJSkiKQpgYGAKCkhlcmUsIHJldGFpbmluZyDCsTE1UENzIHNlZW1zIHJlYXNvbmFibGUuIElmIHlvdSByZWFsbHkgcHJlZmVyIGEgbW9yZSBkYXRhLWRyaXZlbgp3YXkgZm9yIGRldGVybWluaW5nIHRoaXMsIHRoZXJlIGFyZSBwcm9jZWR1cmVzIGF2YWlsYWJsZSB0aGF0IGFpbSB0byAKY29tcHV0YXRpb25hbGx5IGlkZW50aWZ5IHRoZSBlbGJvdy9rbmVlIHBvaW50IGluIHRoZSB2YXJpYW5jZSBleHBsYWluZWQgcGVyIApQQyBwbG90LgoKYGBge3IsIGV2YWwgPSBGQUxTRX0KbGlicmFyeShQQ0F0b29scykKY2hvc2VuLmVsYm93IDwtIGZpbmRFbGJvd1BvaW50KHBlcmNlbnQudmFyKQpjaG9zZW4uZWxib3cKYGBgCgojIyMgUENBIHdpdGhvdXQgZmVhdHVyZSBzZWxlY3Rpb24KCk5vdGU6IG1vcmUgZmVhdHVyZXMgLT4gY29tcHV0YXRpb25hbGx5IG1vcmUgaW50ZW5zaXZlIQoKYGBge3IsIGV2YWwgPSBGQUxTRX0Kc2V0LnNlZWQoMTIzNCkKc2NlTm9GUyA8LSBydW5QQ0EoeCA9IC4uLiwgCiAgICAgICAgICAgICAgICAgIG5jb21wb25lbnRzID0gLi4uLCAKICAgICAgICAgICAgICAgICAgc3Vic2V0X3JvdyA9IDE6bnJvdyhzY2UpKQpwbG90UENBKC4uLikKcm0oc2NlTm9GUykgIyByZW1vdmUgdGhlIG9iamVjdCwgd2UgZG9uJ3QgbmVlZCBpdCBhbnltb3JlCmBgYAoKV2hpbGUgd2UgdXNlIG1vcmUgaW5mb3JtYXRpb24gdG8gbWFrZSB0aGlzIFBDQSBwbG90ICgxNy44ODcgZ2VuZXMpIGFzIGNvbXBhcmVkCnRvIHRoZSBmZWF0dXJlIHNlbGVjdGVkIFBDQSBwbG90ICg2NDIgZ2VuZXMpLCB3ZSBzZWVtIHRvIHJldHJpZXZlIGxlc3Mgc3RydWN0dXJlCmluIHRoZSBkYXRhLiBUaGlzIGlzIHRoZSBwb3dlciBvZiBmZWF0dXJlIHNlbGVjdGlvbiwgYW4gaW5jcmVhc2UgaW4gdGhlCnNpZ25hbC10by1ub2lzZSByYXRpbyEKCiMjIyBFZmZlY3Qgb2YgZmVhdHVyZSBzZWxlY3Rpb24gb24gUENBCgpGaXJzdCwgd2UgY29tcGFyZSB0aGUgZGlmZmVyZW50IGZlYXR1cmUgc2VsZWN0aW9uIGNyaXRlcmlhLCB1c2luZyB0aGUgdG9wIDEwMDAKaGlnaGx5IHZhcmlhYmxlIGdlbmVzIGZvciBlYWNoIG1ldGhvZC4KCmBgYHtyLCBldmFsID0gRkFMU0V9CiMgR2V0IHRvcCAxMDAwIGhpZ2hseSB2YXJpYWJsZSBmZWF0dXJlcyB1c2luZyB0aGUgaGlnaGx5IHZhcmlhYmxlIGdlbmVzCiMgKHcuci50LiBtZWFuKSwgaGlnaCBkZXZpYW5jZSBnZW5lcyBhbmQgdGhlIFZTVCBzdHJhdGVneSBvZiBTZXVyYXQKCmh2ZzEwMDAgPC0gLi4uICMgZXh0cmFjdCB0b3AgMTAwMCBoaWdobHkgdmFyaWFibGUgZ2VuZXMKaGRnMTAwMCA8LSAuLi4gIyBleHRyYWN0IHRvcCAxMDAwIGdlbmVzIHdpdGggaGlnaCBkZXZpYW5jZQp2c3QxMDAwIDwtIC4uLiAjIGV4dHJhY3QgdG9wIDEwMDAgZ2VuZXMgYmFzZWQgb24gVlNUIGFuYWx5c2lzCgojIEhWRyBzdHJhdGVneQpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcxMDAwKSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpICsKICBnZ3RpdGxlKCJIaWdobHkgdmFyaWFibGUgZ2VuZXMiKQoKIyBIREcgc3RyYXRlZ3kKcGxvdFBDQSgKICAgIHJ1blBDQShzY2UsCiAgICAgICAgICAgbmNvbXBvbmVudHMgPSAyLCAKICAgICAgICAgICBzdWJzZXRfcm93ID0gaGRnMTAwMCksIAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKSArCiAgZ2d0aXRsZSgiSGlnaC1kZXZpYW5jZSBnZW5lcyIpCgojIFZTVCBzdHJhdGVneQpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSB2c3QxMDAwKSwgCiAgICBjb2xvdXJfYnkgPSAiY2x1c3RlciIsCiAgICApICsKICBnZ3RpdGxlKCJTZXVyYXQgVlNUIikKYGBgCgpOZXh0LCB3ZSBhc3Nlc3MgdGhlIHNlbnNpdGl2aXR5IG9uIHRoZSBudW1iZXIgb2YgdG9wIGZlYXR1cmVzIGZvciB0aGUgaGlnaGx5CnZhcmlhYmxlIGdlbmVzIG1ldGhvZDsKCmBgYHtyLCBldmFsID0gRkFMU0V9Cmh2Z19hbGwgPC0gZ2V0VG9wSFZHcyhkZWMpCgpodmcyMDAwIDwtIC4uLiAjIGV4dHJhY3QgdG9wIDIwMDAgaGlnaGx5IHZhcmlhYmxlIGdlbmVzCmh2ZzEwMDAgPC0gLi4uICMgZXh0cmFjdCB0b3AgMTAwMCBoaWdobHkgdmFyaWFibGUgZ2VuZXMKaHZnMTAwIDwtIC4uLiAjIGV4dHJhY3QgdG9wIDEwMCBoaWdobHkgdmFyaWFibGUgZ2VuZXMKaHZnMTAgPC0gLi4uICMgZXh0cmFjdCB0b3AgMTAgaGlnaGx5IHZhcmlhYmxlIGdlbmVzCmh2ZzUgPC0gLi4uICMgZXh0cmFjdCB0b3AgNSBoaWdobHkgdmFyaWFibGUgZ2VuZXMKCnBsb3RQQ0EoCiAgICBydW5QQ0Eoc2NlLAogICAgICAgICAgIG5jb21wb25lbnRzID0gMiksIAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKSArCiAgZ2d0aXRsZSgiQWxsIGdlbmVzIikKCnBsb3RQQ0EoCiAgICBydW5QQ0Eoc2NlLAogICAgICAgICAgIG5jb21wb25lbnRzID0gMiwgCiAgICAgICAgICAgc3Vic2V0X3JvdyA9IGh2ZzIwMDApLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIlRvcCAyMDAwIGdlbmVzIikKCnBsb3RQQ0EoCiAgICBydW5QQ0Eoc2NlLAogICAgICAgICAgIG5jb21wb25lbnRzID0gMiwgCiAgICAgICAgICAgc3Vic2V0X3JvdyA9IGh2ZzEwMDApLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIlRvcCAxMDAwIGdlbmVzIikKCnBsb3RQQ0EoCiAgICBydW5QQ0Eoc2NlLAogICAgICAgICAgIG5jb21wb25lbnRzID0gMiwgCiAgICAgICAgICAgc3Vic2V0X3JvdyA9IGh2ZzEwMCksIAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKSArCiAgZ2d0aXRsZSgiVG9wIDEwMCBnZW5lcyIpCgpwbG90UENBKAogICAgcnVuUENBKHNjZSwKICAgICAgICAgICBuY29tcG9uZW50cyA9IDIsIAogICAgICAgICAgIHN1YnNldF9yb3cgPSBodmcxMCksIAogICAgY29sb3VyX2J5ID0gImNsdXN0ZXIiKSArCiAgZ2d0aXRsZSgiVG9wIDEwIGdlbmVzIikKCnBsb3RQQ0EoCiAgICBydW5QQ0Eoc2NlLAogICAgICAgICAgIG5jb21wb25lbnRzID0gMiwgCiAgICAgICAgICAgc3Vic2V0X3JvdyA9IGh2ZzUpLCAKICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikgKwogIGdndGl0bGUoIlRvcCA1IGdlbmVzIikKYGBgCgojIyMgUmVtYXJrcyBvbiBQQ0EKClZpc3VhbGl6YXRpb25zIG9mIHJlZHVjZWQgZGltZW5zaW9ucyBmcm9tIGxpbmVhciBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24KbWV0aG9kcyBhcmUgb2Z0ZW4gIm92ZXJjcm93ZGVkIiwgYW5kIGl0IGlzIGhhcmQgdG8gc2VlIHN0cnVjdHVyZSAoZS5nLiwgdGhlIFBDQQpwbG90IHdlIGp1c3Qgc2F3KS4gTm9uLWxpbmVhciBkaW1lbnNpb25hbGl0eSByZWR1Y3Rpb24gbWV0aG9kcyBjYW4gb3ZlcmNvbWUgdGhpcwpwcm9ibGVtLiBBcyB0aGUgbmFtZSBzdWdnZXN0cywgdGhlIHJlZHVjZWQgZGltZW5zaW9ucyBhcmUgYSBub24tbGluZWFyIGZ1bmN0aW9uCm9mIHRoZSBvYnNlcnZlZCBkYXRhLiBXZSB3aWxsIG5vdCBnbyBpbnRvIGRldGFpbCBhcyB0byBob3cgdGhlc2Ugd29yayB1bmRlciB0aGUKaG9vZCwgYnV0IHByb3ZpZGUgYSBmZXcgZ3VpZGVsaW5lcyBmb3IgdGhlIG1vc3QgcG9wdWxhciBtZXRob2RzLiBPZnRlbiwgdGhlIHRvcAoofjEwLTUwKSBQQ3MgYXJlIHByb3ZpZGVkIGFzIGlucHV0LgoKIyMgQSBnZW5lcmFsaXphdGlvbiBvZiBQQ0EgZm9yIGV4cG9uZW50aWFsIGZhbWlseSBkaXN0cmlidXRpb25zLgoKUENBIGlzIGltcGxpY2l0bHkgYmFzZWQgb24gRXVjbGlkZWFuIGRpc3RhbmNlcywgY29ycmVzcG9uZGluZyB0byBtYXhpbWl6aW5nIGEKR2F1c3NpYW4gbGlrZWxpaG9vZCwgd2hpY2ggaXMgaW5hcHByb3ByaWF0ZSBmb3IgY291bnQgZGF0YSBzdWNoIGFzIHNjUk5BLXNlcS4KW1Rvd25lcyBldCBhbC5dKGh0dHBzOi8vZG9pLm9yZy8xMC4xMTg2L3MxMzA1OS0wMTktMTg2MS02KSAoMjAxOSkgZGV2ZWxvcApHTE0tUENBLCBhIGdlbmVyYWxpemF0aW9uIG9mIFBDQSBmb3IgZXhwb25lbnRpYWwgZmFtaWx5IGxpa2VsaWhvb2RzLiBUaGV5IHBvc2l0LAp1c2luZyBuZWdhdGl2ZSBjb250cm9sIGRhdGEsIHRoYXQgdGhlIGRhdGEgZ2VuZXJhdGl2ZSBtZWNoYW5pc20gb2YgVU1JIGNvdW50CmRhdGEgY2FuIGJlIGNvbnNpZGVyZWQgdG8gYmUgbXVsdGlub21pYWwuCgpUaGUgR0xNLVBDQSBzdHJhdGVneSBpcyBpbXBsZW1lbnRlZCBpbiB0aGUgYGdsbXBjYWAgZnVuY3Rpb24gb2YgdGhlIGBnbG1wY2FgCnBhY2thZ2UuCgpOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBpcyBxdWl0ZSBjb21wdXRhdGlvbmFsbHkgaW50ZW5zaXZlLiBGb3IgcmVndWxhciBQQ0EgCm9uIGxvZy10cmFuc2Zvcm1lZCBub3JtYWxpemVkIGNvdW50cywgdGhlIHVuZGVybHlpbmcgY29tcHV0YXRpb25zIGNhbiBiZSAKc3Ryb25nbHkgc2ltcGxpZmllZC4gSGVyZSwgd2Ugd29yayB3aXRoIHRoZSByYXcgY291bnRzLCB3aGljaCB3ZSBhc3N1bWUgdG8gCmJlICpQb2lzc29uKiBkaXN0cmlidXRlZCwgcmVxdWlyaW5nIGFuIGl0ZXJhdGl2ZSBvcHRpbWl6YXRpb24gc2NoZW1lLgoKYGBge3IsIGV2YWw9RkFMU0V9CiMgcnVucyAybWluIG9uIG15IGxhcHRvcApsaWJyYXJ5KGdsbXBjYSkKc2V0LnNlZWQoMjExMTAzKQpwb2lwY2EgPC0gZ2xtcGNhKFkgPSAuLi4sICMgY291bnRzIGZvciB0aGUgaGlnbHkgdmFyaWFibGUgZ2VuZXMKICAgICAgICAgICAgICAgICBMID0gLi4uLCAjIHR3byBsYXRlbnQgZGltZW5zaW9ucyAoY29tcG9uZW50cykKICAgICAgICAgICAgICAgICBmYW0gPSAuLi4sICMgYXNzdW1lIFBvaXNzb24gZm9yIGRyb3BsZXQgZGF0YQogICAgICAgICAgICAgICAgIG1pbmliYXRjaCA9ICJzdG9jaGFzdGljIikgIyB1c2VkIGluIHRoZSBwYWNrYWdlIHZpZ25ldHRlIGJ5IAojIHRoZSBhdXRob3JzLCBidXQgYmV5b25kIHRoZSBzY29wZSBvZiB0aGlzIHNlc3Npb24uCnJlZHVjZWREaW0oc2NlLCAiUG9pUENBIikgPC0gcG9pcGNhJGZhY3RvcnMKcGxvdFJlZHVjZWREaW0oLi4uKSAjIG1ha2Ugc3VyZSB0byBzcGVjaWZ5IHRoZSByaWdodCB2YWx1ZSBmb3IgdGhlIGBkaW1yZWRgIGFyZ3VtZW50CmBgYAoKQWx0ZXJuYXRpdmVseSwgd2UgY291bGQgYWRvcHQgdGhlIEdMTS1QQ0Egc3RyYXRlZ3kgdXNpbmcgb25seSB0aGUgZ2VuZXMgd2l0aCAKaGlnaCBkZXZpYW5jZS4KCmBgYHtyLCBldmFsID0gRkFMU0V9CiMgQmFzZWQgb24gdGhlIGRpYWdub3N0aWMgcGxvdCBmcm9tIHRoZSBmZWF0dXJlIHNlbGVjdGlvbiwgd2Ugd291bGQgc2VsZWN0IHRoZSAKIyB0b3AgMjAwMCBnZW5lcyB3aXRoIGhpZ2hlc3QgZGV2aWFuY2UuIEhvd2V2ZXIsIHRvIHJlZHVjZSB0aGUgcnVubmluZyB0aW1lIG9mCiMgdGhlIGZ1bmN0aW9uLCBJIGhlcmUgc2VsZWN0IHRoZSB0b3AgNTAwICh3aGljaCBzdGlsbCBpcyBxdWl0ZSBzbG93IC0gNW1pbikuCmhkZzUwMCA8LSBuYW1lcyhzb3J0KHJvd0RhdGEoc2NlKSRiaW5vbWlhbF9kZXZpYW5jZSwgZGVjcmVhc2luZyA9IFRSVUUpKVsxOjUwMF0KCi4uLgpgYGAKClRoZSBhdXRob3JzIG9mIHRoZSBgZ2xtcGNhYCBwYWNrYWdlIG5vdGUgdGhhdCBHTE0tUENBIGNhbiBiZSBzbG93IGZvciBsYXJnZSAKZGF0YXNldHMuIFRoZXJlZm9yZSwgdGhleSBoYXZlIGltcGxlbWVudGVkIGEgZmFzdCBhcHByb3hpbWF0aW9uIG9mIHRoZSAKYWxnb3JpdGhtLCB3aGljaCBmaXJzdCBmaXRzIGEgbnVsbCBtb2RlbCBvZiBjb25zdGFudCBleHByZXNzaW9uIGZvciBlYWNoIGdlbmUgCmFjcm9zcyBhbGwgY2VsbHMsIGFuZCBzdWJzZXF1ZW50bHkgZml0cyBzdGFuZGFyZCBQQ0EgdG8gZWl0aGVyIHRoZSBQZWFyc29uIG9yIApkZXZpYW5jZSByZXNpZHVhbHMgZnJvbSB0aGUgbnVsbCBtb2RlbC4KCkhvd2V2ZXIsIGF0IGxlYXN0IGZvciBtZSB0aGUgYG51bGxSZXNpZHVhbHNgIGZ1bmN0aW9uIHdhcyAqKmV4dHJlbWVseSBzbG93KioKZXZlbiBzbG93ZXIgdGhhbiB0aGUgYGdsbXBjYWAgY29kZSBhYm92ZS4gVGhlcmVmb3JlLCAqKkkgc3VnZ2VzdCBub3QgcnVubmluZyoqCnRoaXMgY29kZSwgYnV0IEkgbGVhdmUgaXQgaW4gZm9yIHJlZmVyZW5jZS4KCmBgYApzY2UgPC0gbnVsbFJlc2lkdWFscyhzY2UsIGFzc2F5PSJjb3VudHMiLCB0eXBlPSJkZXZpYW5jZSIpCnNjZSA8LSBudWxsUmVzaWR1YWxzKHNjZSwgYXNzYXk9ImNvdW50cyIsIHR5cGU9InBlYXJzb24iKQoKcGNhPC1mdW5jdGlvbihZLCBMPTIsIGNlbnRlcj1UUlVFLCBzY2FsZT1UUlVFKXsKICAgICNhc3N1bWVzIGZlYXR1cmVzPXJvd3MsIG9ic2VydmF0aW9ucz1jb2xzCiAgICByZXM8LXByY29tcChhcy5tYXRyaXgodChZKSksIGNlbnRlcj1jZW50ZXIsIHNjYWxlLj1zY2FsZSwgcmFuay49TCkKICAgIGZhY3RvcnM8LWFzLmRhdGEuZnJhbWUocmVzJHgpCiAgICBjb2xuYW1lcyhmYWN0b3JzKTwtcGFzdGUwKCJkaW0iLCAxOkwpCiAgICBmYWN0b3JzCn0KcGNhX2QgPC0gcGNhKGFzc2F5KHNjZVtoZGcsXSwgImJpbm9taWFsX2RldmlhbmNlX3Jlc2lkdWFscyIpKQpwY2FfZCRyZXNpZF90eXBlIDwtICJkZXZpYW5jZV9yZXNpZHVhbHMiCnBjYV9wIDwtIHBjYShhc3NheShzY2VbaGRnLF0sICJiaW5vbWlhbF9wZWFyc29uX3Jlc2lkdWFscyIpKQpwY2FfcCRyZXNpZF90eXBlIDwtICJwZWFyc29uX3Jlc2lkdWFscyIKY20gPC0gYXMuZGF0YS5mcmFtZShjb2xEYXRhKHNjZVtoZGcsXSkpCnBkIDwtIHJiaW5kKGNiaW5kKGNtLCBwY2FfZCksIGNiaW5kKGNtLCBwY2FfcCkpCmdncGxvdChwZCwgYWVzKHg9ZGltMSwgeT1kaW0yLCBjb2xvdXI9cGhlbm9pZCkpICsgZ2VvbV9wb2ludCgpICsKICBmYWNldF93cmFwKH5yZXNpZF90eXBlLCBzY2FsZXM9ImZyZWUiLCBucm93PTIpICsKICBnZ3RpdGxlKCJQQ0EgYXBwbGllZCB0byBudWxsIHJlc2lkdWFscyBvZiBoaWdoIGRldmlhbmNlIGdlbmVzIikKYGBgCgojIyBOb24tbGluZWFyIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbjogdC1TTkUKCnQtU05FIGZvY3VzZXMgb24gcHJlc2VydmluZyBsb2NhbCByYXRoZXIgdGhhbiBnbG9iYWwgZGlzdGFuY2VzLiBUaGVyZWZvcmUsCmRpc3RhbmNlcyBvbiBhIHQtU05FIHJlZHVjZWQgZGltZW5zaW9uIHBsb3QgY2FuIG9ubHkgYmUgaW50ZXJwcmV0ZWQgbG9jYWxseSwKaS5lLiwgY2VsbHMgdGhhdCBhcmUgY2xvc2UgdG9nZXRoZXIgaW4gcmVkdWNlZCBkaW1lbnNpb24gd2lsbCBoYXZlIGEgc2ltaWxhcgp0cmFuc2NyaXB0b21lLCBidXQgY2VsbHMgdGhhdCBhcmUgZmFyIGF3YXkgbWF5IG5vdCBuZWNlc3NhcmlseSBoYXZlIGEgdmVyeSBkaXN0aW5jdCB0cmFuc2NyaXB0b21lLgoKUnVubmluZyB0LVNORSBvbiBhIGBTaW5nbGVDZWxsRXhwZXJpbWVudGAgb2JqZWN0IGNhbiBiZSBhY2hpZXZlZCB3aXRoIHRoZQpgcnVuVFNORWAgZnVuY3Rpb24gb2YgdGhlIGBzY2F0ZXJgIHBhY2thZ2UuIEJ5IGRlZmF1bHQsIHRoaXMgZnVuY3Rpb24gd2lsbCBmaXJzdApwZXJmb3JtIFBDQSwgYW5kIHVzZSB0aGUgdG9wIDUwIFBDcyBhcyBhbiBpbnB1dCB0byB0aGUgYWN0dWFsIHQtU05FCmFsZ29yaXRobS4gU2luY2Ugd2UgYWxyZWFkeSBwZXJmb3JtZWQgUENBLCB3ZSBtYXkgc2V0IGBkaW1yZWQgPSAiUENBImAgYXMKYXJndW1lbnQgdG8gdGhlIGZ1bmN0aW9uLiBBcyBzdWNoIHdlIHdpbGwgYmUgcGVyZm9ybWluZyBhIFQtU05FIG9uIHRoZSAzMCBQQ3MKd2UgY29tcHV0ZWQgYmVmb3JlLiBJZiB3ZSB3b3VsZCBsaWtlIHRvIHJ1biB0LVNORSBvbmx5IHVzaW5nIHRoZSB0b3AgMTAKUENzLCB3ZSBjb3VsZCBzZXQgYG5fZGltcmVkID0gMTBgLgoKSW4gYWRkaXRpb24sIHdlIG1heSB3aXNoIHRvIHNldCBgZXh0ZXJuYWxfbmVpZ2hib3JzPVRSVUVgLCB3aGljaCBpbmNyZWFzZXMgdGhlCnNwZWVkIG9mIHRoZSBhbGdvcml0aG0gZm9yIGxhcmdlIGRhdGFzZXRzIGJ5IGFwcGx5aW5nIGEgaGV1cmlzdGljLgoKKipOb3RlOioqIGZvciBtZSB0aGlzIHdhcyB0aGUgc2xvd2VzdCBmdW5jdGlvbiBvZiB0aGUgYW5hbHlzaXMgKHNvIGZhcikuIElmIHlvdQpmZWVsIGxpa2UgeW91ciBQQy9sYXB0b3AgaGFkIGEgbG90IG9mIHRyb3VibGUgd2l0aCB0aGUgcHJldmlvdXMgc3RlcChzKSwgeW91Cm1heSBjb25zaWRlciBub3QgcnVubmluZyB0aGlzIGNvZGUsIG9yIHJ1bm5pbmcgaXQgb24gYSBzdWJzZXQgb2YgdGhlIGRhdGEKKGUuZy4sIHJhbmRvbWx5IHN1YnNhbXBsaW5nIGNlbGxzKSBmb3IgZGVtb25zdHJhdGlvbmFsIHB1cnBvc2VzLiAKQWx0ZXJuYXRpdmVseSwgeW91IG1heSBjb25zaWRlciByZWR1Y2luZyB0aGUgaW5wdXQgc3BhY2UgZm9yIHRoZSB0LVNORSAKYWxnb3JpdGhtLCBlLmcuIGJ5IHNldHRpbmcgYG5fZGltcmVkID0gNWAuCgpgYGB7ciwgZXZhbCA9IEZBTFNFfQojIChGb3IgbWUgaXQgdGFrZXMgM21pbjMwIHdpdGggbl9kaW1yZWQgPSA1KQpzY2UgPC0gcnVuVFNORSh4ID0gLi4uLCAKICAgICAgICAgICAgICAgZGltcmVkID0gLi4uLAogICAgICAgICAgICAgICBuX2RpbXJlZCA9IC4uLiwKICAgICAgICAgICAgICAgZXh0ZXJuYWxfbmVpZ2hib3JzID0gLi4uKQpwbG90VFNORShzY2UsCiAgICAgICAgIGNvbG91cl9ieSA9ICJjbHVzdGVyIikKYGBgCgojIyBOb24tbGluZWFyIGRpbWVuc2lvbmFsaXR5IHJlZHVjdGlvbjogVU1BUAoKSXQgaXMgb2Z0ZW4gc3VnZ2VzdGVkIHRoYXQgVU1BUCBpcyBiZXR0ZXIgdGhhbiB0LVNORSBpbiBwcmVzZXJ2aW5nIGdsb2JhbCAKZGlmZmVyZW5jZXMuIFRoZXJlZm9yZSwgVU1BUCBpcyBhbHNvIG9mdGVuIHVzZWQgaW4gYW5hbHlzZXMgc3VjaCBhcyB0cmFqZWN0b3J5IAppbmZlcmVuY2UsIHdoZXJlIHRoaXMgaXMgaW1wb3J0YW50LgoKUnVubmluZyBVTUFQIG9uIGEgYFNpbmdsZUNlbGxFeHBlcmltZW50YCBvYmplY3QgY2FuIGJlIGFjaGlldmVkIHdpdGggdGhlCmBydW5VTUFQYCBmdW5jdGlvbiBvZiB0aGUgYHNjYXRlcmAgcGFja2FnZS4KCmBgYHtyLCBldmFsID0gRkFMU0V9CiMgVXNpbmcgdG9wIDEwJSBoaWdobHkgdmFyaWFibGUgZ2VuZXMgYW5kIHRvcCAzMCBQQ3MKc2NlIDwtIHJ1blVNQVAoLi4uKQpwbG90VU1BUCguLi4pCgojIFVzaW5nIHRvcCAxMCUgaGlnaGx5IHZhcmlhYmxlIGdlbmVzIGFuZCB0b3AgMTAgUENzCnBsb3RVTUFQKHJ1blVNQVAoLi4uKSwKICBjb2xvdXJfYnkgPSAiY2x1c3RlciIpCmBgYAoK</div>
<div class="footer">
    <hr>
    This work is licensed under the <a href= "https://creativecommons.org/licenses/by-nc-sa/4.0">
    CC BY-NC-SA 4.0</a> licence.
</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("lab2_MacoskoTemplate.Rmd");
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
